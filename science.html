<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Í≥ºÌïô ÎÜÄÏù¥ÌÑ∞</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}
body{font-family:'Noto Sans KR',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#0d9488 0%,#14b8a6 50%,#0f766e 100%);margin:0;padding:0;width:100vw;height:100vh;height:100dvh;overflow:hidden;touch-action:manipulation}
.rotate-notice{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#0d9488,#14b8a6);z-index:9999;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-size:24px;font-weight:700;text-align:center;gap:20px}
.rotate-notice .rotate-icon{font-size:80px;animation:rotateH 2s ease-in-out infinite}
@keyframes rotateH{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
@media(orientation:portrait){.rotate-notice{display:flex}.container{display:none!important}}
.container{width:1920px;height:1080px;background:#fff;border-radius:25px;box-shadow:0 25px 50px rgba(0,0,0,.12);display:flex;flex-direction:column;overflow:hidden;transform-origin:0 0;position:absolute}
.subject-bar{background:linear-gradient(135deg,#1e3a8a,#3b82f6);display:flex;align-items:center;padding:0 20px;height:56px;flex-shrink:0;gap:4px;position:relative}
.subject-bar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#5eead4,#2dd4bf,#5eead4)}
.sb-tab{padding:8px 30px;border:none;border-radius:12px 12px 0 0;background:0;font-size:18px;font-weight:800;color:rgba(255,255,255,.5);cursor:pointer;font-family:inherit;transition:.2s;display:flex;align-items:center;gap:8px;text-decoration:none}
.sb-tab.active{background:#fff;color:#1e3a8a}
.sb-tab.locked{cursor:default}
.sb-tab .lock{font-size:12px;opacity:.5}
.sb-spacer{flex:1}
.sb-btns{display:flex;gap:8px}
.sb-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);border-radius:10px;padding:6px 14px;font-size:18px;color:#fff;cursor:pointer;transition:.15s}
.sb-btn:active{background:rgba(255,255,255,.3)}
.main-layout{display:grid;grid-template-columns:300px 1fr 300px;gap:14px;padding:14px;flex:1;overflow:hidden}
.left-panel{display:flex;flex-direction:column;gap:10px;overflow:hidden}
.profile-section{background:linear-gradient(145deg,#0d9488,#14b8a6 50%,#5eead4);border-radius:20px;padding:20px;border:3px solid #99f6e4;box-shadow:0 6px 20px rgba(13,148,136,.3);flex-shrink:0;position:relative;overflow:hidden}
.profile-content{position:relative;z-index:1;display:flex;align-items:center;gap:15px}
.profile-avatar{width:90px;height:90px;background:linear-gradient(145deg,#5eead4,#2dd4bf);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;border:3px solid #fff;box-shadow:0 4px 15px rgba(94,234,212,.4);animation:avGlow 3s ease-in-out infinite;flex-shrink:0;cursor:pointer}
@keyframes avGlow{0%,100%{box-shadow:0 4px 15px rgba(94,234,212,.4);transform:scale(1)}50%{box-shadow:0 8px 25px rgba(94,234,212,.6);transform:scale(1.05)}}
.profile-info{flex:1;color:#fff}
.profile-name{font-size:28px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,.3);margin-bottom:8px;cursor:pointer}
.profile-level-container{background:rgba(255,255,255,.2);border-radius:12px;padding:8px 12px}
.profile-level{font-size:22px;font-weight:700;color:#ccfbf1;display:flex;align-items:center;gap:8px}
.level-badge{background:linear-gradient(145deg,#5eead4,#2dd4bf);color:#134e4a;padding:4px 12px;border-radius:8px;font-size:22px;font-weight:800;border:1px solid #fff}
.progress-bar{width:100%;height:6px;background:rgba(255,255,255,.3);border-radius:3px;margin-top:5px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#5eead4,#2dd4bf,#5eead4);background-size:200% 100%;border-radius:3px;transition:width .5s;animation:pShine 2s linear infinite}
@keyframes pShine{0%{background-position:-200% 0}100%{background-position:200% 0}}
.tab-headers{display:grid;grid-template-columns:1fr 1fr;gap:8px;flex-shrink:0}
.tab-btn{background:linear-gradient(145deg,#e2e8f0,#cbd5e1);border:2px solid #94a3b8;border-radius:12px;padding:8px;font-size:20px;font-weight:700;cursor:pointer;transition:.2s;color:#475569;display:flex;align-items:center;justify-content:center;height:62px;white-space:nowrap;font-family:inherit}
.tab-btn.active{background:linear-gradient(145deg,#14b8a6,#0d9488);color:#fff;border-color:#14b8a6}
.tab-btn:active{transform:scale(.97)}
.tab-content{display:none;flex:1;overflow:hidden}
.tab-content.active{display:flex;flex-direction:column}
.side-info{background:linear-gradient(145deg,#f0fdfa,#ccfbf1);border-radius:16px;padding:18px;border:2px solid #14b8a6;display:flex;flex-direction:column;gap:12px;height:100%;overflow:hidden}
.side-title{font-size:24px;font-weight:700;color:#134e4a;text-align:center;flex-shrink:0}
.side-stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#fff;border-radius:8px;font-size:20px;font-weight:600;color:#1e293b}
.side-val{font-size:32px;font-weight:800;color:#0d9488}
.game-launch-btn{flex-shrink:0;background:linear-gradient(145deg,#5eead4,#2dd4bf);color:#134e4a;border:3px solid #fff;border-radius:16px;padding:14px;font-size:26px;font-weight:800;cursor:pointer;text-align:center;box-shadow:0 4px 15px rgba(94,234,212,.4);font-family:inherit;animation:gPulse 2s ease-in-out infinite}
@keyframes gPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
.game-launch-btn:active{transform:scale(.97)}
.center-panel{display:flex;flex-direction:column;overflow:hidden;position:relative}
.game-view{display:none;flex-direction:column;flex:1;overflow:hidden}
.game-view.active{display:flex}
.right-panel{display:flex;flex-direction:column;gap:12px;overflow:hidden}
.action-btn{border:none;border-radius:20px;font-size:36px;font-weight:800;cursor:pointer;transition:.1s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;flex:1;min-height:60px;font-family:inherit;color:#fff}
.action-btn .icon{font-size:62px;opacity:.9}
.action-btn:active{transform:scale(.95)}
.action-btn.btn-teal{background:linear-gradient(145deg,#14b8a6,#0d9488);box-shadow:0 2px 8px rgba(20,184,166,.3)}
.action-btn.btn-cyan{background:linear-gradient(145deg,#06b6d4,#0891b2);box-shadow:0 2px 8px rgba(6,182,212,.2)}
.action-btn.btn-red{background:linear-gradient(145deg,#f87171,#ef4444);box-shadow:0 2px 8px rgba(248,113,113,.2)}
.action-btn.btn-green{background:linear-gradient(145deg,#10b981,#059669);box-shadow:0 2px 8px rgba(16,185,129,.2)}
.action-btn.btn-orange{background:linear-gradient(145deg,#f97316,#ea580c);box-shadow:0 2px 8px rgba(249,115,22,.2)}
.action-btn:disabled{background:linear-gradient(145deg,#e5e7eb,#d1d5db)!important;color:#9ca3af;cursor:not-allowed;box-shadow:none}

/* Mix */
.mix-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;position:relative}
.mix-status{font-size:38px;font-weight:800;color:#134e4a;text-align:center;padding:14px 32px;background:linear-gradient(145deg,#ccfbf1,#99f6e4);border-radius:14px;border:2px solid #5eead4}
.mix-workspace{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;position:relative;width:100%}
.mix-ingredients-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;max-width:820px;width:100%}
.mix-ingredient{height:155px;background:linear-gradient(145deg,#f0fdfa,#ccfbf1);border:3px solid #99f6e4;border-radius:18px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:.2s;font-size:19px;font-weight:700;color:#134e4a;gap:2px}
.mix-ingredient:active{transform:scale(.93)}
.mix-ingredient .mi-emoji{width:90px;height:90px;display:flex;align-items:center;justify-content:center}
.mix-ingredient .mi-emoji svg{width:100%;height:100%}
.mix-ingredient.selected{border-color:#0d9488;background:linear-gradient(145deg,#ccfbf1,#99f6e4);box-shadow:0 0 20px rgba(13,148,136,.4)}
.mix-ingredient.used{opacity:.35;pointer-events:none}
.mix-bubble{position:absolute;border-radius:50%;background:rgba(255,255,255,.6);pointer-events:none;animation:bubUp var(--dur,1.5s) ease-out forwards}
@keyframes bubUp{0%{transform:translateY(0) scale(1);opacity:.8}100%{transform:translateY(var(--ty,-80px)) scale(0);opacity:0}}
.mix-discovery{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:38px;font-weight:900;color:#134e4a;text-align:center;background:rgba(255,255,255,.95);padding:18px 36px;border-radius:20px;border:3px solid #5eead4;box-shadow:0 8px 30px rgba(0,0,0,.2);z-index:20;animation:discoPop .5s ease-out;pointer-events:none}
@keyframes discoPop{0%{transform:translate(-50%,-50%) scale(0)}60%{transform:translate(-50%,-50%) scale(1.1)}100%{transform:translate(-50%,-50%) scale(1)}}

/* Weight */
.weight-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;position:relative}
.weight-question{font-size:42px;font-weight:800;color:#134e4a;background:linear-gradient(145deg,#ccfbf1,#99f6e4);padding:16px 36px;border-radius:16px;border:2px solid #5eead4}
.weight-items{display:flex;justify-content:center;gap:80px;margin-top:8px}
.weight-item{width:320px;height:320px;background:linear-gradient(145deg,#f0fdfa,#ccfbf1);border:4px solid #99f6e4;border-radius:24px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:.2s;gap:8px}
.weight-item:active{transform:scale(.95)}
.weight-item:hover{border-color:#0d9488;box-shadow:0 0 20px rgba(13,148,136,.3)}
.weight-item .wi-emoji{width:220px;height:220px;display:flex;align-items:center;justify-content:center}
.weight-item .wi-emoji svg{width:100%;height:100%}
.weight-item .wi-name{font-size:28px;font-weight:700;color:#134e4a}
.weight-result{font-size:38px;font-weight:800;text-align:center;min-height:40px;color:#0d9488}

/* Light */
.light-area{flex:1;display:flex;flex-direction:column;align-items:center;gap:10px;position:relative;overflow:hidden}
.light-mode-btns{display:flex;gap:10px;flex-shrink:0;padding-top:8px}
.light-mode-btn{padding:14px 32px;border:3px solid #99f6e4;border-radius:14px;background:linear-gradient(145deg,#f0fdfa,#ccfbf1);font-size:28px;font-weight:700;color:#134e4a;cursor:pointer;font-family:inherit;transition:.2s}
.light-mode-btn.active{background:linear-gradient(145deg,#14b8a6,#0d9488);color:#fff;border-color:#14b8a6}
.light-canvas{flex:1;width:100%;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden;background:linear-gradient(180deg,#0f172a 0%,#1e293b 100%);border-radius:16px;border:3px solid #334155}
.light-info{font-size:28px;font-weight:700;color:#134e4a;text-align:center;padding:8px}
.color-orb{position:absolute;border-radius:50%;cursor:pointer;transition:.15s;box-shadow:0 0 20px var(--glow,rgba(255,255,255,.3));width:140px;height:140px}
.color-orb:active{transform:scale(1.15)}
.light-result-text{position:absolute;font-size:22px;font-weight:900;pointer-events:none;animation:ltPop .8s ease-out forwards;z-index:10}
@keyframes ltPop{0%{transform:translate(-50%,-50%) scale(0);opacity:0}40%{transform:translate(-50%,-50%) scale(1.2);opacity:1}100%{transform:translate(-50%,-70%) scale(.8);opacity:0}}

/* Records */
.records-area{flex:1;display:flex;flex-direction:column;gap:20px;padding:20px;overflow-y:auto}
.record-card{background:linear-gradient(145deg,#fff,#f8fafc);border:2px solid #e2e8f0;border-radius:16px;padding:18px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.record-card h3{font-size:24px;font-weight:800;color:#1e293b;margin-bottom:10px}
.record-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.record-item{text-align:center;padding:16px;background:linear-gradient(145deg,#f0fdfa,#ccfbf1);border-radius:12px;border:2px solid #99f6e4}
.record-num{font-size:42px;font-weight:900;color:#0d9488}
.record-label{font-size:17px;font-weight:600;color:#134e4a;margin-top:4px}

/* Hero */
.hero-game{position:absolute;top:0;left:0;width:1920px;height:1080px;z-index:5000;display:flex;flex-direction:column;background:linear-gradient(180deg,#134e4a 0%,#0f766e 30%,#14b8a6 70%,#5eead4 100%);overflow:hidden}
.hero-game.hidden{display:none}
.hg-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(255,255,255,.15);backdrop-filter:blur(12px);flex-shrink:0;z-index:10;border-bottom:2px solid rgba(255,255,255,.2)}
.hg-stat{font-size:32px;font-weight:800;color:#fff}
.hg-hearts{font-size:30px;letter-spacing:3px}
.hg-ctrls{display:flex;gap:8px}
.hg-ctrl-btn{background:rgba(255,255,255,.3);border:2px solid rgba(255,255,255,.5);border-radius:50%;width:44px;height:44px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff}
.hg-ctrl-btn:active{transform:scale(.9)}
.hg-arena{flex:1;position:relative;overflow:hidden}
.hg-ground{position:absolute;bottom:0;left:0;right:0;height:140px;z-index:3;pointer-events:none;overflow:hidden}
.hg-deco{animation:decoFloat 6s ease-in-out infinite}
@keyframes decoFloat{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-15px) rotate(5deg)}50%{transform:translateY(-5px) rotate(-3deg)}75%{transform:translateY(-20px) rotate(4deg)}}
.hg-bg-sparkle{position:absolute;pointer-events:none;z-index:2;animation:bgSparkle 3s ease-in-out infinite}
@keyframes bgSparkle{0%,100%{transform:scale(.6);opacity:.3}50%{transform:scale(1.2);opacity:.8}}
.hg-drip{position:absolute;top:0;z-index:2;pointer-events:none;animation:dripDown 4s ease-in infinite}
@keyframes dripDown{0%{transform:translateY(-20px);opacity:.7}100%{transform:translateY(120px);opacity:0}}

/* === NEW 2-Tube System === */
.hg-tube-glass{position:absolute;bottom:60px;width:250px;z-index:5;pointer-events:none}
.hg-tube-glass.tube-a{left:10%}
.hg-tube-glass.tube-b{right:10%}

/* Tube label plate */
.hg-tube-nameplate{position:absolute;bottom:10px;width:250px;text-align:center;z-index:6;pointer-events:none}
.hg-tube-nameplate.plate-a{left:10%}
.hg-tube-nameplate.plate-b{right:10%}
.hg-tube-nameplate-inner{display:inline-flex;align-items:center;gap:8px;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);border-radius:14px;padding:8px 20px;border:2px solid rgba(255,255,255,.3)}
.hg-tube-nameplate-inner svg{width:50px;height:50px}
.hg-tube-nameplate-inner span{font-size:24px;font-weight:800;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.5)}

/* Liquid with sloshing */
.tube-liquid-fill{transition:height 0.6s cubic-bezier(.34,1.56,.64,1)}
.tube-liquid-fill.slosh{animation:liquidSlosh 0.8s ease-in-out}
@keyframes liquidSlosh{0%{transform:scaleY(1)}30%{transform:scaleY(1.15)}60%{transform:scaleY(0.9)}100%{transform:scaleY(1)}}

/* Bubbles inside tube */
.tube-bubble{position:absolute;border-radius:50%;background:rgba(255,255,255,.3);animation:bubbleRise var(--dur) ease-in infinite}
@keyframes bubbleRise{0%{transform:translateY(0) scale(1);opacity:.5}50%{opacity:.8}100%{transform:translateY(-350px) scale(0.3);opacity:0}}

/* Glow ring under tube */
.tube-glow-ring{position:absolute;bottom:50px;width:200px;height:30px;border-radius:50%;filter:blur(15px);animation:glowPulse 2s ease-in-out infinite;z-index:4;pointer-events:none}
.tube-glow-ring.glow-a{left:calc(10% + 25px)}
.tube-glow-ring.glow-b{right:calc(10% + 25px)}
@keyframes glowPulse{0%,100%{opacity:.4;transform:scale(1)}50%{opacity:.8;transform:scale(1.1)}}

/* Falling item with border glow */
.falling-item{position:absolute;z-index:8;pointer-events:auto;cursor:pointer}
.fi-body{width:120px;height:120px;background:linear-gradient(145deg,rgba(255,255,255,.15),rgba(255,255,255,.05));border:4px solid rgba(255,255,255,.3);border-radius:50%;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.fi-body svg{width:100px;height:100px}
.fi-body.border-red{border-color:#ef4444;box-shadow:0 0 20px rgba(239,68,68,.6),0 0 40px rgba(239,68,68,.3);animation:borderPulseRed 1.2s ease-in-out infinite}
.fi-body.border-blue{border-color:#3b82f6;box-shadow:0 0 20px rgba(59,130,246,.6),0 0 40px rgba(59,130,246,.3);animation:borderPulseBlue 1.2s ease-in-out infinite}
.fi-body.border-grey{border-color:#6b7280;box-shadow:0 0 8px rgba(107,114,128,.3);opacity:.7}
@keyframes borderPulseRed{0%,100%{box-shadow:0 0 20px rgba(239,68,68,.6),0 0 40px rgba(239,68,68,.3)}50%{box-shadow:0 0 30px rgba(239,68,68,.8),0 0 60px rgba(239,68,68,.5)}}
@keyframes borderPulseBlue{0%,100%{box-shadow:0 0 20px rgba(59,130,246,.6),0 0 40px rgba(59,130,246,.3)}50%{box-shadow:0 0 30px rgba(59,130,246,.8),0 0 60px rgba(59,130,246,.5)}}

/* Falling ingredient spin */
.falling-spin{animation:gentleSpin 3s linear infinite}
@keyframes gentleSpin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* Ingredient fly-to-tube */
.ingredient-fly{pointer-events:none!important;z-index:20!important}

/* Wrong tap */
.ingredient-wrong{animation:wrongShake 0.5s ease-in-out}
@keyframes wrongShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-15px)}40%{transform:translateX(15px)}60%{transform:translateX(-10px)}80%{transform:translateX(10px)}}

/* Tube splash when ingredient enters */
.tube-splash{animation:tubeSplash 0.6s ease-out}
@keyframes tubeSplash{0%{transform:scaleY(1)}20%{transform:scaleY(1.1) scaleX(1.05)}100%{transform:scaleY(1)}}

/* Epic reaction particles */
.reaction-particle{position:absolute;border-radius:50%;animation:particleBurst 1s ease-out forwards;pointer-events:none;z-index:30}
@keyframes particleBurst{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}}

/* Cork pop */
.cork-pop{animation:corkPop 0.8s cubic-bezier(.34,1.56,.64,1) forwards}
@keyframes corkPop{0%{transform:translateY(0) rotate(0)}50%{transform:translateY(-80px) rotate(180deg)}100%{transform:translateY(-120px) rotate(360deg);opacity:0}}

/* Confetti shower */
.hg-confetti{position:absolute;pointer-events:none;z-index:28;animation:confettiFall var(--dur,2s) linear forwards}
@keyframes confettiFall{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(var(--fall,600px)) rotate(var(--rot,720deg));opacity:0}}

/* Reaction central beaker */
.reaction-beaker{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:25;pointer-events:none;animation:beakerAppear .4s ease-out}
@keyframes beakerAppear{0%{transform:translate(-50%,-50%) scale(0)}100%{transform:translate(-50%,-50%) scale(1)}}

/* Reaction result text */
.reaction-result-text{position:absolute;left:50%;top:35%;transform:translate(-50%,-50%);z-index:26;pointer-events:none;font-size:64px;font-weight:900;color:#fff;text-shadow:0 4px 20px rgba(0,0,0,.5),0 0 40px rgba(94,234,212,.6);animation:resultZoom 1.2s ease-out forwards}
@keyframes resultZoom{0%{transform:translate(-50%,-50%) scale(0);opacity:0}30%{transform:translate(-50%,-50%) scale(1.4);opacity:1}100%{transform:translate(-50%,-60%) scale(1);opacity:0}}

/* Screen flash for reaction */
.hg-flash-white{position:absolute;inset:0;pointer-events:none;z-index:29;animation:hgFW .4s ease-out forwards}
@keyframes hgFW{0%{background:rgba(255,255,255,.6)}100%{background:transparent}}

.hg-flash-green{position:absolute;inset:0;pointer-events:none;z-index:30;animation:hgFG .3s ease-out forwards}
@keyframes hgFG{0%{background:rgba(34,197,94,.3)}100%{background:transparent}}
.hg-flash-red{position:absolute;inset:0;pointer-events:none;z-index:30;animation:hgFR .4s ease-out forwards}
@keyframes hgFR{0%{background:rgba(239,68,68,.3)}100%{background:transparent}}
.hg-shake{animation:hgSk .4s ease-out}
@keyframes hgSk{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
.hg-chain-text{position:absolute;font-size:48px;font-weight:900;color:#fbbf24;text-shadow:0 4px 12px rgba(0,0,0,.5);pointer-events:none;z-index:25;animation:chainP 1.2s ease-out forwards}
@keyframes chainP{0%{transform:translate(-50%,-50%) scale(0);opacity:0}30%{transform:translate(-50%,-50%) scale(1.3);opacity:1}100%{transform:translate(-50%,-80%) scale(.8);opacity:0}}
.hg-particle{position:absolute;border-radius:50%;pointer-events:none;animation:hgPa var(--dur,.7s) ease-out forwards}
@keyframes hgPa{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx,0),var(--ty,-40px)) scale(0);opacity:0}}
.hg-overlay{position:absolute;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(5px)}
.hg-overlay.hidden{display:none}
.hg-overlay-box{background:#fff;border-radius:24px;padding:40px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.3);min-width:320px}
.hg-overlay-box h2{font-size:36px;font-weight:900;color:#1e293b;margin-bottom:12px}
.hg-overlay-box .score{font-size:28px;font-weight:700;color:#0d9488;margin-bottom:8px}
.hg-overlay-box .msg{font-size:18px;color:#64748b;margin-bottom:20px}
.hg-overlay-box button{display:block;width:100%;padding:14px;border:none;border-radius:14px;font-size:18px;font-weight:800;cursor:pointer;margin-bottom:8px;font-family:inherit}
.hg-overlay-box .btn-retry{background:linear-gradient(145deg,#14b8a6,#0d9488);color:#fff}
.hg-overlay-box .btn-exit{background:linear-gradient(145deg,#e2e8f0,#cbd5e1);color:#475569}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:6000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px)}
.modal-overlay.hidden{display:none}
.modal-box{background:#fff;border-radius:20px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,.3)}
.modal-head{background:linear-gradient(145deg,#14b8a6,#0d9488);color:#fff;padding:16px 20px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center}
.modal-head h3{margin:0;font-size:18px}
.modal-close{background:0;border:0;color:#fff;font-size:24px;cursor:pointer}
.modal-body{padding:20px}
.modal-section{margin-bottom:16px;padding:14px;border-radius:10px;background:#f8fafc}
.modal-section h4{margin:0 0 10px;font-weight:700;color:#374151;font-size:15px}
.modal-input{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;margin-bottom:8px}
.modal-input:focus{outline:none;border-color:#14b8a6}
.modal-btn{padding:10px 16px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;width:100%;background:linear-gradient(145deg,#14b8a6,#0d9488);color:#fff;margin-top:6px}
.char-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:12px}
.char-item{background:linear-gradient(145deg,#f8fafc,#e2e8f0);border:2px solid #cbd5e1;border-radius:14px;padding:12px;text-align:center;cursor:pointer;font-size:32px;height:70px;display:flex;align-items:center;justify-content:center;transition:.2s}
.char-item.selected{background:linear-gradient(145deg,#5eead4,#2dd4bf);border-color:#2dd4bf}
.success-particle{position:absolute;pointer-events:none;z-index:20;animation:sPa var(--dur,.8s) ease-out forwards}
@keyframes sPa{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx,0),var(--ty,-50px)) scale(0);opacity:0}}
.dex-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.dex-item{padding:10px;border-radius:10px;text-align:center;font-size:13px;font-weight:600;border:2px solid #e2e8f0;background:#f8fafc}
.dex-item.discovered{border-color:#2dd4bf;background:linear-gradient(145deg,#f0fdfa,#ccfbf1)}
.dex-item.failed{border-color:#fca5a5;background:#fef2f2}
.dex-item .dex-emoji{font-size:28px;display:block;margin-bottom:2px}

/* ÌååÏõåÏóÖ ÏïÑÏù¥ÌÖú */
.hg-powerup{position:absolute;z-index:9;pointer-events:none;animation:puFloat 1.5s ease-in-out infinite}
@keyframes puFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.pu-body{width:75px;height:75px;background:linear-gradient(145deg,rgba(251,191,36,.3),rgba(245,158,11,.1));border:3px solid #fbbf24;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 20px rgba(251,191,36,.4);animation:puGlow 1s ease-in-out infinite}
.pu-body svg{width:55px;height:55px}
@keyframes puGlow{0%,100%{box-shadow:0 0 20px rgba(251,191,36,.4)}50%{box-shadow:0 0 35px rgba(251,191,36,.7)}}
.pu-active-indicator{position:absolute;top:60px;left:50%;transform:translateX(-50%);background:linear-gradient(145deg,#fbbf24,#f59e0b);color:#78350f;padding:6px 16px;border-radius:12px;font-size:14px;font-weight:800;white-space:nowrap;z-index:50;animation:puIndPop .3s ease-out}
@keyframes puIndPop{0%{transform:translateX(-50%) scale(0)}100%{transform:translateX(-50%) scale(1)}}

/* ÎπÑÏª§ Î∞òÏùë Ïù¥ÌéôÌä∏ */
.beaker-foam{position:absolute;border-radius:50%;background:rgba(255,255,255,.7);pointer-events:none;animation:foamRise var(--dur,2s) ease-out forwards}
@keyframes foamRise{0%{transform:translateY(0) scale(1);opacity:.8}60%{transform:translateY(var(--ty,-60px)) scale(1.2);opacity:.6}100%{transform:translateY(var(--ty2,-100px)) scale(0);opacity:0}}
.beaker-spark{position:absolute;width:4px;height:4px;background:#fbbf24;border-radius:50%;pointer-events:none;animation:bkSpark var(--dur,.6s) ease-out forwards}
@keyframes bkSpark{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx,0),var(--ty,-30px)) scale(0);opacity:0}}

/* Ï†ÄÏö∏ Ï∂îÍ∞Ä Ïù¥ÌéôÌä∏ */
.scale-wobble{animation:scWobble .6s ease-out}
@keyframes scWobble{0%{transform:rotate(0)}15%{transform:rotate(3deg)}30%{transform:rotate(-3deg)}45%{transform:rotate(2deg)}60%{transform:rotate(-1deg)}100%{transform:rotate(0)}}
.wt-correct-glow{animation:wtGlow 1s ease-out forwards}
@keyframes wtGlow{0%{filter:drop-shadow(0 0 0 transparent)}50%{filter:drop-shadow(0 0 30px rgba(34,197,94,.6))}100%{filter:drop-shadow(0 0 0 transparent)}}

/* ÌûàÏñ¥Î°ú ÏãúÌóòÍ¥Ä Î∞òÏùë */
.tube-react{animation:tubeReact .5s ease-out}
@keyframes tubeReact{0%{transform:scale(1)}30%{transform:scale(1.08)}60%{transform:scale(.97)}100%{transform:scale(1)}}
.hg-combo-text{position:absolute;font-size:42px;font-weight:900;color:#fbbf24;text-shadow:0 3px 8px rgba(0,0,0,.5);pointer-events:none;z-index:25;animation:comboFly 1s ease-out forwards}
@keyframes comboFly{0%{transform:translateY(0) scale(0);opacity:0}30%{transform:translateY(-10px) scale(1.2);opacity:1}100%{transform:translateY(-60px) scale(.7);opacity:0}}

/* ÌûàÏñ¥Î°ú Î†àÏãúÌîº ÌûåÌä∏ (HUGE banner) */
.hg-recipe-hint{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);backdrop-filter:blur(12px);border:3px solid rgba(255,255,255,.4);border-radius:20px;padding:16px 40px;font-size:34px;font-weight:900;color:#fff;z-index:15;text-align:center;white-space:nowrap;box-shadow:0 8px 30px rgba(0,0,0,.4)}
.hg-recipe-hint .recipe-icon{display:inline-block;width:60px;height:60px;vertical-align:middle}

/* HUD combo fire */
.hg-combo-fire{position:absolute;top:60px;right:30px;z-index:15;pointer-events:none;font-size:36px;font-weight:900;color:#fbbf24;text-shadow:0 0 20px rgba(251,191,36,.8);animation:firePulse 0.5s ease-in-out infinite}
@keyframes firePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}

/* Lab shelf background decoration */
.hg-lab-shelf{position:absolute;top:60px;left:0;right:0;z-index:1;pointer-events:none;opacity:.15}

/* Smoke wisps at bottom */
.hg-smoke{position:absolute;bottom:100px;z-index:2;pointer-events:none;animation:smokeFloat var(--dur,8s) ease-in-out infinite}
@keyframes smokeFloat{0%{transform:translateX(0) translateY(0);opacity:.15}50%{transform:translateX(var(--dx,30px)) translateY(-20px);opacity:.25}100%{transform:translateX(0) translateY(0);opacity:.15}}

/* ÌîÑÎ¶¨Ï¶ò Ï∂îÍ∞Ä */
.prism-glow{animation:prismGlow 2s ease-in-out infinite}
@keyframes prismGlow{0%,100%{filter:drop-shadow(0 0 10px rgba(94,234,212,.3))}50%{filter:drop-shadow(0 0 30px rgba(94,234,212,.7))}}

/* ÏÉâ ÌòºÌï© Í≤∞Í≥º Ïù¥ÌéôÌä∏ */
.color-mix-burst{position:absolute;border-radius:50%;pointer-events:none;animation:cmBurst .8s ease-out forwards;z-index:5}
@keyframes cmBurst{0%{transform:translate(-50%,-50%) scale(0);opacity:.8}100%{transform:translate(-50%,-50%) scale(3);opacity:0}}

/* Í∑∏Î¶ºÏûê Î™®Îìú Ïù¥ÌéôÌä∏ */
.shadow-info-badge{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(251,191,36,.9);color:#78350f;padding:10px 24px;border-radius:12px;font-size:20px;font-weight:800;z-index:10;pointer-events:none}

/* ===== ÎπÑÏ£ºÏñº ÏóÖÍ∑∏Î†àÏù¥Îìú ===== */
/* ÌÉ≠Î≥Ñ Î∞∞Í≤Ω Ïî¨ */
.mix-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:
  url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 900'><rect fill='%23f0fdfa' width='1320' height='900'/><rect x='0' y='700' width='1320' height='200' fill='%23ccfbf1'/><rect x='40' y='150' width='60' height='500' rx='8' fill='%23fff' opacity='.4'/><rect x='42' y='170' width='56' height='4' rx='2' fill='%2314b8a6' opacity='.2'/><rect x='42' y='220' width='56' height='4' rx='2' fill='%2314b8a6' opacity='.2'/><rect x='42' y='270' width='56' height='4' rx='2' fill='%2314b8a6' opacity='.2'/><rect x='1220' y='150' width='60' height='500' rx='8' fill='%23fff' opacity='.4'/><text x='660' y='50' text-anchor='middle' font-size='28' fill='%230d9488' opacity='.08' font-weight='900'>SCIENCE LAB</text><circle cx='200' cy='800' r='30' fill='%2314b8a6' opacity='.1'/><circle cx='1100' cy='810' r='25' fill='%2314b8a6' opacity='.08'/></svg>") center/cover no-repeat;
  opacity:.2;border-radius:16px}
.mix-view{position:relative}

.weight-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:
  url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 900'><rect fill='%23ecfeff' width='1320' height='900'/><rect x='0' y='750' width='1320' height='150' fill='%23cffafe'/><text x='200' y='830' font-size='80' fill='%2306b6d4' opacity='.05'>‚öñÔ∏è</text><text x='1000' y='150' font-size='60' fill='%2306b6d4' opacity='.05'>üî¨</text></svg>") center/cover no-repeat;
  opacity:.25;border-radius:16px}
.weight-view{position:relative}

.light-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:
  url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 900'><rect fill='%231e1b4b' width='1320' height='900'/><circle cx='660' cy='450' r='300' fill='none' stroke='%23818cf8' stroke-width='1' opacity='.1'><animate attributeName='r' values='300;350;300' dur='5s' repeatCount='indefinite'/></circle><circle cx='300' cy='300' r='200' fill='none' stroke='%23c084fc' stroke-width='1' opacity='.08'><animate attributeName='r' values='200;240;200' dur='4s' repeatCount='indefinite'/></circle><circle cx='1000' cy='600' r='180' fill='none' stroke='%2322d3ee' stroke-width='1' opacity='.1'><animate attributeName='r' values='180;220;180' dur='3.5s' repeatCount='indefinite'/></circle></svg>") center/cover no-repeat;
  opacity:.15;border-radius:16px}
.light-view{position:relative}

.record-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:
  url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 900'><defs><linearGradient id='rg' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%23f0fdfa'/><stop offset='100%' stop-color='%23ccfbf1'/></linearGradient></defs><rect fill='url(%23rg)' width='1320' height='900'/><rect x='80' y='50' width='200' height='12' rx='6' fill='%230d9488' opacity='.08'/><rect x='80' y='80' width='160' height='12' rx='6' fill='%230d9488' opacity='.06'/><text x='660' y='860' text-anchor='middle' font-size='100' fill='%230d9488' opacity='.04' font-weight='900'>üèÜ</text></svg>") center/cover no-repeat;
  opacity:.2;border-radius:16px}
.record-view{position:relative}

/* 3D ÏïÑÏºÄÏù¥Îìú Î≤ÑÌäº */
.tab-btn{border-bottom:5px solid #7c8a9a;transition:transform .1s,border-bottom-width .1s}
.tab-btn:active{transform:translateY(3px) scaleX(1.02) scaleY(.97);border-bottom-width:2px}
.tab-btn.active{border-bottom:5px solid #115e59}
.tab-btn.active:active{border-bottom-width:2px}

.action-btn{border-bottom:6px solid rgba(0,0,0,.25);transition:transform .1s,border-bottom-width .1s}
.action-btn:active{transform:translateY(4px) scaleX(1.02) scaleY(.97)!important;border-bottom-width:2px}
.action-btn.btn-teal{border-bottom-color:#115e59}
.action-btn.btn-cyan{border-bottom-color:#0e7490}
.action-btn.btn-green{border-bottom-color:#047857}
.action-btn.btn-red{border-bottom-color:#b91c1c}
.action-btn.btn-rose{border-bottom-color:#be123c}

.game-launch-btn{border-bottom:6px solid #115e59;transition:transform .1s,border-bottom-width .1s;position:relative;overflow:hidden}
.game-launch-btn:active{transform:translateY(4px) scaleX(1.02) scaleY(.97)!important;border-bottom-width:2px;animation:none}
.game-launch-btn::after{content:'';position:absolute;top:0;left:-100%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.18),transparent);animation:btnShine 3s ease-in-out infinite}
@keyframes btnShine{0%,100%{left:-100%}50%{left:150%}}

/* Ìå®ÎÑê ÎπÑÏ£ºÏñº Î≥¥Í∞ï */
.side-info::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#14b8a6,#2dd4bf,#5eead4,#2dd4bf,#14b8a6);border-radius:16px 16px 0 0}
.side-info{position:relative}
.side-stat{box-shadow:0 2px 6px rgba(20,184,166,.08);transition:transform .15s}
.side-stat:hover{transform:translateX(4px)}
.side-val{text-shadow:0 1px 4px rgba(13,148,136,.2)}

.right-panel::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 30%,rgba(20,184,166,.06) 0%,transparent 70%);pointer-events:none;border-radius:20px;z-index:0}
.right-panel{position:relative}
.action-btn .icon{filter:drop-shadow(0 2px 4px rgba(0,0,0,.15))}

.record-card{backdrop-filter:blur(5px);background:linear-gradient(145deg,rgba(255,255,255,.9),rgba(248,250,252,.9));transition:transform .15s}
.record-card:hover{transform:translateY(-2px)}

/* ÌÉ≠ Ï†ÑÌôò Ïï†ÎãàÎ©îÏù¥ÏÖò */
@keyframes viewFadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
.game-view.active{animation:viewFadeIn .3s ease-out}

/* Ïä§ÏΩîÏñ¥ ÌåùÏóÖ */
.score-popup{position:absolute;font-size:28px;font-weight:900;color:#0d9488;pointer-events:none;z-index:50;animation:scorePop .9s ease-out forwards;text-shadow:0 2px 4px rgba(0,0,0,.2);paint-order:stroke fill;-webkit-text-stroke:2px #fff}
@keyframes scorePop{0%{opacity:1;transform:translateY(0) scale(.5)}40%{transform:translateY(-30px) scale(1.2)}100%{opacity:0;transform:translateY(-70px) scale(.8)}}

/* Î†àÎ≤®ÏóÖ Ïò§Î≤ÑÎ†àÏù¥ */
.levelup-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9000;pointer-events:none;background:rgba(20,184,166,.15)}
.levelup-box{background:linear-gradient(145deg,#14b8a6,#0d9488);color:#fff;padding:30px 60px;border-radius:24px;font-size:42px;font-weight:900;text-shadow:0 3px 8px rgba(0,0,0,.3);border:4px solid #5eead4;box-shadow:0 12px 40px rgba(20,184,166,.5);animation:lvPop .8s cubic-bezier(.34,1.56,.64,1) forwards}
@keyframes lvPop{0%{transform:scale(0) rotate(-10deg);opacity:0}50%{transform:scale(1.15) rotate(3deg);opacity:1}100%{transform:scale(1) rotate(0);opacity:0}}

/* ÎßàÏä§ÏΩîÌä∏ */
.mascot-wrap{position:absolute;z-index:5;pointer-events:none}
.mascot-bubble{position:absolute;top:-40px;left:50%;transform:translateX(-50%);background:#fff;border-radius:12px;padding:6px 14px;font-size:14px;font-weight:700;color:#115e59;white-space:nowrap;box-shadow:0 3px 10px rgba(0,0,0,.15);opacity:0;transition:opacity .3s}
.mascot-bubble.show{opacity:1}
.mascot-bubble::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);border:8px solid transparent;border-top-color:#fff}

/* ÌûàÏñ¥Î°ú ÌäúÌÜ†Î¶¨Ïñº */
.hg-tutorial{position:absolute;inset:0;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;z-index:200;color:#fff;animation:tutFadeIn .5s ease-out}
@keyframes tutFadeIn{0%{opacity:0}100%{opacity:1}}
.hg-tut-step{display:flex;align-items:center;gap:20px;font-size:32px;font-weight:800}
.hg-tut-icon{font-size:70px;flex-shrink:0}
.hg-tut-icon svg{width:70px;height:70px}
.hg-tut-text{font-size:32px}
.hg-countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:200;font-size:140px;font-weight:900;color:#fff;text-shadow:0 8px 30px rgba(0,0,0,.5)}
.tube-glow{animation:tubeGlowAnim 1s ease-in-out infinite}
@keyframes tubeGlowAnim{0%,100%{filter:drop-shadow(0 0 5px rgba(94,234,212,.3))}50%{filter:drop-shadow(0 0 25px rgba(94,234,212,.8))}}

/* ÎπõÎÜÄÏù¥ÌÑ∞ ÏïàÎÇ¥ ÎßêÌíçÏÑ† */
.light-guide-bubble{background:linear-gradient(145deg,rgba(251,191,36,.95),rgba(245,158,11,.95));color:#78350f;padding:14px 28px;border-radius:20px;font-size:28px;font-weight:800;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,.3);position:relative;flex-shrink:0;z-index:5}
.light-guide-bubble::after{content:'';position:absolute;bottom:-12px;left:50%;transform:translateX(-50%);border:12px solid transparent;border-top-color:rgba(251,191,36,.95)}
.light-orb-check{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;pointer-events:none;z-index:10;animation:checkPop .3s ease-out}
@keyframes checkPop{0%{transform:translate(-50%,-50%) scale(0)}100%{transform:translate(-50%,-50%) scale(1)}}

/* Í∑∏Î¶ºÏûê Î™®Îìú ÎìúÎûòÍ∑∏ ÌûåÌä∏ */
.shadow-drag-hint{position:absolute;pointer-events:none;z-index:10;animation:dragHintFloat 1.5s ease-in-out infinite}
@keyframes dragHintFloat{0%,100%{transform:translateX(-10px);opacity:.7}50%{transform:translateX(10px);opacity:1}}
</style>
</head>
<body>
<div class="rotate-notice"><div class="rotate-icon">üì±</div>ÌôîÎ©¥ÏùÑ Í∞ÄÎ°úÎ°ú ÎèåÎ†§Ï£ºÏÑ∏Ïöî!</div>

<div class="container">
  <div class="subject-bar">
    <button class="sb-tab active">üî¨ Í≥ºÌïô</button>
    <div class="sb-spacer"></div>
    <div class="sb-btns">
      <button class="sb-btn" id="sb-sound" onclick="toggleSound()">üîä</button>
      <button class="sb-btn" onclick="showAdmin()">‚öôÔ∏è</button>
    </div>
  </div>

  <div class="main-layout">
    <div class="left-panel">
      <div class="profile-section">
        <div class="profile-content">
          <div class="profile-avatar" onclick="showCharModal()"><span id="pf-char">üßí</span></div>
          <div class="profile-info">
            <div class="profile-name" onclick="changeName()"><span id="pf-name">Í≥ºÌïôÏûê</span></div>
            <div class="profile-level-container">
              <div class="profile-level">
                <span class="level-badge">LV.<span id="pf-level">1</span></span>
                <span id="pf-done">0</span>/<span id="pf-total">10</span>
              </div>
              <div class="progress-bar"><div class="progress-fill" id="pf-bar" style="width:0%"></div></div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-headers">
        <button class="tab-btn active" onclick="switchTab('mix')">üß™ ÏÑûÏñ¥Î≥ºÍπå?</button>
        <button class="tab-btn" onclick="switchTab('weight')">‚öñÔ∏è Ï†ÄÏö∏ÎÜÄÏù¥</button>
        <button class="tab-btn" onclick="switchTab('light')">üí° Îπõ ÎÜÄÏù¥ÌÑ∞</button>
        <button class="tab-btn" onclick="switchTab('record')">üìä ÎÇ¥ Í∏∞Î°ù</button>
      </div>
      <div class="tab-content mix-side active">
        <div class="side-info">
          <div class="side-title">üß™ Ïã§Ìóò ÎèÑÍ∞ê</div>
          <div class="side-stat"><span>Î∞úÍ≤¨</span><span class="side-val" id="mix-discovered">0</span></div>
          <div class="side-stat"><span>ÏãúÎèÑ</span><span class="side-val" id="mix-tried">0</span></div>
          <div class="side-stat"><span>Ïó∞ÏÜç ÏÑ±Í≥µ</span><span class="side-val" id="mix-streak">0</span></div>
          <div class="side-stat"><span>Ï†êÏàò</span><span class="side-val" id="mix-score-side">0</span></div>
        </div>
      </div>
      <div class="tab-content weight-side">
        <div class="side-info">
          <div class="side-title">‚öñÔ∏è Ï†ÄÏö∏ÎÜÄÏù¥</div>
          <div class="side-stat"><span>Î¨∏Ï†ú</span><span class="side-val" id="wt-qnum">1</span></div>
          <div class="side-stat"><span>Ï†ïÎãµ</span><span class="side-val" id="wt-correct">0</span></div>
          <div class="side-stat"><span>Ïó∞ÏÜç</span><span class="side-val" id="wt-streak">0</span></div>
          <div class="side-stat"><span>Ï†êÏàò</span><span class="side-val" id="wt-score-side">0</span></div>
        </div>
      </div>
      <div class="tab-content light-side">
        <div class="side-info">
          <div class="side-title">üí° Îπõ ÎÜÄÏù¥ÌÑ∞</div>
          <div class="side-stat"><span>Î™®Îìú</span><span class="side-val" id="lt-mode">ÌîÑÎ¶¨Ï¶ò</span></div>
          <div class="side-stat"><span>ÌòºÌï© Ïàò</span><span class="side-val" id="lt-mixes">0</span></div>
          <div class="side-stat"><span>Ï†êÏàò</span><span class="side-val" id="lt-score-side">0</span></div>
        </div>
      </div>
      <div class="tab-content record-side">
        <div class="side-info">
          <div class="side-title">üìä Ï¢ÖÌï© Í∏∞Î°ù</div>
          <div class="side-stat"><span>Ï¥ù Ïã§Ìóò</span><span class="side-val" id="rec-total">0</span></div>
          <div class="side-stat"><span>ÏÑ±Í≥µÎ•†</span><span class="side-val" id="rec-rate">0%</span></div>
        </div>
      </div>
      <div class="game-launch-btn" onclick="startHeroGame()">‚ö° Ïã§Ìóò Ï≤¥Ïù∏ ÏãúÏûë!</div>
    </div>

    <div class="center-panel">
      <!-- Mix -->
      <div class="game-view mix-view active" id="mix-view">
        <!-- ÎßàÏä§ÏΩîÌä∏ "ÌîåÎùºÏä§ÌÅ¨" mix -->
        <div class="mascot-wrap" style="bottom:16px;right:16px">
          <div class="mascot-bubble" id="bubble-mix">Ïã§Ìóò!</div>
          <svg width="100" height="140" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="flaskBodyM" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#5eead4"/><stop offset="100%" stop-color="#0d9488"/></linearGradient></defs>
            <!-- Îã§Î¶¨ -->
            <g><rect x="32" y="118" width="12" height="18" rx="6" fill="#0d9488"><animateTransform attributeName="transform" type="rotate" values="-3,38,130;3,38,130;-3,38,130" dur="1.5s" repeatCount="indefinite"/></rect></g>
            <g><rect x="56" y="118" width="12" height="18" rx="6" fill="#0d9488"><animateTransform attributeName="transform" type="rotate" values="3,62,130;-3,62,130;3,62,130" dur="1.5s" repeatCount="indefinite"/></rect></g>
            <!-- Î™∏ÌÜµ (ÌîåÎùºÏä§ÌÅ¨) -->
            <path d="M38,30 L38,55 L22,100 Q18,112 30,115 L70,115 Q82,112 78,100 L62,55 L62,30" fill="url(#flaskBodyM)" stroke="#115e59" stroke-width="2"/>
            <!-- Î™© -->
            <rect x="36" y="18" width="28" height="14" rx="4" fill="#14b8a6" stroke="#115e59" stroke-width="1.5"/>
            <rect x="34" y="16" width="32" height="5" rx="2.5" fill="#0d9488"/>
            <!-- Ïï°Ï≤¥ -->
            <ellipse cx="50" cy="102" rx="22" ry="8" fill="#22c55e" opacity=".5"><animate attributeName="rx" values="22;25;22" dur="2s" repeatCount="indefinite"/></ellipse>
            <circle cx="40" cy="96" r="4" fill="#4ade80" opacity=".5"><animate attributeName="cy" values="96;90;96" dur="1.8s" repeatCount="indefinite"/></circle>
            <circle cx="58" cy="94" r="3" fill="#86efac" opacity=".6"><animate attributeName="cy" values="94;88;94" dur="2.2s" repeatCount="indefinite"/></circle>
            <!-- Îàà -->
            <circle cx="42" cy="42" r="5" fill="#fff"/>
            <circle cx="58" cy="42" r="5" fill="#fff"/>
            <circle cx="42.5" cy="42.5" r="3" fill="#115e59"><animate attributeName="r" values="3;0.4;3" dur="4s" repeatCount="indefinite"/></circle>
            <circle cx="58.5" cy="42.5" r="3" fill="#115e59"><animate attributeName="r" values="3;0.4;3" dur="4s" repeatCount="indefinite"/></circle>
            <!-- Î≥º -->
            <ellipse cx="36" cy="50" rx="4" ry="2.5" fill="#f9a8d4" opacity=".3"/>
            <ellipse cx="64" cy="50" rx="4" ry="2.5" fill="#f9a8d4" opacity=".3"/>
            <!-- ÏûÖ -->
            <path id="mascot-mix-mouth" d="M44,54 Q50,62 56,54" fill="none" stroke="#115e59" stroke-width="2" stroke-linecap="round"/>
            <!-- Ïò§Î•∏ÏÜêÏóê ÎπÑÏª§ -->
            <g transform="translate(72,55)">
              <path d="M0,0 L0,22 Q0,28 4,28 L12,28 Q16,28 16,22 L16,0" fill="rgba(255,255,255,.2)" stroke="#5eead4" stroke-width="1.5"/>
              <line x1="-2" y1="0" x2="18" y2="0" stroke="#5eead4" stroke-width="2"/>
              <ellipse cx="8" cy="22" rx="6" ry="4" fill="#22c55e" opacity=".4"/>
              <circle cx="6" cy="18" r="2" fill="#fff" opacity=".5"><animate attributeName="cy" values="18;14;18" dur="1.5s" repeatCount="indefinite"/></circle>
              <circle cx="10" cy="16" r="1.5" fill="#fff" opacity=".4"><animate attributeName="cy" values="16;12;16" dur="2s" repeatCount="indefinite"/></circle>
            </g>
          </svg>
        </div>
        <div class="mix-area" id="mix-area">
          <div class="mix-status" id="mix-status">Ïû¨Î£å 2Í∞úÎ•º Í≥®Îùº ÎπÑÏª§Ïóê ÎÑ£Ïñ¥Î≥¥ÏÑ∏Ïöî!</div>
          <div class="mix-workspace">
            <div class="mix-ingredients-row" id="mix-ingredients"></div>
            <div style="display:flex;align-items:center;justify-content:center;gap:20px">
              <div id="mix-sel-display" style="display:flex;align-items:center;gap:12px;min-width:200px;justify-content:flex-end">
                <span id="mix-sel-a" style="width:60px;height:60px;display:inline-flex;align-items:center;justify-content:center;border:3px dashed #99f6e4;border-radius:12px;background:rgba(255,255,255,.2)">?</span>
                <span style="font-size:28px;font-weight:900;color:#0d9488">+</span>
                <span id="mix-sel-b" style="width:60px;height:60px;display:inline-flex;align-items:center;justify-content:center;border:3px dashed #99f6e4;border-radius:12px;background:rgba(255,255,255,.2)">?</span>
              </div>
              <span style="font-size:32px;font-weight:900;color:#0d9488">‚Üí</span>
              <svg class="mix-beaker-svg" width="100" height="140" viewBox="0 0 140 200">
                <defs>
                  <linearGradient id="beakerGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="rgba(255,255,255,.3)"/><stop offset="100%" stop-color="rgba(255,255,255,.05)"/></linearGradient>
                  <clipPath id="beakerClip"><path d="M25 10 L25 140 Q25 180 50 190 L90 190 Q115 180 115 140 L115 10 Z"/></clipPath>
                </defs>
                <path d="M25 10 L25 140 Q25 180 50 190 L90 190 Q115 180 115 140 L115 10" fill="url(#beakerGrad)" stroke="#99f6e4" stroke-width="3"/>
                <rect id="beaker-liquid" x="25" y="190" width="90" height="0" fill="#5eead4" opacity=".6" clip-path="url(#beakerClip)"/>
                <line x1="20" y1="10" x2="120" y2="10" stroke="#99f6e4" stroke-width="4" stroke-linecap="round"/>
                <line x1="30" y1="60" x2="38" y2="60" stroke="#99f6e4" stroke-width="1.5" opacity=".5"/>
                <line x1="30" y1="100" x2="38" y2="100" stroke="#99f6e4" stroke-width="1.5" opacity=".5"/>
                <line x1="30" y1="140" x2="38" y2="140" stroke="#99f6e4" stroke-width="1.5" opacity=".5"/>
              </svg>
            </div>
          </div>
          <div style="display:flex;gap:16px;margin-top:10px">
            <button style="padding:14px 36px;border:3px solid #5eead4;border-radius:14px;background:linear-gradient(145deg,#14b8a6,#0d9488);color:#fff;font-size:22px;font-weight:800;cursor:pointer;font-family:inherit" onclick="mixConfirm()">üß™ ÏÑûÍ∏∞!</button>
            <button style="padding:14px 36px;border:3px solid #fca5a5;border-radius:14px;background:linear-gradient(145deg,#f87171,#ef4444);color:#fff;font-size:22px;font-weight:800;cursor:pointer;font-family:inherit" onclick="mixReset()">üîÑ Îã§Ïãú</button>
            <button style="padding:14px 36px;border:3px solid #99f6e4;border-radius:14px;background:linear-gradient(145deg,#f0fdfa,#ccfbf1);color:#134e4a;font-size:22px;font-weight:800;cursor:pointer;font-family:inherit" onclick="showDex()">üìñ ÎèÑÍ∞ê</button>
          </div>
        </div>
      </div>

      <!-- Weight -->
      <div class="game-view weight-view" id="weight-view">
        <div class="weight-area" id="weight-area">
          <div class="weight-question" id="wt-question">Ïñ¥Îñ§ Í≤å Îçî Î¨¥Í±∞Ïö∏Íπå?</div>
          <svg id="scale-svg" width="700" height="320" viewBox="0 0 700 320" style="flex-shrink:0">
            <defs><linearGradient id="scaleBase" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#64748b"/><stop offset="100%" stop-color="#475569"/></linearGradient></defs>
            <rect x="320" y="260" width="60" height="60" rx="8" fill="url(#scaleBase)"/>
            <polygon points="290,260 410,260 386,210 314,210" fill="#94a3b8"/>
            <g id="scale-beam" style="transform-origin:350px 210px;transition:transform .8s cubic-bezier(.34,1.56,.64,1)">
              <rect x="80" y="205" width="540" height="10" rx="5" fill="#94a3b8"/>
              <circle cx="350" cy="210" r="14" fill="#64748b" stroke="#94a3b8" stroke-width="2"/>
              <g id="scale-left-g"><line x1="140" y1="215" x2="140" y2="252" stroke="#64748b" stroke-width="3"/><ellipse cx="140" cy="258" rx="75" ry="16" fill="#e2e8f0" stroke="#94a3b8" stroke-width="2"/><text id="scale-left-emoji" x="140" y="248" text-anchor="middle" font-size="28" font-weight="700" fill="#334155"></text></g>
              <g id="scale-right-g"><line x1="560" y1="215" x2="560" y2="252" stroke="#64748b" stroke-width="3"/><ellipse cx="560" cy="258" rx="75" ry="16" fill="#e2e8f0" stroke="#94a3b8" stroke-width="2"/><text id="scale-right-emoji" x="560" y="248" text-anchor="middle" font-size="28" font-weight="700" fill="#334155"></text></g>
            </g>
          </svg>
          <div class="weight-items" id="wt-items"></div>
          <div class="weight-result" id="wt-result"></div>
        </div>
        <!-- ÎßàÏä§ÏΩîÌä∏ "ÌîåÎùºÏä§ÌÅ¨" weight -->
        <div class="mascot-wrap" style="bottom:16px;right:16px">
          <div class="mascot-bubble" id="bubble-wt">Î¨¥Í≤å!</div>
          <svg width="100" height="140" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="flaskBodyW" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#5eead4"/><stop offset="100%" stop-color="#0d9488"/></linearGradient></defs>
            <g><rect x="32" y="118" width="12" height="18" rx="6" fill="#0d9488"><animateTransform attributeName="transform" type="rotate" values="-3,38,130;3,38,130;-3,38,130" dur="1.5s" repeatCount="indefinite"/></rect></g>
            <g><rect x="56" y="118" width="12" height="18" rx="6" fill="#0d9488"><animateTransform attributeName="transform" type="rotate" values="3,62,130;-3,62,130;3,62,130" dur="1.5s" repeatCount="indefinite"/></rect></g>
            <path d="M38,30 L38,55 L22,100 Q18,112 30,115 L70,115 Q82,112 78,100 L62,55 L62,30" fill="url(#flaskBodyW)" stroke="#115e59" stroke-width="2"/>
            <rect x="36" y="18" width="28" height="14" rx="4" fill="#14b8a6" stroke="#115e59" stroke-width="1.5"/>
            <rect x="34" y="16" width="32" height="5" rx="2.5" fill="#0d9488"/>
            <ellipse cx="50" cy="102" rx="22" ry="8" fill="#22c55e" opacity=".5"><animate attributeName="rx" values="22;25;22" dur="2s" repeatCount="indefinite"/></ellipse>
            <circle cx="40" cy="96" r="4" fill="#4ade80" opacity=".5"><animate attributeName="cy" values="96;90;96" dur="1.8s" repeatCount="indefinite"/></circle>
            <circle cx="58" cy="94" r="3" fill="#86efac" opacity=".6"><animate attributeName="cy" values="94;88;94" dur="2.2s" repeatCount="indefinite"/></circle>
            <circle cx="42" cy="42" r="5" fill="#fff"/>
            <circle cx="58" cy="42" r="5" fill="#fff"/>
            <circle cx="42.5" cy="42.5" r="3" fill="#115e59"><animate attributeName="r" values="3;0.4;3" dur="4s" repeatCount="indefinite"/></circle>
            <circle cx="58.5" cy="42.5" r="3" fill="#115e59"><animate attributeName="r" values="3;0.4;3" dur="4s" repeatCount="indefinite"/></circle>
            <ellipse cx="36" cy="50" rx="4" ry="2.5" fill="#f9a8d4" opacity=".3"/>
            <ellipse cx="64" cy="50" rx="4" ry="2.5" fill="#f9a8d4" opacity=".3"/>
            <path id="mascot-wt-mouth" d="M44,54 Q50,62 56,54" fill="none" stroke="#115e59" stroke-width="2" stroke-linecap="round"/>
            <!-- Ïò§Î•∏ÏÜêÏóê ÎØ∏Îãà Ï†ÄÏö∏ -->
            <g transform="translate(72,50)">
              <line x1="8" y1="0" x2="8" y2="18" stroke="#64748b" stroke-width="2"/>
              <rect x="4" y="16" width="8" height="6" rx="2" fill="#94a3b8"/>
              <line x1="0" y1="6" x2="16" y2="6" stroke="#64748b" stroke-width="2" stroke-linecap="round"/>
              <circle cx="8" cy="4" r="2.5" fill="#94a3b8"/>
              <line x1="2" y1="6" x2="2" y2="12" stroke="#94a3b8" stroke-width="1"/>
              <ellipse cx="2" cy="13" rx="4" ry="2" fill="#cbd5e1"/>
              <line x1="14" y1="6" x2="14" y2="12" stroke="#94a3b8" stroke-width="1"/>
              <ellipse cx="14" cy="13" rx="4" ry="2" fill="#cbd5e1"/>
            </g>
          </svg>
        </div>
      </div>

      <!-- Light -->
      <div class="game-view light-view" id="light-view">
        <div class="light-area">
          <div class="light-mode-btns">
            <button class="light-mode-btn active" onclick="setLightMode('prism')">üî∫ ÌîÑÎ¶¨Ï¶ò</button>
            <button class="light-mode-btn" onclick="setLightMode('colormix')">üé® ÏÉâ ÌòºÌï©</button>
            <button class="light-mode-btn" onclick="setLightMode('shadow')">üë§ Í∑∏Î¶ºÏûê</button>
          </div>
          <div class="light-canvas" id="light-canvas"></div>
          <div class="light-info" id="light-info">ÌîÑÎ¶¨Ï¶òÏóê ÎπõÏùÑ ÌÜµÍ≥ºÏãúÏºú Î¨¥ÏßÄÍ∞úÎ•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</div>
        </div>
        <!-- ÎßàÏä§ÏΩîÌä∏ "ÌîåÎùºÏä§ÌÅ¨" light -->
        <div class="mascot-wrap" style="bottom:16px;right:16px">
          <div class="mascot-bubble" id="bubble-lt">Îπõ!</div>
          <svg width="100" height="140" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="flaskBodyL" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#5eead4"/><stop offset="100%" stop-color="#0d9488"/></linearGradient></defs>
            <g><rect x="32" y="118" width="12" height="18" rx="6" fill="#0d9488"><animateTransform attributeName="transform" type="rotate" values="-3,38,130;3,38,130;-3,38,130" dur="1.5s" repeatCount="indefinite"/></rect></g>
            <g><rect x="56" y="118" width="12" height="18" rx="6" fill="#0d9488"><animateTransform attributeName="transform" type="rotate" values="3,62,130;-3,62,130;3,62,130" dur="1.5s" repeatCount="indefinite"/></rect></g>
            <path d="M38,30 L38,55 L22,100 Q18,112 30,115 L70,115 Q82,112 78,100 L62,55 L62,30" fill="url(#flaskBodyL)" stroke="#115e59" stroke-width="2"/>
            <rect x="36" y="18" width="28" height="14" rx="4" fill="#14b8a6" stroke="#115e59" stroke-width="1.5"/>
            <rect x="34" y="16" width="32" height="5" rx="2.5" fill="#0d9488"/>
            <ellipse cx="50" cy="102" rx="22" ry="8" fill="#22c55e" opacity=".5"><animate attributeName="rx" values="22;25;22" dur="2s" repeatCount="indefinite"/></ellipse>
            <circle cx="40" cy="96" r="4" fill="#4ade80" opacity=".5"><animate attributeName="cy" values="96;90;96" dur="1.8s" repeatCount="indefinite"/></circle>
            <circle cx="58" cy="94" r="3" fill="#86efac" opacity=".6"><animate attributeName="cy" values="94;88;94" dur="2.2s" repeatCount="indefinite"/></circle>
            <circle cx="42" cy="42" r="5" fill="#fff"/>
            <circle cx="58" cy="42" r="5" fill="#fff"/>
            <circle cx="42.5" cy="42.5" r="3" fill="#115e59"><animate attributeName="r" values="3;0.4;3" dur="4s" repeatCount="indefinite"/></circle>
            <circle cx="58.5" cy="42.5" r="3" fill="#115e59"><animate attributeName="r" values="3;0.4;3" dur="4s" repeatCount="indefinite"/></circle>
            <ellipse cx="36" cy="50" rx="4" ry="2.5" fill="#f9a8d4" opacity=".3"/>
            <ellipse cx="64" cy="50" rx="4" ry="2.5" fill="#f9a8d4" opacity=".3"/>
            <path id="mascot-lt-mouth" d="M44,54 Q50,62 56,54" fill="none" stroke="#115e59" stroke-width="2" stroke-linecap="round"/>
            <!-- Ïò§Î•∏ÏÜêÏóê ÌîÑÎ¶¨Ï¶ò + Î¨¥ÏßÄÍ∞ú -->
            <g transform="translate(70,48)">
              <polygon points="10,0 20,20 0,20" fill="rgba(255,255,255,.15)" stroke="#5eead4" stroke-width="1.5"/>
              <line x1="20" y1="8" x2="30" y2="4" stroke="#ef4444" stroke-width="1.5" opacity=".7"/>
              <line x1="20" y1="11" x2="30" y2="8" stroke="#f97316" stroke-width="1.5" opacity=".7"/>
              <line x1="20" y1="14" x2="30" y2="12" stroke="#eab308" stroke-width="1.5" opacity=".7"/>
              <line x1="20" y1="17" x2="30" y2="16" stroke="#22c55e" stroke-width="1.5" opacity=".7"/>
              <line x1="20" y1="20" x2="30" y2="20" stroke="#3b82f6" stroke-width="1.5" opacity=".7"/>
            </g>
          </svg>
        </div>
      </div>

      <!-- Records -->
      <div class="game-view record-view" id="record-view">
        <div class="records-area">
          <div class="record-card"><h3>üèÜ Ï¢ÖÌï© ÏÑ±Ï†Å</h3><div class="record-grid">
            <div class="record-item"><div class="record-num" id="r-total">0</div><div class="record-label">Ï¥ù Ïã§Ìóò</div></div>
            <div class="record-item"><div class="record-num" id="r-correct">0</div><div class="record-label">ÏÑ±Í≥µ</div></div>
            <div class="record-item"><div class="record-num" id="r-rate">0%</div><div class="record-label">ÏÑ±Í≥µÎ•†</div></div>
          </div></div>
          <div class="record-card"><h3>üß™ ÏÑûÏñ¥Î≥ºÍπå?</h3><div class="record-grid">
            <div class="record-item"><div class="record-num" id="r-mix-disc">0</div><div class="record-label">Î∞úÍ≤¨</div></div>
            <div class="record-item"><div class="record-num" id="r-mix-tried">0</div><div class="record-label">ÏãúÎèÑ</div></div>
            <div class="record-item"><div class="record-num" id="r-mix-score">0</div><div class="record-label">Ï†êÏàò</div></div>
          </div></div>
          <div class="record-card"><h3>‚öñÔ∏è Ï†ÄÏö∏ÎÜÄÏù¥</h3><div class="record-grid">
            <div class="record-item"><div class="record-num" id="r-wt-correct">0</div><div class="record-label">Ï†ïÎãµ</div></div>
            <div class="record-item"><div class="record-num" id="r-wt-streak">0</div><div class="record-label">ÏµúÍ≥† Ïó∞ÏÜç</div></div>
            <div class="record-item"><div class="record-num" id="r-wt-score">0</div><div class="record-label">Ï†êÏàò</div></div>
          </div></div>
          <div class="record-card"><h3>üí° Îπõ ÎÜÄÏù¥ÌÑ∞</h3><div class="record-grid">
            <div class="record-item"><div class="record-num" id="r-lt-mixes">0</div><div class="record-label">ÌòºÌï©</div></div>
            <div class="record-item"><div class="record-num" id="r-lt-score">0</div><div class="record-label">Ï†êÏàò</div></div>
            <div class="record-item"><div class="record-num" id="r-hero-best">0</div><div class="record-label">ÌûàÏñ¥Î°ú ÏµúÍ≥†</div></div>
          </div></div>
        </div>
        <!-- ÎßàÏä§ÏΩîÌä∏ "ÌîåÎùºÏä§ÌÅ¨" record -->
        <div class="mascot-wrap" style="bottom:16px;right:16px">
          <div class="mascot-bubble" id="bubble-rec">Í∏∞Î°ù!</div>
          <svg width="100" height="140" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="flaskBodyR" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#5eead4"/><stop offset="100%" stop-color="#0d9488"/></linearGradient></defs>
            <g><rect x="32" y="118" width="12" height="18" rx="6" fill="#0d9488"><animateTransform attributeName="transform" type="rotate" values="-3,38,130;3,38,130;-3,38,130" dur="1.5s" repeatCount="indefinite"/></rect></g>
            <g><rect x="56" y="118" width="12" height="18" rx="6" fill="#0d9488"><animateTransform attributeName="transform" type="rotate" values="3,62,130;-3,62,130;3,62,130" dur="1.5s" repeatCount="indefinite"/></rect></g>
            <path d="M38,30 L38,55 L22,100 Q18,112 30,115 L70,115 Q82,112 78,100 L62,55 L62,30" fill="url(#flaskBodyR)" stroke="#115e59" stroke-width="2"/>
            <rect x="36" y="18" width="28" height="14" rx="4" fill="#14b8a6" stroke="#115e59" stroke-width="1.5"/>
            <rect x="34" y="16" width="32" height="5" rx="2.5" fill="#0d9488"/>
            <ellipse cx="50" cy="102" rx="22" ry="8" fill="#22c55e" opacity=".5"><animate attributeName="rx" values="22;25;22" dur="2s" repeatCount="indefinite"/></ellipse>
            <circle cx="40" cy="96" r="4" fill="#4ade80" opacity=".5"><animate attributeName="cy" values="96;90;96" dur="1.8s" repeatCount="indefinite"/></circle>
            <circle cx="58" cy="94" r="3" fill="#86efac" opacity=".6"><animate attributeName="cy" values="94;88;94" dur="2.2s" repeatCount="indefinite"/></circle>
            <circle cx="42" cy="42" r="5" fill="#fff"/>
            <circle cx="58" cy="42" r="5" fill="#fff"/>
            <circle cx="42.5" cy="42.5" r="3" fill="#115e59"><animate attributeName="r" values="3;0.4;3" dur="4s" repeatCount="indefinite"/></circle>
            <circle cx="58.5" cy="42.5" r="3" fill="#115e59"><animate attributeName="r" values="3;0.4;3" dur="4s" repeatCount="indefinite"/></circle>
            <ellipse cx="36" cy="50" rx="4" ry="2.5" fill="#f9a8d4" opacity=".3"/>
            <ellipse cx="64" cy="50" rx="4" ry="2.5" fill="#f9a8d4" opacity=".3"/>
            <path id="mascot-rec-mouth" d="M44,54 Q50,62 56,54" fill="none" stroke="#115e59" stroke-width="2" stroke-linecap="round"/>
            <!-- Ïò§Î•∏ÏÜêÏóê Í∏àÌä∏Î°úÌîº -->
            <g transform="translate(72,46)">
              <path d="M4,0 L16,0 L14,14 Q10,20 10,22 L6,14 Z" fill="#fbbf24" stroke="#d97706" stroke-width="1.5"/>
              <rect x="6" y="22" width="8" height="3" rx="1" fill="#f59e0b"/>
              <rect x="4" y="25" width="12" height="4" rx="2" fill="#d97706"/>
              <path d="M4,2 Q-2,6 0,12 Q2,14 6,12" fill="none" stroke="#fbbf24" stroke-width="1.5"/><path d="M16,2 Q22,6 20,12 Q18,14 14,12" fill="none" stroke="#fbbf24" stroke-width="1.5"/>
              <polygon points="10,6 11,9 14,9 11.5,11 12.5,14 10,12 7.5,14 8.5,11 6,9 9,9" fill="#fff" opacity=".5"/>
            </g>
          </svg>
        </div>
      </div>
    </div>

    <div class="right-panel" id="right-panel">
      <button class="action-btn btn-cyan" id="act1" onclick="actionBtn(1)"><span class="icon">üí°</span>ÌûåÌä∏</button>
      <button class="action-btn btn-green" id="act2" onclick="actionBtn(2)"><span class="icon">‚è≠</span>Îã§Ïùå</button>
      <button class="action-btn btn-red" id="act3" onclick="actionBtn(3)"><span class="icon">üîÑ</span>Î¶¨ÏÖã</button>
    </div>
  </div>

  <!-- Hero Game (container ÎÇ¥Î∂Ä) -->
  <div id="hero-game" class="hero-game hidden">
    <div class="hg-header">
      <div class="hg-stat">‚≠ê <span id="hg-score">0</span>Ï†ê</div>
      <div class="hg-stat">Î†àÎ≤® <span id="hg-level">1</span></div>
      <div class="hg-hearts" id="hg-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      <div class="hg-ctrls">
        <button class="hg-ctrl-btn" onclick="hgPause()">‚è∏</button>
        <button class="hg-ctrl-btn" onclick="hgExit()">‚úï</button>
      </div>
    </div>
    <div class="hg-arena" id="hg-arena">
      <div class="hg-ground"></div>
    </div>
    <div id="hg-over" class="hg-overlay hidden">
      <div class="hg-overlay-box">
        <h2>Ïã§Ìóò ÎÅù!</h2>
        <div class="score">‚≠ê <span id="hg-final-score">0</span>Ï†ê</div>
        <div class="msg" id="hg-over-msg">ÏûòÌñàÏñ¥Ïöî!</div>
        <button class="btn-retry" onclick="hgRestart()">üîÑ Îã§ÏãúÌïòÍ∏∞</button>
        <button class="btn-exit" onclick="hgExit()">üè† ÎèåÏïÑÍ∞ÄÍ∏∞</button>
      </div>
    </div>
    <div id="hg-pause" class="hg-overlay hidden">
      <div class="hg-overlay-box">
        <h2>‚è∏ ÏùºÏãúÏ†ïÏßÄ</h2>
        <button class="btn-retry" onclick="hgPause()">‚ñ∂ Í≥ÑÏÜçÌïòÍ∏∞</button>
        <button class="btn-exit" onclick="hgExit()">üè† ÎèåÏïÑÍ∞ÄÍ∏∞</button>
      </div>
    </div>
  </div>
</div>

<!-- Admin Modal -->
<div id="admin-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-head"><h3>‚öô ÏÑ§Ï†ï</h3><button class="modal-close" onclick="hideAdmin()">√ó</button></div>
    <div class="modal-body">
      <div class="modal-section"><h4>üë§ ÌîÑÎ°úÌïÑ</h4><input class="modal-input" id="adm-name" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•" maxlength="10"><button class="modal-btn" onclick="saveProfile()">Ï†ÄÏû•</button></div>
      <div class="modal-section"><h4>üîÑ Ï¥àÍ∏∞Ìôî</h4><button class="modal-btn" style="background:linear-gradient(145deg,#ef4444,#dc2626)" onclick="resetAll()">Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button></div>
    </div>
  </div>
</div>
<!-- Char Modal -->
<div id="char-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-head"><h3>üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù</h3><button class="modal-close" onclick="hideCharModal()">√ó</button></div>
    <div class="modal-body"><div class="char-grid" id="char-grid"></div></div>
  </div>
</div>
<!-- Dex Modal -->
<div id="dex-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-head"><h3>üìñ Ïã§Ìóò ÎèÑÍ∞ê</h3><button class="modal-close" onclick="hideDex()">√ó</button></div>
    <div class="modal-body"><div class="dex-grid" id="dex-grid"></div></div>
  </div>
</div>

<script>
// ===== Global =====
let currentTab = 'mix';
let soundEnabled = true;
const LS = localStorage;

// Profile
let profile = {
  name: LS.getItem('sciName') || 'Í≥ºÌïôÏûê',
  char: LS.getItem('sciChar') || 'üßí',
  totalCorrect: parseInt(LS.getItem('sciCorrect')) || 0,
  totalPlayed: parseInt(LS.getItem('sciPlayed')) || 0
};

// ===== TTS =====
let audioQueue = [];
let isSpeaking = false;
function speak(text) {
  if (!soundEnabled) return;
  speechSynthesis.cancel();
  audioQueue = [];
  isSpeaking = false;
  audioQueue.push(text);
  processQueue();
}
function processQueue() {
  if (isSpeaking || !audioQueue.length) return;
  isSpeaking = true;
  const u = new SpeechSynthesisUtterance(audioQueue.shift());
  u.lang = 'ko-KR'; u.rate = 1.0; u.pitch = 1.1;
  u.onend = () => { isSpeaking = false; processQueue(); };
  u.onerror = () => { isSpeaking = false; processQueue(); };
  speechSynthesis.speak(u);
}
function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('sb-sound').textContent = soundEnabled ? 'üîä' : 'üîá';
  if (!soundEnabled) speechSynthesis.cancel();
}

// ===== SFX ÏãúÏä§ÌÖú =====
const SFX = {
  _ctx: null,
  _getCtx() { if (!this._ctx) this._ctx = new (window.AudioContext || window.webkitAudioContext)(); return this._ctx; },
  _play(fn) { try { if (!soundEnabled) return; fn(this._getCtx()); } catch(e) {} },
  bubble() { this._play(ctx => { for(let i=0;i<4;i++){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=600+Math.random()*400;g.gain.setValueAtTime(.04,ctx.currentTime+i*.05);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.05+.08);o.start(ctx.currentTime+i*.05);o.stop(ctx.currentTime+i*.05+.08);} }); },
  mix() { this._play(ctx => { [400,600,900,1200].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.05,ctx.currentTime+i*.08);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.08+.15);o.start(ctx.currentTime+i*.08);o.stop(ctx.currentTime+i*.08+.15); }); }); },
  correct() { this._play(ctx => { [659,784,988].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.06);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.06+.12);o.start(ctx.currentTime+i*.06);o.stop(ctx.currentTime+i*.06+.12); }); }); },
  wrong() { this._play(ctx => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sawtooth';o.frequency.setValueAtTime(250,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(120,ctx.currentTime+.18);g.gain.setValueAtTime(.04,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.18);o.start();o.stop(ctx.currentTime+.18); }); },
  prism() { this._play(ctx => { [523,659,784,988,1175].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.04,ctx.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.1+.2);o.start(ctx.currentTime+i*.1);o.stop(ctx.currentTime+i*.1+.2); }); }); },
  fanfare() { this._play(ctx => { [523,659,784,1047].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='square';o.frequency.value=f;g.gain.setValueAtTime(.04,ctx.currentTime+i*.12);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.12+.25);o.start(ctx.currentTime+i*.12);o.stop(ctx.currentTime+i*.12+.25); }); }); },
  levelup() { this._play(ctx => { for(let i=0;i<8;i++){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=523*(1+i*.15);g.gain.setValueAtTime(.05,ctx.currentTime+i*.06);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.06+.15);o.start(ctx.currentTime+i*.06);o.stop(ctx.currentTime+i*.06+.15);} }); },
  combo(n) { this._play(ctx => { const f=800+Math.min(n,10)*60;const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.setValueAtTime(f,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(f*1.3,ctx.currentTime+.1);g.gain.setValueAtTime(.06,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.12);o.start();o.stop(ctx.currentTime+.12); }); },
  gameStart() { this._play(ctx => { [392,523,659,784].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.1+.2);o.start(ctx.currentTime+i*.1);o.stop(ctx.currentTime+i*.1+.2); }); }); },
  gameOver() { this._play(ctx => { [523,440,349,262].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.15);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.15+.3);o.start(ctx.currentTime+i*.15);o.stop(ctx.currentTime+i*.15+.3); }); }); }
};

// ===== SVG ÎîïÏÖîÎÑàÎ¶¨ =====
const INGREDIENT_SVG = {
  'ÏãùÏ¥à': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><rect x="25" y="30" width="30" height="40" rx="4" fill="#8B4513"/><rect x="25" y="30" width="30" height="40" rx="4" fill="none" stroke="#5C2D06" stroke-width="2"/><rect x="33" y="10" width="14" height="22" rx="3" fill="#8B4513"/><rect x="33" y="10" width="14" height="22" rx="3" fill="none" stroke="#5C2D06" stroke-width="1.5"/><rect x="30" y="8" width="20" height="5" rx="2" fill="#A0522D"/><rect x="29" y="40" width="22" height="16" rx="3" fill="#fff"/><text x="40" y="52" text-anchor="middle" font-size="9" font-weight="800" fill="#5C2D06" font-family="sans-serif">ÏãùÏ¥à</text><ellipse cx="40" cy="33" rx="10" ry="2" fill="rgba(255,255,255,.2)"/></svg>',
  'Î≤†Ïù¥ÌÇπÏÜåÎã§': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><path d="M18,28 L28,12 L52,12 L62,28 L62,68 Q62,72 58,72 L22,72 Q18,72 18,68 Z" fill="#FFD700"/><path d="M18,28 L28,12 L52,12 L62,28 L62,68 Q62,72 58,72 L22,72 Q18,72 18,68 Z" fill="none" stroke="#DAA520" stroke-width="2"/><rect x="24" y="35" width="32" height="18" rx="3" fill="#fff"/><text x="40" y="47" text-anchor="middle" font-size="7" font-weight="800" fill="#DAA520" font-family="sans-serif">BAKING</text><text x="40" y="51" text-anchor="middle" font-size="5" fill="#DAA520" font-family="sans-serif">SODA</text><circle cx="30" cy="18" r="3" fill="#fff" opacity=".6"/><circle cx="40" cy="15" r="4" fill="#fff" opacity=".5"/><circle cx="50" cy="18" r="3" fill="#fff" opacity=".6"/><circle cx="35" cy="10" r="2" fill="#fff" opacity=".4"/><circle cx="45" cy="9" r="2.5" fill="#fff" opacity=".4"/></svg>',
  'Î¨º': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="waterG" cx=".4" cy=".3"><stop offset="0%" stop-color="#93C5FD"/><stop offset="100%" stop-color="#2563EB"/></radialGradient></defs><path d="M40,8 Q55,35 58,50 A20,20 0 1,1 22,50 Q25,35 40,8 Z" fill="url(#waterG)"/><path d="M40,8 Q55,35 58,50 A20,20 0 1,1 22,50 Q25,35 40,8 Z" fill="none" stroke="#1D4ED8" stroke-width="2"/><ellipse cx="34" cy="40" rx="6" ry="10" fill="rgba(255,255,255,.3)" transform="rotate(-15,34,40)"/><circle cx="30" cy="35" r="2" fill="rgba(255,255,255,.4)"/></svg>',
  'Í∏∞Î¶Ñ': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><rect x="24" y="25" width="32" height="45" rx="5" fill="#FCD34D"/><rect x="24" y="25" width="32" height="45" rx="5" fill="none" stroke="#D97706" stroke-width="2"/><rect x="34" y="12" width="12" height="16" rx="3" fill="#FCD34D"/><rect x="34" y="12" width="12" height="16" rx="3" fill="none" stroke="#D97706" stroke-width="1.5"/><rect x="32" y="10" width="16" height="5" rx="2" fill="#F59E0B"/><ellipse cx="40" cy="29" rx="10" ry="2" fill="rgba(255,255,255,.3)"/><path d="M44,40 Q46,46 44,52" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="2"/><rect x="28" y="48" width="24" height="12" rx="2" fill="#fff" opacity=".8"/><text x="40" y="57" text-anchor="middle" font-size="8" font-weight="700" fill="#D97706" font-family="sans-serif">OIL</text></svg>',
  'Ïö∞Ïú†': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><rect x="22" y="18" width="36" height="52" rx="4" fill="#fff"/><rect x="22" y="18" width="36" height="52" rx="4" fill="none" stroke="#93C5FD" stroke-width="2"/><rect x="22" y="18" width="36" height="14" rx="4" fill="#3B82F6"/><path d="M22,32 L58,32" stroke="#3B82F6" stroke-width="2"/><polygon points="34,10 40,4 46,10" fill="#e2e8f0" stroke="#93C5FD" stroke-width="1.5"/><text x="40" y="28" text-anchor="middle" font-size="10" font-weight="800" fill="#fff" font-family="sans-serif">MILK</text><text x="40" y="52" text-anchor="middle" font-size="8" font-weight="700" fill="#3B82F6" font-family="sans-serif">Ïö∞Ïú†</text><circle cx="32" cy="44" r="4" fill="#DBEAFE"/><circle cx="48" cy="42" r="3" fill="#DBEAFE"/></svg>',
  'ÏãùÏö©ÏÉâÏÜå': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><rect x="8" y="28" width="16" height="40" rx="4" fill="#EF4444"/><rect x="8" y="28" width="16" height="40" rx="4" fill="none" stroke="#B91C1C" stroke-width="1.5"/><path d="M16,28 L16,20 L14,16 L18,16 L16,20" fill="#B91C1C"/><circle cx="16" cy="14" r="3" fill="#FCA5A5"/><rect x="32" y="28" width="16" height="40" rx="4" fill="#3B82F6"/><rect x="32" y="28" width="16" height="40" rx="4" fill="none" stroke="#1D4ED8" stroke-width="1.5"/><path d="M40,28 L40,20 L38,16 L42,16 L40,20" fill="#1D4ED8"/><circle cx="40" cy="14" r="3" fill="#93C5FD"/><rect x="56" y="28" width="16" height="40" rx="4" fill="#EAB308"/><rect x="56" y="28" width="16" height="40" rx="4" fill="none" stroke="#A16207" stroke-width="1.5"/><path d="M64,28 L64,20 L62,16 L66,16 L64,20" fill="#A16207"/><circle cx="64" cy="14" r="3" fill="#FDE68A"/></svg>',
  'Î†àÎ™¨Ï¶ô': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="40" cy="42" rx="22" ry="20" fill="#FDE68A"/><ellipse cx="40" cy="42" rx="22" ry="20" fill="none" stroke="#CA8A04" stroke-width="2"/><path d="M40,22 L40,42" stroke="#fff" stroke-width="2" opacity=".4"/><ellipse cx="40" cy="42" rx="15" ry="13" fill="#FEF3C7" opacity=".5"/><path d="M30,42 Q33,36 36,42 Q38,36 40,42 Q42,36 44,42 Q46,36 50,42" fill="none" stroke="#EAB308" stroke-width="1.5" opacity=".5"/><ellipse cx="40" cy="42" rx="22" ry="2" fill="rgba(202,138,4,.15)"/><circle cx="40" cy="64" r="3" fill="#FCD34D" opacity=".8"><animate attributeName="cy" values="64;68;64" dur="1.5s" repeatCount="indefinite"/></circle><circle cx="36" cy="68" r="2" fill="#FCD34D" opacity=".5"><animate attributeName="cy" values="68;72;68" dur="2s" repeatCount="indefinite"/></circle></svg>',
  'ÏÜåÍ∏à': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><rect x="22" y="22" width="36" height="48" rx="6" fill="#F8FAFC"/><rect x="22" y="22" width="36" height="48" rx="6" fill="none" stroke="#CBD5E1" stroke-width="2"/><rect x="22" y="22" width="36" height="14" rx="6" fill="#94A3B8"/><circle cx="32" cy="16" r="2" fill="#CBD5E1"/><circle cx="40" cy="16" r="2" fill="#CBD5E1"/><circle cx="48" cy="16" r="2" fill="#CBD5E1"/><text x="40" y="50" text-anchor="middle" font-size="9" font-weight="800" fill="#64748B" font-family="sans-serif">SALT</text><circle cx="34" cy="10" r="1.5" fill="#E2E8F0"><animate attributeName="cy" values="10;14" dur=".8s" repeatCount="indefinite"/></circle><circle cx="40" cy="8" r="1" fill="#E2E8F0"><animate attributeName="cy" values="8;13" dur="1s" repeatCount="indefinite"/></circle><circle cx="46" cy="10" r="1.5" fill="#E2E8F0"><animate attributeName="cy" values="10;15" dur=".9s" repeatCount="indefinite"/></circle></svg>',
  'ÏñºÏùå': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="iceG" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#BFDBFE"/><stop offset="50%" stop-color="#93C5FD"/><stop offset="100%" stop-color="#60A5FA"/></linearGradient></defs><rect x="18" y="22" width="44" height="40" rx="6" fill="url(#iceG)" opacity=".8"/><rect x="18" y="22" width="44" height="40" rx="6" fill="none" stroke="#3B82F6" stroke-width="2" opacity=".6"/><line x1="36" y1="22" x2="36" y2="62" stroke="#DBEAFE" stroke-width="1.5" opacity=".5"/><line x1="18" y1="42" x2="62" y2="42" stroke="#DBEAFE" stroke-width="1.5" opacity=".5"/><polygon points="24,28 30,24 32,30 26,32" fill="rgba(255,255,255,.5)"/><polygon points="44,26 52,24 54,30 46,32" fill="rgba(255,255,255,.4)"/><polygon points="22,48 28,46 30,52 24,54" fill="rgba(255,255,255,.3)"/></svg>',
  'Îã¨Í±Ä': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="eggG" cx=".4" cy=".35"><stop offset="0%" stop-color="#FEF3C7"/><stop offset="100%" stop-color="#DEB887"/></radialGradient></defs><ellipse cx="40" cy="44" rx="20" ry="26" fill="url(#eggG)"/><ellipse cx="40" cy="44" rx="20" ry="26" fill="none" stroke="#C4A47C" stroke-width="2"/><ellipse cx="34" cy="36" rx="6" ry="8" fill="rgba(255,255,255,.3)" transform="rotate(-10,34,36)"/><circle cx="32" cy="32" r="2" fill="rgba(255,255,255,.3)"/></svg>'
};
/* ÌûàÏñ¥Î°úÏö© Î≥ÑÏπ≠ (HERO_INGREDIENTS Ïù¥Î¶Ñ ‚Üí INGREDIENT_SVG Îß§Ìïë) */
INGREDIENT_SVG['ÏÜåÎã§'] = INGREDIENT_SVG['Î≤†Ïù¥ÌÇπÏÜåÎã§'];
INGREDIENT_SVG['ÏÉâÏÜå'] = INGREDIENT_SVG['ÏãùÏö©ÏÉâÏÜå'];
INGREDIENT_SVG['Î†àÎ™¨'] = INGREDIENT_SVG['Î†àÎ™¨Ï¶ô'];

const OBJECT_SVG = {
  'ÏΩîÎÅºÎ¶¨': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="40" cy="42" rx="22" ry="18" fill="#9CA3AF"/><circle cx="40" cy="28" r="14" fill="#9CA3AF"/><circle cx="34" cy="24" r="2.5" fill="#fff"/><circle cx="34" cy="24" r="1.5" fill="#1F2937"/><circle cx="46" cy="24" r="2.5" fill="#fff"/><circle cx="46" cy="24" r="1.5" fill="#1F2937"/><path d="M28,28 Q22,30 20,42 Q18,50 22,52" fill="none" stroke="#9CA3AF" stroke-width="5" stroke-linecap="round"/><path d="M28,28 Q22,30 20,42 Q18,50 22,52" fill="none" stroke="#6B7280" stroke-width="2" stroke-linecap="round"/><ellipse cx="26" cy="24" rx="8" ry="10" fill="#9CA3AF" stroke="#6B7280" stroke-width="1.5"/><ellipse cx="54" cy="24" rx="8" ry="10" fill="#9CA3AF" stroke="#6B7280" stroke-width="1.5"/><ellipse cx="26" cy="24" rx="5" ry="7" fill="#D1D5DB"/><ellipse cx="54" cy="24" rx="5" ry="7" fill="#D1D5DB"/><rect x="28" y="56" width="6" height="14" rx="3" fill="#9CA3AF" stroke="#6B7280" stroke-width="1"/><rect x="36" y="56" width="6" height="14" rx="3" fill="#9CA3AF" stroke="#6B7280" stroke-width="1"/><rect x="46" y="56" width="6" height="14" rx="3" fill="#9CA3AF" stroke="#6B7280" stroke-width="1"/><rect x="38" y="56" width="6" height="14" rx="3" fill="#9CA3AF" stroke="#6B7280" stroke-width="1"/></svg>',
  'Í≥†ÏñëÏù¥': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="40" cy="48" rx="16" ry="14" fill="#F97316"/><circle cx="40" cy="30" r="14" fill="#F97316"/><polygon points="28,22 24,6 34,16" fill="#F97316" stroke="#EA580C" stroke-width="1.5"/><polygon points="52,22 56,6 46,16" fill="#F97316" stroke="#EA580C" stroke-width="1.5"/><polygon points="28,22 25,8 33,17" fill="#FED7AA"/><polygon points="52,22 55,8 47,17" fill="#FED7AA"/><circle cx="34" cy="28" r="3" fill="#fff"/><circle cx="34" cy="28" r="2" fill="#1F2937"/><circle cx="46" cy="28" r="3" fill="#fff"/><circle cx="46" cy="28" r="2" fill="#1F2937"/><ellipse cx="40" cy="34" rx="2" ry="1.5" fill="#F9A8D4"/><line x1="22" y1="30" x2="30" y2="32" stroke="#EA580C" stroke-width="1"/><line x1="22" y1="34" x2="30" y2="34" stroke="#EA580C" stroke-width="1"/><line x1="50" y1="32" x2="58" y2="30" stroke="#EA580C" stroke-width="1"/><line x1="50" y1="34" x2="58" y2="34" stroke="#EA580C" stroke-width="1"/><path d="M55,52 Q65,44 68,56" fill="none" stroke="#F97316" stroke-width="4" stroke-linecap="round"/><rect x="32" y="60" width="5" height="10" rx="2.5" fill="#F97316"/><rect x="43" y="60" width="5" height="10" rx="2.5" fill="#F97316"/></svg>',
  'ÏûêÎèôÏ∞®': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="36" width="60" height="22" rx="6" fill="#EF4444"/><path d="M22,36 L28,20 L52,20 L58,36" fill="#EF4444" stroke="#DC2626" stroke-width="1.5"/><rect x="30" y="22" width="20" height="12" rx="2" fill="#BFDBFE" stroke="#93C5FD" stroke-width="1"/><line x1="40" y1="22" x2="40" y2="34" stroke="#93C5FD" stroke-width="1"/><circle cx="24" cy="58" r="8" fill="#374151"/><circle cx="24" cy="58" r="4" fill="#6B7280"/><circle cx="56" cy="58" r="8" fill="#374151"/><circle cx="56" cy="58" r="4" fill="#6B7280"/><rect x="12" y="40" width="8" height="4" rx="2" fill="#FCD34D"/><rect x="60" y="40" width="8" height="4" rx="2" fill="#FCA5A5"/></svg>',
  'ÏûêÏ†ÑÍ±∞': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="22" cy="52" r="14" fill="none" stroke="#374151" stroke-width="3"/><circle cx="58" cy="52" r="14" fill="none" stroke="#374151" stroke-width="3"/><circle cx="22" cy="52" r="2" fill="#6B7280"/><circle cx="58" cy="52" r="2" fill="#6B7280"/><line x1="22" y1="52" x2="40" y2="42" stroke="#6B7280" stroke-width="2.5"/><line x1="40" y1="42" x2="58" y2="52" stroke="#6B7280" stroke-width="2.5"/><line x1="40" y1="42" x2="40" y2="28" stroke="#6B7280" stroke-width="2.5"/><line x1="34" y1="26" x2="46" y2="26" stroke="#374151" stroke-width="3" stroke-linecap="round"/><line x1="40" y1="42" x2="48" y2="52" stroke="#6B7280" stroke-width="2"/><rect x="36" y="36" width="8" height="3" rx="1" fill="#EF4444"/></svg>',
  'ÏàòÎ∞ï': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="42" r="24" fill="#22C55E"/><path d="M18,32 Q24,28 30,32 Q36,28 42,32 Q48,28 54,32 Q60,28 62,32" fill="none" stroke="#166534" stroke-width="2.5"/><path d="M20,46 Q26,42 32,46 Q38,42 44,46 Q50,42 56,46 Q62,42 62,46" fill="none" stroke="#166534" stroke-width="2"/><circle cx="40" cy="42" r="16" fill="#EF4444"/><circle cx="34" cy="38" r="1.5" fill="#1F2937"/><circle cx="42" cy="36" r="1.5" fill="#1F2937"/><circle cx="38" cy="46" r="1.5" fill="#1F2937"/><circle cx="46" cy="42" r="1.5" fill="#1F2937"/><circle cx="35" cy="48" r="1" fill="#1F2937"/></svg>',
  'Îî∏Í∏∞': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><path d="M40,18 Q56,30 56,50 Q56,66 40,68 Q24,66 24,50 Q24,30 40,18Z" fill="#EF4444"/><path d="M40,18 Q56,30 56,50 Q56,66 40,68 Q24,66 24,50 Q24,30 40,18Z" fill="none" stroke="#DC2626" stroke-width="2"/><path d="M30,14 Q34,10 38,14" fill="#22C55E"/><path d="M36,12 Q40,8 44,12" fill="#22C55E"/><path d="M42,14 Q46,10 50,14" fill="#22C55E"/><circle cx="34" cy="34" r="1.5" fill="#FCD34D"/><circle cx="44" cy="32" r="1.5" fill="#FCD34D"/><circle cx="32" cy="44" r="1.5" fill="#FCD34D"/><circle cx="40" cy="42" r="1.5" fill="#FCD34D"/><circle cx="48" cy="44" r="1.5" fill="#FCD34D"/><circle cx="36" cy="54" r="1.5" fill="#FCD34D"/><circle cx="44" cy="56" r="1.5" fill="#FCD34D"/></svg>',
  'Î≥ºÎßÅÍ≥µ': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="bowlG" cx=".35" cy=".35"><stop offset="0%" stop-color="#4B5563"/><stop offset="100%" stop-color="#111827"/></radialGradient></defs><circle cx="40" cy="42" r="24" fill="url(#bowlG)"/><circle cx="40" cy="42" r="24" fill="none" stroke="#374151" stroke-width="2"/><circle cx="34" cy="32" r="4" fill="#1F2937" stroke="#374151" stroke-width="1"/><circle cx="44" cy="30" r="4" fill="#1F2937" stroke="#374151" stroke-width="1"/><circle cx="42" cy="40" r="4" fill="#1F2937" stroke="#374151" stroke-width="1"/><ellipse cx="32" cy="36" rx="4" ry="6" fill="rgba(255,255,255,.1)" transform="rotate(-20,32,36)"/></svg>',
  'ÌíçÏÑ†': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="ballG" cx=".35" cy=".3"><stop offset="0%" stop-color="#FCA5A5"/><stop offset="100%" stop-color="#EF4444"/></radialGradient></defs><ellipse cx="40" cy="34" rx="18" ry="22" fill="url(#ballG)"/><ellipse cx="40" cy="34" rx="18" ry="22" fill="none" stroke="#DC2626" stroke-width="1.5"/><polygon points="37,56 40,60 43,56" fill="#DC2626"/><path d="M40,60 Q42,66 38,72 Q42,68 40,76" fill="none" stroke="#9CA3AF" stroke-width="1.5"/><ellipse cx="34" cy="28" rx="4" ry="6" fill="rgba(255,255,255,.3)" transform="rotate(-15,34,28)"/></svg>',
  'Ï±Ö': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><rect x="16" y="16" width="48" height="52" rx="3" fill="#3B82F6"/><rect x="16" y="16" width="48" height="52" rx="3" fill="none" stroke="#1D4ED8" stroke-width="2"/><rect x="20" y="16" width="4" height="52" fill="#2563EB"/><rect x="26" y="24" width="32" height="4" rx="1" fill="rgba(255,255,255,.6)"/><rect x="26" y="32" width="24" height="3" rx="1" fill="rgba(255,255,255,.4)"/><rect x="26" y="38" width="28" height="3" rx="1" fill="rgba(255,255,255,.3)"/><rect x="26" y="50" width="20" height="8" rx="2" fill="rgba(255,255,255,.2)"/></svg>',
  'ÍπÉÌÑ∏': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><path d="M40,8 Q50,20 52,40 Q50,60 40,74" fill="none" stroke="#94A3B8" stroke-width="1.5"/><path d="M40,8 Q30,20 28,40 Q30,50 40,58" fill="#E2E8F0" opacity=".6"/><path d="M40,8 Q50,20 52,40 Q50,50 40,58" fill="#F1F5F9" opacity=".6"/><path d="M34,20 Q38,22 40,18" fill="none" stroke="#CBD5E1" stroke-width="1"/><path d="M32,30 Q36,32 40,28" fill="none" stroke="#CBD5E1" stroke-width="1"/><path d="M30,40 Q36,42 40,38" fill="none" stroke="#CBD5E1" stroke-width="1"/><path d="M46,20 Q42,22 40,18" fill="none" stroke="#CBD5E1" stroke-width="1"/><path d="M48,30 Q44,32 40,28" fill="none" stroke="#CBD5E1" stroke-width="1"/><path d="M48,40 Q44,42 40,38" fill="none" stroke="#CBD5E1" stroke-width="1"/></svg>',
  'Í∏àÌôî': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="coinG" cx=".4" cy=".35"><stop offset="0%" stop-color="#FDE68A"/><stop offset="100%" stop-color="#D97706"/></radialGradient></defs><circle cx="40" cy="42" r="22" fill="url(#coinG)"/><circle cx="40" cy="42" r="22" fill="none" stroke="#B45309" stroke-width="2.5"/><circle cx="40" cy="42" r="17" fill="none" stroke="#B45309" stroke-width="1.5" opacity=".4"/><text x="40" y="49" text-anchor="middle" font-size="22" font-weight="900" fill="#92400E" font-family="serif">$</text><ellipse cx="34" cy="34" rx="4" ry="8" fill="rgba(255,255,255,.2)" transform="rotate(-20,34,34)"/></svg>',
  'ÎÉâÏû•Í≥†': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><rect x="18" y="8" width="44" height="64" rx="4" fill="#F8FAFC"/><rect x="18" y="8" width="44" height="64" rx="4" fill="none" stroke="#94A3B8" stroke-width="2"/><line x1="18" y1="36" x2="62" y2="36" stroke="#94A3B8" stroke-width="2"/><rect x="52" y="18" width="4" height="12" rx="2" fill="#94A3B8"/><rect x="52" y="42" width="4" height="12" rx="2" fill="#94A3B8"/><rect x="22" y="12" width="36" height="20" rx="2" fill="#DBEAFE" opacity=".3"/><rect x="22" y="40" width="36" height="28" rx="2" fill="#DBEAFE" opacity=".2"/></svg>',
  'Í∞ïÏïÑÏßÄ': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="40" cy="48" rx="18" ry="14" fill="#D2691E"/><circle cx="40" cy="30" r="14" fill="#D2691E"/><ellipse cx="26" cy="24" rx="7" ry="10" fill="#A0522D" transform="rotate(-15,26,24)"/><ellipse cx="54" cy="24" rx="7" ry="10" fill="#A0522D" transform="rotate(15,54,24)"/><circle cx="34" cy="28" r="3" fill="#fff"/><circle cx="34" cy="28" r="2" fill="#1F2937"/><circle cx="46" cy="28" r="3" fill="#fff"/><circle cx="46" cy="28" r="2" fill="#1F2937"/><ellipse cx="40" cy="34" rx="4" ry="3" fill="#1F2937"/><ellipse cx="40" cy="34" rx="2.5" ry="1.5" fill="#374151"/><path d="M36,38 Q40,42 44,38" fill="none" stroke="#A0522D" stroke-width="1.5"/><rect x="30" y="58" width="6" height="12" rx="3" fill="#D2691E"/><rect x="44" y="58" width="6" height="12" rx="3" fill="#D2691E"/><path d="M56,48 Q64,44 66,50 Q68,56 60,54" fill="#D2691E" stroke="#A0522D" stroke-width="1"/></svg>',
  'Í∞úÎØ∏': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="40" cy="46" rx="10" ry="8" fill="#1F2937"/><ellipse cx="28" cy="44" rx="7" ry="6" fill="#1F2937"/><circle cx="52" cy="40" r="8" fill="#1F2937"/><circle cx="50" cy="36" r="2" fill="#fff"/><circle cx="54" cy="36" r="2" fill="#fff"/><circle cx="50" cy="36" r="1" fill="#111"/><circle cx="54" cy="36" r="1" fill="#111"/><line x1="56" y1="32" x2="62" y2="24" stroke="#374151" stroke-width="1.5"/><circle cx="62" cy="23" r="2" fill="#374151"/><line x1="52" y1="34" x2="56" y2="24" stroke="#374151" stroke-width="1.5"/><circle cx="56" cy="23" r="2" fill="#374151"/><line x1="24" y1="50" x2="16" y2="58" stroke="#374151" stroke-width="1.5"/><line x1="28" y1="50" x2="22" y2="60" stroke="#374151" stroke-width="1.5"/><line x1="36" y1="52" x2="32" y2="62" stroke="#374151" stroke-width="1.5"/><line x1="44" y1="52" x2="40" y2="62" stroke="#374151" stroke-width="1.5"/><line x1="48" y1="48" x2="54" y2="58" stroke="#374151" stroke-width="1.5"/><line x1="40" y1="50" x2="46" y2="60" stroke="#374151" stroke-width="1.5"/></svg>',
  'ÎπÑÌñâÍ∏∞': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="40" cy="40" rx="8" ry="28" fill="#E2E8F0" transform="rotate(0,40,40)"/><path d="M40,12 L42,18 L38,18 Z" fill="#94A3B8"/><path d="M18,38 L40,32 L40,48 Z" fill="#3B82F6"/><path d="M62,38 L40,32 L40,48 Z" fill="#3B82F6"/><path d="M30,56 L40,50 L50,56 Z" fill="#60A5FA"/><rect x="36" y="22" width="8" height="10" rx="2" fill="#BFDBFE"/><circle cx="40" cy="26" r="3" fill="#93C5FD"/><rect x="38" y="62" width="4" height="6" rx="1" fill="#94A3B8"/></svg>',
  'Î∞∞': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><path d="M10,52 Q14,36 40,34 Q66,36 70,52 L65,56 L15,56 Z" fill="#6B7280"/><path d="M10,52 Q14,36 40,34 Q66,36 70,52 L65,56 L15,56 Z" fill="none" stroke="#4B5563" stroke-width="2"/><rect x="12" y="56" width="56" height="8" rx="3" fill="#4B5563"/><line x1="40" y1="10" x2="40" y2="34" stroke="#78350F" stroke-width="3"/><rect x="42" y="14" width="20" height="14" rx="2" fill="#EF4444"/><path d="M42,14 L62,14 L62,28 L42,28" fill="none" stroke="#DC2626" stroke-width="1.5"/><rect x="18" y="40" width="6" height="6" rx="1" fill="#BFDBFE"/><rect x="28" y="40" width="6" height="6" rx="1" fill="#BFDBFE"/><rect x="46" y="40" width="6" height="6" rx="1" fill="#BFDBFE"/><rect x="56" y="40" width="6" height="6" rx="1" fill="#BFDBFE"/></svg>',
  'ÏÇ¨Í≥º': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="appleG" cx=".4" cy=".35"><stop offset="0%" stop-color="#FCA5A5"/><stop offset="100%" stop-color="#DC2626"/></radialGradient></defs><circle cx="40" cy="46" r="22" fill="url(#appleG)"/><circle cx="40" cy="46" r="22" fill="none" stroke="#B91C1C" stroke-width="2"/><path d="M40,24 Q42,16 48,14" fill="none" stroke="#78350F" stroke-width="2.5" stroke-linecap="round"/><ellipse cx="48" cy="16" rx="6" ry="4" fill="#22C55E" transform="rotate(-20,48,16)"/><ellipse cx="34" cy="38" rx="4" ry="6" fill="rgba(255,255,255,.25)" transform="rotate(-15,34,38)"/></svg>',
  'Î∞îÎÇòÎÇò': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><path d="M24,60 Q16,46 20,30 Q26,14 42,10 Q50,10 52,16 Q48,14 42,16 Q30,22 26,38 Q22,52 32,62 Z" fill="#FCD34D"/><path d="M24,60 Q16,46 20,30 Q26,14 42,10 Q50,10 52,16 Q48,14 42,16 Q30,22 26,38 Q22,52 32,62 Z" fill="none" stroke="#CA8A04" stroke-width="2"/><path d="M30,50 Q24,42 26,32 Q30,20 40,14" fill="none" stroke="#EAB308" stroke-width="1.5" opacity=".4"/></svg>',
  'ÌîºÏïÑÎÖ∏': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="16" width="60" height="48" rx="4" fill="#1F2937"/><rect x="10" y="16" width="60" height="48" rx="4" fill="none" stroke="#111827" stroke-width="2"/><rect x="14" y="22" width="6" height="36" rx="1" fill="#F8FAFC"/><rect x="22" y="22" width="6" height="36" rx="1" fill="#F8FAFC"/><rect x="30" y="22" width="6" height="36" rx="1" fill="#F8FAFC"/><rect x="38" y="22" width="6" height="36" rx="1" fill="#F8FAFC"/><rect x="46" y="22" width="6" height="36" rx="1" fill="#F8FAFC"/><rect x="54" y="22" width="6" height="36" rx="1" fill="#F8FAFC"/><rect x="62" y="22" width="6" height="36" rx="1" fill="#F8FAFC"/><rect x="19" y="22" width="4" height="22" rx="1" fill="#1F2937"/><rect x="27" y="22" width="4" height="22" rx="1" fill="#1F2937"/><rect x="43" y="22" width="4" height="22" rx="1" fill="#1F2937"/><rect x="51" y="22" width="4" height="22" rx="1" fill="#1F2937"/><rect x="59" y="22" width="4" height="22" rx="1" fill="#1F2937"/><rect x="14" y="62" width="52" height="4" rx="2" fill="#374151"/></svg>',
  'Í∏∞ÌÉÄ': '<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="36" cy="54" rx="16" ry="14" fill="#A0522D"/><ellipse cx="36" cy="54" rx="16" ry="14" fill="none" stroke="#6B3410" stroke-width="2"/><circle cx="36" cy="54" r="5" fill="#1F2937"/><line x1="44" y1="42" x2="62" y2="12" stroke="#A0522D" stroke-width="5"/><line x1="44" y1="42" x2="62" y2="12" stroke="#6B3410" stroke-width="2"/><rect x="56" y="8" width="12" height="8" rx="2" fill="#D2691E"/><line x1="32" y1="40" x2="32" y2="68" stroke="#CBD5E1" stroke-width="1"/><line x1="36" y1="40" x2="36" y2="68" stroke="#CBD5E1" stroke-width="1"/><line x1="40" y1="40" x2="40" y2="68" stroke="#CBD5E1" stroke-width="1"/><circle cx="58" cy="10" r="1.5" fill="#FCD34D"/><circle cx="62" cy="10" r="1.5" fill="#FCD34D"/><circle cx="66" cy="10" r="1.5" fill="#FCD34D"/></svg>'
};

const POWERUP_SVG = {
  'shield': '<svg viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="20" width="40" height="18" rx="8" fill="rgba(147,197,253,.3)" stroke="#93C5FD" stroke-width="2"/><rect x="10" y="20" width="40" height="18" rx="8" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="1" transform="translate(0,-1)"/><line x1="8" y1="29" x2="14" y2="29" stroke="#93C5FD" stroke-width="2.5" stroke-linecap="round"/><line x1="46" y1="29" x2="52" y2="29" stroke="#93C5FD" stroke-width="2.5" stroke-linecap="round"/><circle cx="30" cy="29" r="3" fill="#BFDBFE"/><ellipse cx="25" cy="27" rx="5" ry="3" fill="rgba(255,255,255,.2)"/></svg>',
  'slow': '<svg viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><ellipse cx="32" cy="38" rx="16" ry="12" fill="#A0522D"/><ellipse cx="32" cy="38" rx="16" ry="12" fill="none" stroke="#6B3410" stroke-width="2"/><path d="M26,26 Q22,16 28,12 Q30,10 32,12 Q38,16 34,26" fill="#A0522D" stroke="#6B3410" stroke-width="1.5"/><circle cx="28" cy="34" r="2" fill="#fff"/><circle cx="28" cy="34" r="1.2" fill="#1F2937"/><circle cx="36" cy="34" r="2" fill="#fff"/><circle cx="36" cy="34" r="1.2" fill="#1F2937"/><ellipse cx="32" cy="26" rx="5" ry="3" fill="#A0522D"/><path d="M28,40 Q32,43 36,40" fill="none" stroke="#6B3410" stroke-width="1.5" stroke-linecap="round"/><ellipse cx="38" cy="38" rx="3" ry="6" fill="rgba(255,255,255,.15)"/></svg>',
  'double': '<svg viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="starPuG" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#FDE68A"/><stop offset="100%" stop-color="#F59E0B"/></linearGradient></defs><polygon points="30,6 36,22 54,22 40,33 45,50 30,40 15,50 20,33 6,22 24,22" fill="url(#starPuG)" stroke="#D97706" stroke-width="2"/><polygon points="30,14 34,24 44,24 36,30 38,40 30,34 22,40 24,30 16,24 26,24" fill="rgba(255,255,255,.25)"/></svg>'
};

function showScorePopup(container, points, x, y) {
  const el = document.createElement('div');
  el.className = 'score-popup';
  el.textContent = (typeof points === 'number' && points > 0 ? '+' : '') + points;
  el.style.left = x + 'px'; el.style.top = y + 'px';
  container.appendChild(el);
  setTimeout(() => el.remove(), 900);
}
function showLevelUp(lv) {
  SFX.levelup();
  const ov = document.createElement('div');
  ov.className = 'levelup-overlay';
  ov.innerHTML = `<div class="levelup-box">üß™ Î†àÎ≤® ${lv} Îã¨ÏÑ±!</div>`;
  document.body.appendChild(ov);
  setTimeout(() => ov.remove(), 800);
}
function setMascotEmotion(mouthId, bubbleId, emotion) {
  const mouth = document.getElementById(mouthId);
  const bubble = document.getElementById(bubbleId);
  if (!mouth) return;
  if (emotion === 'happy') {
    mouth.setAttribute('d', 'M44,54 Q50,64 56,54');
    if (bubble) { bubble.textContent = ['ÎåÄÎ∞ï!','Ïö∞ÏôÄ!','Ïß±!','ÏÑ±Í≥µ!'][Math.floor(Math.random()*4)]; bubble.classList.add('show'); setTimeout(() => bubble.classList.remove('show'), 2000); }
  } else if (emotion === 'worried') {
    mouth.setAttribute('d', 'M44,60 Q50,53 56,60');
    if (bubble) { bubble.textContent = 'Ïïó!'; bubble.classList.add('show'); setTimeout(() => bubble.classList.remove('show'), 1500); }
  } else {
    mouth.setAttribute('d', 'M44,54 Q50,62 56,54');
  }
  setTimeout(() => { if (mouth) mouth.setAttribute('d', 'M44,54 Q50,62 56,54'); }, 2500);
}

// ===== Profile =====
let _prevMainLevel = 1;
function updateProfile() {
  document.getElementById('pf-name').textContent = profile.name;
  document.getElementById('pf-char').textContent = profile.char;
  const lv = Math.floor(profile.totalCorrect / 10) + 1;
  if (lv > _prevMainLevel && _prevMainLevel > 0) showLevelUp(lv);
  _prevMainLevel = lv;
  document.getElementById('pf-level').textContent = lv;
  const prog = (profile.totalCorrect % 10);
  document.getElementById('pf-done').textContent = prog;
  document.getElementById('pf-total').textContent = 10;
  document.getElementById('pf-bar').style.width = (prog * 10) + '%';
}
function changeName() {
  const n = prompt('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', profile.name);
  if (n && n.trim()) { profile.name = n.trim(); LS.setItem('sciName', profile.name); updateProfile(); }
}
function showCharModal() {
  document.getElementById('char-modal').classList.remove('hidden');
  const chars = ['üßí','üë¶','üëß','ü¶∏‚Äç‚ôÇÔ∏è','ü¶∏‚Äç‚ôÄÔ∏è','üßô‚Äç‚ôÇÔ∏è','üê±','üê∂','ü¶ä','üêª','üê∞','üê∏','ü¶Å','üêØ','üêº'];
  const g = document.getElementById('char-grid');
  g.innerHTML = chars.map(c => '<div class="char-item' + (c===profile.char?' selected':'') + '" onclick="pickChar(\'' + c + '\')">' + c + '</div>').join('');
}
function hideCharModal() { document.getElementById('char-modal').classList.add('hidden'); }
function pickChar(c) { profile.char = c; LS.setItem('sciChar', c); updateProfile(); hideCharModal(); }
function showAdmin() { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('adm-name').value = profile.name; }
function hideAdmin() { document.getElementById('admin-modal').classList.add('hidden'); }
function saveProfile() {
  const n = document.getElementById('adm-name').value.trim();
  if (n) { profile.name = n; LS.setItem('sciName', n); updateProfile(); }
  hideAdmin();
}
function resetAll() {
  if (!confirm('Î™®Îì† Í∏∞Î°ùÏù¥ ÏÇ¨ÎùºÏßëÎãàÎã§. Ï†ïÎßê Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?')) return;
  ['sciName','sciChar','sciCorrect','sciPlayed','mixDisc','mixTried','mixScore','mixBestStreak','mixDex',
   'wtCorrect','wtScore','wtBestStreak','ltMixes','ltScore','heroBest'].forEach(k => LS.removeItem(k));
  location.reload();
}
function saveStats() {
  LS.setItem('sciCorrect', profile.totalCorrect);
  LS.setItem('sciPlayed', profile.totalPlayed);
  LS.setItem('mixDisc', mix.discovered.size);
  LS.setItem('mixTried', mix.tried);
  LS.setItem('mixScore', mix.score);
  LS.setItem('mixBestStreak', mix.bestStreak);
  LS.setItem('mixDex', JSON.stringify(Array.from(mix.dex)));
  LS.setItem('wtCorrect', wt.correctCount);
  LS.setItem('wtScore', wt.score);
  LS.setItem('wtBestStreak', wt.bestStreak);
  LS.setItem('ltMixes', lt.mixes);
  LS.setItem('ltScore', lt.score);
  LS.setItem('heroBest', hg.bestScore);
}

// ===== Tab Switch =====
function switchTab(tab) {
  speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', ['mix','weight','light','record'][i] === tab);
  });
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector('.' + tab + '-side').classList.add('active');
  document.querySelectorAll('.game-view').forEach(v => v.classList.remove('active'));
  document.querySelector('.' + tab + '-view').classList.add('active');
  updateActionButtons();
  if (tab === 'record') updateRecords();
}
function updateActionButtons() {
  const a1 = document.getElementById('act1');
  const a2 = document.getElementById('act2');
  const a3 = document.getElementById('act3');
  if (currentTab === 'mix') {
    a1.innerHTML = '<span class="icon">üìñ</span>ÎèÑÍ∞ê'; a1.className = 'action-btn btn-cyan'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">üß™</span>ÏÑûÍ∏∞'; a2.className = 'action-btn btn-green'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">üîÑ</span>Îã§Ïãú'; a3.className = 'action-btn btn-red'; a3.disabled = false;
  } else if (currentTab === 'weight') {
    a1.innerHTML = '<span class="icon">üí°</span>ÌûåÌä∏'; a1.className = 'action-btn btn-cyan'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">‚è≠</span>Îã§Ïùå'; a2.className = 'action-btn btn-green'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">üîÑ</span>Îã§Ïãú'; a3.className = 'action-btn btn-red'; a3.disabled = false;
  } else if (currentTab === 'light') {
    a1.innerHTML = '<span class="icon">üí°</span>ÌûåÌä∏'; a1.className = 'action-btn btn-cyan'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">üîÑ</span>Î¶¨ÏÖã'; a2.className = 'action-btn btn-orange'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">‚è≠</span>Îã§Ïùå'; a3.className = 'action-btn btn-green'; a3.disabled = false;
  } else {
    a1.innerHTML = '<span class="icon">üìä</span>Í∏∞Î°ù'; a1.className = 'action-btn btn-cyan'; a1.disabled = true;
    a2.innerHTML = '<span class="icon">‚Äî</span>‚Äî'; a2.className = 'action-btn btn-green'; a2.disabled = true;
    a3.innerHTML = '<span class="icon">‚Äî</span>‚Äî'; a3.className = 'action-btn btn-red'; a3.disabled = true;
  }
}
function actionBtn(n) {
  if (currentTab === 'mix') { if (n===1) showDex(); else if (n===2) mixConfirm(); else mixReset(); }
  else if (currentTab === 'weight') { if (n===1) wtHint(); else if (n===2) newWeightQuestion(); else newWeightQuestion(); }
  else if (currentTab === 'light') { if (n===1) ltHint(); else if (n===2) initLightMode(); else initLightMode(); }
}

// ===== MIX GAME =====
const RECIPES = [
  {a:'ÏãùÏ¥à',b:'Î≤†Ïù¥ÌÇπÏÜåÎã§',ae:'ü´ó',be:'üßÇ',result:'Í±∞Ìíà Ìè≠Î∞ú!',re:'ü´ß',color:'#a7f3d0',desc:'Ïù¥ÏÇ∞ÌôîÌÉÑÏÜå Í∏∞Ï≤¥Í∞Ä ÎÇòÏôÄÏöî'},
  {a:'Î¨º',b:'Í∏∞Î¶Ñ',ae:'üíß',be:'ü´ó',result:'Ï∏µ Î∂ÑÎ¶¨!',re:'üîµ',color:'#93c5fd',desc:'Î¨ºÍ≥º Í∏∞Î¶ÑÏùÄ ÏÑûÏù¥ÏßÄ ÏïäÏïÑÏöî'},
  {a:'Ïö∞Ïú†',b:'ÏãùÏö©ÏÉâÏÜå',ae:'ü•õ',be:'üé®',result:'ÎßàÎ∏îÎßÅ!',re:'üåÄ',color:'#c4b5fd',desc:'ÏÉâÏÜåÍ∞Ä ÌçºÏßÄÎ©∞ Î¨¥Îä¨Î•º ÎßåÎì§Ïñ¥Ïöî'},
  {a:'Î†àÎ™¨Ï¶ô',b:'Ïö∞Ïú†',ae:'üçã',be:'ü•õ',result:'ÏùëÍ≥†!',re:'üßÄ',color:'#fde68a',desc:'ÏÇ∞ ÎïåÎ¨∏Ïóê Ïö∞Ïú†Í∞Ä Íµ≥Ïñ¥Ïöî'},
  {a:'ÏÜåÍ∏à',b:'ÏñºÏùå',ae:'üßÇ',be:'üßä',result:'Ï¥àÎÉâÍ∞Å!',re:'‚ùÑÔ∏è',color:'#bae6fd',desc:'ÏÜåÍ∏àÏù¥ ÏñºÏùåÏùÑ Îçî Ï∞®Í∞ëÍ≤å Ìï¥Ïöî'},
  {a:'ÏãùÏ¥à',b:'Îã¨Í±Ä',ae:'ü´ó',be:'ü•ö',result:'Ìà¨Î™Ö Îã¨Í±Ä!',re:'üîÆ',color:'#fecaca',desc:'ÏãùÏ¥àÍ∞Ä ÍªçÎç∞Í∏∞Î•º ÎÖπÏó¨Ïöî'},
  {a:'Î¨º',b:'ÏãùÏö©ÏÉâÏÜå',ae:'üíß',be:'üé®',result:'ÏÉâ Î≥ÄÌôî!',re:'üåà',color:'#ddd6fe',desc:'ÏÉâÏÜåÍ∞Ä Î¨ºÏóê ÌçºÏ†∏Ïöî'},
  {a:'Î≤†Ïù¥ÌÇπÏÜåÎã§',b:'Î†àÎ™¨Ï¶ô',ae:'üßÇ',be:'üçã',result:'ÌôîÏÇ∞ Ìè≠Î∞ú!',re:'üåã',color:'#fed7aa',desc:'ÏÇ∞Í≥º ÏóºÍ∏∞Í∞Ä ÎßåÎÇò Î∞òÏùëÌï¥Ïöî'},
  {a:'Î¨º',b:'ÏÜåÍ∏à',ae:'üíß',be:'üßÇ',result:'ÏÜåÍ∏àÎ¨º!',re:'ü´ß',color:'#ccfbf1',desc:'ÏÜåÍ∏àÏù¥ Î¨ºÏóê ÎÖπÏïÑÏöî'},
  {a:'Í∏∞Î¶Ñ',b:'ÏãùÏö©ÏÉâÏÜå',ae:'ü´ó',be:'üé®',result:'Ïö©Ïïî Îû®ÌîÑ!',re:'üî¥',color:'#fca5a5',desc:'ÏÉâÏÜå Î∞©Ïö∏Ïù¥ Í∏∞Î¶Ñ ÏÜçÏùÑ ÎèåÏïÑÎã§ÎÖÄÏöî'},
];
const INGREDIENTS = ['ÏãùÏ¥à','Î≤†Ïù¥ÌÇπÏÜåÎã§','Î¨º','Í∏∞Î¶Ñ','Ïö∞Ïú†','ÏãùÏö©ÏÉâÏÜå','Î†àÎ™¨Ï¶ô','ÏÜåÍ∏à','ÏñºÏùå','Îã¨Í±Ä'];
const ING_EMOJI = {'ÏãùÏ¥à':'ü´ó','Î≤†Ïù¥ÌÇπÏÜåÎã§':'üßÇ','Î¨º':'üíß','Í∏∞Î¶Ñ':'üõ¢Ô∏è','Ïö∞Ïú†':'ü•õ','ÏãùÏö©ÏÉâÏÜå':'üé®','Î†àÎ™¨Ï¶ô':'üçã','ÏÜåÍ∏à':'üßÇ','ÏñºÏùå':'üßä','Îã¨Í±Ä':'ü•ö'};

let mix = {
  selected: [],
  tried: parseInt(LS.getItem('mixTried')) || 0,
  score: parseInt(LS.getItem('mixScore')) || 0,
  streak: 0,
  bestStreak: parseInt(LS.getItem('mixBestStreak')) || 0,
  discovered: new Set(),
  dex: new Set(JSON.parse(LS.getItem('mixDex') || '[]'))
};
mix.discovered = new Set(Array.from(mix.dex));

function initMixGame() {
  mix.selected = [];
  const row = document.getElementById('mix-ingredients');
  // 10Í∞ú Ï†ÑÎ∂Ä ÌëúÏãú (5+5 Î∞∞Ïπò)
  const pool = [...INGREDIENTS];
  row.innerHTML = pool.map((ing, i) =>
    '<div class="mix-ingredient" data-ing="' + ing + '" onclick="selectIngredient(this,' + i + ')">' +
    '<div class="mi-emoji">' + (INGREDIENT_SVG[ing]||'üß™') + '</div>' + ing + '</div>'
  ).join('');
  document.getElementById('mix-status').textContent = 'Ïû¨Î£å 2Í∞úÎ•º Í≥®Îùº ÎπÑÏª§Ïóê ÎÑ£Ïñ¥Î≥¥ÏÑ∏Ïöî!';
  // ÏÑ†ÌÉù Ïä¨Î°Ø Î¶¨ÏÖã
  const slotA = document.getElementById('mix-sel-a');
  const slotB = document.getElementById('mix-sel-b');
  if (slotA) { slotA.innerHTML = '?'; slotA.style.borderStyle = 'dashed'; slotA.style.borderColor = '#99f6e4'; }
  if (slotB) { slotB.innerHTML = '?'; slotB.style.borderStyle = 'dashed'; slotB.style.borderColor = '#99f6e4'; }
  // ÎπÑÏª§ Î¶¨ÏÖã
  const liq = document.getElementById('beaker-liquid');
  liq.setAttribute('y', '190');
  liq.setAttribute('height', '0');
  liq.setAttribute('fill', '#5eead4');
  updateMixUI();
}

function selectIngredient(el, idx) {
  if (mix.selected.length >= 2 && !el.classList.contains('selected')) return;
  el.classList.toggle('selected');
  const ing = el.dataset.ing;
  if (el.classList.contains('selected')) {
    mix.selected.push(ing);
  } else {
    mix.selected = mix.selected.filter(s => s !== ing);
  }
  /* ÏÑ†ÌÉù Ïä¨Î°Ø ÏóÖÎç∞Ïù¥Ìä∏ */
  const slotA = document.getElementById('mix-sel-a');
  const slotB = document.getElementById('mix-sel-b');
  if (mix.selected.length >= 1) {
    slotA.innerHTML = '<div style="width:50px;height:50px">' + (INGREDIENT_SVG[mix.selected[0]]||'?') + '</div>';
    slotA.style.borderStyle = 'solid';
    slotA.style.borderColor = '#0d9488';
  } else {
    slotA.innerHTML = '?'; slotA.style.borderStyle = 'dashed'; slotA.style.borderColor = '#99f6e4';
  }
  if (mix.selected.length >= 2) {
    slotB.innerHTML = '<div style="width:50px;height:50px">' + (INGREDIENT_SVG[mix.selected[1]]||'?') + '</div>';
    slotB.style.borderStyle = 'solid';
    slotB.style.borderColor = '#0d9488';
  } else {
    slotB.innerHTML = '?'; slotB.style.borderStyle = 'dashed'; slotB.style.borderColor = '#99f6e4';
  }
  if (mix.selected.length === 2) {
    document.getElementById('mix-status').textContent = mix.selected[0] + ' + ' + mix.selected[1] + ' ‚Üí ÏÑûÍ∏∞ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî!';
  } else if (mix.selected.length === 1) {
    document.getElementById('mix-status').textContent = mix.selected[0] + ' ÏÑ†ÌÉù! ÌïòÎÇò Îçî Í≥®ÎùºÏ£ºÏÑ∏Ïöî';
  } else {
    document.getElementById('mix-status').textContent = 'Ïû¨Î£å 2Í∞úÎ•º Í≥®Îùº ÎπÑÏª§Ïóê ÎÑ£Ïñ¥Î≥¥ÏÑ∏Ïöî!';
  }
}

function mixConfirm() {
  if (mix.selected.length !== 2) { speak('Ïû¨Î£å 2Í∞úÎ•º Í≥®ÎùºÏ£ºÏÑ∏Ïöî!'); return; }
  mix.tried++;
  profile.totalPlayed++;
  const a = mix.selected[0], b = mix.selected[1];
  const recipe = RECIPES.find(r => (r.a===a && r.b===b) || (r.a===b && r.b===a));

  // ÎπÑÏª§ Ï±ÑÏö∞Í∏∞ Ïï†ÎãàÎ©îÏù¥ÏÖò
  const liq = document.getElementById('beaker-liquid');
  const color = recipe ? recipe.color : '#94a3b8';
  liq.setAttribute('fill', color);
  liq.setAttribute('y', '100');
  liq.setAttribute('height', '90');

  if (recipe) {
    mix.streak++;
    mix.score += 10 + mix.streak * 2;
    if (mix.streak > mix.bestStreak) mix.bestStreak = mix.streak;
    profile.totalCorrect++;
    const key = [a,b].sort().join('+');
    const isNew = !mix.discovered.has(key);
    mix.discovered.add(key);
    mix.dex.add(key);
    // Í±∞Ìíà ÌååÌã∞ÌÅ¥ + Í∞ïÌôî Ïù¥ÌéôÌä∏
    SFX.mix(); SFX.correct(); setMascotEmotion('mascot-mix-mouth','bubble-mix','happy');
    mixBubbleEffect(recipe.color);
    beakerReactionEffect(recipe.color, 'foam');
    beakerReactionEffect(recipe.color, 'spark');
    playMixSound();
    setTimeout(() => {
      const disc = document.createElement('div');
      disc.className = 'mix-discovery';
      disc.innerHTML = recipe.re + ' ' + recipe.result + '<br><span style="font-size:16px;color:#64748b">' + recipe.desc + '</span>' + (isNew ? '<br><span style="color:#f59e0b;font-size:18px">ÏÉà Î∞úÍ≤¨!</span>' : '');
      document.getElementById('mix-area').appendChild(disc);
      speak(recipe.result + '. ' + recipe.desc);
      setTimeout(() => disc.remove(), 3000);
    }, 800);
  } else {
    mix.streak = 0;
    document.getElementById('mix-status').textContent = 'Î∞òÏùë ÏóÜÏùå... Îã§Î•∏ Ï°∞Ìï©ÏùÑ ÏãúÎèÑÌï¥Î¥ê!';
    const key = [a,b].sort().join('+');
    mix.dex.add('X:' + key);
    SFX.wrong(); setMascotEmotion('mascot-mix-mouth','bubble-mix','worried');
    speak('Ïùå, Ïù¥ Ï°∞Ìï©ÏùÄ Î∞òÏùëÏù¥ ÏóÜÎÑ§Ïöî');
  }
  updateMixUI();
  updateProfile();
  saveStats();
  setTimeout(() => initMixGame(), 3500);
}

function mixBubbleEffect(color) {
  const area = document.getElementById('mix-area');
  for (let i = 0; i < 15; i++) {
    setTimeout(() => {
      const b = document.createElement('div');
      b.className = 'mix-bubble';
      const size = 8 + Math.random() * 20;
      const x = 50 + Math.random() * 40 - 20;
      b.style.cssText = 'left:' + x + '%;bottom:30%;width:' + size + 'px;height:' + size + 'px;background:' + color + ';opacity:.5;--ty:-' + (60 + Math.random()*80) + 'px;--dur:' + (0.8+Math.random()*0.8) + 's';
      area.appendChild(b);
      setTimeout(() => b.remove(), 1600);
    }, i * 80);
  }
}

function mixReset() { initMixGame(); }

function updateMixUI() {
  document.getElementById('mix-discovered').textContent = mix.discovered.size;
  document.getElementById('mix-tried').textContent = mix.tried;
  document.getElementById('mix-streak').textContent = mix.streak;
  document.getElementById('mix-score-side').textContent = mix.score;
}

function showDex() {
  document.getElementById('dex-modal').classList.remove('hidden');
  const grid = document.getElementById('dex-grid');
  let html = '';
  RECIPES.forEach(r => {
    const key = [r.a, r.b].sort().join('+');
    const found = mix.discovered.has(key);
    html += '<div class="dex-item ' + (found ? 'discovered' : '') + '"><span class="dex-emoji">' + (found ? r.re : '‚ùì') + '</span>' + (found ? r.a+'+'+r.b+'<br>'+r.result : '???') + '</div>';
  });
  grid.innerHTML = html;
}
function hideDex() { document.getElementById('dex-modal').classList.add('hidden'); }

// ===== WEIGHT GAME =====
const OBJECTS = [
  {name:'ÏΩîÎÅºÎ¶¨',emoji:'üêò',weight:5000},{name:'Í≥†ÏñëÏù¥',emoji:'üê±',weight:4},
  {name:'ÏûêÎèôÏ∞®',emoji:'üöó',weight:1500},{name:'ÏûêÏ†ÑÍ±∞',emoji:'üö≤',weight:12},
  {name:'ÏàòÎ∞ï',emoji:'üçâ',weight:8},{name:'Îî∏Í∏∞',emoji:'üçì',weight:0.02},
  {name:'Î≥ºÎßÅÍ≥µ',emoji:'üé≥',weight:6},{name:'ÌíçÏÑ†',emoji:'üéà',weight:0.003},
  {name:'Ï±Ö',emoji:'üìö',weight:0.5},{name:'ÍπÉÌÑ∏',emoji:'ü™∂',weight:0.001},
  {name:'Í∏àÌôî',emoji:'ü™ô',weight:0.03},{name:'ÎÉâÏû•Í≥†',emoji:'üßä',weight:80},
  {name:'Í∞ïÏïÑÏßÄ',emoji:'üê∂',weight:10},{name:'Í∞úÎØ∏',emoji:'üêú',weight:0.0001},
  {name:'ÎπÑÌñâÍ∏∞',emoji:'‚úàÔ∏è',weight:80000},{name:'Î∞∞',emoji:'üö¢',weight:50000},
  {name:'ÏÇ¨Í≥º',emoji:'üçé',weight:0.2},{name:'Î∞îÎÇòÎÇò',emoji:'üçå',weight:0.12},
  {name:'ÌîºÏïÑÎÖ∏',emoji:'üéπ',weight:300},{name:'Í∏∞ÌÉÄ',emoji:'üé∏',weight:3},
];

let wt = {
  left: null, right: null, answer: -1, qNum: 1,
  correctCount: parseInt(LS.getItem('wtCorrect')) || 0,
  score: parseInt(LS.getItem('wtScore')) || 0,
  streak: 0,
  bestStreak: parseInt(LS.getItem('wtBestStreak')) || 0,
  answered: false
};

function newWeightQuestion() {
  wt.answered = false;
  const shuffled = [...OBJECTS].sort(() => Math.random() - 0.5);
  wt.left = shuffled[0];
  wt.right = shuffled[1];
  // Í∞ôÏùÄ Î¨¥Í≤åÎ©¥ Îã§Ïãú
  if (wt.left.weight === wt.right.weight) { wt.right = shuffled[2]; }
  wt.answer = wt.left.weight > wt.right.weight ? 0 : 1;

  document.getElementById('wt-question').textContent = 'Ïñ¥Îñ§ Í≤å Îçî Î¨¥Í±∞Ïö∏Íπå? ü§î';
  document.getElementById('scale-left-emoji').textContent = wt.left.name;
  document.getElementById('scale-right-emoji').textContent = wt.right.name;
  document.getElementById('scale-beam').style.transform = 'rotate(0deg)';
  document.getElementById('wt-result').textContent = '';

  const items = document.getElementById('wt-items');
  items.innerHTML =
    '<div class="weight-item" onclick="pickWeight(0)"><div class="wi-emoji">' + (OBJECT_SVG[wt.left.name]||wt.left.emoji) + '</div><div class="wi-name">' + wt.left.name + '</div></div>' +
    '<div class="weight-item" onclick="pickWeight(1)"><div class="wi-emoji">' + (OBJECT_SVG[wt.right.name]||wt.right.emoji) + '</div><div class="wi-name">' + wt.right.name + '</div></div>';
  updateWeightUI();
}

function pickWeight(choice) {
  if (wt.answered) return;
  wt.answered = true;
  profile.totalPlayed++;
  wt.qNum++;

  const beam = document.getElementById('scale-beam');
  const correct = choice === wt.answer;
  const heavier = wt.answer === 0 ? 'left' : 'right';

  // Ï†ÄÏö∏ Í∏∞Ïö∏Ïù¥Í∏∞
  beam.style.transform = heavier === 'left' ? 'rotate(-12deg)' : 'rotate(12deg)';

  if (correct) {
    wt.correctCount++;
    wt.streak++;
    wt.score += 10 + wt.streak * 2;
    if (wt.streak > wt.bestStreak) wt.bestStreak = wt.streak;
    profile.totalCorrect++;
    document.getElementById('wt-result').textContent = 'üéâ Ï†ïÎãµ! ' + (wt.answer===0?wt.left.name:wt.right.name) + 'Ïù¥(Í∞Ä) Îçî Î¨¥Í±∞ÏõåÏöî!';
    document.getElementById('wt-result').style.color = '#059669';
    SFX.correct(); setMascotEmotion('mascot-wt-mouth','bubble-wt','happy');
    speak('Ï†ïÎãµ! ' + (wt.answer===0?wt.left.name:wt.right.name) + 'Ïù¥ Îçî Î¨¥Í±∞ÏõåÏöî');
    wtSuccessEffect();
    scaleWobbleEffect();
    wtCorrectGlowEffect();
    wtConfettiEffect();
    playSuccessSound();
  } else {
    wt.streak = 0;
    document.getElementById('wt-result').textContent = '‚ùå ÏïÑÏâ¨ÏõåÏöî! ' + (wt.answer===0?wt.left.name:wt.right.name) + 'Ïù¥(Í∞Ä) Îçî Î¨¥Í±∞ÏõåÏöî';
    document.getElementById('wt-result').style.color = '#dc2626';
    SFX.wrong(); setMascotEmotion('mascot-wt-mouth','bubble-wt','worried');
    speak('ÏïÑÏâ¨ÏõåÏöî. ' + (wt.answer===0?wt.left.name:wt.right.name) + 'Ïù¥ Îçî Î¨¥Í±∞ÏõåÏöî');
    scaleWobbleEffect();
    playFailSound();
  }
  updateWeightUI();
  updateProfile();
  saveStats();
  setTimeout(() => newWeightQuestion(), 2500);
}

function wtSuccessEffect() {
  const area = document.getElementById('weight-area');
  const emojis = ['‚≠ê','‚ú®','üåü','üí´','üéâ'];
  for (let i = 0; i < 10; i++) {
    const p = document.createElement('div');
    p.className = 'success-particle';
    p.textContent = emojis[Math.floor(Math.random()*emojis.length)];
    const x = 30 + Math.random() * 40;
    const angle = Math.random() * Math.PI * 2;
    const dist = 60 + Math.random() * 80;
    p.style.cssText = 'left:' + x + '%;top:50%;font-size:' + (20+Math.random()*16) + 'px;--tx:' + (Math.cos(angle)*dist) + 'px;--ty:' + (Math.sin(angle)*dist) + 'px;--dur:' + (0.6+Math.random()*0.4) + 's';
    area.appendChild(p);
    setTimeout(() => p.remove(), 1000);
  }
}

function wtHint() {
  if (wt.answered) return;
  const heavier = wt.answer === 0 ? wt.left : wt.right;
  speak('ÌûåÌä∏! ' + heavier.name + 'ÏùÑ ÏÉùÍ∞ÅÌï¥Î≥¥ÏÑ∏Ïöî');
  document.getElementById('wt-result').textContent = 'üí° ÌÅ¨Í∏∞Í∞Ä ÌÅ∞ Í≤å Ìï≠ÏÉÅ Î¨¥Í±∞Ïö¥ Í±¥ ÏïÑÎãàÏóêÏöî!';
  document.getElementById('wt-result').style.color = '#0d9488';
}

function updateWeightUI() {
  document.getElementById('wt-qnum').textContent = wt.qNum;
  document.getElementById('wt-correct').textContent = wt.correctCount;
  document.getElementById('wt-streak').textContent = wt.streak;
  document.getElementById('wt-score-side').textContent = wt.score;
}

// ===== LIGHT GAME =====
let lt = {
  mode: 'prism',
  mixes: parseInt(LS.getItem('ltMixes')) || 0,
  score: parseInt(LS.getItem('ltScore')) || 0,
  selectedColors: [],
  prismActive: false
};

const COLOR_MIXES = [
  {a:'Îπ®Í∞ï',b:'ÌååÎûë',ac:'#ef4444',bc:'#3b82f6',result:'Î≥¥Îùº',rc:'#8b5cf6'},
  {a:'Îπ®Í∞ï',b:'ÎÖ∏Îûë',ac:'#ef4444',bc:'#eab308',result:'Ï£ºÌô©',rc:'#f97316'},
  {a:'ÌååÎûë',b:'ÎÖ∏Îûë',ac:'#3b82f6',bc:'#eab308',result:'Ï¥àÎ°ù',rc:'#22c55e'},
  {a:'Îπ®Í∞ï',b:'Ï¥àÎ°ù',ac:'#ef4444',bc:'#22c55e',result:'Í∞àÏÉâ',rc:'#92400e'},
  {a:'Îπ®Í∞ï',b:'Ìù∞ÏÉâ',ac:'#ef4444',bc:'#ffffff',result:'Î∂ÑÌôç',rc:'#f9a8d4'},
  {a:'ÌååÎûë',b:'Ìù∞ÏÉâ',ac:'#3b82f6',bc:'#ffffff',result:'ÌïòÎäò',rc:'#7dd3fc'},
];

function setLightMode(mode) {
  lt.mode = mode;
  lt.selectedColors = [];
  document.querySelectorAll('.light-mode-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.light-mode-btn[onclick*="' + mode + '"]').classList.add('active');
  document.getElementById('lt-mode').textContent = mode === 'prism' ? 'ÌîÑÎ¶¨Ï¶ò' : mode === 'colormix' ? 'ÏÉâ ÌòºÌï©' : 'Í∑∏Î¶ºÏûê';
  initLightMode();
}

function initLightMode() {
  const canvas = document.getElementById('light-canvas');
  canvas.innerHTML = '';
  lt.selectedColors = [];

  if (lt.mode === 'prism') {
    initPrism(canvas);
  } else if (lt.mode === 'colormix') {
    initColorMix(canvas);
  } else {
    initShadow(canvas);
  }
}

function initPrism(canvas) {
  document.getElementById('light-info').innerHTML = '<span style="color:#fbbf24">&#9757;</span> ÌîÑÎ¶¨Ï¶ò ÏÇºÍ∞ÅÌòïÏùÑ ÌÑ∞ÏπòÌï¥Î≥¥ÏÑ∏Ïöî!';
  canvas.innerHTML = '<svg width="100%" height="100%" viewBox="0 0 900 500" style="position:absolute;inset:0">' +
    '<defs>' +
    '<linearGradient id="beam" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#fef3c7"/><stop offset="100%" stop-color="#fbbf24"/></linearGradient>' +
    '<linearGradient id="rainbowDeco" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#ef4444"/><stop offset="16%" stop-color="#f97316"/><stop offset="33%" stop-color="#eab308"/><stop offset="50%" stop-color="#22c55e"/><stop offset="66%" stop-color="#3b82f6"/><stop offset="83%" stop-color="#6366f1"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient>' +
    '<radialGradient id="starGlow"><stop offset="0%" stop-color="rgba(255,255,255,.8)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient>' +
    '<radialGradient id="sunGlow" cx=".5" cy=".5" r=".5"><stop offset="0%" stop-color="#fbbf24"/><stop offset="60%" stop-color="#f59e0b" stop-opacity=".6"/><stop offset="100%" stop-color="#f59e0b" stop-opacity="0"/></radialGradient>' +
    '</defs>' +
    /* Î∞∞Í≤Ω Ïû•Ïãù: Î∞òÏßùÏù¥Îäî Î≥ÑÎì§ */
    '<circle cx="50" cy="60" r="3" fill="#fff" opacity=".6"><animate attributeName="opacity" values=".3;.9;.3" dur="2s" repeatCount="indefinite"/></circle>' +
    '<circle cx="150" cy="40" r="2" fill="#fff" opacity=".4"><animate attributeName="opacity" values=".2;.8;.2" dur="2.5s" repeatCount="indefinite"/></circle>' +
    '<circle cx="680" cy="50" r="3" fill="#fff" opacity=".5"><animate attributeName="opacity" values=".3;1;.3" dur="1.8s" repeatCount="indefinite"/></circle>' +
    '<circle cx="750" cy="90" r="2" fill="#fff" opacity=".4"><animate attributeName="opacity" values=".2;.7;.2" dur="3s" repeatCount="indefinite"/></circle>' +
    '<circle cx="600" cy="420" r="2" fill="#5eead4" opacity=".5"><animate attributeName="opacity" values=".3;.9;.3" dur="2.2s" repeatCount="indefinite"/></circle>' +
    '<circle cx="720" cy="380" r="3" fill="#5eead4" opacity=".4"><animate attributeName="opacity" values=".2;.8;.2" dur="2.7s" repeatCount="indefinite"/></circle>' +
    /* Ïû•Ïãù Î¨¥ÏßÄÍ∞ú ÏïÑÏπò (Ïö∞ÌïòÎã®) */
    '<path d="M 560 460 Q 660 340 760 460" fill="none" stroke="url(#rainbowDeco)" stroke-width="8" opacity=".2" stroke-linecap="round"/>' +
    '<path d="M 570 460 Q 660 350 750 460" fill="none" stroke="url(#rainbowDeco)" stroke-width="5" opacity=".12" stroke-linecap="round"/>' +
    /* ÌÉúÏñë/Îπõ ÏõêÏ≤ú (ÏôºÏ™Ω) */
    '<circle cx="80" cy="250" r="70" fill="url(#sunGlow)"/>' +
    '<circle cx="80" cy="250" r="32" fill="#fbbf24"/>' +
    '<circle cx="80" cy="250" r="32" fill="none" stroke="#f59e0b" stroke-width="2"/>' +
    /* ÌÉúÏñë Í¥ëÏÑ† Ïû•Ïãù */
    '<line x1="120" y1="250" x2="140" y2="250" stroke="#fbbf24" stroke-width="3" stroke-linecap="round" opacity=".7"/>' +
    '<line x1="108" y1="218" x2="120" y2="206" stroke="#fbbf24" stroke-width="2.5" stroke-linecap="round" opacity=".6"/>' +
    '<line x1="108" y1="282" x2="120" y2="294" stroke="#fbbf24" stroke-width="2.5" stroke-linecap="round" opacity=".6"/>' +
    '<line x1="80" y1="210" x2="80" y2="196" stroke="#fbbf24" stroke-width="2.5" stroke-linecap="round" opacity=".5"/>' +
    '<line x1="80" y1="290" x2="80" y2="304" stroke="#fbbf24" stroke-width="2.5" stroke-linecap="round" opacity=".5"/>' +
    '<text x="80" y="256" text-anchor="middle" font-size="28" font-weight="800" fill="#78350f" style="pointer-events:none">&#9728;</text>' +
    /* Í¥ëÏÑ† Îπî (ÌÉúÏñëÏóêÏÑú ÌîÑÎ¶¨Ï¶òÏúºÎ°ú) */
    '<line id="prism-beam" x1="120" y1="250" x2="290" y2="260" stroke="url(#beam)" stroke-width="10" opacity=".8"/>' +
    /* ÌîÑÎ¶¨Ï¶ò Í∏ÄÎ°úÏö∞ */
    '<polygon points="350,140 460,360 240,360" fill="rgba(94,234,212,.06)" stroke="none" style="filter:blur(20px)"/>' +
    /* ÌîÑÎ¶¨Ï¶ò Î≥∏Ï≤¥ (Îçî ÌÅ¨Í≤å) */
    '<polygon id="prism-shape" points="350,140 460,360 240,360" fill="rgba(255,255,255,.12)" stroke="#5eead4" stroke-width="3.5" style="cursor:pointer;filter:drop-shadow(0 0 25px rgba(94,234,212,.5))"/>' +
    /* ÌîÑÎ¶¨Ï¶ò Ïïà Î∞òÏßùÏûÑ */
    '<polygon points="345,175 425,330 275,330" fill="none" stroke="rgba(255,255,255,.15)" stroke-width="1"/>' +
    /* ÌîÑÎ¶¨Ï¶ò Ïïà ÏÜêÍ∞ÄÎùΩ ÏïÑÏù¥ÏΩò + Î¨ºÍ≤∞ */
    '<circle cx="350" cy="270" r="35" fill="none" stroke="rgba(255,255,255,.25)" stroke-width="2"><animate attributeName="r" values="30;40;30" dur="2s" repeatCount="indefinite"/><animate attributeName="opacity" values=".5;.1;.5" dur="2s" repeatCount="indefinite"/></circle>' +
    '<circle cx="350" cy="270" r="20" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="1.5"><animate attributeName="r" values="18;28;18" dur="1.5s" repeatCount="indefinite"/><animate attributeName="opacity" values=".6;.15;.6" dur="1.5s" repeatCount="indefinite"/></circle>' +
    '<text x="350" y="262" text-anchor="middle" font-size="36" style="pointer-events:none">&#9757;&#65039;</text>' +
    '<text x="350" y="300" text-anchor="middle" font-size="18" fill="rgba(255,255,255,.7)" font-weight="700" style="pointer-events:none">ÌÑ∞Ïπò!</text>' +
    '<g id="rainbow-group" opacity="0"></g>' +
    '</svg>';
  document.getElementById('prism-shape').addEventListener('click', activatePrism);
}

function activatePrism() {
  if (lt.prismActive) return;
  lt.prismActive = true;
  lt.mixes++;
  lt.score += 15;
  profile.totalCorrect++;
  profile.totalPlayed++;

  const rainbow = document.getElementById('rainbow-group');
  const colors = ['#ef4444','#f97316','#eab308','#22c55e','#3b82f6','#6366f1','#8b5cf6'];
  const names = ['Îπ®Í∞ï','Ï£ºÌô©','ÎÖ∏Îûë','Ï¥àÎ°ù','ÌååÎûë','ÎÇ®ÏÉâ','Î≥¥Îùº'];
  let html = '';
  colors.forEach((c, i) => {
    const endY = 80 + i * 48;
    html += '<line x1="430" y1="' + (230+i*6) + '" x2="780" y2="' + endY + '" stroke="' + c + '" stroke-width="8" opacity=".9"><animate attributeName="x2" from="430" to="780" dur="0.8s" fill="freeze"/><animate attributeName="opacity" from="0" to=".9" dur="0.5s" fill="freeze"/></line>';
    html += '<text x="795" y="' + (endY+8) + '" fill="#000" font-size="32" font-weight="900" stroke="#000" stroke-width="5" paint-order="stroke">' + names[i] + '</text>';
    html += '<text x="795" y="' + (endY+8) + '" fill="' + c + '" font-size="32" font-weight="900" style="filter:drop-shadow(0 0 6px ' + c + ')">' + names[i] + '</text>';
  });
  rainbow.innerHTML = html;
  rainbow.setAttribute('opacity', '1');
  speak('ÏôÄ! ÎπõÏù¥ ÌîÑÎ¶¨Ï¶òÏùÑ ÌÜµÍ≥ºÌïòÎ©¥ Î¨¥ÏßÄÍ∞ú 7Í∞ÄÏßÄ ÏÉâÏúºÎ°ú ÎÇòÎâòÏñ¥Ïöî!');
  document.getElementById('light-info').textContent = 'ÎπõÏùÄ ÌîÑÎ¶¨Ï¶òÏùÑ ÌÜµÍ≥ºÌïòÎ©¥ 7Í∞ÄÏßÄ ÏÉâÏúºÎ°ú ÎÇòÎâòÏñ¥Ïöî!';

  SFX.prism(); SFX.correct(); setMascotEmotion('mascot-lt-mouth','bubble-lt','happy');
  updateLightUI();
  updateProfile();
  saveStats();
  setTimeout(() => {
    lt.prismActive = false;
    document.getElementById('light-info').innerHTML = '<span style="color:#fbbf24">&#9757;</span> Îã§Ïãú ÌîÑÎ¶¨Ï¶òÏùÑ ÌÑ∞ÏπòÌï¥Î≥¥ÏÑ∏Ïöî!';
  }, 2000);
}

function initColorMix(canvas) {
  document.getElementById('light-info').textContent = 'ÏÉâ Í≥µ 2Í∞úÎ•º Ï∞®Î°ÄÎ°ú ÌÑ∞ÏπòÌï¥ÏÑú ÏÉà ÏÉâÏùÑ ÎßåÎì§Ïñ¥Ïöî!';
  const colors = [{name:'Îπ®Í∞ï',c:'#ef4444'},{name:'ÌååÎûë',c:'#3b82f6'},{name:'ÎÖ∏Îûë',c:'#eab308'},{name:'Ï¥àÎ°ù',c:'#22c55e'},{name:'Ìù∞ÏÉâ',c:'#ffffff'}];
  let html = '';
  /* ÏÉÅÎã® ÏïàÎÇ¥ ÎßêÌíçÏÑ† */
  html += '<div class="light-guide-bubble" style="position:absolute;top:16px;left:50%;transform:translateX(-50%);z-index:5">ÏÉâ Í≥µ 2Í∞úÎ•º Ï∞®Î°ÄÎ°ú ÌÑ∞ÏπòÌïòÏÑ∏Ïöî!</div>';
  colors.forEach((col, i) => {
    const x = 80 + i * 150;
    const txtColor = col.name === 'Ìù∞ÏÉâ' ? '#1e293b' : '#fff';
    html += '<div class="color-orb" style="left:' + x + 'px;top:160px;background:' + col.c + ';--glow:' + col.c + ';display:flex;align-items:center;justify-content:center" onclick="pickColor(\'' + col.name + '\',\'' + col.c + '\',this)" data-color="' + col.name + '"><span style="font-size:26px;font-weight:800;color:' + txtColor + ';pointer-events:none;text-shadow:0 2px 4px rgba(0,0,0,.3)">' + col.name + '</span></div>';
  });
  html += '<div id="mix-result-zone" style="position:absolute;left:50%;top:360px;transform:translateX(-50%);width:160px;height:160px;border-radius:50%;border:4px dashed rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;font-size:28px;color:rgba(255,255,255,.5);font-weight:800;transition:.3s">Í≤∞Í≥º</div>';
  canvas.innerHTML = html;
}

function pickColor(name, color, el) {
  if (lt.selectedColors.length >= 2) return;
  el.style.boxShadow = '0 0 30px ' + color + ', 0 0 60px ' + color;
  el.style.transform = 'scale(1.15)';
  /* Ï≤¥ÌÅ¨ÎßàÌÅ¨ ÌëúÏãú */
  const chk = document.createElement('div');
  chk.className = 'light-orb-check';
  chk.innerHTML = '<svg width="48" height="48" viewBox="0 0 48 48"><circle cx="24" cy="24" r="22" fill="rgba(34,197,94,.7)" stroke="#fff" stroke-width="3"/><path d="M14,24 L22,32 L34,16" fill="none" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  el.style.position = 'absolute';
  el.appendChild(chk);
  lt.selectedColors.push({name, color});

  if (lt.selectedColors.length === 2) {
    const a = lt.selectedColors[0].name, b = lt.selectedColors[1].name;
    const recipe = COLOR_MIXES.find(r => (r.a===a && r.b===b) || (r.a===b && r.b===a));
    lt.mixes++;
    profile.totalPlayed++;

    const zone = document.getElementById('mix-result-zone');
    if (recipe) {
      lt.score += 10;
      profile.totalCorrect++;
      zone.style.background = recipe.rc;
      zone.style.border = '4px solid ' + recipe.rc;
      zone.style.boxShadow = '0 0 40px ' + recipe.rc;
      zone.style.color = '#fff';
      zone.textContent = recipe.result + '!';
      colorMixBurstEffect(canvas, recipe.rc);
      SFX.correct(); setMascotEmotion('mascot-lt-mouth','bubble-lt','happy');
      playSuccessSound();
      speak(a + 'Í≥º ' + b + 'ÏùÑ ÏÑûÏúºÎ©¥ ' + recipe.result + 'Ïù¥ ÎèºÏöî!');
      document.getElementById('light-info').textContent = a + ' + ' + b + ' = ' + recipe.result + '!';
    } else {
      zone.style.background = 'rgba(100,100,100,.5)';
      zone.style.color = '#fff';
      zone.textContent = 'Ïñ¥ÎëëÏñ¥Îëë';
      SFX.wrong(); setMascotEmotion('mascot-lt-mouth','bubble-lt','worried');
      speak('Ïù¥ Ï°∞Ìï©ÏùÄ Ï¢Ä Ïñ¥ÎëêÏö¥ ÏÉâÏù¥ ÎêòÎÑ§Ïöî');
      document.getElementById('light-info').textContent = 'Î™®Îì† ÏÉâÏùÑ ÏÑûÏúºÎ©¥ Ïñ¥ÎëêÏõåÏ†∏Ïöî';
    }
    updateLightUI();
    updateProfile();
    saveStats();
    setTimeout(() => {
      lt.selectedColors = [];
      initColorMix(document.getElementById('light-canvas'));
    }, 2500);
  }
}

function initShadow(canvas) {
  document.getElementById('light-info').innerHTML = '<span style="color:#fbbf24">&#9757;</span> ÏÜêÏ†ÑÎì±ÏùÑ ÎìúÎûòÍ∑∏Ìï¥ÏÑú ÏõÄÏßÅÏó¨Î≥¥ÏÑ∏Ïöî!';
  canvas.innerHTML =
    '<svg width="100%" height="100%" viewBox="0 0 800 500" style="position:absolute;inset:0">' +
    '<defs><radialGradient id="flashG" cx=".5" cy=".5" r=".5"><stop offset="0%" stop-color="#fbbf24"/><stop offset="60%" stop-color="#f59e0b" stop-opacity=".4"/><stop offset="100%" stop-color="#f59e0b" stop-opacity="0"/></radialGradient></defs>' +
    /* ÏÜêÏ†ÑÎì± Í∏ÄÎ°úÏö∞ */
    '<circle id="sh-glow" cx="120" cy="250" r="80" fill="url(#flashG)" opacity=".5"/>' +
    /* ÏÜêÏ†ÑÎì± Î≥∏Ï≤¥ (Îçî ÌÅ¨Í≤å) */
    '<circle id="sh-light" cx="120" cy="250" r="50" fill="#fbbf24" opacity=".9" style="cursor:grab;filter:drop-shadow(0 0 40px #fbbf24)"/>' +
    '<circle cx="120" cy="250" r="50" fill="none" stroke="#f59e0b" stroke-width="2.5" style="pointer-events:none"/>' +
    /* ÏÜêÏ†ÑÎì± ÏïÑÏù¥ÏΩò */
    '<g id="sh-light-icon" style="pointer-events:none"><text x="120" y="258" text-anchor="middle" font-size="36" fill="#78350f">&#128294;</text></g>' +
    /* ÎìúÎûòÍ∑∏ ÌôîÏÇ¥Ìëú ÌûåÌä∏ */
    '<g id="sh-drag-hint" style="pointer-events:none">' +
    '<text x="120" y="316" text-anchor="middle" font-size="20" font-weight="800" fill="#fbbf24" opacity=".8">&#8592; &#8594; \ub4dc\ub798\uadf8!</text>' +
    '</g>' +
    /* Îπî ÎùºÏù∏ */
    '<line id="sh-beam1" x1="170" y1="238" x2="400" y2="170" stroke="#fbbf24" stroke-width="2.5" opacity=".3"/>' +
    '<line id="sh-beam2" x1="170" y1="262" x2="400" y2="330" stroke="#fbbf24" stroke-width="2.5" opacity=".3"/>' +
    /* Ïò§Î∏åÏ†ùÌä∏ (Ïßë - Îçî ÌÅ¨Í≤å) */
    '<g id="sh-object-g">' +
    '<rect id="sh-object" x="380" y="170" width="80" height="130" rx="8" fill="#64748b" stroke="#94a3b8" stroke-width="3"/>' +
    /* Ïßë ÏßÄÎ∂ï */
    '<polygon points="370,175 420,130 470,175" fill="#475569" stroke="#94a3b8" stroke-width="2"/>' +
    /* Ïßë Ï∞ΩÎ¨∏ */
    '<rect x="396" y="195" width="20" height="20" rx="3" fill="#BFDBFE" stroke="#93C5FD" stroke-width="1.5"/>' +
    '<line x1="406" y1="195" x2="406" y2="215" stroke="#93C5FD" stroke-width="1"/>' +
    '<line x1="396" y1="205" x2="416" y2="205" stroke="#93C5FD" stroke-width="1"/>' +
    /* Ïßë Î¨∏ */
    '<rect x="400" y="255" width="18" height="28" rx="2" fill="#A0522D"/>' +
    '<circle cx="414" cy="270" r="2" fill="#D97706"/>' +
    '</g>' +
    /* Í∑∏Î¶ºÏûê (Îçî Í∑πÏ†Å Î≤îÏúÑ) */
    '<rect id="sh-shadow" x="470" y="150" width="100" height="180" rx="6" fill="rgba(0,0,0,.5)" style="transition:all .3s"/>' +
    /* Í±∞Î¶¨ ÏïàÎÇ¥ ÎùºÎ≤® */
    '<g id="sh-dist-label" style="pointer-events:none">' +
    '<rect x="340" y="420" width="120" height="40" rx="10" fill="rgba(251,191,36,.9)"/>' +
    '<text id="sh-dist-text" x="400" y="446" text-anchor="middle" font-size="20" font-weight="800" fill="#78350f">\uac00\uae4c\uc774</text>' +
    '</g>' +
    '</svg>';

  const light = document.getElementById('sh-light');
  const lightGlow = document.getElementById('sh-glow');
  const lightIcon = document.getElementById('sh-light-icon');
  const dragHint = document.getElementById('sh-drag-hint');
  let dragging = false;
  let hasDragged = false;

  function updateShadow(lx) {
    const objX = 420;
    const dist = Math.max(objX - lx, 40);
    const scale = Math.max(0.4, 350 / dist);
    const sw = 80 * scale;
    const sh = 130 * scale;
    const shadow = document.getElementById('sh-shadow');
    shadow.setAttribute('x', 470);
    shadow.setAttribute('width', Math.min(sw, 300));
    shadow.setAttribute('height', Math.min(sh, 400));
    shadow.setAttribute('y', 330 - Math.min(sh, 400));
    shadow.setAttribute('opacity', Math.min(0.6, 0.3 + scale * 0.1));

    /* Îπî ÏóÖÎç∞Ïù¥Ìä∏ */
    document.getElementById('sh-beam1').setAttribute('x1', lx + 50);
    document.getElementById('sh-beam2').setAttribute('x1', lx + 50);
    document.getElementById('sh-beam1').setAttribute('y1', 240);
    document.getElementById('sh-beam2').setAttribute('y1', 262);

    /* Í∏ÄÎ°úÏö∞ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏ */
    lightGlow.setAttribute('cx', lx);

    /* Í±∞Î¶¨ ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏ */
    const distText = document.getElementById('sh-dist-text');
    if (dist < 150) {
      distText.textContent = '\uac00\uae4c\uc774! \u2192 \uadf8\ub9bc\uc790 \ud07c!';
      document.getElementById('light-info').textContent = '\uac00\uae4c\uc6b8\uc218\ub85d \uadf8\ub9bc\uc790\uac00 \ucee4\uc838\uc694! (\uadf8\ub9bc\uc790: ' + Math.round(scale*100) + '%)';
    } else if (dist > 250) {
      distText.textContent = '\uba40\ub9ac! \u2192 \uadf8\ub9bc\uc790 \uc791\uc544!';
      document.getElementById('light-info').textContent = '\uba40\uc218\ub85d \uadf8\ub9bc\uc790\uac00 \uc791\uc544\uc838\uc694! (\uadf8\ub9bc\uc790: ' + Math.round(scale*100) + '%)';
    } else {
      distText.textContent = '\uac70\ub9ac: ' + Math.round(scale*100) + '%';
      document.getElementById('light-info').textContent = '\uc190\uc804\ub4f1 \uac70\ub9ac\uc5d0 \ub530\ub77c \uadf8\ub9bc\uc790 \ud06c\uae30\uac00 \ubcc0\ud574\uc694! (\uadf8\ub9bc\uc790: ' + Math.round(scale*100) + '%)';
    }
  }

  const svgEl = canvas.querySelector('svg');
  svgEl.addEventListener('pointerdown', (e) => {
    const pt = svgEl.createSVGPoint();
    pt.x = e.clientX; pt.y = e.clientY;
    const svgPt = pt.matrixTransform(svgEl.getScreenCTM().inverse());
    if (Math.hypot(svgPt.x - parseFloat(light.getAttribute('cx')), svgPt.y - parseFloat(light.getAttribute('cy'))) < 70) {
      dragging = true;
      light.style.cursor = 'grabbing';
      if (!hasDragged) {
        hasDragged = true;
        if (dragHint) dragHint.style.opacity = '0';
      }
    }
  });
  svgEl.addEventListener('pointermove', (e) => {
    if (!dragging) return;
    const pt = svgEl.createSVGPoint();
    pt.x = e.clientX; pt.y = e.clientY;
    const svgPt = pt.matrixTransform(svgEl.getScreenCTM().inverse());
    const nx = Math.max(60, Math.min(360, svgPt.x));
    light.setAttribute('cx', nx);
    lightIcon.querySelector('text').setAttribute('x', nx);
    if (dragHint) {
      dragHint.querySelector('text').setAttribute('x', nx);
    }
    updateShadow(nx);
  });
  svgEl.addEventListener('pointerup', () => { dragging = false; light.style.cursor = 'grab'; });

  lt.mixes++;
  profile.totalPlayed++;
  profile.totalCorrect++;
  lt.score += 5;
  updateLightUI();
  updateProfile();
  saveStats();
}

function ltHint() {
  if (lt.mode === 'prism') speak('ÌîÑÎ¶¨Ï¶ò ÏÇºÍ∞ÅÌòïÏùÑ ÌÅ¥Î¶≠Ìï¥Î≥¥ÏÑ∏Ïöî!');
  else if (lt.mode === 'colormix') speak('ÏÉâ Í≥µ 2Í∞úÎ•º Ï∞®Î°ÄÎ°ú ÎàåÎü¨Î≥¥ÏÑ∏Ïöî!');
  else speak('ÏÜêÏ†ÑÎì±ÏùÑ ÎìúÎûòÍ∑∏Ìï¥ÏÑú ÏõÄÏßÅÏó¨Î≥¥ÏÑ∏Ïöî!');
}

function updateLightUI() {
  document.getElementById('lt-mixes').textContent = lt.mixes;
  document.getElementById('lt-score-side').textContent = lt.score;
}

// ===== RECORDS =====
function updateRecords() {
  const total = profile.totalPlayed;
  const correct = profile.totalCorrect;
  const rate = total > 0 ? Math.round(correct / total * 100) : 0;
  document.getElementById('r-total').textContent = total;
  document.getElementById('r-correct').textContent = correct;
  document.getElementById('r-rate').textContent = rate + '%';
  document.getElementById('rec-total').textContent = total;
  document.getElementById('rec-rate').textContent = rate + '%';
  document.getElementById('r-mix-disc').textContent = mix.discovered.size;
  document.getElementById('r-mix-tried').textContent = mix.tried;
  document.getElementById('r-mix-score').textContent = mix.score;
  document.getElementById('r-wt-correct').textContent = wt.correctCount;
  document.getElementById('r-wt-streak').textContent = wt.bestStreak;
  document.getElementById('r-wt-score').textContent = wt.score;
  document.getElementById('r-lt-mixes').textContent = lt.mixes;
  document.getElementById('r-lt-score').textContent = lt.score;
  document.getElementById('r-hero-best').textContent = hg.bestScore;
}

// ===== HERO GAME: Experiment Chain =====
const HERO_INGREDIENTS = [
  {name:'Î¨º',emoji:'üíß'},{name:'ÏãùÏ¥à',emoji:'ü´ó'},{name:'ÏÜåÎã§',emoji:'üßÇ'},
  {name:'Í∏∞Î¶Ñ',emoji:'üõ¢Ô∏è'},{name:'ÏÉâÏÜå',emoji:'üé®'},{name:'Î†àÎ™¨',emoji:'üçã'},
  {name:'ÏÜåÍ∏à',emoji:'üßÇ'},{name:'Ïö∞Ïú†',emoji:'ü•õ'}
];
const HERO_RECIPES = [
  {a:'ÏãùÏ¥à',b:'ÏÜåÎã§',result:'Í±∞Ìíà Ìè≠Î∞ú!',emoji:'ü´ß',color:'#a7f3d0'},
  {a:'Î¨º',b:'Í∏∞Î¶Ñ',result:'Ï∏µ Î∂ÑÎ¶¨!',emoji:'üîµ',color:'#93c5fd'},
  {a:'Ïö∞Ïú†',b:'ÏÉâÏÜå',result:'ÎßàÎ∏îÎßÅ!',emoji:'üåÄ',color:'#c4b5fd'},
  {a:'Î†àÎ™¨',b:'ÏÜåÎã§',result:'Í±∞Ìíà Î∞òÏùë!',emoji:'ü´ß',color:'#a7f3d0'},
  {a:'Î¨º',b:'ÏÉâÏÜå',result:'ÏÉâ Î≥ÄÌôî!',emoji:'üåà',color:'#ddd6fe'},
  {a:'Î¨º',b:'ÏÜåÍ∏à',result:'ÏÜåÍ∏àÎ¨º!',emoji:'ü´ß',color:'#ccfbf1'},
];

let hg = {
  score: 0, lives: 5, level: 1, running: false, paused: false,
  items: [], spawnTimer: null, animId: null, combo: 0, maxCombo: 0,
  bestScore: parseInt(LS.getItem('heroBest')) || 0,
  tubes: {a: null, b: null},
  currentRecipe: null,
  liquidLevelA: 0, liquidLevelB: 0
};

const HG_BACKGROUNDS = [
  'linear-gradient(180deg,#134e4a 0%,#0f766e 30%,#14b8a6 70%,#5eead4 100%)',
  'linear-gradient(180deg,#1e1b4b 0%,#312e81 30%,#4338ca 70%,#818cf8 100%)',
  'linear-gradient(180deg,#7c2d12 0%,#c2410c 40%,#fb923c 80%,#fed7aa 100%)',
  'linear-gradient(180deg,#0c4a6e 0%,#0284c7 30%,#38bdf8 70%,#bae6fd 100%)',
  'linear-gradient(180deg,#064e3b 0%,#047857 30%,#34d399 70%,#a7f3d0 100%)',
  'linear-gradient(180deg,#1e3a5f 0%,#2563eb 30%,#60a5fa 70%,#dbeafe 100%)',
  'linear-gradient(180deg,#581c87 0%,#7c3aed 30%,#a78bfa 70%,#ede9fe 100%)',
  'linear-gradient(180deg,#831843 0%,#db2777 30%,#f472b6 70%,#fce7f3 100%)',
];

function addHgDecorations() {
  const arena = document.getElementById('hg-arena');
  arena.querySelectorAll('.hg-deco,.hg-bg-sparkle,.hg-drip,.hg-ground-deco').forEach(e=>e.remove());

  const ground = arena.querySelector('.hg-ground');
  ground.innerHTML = '<svg width="100%" height="140" viewBox="0 0 1920 140" preserveAspectRatio="none"><rect width="1920" height="140" fill="#334155"/><g opacity=".2"><path d="M100,40 L100,100 Q100,130 120,130 L140,130 Q160,130 160,100 L160,40" fill="none" stroke="#5eead4" stroke-width="3"/><line x1="90" y1="40" x2="170" y2="40" stroke="#5eead4" stroke-width="3"/><path d="M400,60 L400,110 Q400,130 415,130 L435,130 Q450,130 450,110 L450,60" fill="none" stroke="#99f6e4" stroke-width="2"/><path d="M700,50 L720,120 L760,120 L780,50" fill="none" stroke="#2dd4bf" stroke-width="2"/><circle cx="1100" cy="100" r="25" fill="none" stroke="#5eead4" stroke-width="2"/><circle cx="1100" cy="100" r="15" fill="none" stroke="#5eead4" stroke-width="1"/><path d="M1400,45 L1400,110 Q1400,130 1420,130 L1450,130 Q1470,130 1470,110 L1470,45" fill="none" stroke="#99f6e4" stroke-width="2"/><line x1="1390" y1="45" x2="1480" y2="45" stroke="#99f6e4" stroke-width="3"/></g></svg>';

  const decoSVGs = [
    '<svg viewBox="0 0 40 40" width="45" height="45"><circle cx="20" cy="20" r="8" fill="none" stroke="#5eead4" stroke-width="2"/><circle cx="20" cy="20" r="3" fill="#14b8a6"/><ellipse cx="20" cy="20" rx="16" ry="6" fill="none" stroke="#5eead4" stroke-width="1.5" transform="rotate(45,20,20)"/></svg>',
    '<svg viewBox="0 0 40 40" width="40" height="40"><path d="M10,30 Q15,10 20,25 Q25,10 30,30 Q25,20 20,30 Q15,20 10,30" fill="none" stroke="#22d3ee" stroke-width="2"/></svg>',
    '<svg viewBox="0 0 40 40" width="42" height="42"><path d="M15,5 L15,25 L8,38 L32,38 L25,25 L25,5" fill="rgba(94,234,212,.3)" stroke="#14b8a6" stroke-width="2"/><line x1="12" y1="5" x2="28" y2="5" stroke="#14b8a6" stroke-width="2.5"/></svg>',
    '<svg viewBox="0 0 40 40" width="38" height="38"><circle cx="28" cy="22" r="12" fill="none" stroke="#f59e0b" stroke-width="2"/><line x1="8" y1="32" x2="19" y2="28" stroke="#f59e0b" stroke-width="3"/></svg>',
    '<svg viewBox="0 0 40 40" width="40" height="40"><rect x="15" y="5" width="10" height="20" rx="5" fill="#94a3b8"/><rect x="12" y="25" width="16" height="4" rx="2" fill="#64748b"/><rect x="8" y="29" width="24" height="3" rx="1" fill="#475569"/><line x1="20" y1="32" x2="20" y2="38" stroke="#475569" stroke-width="3"/><rect x="12" y="36" width="16" height="4" rx="2" fill="#475569"/></svg>',
    '<svg viewBox="0 0 40 40" width="36" height="36"><text x="20" y="28" text-anchor="middle" font-size="20" font-weight="900" fill="#5eead4" font-family="serif">H\u2082O</text></svg>',
    '<svg viewBox="0 0 40 40" width="38" height="38"><path d="M20,5 L20,15 M15,15 L25,15 L25,20 Q25,35 20,35 Q15,35 15,20 Z" fill="#fbbf24" stroke="#f59e0b" stroke-width="1.5"/><path d="M13,12 Q20,0 27,12" fill="none" stroke="#fbbf24" stroke-width="2"/></svg>',
    '<svg viewBox="0 0 40 40" width="36" height="36"><circle cx="20" cy="20" r="12" fill="none" stroke="#94a3b8" stroke-width="2"/><path d="M20,8 L22,17 L20,15 L18,17 Z" fill="#94a3b8"/><rect x="14" y="14" width="12" height="12" rx="2" fill="none" stroke="#94a3b8" stroke-width="1.5" transform="rotate(45,20,20)"/></svg>',
    '<svg viewBox="0 0 40 40" width="34" height="34"><polygon points="20,4 23,16 36,16 26,24 29,36 20,28 11,36 14,24 4,16 17,16" fill="#fbbf24" opacity=".7"/></svg>',
    '<svg viewBox="0 0 40 40" width="38" height="38"><circle cx="14" cy="20" r="6" fill="#ef4444" opacity=".6"/><circle cx="26" cy="20" r="6" fill="#3b82f6" opacity=".6"/><circle cx="20" cy="12" r="6" fill="#22c55e" opacity=".6"/><line x1="14" y1="20" x2="26" y2="20" stroke="#475569" stroke-width="1.5"/><line x1="14" y1="20" x2="20" y2="12" stroke="#475569" stroke-width="1.5"/><line x1="26" y1="20" x2="20" y2="12" stroke="#475569" stroke-width="1.5"/></svg>'
  ];

  for(let i=0;i<10;i++){
    const d=document.createElement('div');
    d.className='hg-deco';
    d.style.cssText='position:absolute;z-index:2;pointer-events:none;opacity:.25;left:'+((i*180)+Math.random()*100)+'px;top:'+(80+Math.random()*500)+'px;animation-delay:'+(i*0.6)+'s;animation-duration:'+(5+Math.random()*4)+'s';
    d.innerHTML=decoSVGs[i];
    arena.appendChild(d);
  }

  for(let i=0;i<12;i++){
    const s=document.createElement('div');
    s.className='hg-bg-sparkle';
    const sz=4+Math.random()*6;
    s.style.cssText='left:'+(Math.random()*95)+'%;top:'+(Math.random()*80)+'%;width:'+sz+'px;height:'+sz+'px;background:#5eead4;border-radius:50%;animation-delay:'+(Math.random()*3)+'s;animation-duration:'+(2+Math.random()*2)+'s';
    arena.appendChild(s);
  }

  const dripColors=['#14b8a6','#2dd4bf','#5eead4','#22d3ee','#0ea5e9','#99f6e4'];
  for(let i=0;i<6;i++){
    const dr=document.createElement('div');
    dr.className='hg-drip';
    dr.style.cssText='left:'+(10+i*16)+'%;animation-delay:'+(Math.random()*4)+'s;animation-duration:'+(3+Math.random()*3)+'s';
    dr.innerHTML='<svg width="12" height="30" viewBox="0 0 12 30"><ellipse cx="6" cy="6" rx="5" ry="6" fill="'+dripColors[i]+'" opacity=".5"/><rect x="4" y="6" width="4" height="20" rx="2" fill="'+dripColors[i]+'" opacity=".3"/></svg>';
    arena.appendChild(dr);
  }
}

function startHeroGame() {
  try{document.documentElement.requestFullscreen?.()}catch(e){}
  hg.score = 0; hg.lives = 5; hg.level = 1; hg.combo = 0; hg.maxCombo = 0;
  hg.running = false; hg.paused = false;
  hg.items = [];
  hg.tubes = {a: null, b: null};
  hg.liquidLevelA = 0; hg.liquidLevelB = 0;
  const heroEl = document.getElementById('hero-game');
  heroEl.classList.remove('hidden');
  heroEl.style.background = HG_BACKGROUNDS[0];
  document.getElementById('hg-over').classList.add('hidden');
  document.getElementById('hg-pause').classList.add('hidden');
  updateHeroUI();
  hg.shielded = false;
  hg.slowMode = false;
  hg.doublePoints = false;
  pickHeroRecipe();
  setupTubes();
  addHgDecorations();
  addLabShelf();
  addSmokeWisps();

  /* ÌäúÌÜ†Î¶¨Ïñº ÌëúÏãú ‚Äî 3 simple steps */
  const arena = document.getElementById('hg-arena');
  const tut = document.createElement('div');
  tut.className = 'hg-tutorial';
  const recipe = hg.currentRecipe;
  const aSvg = recipe ? (INGREDIENT_SVG[recipe.a]||'') : '';
  const bSvg = recipe ? (INGREDIENT_SVG[recipe.b]||'') : '';
  tut.innerHTML =
    '<div style="font-size:44px;font-weight:900;color:#fbbf24;text-shadow:0 4px 12px rgba(0,0,0,.5);margin-bottom:24px;text-align:center">Ïã§Ìóò Ï≤¥Ïù∏!</div>' +
    '<div class="hg-tut-step"><div class="hg-tut-icon"><svg viewBox="0 0 70 70" width="70" height="70"><circle cx="35" cy="35" r="30" fill="rgba(239,68,68,.3)" stroke="#ef4444" stroke-width="3"/><text x="35" y="44" text-anchor="middle" font-size="28" font-weight="900" fill="#fff">1</text></svg></div><div class="hg-tut-text" style="font-size:30px"><span style="color:#ef4444">Îπ®Í∞Ñ ÌÖåÎëêÎ¶¨</span> Ïû¨Î£å ÌÑ∞Ïπò ‚Üí Îπ®Í∞Ñ ÏãúÌóòÍ¥ÄÏúºÎ°ú!</div></div>' +
    '<div class="hg-tut-step"><div class="hg-tut-icon"><svg viewBox="0 0 70 70" width="70" height="70"><circle cx="35" cy="35" r="30" fill="rgba(59,130,246,.3)" stroke="#3b82f6" stroke-width="3"/><text x="35" y="44" text-anchor="middle" font-size="28" font-weight="900" fill="#fff">2</text></svg></div><div class="hg-tut-text" style="font-size:30px"><span style="color:#3b82f6">ÌååÎûÄ ÌÖåÎëêÎ¶¨</span> Ïû¨Î£å ÌÑ∞Ïπò ‚Üí ÌååÎûÄ ÏãúÌóòÍ¥ÄÏúºÎ°ú!</div></div>' +
    '<div class="hg-tut-step"><div class="hg-tut-icon"><svg viewBox="0 0 70 70" width="70" height="70"><circle cx="35" cy="35" r="30" fill="rgba(107,114,128,.3)" stroke="#6b7280" stroke-width="3"/><text x="35" y="44" text-anchor="middle" font-size="28" font-weight="900" fill="#fff">3</text></svg></div><div class="hg-tut-text" style="font-size:30px"><span style="color:#9ca3af">ÌöåÏÉâ ÌÖåÎëêÎ¶¨</span>Îäî Ï†àÎåÄ ÌÑ∞Ïπò Í∏àÏßÄ!</div></div>' +
    '<div style="margin-top:20px;padding:16px 30px;background:rgba(255,255,255,.15);border-radius:16px;border:2px solid rgba(255,255,255,.3);font-size:32px;font-weight:800;color:#a7f3d0;text-align:center">' +
    '<span style="display:inline-block;width:50px;height:50px;vertical-align:middle">' + aSvg + '</span> <span style="color:#ef4444">' + (recipe?recipe.a:'?') + '</span> + ' +
    '<span style="display:inline-block;width:50px;height:50px;vertical-align:middle">' + bSvg + '</span> <span style="color:#3b82f6">' + (recipe?recipe.b:'?') + '</span> = ' +
    (recipe?recipe.emoji:'') + ' ' + (recipe?recipe.result:'?') + '</div>';
  arena.appendChild(tut);

  /* 3Ï¥à ÌõÑ ÌäúÌÜ†Î¶¨Ïñº Ï†úÍ±∞ ‚Üí Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ‚Üí Í≤åÏûÑ ÏãúÏûë */
  setTimeout(() => {
    tut.remove();
    let count = 3;
    const cd = document.createElement('div');
    cd.className = 'hg-countdown';
    cd.textContent = count;
    arena.appendChild(cd);
    SFX.gameStart();
    const cdInterval = setInterval(() => {
      count--;
      if (count > 0) {
        cd.textContent = count;
      } else {
        cd.textContent = 'GO!';
        clearInterval(cdInterval);
        setTimeout(() => {
          cd.remove();
          hg.running = true;
          showRecipeHint();
          hgSpawnLoop();
          hgGameLoop();
          speak('Ïã§Ìóò Ï≤¥Ïù∏ ÏãúÏûë!');
        }, 500);
      }
    }, 800);
  }, 3000);
}

function setupTubes() {
  const arena = document.getElementById('hg-arena');
  // Í∏∞Ï°¥ ÏöîÏÜå Ï†úÍ±∞
  arena.querySelectorAll('.hg-tube-glass,.hg-tube-nameplate,.tube-glow-ring,.tube-bubble').forEach(t => t.remove());
  hg.tubes = {a: null, b: null};
  hg.liquidLevelA = 0; hg.liquidLevelB = 0;

  const recipe = hg.currentRecipe;
  const tubeColors = [{id:'a', color:'#ef4444', name:recipe?recipe.a:'Ïû¨Î£åA', pos:'left', lightColor:'rgba(239,68,68,.4)'},
                      {id:'b', color:'#3b82f6', name:recipe?recipe.b:'Ïû¨Î£åB', pos:'right', lightColor:'rgba(59,130,246,.4)'}];

  tubeColors.forEach(cfg => {
    /* Glow ring */
    const glow = document.createElement('div');
    glow.className = 'tube-glow-ring glow-' + cfg.id;
    glow.style.background = cfg.lightColor;
    arena.appendChild(glow);

    /* Tube glass SVG ‚Äî 250√ó400 gorgeous glass effect */
    const tubeEl = document.createElement('div');
    tubeEl.className = 'hg-tube-glass tube-' + cfg.id;
    tubeEl.id = 'hg-tube-' + cfg.id;

    const liquidId = 'tube-liq-' + cfg.id;
    const bubbleId = 'tube-bub-' + cfg.id;
    const corkId = 'tube-cork-' + cfg.id;
    tubeEl.innerHTML =
      '<svg width="250" height="400" viewBox="0 0 250 400" xmlns="http://www.w3.org/2000/svg">' +
      '<defs>' +
      '<linearGradient id="glass-' + cfg.id + '" x1="0" y1="0" x2="1" y2="0">' +
      '<stop offset="0%" stop-color="rgba(255,255,255,.12)"/>' +
      '<stop offset="30%" stop-color="rgba(255,255,255,.04)"/>' +
      '<stop offset="70%" stop-color="rgba(255,255,255,.02)"/>' +
      '<stop offset="100%" stop-color="rgba(255,255,255,.1)"/>' +
      '</linearGradient>' +
      '<linearGradient id="liqGrad-' + cfg.id + '" x1="0" y1="0" x2="0" y2="1">' +
      '<stop offset="0%" stop-color="' + cfg.color + '" stop-opacity=".6"/>' +
      '<stop offset="100%" stop-color="' + cfg.color + '" stop-opacity=".9"/>' +
      '</linearGradient>' +
      '<clipPath id="tubeClip-' + cfg.id + '"><path d="M40 30 L40 330 Q40 380 80 380 L170 380 Q210 380 210 330 L210 30 Z"/></clipPath>' +
      '</defs>' +
      /* Cork/stopper */
      '<g id="' + corkId + '">' +
      '<rect x="55" y="10" width="140" height="28" rx="6" fill="#A0522D"/>' +
      '<rect x="55" y="10" width="140" height="28" rx="6" fill="none" stroke="#6B3410" stroke-width="2"/>' +
      '<rect x="60" y="14" width="40" height="6" rx="3" fill="rgba(255,255,255,.2)"/>' +
      '</g>' +
      /* Glass body */
      '<path d="M40 30 L40 330 Q40 380 80 380 L170 380 Q210 380 210 330 L210 30" fill="url(#glass-' + cfg.id + ')" stroke="' + cfg.color + '" stroke-width="3.5" stroke-opacity=".6"/>' +
      /* Rim at top */
      '<rect x="30" y="26" width="190" height="8" rx="4" fill="' + cfg.color + '" opacity=".5"/>' +
      /* Glass reflection (left) */
      '<rect x="50" y="50" width="12" height="280" rx="6" fill="rgba(255,255,255,.12)"/>' +
      /* Glass reflection (right) */
      '<rect x="190" y="80" width="8" height="200" rx="4" fill="rgba(255,255,255,.06)"/>' +
      /* Liquid fill (height controlled by JS) */
      '<rect id="' + liquidId + '" class="tube-liquid-fill" x="40" y="380" width="170" height="0" fill="url(#liqGrad-' + cfg.id + ')" clip-path="url(#tubeClip-' + cfg.id + ')" rx="4"/>' +
      /* Measurement marks */
      '<line x1="42" y1="120" x2="65" y2="120" stroke="' + cfg.color + '" stroke-width="1.5" opacity=".3"/>' +
      '<line x1="42" y1="200" x2="65" y2="200" stroke="' + cfg.color + '" stroke-width="1.5" opacity=".3"/>' +
      '<line x1="42" y1="280" x2="65" y2="280" stroke="' + cfg.color + '" stroke-width="1.5" opacity=".3"/>' +
      /* Bubbles (always floating) */
      '<g id="' + bubbleId + '">' +
      '<circle cx="90" cy="350" r="5" fill="rgba(255,255,255,.25)"><animate attributeName="cy" values="350;80;350" dur="4s" repeatCount="indefinite"/><animate attributeName="opacity" values=".3;.6;.3" dur="4s" repeatCount="indefinite"/></circle>' +
      '<circle cx="140" cy="320" r="3.5" fill="rgba(255,255,255,.2)"><animate attributeName="cy" values="320;100;320" dur="5s" repeatCount="indefinite"/><animate attributeName="opacity" values=".2;.5;.2" dur="5s" repeatCount="indefinite"/></circle>' +
      '<circle cx="170" cy="360" r="4" fill="rgba(255,255,255,.22)"><animate attributeName="cy" values="360;120;360" dur="3.5s" repeatCount="indefinite"/><animate attributeName="opacity" values=".25;.55;.25" dur="3.5s" repeatCount="indefinite"/></circle>' +
      '<circle cx="110" cy="340" r="3" fill="rgba(255,255,255,.18)"><animate attributeName="cy" values="340;90;340" dur="4.5s" repeatCount="indefinite"/><animate attributeName="opacity" values=".2;.4;.2" dur="4.5s" repeatCount="indefinite"/></circle>' +
      '</g>' +
      /* Tube letter label inside */
      '<text x="125" y="370" text-anchor="middle" font-size="60" font-weight="900" fill="' + cfg.color + '" opacity=".2">' + cfg.id.toUpperCase() + '</text>' +
      '</svg>';
    arena.appendChild(tubeEl);

    /* Nameplate below tube */
    const plate = document.createElement('div');
    plate.className = 'hg-tube-nameplate plate-' + cfg.id;
    plate.id = 'hg-plate-' + cfg.id;
    const ingIcon = INGREDIENT_SVG[cfg.name] || '';
    plate.innerHTML = '<div class="hg-tube-nameplate-inner" style="border-color:' + cfg.color + '">' +
      (ingIcon ? ingIcon : '') +
      '<span style="color:' + cfg.color + '">' + cfg.name + '</span></div>';
    arena.appendChild(plate);
  });
}

function addLabShelf() {
  const arena = document.getElementById('hg-arena');
  arena.querySelectorAll('.hg-lab-shelf').forEach(e => e.remove());
  const shelf = document.createElement('div');
  shelf.className = 'hg-lab-shelf';
  shelf.innerHTML = '<svg width="1920" height="80" viewBox="0 0 1920 80" preserveAspectRatio="none">' +
    '<rect x="0" y="60" width="1920" height="20" fill="#475569" rx="4"/>' +
    /* beakers on shelf */
    '<g opacity=".6">' +
    '<path d="M100,20 L100,55 Q100,60 105,60 L130,60 Q135,60 135,55 L135,20" fill="rgba(255,255,255,.1)" stroke="#5eead4" stroke-width="2"/><line x1="95" y1="20" x2="140" y2="20" stroke="#5eead4" stroke-width="2"/>' +
    '<path d="M300,30 L300,55 Q300,60 305,60 L325,60 Q330,60 330,55 L330,30" fill="rgba(255,255,255,.08)" stroke="#99f6e4" stroke-width="1.5"/><ellipse cx="315" cy="52" rx="8" ry="4" fill="#14b8a6" opacity=".4"/>' +
    '<rect x="500" y="25" width="35" height="35" rx="4" fill="rgba(59,130,246,.15)" stroke="#3b82f6" stroke-width="1.5"/><text x="517" y="48" text-anchor="middle" font-size="14" fill="#3b82f6" opacity=".6">H‚ÇÇO</text>' +
    '<path d="M750,15 L770,55 L810,55 L830,15" fill="rgba(239,68,68,.1)" stroke="#ef4444" stroke-width="1.5"/><line x1="745" y1="15" x2="835" y2="15" stroke="#ef4444" stroke-width="2"/>' +
    '<circle cx="1050" cy="40" r="18" fill="none" stroke="#fbbf24" stroke-width="1.5"/><line x1="1030" y1="55" x2="1020" y2="65" stroke="#fbbf24" stroke-width="2"/>' +
    '<rect x="1300" y="20" width="50" height="40" rx="3" fill="rgba(139,92,246,.1)" stroke="#8b5cf6" stroke-width="1.5"/><text x="1325" y="45" text-anchor="middle" font-size="10" fill="#8b5cf6">NaCl</text>' +
    '<path d="M1550,25 L1550,55 Q1560,60 1570,55 L1570,25" fill="rgba(34,197,94,.1)" stroke="#22c55e" stroke-width="1.5"/><rect x="1545" y="20" width="30" height="8" rx="3" fill="#22c55e" opacity=".3"/>' +
    '<path d="M1750,30 L1740,55 Q1740,60 1745,60 L1775,60 Q1780,60 1780,55 L1770,30" fill="rgba(251,191,36,.1)" stroke="#fbbf24" stroke-width="1.5"/><line x1="1738" y1="30" x2="1782" y2="30" stroke="#fbbf24" stroke-width="2"/>' +
    '</g></svg>';
  arena.appendChild(shelf);
}

function addSmokeWisps() {
  const arena = document.getElementById('hg-arena');
  arena.querySelectorAll('.hg-smoke').forEach(e => e.remove());
  for (let i = 0; i < 5; i++) {
    const smoke = document.createElement('div');
    smoke.className = 'hg-smoke';
    const x = 10 + i * 20;
    smoke.style.cssText = 'left:' + x + '%;--dx:' + (20+Math.random()*40) + 'px;--dur:' + (6+Math.random()*6) + 's;animation-delay:' + (Math.random()*4) + 's';
    smoke.innerHTML = '<svg width="120" height="60" viewBox="0 0 120 60"><ellipse cx="60" cy="30" rx="50" ry="20" fill="rgba(255,255,255,.08)"/><ellipse cx="40" cy="35" rx="30" ry="15" fill="rgba(255,255,255,.05)"/></svg>';
    arena.appendChild(smoke);
  }
}

function pickHeroRecipe() {
  hg.currentRecipe = HERO_RECIPES[Math.floor(Math.random() * HERO_RECIPES.length)];
}

function hgSpawnLoop() {
  if (!hg.running) return;
  const delay = Math.max(800, 2000 - hg.level * 150);
  hg.spawnTimer = setTimeout(() => {
    if (!hg.paused && hg.running) spawnHeroItem();
    hgSpawnLoop();
  }, delay);
}

function spawnHeroItem() {
  spawnPowerup(); // 15% ÌôïÎ•†Î°ú ÌååÏõåÏóÖ Ï∂îÍ∞Ä
  const arena = document.getElementById('hg-arena');
  const arenaW = 1920; // fixed layout
  // ÌòÑÏû¨ Î†àÏãúÌîºÏùò Ïû¨Î£åÎ•º ÎÜíÏùÄ ÌôïÎ•†Î°ú
  let ing;
  const rng = Math.random();
  if (rng < 0.3 && hg.currentRecipe) {
    ing = HERO_INGREDIENTS.find(i => i.name === hg.currentRecipe.a);
  } else if (rng < 0.6 && hg.currentRecipe) {
    ing = HERO_INGREDIENTS.find(i => i.name === hg.currentRecipe.b);
  }
  if (!ing) ing = HERO_INGREDIENTS[Math.floor(Math.random() * HERO_INGREDIENTS.length)];

  /* Determine color type: red (recipe.a), blue (recipe.b), or grey (other) */
  let borderClass = 'border-grey';
  let itemType = 'grey';
  if (hg.currentRecipe && ing.name === hg.currentRecipe.a) { borderClass = 'border-red'; itemType = 'a'; }
  else if (hg.currentRecipe && ing.name === hg.currentRecipe.b) { borderClass = 'border-blue'; itemType = 'b'; }

  const el = document.createElement('div');
  el.className = 'falling-item';
  el.style.pointerEvents = 'auto';
  el.style.cursor = 'pointer';
  const x = 100 + Math.random() * (arenaW - 300);
  el.style.left = x + 'px';
  el.style.top = '-130px';

  el.innerHTML = '<div class="falling-spin"><div class="fi-body ' + borderClass + '">' + (INGREDIENT_SVG[ing.name]||ing.emoji) + '</div></div>' +
    '<div style="text-align:center;font-size:24px;font-weight:800;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.8);margin-top:4px">' + ing.name + '</div>';
  el.dataset.name = ing.name;
  el.dataset.type = itemType;
  arena.appendChild(el);

  const item = { el, name: ing.name, type: itemType, x, y: -130, speed: 1.5 + hg.level * 0.3 };
  hg.items.push(item);

  /* Tap handler ‚Äî auto-route to correct tube or penalize */
  el.addEventListener('pointerdown', (e) => {
    e.stopPropagation();
    if (!hg.running || hg.paused) return;

    if (itemType === 'grey') {
      /* Wrong! Grey ingredient tapped */
      if (hg.shielded) {
        hg.shielded = false;
        speak('ÏïàÏ†ÑÍ≥†Í∏ÄÏù¥ ÎßâÏïÑÏ§¨Ïñ¥Ïöî!');
        item.el.remove();
        hg.items = hg.items.filter(i => i !== item);
        updateHeroUI();
        return;
      }
      hg.lives--;
      hg.combo = 0;
      SFX.wrong();
      playFailSound();
      /* Red X flash + shake */
      el.querySelector('.fi-body').classList.add('ingredient-wrong');
      const xMark = document.createElement('div');
      xMark.style.cssText = 'position:absolute;top:20px;left:50%;transform:translateX(-50%);z-index:20;pointer-events:none';
      xMark.innerHTML = '<svg width="80" height="80" viewBox="0 0 80 80"><circle cx="40" cy="40" r="35" fill="rgba(239,68,68,.8)" stroke="#fff" stroke-width="3"/><line x1="25" y1="25" x2="55" y2="55" stroke="#fff" stroke-width="5" stroke-linecap="round"/><line x1="55" y1="25" x2="25" y2="55" stroke="#fff" stroke-width="5" stroke-linecap="round"/></svg>';
      el.appendChild(xMark);
      hgFailEffect();
      speak('ÏïÑ! Ïù¥Í±¥ ÌïÑÏöîÏóÜÎäî Ïû¨Î£åÏïº!');
      setTimeout(() => {
        item.el.remove();
        hg.items = hg.items.filter(i => i !== item);
      }, 500);
      if (hg.lives <= 0) { hgGameOver(); return; }
      updateHeroUI();
      return;
    }

    /* Correct ingredient tapped ‚Äî fly to correct tube */
    const tubeId = itemType; // 'a' or 'b'
    const tubeEl = document.getElementById('hg-tube-' + tubeId);
    if (!tubeEl) return;

    /* Calculate target position for fly animation */
    const tubeRect = tubeEl.getBoundingClientRect();
    const arenaRect = arena.getBoundingClientRect();
    const scaleRatio = arenaRect.width / 1920;
    const tubeCx = (tubeRect.left - arenaRect.left) / scaleRatio + tubeRect.width / scaleRatio / 2;
    const tubeCy = (tubeRect.top - arenaRect.top) / scaleRatio + tubeRect.height / scaleRatio / 2;
    const itemCx = item.x + 60;
    const itemCy = item.y + 60;
    const dx = tubeCx - itemCx;
    const dy = tubeCy - itemCy;

    /* Animate fly */
    el.classList.add('ingredient-fly');
    el.style.transition = 'left 0.5s cubic-bezier(.2,.8,.3,1), top 0.5s cubic-bezier(.2,.8,.3,1), transform 0.5s cubic-bezier(.2,.8,.3,1), opacity 0.4s ease-out 0.3s';
    el.style.left = (item.x + dx) + 'px';
    el.style.top = (item.y + dy) + 'px';
    el.style.transform = 'scale(0.3)';
    el.style.opacity = '0';
    el.style.pointerEvents = 'none';

    SFX.bubble();

    setTimeout(() => {
      item.el.remove();
      hg.items = hg.items.filter(i => i !== item);

      /* Fill tube */
      hg.tubes[tubeId] = item.name;
      if (tubeId === 'a') hg.liquidLevelA = 180;
      else hg.liquidLevelB = 180;
      updateTubeLiquid(tubeId);

      /* Splash effect on tube */
      tubeSplashEffect(tubeId);

      /* Check if both tubes are full ‚Üí reaction! */
      checkReaction();
    }, 450);
  });
}

function updateTubeLiquid(tubeId) {
  const liq = document.getElementById('tube-liq-' + tubeId);
  if (!liq) return;
  const level = tubeId === 'a' ? hg.liquidLevelA : hg.liquidLevelB;
  liq.setAttribute('height', level);
  liq.setAttribute('y', 380 - level);
  liq.classList.add('slosh');
  setTimeout(() => liq.classList.remove('slosh'), 800);
}

function tubeSplashEffect(tubeId) {
  const tubeEl = document.getElementById('hg-tube-' + tubeId);
  if (!tubeEl) return;
  tubeEl.classList.add('tube-splash');
  setTimeout(() => tubeEl.classList.remove('tube-splash'), 600);

  /* Splash particles above tube */
  const arena = document.getElementById('hg-arena');
  const tubeRect = tubeEl.getBoundingClientRect();
  const arenaRect = arena.getBoundingClientRect();
  const scaleRatio = arenaRect.width / 1920;
  const cx = (tubeRect.left - arenaRect.left) / scaleRatio + tubeRect.width / scaleRatio / 2;
  const cy = (tubeRect.top - arenaRect.top) / scaleRatio + 60;
  const color = tubeId === 'a' ? '#ef4444' : '#3b82f6';

  for (let i = 0; i < 8; i++) {
    const p = document.createElement('div');
    p.className = 'hg-particle';
    const angle = Math.PI + (Math.random() - 0.5) * Math.PI;
    const dist = 30 + Math.random() * 60;
    const size = 6 + Math.random() * 10;
    p.style.cssText = 'left:' + cx + 'px;top:' + cy + 'px;width:' + size + 'px;height:' + size + 'px;background:' + color + ';--tx:' + (Math.cos(angle)*dist) + 'px;--ty:' + (Math.sin(angle)*dist) + 'px;--dur:' + (0.4+Math.random()*0.3) + 's';
    arena.appendChild(p);
    setTimeout(() => p.remove(), 700);
  }
}

function checkReaction() {
  if (hg.tubes.a === null || hg.tubes.b === null) return;

  const arena = document.getElementById('hg-arena');
  const recipe = hg.currentRecipe;
  if (!recipe) return;

  /* Both tubes filled ‚Äî EPIC REACTION! */
  hg.combo++;
  if (hg.combo > hg.maxCombo) hg.maxCombo = hg.combo;
  let pts = 20 + hg.combo * 5;
  /* Combo bonus */
  if (hg.combo >= 3) pts += 3;
  if (hg.combo >= 5) pts += 5;
  if (hg.doublePoints) pts *= 2;
  hg.score += pts;

  SFX.correct(); SFX.mix();
  if (hg.combo >= 3) SFX.combo(hg.combo);
  playSuccessSound();

  /* === EPIC REACTION SEQUENCE === */

  /* Step 1: Cork pop animation */
  const corkA = document.getElementById('tube-cork-a');
  const corkB = document.getElementById('tube-cork-b');
  if (corkA) corkA.classList.add('cork-pop');
  if (corkB) corkB.classList.add('cork-pop');

  /* Step 2: Screen flash */
  setTimeout(() => {
    const flash = document.createElement('div');
    flash.className = 'hg-flash-white';
    arena.appendChild(flash);
    setTimeout(() => flash.remove(), 400);
  }, 300);

  /* Step 3: Central beaker appears with reaction */
  setTimeout(() => {
    const beaker = document.createElement('div');
    beaker.className = 'reaction-beaker';
    beaker.innerHTML = '<svg width="200" height="280" viewBox="0 0 200 280">' +
      '<defs><linearGradient id="rxBeaker" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="' + recipe.color + '" stop-opacity=".4"/><stop offset="100%" stop-color="' + recipe.color + '" stop-opacity=".9"/></linearGradient></defs>' +
      '<path d="M50 10 L50 180 Q50 260 100 260 Q150 260 150 180 L150 10" fill="rgba(255,255,255,.1)" stroke="#fff" stroke-width="3"/>' +
      '<line x1="40" y1="10" x2="160" y2="10" stroke="#fff" stroke-width="4" stroke-linecap="round"/>' +
      '<rect x="50" y="100" width="100" height="155" rx="20" fill="url(#rxBeaker)" clip-path="inset(0)"/>' +
      '<ellipse cx="100" cy="100" rx="45" ry="8" fill="' + recipe.color + '" opacity=".6"><animate attributeName="ry" values="8;12;8" dur="0.5s" repeatCount="indefinite"/></ellipse>' +
      /* Bubbles inside beaker */
      '<circle cx="80" cy="200" r="6" fill="rgba(255,255,255,.4)"><animate attributeName="cy" values="200;120;200" dur="1s" repeatCount="indefinite"/></circle>' +
      '<circle cx="120" cy="180" r="4" fill="rgba(255,255,255,.3)"><animate attributeName="cy" values="180;110;180" dur="1.2s" repeatCount="indefinite"/></circle>' +
      '<circle cx="100" cy="220" r="5" fill="rgba(255,255,255,.35)"><animate attributeName="cy" values="220;130;220" dur="0.8s" repeatCount="indefinite"/></circle>' +
      '</svg>';
    arena.appendChild(beaker);

    /* Step 4: Particle explosion (25+ particles) */
    const colors = [recipe.color, '#fbbf24', '#ef4444', '#3b82f6', '#22c55e', '#8b5cf6', '#fff'];
    for (let i = 0; i < 28; i++) {
      const p = document.createElement('div');
      p.className = 'reaction-particle';
      const angle = (Math.PI * 2 / 28) * i;
      const dist = 100 + Math.random() * 200;
      const size = 10 + Math.random() * 18;
      const color = colors[Math.floor(Math.random() * colors.length)];
      p.style.cssText = 'left:50%;top:50%;width:' + size + 'px;height:' + size + 'px;background:' + color + ';--tx:' + (Math.cos(angle)*dist) + 'px;--ty:' + (Math.sin(angle)*dist) + 'px';
      arena.appendChild(p);
      setTimeout(() => p.remove(), 1000);
    }

    /* Step 5: Recipe result text zooms in */
    const resultTxt = document.createElement('div');
    resultTxt.className = 'reaction-result-text';
    resultTxt.textContent = recipe.emoji + ' ' + recipe.result;
    arena.appendChild(resultTxt);
    setTimeout(() => resultTxt.remove(), 1200);

    /* Step 6: Confetti shower */
    spawnConfetti(arena, 30);

    /* Score popup */
    showScorePopup(arena, '+' + pts, 960, 300);

    /* Combo display */
    if (hg.combo >= 2) {
      showComboText(960, 250, hg.combo);
    }

    if (hg.combo >= 3) {
      hg.score += 30;
      const ct = document.createElement('div');
      ct.className = 'hg-chain-text';
      ct.textContent = 'üî• Ï≤¥Ïù∏ Î¶¨Ïï°ÏÖò! +30';
      ct.style.left = '50%'; ct.style.top = '35%';
      arena.appendChild(ct);
      setTimeout(() => ct.remove(), 1200);
    }

    speak(recipe.result);

    /* Step 7: Clean up after reaction, prepare next */
    setTimeout(() => {
      beaker.remove();
      /* Reset tubes */
      hg.tubes = {a: null, b: null};
      hg.liquidLevelA = 0; hg.liquidLevelB = 0;
      updateTubeLiquid('a');
      updateTubeLiquid('b');

      /* Restore corks */
      if (corkA) corkA.classList.remove('cork-pop');
      if (corkB) corkB.classList.remove('cork-pop');

      /* Level up check */
      if (hg.score >= hg.level * 100) {
        hg.level++;
        document.getElementById('hg-level').textContent = hg.level;
        document.getElementById('hero-game').style.background = HG_BACKGROUNDS[(hg.level - 1) % HG_BACKGROUNDS.length];
        SFX.levelup(); showLevelUp(hg.level);
        speak('Î†àÎ≤® ÏóÖ!');
      }

      /* Pick new recipe */
      pickHeroRecipe();
      updateTubeLabels();
      showRecipeHint();
      updateHeroUI();
    }, 1000);
  }, 400);

  updateHeroUI();
}

function spawnConfetti(arena, count) {
  const colors = ['#ef4444','#f97316','#eab308','#22c55e','#3b82f6','#8b5cf6','#ec4899','#fbbf24','#14b8a6'];
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      const c = document.createElement('div');
      c.className = 'hg-confetti';
      const size = 8 + Math.random() * 12;
      const color = colors[Math.floor(Math.random() * colors.length)];
      const x = Math.random() * 100;
      const rot = 360 + Math.random() * 720;
      const fall = 400 + Math.random() * 400;
      const dur = 1.5 + Math.random() * 1;
      c.style.cssText = 'left:' + x + '%;top:-20px;width:' + size + 'px;height:' + (size*0.6) + 'px;background:' + color + ';border-radius:2px;--fall:' + fall + 'px;--rot:' + rot + 'deg;--dur:' + dur + 's';
      arena.appendChild(c);
      setTimeout(() => c.remove(), dur * 1000 + 200);
    }, i * 40);
  }
}

function hgFailEffect() {
  const arena = document.getElementById('hg-arena');
  const flash = document.createElement('div');
  flash.className = 'hg-flash-red';
  arena.appendChild(flash);
  setTimeout(() => flash.remove(), 400);
  arena.classList.add('hg-shake');
  setTimeout(() => arena.classList.remove('hg-shake'), 400);
}

function hgGameLoop() {
  if (!hg.running) return;
  hg.animId = requestAnimationFrame(hgGameLoop);
  if (hg.paused) return;

  const arena = document.getElementById('hg-arena');
  const arenaH = 1024; // fixed arena height (1080 - header)

  const itemsToRemove = [];

  hg.items.forEach(item => {
    if (item.removing) return;
    const spd = (hg.slowMode && !item.isPowerup) ? item.speed * 0.5 : item.speed;
    item.y += spd;
    item.el.style.top = item.y + 'px';

    /* Powerup auto-collect when it reaches the lower area */
    if (item.isPowerup && item.y > arenaH * 0.6) {
      item.removing = true;
      activatePowerup(item.type, item.name);
      item.el.remove();
      itemsToRemove.push(item);
      playSuccessSound();
      return;
    }

    /* Item hits the ground ‚Äî lose a heart (only for recipe ingredients, not grey) */
    if (!item.isPowerup && item.y > arenaH - 160) {
      item.removing = true;
      if (item.type === 'a' || item.type === 'b') {
        /* Missed a recipe ingredient ‚Äî penalty! */
        if (hg.shielded) {
          hg.shielded = false;
          speak('ÏïàÏ†ÑÍ≥†Í∏ÄÏù¥ ÎßâÏïÑÏ§¨Ïñ¥Ïöî!');
        } else {
          hg.lives--;
          hg.combo = 0;
          hgFailEffect();
          SFX.wrong();
          speak('Ïû¨Î£åÎ•º ÎÜìÏ≥§Ïñ¥Ïöî!');
          if (hg.lives <= 0) {
            item.el.remove();
            itemsToRemove.push(item);
            hgGameOver();
            return;
          }
          updateHeroUI();
        }
      }
      /* Grey items just disappear ‚Äî no penalty for missing them */
      item.el.remove();
      itemsToRemove.push(item);
    }
  });

  if (itemsToRemove.length > 0) {
    hg.items = hg.items.filter(i => !itemsToRemove.includes(i));
  }
}

let _prevHgLives = 5, _prevHgLevel = 1;
function updateHeroUI() {
  document.getElementById('hg-score').textContent = hg.score;
  document.getElementById('hg-level').textContent = hg.level;
  let hearts = '';
  for (let i = 0; i < 5; i++) hearts += i < hg.lives ? '‚ù§Ô∏è' : 'üñ§';
  document.getElementById('hg-hearts').textContent = hearts;
  if (hg.lives < _prevHgLives && _prevHgLives > 0) SFX.wrong();
  if (hg.level > _prevHgLevel && _prevHgLevel > 0) { SFX.levelup(); showScorePopup(document.getElementById('hg-arena'), 'Lv.' + hg.level, 400, 200); }
  _prevHgLives = hg.lives; _prevHgLevel = hg.level;
}

function hgPause() {
  hg.paused = !hg.paused;
  document.getElementById('hg-pause').classList.toggle('hidden', !hg.paused);
}

function hgGameOver() {
  hg.running = false;
  clearTimeout(hg.spawnTimer);
  cancelAnimationFrame(hg.animId);
  if (hg.score > hg.bestScore) hg.bestScore = hg.score;
  document.getElementById('hg-final-score').textContent = hg.score;
  document.getElementById('hg-over-msg').textContent = 'ÏµúÍ≥† ÏΩ§Î≥¥: ' + hg.maxCombo + 'Ìöå';
  document.getElementById('hg-over').classList.remove('hidden');
  SFX.gameOver();
  speak('Ïã§Ìóò ÎÅù! ' + hg.score + 'Ï†ê!');
  saveStats();
}

function hgRestart() {
  document.getElementById('hg-arena').querySelectorAll('.falling-item,.hg-tube-glass,.hg-tube-nameplate,.tube-glow-ring,.hg-tutorial,.hg-countdown,.hg-recipe-hint,.hg-lab-shelf,.hg-smoke,.reaction-beaker,.reaction-result-text,.hg-confetti,.reaction-particle,.hg-combo-fire,.hg-combo-text,.hg-chain-text,.hg-flash-white,.hg-flash-green,.hg-flash-red,.pu-active-indicator').forEach(e => e.remove());
  hg.items = [];
  hg.running = false;
  clearTimeout(hg.spawnTimer);
  cancelAnimationFrame(hg.animId);
  startHeroGame();
}

function hgExit() {
  hg.running = false;
  clearTimeout(hg.spawnTimer);
  cancelAnimationFrame(hg.animId);
  speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
  document.getElementById('hg-arena').querySelectorAll('.falling-item,.hg-tube-glass,.hg-tube-nameplate,.tube-glow-ring,.hg-recipe-hint,.hg-lab-shelf,.hg-smoke,.reaction-beaker,.reaction-result-text,.hg-confetti,.reaction-particle,.hg-combo-fire,.hg-combo-text,.hg-chain-text,.pu-active-indicator').forEach(e => e.remove());
  hg.items = [];
  document.getElementById('hero-game').classList.add('hidden');
  saveStats();
  if(document.fullscreenElement)document.exitFullscreen?.();
}

// ===== HERO POWERUPS =====
const POWERUPS = [
  {name:'ÏïàÏ†ÑÍ≥†Í∏Ä',emoji:'ü•Ω',desc:'Ïã§Ìå® 1Ìöå Î∞©Ïñ¥',type:'shield'},
  {name:'Ïä¨Î°úÏö∞',emoji:'üêå',desc:'Ïû¨Î£å ÏÜçÎèÑ Í∞êÏÜå',type:'slow'},
  {name:'ÎçîÎ∏î',emoji:'‚≠ê',desc:'Ï†êÏàò 2Î∞∞',type:'double'},
];

function spawnPowerup() {
  if (!hg.running || hg.paused) return;
  if (Math.random() > 0.15) return; // 15% ÌôïÎ•†
  const arena = document.getElementById('hg-arena');
  const pu = POWERUPS[Math.floor(Math.random() * POWERUPS.length)];

  const el = document.createElement('div');
  el.className = 'hg-powerup';
  const x = 80 + Math.random() * (1920 - 200);
  el.style.left = x + 'px';
  el.style.top = '-70px';
  el.innerHTML = '<div class="pu-body">' + (POWERUP_SVG[pu.type]||pu.emoji) + '</div>';
  el.dataset.type = pu.type;
  el.dataset.name = pu.name;
  arena.appendChild(el);

  const item = { el, type: pu.type, name: pu.name, x, y: -70, speed: 1.2, isPowerup: true };
  hg.items.push(item);
}

function activatePowerup(type, name) {
  const arena = document.getElementById('hg-arena');
  speak(name + ' ÌååÏõåÏóÖ!');

  // Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ ÌëúÏãú
  const ind = document.createElement('div');
  ind.className = 'pu-active-indicator';
  ind.textContent = name + ' Î∞úÎèô!';
  arena.appendChild(ind);
  setTimeout(() => ind.remove(), 2000);

  if (type === 'shield') {
    hg.shielded = true;
    setTimeout(() => { hg.shielded = false; }, 10000);
  } else if (type === 'slow') {
    hg.slowMode = true;
    hg.items.forEach(item => { if (!item.isPowerup) item.speed *= 0.5; });
    setTimeout(() => { hg.slowMode = false; }, 8000);
  } else if (type === 'double') {
    hg.doublePoints = true;
    setTimeout(() => { hg.doublePoints = false; }, 10000);
  }
}

// ===== BEAKER ENHANCED EFFECTS =====
function beakerReactionEffect(color, type) {
  const area = document.getElementById('mix-area');
  // Í±∞Ìíà Ïù¥ÌéôÌä∏
  if (type === 'foam') {
    for (let i = 0; i < 20; i++) {
      setTimeout(() => {
        const foam = document.createElement('div');
        foam.className = 'beaker-foam';
        const size = 6 + Math.random() * 16;
        const x = 48 + Math.random() * 8;
        foam.style.cssText = 'left:' + x + '%;bottom:35%;width:' + size + 'px;height:' + size + 'px;background:' + color + ';--ty:-' + (40+Math.random()*60) + 'px;--ty2:-' + (80+Math.random()*40) + 'px;--dur:' + (1.2+Math.random()*1) + 's';
        area.appendChild(foam);
        setTimeout(() => foam.remove(), 2200);
      }, i * 60);
    }
  }
  // Ïä§ÌååÌÅ¨ Ïù¥ÌéôÌä∏
  if (type === 'spark') {
    for (let i = 0; i < 12; i++) {
      const spark = document.createElement('div');
      spark.className = 'beaker-spark';
      const angle = Math.random() * Math.PI * 2;
      const dist = 30 + Math.random() * 50;
      spark.style.cssText = 'left:52%;top:40%;--tx:' + (Math.cos(angle)*dist) + 'px;--ty:' + (Math.sin(angle)*dist) + 'px;--dur:' + (0.3+Math.random()*0.4) + 's;background:' + color;
      area.appendChild(spark);
      setTimeout(() => spark.remove(), 700);
    }
  }
  // Î∂ÑÎ¶¨ Ïù¥ÌéôÌä∏
  if (type === 'layer') {
    const liq = document.getElementById('beaker-liquid');
    // 2ÏÉâ Î†àÏù¥Ïñ¥ ÌëúÌòÑ (ÏúÑ/ÏïÑÎûò)
    setTimeout(() => {
      liq.setAttribute('fill', color);
      liq.setAttribute('opacity', '.4');
    }, 400);
  }
}

// ===== WEIGHT ENHANCED EFFECTS =====
function scaleWobbleEffect() {
  const svg = document.getElementById('scale-svg');
  svg.classList.add('scale-wobble');
  setTimeout(() => svg.classList.remove('scale-wobble'), 600);
}

function wtCorrectGlowEffect() {
  const svg = document.getElementById('scale-svg');
  svg.classList.add('wt-correct-glow');
  setTimeout(() => svg.classList.remove('wt-correct-glow'), 1000);
}

function wtConfettiEffect() {
  const area = document.getElementById('weight-area');
  const colors = ['#ef4444','#f97316','#eab308','#22c55e','#3b82f6','#8b5cf6','#ec4899'];
  for (let i = 0; i < 20; i++) {
    const c = document.createElement('div');
    c.className = 'success-particle';
    const color = colors[Math.floor(Math.random() * colors.length)];
    const x = 20 + Math.random() * 60;
    const angle = Math.random() * Math.PI * 2;
    const dist = 80 + Math.random() * 120;
    c.style.cssText = 'left:' + x + '%;top:40%;width:10px;height:10px;background:' + color + ';border-radius:2px;--tx:' + (Math.cos(angle)*dist) + 'px;--ty:' + (Math.sin(angle)*dist) + 'px;--dur:' + (0.6+Math.random()*0.6) + 's';
    area.appendChild(c);
    setTimeout(() => c.remove(), 1200);
  }
}

// ===== COLOR MIX ENHANCED EFFECTS =====
function colorMixBurstEffect(canvas, color) {
  for (let i = 0; i < 3; i++) {
    setTimeout(() => {
      const burst = document.createElement('div');
      burst.className = 'color-mix-burst';
      const size = 60 + i * 30;
      burst.style.cssText = 'left:50%;top:75%;width:' + size + 'px;height:' + size + 'px;background:' + color + ';opacity:.4';
      canvas.appendChild(burst);
      setTimeout(() => burst.remove(), 800);
    }, i * 150);
  }
}

function updateTubeLabels() {
  const recipe = hg.currentRecipe;
  if (!recipe) return;
  const cfgs = [{id:'a', color:'#ef4444', name:recipe.a}, {id:'b', color:'#3b82f6', name:recipe.b}];
  cfgs.forEach(cfg => {
    const plate = document.getElementById('hg-plate-' + cfg.id);
    if (plate) {
      const ingIcon = INGREDIENT_SVG[cfg.name] || '';
      plate.innerHTML = '<div class="hg-tube-nameplate-inner" style="border-color:' + cfg.color + '">' +
        (ingIcon ? ingIcon : '') +
        '<span style="color:' + cfg.color + '">' + cfg.name + '</span></div>';
    }
  });
}

// ===== HERO RECIPE HINT DISPLAY (HUGE banner) =====
function showRecipeHint() {
  const arena = document.getElementById('hg-arena');
  arena.querySelectorAll('.hg-recipe-hint,.hg-combo-fire').forEach(h => h.remove());
  if (!hg.currentRecipe) return;
  const hint = document.createElement('div');
  hint.className = 'hg-recipe-hint';
  const aSvg = INGREDIENT_SVG[hg.currentRecipe.a] || '';
  const bSvg = INGREDIENT_SVG[hg.currentRecipe.b] || '';
  const aIcon = aSvg ? '<span class="recipe-icon">' + aSvg + '</span>' : '';
  const bIcon = bSvg ? '<span class="recipe-icon">' + bSvg + '</span>' : '';
  hint.innerHTML = '<span style="color:#ef4444">' + aIcon + ' ' + hg.currentRecipe.a + '</span> + <span style="color:#3b82f6">' + bIcon + ' ' + hg.currentRecipe.b + '</span> = ' + hg.currentRecipe.emoji + ' ' + hg.currentRecipe.result;
  arena.appendChild(hint);

  /* Combo fire indicator if combo >= 2 */
  if (hg.combo >= 2) {
    const fire = document.createElement('div');
    fire.className = 'hg-combo-fire';
    fire.textContent = 'üî• ' + hg.combo + ' COMBO';
    arena.appendChild(fire);
  }
}

// ===== HERO COMBO DISPLAY =====
function showComboText(x, y, combo) {
  const arena = document.getElementById('hg-arena');
  const ct = document.createElement('div');
  ct.className = 'hg-combo-text';
  ct.textContent = 'üî• ' + combo + ' COMBO!';
  ct.style.left = x + 'px';
  ct.style.top = y + 'px';
  arena.appendChild(ct);
  setTimeout(() => ct.remove(), 1000);
}

// ===== Web Audio beep =====
function playBeep(freq, dur) {
  if (!soundEnabled) return;
  try {
    const ctx = SFX._getCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = freq;
    osc.type = 'sine';
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
    osc.start();
    osc.stop(ctx.currentTime + dur);
  } catch(e) {}
}

function playSuccessSound() { playBeep(523, 0.15); setTimeout(() => playBeep(659, 0.15), 100); setTimeout(() => playBeep(784, 0.2), 200); }
function playFailSound() { playBeep(330, 0.15); setTimeout(() => playBeep(262, 0.25), 120); }
function playMixSound() { playBeep(440, 0.1); setTimeout(() => playBeep(554, 0.1), 80); setTimeout(() => playBeep(659, 0.15), 160); }

// ===== INIT =====
document.addEventListener('DOMContentLoaded', function() {
  function fitScale() {
    const c = document.querySelector('.container');
    if (!c || getComputedStyle(c).display === 'none') return;
    const M = 0.03;
    const aW = window.innerWidth * (1 - M * 2);
    const aH = window.innerHeight * (1 - M * 2);
    const s = Math.min(aW / 1920, aH / 1080);
    c.style.transform = 'scale(' + s + ')';
    c.style.left = ((window.innerWidth - 1920 * s) / 2) + 'px';
    c.style.top = ((window.innerHeight - 1080 * s) / 2) + 'px';
  }
  fitScale();
  window.addEventListener('resize', fitScale);
  if (window.visualViewport) window.visualViewport.addEventListener('resize', fitScale);

  const _p = parseInt(localStorage.getItem('sciCorrect')) || 0;
  _prevMainLevel = Math.floor(_p / 10) + 1;
  updateProfile();
  updateActionButtons();
  initMixGame();
  newWeightQuestion();
  initLightMode();
});

// ÎçîÎ∏îÌÉ≠ Î∞©ÏßÄ
let lastTouchEnd = 0;
document.addEventListener('touchend', function(e) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) e.preventDefault();
  lastTouchEnd = now;
}, false);
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
    if (hg.running && !hg.paused) hgPause();
  }
});
window.matchMedia('(orientation: portrait)').addEventListener('change', e => {
  if (e.matches) {
    speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
    if (hg.running && !hg.paused) hgPause();
  }
});
</script>
</body>
</html>
