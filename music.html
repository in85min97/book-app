<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ìŒì•… ë†€ì´í„° ğŸµ</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}
body{font-family:'Noto Sans KR',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#7c3aed 0%,#8b5cf6 50%,#6d28d9 100%);margin:0;padding:0;width:100vw;height:100vh;height:100dvh;overflow:hidden;touch-action:manipulation}
.rotate-notice{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#7c3aed,#8b5cf6);z-index:9999;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-size:24px;font-weight:700;text-align:center;gap:20px}
.rotate-notice .rotate-icon{font-size:80px;animation:rotateH 2s ease-in-out infinite}
@keyframes rotateH{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
@media(orientation:portrait){.rotate-notice{display:flex}.container{display:none!important}}
.container{width:1920px;height:1080px;background:#fff;border-radius:25px;box-shadow:0 25px 50px rgba(0,0,0,.12);display:flex;flex-direction:column;overflow:hidden;transform-origin:0 0;position:absolute}

.subject-bar{background:linear-gradient(135deg,#1e3a8a,#3b82f6);display:flex;align-items:center;padding:0 20px;height:56px;flex-shrink:0;gap:4px;position:relative}
.subject-bar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#c4b5fd,#a78bfa,#c4b5fd)}
.sb-tab{padding:8px 30px;border:none;border-radius:12px 12px 0 0;background:0;font-size:18px;font-weight:800;color:rgba(255,255,255,.5);cursor:pointer;font-family:inherit;transition:.2s;display:flex;align-items:center;gap:8px;text-decoration:none}
.sb-tab.active{background:#fff;color:#1e3a8a}
.sb-tab.locked{cursor:default}
.sb-tab .lock{font-size:12px;opacity:.5}
.sb-spacer{flex:1}
.sb-btns{display:flex;gap:8px}
.sb-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);border-radius:10px;padding:6px 14px;font-size:18px;color:#fff;cursor:pointer;transition:.15s}
.sb-btn:active{background:rgba(255,255,255,.3)}

.main-layout{display:grid;grid-template-columns:300px 1fr 300px;gap:14px;padding:14px;flex:1;overflow:hidden}

.left-panel{display:flex;flex-direction:column;gap:10px;overflow:hidden}
.profile-section{background:linear-gradient(145deg,#7c3aed,#8b5cf6 50%,#a78bfa);border-radius:20px;padding:20px;border:3px solid #c4b5fd;box-shadow:0 6px 20px rgba(124,58,237,.3);flex-shrink:0;position:relative;overflow:hidden}
.profile-section::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='15' cy='15' r='1.5' fill='white' opacity='.3'><animate attributeName='opacity' values='.3;.1;.3' dur='2s' repeatCount='indefinite'/></circle><circle cx='85' cy='25' r='1' fill='white' opacity='.25'><animate attributeName='opacity' values='.25;.08;.25' dur='1.5s' repeatCount='indefinite'/></circle><circle cx='25' cy='75' r='1.2' fill='white' opacity='.3'><animate attributeName='opacity' values='.3;.1;.3' dur='1.8s' repeatCount='indefinite'/></circle></svg>") repeat;pointer-events:none}
.profile-content{position:relative;z-index:1;display:flex;align-items:center;gap:15px}
.profile-avatar{width:90px;height:90px;background:linear-gradient(145deg,#c4b5fd,#a78bfa);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;border:3px solid #fff;box-shadow:0 4px 15px rgba(167,139,250,.4);animation:avGlow 3s ease-in-out infinite;flex-shrink:0;cursor:pointer}
@keyframes avGlow{0%,100%{box-shadow:0 4px 15px rgba(167,139,250,.4);transform:scale(1)}50%{box-shadow:0 8px 25px rgba(167,139,250,.6);transform:scale(1.05)}}
.profile-info{flex:1;color:#fff}
.profile-name{font-size:28px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,.3);margin-bottom:8px;cursor:pointer}
.profile-level-container{background:rgba(255,255,255,.2);border-radius:12px;padding:8px 12px}
.profile-level{font-size:22px;font-weight:700;color:#e9d5ff;display:flex;align-items:center;gap:8px}
.level-badge{background:linear-gradient(145deg,#c4b5fd,#a78bfa);color:#4c1d95;padding:4px 12px;border-radius:8px;font-size:22px;font-weight:800;border:1px solid #fff}
.progress-bar{width:100%;height:6px;background:rgba(255,255,255,.3);border-radius:3px;margin-top:5px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#c4b5fd,#a78bfa,#c4b5fd);background-size:200% 100%;border-radius:3px;transition:width .5s;animation:pShine 2s linear infinite}
@keyframes pShine{0%{background-position:-200% 0}100%{background-position:200% 0}}

.tab-headers{display:grid;grid-template-columns:1fr 1fr;gap:8px;flex-shrink:0}
.tab-btn{background:linear-gradient(145deg,#e2e8f0,#cbd5e1);border:2px solid #94a3b8;border-radius:12px;padding:8px;font-size:20px;font-weight:700;cursor:pointer;transition:.2s;color:#475569;display:flex;align-items:center;justify-content:center;height:62px;white-space:nowrap;font-family:inherit}
.tab-btn.active{background:linear-gradient(145deg,#8b5cf6,#7c3aed);color:#fff;border-color:#8b5cf6}
.tab-btn:active{transform:scale(.97)}
.tab-content{display:none;flex:1;overflow:hidden}
.tab-content.active{display:flex;flex-direction:column}

.side-info{background:linear-gradient(145deg,#f5f3ff,#ede9fe);border-radius:16px;padding:16px;border:2px solid #8b5cf6;display:flex;flex-direction:column;gap:10px;height:100%;overflow:hidden}
.side-title{font-size:26px;font-weight:800;color:#5b21b6;text-align:center;flex-shrink:0}
.side-stat{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#fff;border-radius:10px;font-size:22px;font-weight:600;color:#1e293b}
.side-val{font-size:36px;font-weight:800;color:#7c3aed}

.game-launch-btn{flex-shrink:0;background:linear-gradient(145deg,#c4b5fd,#a78bfa);color:#4c1d95;border:3px solid #fff;border-radius:16px;padding:20px;font-size:26px;font-weight:800;cursor:pointer;text-align:center;box-shadow:0 4px 15px rgba(167,139,250,.4);font-family:inherit;animation:gPulse 2s ease-in-out infinite}
@keyframes gPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
.game-launch-btn:active{transform:scale(.97)}

.center-panel{display:flex;flex-direction:column;overflow:hidden;position:relative}
.game-view{display:none;flex-direction:column;flex:1;overflow:hidden}
.game-view.active{display:flex}

.right-panel{display:flex;flex-direction:column;gap:12px;overflow:hidden}
.action-btn{border:none;border-radius:20px;font-size:36px;font-weight:800;cursor:pointer;transition:.1s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;flex:1;min-height:60px;font-family:inherit;color:#fff}
.action-btn .icon{font-size:62px;opacity:.9;line-height:1}
.action-btn:active{transform:scale(.95)}
.action-btn.btn-purple{background:linear-gradient(145deg,#8b5cf6,#7c3aed);box-shadow:0 2px 8px rgba(139,92,246,.3)}
.action-btn.btn-cyan{background:linear-gradient(145deg,#06b6d4,#0891b2);box-shadow:0 2px 8px rgba(6,182,212,.2)}
.action-btn.btn-red{background:linear-gradient(145deg,#f87171,#ef4444);box-shadow:0 2px 8px rgba(248,113,113,.2)}
.action-btn.btn-green{background:linear-gradient(145deg,#10b981,#059669);box-shadow:0 2px 8px rgba(16,185,129,.2)}
.action-btn.btn-orange{background:linear-gradient(145deg,#f97316,#ea580c);box-shadow:0 2px 8px rgba(249,115,22,.2)}
.action-btn:disabled{background:linear-gradient(145deg,#e5e7eb,#d1d5db)!important;color:#9ca3af;cursor:not-allowed;box-shadow:none}

/* ì†Œë¦¬ ê·¸ë¦¼ */
.draw-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.draw-canvas-wrap{flex:1;position:relative;background:linear-gradient(180deg,#f5f3ff,#ede9fe);border-radius:16px;margin:8px;border:3px solid #c4b5fd;overflow:hidden;cursor:crosshair}
.draw-canvas-wrap svg{width:100%;height:100%;position:absolute;top:0;left:0}
.draw-guide{position:absolute;left:0;top:0;bottom:0;width:70px;display:flex;flex-direction:column;justify-content:space-between;padding:12px 0;pointer-events:none;z-index:5}
.draw-note{font-size:22px;font-weight:700;color:#7c3aed;text-align:center;opacity:.7;display:flex;align-items:center;justify-content:center;gap:4px}
.draw-note svg{width:32px;height:32px;flex-shrink:0}
.draw-info{text-align:center;padding:10px;font-size:22px;font-weight:700;color:#5b21b6;flex-shrink:0}
/* ì†Œë¦¬ê·¸ë¦¼ idle ë– ë‹¤ë‹ˆëŠ” ìŒí‘œ */
.draw-idle-note{position:absolute;pointer-events:none;z-index:2;opacity:.35;animation:drawIdleFloat linear infinite}
@keyframes drawIdleFloat{0%{transform:translateY(0) rotate(0deg);opacity:.35}25%{opacity:.5}50%{transform:translateY(-30px) rotate(15deg);opacity:.35}75%{opacity:.5}100%{transform:translateY(0) rotate(0deg);opacity:.35}}
/* ìŒí‘œ íŒŒí‹°í´ ì´í™íŠ¸ */
.draw-particle{position:absolute;pointer-events:none;z-index:10;animation:drawParticlePop .7s ease-out forwards}
@keyframes drawParticlePop{0%{transform:scale(0) rotate(0deg);opacity:1}50%{transform:scale(1.2) rotate(180deg);opacity:.8}100%{transform:scale(0) rotate(360deg);opacity:0}}
/* ì†Œë¦¬ê·¸ë¦¼ ì¬ìƒ ì»¤ì„œ */
.replay-cursor{filter:drop-shadow(0 0 4px #fbbf24) drop-shadow(0 0 8px #f59e0b);transition:cx .04s,cy .04s}
.replay-glow{filter:drop-shadow(0 0 8px currentColor) drop-shadow(0 0 16px currentColor)}

/* ëª¸ìœ¼ë¡œ ë“œëŸ¼ */
.drum-area{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;overflow:hidden}
.drum-pattern-bar{background:linear-gradient(145deg,#1e1b4b,#312e81);border-radius:16px;padding:14px 18px;display:flex;align-items:center;gap:12px;flex-shrink:0}
.drum-pattern-label{color:#c4b5fd;font-size:24px;font-weight:700;flex-shrink:0}
.drum-beats{display:flex;gap:8px;flex:1;justify-content:center}
.drum-beat{width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);transition:.2s}
.drum-beat svg{width:40px;height:40px}
.drum-beat.active{border-color:#fbbf24;box-shadow:0 0 20px rgba(251,191,36,.6);transform:scale(1.2);background:rgba(251,191,36,.2)}
.drum-beat.hit-perfect{background:#22c55e!important;border-color:#22c55e!important}
.drum-beat.hit-good{background:#f59e0b!important;border-color:#f59e0b!important}
.drum-beat.hit-miss{background:#ef4444!important;border-color:#ef4444!important}
.drum-score-bar{display:flex;justify-content:center;gap:24px;font-size:24px;font-weight:700;color:#1e293b;flex-shrink:0}
.drum-score-bar span{padding:8px 18px;background:linear-gradient(145deg,#f5f3ff,#ede9fe);border-radius:10px}
.drum-pads{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:10px}
.drum-pad{border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:800;cursor:pointer;border:5px solid rgba(255,255,255,.4);transition:.15s;position:relative;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.2)}
.drum-pad svg{width:65%;height:50%;pointer-events:none;filter:drop-shadow(0 3px 6px rgba(0,0,0,.3))}
.drum-pad:active{transform:scale(.92)}
.drum-pad.pad-clap{background:linear-gradient(145deg,#ef4444,#dc2626);color:#fff}
.drum-pad.pad-stomp{background:linear-gradient(145deg,#f97316,#ea580c);color:#fff}
.drum-pad.pad-knee{background:linear-gradient(145deg,#22c55e,#16a34a);color:#fff}
.drum-pad.pad-tongue{background:linear-gradient(145deg,#3b82f6,#2563eb);color:#fff}
.drum-pad-label{font-size:26px;font-weight:800;margin-top:2px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
.drum-pad.drum-bounce svg{animation:drumBounce .3s ease-out}
.drum-pad.drum-glow{box-shadow:0 0 30px 8px rgba(255,255,255,.5)!important}
@keyframes drumBounce{0%{transform:scale(1)}40%{transform:scale(1.25)}100%{transform:scale(1)}}
.drum-pad-ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,.4);transform:scale(0);animation:padRipple .5s ease-out forwards;pointer-events:none}
@keyframes padRipple{0%{transform:scale(0);opacity:1}100%{transform:scale(2.5);opacity:0}}
.drum-result{position:absolute;font-size:34px;font-weight:900;pointer-events:none;z-index:10;animation:drumResPop .8s ease-out forwards}
@keyframes drumResPop{0%{transform:translate(-50%,-50%) scale(0);opacity:0}30%{transform:translate(-50%,-50%) scale(1.3);opacity:1}100%{transform:translate(-50%,-80%) scale(.7);opacity:0}}

/* ëƒ‰ì¥ê³  ì˜¤ì¼€ìŠ¤íŠ¸ë¼ */
.fridge-area{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;overflow:hidden}
.fridge-items{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;flex:1}
.fridge-item{background:linear-gradient(145deg,rgba(255,255,255,.9),rgba(248,250,252,.95));border:3px solid #e2e8f0;border-radius:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:.15s;position:relative;overflow:hidden;padding:8px;backdrop-filter:blur(4px)}
.fridge-item svg{width:85%;height:65%;pointer-events:none;filter:drop-shadow(0 3px 8px rgba(0,0,0,.15))}
.fridge-item:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(139,92,246,.15)}
.fridge-item:active{transform:scale(.93);border-color:#8b5cf6}
.fridge-item-name{font-size:22px;font-weight:800;color:#475569;margin-top:4px}
.fridge-item.playing{border-color:#8b5cf6;box-shadow:0 0 30px rgba(139,92,246,.5);background:linear-gradient(145deg,#f5f3ff,#ede9fe)}
.fridge-item.playing svg{animation:fridgeSvgShake .3s ease-out}
@keyframes fridgeSvgShake{0%{transform:rotate(0)}25%{transform:rotate(-12deg)}50%{transform:rotate(12deg)}75%{transform:rotate(-6deg)}100%{transform:rotate(0)}}
/* ì†Œë¦¬íŒŒ ì´í™íŠ¸ */
.fridge-soundwave{position:absolute;top:50%;left:50%;width:40px;height:40px;border-radius:50%;border:3px solid #8b5cf6;pointer-events:none;transform:translate(-50%,-50%);animation:fridgeSoundwave .6s ease-out forwards;opacity:0}
@keyframes fridgeSoundwave{0%{width:40px;height:40px;opacity:.8}100%{width:160px;height:160px;opacity:0}}
.fridge-seq{display:flex;gap:10px;align-items:center;flex-shrink:0;padding:12px 14px;background:linear-gradient(145deg,#1e1b4b,#312e81);border-radius:16px;position:relative;overflow:hidden}
.fridge-seq::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 60'><path d='M0 30 Q25 10 50 30 T100 30 T150 30 T200 30' fill='none' stroke='rgba(167,139,250,0.15)' stroke-width='2'><animate attributeName='d' values='M0 30 Q25 10 50 30 T100 30 T150 30 T200 30;M0 30 Q25 50 50 30 T100 30 T150 30 T200 30;M0 30 Q25 10 50 30 T100 30 T150 30 T200 30' dur='3s' repeatCount='indefinite'/></path></svg>") repeat-x;pointer-events:none;opacity:.6}
.fridge-seq-label{color:#c4b5fd;font-size:24px;font-weight:700;flex-shrink:0;padding:0 10px;z-index:1}
.fridge-seq-slots{display:flex;gap:10px;flex:1;justify-content:center;z-index:1}
.fridge-slot{width:100px;height:100px;border:3px dashed rgba(255,255,255,.3);border-radius:18px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.05);cursor:pointer;transition:.2s;position:relative}
.fridge-slot svg{width:62px;height:62px}
.fridge-slot.filled{border-style:solid;border-color:#a78bfa;background:rgba(167,139,250,.2)}
.fridge-slot.active-slot{border-color:#fbbf24;box-shadow:0 0 20px rgba(251,191,36,.6)}
.fridge-play-btn{background:linear-gradient(145deg,#8b5cf6,#7c3aed);color:#fff;border:none;border-radius:14px;padding:16px 34px;font-size:26px;font-weight:800;cursor:pointer;font-family:inherit;flex-shrink:0;z-index:1}
.fridge-play-btn:active{transform:scale(.95)}
.fridge-item-ring{position:absolute;border-radius:50%;border:3px solid;pointer-events:none;animation:itemRing .6s ease-out forwards}
@keyframes itemRing{0%{transform:scale(0);opacity:1}100%{transform:scale(2);opacity:0}}

/* ë‚´ ê¸°ë¡ â€” ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ */
.records-area{flex:1;display:flex;flex-direction:column;gap:16px;padding:16px;overflow-y:auto}
.record-card{background:linear-gradient(145deg,rgba(255,255,255,.85),rgba(248,250,252,.9));border:2px solid rgba(139,92,246,.15);border-radius:18px;padding:18px;box-shadow:0 4px 16px rgba(0,0,0,.06);backdrop-filter:blur(8px);transition:.2s}
.record-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(139,92,246,.12)}
.record-card h3{font-size:26px;font-weight:800;background:linear-gradient(135deg,#7c3aed,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
.record-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.record-item{text-align:center;padding:14px;background:linear-gradient(145deg,rgba(245,243,255,.8),rgba(237,233,254,.9));border-radius:14px;border:2px solid rgba(167,139,250,.2);backdrop-filter:blur(4px)}
.record-num{font-size:48px;font-weight:900;color:#7c3aed;text-shadow:0 0 20px rgba(124,58,237,.2)}
.record-label{font-size:18px;font-weight:700;color:#5b21b6;margin-top:4px}

/* íˆì–´ë¡œ: ë¹„íŠ¸ ëŸ¬ì‹œ (ë¹„íŠ¸ë§¤ë‹ˆì•„ ìŠ¤íƒ€ì¼) */
.hero-game{position:absolute;top:0;left:0;width:1920px;height:1080px;z-index:5000;display:flex;flex-direction:column;background:linear-gradient(180deg,#0f0720 0%,#1a0a3e 40%,#2d1463 100%);overflow:hidden}
.hero-game.hidden{display:none}
.hg-header{display:flex;align-items:center;justify-content:space-between;padding:10px 24px;background:rgba(0,0,0,.4);backdrop-filter:blur(12px);flex-shrink:0;z-index:10;border-bottom:2px solid rgba(167,139,250,.3)}
.hg-stat{font-size:24px;font-weight:800;color:#e9d5ff;text-shadow:0 2px 8px rgba(139,92,246,.4)}
.hg-hearts{font-size:26px;letter-spacing:4px}
.hg-ctrls{display:flex;gap:10px}
.hg-ctrl-btn{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:50%;width:48px;height:48px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;transition:.15s}
.hg-ctrl-btn:active{transform:scale(.85);background:rgba(255,255,255,.2)}
.hg-arena{flex:1;position:relative;overflow:hidden}
/* ë ˆì¸ ë°°ê²½ */
.hg-lane-bg{position:absolute;top:0;bottom:0;width:160px;z-index:1;border-left:1px solid rgba(255,255,255,.06);border-right:1px solid rgba(255,255,255,.06)}
.hg-lane-bg::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,transparent 0%,rgba(255,255,255,.03) 80%,rgba(255,255,255,.08) 100%)}
.hg-lane-bg[data-l="0"]{left:calc(50% - 332px);background:linear-gradient(180deg,transparent,rgba(239,68,68,.04))}
.hg-lane-bg[data-l="1"]{left:calc(50% - 168px);background:linear-gradient(180deg,transparent,rgba(59,130,246,.04))}
.hg-lane-bg[data-l="2"]{left:calc(50% + 8px);background:linear-gradient(180deg,transparent,rgba(34,197,94,.04))}
.hg-lane-bg[data-l="3"]{left:calc(50% + 172px);background:linear-gradient(180deg,transparent,rgba(251,191,36,.04))}
/* íŒì • ë¼ì¸ */
.hg-judge-line{position:absolute;left:calc(50% - 340px);width:680px;height:6px;bottom:160px;z-index:8;border-radius:3px;background:linear-gradient(90deg,transparent,#c084fc,#a78bfa,#c084fc,transparent);box-shadow:0 0 30px rgba(192,132,252,.5),0 0 60px rgba(167,139,250,.3);animation:judgePulse 1.5s ease-in-out infinite}
@keyframes judgePulse{0%,100%{box-shadow:0 0 30px rgba(192,132,252,.5),0 0 60px rgba(167,139,250,.3)}50%{box-shadow:0 0 40px rgba(192,132,252,.7),0 0 80px rgba(167,139,250,.5)}}
/* ë²„íŠ¼ í–‰ */
.hg-btn-row{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);display:flex;gap:12px;z-index:20}
.hg-btn{width:160px;height:110px;border-radius:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:900;cursor:pointer;transition:transform .08s;border:none;font-family:inherit;position:relative;overflow:hidden}
.hg-btn::before{content:'';position:absolute;inset:0;border-radius:20px;border:3px solid;pointer-events:none}
.hg-btn .note-icon{font-size:36px;line-height:1}
.hg-btn .note-label{font-size:16px;margin-top:4px;opacity:.8}
.hg-btn[data-l="0"]{background:linear-gradient(180deg,rgba(239,68,68,.2),rgba(239,68,68,.35));color:#fca5a5;border-bottom:5px solid #dc2626}.hg-btn[data-l="0"]::before{border-color:rgba(239,68,68,.4)}
.hg-btn[data-l="1"]{background:linear-gradient(180deg,rgba(59,130,246,.2),rgba(59,130,246,.35));color:#93c5fd;border-bottom:5px solid #2563eb}.hg-btn[data-l="1"]::before{border-color:rgba(59,130,246,.4)}
.hg-btn[data-l="2"]{background:linear-gradient(180deg,rgba(34,197,94,.2),rgba(34,197,94,.35));color:#86efac;border-bottom:5px solid #16a34a}.hg-btn[data-l="2"]::before{border-color:rgba(34,197,94,.4)}
.hg-btn[data-l="3"]{background:linear-gradient(180deg,rgba(251,191,36,.2),rgba(251,191,36,.35));color:#fde68a;border-bottom:5px solid #d97706}.hg-btn[data-l="3"]::before{border-color:rgba(251,191,36,.4)}
.hg-btn:active{transform:translateY(3px);border-bottom-width:2px}
.hg-btn.flash{animation:btnFlash .2s}
@keyframes btnFlash{0%{filter:brightness(2)}100%{filter:brightness(1)}}
/* ë…¸íŠ¸ */
.hg-note{position:absolute;z-index:5;pointer-events:none;border-radius:12px;display:flex;align-items:center;justify-content:center}
.hg-note[data-l="0"]{background:linear-gradient(180deg,#ef4444,#dc2626);box-shadow:0 0 15px rgba(239,68,68,.5),0 4px 8px rgba(0,0,0,.3)}
.hg-note[data-l="1"]{background:linear-gradient(180deg,#3b82f6,#2563eb);box-shadow:0 0 15px rgba(59,130,246,.5),0 4px 8px rgba(0,0,0,.3)}
.hg-note[data-l="2"]{background:linear-gradient(180deg,#22c55e,#16a34a);box-shadow:0 0 15px rgba(34,197,94,.5),0 4px 8px rgba(0,0,0,.3)}
.hg-note[data-l="3"]{background:linear-gradient(180deg,#fbbf24,#d97706);box-shadow:0 0 15px rgba(251,191,36,.5),0 4px 8px rgba(0,0,0,.3)}
.hg-note svg{width:32px;height:32px}
/* íŒì • í…ìŠ¤íŠ¸ */
.hg-judge-text{position:absolute;left:50%;bottom:200px;transform:translateX(-50%);font-size:42px;font-weight:900;z-index:30;pointer-events:none;text-shadow:0 3px 15px rgba(0,0,0,.5);animation:judgeText .8s ease-out forwards}
@keyframes judgeText{0%{transform:translateX(-50%) scale(0) translateY(0);opacity:0}20%{transform:translateX(-50%) scale(1.4) translateY(0);opacity:1}100%{transform:translateX(-50%) scale(.9) translateY(-60px);opacity:0}}
/* ì½¤ë³´ */
.hg-combo-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:60px;font-weight:900;color:#fbbf24;text-shadow:0 0 30px rgba(251,191,36,.6),0 4px 15px rgba(0,0,0,.4);z-index:25;pointer-events:none;animation:comboPop 1s ease-out forwards}
@keyframes comboPop{0%{transform:translate(-50%,-50%) scale(0);opacity:0}25%{transform:translate(-50%,-50%) scale(1.3);opacity:1}100%{transform:translate(-50%,-50%) scale(.7);opacity:0}}
/* ë ˆì¸ íˆíŠ¸ í”Œë˜ì‹œ */
.hg-lane-flash{position:absolute;top:0;bottom:0;width:160px;z-index:6;pointer-events:none;animation:laneFlash .25s ease-out forwards}
@keyframes laneFlash{0%{opacity:.5}100%{opacity:0}}
.hg-lane-flash[data-l="0"]{background:linear-gradient(180deg,transparent,rgba(239,68,68,.4))}
.hg-lane-flash[data-l="1"]{background:linear-gradient(180deg,transparent,rgba(59,130,246,.4))}
.hg-lane-flash[data-l="2"]{background:linear-gradient(180deg,transparent,rgba(34,197,94,.4))}
.hg-lane-flash[data-l="3"]{background:linear-gradient(180deg,transparent,rgba(251,191,36,.4))}
/* ìŠ¤ì½”ì–´ íŒì—… */
.hg-score-pop{position:absolute;z-index:28;font-size:24px;font-weight:900;color:#fbbf24;pointer-events:none;text-shadow:0 2px 8px rgba(0,0,0,.4);animation:scorePop .6s ease-out forwards}
@keyframes scorePop{0%{transform:translateY(0) scale(.5);opacity:0}20%{transform:translateY(0) scale(1.1);opacity:1}100%{transform:translateY(-40px) scale(.8);opacity:0}}
/* ë¯¸ìŠ¤ í”Œë˜ì‹œ */
.hg-flash-miss{position:absolute;inset:0;pointer-events:none;z-index:28;animation:flashMiss .35s ease-out forwards}
@keyframes flashMiss{0%{background:rgba(239,68,68,.2)}100%{background:transparent}}
/* BPM í‘œì‹œ */
.hg-bpm{position:absolute;top:80px;right:40px;font-size:20px;font-weight:700;color:rgba(167,139,250,.5);z-index:15;pointer-events:none}
/* ì´í€„ë¼ì´ì € ì¥ì‹ */
.hg-eq-bar{position:absolute;bottom:160px;width:8px;border-radius:4px 4px 0 0;z-index:2;pointer-events:none;opacity:.15;animation:eqBounce var(--dur) ease-in-out infinite}
@keyframes eqBounce{0%,100%{height:var(--h1)}50%{height:var(--h2)}}
/* ì˜¤ë²„ë ˆì´ */
.hg-overlay{position:absolute;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(8px)}
.hg-overlay.hidden{display:none}
.hg-overlay-box{background:linear-gradient(145deg,#1e1b4b,#312e81);border:2px solid rgba(167,139,250,.3);border-radius:28px;padding:48px;text-align:center;box-shadow:0 30px 60px rgba(0,0,0,.5);min-width:380px}
.hg-overlay-box h2{font-size:40px;font-weight:900;color:#e9d5ff;margin-bottom:16px}
.hg-overlay-box .score{font-size:32px;font-weight:700;color:#c4b5fd;margin-bottom:6px}
.hg-overlay-box .msg{font-size:20px;color:#a78bfa;margin-bottom:24px}
.hg-overlay-box .stats{display:flex;gap:20px;justify-content:center;margin-bottom:20px}
.hg-overlay-box .stat-item{text-align:center}
.hg-overlay-box .stat-val{font-size:28px;font-weight:900;color:#fbbf24}
.hg-overlay-box .stat-label{font-size:14px;color:#a78bfa;margin-top:2px}
.hg-overlay-box button{display:block;width:100%;padding:16px;border:none;border-radius:16px;font-size:20px;font-weight:800;cursor:pointer;margin-bottom:10px;font-family:inherit;transition:.15s}
.hg-overlay-box button:active{transform:scale(.96)}
.hg-overlay-box .btn-retry{background:linear-gradient(145deg,#8b5cf6,#7c3aed);color:#fff;box-shadow:0 4px 15px rgba(139,92,246,.4)}
.hg-overlay-box .btn-exit{background:rgba(255,255,255,.1);color:#c4b5fd;border:1px solid rgba(167,139,250,.3)}
/* ì¹´ìš´íŠ¸ë‹¤ìš´ */
.hg-countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:50;pointer-events:none}
.hg-countdown-num{font-size:120px;font-weight:900;color:#e9d5ff;text-shadow:0 0 60px rgba(167,139,250,.6);animation:countPop .8s ease-out forwards}
@keyframes countPop{0%{transform:scale(2);opacity:0}30%{transform:scale(1);opacity:1}80%{opacity:1}100%{transform:scale(.5);opacity:0}}

/* ëª¨ë‹¬ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:6000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px)}
.modal-overlay.hidden{display:none}
.modal-box{background:#fff;border-radius:20px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,.3)}
.modal-head{background:linear-gradient(145deg,#8b5cf6,#7c3aed);color:#fff;padding:16px 20px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center}
.modal-head h3{margin:0;font-size:18px}
.modal-close{background:0;border:0;color:#fff;font-size:24px;cursor:pointer}
.modal-body{padding:20px}
.modal-section{margin-bottom:16px;padding:14px;border-radius:10px;background:#f8fafc}
.modal-section h4{margin:0 0 10px;font-weight:700;color:#374151;font-size:15px}
.modal-input{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;margin-bottom:8px}
.modal-input:focus{outline:none;border-color:#8b5cf6}
.modal-btn{padding:10px 16px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;width:100%;background:linear-gradient(145deg,#8b5cf6,#7c3aed);color:#fff;margin-top:6px}
.char-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:12px}
.char-item{background:linear-gradient(145deg,#f8fafc,#e2e8f0);border:2px solid #cbd5e1;border-radius:14px;padding:12px;text-align:center;cursor:pointer;font-size:32px;height:70px;display:flex;align-items:center;justify-content:center;transition:.2s}
.char-item.selected{background:linear-gradient(145deg,#c4b5fd,#a78bfa);border-color:#a78bfa}

/* ===== ë°°ê²½ ì”¬ ===== */
/* ì†Œë¦¬ê·¸ë¦¼: ì½˜ì„œíŠ¸ í™€ ë¬´ëŒ€ */
.draw-view{background:linear-gradient(180deg,#0f0326 0%,#1a0a3e 30%,#2e1065 70%,#4c1d95 100%);border-radius:16px;overflow:hidden;position:relative}
.draw-view::before{content:'';position:absolute;inset:0;z-index:0;pointer-events:none;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 960'><defs><radialGradient id='sp1' cx='30%25' cy='0'><stop offset='0%25' stop-color='%23fbbf24' stop-opacity='.12'/><stop offset='100%25' stop-color='transparent'/></radialGradient><radialGradient id='sp2' cx='70%25' cy='0'><stop offset='0%25' stop-color='%23a78bfa' stop-opacity='.1'/><stop offset='100%25' stop-color='transparent'/></radialGradient></defs><rect x='0' y='860' width='1320' height='100' fill='%231e1b4b' opacity='.4'/><rect x='0' y='858' width='1320' height='4' fill='%23c4b5fd' opacity='.12'/><ellipse cx='400' cy='0' rx='400' ry='800' fill='url(%23sp1)'/><ellipse cx='920' cy='0' rx='350' ry='700' fill='url(%23sp2)'/><circle cx='100' cy='50' r='2' fill='%23fff' opacity='.3'><animate attributeName='opacity' values='.3;.08;.3' dur='2.5s' repeatCount='indefinite'/></circle><circle cx='350' cy='80' r='1.5' fill='%23fff' opacity='.25'><animate attributeName='opacity' values='.25;.05;.25' dur='3s' repeatCount='indefinite'/></circle><circle cx='600' cy='40' r='2' fill='%23fff' opacity='.35'><animate attributeName='opacity' values='.35;.08;.35' dur='2s' repeatCount='indefinite'/></circle><circle cx='900' cy='65' r='1.8' fill='%23fff' opacity='.3'><animate attributeName='opacity' values='.3;.06;.3' dur='2.8s' repeatCount='indefinite'/></circle><circle cx='1200' cy='55' r='1.5' fill='%23fff' opacity='.2'><animate attributeName='opacity' values='.2;.05;.2' dur='3.2s' repeatCount='indefinite'/></circle></svg>") no-repeat center/cover}
.draw-view .draw-area{position:relative;z-index:1}
.draw-view .draw-info{color:#e9d5ff}

/* ëª¸ìœ¼ë¡œë“œëŸ¼: ì´ë¯¸ ì–´ë‘ìš´ drum-pattern-barê°€ ìˆìœ¼ë¯€ë¡œ ì „ì²´ë¥¼ ë¦¬ë“¬ ìŠ¤íŠœë””ì˜¤ ëŠë‚Œìœ¼ë¡œ */
.drum-view{background:linear-gradient(180deg,#1a0533 0%,#2d0a5e 50%,#4c1d95 100%);border-radius:16px;overflow:hidden;position:relative}
.drum-view::before{content:'';position:absolute;inset:0;z-index:0;pointer-events:none;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 960'><rect x='0' y='0' width='1320' height='960' fill='none'/><rect x='0' y='900' width='1320' height='60' fill='%23c4b5fd' opacity='.05'/><line x1='0' y1='900' x2='1320' y2='900' stroke='%23c4b5fd' stroke-width='2' opacity='.08'/><line x1='220' y1='900' x2='220' y2='960' stroke='%23a78bfa' stroke-width='1' opacity='.06'/><line x1='440' y1='900' x2='440' y2='960' stroke='%23a78bfa' stroke-width='1' opacity='.06'/><line x1='660' y1='900' x2='660' y2='960' stroke='%23a78bfa' stroke-width='1' opacity='.06'/><line x1='880' y1='900' x2='880' y2='960' stroke='%23a78bfa' stroke-width='1' opacity='.06'/><line x1='1100' y1='900' x2='1100' y2='960' stroke='%23a78bfa' stroke-width='1' opacity='.06'/><circle cx='180' cy='300' r='3' fill='%23f472b6' opacity='.25'><animate attributeName='opacity' values='.25;.08;.25' dur='1.5s' repeatCount='indefinite'/></circle><circle cx='500' cy='200' r='2.5' fill='%2322d3ee' opacity='.2'><animate attributeName='opacity' values='.2;.06;.2' dur='2s' repeatCount='indefinite'/></circle><circle cx='820' cy='250' r='3' fill='%23fbbf24' opacity='.2'><animate attributeName='opacity' values='.2;.05;.2' dur='2.5s' repeatCount='indefinite'/></circle><circle cx='1140' cy='350' r='2' fill='%23a78bfa' opacity='.3'><animate attributeName='opacity' values='.3;.08;.3' dur='1.8s' repeatCount='indefinite'/></circle></svg>") no-repeat center/cover}
.drum-view .drum-area{position:relative;z-index:1}
.drum-view .drum-score-bar{background:rgba(255,255,255,.1);backdrop-filter:blur(4px)}
.drum-view .drum-score-bar span{background:rgba(255,255,255,.12);color:#e9d5ff}

/* ëƒ‰ì¥ê³  ì˜¤ì¼€ìŠ¤íŠ¸ë¼: ëƒ‰ì¥ê³  ë‚´ë¶€ */
.fridge-view{background:linear-gradient(180deg,#e0f2fe 0%,#bae6fd 20%,#f0f9ff 60%,#e0f2fe 100%);border-radius:16px;overflow:hidden;position:relative}
.fridge-view::before{content:'';position:absolute;inset:0;z-index:0;pointer-events:none;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 960'><rect x='0' y='0' width='1320' height='960' fill='none'/><rect x='40' y='0' width='3' height='960' fill='%2393c5fd' opacity='.06'/><rect x='1277' y='0' width='3' height='960' fill='%2393c5fd' opacity='.06'/><rect x='0' y='300' width='1320' height='2' fill='%2393c5fd' opacity='.08'/><rect x='0' y='620' width='1320' height='2' fill='%2393c5fd' opacity='.08'/><circle cx='80' cy='80' r='30' fill='%2338bdf8' opacity='.04'><animate attributeName='opacity' values='.04;.08;.04' dur='3s' repeatCount='indefinite'/></circle><circle cx='1240' cy='120' r='25' fill='%237dd3fc' opacity='.05'><animate attributeName='opacity' values='.05;.09;.05' dur='2.5s' repeatCount='indefinite'/></circle><text x='200' y='180' font-size='28' opacity='.06' fill='%230ea5e9'>â„</text><text x='900' y='150' font-size='24' opacity='.05' fill='%230284c7'>â„</text><text x='600' y='900' font-size='30' opacity='.06' fill='%230ea5e9'>â„</text></svg>") no-repeat center/cover}
.fridge-view .fridge-area{position:relative;z-index:1}

/* ë‚´ê¸°ë¡: ëª…ì˜ˆì˜ ì „ë‹¹ â€” ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ */
.record-view{background:linear-gradient(180deg,#1e1b4b 0%,#312e81 30%,#4c1d95 70%,#6d28d9 100%);border-radius:16px;overflow:hidden;position:relative}
.record-view::before{content:'';position:absolute;inset:0;z-index:0;pointer-events:none;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 960'><circle cx='100' cy='100' r='50' fill='none' stroke='%23c4b5fd' stroke-width='2' opacity='.1'/><circle cx='100' cy='100' r='20' fill='%23c4b5fd' opacity='.06'/><circle cx='1220' cy='100' r='50' fill='none' stroke='%23c4b5fd' stroke-width='2' opacity='.1'/><circle cx='1220' cy='100' r='20' fill='%23c4b5fd' opacity='.06'/><polygon points='660,30 670,55 695,55 675,70 683,95 660,80 637,95 645,70 625,55 650,55' fill='%23fbbf24' opacity='.12'><animate attributeName='opacity' values='.12;.05;.12' dur='3s' repeatCount='indefinite'/></polygon><polygon points='200,800 206,818 225,818 210,828 215,846 200,836 185,846 190,828 175,818 194,818' fill='%23fbbf24' opacity='.08'><animate attributeName='opacity' values='.08;.03;.08' dur='4s' repeatCount='indefinite'/></polygon><polygon points='1100,750 1106,768 1125,768 1110,778 1115,796 1100,786 1085,796 1090,778 1075,768 1094,768' fill='%23fbbf24' opacity='.07'/><text x='400' y='480' font-size='60' opacity='.04' fill='%23c4b5fd'>ğŸ†</text><text x='900' y='520' font-size='50' opacity='.04' fill='%23c4b5fd'>ğŸµ</text></svg>") no-repeat center/cover}
.record-view .records-area{position:relative;z-index:1}
.record-view .record-card{background:linear-gradient(145deg,rgba(255,255,255,.1),rgba(255,255,255,.05));backdrop-filter:blur(12px);border:1px solid rgba(196,181,253,.2);box-shadow:0 8px 32px rgba(0,0,0,.15)}
.record-view .record-card h3{background:linear-gradient(135deg,#c4b5fd,#e9d5ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.record-view .record-item{background:linear-gradient(145deg,rgba(255,255,255,.08),rgba(255,255,255,.04));border:1px solid rgba(196,181,253,.15);backdrop-filter:blur(4px)}
.record-view .record-num{color:#c4b5fd;text-shadow:0 0 20px rgba(196,181,253,.4)}
.record-view .record-label{color:#a78bfa}

/* ===== 3D ì•„ì¼€ì´ë“œ ë²„íŠ¼ ===== */
.tab-btn{border-bottom:5px solid #64748b;transition:.15s}
.tab-btn.active{border-bottom:5px solid #5b21b6;box-shadow:0 2px 8px rgba(139,92,246,.3)}
.tab-btn:active{transform:translateY(3px) scaleX(1.06) scaleY(0.94)!important;border-bottom-width:2px}
.action-btn{border-bottom:6px solid rgba(0,0,0,.25)}
.action-btn.btn-purple{border-bottom-color:#5b21b6}
.action-btn.btn-cyan{border-bottom-color:#0e7490}
.action-btn.btn-red{border-bottom-color:#b91c1c}
.action-btn.btn-green{border-bottom-color:#047857}
.action-btn.btn-orange{border-bottom-color:#c2410c}
.action-btn:active{transform:translateY(4px) scaleX(1.06) scaleY(0.92)!important;border-bottom-width:2px}
.game-launch-btn{border-bottom:6px solid #7c3aed;position:relative;overflow:hidden}
.game-launch-btn::after{content:'';position:absolute;top:0;left:-100%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);animation:btnSweep 3s ease-in-out infinite}
@keyframes btnSweep{0%{left:-100%}50%{left:150%}100%{left:150%}}
.game-launch-btn:active{transform:translateY(4px) scaleX(1.04) scaleY(0.94)!important;border-bottom-width:2px}
.drum-pad{border-bottom:8px solid rgba(0,0,0,.2)}
.drum-pad:active{transform:scale(.92) translateY(4px)!important;border-bottom-width:3px}

/* ===== íŒ¨ë„ ê°•í™” ===== */
.right-panel{background:linear-gradient(180deg,rgba(139,92,246,.12),rgba(124,58,237,.18),rgba(109,40,217,.12));border:3px solid rgba(139,92,246,.25);border-radius:20px;padding:10px}
.side-info{background:linear-gradient(145deg,#ede9fe,#ddd6fe,#e9d5ff)}
.side-val{font-size:32px;-webkit-text-stroke:1px #5b21b6;paint-order:stroke fill}
.side-title{font-size:24px;-webkit-text-stroke:.5px #5b21b6;paint-order:stroke fill}

/* ===== ë””ìì¸ ê³µì‹ ===== */
.record-num{-webkit-text-stroke:1px #5b21b6;paint-order:stroke fill}
.game-launch-btn{-webkit-text-stroke:1px #4c1d95;paint-order:stroke fill;font-size:26px}
.hg-stat{font-size:26px;-webkit-text-stroke:1px #1e1b4b;paint-order:stroke fill}
.drum-pad-label{-webkit-text-stroke:.5px rgba(0,0,0,.3);paint-order:stroke fill}
.score-popup{position:absolute;pointer-events:none;z-index:30;font-size:36px;font-weight:900;-webkit-text-stroke:1.5px rgba(0,0,0,.3);paint-order:stroke fill;animation:scorePop .8s ease-out forwards}
@keyframes scorePop{0%{transform:translateY(0) scale(0);opacity:0}20%{transform:translateY(-10px) scale(1.3);opacity:1}50%{transform:translateY(-30px) scale(1);opacity:1}100%{transform:translateY(-60px) scale(.7);opacity:0}}
.game-view{animation:viewFadeIn .25s ease-out}
.tab-content{animation:viewFadeIn .25s ease-out}
@keyframes viewFadeIn{0%{opacity:0;transform:translateY(6px)}100%{opacity:1;transform:translateY(0)}}
.levelup-overlay{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.4);animation:lvFade .8s ease-out forwards;pointer-events:none}
@keyframes lvFade{0%{opacity:0}15%{opacity:1}70%{opacity:1}100%{opacity:0}}
.levelup-text{font-size:80px;font-weight:900;color:#c4b5fd;-webkit-text-stroke:3px #1e1b4b;paint-order:stroke fill;text-shadow:0 4px 12px rgba(0,0,0,.4),0 0 40px rgba(196,181,253,.5);animation:lvPop .8s cubic-bezier(.34,1.56,.64,1) forwards}
@keyframes lvPop{0%{transform:scale(0) rotate(-10deg)}30%{transform:scale(1.3) rotate(5deg)}50%{transform:scale(1) rotate(0deg)}100%{transform:scale(.9) rotate(0deg)}}
.hg-heart-lost{display:inline-block;animation:heartLost .5s ease-out forwards}
@keyframes heartLost{0%{transform:scale(1);opacity:1;filter:none}30%{transform:scale(1.4);filter:brightness(2)}100%{transform:scale(0) translateY(-20px);opacity:0;filter:grayscale(1)}}
.mascot-wrap{position:absolute;z-index:5;pointer-events:none}
.mascot-svg{filter:drop-shadow(0 4px 8px rgba(0,0,0,.15));animation:mascotBob 3s ease-in-out infinite}
@keyframes mascotBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.mascot-speech{background:#fff;color:#1e293b;padding:6px 14px;border-radius:14px;font-size:14px;font-weight:700;box-shadow:0 3px 10px rgba(0,0,0,.12);margin-bottom:6px;white-space:nowrap;position:relative;text-align:center}
.mascot-speech::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#fff}
</style>
</head>
<body>
<div class="rotate-notice"><div class="rotate-icon">ğŸ“±</div>í™”ë©´ì„ ê°€ë¡œë¡œ ëŒë ¤ì£¼ì„¸ìš”!</div>

<div class="container">
  <div class="subject-bar">
    <button class="sb-tab active">ğŸµ ìŒì•…</button>
    <div class="sb-spacer"></div>
    <div class="sb-btns">
      <button class="sb-btn" id="sb-sound" onclick="toggleSound()">ğŸ”Š</button>
      <button class="sb-btn" onclick="showAdmin()">âš™ï¸</button>
    </div>
  </div>

  <div class="main-layout">
    <div class="left-panel">
      <div class="profile-section">
        <div class="profile-content">
          <div class="profile-avatar" onclick="showCharModal()"><span id="pf-char">ğŸ§’</span></div>
          <div class="profile-info">
            <div class="profile-name" onclick="changeName()"><span id="pf-name">ìŒì•…ê°€</span></div>
            <div class="profile-level-container">
              <div class="profile-level">
                <span class="level-badge">LV.<span id="pf-level">1</span></span>
                <span id="pf-done">0</span>/<span id="pf-total">10</span>
              </div>
              <div class="progress-bar"><div class="progress-fill" id="pf-bar" style="width:0%"></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-headers">
        <button class="tab-btn active" onclick="switchTab('draw')">ğŸ¨ ì†Œë¦¬ê·¸ë¦¼</button>
        <button class="tab-btn" onclick="switchTab('drum')">ğŸ¥ ëª¸ìœ¼ë¡œë“œëŸ¼</button>
        <button class="tab-btn" onclick="switchTab('fridge')">ğŸ¹ ëƒ‰ì¥ê³ </button>
        <button class="tab-btn" onclick="switchTab('record')">ğŸ“Š ë‚´ ê¸°ë¡</button>
      </div>

      <div class="tab-content draw-side active">
        <div class="side-info">
          <div class="side-title">ğŸ¨ ì†Œë¦¬ ê·¸ë¦¼</div>
          <div class="side-stat"><span>ê·¸ë¦° ê³¡</span><span class="side-val" id="draw-count">0</span></div>
          <div class="side-stat"><span>ìŒí‘œ ìˆ˜</span><span class="side-val" id="draw-notes">0</span></div>
        </div>
      </div>
      <div class="tab-content drum-side">
        <div class="side-info">
          <div class="side-title">ğŸ¥ ëª¸ìœ¼ë¡œ ë“œëŸ¼</div>
          <div class="side-stat"><span>ì ìˆ˜</span><span class="side-val" id="drum-score-side">0</span></div>
          <div class="side-stat"><span>Perfect</span><span class="side-val" id="drum-perfect">0</span></div>
          <div class="side-stat"><span>ì½¤ë³´</span><span class="side-val" id="drum-combo-side">0</span></div>
        </div>
      </div>
      <div class="tab-content fridge-side">
        <div class="side-info">
          <div class="side-title">ğŸ¹ ëƒ‰ì¥ê³  ì˜¤ì¼€ìŠ¤íŠ¸ë¼</div>
          <div class="side-stat"><span>ì—°ì£¼ íšŸìˆ˜</span><span class="side-val" id="fridge-plays">0</span></div>
          <div class="side-stat"><span>ë°°ì¹˜ ì™„ë£Œ</span><span class="side-val" id="fridge-filled">0</span></div>
        </div>
      </div>
      <div class="tab-content record-side">
        <div class="side-info">
          <div class="side-title">ğŸ“Š ì¢…í•© ê¸°ë¡</div>
          <div class="side-stat"><span>ì´ í™œë™</span><span class="side-val" id="rec-total">0</span></div>
          <div class="side-stat"><span>ë ˆë²¨</span><span class="side-val" id="rec-level">1</span></div>
        </div>
      </div>

      <div class="game-launch-btn" onclick="startHeroGame()">ğŸµ ë¹„íŠ¸ ëŸ¬ì‹œ ì‹œì‘!</div>
    </div>

    <div class="center-panel">
      <!-- ì†Œë¦¬ ê·¸ë¦¼ -->
      <div class="game-view draw-view active" id="draw-view">
        <div class="mascot-wrap" id="mascot-draw" style="top:8px;right:16px">
          <div class="mascot-speech" id="mascot-draw-speech">ê·¸ë¦¼ìœ¼ë¡œ ìŒì•…ì„ ë§Œë“¤ì!</div>
          <svg class="mascot-svg" viewBox="0 0 100 140" width="90" height="126">
            <defs><linearGradient id="mGd1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#7c3aed"/></linearGradient></defs>
            <!-- ë‹¤ë¦¬ -->
            <ellipse cx="35" cy="128" rx="10" ry="6" fill="#7c3aed"><animate attributeName="cx" values="35;33;35" dur="2s" repeatCount="indefinite"/></ellipse>
            <ellipse cx="65" cy="128" rx="10" ry="6" fill="#7c3aed"><animate attributeName="cx" values="65;67;65" dur="2s" begin="0.5s" repeatCount="indefinite"/></ellipse>
            <!-- ê·¸ë¦¼ì -->
            <ellipse cx="50" cy="134" rx="30" ry="4" fill="#000" opacity=".08"/>
            <!-- ëª¸í†µ (ìŒí‘œ ë¨¸ë¦¬) -->
            <ellipse cx="50" cy="82" rx="32" ry="28" fill="url(#mGd1)"/>
            <ellipse cx="50" cy="80" rx="28" ry="24" fill="#a78bfa"/>
            <!-- ìŒí‘œ ê¸°ë‘¥+ê¹ƒë°œ -->
            <rect x="70" y="28" width="7" height="54" rx="3" fill="#8b5cf6"/>
            <path d="M77 28c0 0 14-4 14 10s-14 10-14 10" fill="#c4b5fd" stroke="#7c3aed" stroke-width="1.5"/>
            <!-- íŒ” (ë¶“ ë“¤ê³  ìˆìŒ) -->
            <ellipse cx="22" cy="86" rx="8" ry="6" fill="#8b5cf6"><animate attributeName="ry" values="6;7;6" dur="1.5s" repeatCount="indefinite"/></ellipse>
            <rect x="12" y="72" width="4" height="18" rx="2" fill="#f59e0b" transform="rotate(-15 14 80)"/>
            <path d="M11 72l2-6 2 6" fill="#ef4444"/>
            <!-- ëˆˆ -->
            <circle cx="38" cy="74" r="8" fill="#fff"/><circle cx="62" cy="74" r="8" fill="#fff"/>
            <circle cx="40" cy="75" r="4" fill="#2e1065"><animate attributeName="ry" values="4;0.5;4" dur=".15s" begin="3s;bkD1.end+4s" id="bkD1" fill="freeze"/></circle>
            <circle cx="60" cy="75" r="4" fill="#2e1065"><animate attributeName="ry" values="4;0.5;4" dur=".15s" begin="3s;bkD1.end+4s" fill="freeze"/></circle>
            <circle cx="42" cy="72" r="1.5" fill="#fff" opacity=".9"/>
            <circle cx="62" cy="72" r="1.5" fill="#fff" opacity=".9"/>
            <!-- ëº¨ -->
            <ellipse cx="28" cy="84" rx="5" ry="3" fill="#f9a8d4" opacity=".4"/>
            <ellipse cx="72" cy="84" rx="5" ry="3" fill="#f9a8d4" opacity=".4"/>
            <!-- ì… -->
            <path d="M40 90 Q50 97 60 90" fill="none" stroke="#4c1d95" stroke-width="2" stroke-linecap="round" id="mascot-draw-mouth"/>
            <!-- ë¨¸ë¦¬ ì¥ì‹: ë¯¸ë‹ˆ ìŒí‘œ -->
            <g transform="translate(42,48)"><animateTransform attributeName="transform" type="rotate" values="0 8 8;10 8 8;0 8 8;-10 8 8;0 8 8" dur="4s" repeatCount="indefinite" additive="sum"/><ellipse cx="4" cy="12" rx="4" ry="3" fill="#fbbf24"/><rect x="7" y="2" width="2" height="10" rx="1" fill="#fbbf24"/><path d="M9 2c2-1 4 0 4 2s-2 3-4 2" fill="#fde68a"/></g>
          </svg>
        </div>
        <div class="draw-area">
          <div class="draw-info" id="draw-info">ì†ê°€ë½ìœ¼ë¡œ ê·¸ë ¤ë³´ì„¸ìš”! ìœ„ë¡œ ê°€ë©´ ë†’ì€ ì†Œë¦¬, ì•„ë˜ë¡œ ê°€ë©´ ë‚®ì€ ì†Œë¦¬</div>
          <div class="draw-canvas-wrap" id="draw-wrap">
            <div class="draw-guide">
              <div class="draw-note"><svg viewBox="0 0 24 24" fill="#7c3aed"><ellipse cx="9" cy="18" rx="5" ry="3.5"/><rect x="13" y="4" width="2.5" height="14" rx="1"/><path d="M15.5 4c3-1 5.5 0 5.5 3s-2.5 4-5.5 3z"/></svg>ë¼</div>
              <div class="draw-note"><svg viewBox="0 0 24 24" fill="#8b5cf6"><ellipse cx="9" cy="18" rx="5" ry="3.5"/><rect x="13" y="5" width="2.5" height="13" rx="1"/></svg>ì†”</div>
              <div class="draw-note"><svg viewBox="0 0 24 24" fill="#a78bfa"><ellipse cx="7" cy="18" rx="5" ry="3.5"/><rect x="11" y="4" width="2.5" height="14" rx="1"/><ellipse cx="17" cy="16" rx="5" ry="3.5"/><rect x="21" y="4" width="2.5" height="12" rx="1"/><path d="M13.5 4h10" stroke="#a78bfa" stroke-width="2.5"/></svg>ë¯¸</div>
              <div class="draw-note"><svg viewBox="0 0 24 24" fill="#7c3aed"><ellipse cx="9" cy="18" rx="5" ry="3.5"/><rect x="13" y="5" width="2.5" height="13" rx="1"/></svg>ë ˆ</div>
              <div class="draw-note"><svg viewBox="0 0 24 24" fill="#8b5cf6"><ellipse cx="9" cy="18" rx="5" ry="3.5"/><rect x="13" y="4" width="2.5" height="14" rx="1"/><path d="M15.5 4c3-1 5.5 0 5.5 3s-2.5 4-5.5 3z"/></svg>ë„</div>
            </div>
            <svg id="draw-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
          </div>
        </div>
      </div>

      <!-- ëª¸ìœ¼ë¡œ ë“œëŸ¼ -->
      <div class="game-view drum-view" id="drum-view">
        <div class="mascot-wrap" id="mascot-drum" style="top:8px;right:16px">
          <div class="mascot-speech" id="mascot-drum-speech">ë¦¬ë“¬ì„ ë§ì¶°ë´!</div>
          <svg class="mascot-svg" viewBox="0 0 100 140" width="90" height="126">
            <defs><linearGradient id="mGd2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#7c3aed"/></linearGradient></defs>
            <!-- ë‹¤ë¦¬ -->
            <ellipse cx="35" cy="128" rx="10" ry="6" fill="#7c3aed"><animate attributeName="cx" values="35;33;35" dur="1.2s" repeatCount="indefinite"/></ellipse>
            <ellipse cx="65" cy="128" rx="10" ry="6" fill="#7c3aed"><animate attributeName="cx" values="65;67;65" dur="1.2s" begin="0.3s" repeatCount="indefinite"/></ellipse>
            <ellipse cx="50" cy="134" rx="30" ry="4" fill="#000" opacity=".08"/>
            <!-- ëª¸í†µ -->
            <ellipse cx="50" cy="82" rx="32" ry="28" fill="url(#mGd2)"/>
            <ellipse cx="50" cy="80" rx="28" ry="24" fill="#a78bfa"/>
            <!-- ìŒí‘œ ê¸°ë‘¥+ê¹ƒë°œ -->
            <rect x="70" y="28" width="7" height="54" rx="3" fill="#8b5cf6"/>
            <path d="M77 28c0 0 14-4 14 10s-14 10-14 10" fill="#c4b5fd" stroke="#7c3aed" stroke-width="1.5"/>
            <!-- íŒ” (ë“œëŸ¼ìŠ¤í‹±) -->
            <ellipse cx="22" cy="82" rx="8" ry="6" fill="#8b5cf6"><animate attributeName="cy" values="82;78;82" dur="0.6s" repeatCount="indefinite"/></ellipse>
            <rect x="8" y="70" width="3" height="22" rx="1.5" fill="#d4a06a" transform="rotate(-20 10 80)"/>
            <circle cx="8" cy="70" r="3" fill="#f59e0b" transform="rotate(-20 10 80)"/>
            <ellipse cx="78" cy="82" rx="8" ry="6" fill="#8b5cf6"><animate attributeName="cy" values="82;78;82" dur="0.6s" begin="0.3s" repeatCount="indefinite"/></ellipse>
            <!-- ëˆˆ -->
            <circle cx="38" cy="74" r="8" fill="#fff"/><circle cx="62" cy="74" r="8" fill="#fff"/>
            <circle cx="40" cy="75" r="4" fill="#2e1065"><animate attributeName="ry" values="4;0.5;4" dur=".15s" begin="3.5s;bkDm1.end+5s" id="bkDm1" fill="freeze"/></circle>
            <circle cx="60" cy="75" r="4" fill="#2e1065"><animate attributeName="ry" values="4;0.5;4" dur=".15s" begin="3.5s;bkDm1.end+5s" fill="freeze"/></circle>
            <circle cx="42" cy="72" r="1.5" fill="#fff" opacity=".9"/>
            <circle cx="62" cy="72" r="1.5" fill="#fff" opacity=".9"/>
            <!-- ëº¨ -->
            <ellipse cx="28" cy="84" rx="5" ry="3" fill="#f9a8d4" opacity=".4"/>
            <ellipse cx="72" cy="84" rx="5" ry="3" fill="#f9a8d4" opacity=".4"/>
            <!-- ì… -->
            <path d="M40 90 Q50 97 60 90" fill="none" stroke="#4c1d95" stroke-width="2" stroke-linecap="round" id="mascot-drum-mouth"/>
            <!-- í—¤ë“œí° -->
            <path d="M22 68c0-20 12-32 28-32s28 12 28 32" fill="none" stroke="#1e1b4b" stroke-width="5" stroke-linecap="round"/>
            <rect x="16" y="62" width="10" height="14" rx="5" fill="#1e1b4b"/><rect x="74" y="62" width="10" height="14" rx="5" fill="#1e1b4b"/>
            <rect x="18" y="64" width="6" height="10" rx="3" fill="#312e81"/><rect x="76" y="64" width="6" height="10" rx="3" fill="#312e81"/>
          </svg>
        </div>
        <div class="drum-area">
          <div class="drum-pattern-bar">
            <div class="drum-pattern-label">ë¦¬ë“¬:</div>
            <div class="drum-beats" id="drum-beats"></div>
          </div>
          <div class="drum-score-bar">
            <span>ì ìˆ˜: <b id="drum-score">0</b></span>
            <span>ì½¤ë³´: <b id="drum-combo">0</b></span>
            <span id="drum-status">ì¤€ë¹„!</span>
          </div>
          <div class="drum-pads" id="drum-pads">
            <div class="drum-pad pad-clap" onclick="hitDrum(0)" data-drum="0">
              <svg viewBox="0 0 120 100"><g fill="#fff">
                <!-- ì™¼ì† -->
                <path d="M18 72c-2 0-5-2-5-6v-8l2-20c1-3 3-4 5-3s3 3 2 6l-1 10 1-14c1-3 3-5 5-4s3 3 2 6l-1 12 2-13c1-3 3-4 5-3s3 3 2 5l-2 13 2-10c1-3 3-4 5-3s2 3 1 6l-4 22c-1 4-4 7-8 7z"/>
                <!-- ì˜¤ë¥¸ì† -->
                <path d="M102 72c2 0 5-2 5-6v-8l-2-20c-1-3-3-4-5-3s-3 3-2 6l1 10-1-14c-1-3-3-5-5-4s-3 3-2 6l1 12-2-13c-1-3-3-4-5-3s-3 3-2 5l2 13-2-10c-1-3-3-4-5-3s-2 3-1 6l4 22c1 4 4 7 8 7z"/>
                <!-- ì¶©ëŒ ì´í™íŠ¸ -->
                <polygon points="60,28 62,36 70,36 64,41 66,50 60,44 54,50 56,41 50,36 58,36" fill="#fff" opacity=".9"><animate attributeName="opacity" values=".9;.4;.9" dur="1s" repeatCount="indefinite"/></polygon>
                <line x1="60" y1="18" x2="60" y2="10" stroke="#fff" stroke-width="3" stroke-linecap="round" opacity=".7"/>
                <line x1="48" y1="24" x2="42" y2="18" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity=".6"/>
                <line x1="72" y1="24" x2="78" y2="18" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity=".6"/>
                <circle cx="45" cy="14" r="2" opacity=".5"/><circle cx="75" cy="14" r="2" opacity=".5"/>
              </g></svg>
              <div class="drum-pad-label">ë°•ìˆ˜</div>
            </div>
            <div class="drum-pad pad-stomp" onclick="hitDrum(1)" data-drum="1">
              <svg viewBox="0 0 120 100"><g fill="#fff">
                <!-- ìš´ë™í™” -->
                <path d="M25 42h65c8 0 14 5 14 12v8c0 3-1 5-3 6H20c-4 0-7-3-7-7v-5c0-8 5-14 12-14z" opacity=".95"/>
                <path d="M25 42c0-8 8-15 18-15h10c6 0 12 4 14 10" fill="none" stroke="#fff" stroke-width="3.5" stroke-linecap="round"/>
                <rect x="30" y="48" width="55" height="4" rx="2" fill="rgba(0,0,0,.15)"/>
                <circle cx="40" cy="56" r="3" fill="rgba(0,0,0,.12)"/><circle cx="52" cy="56" r="3" fill="rgba(0,0,0,.12)"/><circle cx="64" cy="56" r="3" fill="rgba(0,0,0,.12)"/>
                <!-- ë°”ë‹¥ ì¶©ê²©íŒŒ -->
                <rect x="15" y="70" width="90" height="4" rx="2" opacity=".6"/>
                <path d="M30 80c10-3 20 0 30-3s20 0 30-3" fill="none" stroke="#fff" stroke-width="2" opacity=".5">
                  <animate attributeName="d" values="M30 80c10-3 20 0 30-3s20 0 30-3;M30 82c10 3 20 0 30 3s20 0 30 3;M30 80c10-3 20 0 30-3s20 0 30-3" dur="0.8s" repeatCount="indefinite"/></path>
                <path d="M35 88c8-2 16 0 25-2s16 0 25-2" fill="none" stroke="#fff" stroke-width="1.5" opacity=".3">
                  <animate attributeName="d" values="M35 88c8-2 16 0 25-2s16 0 25-2;M35 90c8 2 16 0 25 2s16 0 25 2;M35 88c8-2 16 0 25-2s16 0 25-2" dur="1s" repeatCount="indefinite"/></path>
                <!-- í™”ì‚´í‘œ (ì•„ë˜ë¡œ) -->
                <polygon points="60,4 50,16 55,16 55,30 65,30 65,16 70,16" opacity=".5"><animate attributeName="opacity" values=".5;.2;.5" dur="0.6s" repeatCount="indefinite"/></polygon>
              </g></svg>
              <div class="drum-pad-label">ë°œêµ¬ë¥´ê¸°</div>
            </div>
            <div class="drum-pad pad-knee" onclick="hitDrum(2)" data-drum="2">
              <svg viewBox="0 0 120 100"><g fill="#fff">
                <!-- ë‹¤ë¦¬ (ë¬´ë¦ êµ¬ë¶€ë¦°) -->
                <path d="M20 10c0 0 4 25 8 40c2 8 12 14 22 14" stroke="#fff" stroke-width="8" fill="none" stroke-linecap="round" opacity=".7"/>
                <path d="M50 64c10 0 18 4 22 15l8 18" stroke="#fff" stroke-width="8" fill="none" stroke-linecap="round" opacity=".7"/>
                <!-- ë¬´ë¦ ì› -->
                <circle cx="50" cy="60" r="14" fill="#fff" opacity=".3" stroke="#fff" stroke-width="2"/>
                <!-- ì† (ë•Œë¦¬ëŠ”) -->
                <path d="M95 20c-2-1-4 0-5 2l-10 18-6 10" stroke="#fff" stroke-width="4" fill="none" stroke-linecap="round"/>
                <path d="M82 32l-14 12" stroke="#fff" stroke-width="4" fill="none" stroke-linecap="round"/>
                <ellipse cx="68" cy="46" rx="10" ry="7" fill="#fff" opacity=".8" transform="rotate(-20 68 46)"/>
                <!-- ì¶©ê²© ì´í™íŠ¸ -->
                <line x1="52" y1="42" x2="55" y2="32" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity=".7"/>
                <line x1="42" y1="46" x2="36" y2="38" stroke="#fff" stroke-width="2" stroke-linecap="round" opacity=".5"/>
                <line x1="60" y1="44" x2="66" y2="36" stroke="#fff" stroke-width="2" stroke-linecap="round" opacity=".5"/>
                <circle cx="50" cy="46" r="3" opacity=".6"><animate attributeName="r" values="3;5;3" dur="0.8s" repeatCount="indefinite"/><animate attributeName="opacity" values=".6;.2;.6" dur="0.8s" repeatCount="indefinite"/></circle>
              </g></svg>
              <div class="drum-pad-label">ë¬´ë¦ì¹˜ê¸°</div>
            </div>
            <div class="drum-pad pad-tongue" onclick="hitDrum(3)" data-drum="3">
              <svg viewBox="0 0 120 100"><g fill="#fff">
                <!-- ì–¼êµ´ ìœ¤ê³½ -->
                <circle cx="60" cy="42" r="30" fill="none" stroke="#fff" stroke-width="3" opacity=".6"/>
                <!-- ëˆˆ -->
                <circle cx="48" cy="34" r="4"/><circle cx="72" cy="34" r="4"/>
                <circle cx="49" cy="33" r="1.5" fill="rgba(0,0,0,.3)"/><circle cx="73" cy="33" r="1.5" fill="rgba(0,0,0,.3)"/>
                <!-- ì… (í¬ê²Œ ë²Œë¦°) -->
                <ellipse cx="60" cy="54" rx="16" ry="10" fill="#fff" opacity=".3" stroke="#fff" stroke-width="2"/>
                <!-- í˜€ -->
                <ellipse cx="60" cy="60" rx="8" ry="10" fill="#fff" opacity=".5">
                  <animate attributeName="ry" values="10;12;10" dur="0.6s" repeatCount="indefinite"/></ellipse>
                <!-- ì†Œë¦¬íŒŒ -->
                <path d="M92 42c4-6 4-14 0-20" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity=".7">
                  <animate attributeName="opacity" values=".7;.3;.7" dur="0.8s" repeatCount="indefinite"/></path>
                <path d="M98 46c6-8 6-22 0-28" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" opacity=".5">
                  <animate attributeName="opacity" values=".5;.2;.5" dur="1s" repeatCount="indefinite"/></path>
                <path d="M104 50c8-12 8-28 0-36" fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round" opacity=".3"/>
                <!-- ë”±! í…ìŠ¤íŠ¸ -->
                <text x="60" y="90" text-anchor="middle" font-size="14" font-weight="900" fill="#fff" opacity=".6">ë”±!</text>
              </g></svg>
              <div class="drum-pad-label">í˜€ì°¨ê¸°</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ëƒ‰ì¥ê³  ì˜¤ì¼€ìŠ¤íŠ¸ë¼ -->
      <div class="game-view fridge-view" id="fridge-view">
        <div class="mascot-wrap" id="mascot-fridge" style="top:8px;right:16px">
          <div class="mascot-speech" id="mascot-fridge-speech">ì£¼ë°© ì—°ì£¼ ì‹œì‘!</div>
          <svg class="mascot-svg" viewBox="0 0 100 140" width="90" height="126">
            <defs><linearGradient id="mGd3" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#7c3aed"/></linearGradient></defs>
            <!-- ë‹¤ë¦¬ -->
            <ellipse cx="35" cy="128" rx="10" ry="6" fill="#7c3aed"><animate attributeName="cx" values="35;33;35" dur="2s" repeatCount="indefinite"/></ellipse>
            <ellipse cx="65" cy="128" rx="10" ry="6" fill="#7c3aed"><animate attributeName="cx" values="65;67;65" dur="2s" begin="0.5s" repeatCount="indefinite"/></ellipse>
            <ellipse cx="50" cy="134" rx="30" ry="4" fill="#000" opacity=".08"/>
            <!-- ëª¸í†µ -->
            <ellipse cx="50" cy="82" rx="32" ry="28" fill="url(#mGd3)"/>
            <ellipse cx="50" cy="80" rx="28" ry="24" fill="#a78bfa"/>
            <!-- ìŒí‘œ ê¸°ë‘¥+ê¹ƒë°œ -->
            <rect x="70" y="28" width="7" height="54" rx="3" fill="#8b5cf6"/>
            <path d="M77 28c0 0 14-4 14 10s-14 10-14 10" fill="#c4b5fd" stroke="#7c3aed" stroke-width="1.5"/>
            <!-- íŒ” (ìš”ë¦¬ì‚¬ ì£¼ê±±) -->
            <ellipse cx="22" cy="86" rx="8" ry="6" fill="#8b5cf6"/>
            <rect x="6" y="68" width="3.5" height="24" rx="1.5" fill="#a8a29e" transform="rotate(-12 8 80)"/>
            <ellipse cx="7" cy="66" rx="5" ry="3.5" fill="#cbd5e1" transform="rotate(-12 8 66)"/>
            <!-- ìš”ë¦¬ì‚¬ ëª¨ì -->
            <ellipse cx="50" cy="50" rx="26" ry="6" fill="#fff" stroke="#e2e8f0" stroke-width="1"/>
            <path d="M28 50c0-16 10-26 22-26s22 10 22 26" fill="#fff" stroke="#e2e8f0" stroke-width="1"/>
            <ellipse cx="42" cy="32" rx="6" ry="8" fill="#f8fafc"/>
            <ellipse cx="56" cy="30" rx="7" ry="9" fill="#f8fafc"/>
            <!-- ëˆˆ -->
            <circle cx="38" cy="74" r="8" fill="#fff"/><circle cx="62" cy="74" r="8" fill="#fff"/>
            <circle cx="40" cy="75" r="4" fill="#2e1065"><animate attributeName="ry" values="4;0.5;4" dur=".15s" begin="4s;bkF1.end+5s" id="bkF1" fill="freeze"/></circle>
            <circle cx="60" cy="75" r="4" fill="#2e1065"><animate attributeName="ry" values="4;0.5;4" dur=".15s" begin="4s;bkF1.end+5s" fill="freeze"/></circle>
            <circle cx="42" cy="72" r="1.5" fill="#fff" opacity=".9"/>
            <circle cx="62" cy="72" r="1.5" fill="#fff" opacity=".9"/>
            <!-- ëº¨ -->
            <ellipse cx="28" cy="84" rx="5" ry="3" fill="#f9a8d4" opacity=".4"/>
            <ellipse cx="72" cy="84" rx="5" ry="3" fill="#f9a8d4" opacity=".4"/>
            <!-- ì… -->
            <path d="M40 90 Q50 97 60 90" fill="none" stroke="#4c1d95" stroke-width="2" stroke-linecap="round" id="mascot-fridge-mouth"/>
          </svg>
        </div>
        <div class="fridge-area">
          <div class="fridge-items" id="fridge-items"></div>
          <div class="fridge-seq">
            <div class="fridge-seq-label">ì‹œí€€ì„œ</div>
            <div class="fridge-seq-slots" id="fridge-slots">
              <div class="fridge-slot" onclick="clearSlot(0)" id="fslot-0"></div>
              <div class="fridge-slot" onclick="clearSlot(1)" id="fslot-1"></div>
              <div class="fridge-slot" onclick="clearSlot(2)" id="fslot-2"></div>
              <div class="fridge-slot" onclick="clearSlot(3)" id="fslot-3"></div>
            </div>
            <button class="fridge-play-btn" onclick="playSequence()">â–¶ ì¬ìƒ</button>
          </div>
        </div>
      </div>

      <!-- ë‚´ ê¸°ë¡ -->
      <div class="game-view record-view" id="record-view">
        <div class="mascot-wrap" id="mascot-record" style="bottom:16px;right:16px">
          <div class="mascot-speech" id="mascot-record-speech">ë©‹ì§„ ìŒì•…ê°€!</div>
          <svg class="mascot-svg" viewBox="0 0 100 140" width="90" height="126">
            <defs><linearGradient id="mGd4" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#7c3aed"/></linearGradient></defs>
            <!-- ë‹¤ë¦¬ -->
            <ellipse cx="35" cy="128" rx="10" ry="6" fill="#7c3aed"><animate attributeName="cx" values="35;33;35" dur="2s" repeatCount="indefinite"/></ellipse>
            <ellipse cx="65" cy="128" rx="10" ry="6" fill="#7c3aed"><animate attributeName="cx" values="65;67;65" dur="2s" begin="0.5s" repeatCount="indefinite"/></ellipse>
            <ellipse cx="50" cy="134" rx="30" ry="4" fill="#000" opacity=".08"/>
            <!-- ëª¸í†µ -->
            <ellipse cx="50" cy="82" rx="32" ry="28" fill="url(#mGd4)"/>
            <ellipse cx="50" cy="80" rx="28" ry="24" fill="#a78bfa"/>
            <!-- ìŒí‘œ ê¸°ë‘¥+ê¹ƒë°œ -->
            <rect x="70" y="28" width="7" height="54" rx="3" fill="#8b5cf6"/>
            <path d="M77 28c0 0 14-4 14 10s-14 10-14 10" fill="#c4b5fd" stroke="#7c3aed" stroke-width="1.5"/>
            <!-- íŒ” (íŠ¸ë¡œí”¼ ë“¤ê³  ìˆìŒ) -->
            <ellipse cx="22" cy="86" rx="8" ry="6" fill="#8b5cf6"/>
            <g transform="translate(4,62)">
              <rect x="4" y="8" width="12" height="10" rx="2" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/>
              <path d="M2 8h3v5c0 2-1 3-3 3z" fill="#fde68a"/><path d="M16 8h3c0 0 0 6-3 8v-8z" fill="#fde68a"/>
              <rect x="7" y="18" width="6" height="3" rx="1" fill="#f59e0b"/>
              <rect x="5" y="21" width="10" height="2" rx="1" fill="#d97706"/>
              <text x="10" y="16" text-anchor="middle" font-size="7" fill="#92400e" font-weight="bold">1</text>
            </g>
            <!-- ì™•ê´€ -->
            <g transform="translate(35,42)">
              <polygon points="0,12 4,0 8,8 12,0 16,8 20,0 24,8 28,0 30,12" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/>
              <circle cx="4" cy="2" r="2" fill="#ef4444"/><circle cx="15" cy="0" r="2" fill="#3b82f6"/><circle cx="26" cy="2" r="2" fill="#22c55e"/>
            </g>
            <!-- ëˆˆ -->
            <circle cx="38" cy="74" r="8" fill="#fff"/><circle cx="62" cy="74" r="8" fill="#fff"/>
            <circle cx="40" cy="75" r="4" fill="#2e1065"><animate attributeName="ry" values="4;0.5;4" dur=".15s" begin="4s;bkR1.end+5s" id="bkR1" fill="freeze"/></circle>
            <circle cx="60" cy="75" r="4" fill="#2e1065"><animate attributeName="ry" values="4;0.5;4" dur=".15s" begin="4s;bkR1.end+5s" fill="freeze"/></circle>
            <circle cx="42" cy="72" r="1.5" fill="#fff" opacity=".9"/>
            <circle cx="62" cy="72" r="1.5" fill="#fff" opacity=".9"/>
            <!-- ëº¨ -->
            <ellipse cx="28" cy="84" rx="5" ry="3" fill="#f9a8d4" opacity=".4"/>
            <ellipse cx="72" cy="84" rx="5" ry="3" fill="#f9a8d4" opacity=".4"/>
            <!-- ì… -->
            <path d="M40 90 Q50 97 60 90" fill="none" stroke="#4c1d95" stroke-width="2" stroke-linecap="round" id="mascot-record-mouth"/>
          </svg>
        </div>
        <div class="records-area">
          <div class="record-card">
            <h3>ğŸ† ì¢…í•© ì„±ì </h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-total">0</div><div class="record-label">ì´ í™œë™</div></div>
              <div class="record-item"><div class="record-num" id="r-level">1</div><div class="record-label">ë ˆë²¨</div></div>
              <div class="record-item"><div class="record-num" id="r-xp">0</div><div class="record-label">ê²½í—˜ì¹˜</div></div>
            </div>
          </div>
          <div class="record-card">
            <h3>ğŸ¨ ì†Œë¦¬ ê·¸ë¦¼</h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-draw-count">0</div><div class="record-label">ê·¸ë¦° ê³¡</div></div>
              <div class="record-item"><div class="record-num" id="r-draw-notes">0</div><div class="record-label">ì´ ìŒí‘œ</div></div>
              <div class="record-item"><div class="record-num" id="r-draw-best">0</div><div class="record-label">ìµœì¥ ê³¡</div></div>
            </div>
          </div>
          <div class="record-card">
            <h3>ğŸ¥ ëª¸ìœ¼ë¡œ ë“œëŸ¼</h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-drum-score">0</div><div class="record-label">ìµœê³  ì ìˆ˜</div></div>
              <div class="record-item"><div class="record-num" id="r-drum-perfect">0</div><div class="record-label">ì´ Perfect</div></div>
              <div class="record-item"><div class="record-num" id="r-drum-combo">0</div><div class="record-label">ìµœê³  ì½¤ë³´</div></div>
            </div>
          </div>
          <div class="record-card">
            <h3>ğŸ¹ ëƒ‰ì¥ê³  ì˜¤ì¼€ìŠ¤íŠ¸ë¼</h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-fridge-plays">0</div><div class="record-label">ì—°ì£¼ íšŸìˆ˜</div></div>
              <div class="record-item"><div class="record-num" id="r-fridge-items">0</div><div class="record-label">ì‚¬ìš© ë¬¼ê±´</div></div>
              <div class="record-item"><div class="record-num" id="r-fridge-loops">0</div><div class="record-label">ë£¨í”„ ì¬ìƒ</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="right-panel" id="right-panel">
      <button class="action-btn btn-cyan" id="act1" onclick="actionBtn(1)"><span class="icon">â–¶</span>ì¬ìƒ</button>
      <button class="action-btn btn-green" id="act2" onclick="actionBtn(2)"><span class="icon">ğŸ—‘</span>ì§€ìš°ê¸°</button>
      <button class="action-btn btn-red" id="act3" onclick="actionBtn(3)"><span class="icon">ğŸ’¾</span>ì €ì¥</button>
    </div>
  </div>

  <!-- íˆì–´ë¡œ: ë¹„íŠ¸ ëŸ¬ì‹œ (ë¹„íŠ¸ë§¤ë‹ˆì•„ ìŠ¤íƒ€ì¼) -->
  <div id="hero-game" class="hero-game hidden">
    <div class="hg-header">
      <div class="hg-stat">
        <svg viewBox="0 0 24 24" width="22" height="22" style="vertical-align:middle"><polygon points="12,2 15,9 22,9 16,14 18,22 12,17 6,22 8,14 2,9 9,9" fill="#fbbf24"/></svg>
        <span id="hg-score">0</span>ì 
      </div>
      <div class="hg-stat">Lv.<span id="hg-level">1</span></div>
      <div class="hg-hearts" id="hg-hearts">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
      <div class="hg-ctrls">
        <button class="hg-ctrl-btn" onclick="hgPause()">â¸</button>
        <button class="hg-ctrl-btn" onclick="hgExit()">âœ•</button>
      </div>
    </div>
    <div class="hg-arena" id="hg-arena">
      <!-- 4ë ˆì¸ ë°°ê²½ -->
      <div class="hg-lane-bg" data-l="0"></div>
      <div class="hg-lane-bg" data-l="1"></div>
      <div class="hg-lane-bg" data-l="2"></div>
      <div class="hg-lane-bg" data-l="3"></div>
      <!-- íŒì • ë¼ì¸ -->
      <div class="hg-judge-line"></div>
      <!-- BPM í‘œì‹œ -->
      <div class="hg-bpm" id="hg-bpm">â™© 90 BPM</div>
      <!-- ë²„íŠ¼ í–‰ -->
      <div class="hg-btn-row">
        <div class="hg-btn" data-l="0" onclick="hgTap(0)" id="hg-btn-0">
          <div class="note-icon"><svg viewBox="0 0 32 32" width="36" height="36"><ellipse cx="12" cy="24" rx="7" ry="5" fill="#fca5a5"/><rect x="18" y="6" width="3" height="18" rx="1.5" fill="#fca5a5"/><path d="M21 6c4-1.5 8 0 8 4s-4 6-8 5z" fill="#fca5a5" opacity=".8"/></svg></div>
          <div class="note-label">D</div>
        </div>
        <div class="hg-btn" data-l="1" onclick="hgTap(1)" id="hg-btn-1">
          <div class="note-icon"><svg viewBox="0 0 40 32" width="36" height="36"><ellipse cx="10" cy="25" rx="6" ry="4.5" fill="#93c5fd"/><rect x="15" y="5" width="3" height="20" rx="1.5" fill="#93c5fd"/><ellipse cx="28" cy="23" rx="6" ry="4.5" fill="#93c5fd"/><rect x="33" y="5" width="3" height="18" rx="1.5" fill="#93c5fd"/><rect x="18" y="5" width="18" height="3.5" rx="1.5" fill="#93c5fd"/></svg></div>
          <div class="note-label">F</div>
        </div>
        <div class="hg-btn" data-l="2" onclick="hgTap(2)" id="hg-btn-2">
          <div class="note-icon"><svg viewBox="0 0 32 32" width="36" height="36"><ellipse cx="12" cy="24" rx="7" ry="5" fill="#86efac"/><rect x="18" y="6" width="3" height="18" rx="1.5" fill="#86efac"/><path d="M21 6c4-1.5 8 0 8 4s-4 6-8 5z" fill="#86efac" opacity=".8"/></svg></div>
          <div class="note-label">J</div>
        </div>
        <div class="hg-btn" data-l="3" onclick="hgTap(3)" id="hg-btn-3">
          <div class="note-icon"><svg viewBox="0 0 40 32" width="36" height="36"><ellipse cx="10" cy="25" rx="6" ry="4.5" fill="#fde68a"/><rect x="15" y="5" width="3" height="20" rx="1.5" fill="#fde68a"/><ellipse cx="28" cy="23" rx="6" ry="4.5" fill="#fde68a"/><rect x="33" y="5" width="3" height="18" rx="1.5" fill="#fde68a"/><rect x="18" y="5" width="18" height="3.5" rx="1.5" fill="#fde68a"/></svg></div>
          <div class="note-label">K</div>
        </div>
      </div>
    </div>
    <!-- ê²Œì„ ì˜¤ë²„ -->
    <div id="hg-over" class="hg-overlay hidden">
      <div class="hg-overlay-box">
        <h2>ğŸµ ê²Œì„ ë!</h2>
        <div class="score">â­ <span id="hg-final-score">0</span>ì </div>
        <div class="stats">
          <div class="stat-item"><div class="stat-val" id="hg-final-combo">0</div><div class="stat-label">ìµœëŒ€ ì½¤ë³´</div></div>
          <div class="stat-item"><div class="stat-val" id="hg-final-perfect">0</div><div class="stat-label">Perfect</div></div>
          <div class="stat-item"><div class="stat-val" id="hg-final-level">1</div><div class="stat-label">ë ˆë²¨</div></div>
        </div>
        <div class="msg" id="hg-over-msg">ì˜í–ˆì–´ìš”!</div>
        <button class="btn-retry" onclick="hgRestart()">ğŸ”„ ë‹¤ì‹œí•˜ê¸°</button>
        <button class="btn-exit" onclick="hgExit()">ğŸ  ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
    <!-- ì¼ì‹œì •ì§€ -->
    <div id="hg-pause" class="hg-overlay hidden">
      <div class="hg-overlay-box">
        <h2>â¸ ì¼ì‹œì •ì§€</h2>
        <button class="btn-retry" onclick="hgPause()">â–¶ ê³„ì†í•˜ê¸°</button>
        <button class="btn-exit" onclick="hgExit()">ğŸ  ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
    <!-- ì¹´ìš´íŠ¸ë‹¤ìš´ -->
    <div class="hg-countdown" id="hg-countdown" style="display:none"></div>
  </div>
</div>

<!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
<div id="admin-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-head"><h3>âš™ ì„¤ì •</h3><button class="modal-close" onclick="hideAdmin()">Ã—</button></div>
    <div class="modal-body">
      <div class="modal-section">
        <h4>ğŸ‘¤ í”„ë¡œí•„</h4>
        <input class="modal-input" id="adm-name" placeholder="ì´ë¦„ ì…ë ¥" maxlength="10">
        <button class="modal-btn" onclick="saveProfileAdmin()">ì €ì¥</button>
      </div>
      <div class="modal-section">
        <h4>ğŸ”„ ì´ˆê¸°í™”</h4>
        <button class="modal-btn" style="background:linear-gradient(145deg,#ef4444,#dc2626)" onclick="resetAll()">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>
</div>

<!-- ìºë¦­í„° ëª¨ë‹¬ -->
<div id="char-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-head"><h3>ğŸ­ ìºë¦­í„° ì„ íƒ</h3><button class="modal-close" onclick="hideCharModal()">Ã—</button></div>
    <div class="modal-body">
      <div class="char-grid" id="char-grid"></div>
    </div>
  </div>
</div>

<script>
// ===== ì „ì—­ ë³€ìˆ˜ =====
let currentTab = 'draw';
let soundEnabled = true;
const LS = localStorage;

// ===== SFX (ìŒì•…/ë¦¬ë“¬ í†¤) =====
const SFX = {
  _ctx: null,
  _getCtx() { if (!this._ctx) try { this._ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} return this._ctx; },
  _play(fn) { if (!soundEnabled) return; const ctx = this._getCtx(); if (!ctx) return; if (ctx.state==='suspended') ctx.resume(); try{fn(ctx);}catch(e){} },
  // ë¦¬ë“¬ íƒ­ â€” ì§§ì€ í¼ì»¤ì…˜
  tap() { this._play(ctx => { const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.type='triangle';o.frequency.setValueAtTime(500,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(200,ctx.currentTime+.05); g.gain.setValueAtTime(.1,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.06); o.start();o.stop(ctx.currentTime+.06); }); },
  // ì„±ê³µ í™”ìŒ â€” ë©”ì´ì € íŠ¸ë¼ì´ì–´ë“œ
  chord() { this._play(ctx => { [523,659,784].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.type='sine';o.frequency.value=f; g.gain.setValueAtTime(.06,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.4); o.start();o.stop(ctx.currentTime+.4); }); }); },
  // ì‹¤íŒ¨ â€” ë§ˆì´ë„ˆ 2nd ë¶ˆí˜‘í™”ìŒ
  dissonance() { this._play(ctx => { [330,349].forEach(f => { const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.type='sawtooth';o.frequency.value=f; g.gain.setValueAtTime(.04,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.25); o.start();o.stop(ctx.currentTime+.25); }); }); },
  // Perfect â€” ë†’ì€ ì¢…ì†Œë¦¬
  perfect() { this._play(ctx => { [1047,1319,1568].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.type='sine';o.frequency.value=f; g.gain.setValueAtTime(.06,ctx.currentTime+i*.08);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.08+.3); o.start(ctx.currentTime+i*.08);o.stop(ctx.currentTime+i*.08+.3); }); }); },
  // íŒ¡íŒŒë ˆ â€” ê¸ˆê´€ ìƒí–‰
  fanfare() { this._play(ctx => { [523,659,784,1047].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.type='square';o.frequency.value=f; g.gain.setValueAtTime(.04,ctx.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.1+.25); o.start(ctx.currentTime+i*.1);o.stop(ctx.currentTime+i*.1+.25); }); }); },
  // ë ˆë²¨ì—… â€” ë¹ ë¥¸ ìŠ¤ì¼€ì¼
  levelup() { this._play(ctx => { [523,587,659,698,784,880,988,1047].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.type='sine';o.frequency.value=f; g.gain.setValueAtTime(.06,ctx.currentTime+i*.05);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.05+.12); o.start(ctx.currentTime+i*.05);o.stop(ctx.currentTime+i*.05+.12); }); }); },
  // ì½¤ë³´
  combo(n) { this._play(ctx => { const f=523+Math.min(n,10)*80; const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.type='sine';o.frequency.value=f; g.gain.setValueAtTime(.08,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.12); o.start();o.stop(ctx.currentTime+.12); }); },
  // ê²Œì„ì‹œì‘ â€” 4ìŒ ìƒí–‰
  gameStart() { this._play(ctx => { [392,523,659,784].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.type='sine';o.frequency.value=f; g.gain.setValueAtTime(.07,ctx.currentTime+i*.12);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.12+.2); o.start(ctx.currentTime+i*.12);o.stop(ctx.currentTime+i*.12+.2); }); }); },
  // ê²Œì„ë â€” í•˜í–‰
  gameOver() { this._play(ctx => { [523,440,349,262].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.type='sine';o.frequency.value=f; g.gain.setValueAtTime(.05,ctx.currentTime+i*.18);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.18+.25); o.start(ctx.currentTime+i*.18);o.stop(ctx.currentTime+i*.18+.25); }); }); }
};

// Web Audio Context
let audioCtx = null;
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

// íœíƒ€í† ë‹‰ ì£¼íŒŒìˆ˜ (ë„ë ˆë¯¸ì†”ë¼)
const PENTA = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25, 587.33, 659.25];
const PENTA_NAMES = ['ë„','ë ˆ','ë¯¸','ì†”','ë¼','ë„+','ë ˆ+','ë¯¸+'];

// í”„ë¡œí•„
let profile = {
  name: LS.getItem('musicName') || 'ìŒì•…ê°€',
  char: LS.getItem('musicChar') || 'ğŸ§’',
  totalXP: parseInt(LS.getItem('musicXP')) || 0
};

// ì†Œë¦¬ ê·¸ë¦¼ ìƒíƒœ
let draw = {
  isDrawing: false, replaying: false, points: [], paths: [], noteCount: 0,
  totalDrawn: parseInt(LS.getItem('drawCount')) || 0,
  totalNotes: parseInt(LS.getItem('drawNotes')) || 0,
  bestLength: parseInt(LS.getItem('drawBest')) || 0,
  currentOsc: null, currentGain: null
};

// ë“œëŸ¼ ìƒíƒœ
let drum = {
  score: 0, combo: 0, maxCombo: parseInt(LS.getItem('drumCombo')) || 0,
  totalPerfect: parseInt(LS.getItem('drumPerfect')) || 0,
  bestScore: parseInt(LS.getItem('drumBestScore')) || 0,
  pattern: [], currentBeat: -1, playing: false, timer: null, bpm: 100
};

// ëƒ‰ì¥ê³  ìƒíƒœ
let fridge = {
  sequence: [null, null, null, null], nextSlot: 0,
  totalPlays: parseInt(LS.getItem('fridgePlays')) || 0,
  totalItems: parseInt(LS.getItem('fridgeItems')) || 0,
  totalLoops: parseInt(LS.getItem('fridgeLoops')) || 0,
  isPlaying: false
};

// íˆì–´ë¡œ ìƒíƒœ
let hg = {
  score: 0, lives: 5, level: 1, running: false, paused: false,
  notes: [], spawnTimer: null, animId: null, combo: 0, maxCombo: 0,
  bpm: 100, perfects: 0
};

// ëƒ‰ì¥ê³  ë¬¼ê±´ ë°ì´í„° â€” ì‹¤ì œ ëƒ‰ì¥ê³  ì•ˆì— ìˆëŠ” ë¬¼ê±´ë“¤
const FRIDGE_SVG = [
  // ì£¼ìŠ¤ë³‘ (ì˜¤ë Œì§€ì£¼ìŠ¤ ìœ ë¦¬ë³‘)
  `<svg viewBox="0 0 80 80"><rect x="30" y="4" width="20" height="8" rx="4" fill="#f97316" stroke="#ea580c" stroke-width="1.5"/><path d="M30 12l-3 6v46c0 5 5 10 13 10s13-5 13-10V18l-3-6z" fill="#fdba74" opacity=".7" stroke="#f97316" stroke-width="2"/><rect x="30" y="18" width="20" height="44" rx="6" fill="#fed7aa" opacity=".4"/><path d="M34 24v34" stroke="#fff" stroke-width="2" opacity=".4" stroke-linecap="round"/><ellipse cx="40" cy="60" rx="10" ry="3" fill="#f97316" opacity=".25"/><text x="40" y="44" text-anchor="middle" font-size="10" fill="#ea580c" font-weight="700" opacity=".6">OJ</text><circle cx="40" cy="32" r="4" fill="#f97316" opacity=".3"/></svg>`,
  // ìš°ìœ íŒ©
  `<svg viewBox="0 0 80 80"><path d="M22 18l8-12h20l8 12z" fill="#dbeafe" stroke="#93c5fd" stroke-width="1.5"/><rect x="22" y="18" width="36" height="52" rx="3" fill="#eff6ff" stroke="#93c5fd" stroke-width="2"/><rect x="26" y="22" width="28" height="18" rx="2" fill="#bfdbfe"/><text x="40" y="36" text-anchor="middle" font-size="9" fill="#1d4ed8" font-weight="800">ìš°ìœ </text><path d="M32 42c2-2 6-2 8 0s6 2 8 0" fill="none" stroke="#93c5fd" stroke-width="1.5" opacity=".5"/><circle cx="36" cy="52" r="3" fill="#60a5fa" opacity=".2"/><circle cx="44" cy="56" r="2" fill="#60a5fa" opacity=".15"/></svg>`,
  // ìº”ìŒë£Œ (ë¹¨ê°„ íƒ„ì‚°ìº”)
  `<svg viewBox="0 0 80 80"><ellipse cx="40" cy="14" rx="16" ry="5" fill="#b91c1c" stroke="#991b1b" stroke-width="1.5"/><rect x="24" y="14" width="32" height="52" rx="0" fill="#dc2626" stroke="#b91c1c" stroke-width="1.5"/><ellipse cx="40" cy="66" rx="16" ry="5" fill="#b91c1c" stroke="#991b1b" stroke-width="1.5"/><ellipse cx="40" cy="14" rx="10" ry="3" fill="#a3a3a3" stroke="#737373" stroke-width="1"/><ellipse cx="43" cy="13" rx="3" ry="1.5" fill="#d4d4d4"/><rect x="26" y="26" width="28" height="14" rx="2" fill="#fca5a5" opacity=".4"/><path d="M30 20v44" stroke="#ef4444" stroke-width="1" opacity=".3"/><path d="M50 20v44" stroke="#fca5a5" stroke-width="1.5" opacity=".3"/><text x="40" y="48" text-anchor="middle" font-size="11" fill="#fff" font-weight="800" opacity=".8">cola</text></svg>`,
  // ìš”êµ¬ë¥´íŠ¸ (ì‘ì€ ì»µ)
  `<svg viewBox="0 0 80 80"><path d="M24 24h32l-3 44H27z" fill="#fbcfe8" stroke="#f472b6" stroke-width="2"/><rect x="22" y="18" width="36" height="8" rx="3" fill="#fce7f3" stroke="#f472b6" stroke-width="1.5"/><ellipse cx="40" cy="22" rx="18" ry="4" fill="#fdf2f8"/><path d="M30 36c3-2 6 0 8 2s6 2 10-1" fill="none" stroke="#f9a8d4" stroke-width="1.5" opacity=".5"/><circle cx="36" cy="48" r="5" fill="#f9a8d4" opacity=".25"/><circle cx="44" cy="44" r="3" fill="#f9a8d4" opacity=".2"/><text x="40" y="58" text-anchor="middle" font-size="8" fill="#db2777" font-weight="700" opacity=".6">ìš”êµ¬ë¥´íŠ¸</text></svg>`,
  // ì¼€ì²© (ì†ŒìŠ¤í†µ)
  `<svg viewBox="0 0 80 80"><rect x="34" y="4" width="12" height="12" rx="3" fill="#991b1b" stroke="#7f1d1d" stroke-width="1"/><path d="M28 22c0-4 5-6 12-6s12 2 12 6v42c0 5-5 10-12 10s-12-5-12-10z" fill="#dc2626" stroke="#b91c1c" stroke-width="2"/><rect x="30" y="32" width="20" height="16" rx="2" fill="#fef2f2" opacity=".8"/><text x="40" y="44" text-anchor="middle" font-size="7" fill="#991b1b" font-weight="700">KETCHUP</text><path d="M36 16h8" stroke="#fca5a5" stroke-width="1" opacity=".5"/><path d="M34 24v40" stroke="#ef4444" stroke-width="1" opacity=".3"/><ellipse cx="40" cy="64" rx="8" ry="2" fill="#b91c1c" opacity=".2"/></svg>`,
  // ë‹¬ê±€ (ë‹¬ê±€ 2ê°œ)
  `<svg viewBox="0 0 80 80"><ellipse cx="30" cy="46" rx="14" ry="18" fill="#fef3c7" stroke="#fbbf24" stroke-width="1.5"/><ellipse cx="30" cy="44" rx="10" ry="14" fill="#fffbeb" opacity=".5"/><path d="M24 36c3-2 6-1 8 1" fill="none" stroke="#fde68a" stroke-width="1" opacity=".5"/><ellipse cx="52" cy="48" rx="13" ry="17" fill="#fef9c3" stroke="#facc15" stroke-width="1.5"/><ellipse cx="52" cy="46" rx="9" ry="13" fill="#fefce8" opacity=".5"/><circle cx="28" cy="40" r="2" fill="#fff" opacity=".6"/><circle cx="50" cy="42" r="2" fill="#fff" opacity=".6"/></svg>`,
  // ë°˜ì°¬í†µ (ë°€íìš©ê¸°, íŒŒë€ ëšœê»‘)
  `<svg viewBox="0 0 80 80"><rect x="14" y="30" width="52" height="36" rx="6" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="2"/><rect x="12" y="22" width="56" height="12" rx="4" fill="#3b82f6" stroke="#2563eb" stroke-width="1.5"/><rect x="16" y="24" width="48" height="8" rx="3" fill="#60a5fa"/><rect x="20" y="40" width="40" height="3" rx="1.5" fill="#e2e8f0" opacity=".5"/><rect x="20" y="50" width="40" height="3" rx="1.5" fill="#e2e8f0" opacity=".3"/><circle cx="22" cy="26" r="2" fill="#93c5fd"/><circle cx="58" cy="26" r="2" fill="#93c5fd"/></svg>`,
  // ì–¼ìŒ (ì•„ì´ìŠ¤íŠ¸ë ˆì´)
  `<svg viewBox="0 0 80 80"><rect x="10" y="24" width="60" height="40" rx="4" fill="#e0f2fe" stroke="#7dd3fc" stroke-width="2"/><g fill="#bae6fd" stroke="#7dd3fc" stroke-width="1"><rect x="14" y="28" width="16" height="14" rx="3"/><rect x="32" y="28" width="16" height="14" rx="3"/><rect x="50" y="28" width="16" height="14" rx="3"/><rect x="14" y="44" width="16" height="14" rx="3"/><rect x="32" y="44" width="16" height="14" rx="3"/><rect x="50" y="44" width="16" height="14" rx="3"/></g><rect x="16" y="30" width="4" height="4" rx="2" fill="#fff" opacity=".5"/><rect x="34" y="30" width="4" height="4" rx="2" fill="#fff" opacity=".5"/><rect x="52" y="30" width="4" height="4" rx="2" fill="#fff" opacity=".5"/><rect x="16" y="46" width="4" height="4" rx="2" fill="#fff" opacity=".4"/><rect x="34" y="46" width="4" height="4" rx="2" fill="#fff" opacity=".4"/><rect x="52" y="46" width="4" height="4" rx="2" fill="#fff" opacity=".4"/></svg>`
];
const FRIDGE_ITEMS = [
  { emoji: 'ğŸŠ', name: 'ì£¼ìŠ¤ë³‘', type: 'glassTing', freq: 800 },
  { emoji: 'ğŸ¥›', name: 'ìš°ìœ íŒ©', type: 'boxThud', freq: 150 },
  { emoji: 'ğŸ¥¤', name: 'ìº”ìŒë£Œ', type: 'metalTing', freq: 1200 },
  { emoji: 'ğŸ¦', name: 'ìš”êµ¬ë¥´íŠ¸', type: 'woodTap', freq: 1800 },
  { emoji: 'ğŸ…', name: 'ì¼€ì²©', type: 'waterDrop', freq: 500 },
  { emoji: 'ğŸ¥š', name: 'ë‹¬ê±€', type: 'woodTap', freq: 2500 },
  { emoji: 'ğŸ±', name: 'ë°˜ì°¬í†µ', type: 'metalHit', freq: 300 },
  { emoji: 'ğŸ§Š', name: 'ì–¼ìŒ', type: 'bell', freq: 1500 }
];

// ë“œëŸ¼ ì†Œë¦¬ íƒ€ì… (SVG ì•„ì´ì½˜)
const DRUM_SVG = [
  `<svg viewBox="0 0 40 40"><g fill="#fff"><path d="M8 28l1-10c0-1 1-2 2-1l-1 6 1-7c0-1 1-2 2-1l-1 6 1-6c0-1 1-2 2-1l-1 6 1-5c0-1 1-1 2-1l-1 8-2 6z" opacity=".9"/><path d="M32 28l-1-10c0-1-1-2-2-1l1 6-1-7c0-1-1-2-2-1l1 6-1-6c0-1-1-2-2-1l1 6-1-5c0-1-1-1-2-1l1 8 2 6z" opacity=".9"/><polygon points="20,12 21,16 25,16 22,18 23,22 20,20 17,22 18,18 15,16 19,16" opacity=".8"/></g></svg>`,
  `<svg viewBox="0 0 40 40"><g fill="#fff"><path d="M10 18h18c3 0 5 2 5 4v3H8v-3c0-2 2-4 4-4z" opacity=".9"/><path d="M12 18c0-4 4-7 8-7 3 0 5 2 6 4" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"/><rect x="7" y="26" width="26" height="2" rx="1" opacity=".6"/><path d="M14 30c4-1 8 0 12-1" fill="none" stroke="#fff" stroke-width="1.5" opacity=".4"/></g></svg>`,
  `<svg viewBox="0 0 40 40"><g fill="#fff"><path d="M10 6c0 0 2 12 4 18c1 3 4 5 8 5" stroke="#fff" stroke-width="3" fill="none" stroke-linecap="round" opacity=".7"/><path d="M22 29c4 0 7 2 9 6" stroke="#fff" stroke-width="3" fill="none" stroke-linecap="round" opacity=".7"/><circle cx="22" cy="26" r="5" opacity=".3" stroke="#fff" stroke-width="1.5"/><ellipse cx="28" cy="20" rx="4" ry="3" opacity=".7" transform="rotate(-15 28 20)"/><line x1="24" y1="18" x2="26" y2="14" stroke="#fff" stroke-width="1.5" stroke-linecap="round" opacity=".5"/></g></svg>`,
  `<svg viewBox="0 0 40 40"><g fill="#fff"><circle cx="20" cy="18" r="12" fill="none" stroke="#fff" stroke-width="2" opacity=".6"/><circle cx="16" cy="14" r="2"/><circle cx="24" cy="14" r="2"/><ellipse cx="20" cy="22" rx="6" ry="4" opacity=".3" stroke="#fff" stroke-width="1.5"/><ellipse cx="20" cy="25" rx="3" ry="4" opacity=".4"/><path d="M34 16c2-3 2-7 0-9" fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round" opacity=".6"/></g></svg>`
];
const DRUM_TYPES = [
  { name: 'ë°•ìˆ˜', emoji: 'ğŸ‘' },
  { name: 'ë°œêµ¬ë¥´ê¸°', emoji: 'ğŸ¦¶' },
  { name: 'ë¬´ë¦ì¹˜ê¸°', emoji: 'ğŸ¦µ' },
  { name: 'í˜€ì°¨ê¸°', emoji: 'ğŸ‘…' }
];

// ===== Web Audio ì†Œë¦¬ í•©ì„± =====
function playNote(freq, duration, type) {
  if (!soundEnabled) return;
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    const filter = ctx.createBiquadFilter();
    osc.type = type || 'sine';
    osc.frequency.setValueAtTime(freq, ctx.currentTime);
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(2000, ctx.currentTime);
    osc.connect(filter);
    filter.connect(gain);
    gain.connect(ctx.destination);
    gain.gain.setValueAtTime(0.25, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + (duration || 0.3));
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + (duration || 0.3));
  } catch(e) {}
}

function playDrumSound(drumIdx) {
  if (!soundEnabled) return;
  try {
    const ctx = getAudioCtx();
    if (drumIdx === 0) { // ë°•ìˆ˜ â€” ë…¸ì´ì¦ˆ ë²„ìŠ¤íŠ¸
      const bufSize = ctx.sampleRate * 0.08;
      const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
      const data = buf.getChannelData(0);
      for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * (1 - i / bufSize);
      const src = ctx.createBufferSource();
      src.buffer = buf;
      const hp = ctx.createBiquadFilter(); hp.type = 'highpass'; hp.frequency.value = 1000;
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0.4, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);
      src.connect(hp); hp.connect(gain); gain.connect(ctx.destination);
      src.start(); src.stop(ctx.currentTime + 0.12);
    } else if (drumIdx === 1) { // ë°œêµ¬ë¥´ê¸° â€” í‚¥ë“œëŸ¼
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(150, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.15);
      gain.gain.setValueAtTime(0.5, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(); osc.stop(ctx.currentTime + 0.2);
    } else if (drumIdx === 2) { // ë¬´ë¦ì¹˜ê¸° â€” ìŠ¤ë„¤ì–´
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(200, ctx.currentTime);
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(); osc.stop(ctx.currentTime + 0.1);
      // ë…¸ì´ì¦ˆ
      const bufSize = ctx.sampleRate * 0.06;
      const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
      const data = buf.getChannelData(0);
      for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * (1 - i / bufSize);
      const src = ctx.createBufferSource(); src.buffer = buf;
      const g2 = ctx.createGain(); g2.gain.setValueAtTime(0.2, ctx.currentTime);
      g2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08);
      src.connect(g2); g2.connect(ctx.destination);
      src.start(); src.stop(ctx.currentTime + 0.08);
    } else { // í˜€ì°¨ê¸° â€” í•˜ì´í–‡
      const bufSize = ctx.sampleRate * 0.04;
      const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
      const data = buf.getChannelData(0);
      for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufSize, 3);
      const src = ctx.createBufferSource(); src.buffer = buf;
      const hp = ctx.createBiquadFilter(); hp.type = 'highpass'; hp.frequency.value = 5000;
      const gain = ctx.createGain(); gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.06);
      src.connect(hp); hp.connect(gain); gain.connect(ctx.destination);
      src.start(); src.stop(ctx.currentTime + 0.06);
    }
  } catch(e) {}
}

function playFridgeSound(item) {
  if (!soundEnabled) return;
  try {
    const ctx = getAudioCtx();
    const t = ctx.currentTime;
    if (item.type === 'metalHit') {
      const osc = ctx.createOscillator(); const g = ctx.createGain();
      osc.type = 'square'; osc.frequency.setValueAtTime(item.freq, t);
      osc.frequency.exponentialRampToValueAtTime(item.freq * 0.5, t + 0.3);
      g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
      osc.connect(g); g.connect(ctx.destination); osc.start(t); osc.stop(t + 0.3);
    } else if (item.type === 'metalTing') {
      const osc = ctx.createOscillator(); const g = ctx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(item.freq, t);
      g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
      osc.connect(g); g.connect(ctx.destination); osc.start(t); osc.stop(t + 0.5);
    } else if (item.type === 'glassTing') {
      const osc = ctx.createOscillator(); const g = ctx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(item.freq, t);
      osc.frequency.setValueAtTime(item.freq * 1.5, t + 0.05);
      g.gain.setValueAtTime(0.15, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.6);
      osc.connect(g); g.connect(ctx.destination); osc.start(t); osc.stop(t + 0.6);
      const osc2 = ctx.createOscillator(); const g2 = ctx.createGain();
      osc2.type = 'sine'; osc2.frequency.setValueAtTime(item.freq * 2, t);
      g2.gain.setValueAtTime(0.08, t); g2.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
      osc2.connect(g2); g2.connect(ctx.destination); osc2.start(t); osc2.stop(t + 0.4);
    } else if (item.type === 'crash') {
      const bufSize = ctx.sampleRate * 0.3;
      const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
      const data = buf.getChannelData(0);
      for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufSize, 1.5);
      const src = ctx.createBufferSource(); src.buffer = buf;
      const bp = ctx.createBiquadFilter(); bp.type = 'bandpass'; bp.frequency.value = item.freq; bp.Q.value = 1;
      const g = ctx.createGain(); g.gain.setValueAtTime(0.25, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
      src.connect(bp); bp.connect(g); g.connect(ctx.destination); src.start(t); src.stop(t + 0.4);
    } else if (item.type === 'waterDrop') {
      const osc = ctx.createOscillator(); const g = ctx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(item.freq, t);
      osc.frequency.exponentialRampToValueAtTime(item.freq * 0.6, t + 0.15);
      g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
      osc.connect(g); g.connect(ctx.destination); osc.start(t); osc.stop(t + 0.2);
    } else if (item.type === 'woodTap') {
      const osc = ctx.createOscillator(); const g = ctx.createGain();
      osc.type = 'triangle'; osc.frequency.setValueAtTime(item.freq, t);
      g.gain.setValueAtTime(0.15, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
      osc.connect(g); g.connect(ctx.destination); osc.start(t); osc.stop(t + 0.05);
    } else if (item.type === 'boxThud') {
      const osc = ctx.createOscillator(); const g = ctx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(item.freq, t);
      osc.frequency.exponentialRampToValueAtTime(30, t + 0.15);
      g.gain.setValueAtTime(0.35, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
      osc.connect(g); g.connect(ctx.destination); osc.start(t); osc.stop(t + 0.2);
    } else if (item.type === 'bell') {
      [1, 2, 3].forEach((h, i) => {
        const osc = ctx.createOscillator(); const g = ctx.createGain();
        osc.type = 'sine'; osc.frequency.setValueAtTime(item.freq * h, t);
        g.gain.setValueAtTime(0.12 / h, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.8);
        osc.connect(g); g.connect(ctx.destination); osc.start(t); osc.stop(t + 0.8);
      });
    }
  } catch(e) {}
}

// ===== TTS =====
let audioQueue = [];
let isSpeaking = false;
function speak(text) {
  if (!soundEnabled) return;
  speechSynthesis.cancel();
  audioQueue = [];
  isSpeaking = false;
  audioQueue.push(text);
  processQueue();
}
function speakQueue(text) {
  if (!soundEnabled) return;
  audioQueue.push(text);
  processQueue();
}
function processQueue() {
  if (isSpeaking || !audioQueue.length) return;
  isSpeaking = true;
  const u = new SpeechSynthesisUtterance(audioQueue.shift());
  u.lang = 'ko-KR'; u.rate = 1.0; u.pitch = 1.1;
  u.onend = () => { isSpeaking = false; processQueue(); };
  u.onerror = () => { isSpeaking = false; processQueue(); };
  speechSynthesis.speak(u);
}
function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('sb-sound').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
  if (!soundEnabled) speechSynthesis.cancel();
}

// ===== í”„ë¡œí•„ =====
let _prevMainLevel = 1;
function updateProfile() {
  document.getElementById('pf-name').textContent = profile.name;
  document.getElementById('pf-char').textContent = profile.char;
  const lv = Math.floor(profile.totalXP / 10) + 1;
  document.getElementById('pf-level').textContent = lv;
  const prog = (profile.totalXP % 10);
  document.getElementById('pf-done').textContent = prog;
  document.getElementById('pf-total').textContent = 10;
  document.getElementById('pf-bar').style.width = (prog * 10) + '%';
  if (lv > _prevMainLevel && _prevMainLevel > 0) showLevelUp(lv);
  _prevMainLevel = lv;
}
function changeName() {
  const n = prompt('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', profile.name);
  if (n && n.trim()) { profile.name = n.trim(); LS.setItem('musicName', profile.name); updateProfile(); }
}
function showCharModal() {
  document.getElementById('char-modal').classList.remove('hidden');
  const chars = ['ğŸ§’','ğŸ‘¦','ğŸ‘§','ğŸ¦¸â€â™‚ï¸','ğŸ¦¸â€â™€ï¸','ğŸ§™â€â™‚ï¸','ğŸ±','ğŸ¶','ğŸ¦Š','ğŸ»','ğŸ°','ğŸ¸','ğŸ¦','ğŸ¯','ğŸ¼'];
  const g = document.getElementById('char-grid');
  g.innerHTML = chars.map(c => `<div class="char-item${c===profile.char?' selected':''}" onclick="pickChar('${c}')">${c}</div>`).join('');
}
function hideCharModal() { document.getElementById('char-modal').classList.add('hidden'); }
function pickChar(c) { profile.char = c; LS.setItem('musicChar', c); updateProfile(); hideCharModal(); }
function showAdmin() { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('adm-name').value = profile.name; }
function hideAdmin() { document.getElementById('admin-modal').classList.add('hidden'); }
function saveProfileAdmin() {
  const n = document.getElementById('adm-name').value.trim();
  if (n) { profile.name = n; LS.setItem('musicName', n); updateProfile(); }
  hideAdmin();
}
function resetAll() {
  if (!confirm('ëª¨ë“  ê¸°ë¡ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
  ['musicName','musicChar','musicXP','drawCount','drawNotes','drawBest','drumCombo','drumPerfect','drumBestScore','fridgePlays','fridgeItems','fridgeLoops'].forEach(k => LS.removeItem(k));
  location.reload();
}
function saveStats() {
  LS.setItem('musicXP', profile.totalXP);
  LS.setItem('drawCount', draw.totalDrawn);
  LS.setItem('drawNotes', draw.totalNotes);
  LS.setItem('drawBest', draw.bestLength);
  LS.setItem('drumCombo', drum.maxCombo);
  LS.setItem('drumPerfect', drum.totalPerfect);
  LS.setItem('drumBestScore', drum.bestScore);
  LS.setItem('fridgePlays', fridge.totalPlays);
  LS.setItem('fridgeItems', fridge.totalItems);
  LS.setItem('fridgeLoops', fridge.totalLoops);
}
function addXP(n) {
  profile.totalXP += n;
  updateProfile();
  saveStats();
}

// ===== íƒ­ ì „í™˜ =====
function switchTab(tab) {
  if (drum.playing) stopDrumPattern();
  speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', ['draw','drum','fridge','record'][i] === tab);
  });
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector('.' + tab + '-side').classList.add('active');
  document.querySelectorAll('.game-view').forEach(v => v.classList.remove('active'));
  document.querySelector('.' + tab + '-view').classList.add('active');
  updateActionButtons();
  if (tab === 'record') updateRecords();
}

function updateActionButtons() {
  const a1 = document.getElementById('act1');
  const a2 = document.getElementById('act2');
  const a3 = document.getElementById('act3');
  if (currentTab === 'draw') {
    a1.innerHTML = '<span class="icon">â–¶</span>ì¬ìƒ'; a1.className = 'action-btn btn-cyan'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">ğŸ—‘</span>ì§€ìš°ê¸°'; a2.className = 'action-btn btn-red'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">ğŸ’¾</span>ì €ì¥'; a3.className = 'action-btn btn-green'; a3.disabled = false;
  } else if (currentTab === 'drum') {
    a1.innerHTML = '<span class="icon">â–¶</span>ì‹œì‘'; a1.className = 'action-btn btn-green'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">â¹</span>ë©ˆì¶¤'; a2.className = 'action-btn btn-red'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">ğŸ”„</span>ìƒˆ ë¦¬ë“¬'; a3.className = 'action-btn btn-purple'; a3.disabled = false;
  } else if (currentTab === 'fridge') {
    a1.innerHTML = '<span class="icon">â–¶</span>ì¬ìƒ'; a1.className = 'action-btn btn-green'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">ğŸ—‘</span>ë¹„ìš°ê¸°'; a2.className = 'action-btn btn-red'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">ğŸ”€</span>ëœë¤'; a3.className = 'action-btn btn-purple'; a3.disabled = false;
  } else {
    a1.innerHTML = '<span class="icon">ğŸ“Š</span>ê¸°ë¡'; a1.className = 'action-btn btn-cyan'; a1.disabled = true;
    a2.innerHTML = '<span class="icon">â€”</span>â€”'; a2.className = 'action-btn btn-green'; a2.disabled = true;
    a3.innerHTML = '<span class="icon">â€”</span>â€”'; a3.className = 'action-btn btn-red'; a3.disabled = true;
  }
}

function actionBtn(n) {
  if (currentTab === 'draw') {
    if (n === 1) replayDrawing();
    else if (n === 2) clearDrawing();
    else saveDrawing();
  } else if (currentTab === 'drum') {
    if (n === 1) startDrumPattern();
    else if (n === 2) stopDrumPattern();
    else generateDrumPattern();
  } else if (currentTab === 'fridge') {
    if (n === 1) playSequence();
    else if (n === 2) clearSequence();
    else randomSequence();
  }
}

// ===== ì†Œë¦¬ ê·¸ë¦¼ =====
function initDrawing() {
  const wrap = document.getElementById('draw-wrap');
  const svg = document.getElementById('draw-svg');

  // SVG ì˜¤ì„ ì§€ (ì•…ë³´ ì¤„ 5ê°œ) ë°°ê²½
  const svgNS = 'http://www.w3.org/2000/svg';
  for (let i = 0; i < 5; i++) {
    const line = document.createElementNS(svgNS, 'line');
    line.setAttribute('x1', '6'); line.setAttribute('x2', '100');
    line.setAttribute('y1', String(i * 20 + 10));
    line.setAttribute('y2', String(i * 20 + 10));
    line.setAttribute('stroke', '#c4b5fd'); line.setAttribute('stroke-width', '1');
    line.setAttribute('vector-effect', 'non-scaling-stroke');
    line.setAttribute('stroke-dasharray', '0'); line.setAttribute('opacity', '0.35');
    svg.appendChild(line);
  }
  // ë†’ì€ìŒìë¦¬í‘œ SVG ì¥ì‹
  const treble = document.createElementNS(svgNS, 'text');
  treble.setAttribute('x', '1'); treble.setAttribute('y', '60');
  treble.setAttribute('font-size', '14'); treble.setAttribute('fill', '#c4b5fd');
  treble.setAttribute('opacity', '0.15'); treble.setAttribute('font-family', 'serif');
  treble.textContent = '\uD834\uDD1E'; // ìŒìë¦¬í‘œ ìœ ë‹ˆì½”ë“œ â€” í´ë°±ìœ¼ë¡œ ì¼ë°˜ í…ìŠ¤íŠ¸
  svg.appendChild(treble);

  // idle ë– ë‹¤ë‹ˆëŠ” ìŒí‘œ ì• ë‹ˆë©”ì´ì…˜
  const idleNotes = [
    {svg:'<svg viewBox="0 0 24 24" width="28" height="28"><ellipse cx="9" cy="18" rx="5" ry="3.5" fill="#a78bfa"/><rect x="13" y="5" width="2" height="13" fill="#a78bfa"/><path d="M15 5c3-1 5 0 5 2.5s-2 3.5-5 2.5z" fill="#a78bfa"/></svg>', x:20, y:30, dur:4},
    {svg:'<svg viewBox="0 0 28 24" width="32" height="24"><ellipse cx="7" cy="18" rx="5" ry="3.5" fill="#c4b5fd"/><rect x="11" y="4" width="2" height="14" fill="#c4b5fd"/><ellipse cx="19" cy="16" rx="5" ry="3.5" fill="#c4b5fd"/><rect x="23" y="4" width="2" height="12" fill="#c4b5fd"/><rect x="13" y="4" width="12" height="2.5" fill="#c4b5fd"/></svg>', x:55, y:60, dur:5},
    {svg:'<svg viewBox="0 0 24 24" width="22" height="22"><ellipse cx="9" cy="18" rx="5" ry="3.5" fill="#8b5cf6"/><rect x="13" y="5" width="2" height="13" fill="#8b5cf6"/></svg>', x:80, y:20, dur:3.5},
    {svg:'<svg viewBox="0 0 24 24" width="26" height="26"><polygon points="12,1 15,9 24,9 17,14 19,23 12,18 5,23 7,14 0,9 9,9" fill="#ddd6fe" opacity=".6"/></svg>', x:40, y:75, dur:6}
  ];
  idleNotes.forEach((n, i) => {
    const el = document.createElement('div');
    el.className = 'draw-idle-note';
    el.innerHTML = n.svg;
    el.style.cssText = `left:${n.x}%;top:${n.y}%;animation-duration:${n.dur}s;animation-delay:${i*0.8}s`;
    el.id = 'draw-idle-' + i;
    wrap.appendChild(el);
  });

  function getPos(e) {
    const rect = wrap.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
      x: ((clientX - rect.left) / rect.width) * 100,
      y: ((clientY - rect.top) / rect.height) * 100
    };
  }

  let drawParticleTimer = 0;
  function spawnDrawParticle(x, y) {
    const now = Date.now();
    if (now - drawParticleTimer < 150) return; // throttle
    drawParticleTimer = now;
    const pSvgs = [
      '<svg viewBox="0 0 20 20" width="18" height="18"><ellipse cx="7" cy="14" rx="4" ry="3" fill="#a78bfa"/><rect x="10" y="4" width="2" height="10" fill="#a78bfa"/><path d="M12 4c2-1 4 0 4 2s-2 3-4 2z" fill="#a78bfa"/></svg>',
      '<svg viewBox="0 0 20 20" width="16" height="16"><polygon points="10,1 12,7 18,7 13,11 15,17 10,13 5,17 7,11 2,7 8,7" fill="#c4b5fd"/></svg>',
      '<svg viewBox="0 0 20 20" width="14" height="14"><circle cx="10" cy="10" r="6" fill="none" stroke="#8b5cf6" stroke-width="2"/><circle cx="10" cy="10" r="2" fill="#8b5cf6"/></svg>'
    ];
    const el = document.createElement('div');
    el.className = 'draw-particle';
    el.innerHTML = pSvgs[Math.floor(Math.random() * pSvgs.length)];
    el.style.cssText = `left:${x}%;top:${y}%;transform:translate(-50%,-50%)`;
    wrap.appendChild(el);
    setTimeout(() => el.remove(), 700);
  }

  function startDraw(e) {
    e.preventDefault();
    draw.isDrawing = true;
    draw.points = [];
    const pos = getPos(e);
    draw.points.push(pos);
    playNoteFromY(pos.y);
    // ê·¸ë¦¬ê¸° ì‹œì‘í•˜ë©´ idle ìŒí‘œ ìˆ¨ê¹€
    wrap.querySelectorAll('.draw-idle-note').forEach(n => n.style.opacity = '0');
  }

  function moveDraw(e) {
    if (!draw.isDrawing) return;
    e.preventDefault();
    const pos = getPos(e);
    draw.points.push(pos);
    renderCurrentPath();
    playNoteFromY(pos.y);
    spawnDrawParticle(pos.x, pos.y);
  }

  function endDraw(e) {
    if (!draw.isDrawing) return;
    draw.isDrawing = false;
    stopCurrentNote();
    if (draw.points.length > 3) {
      finalizeCurrentPath();
      draw.paths.push([...draw.points]);
      draw.noteCount += draw.points.length;
      draw.totalNotes += draw.points.length;
      document.getElementById('draw-notes').textContent = draw.noteCount;
    }
    // ê·¸ë¦¬ê¸° ëë‚˜ë©´ idle ë³µì›
    setTimeout(() => {
      if (draw.paths.length === 0) {
        wrap.querySelectorAll('.draw-idle-note').forEach(n => n.style.opacity = '');
      }
    }, 500);
  }

  wrap.addEventListener('mousedown', startDraw);
  wrap.addEventListener('mousemove', moveDraw);
  wrap.addEventListener('mouseup', endDraw);
  wrap.addEventListener('mouseleave', endDraw);
  wrap.addEventListener('touchstart', startDraw, { passive: false });
  wrap.addEventListener('touchmove', moveDraw, { passive: false });
  wrap.addEventListener('touchend', endDraw);
}

function playNoteFromY(yPercent) {
  if (!soundEnabled) return;
  try {
    const ctx = getAudioCtx();
    const idx = Math.floor((1 - yPercent / 100) * (PENTA.length - 1));
    const noteIdx = Math.max(0, Math.min(PENTA.length - 1, idx));
    const freq = PENTA[noteIdx];

    if (draw.currentOsc) {
      draw.currentOsc.frequency.setTargetAtTime(freq, ctx.currentTime, 0.03);
    } else {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      const filter = ctx.createBiquadFilter();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      filter.type = 'lowpass';
      filter.frequency.setValueAtTime(1500, ctx.currentTime);
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(ctx.destination);
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      osc.start();
      draw.currentOsc = osc;
      draw.currentGain = gain;
    }
  } catch(e) {}
}

function stopCurrentNote() {
  if (draw.currentGain) {
    try {
      const ctx = getAudioCtx();
      draw.currentGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
      setTimeout(() => {
        try { draw.currentOsc.stop(); } catch(e) {}
        draw.currentOsc = null;
        draw.currentGain = null;
      }, 150);
    } catch(e) {
      draw.currentOsc = null;
      draw.currentGain = null;
    }
  }
}

function renderCurrentPath() {
  const svg = document.getElementById('draw-svg');
  let existing = svg.querySelector('.current-draw-path');
  if (!existing) {
    const svgNS = 'http://www.w3.org/2000/svg';
    existing = document.createElementNS(svgNS, 'path');
    existing.classList.add('current-draw-path');
    existing.setAttribute('fill', 'none');
    existing.setAttribute('stroke', '#7c3aed');
    existing.setAttribute('stroke-width', '4');
    existing.setAttribute('stroke-linecap', 'round');
    existing.setAttribute('stroke-linejoin', 'round');
    existing.setAttribute('vector-effect', 'non-scaling-stroke');
    svg.appendChild(existing);
  }
  if (draw.points.length < 2) return;
  let d = `M ${draw.points[0].x} ${draw.points[0].y}`;
  for (let i = 1; i < draw.points.length; i++) {
    d += ` L ${draw.points[i].x} ${draw.points[i].y}`;
  }
  existing.setAttribute('d', d);
}

function finalizeCurrentPath() {
  const svg = document.getElementById('draw-svg');
  const current = svg.querySelector('.current-draw-path');
  if (current) {
    current.classList.remove('current-draw-path');
    current.classList.add('saved-draw-path');
    // ìƒ‰ìƒ ë‹¤ì–‘í•˜ê²Œ
    const colors = ['#7c3aed','#8b5cf6','#a78bfa','#ec4899','#3b82f6','#06b6d4','#10b981'];
    current.setAttribute('stroke', colors[draw.paths.length % colors.length]);
    current.setAttribute('stroke-width', '4');
    current.setAttribute('vector-effect', 'non-scaling-stroke');
  }
}

function replayDrawing() {
  if (draw.paths.length === 0) { speak('ë¨¼ì € ê·¸ë¦¼ì„ ê·¸ë ¤ë³´ì„¸ìš”!'); return; }
  if (draw.replaying) return;
  draw.replaying = true;
  speak('ê·¸ë¦¼ì„ ì¬ìƒí•©ë‹ˆë‹¤!');

  const svg = document.getElementById('draw-svg');
  const svgNS = 'http://www.w3.org/2000/svg';
  const colors = ['#7c3aed','#8b5cf6','#a78bfa','#ec4899','#3b82f6','#06b6d4','#10b981'];

  // ê¸°ì¡´ ì €ì¥ ê²½ë¡œ íë¦¬ê²Œ
  svg.querySelectorAll('.saved-draw-path').forEach(p => { p.dataset.origOpacity = p.style.opacity || ''; p.style.opacity = '0.15'; });

  // ì¬ìƒ ì»¤ì„œ (ë¹›ë‚˜ëŠ” ì )
  const cursor = document.createElementNS(svgNS, 'circle');
  cursor.setAttribute('r', '1.8');
  cursor.setAttribute('fill', '#fbbf24');
  cursor.classList.add('replay-cursor');
  svg.appendChild(cursor);

  let pathIdx = 0;
  function playPath() {
    if (pathIdx >= draw.paths.length) {
      // ì¬ìƒ ì™„ë£Œ â€” ì›ìƒë³µêµ¬
      cursor.remove();
      svg.querySelectorAll('.replay-path').forEach(p => p.remove());
      svg.querySelectorAll('.saved-draw-path').forEach(p => { p.style.opacity = p.dataset.origOpacity || ''; });
      draw.replaying = false;
      stopCurrentNote();
      setMascotEmotion('draw', 'happy');
      return;
    }

    const pts = draw.paths[pathIdx];
    const color = colors[pathIdx % colors.length];

    // ì¬ìƒìš© ê¸€ë¡œìš° ê²½ë¡œ
    const replayPath = document.createElementNS(svgNS, 'path');
    replayPath.classList.add('replay-path', 'replay-glow');
    replayPath.setAttribute('fill', 'none');
    replayPath.setAttribute('stroke', color);
    replayPath.setAttribute('stroke-width', '6');
    replayPath.setAttribute('stroke-linecap', 'round');
    replayPath.setAttribute('stroke-linejoin', 'round');
    replayPath.setAttribute('vector-effect', 'non-scaling-stroke');
    replayPath.style.color = color;
    svg.appendChild(replayPath);

    let ptIdx = 0;
    let d = '';

    const interval = setInterval(() => {
      if (ptIdx >= pts.length) {
        clearInterval(interval);
        stopCurrentNote();
        // ê¸€ë¡œìš° ê²½ë¡œ í˜ì´ë“œì•„ì›ƒ
        replayPath.style.transition = 'opacity .3s';
        replayPath.style.opacity = '0';
        setTimeout(() => replayPath.remove(), 300);
        pathIdx++;
        setTimeout(playPath, 250);
        return;
      }

      const pt = pts[ptIdx];
      if (ptIdx === 0) {
        d = `M ${pt.x} ${pt.y}`;
      } else {
        d += ` L ${pt.x} ${pt.y}`;
      }
      replayPath.setAttribute('d', d);

      // ì»¤ì„œ ì´ë™
      cursor.setAttribute('cx', String(pt.x));
      cursor.setAttribute('cy', String(pt.y));

      // ì†Œë¦¬ ì¬ìƒ
      playNoteFromY(pt.y);

      ptIdx += 3;
    }, 50);
  }
  playPath();
}

function clearDrawing() {
  const svg = document.getElementById('draw-svg');
  svg.querySelectorAll('.current-draw-path,.saved-draw-path').forEach(p => p.remove());
  draw.paths = [];
  draw.points = [];
  draw.noteCount = 0;
  document.getElementById('draw-notes').textContent = 0;
  // idle ìŒí‘œ ë³µì›
  document.querySelectorAll('.draw-idle-note').forEach(n => n.style.opacity = '');
}

function saveDrawing() {
  if (draw.paths.length === 0) { speak('ë¨¼ì € ê·¸ë¦¼ì„ ê·¸ë ¤ë³´ì„¸ìš”!'); return; }
  draw.totalDrawn++;
  if (draw.noteCount > draw.bestLength) draw.bestLength = draw.noteCount;
  document.getElementById('draw-count').textContent = draw.totalDrawn;
  addXP(2);
  speak('ë©‹ì§„ ê³¡ì´ ì €ì¥ë˜ì—ˆì–´ìš”!');
  // ì €ì¥ ì´í™íŠ¸
  finalizeCurrentPath();
}

// ===== ëª¸ìœ¼ë¡œ ë“œëŸ¼ =====
function generateDrumPattern() {
  const length = 8;
  drum.pattern = [];
  for (let i = 0; i < length; i++) {
    drum.pattern.push(Math.floor(Math.random() * 4));
  }
  renderDrumBeats();
  drum.currentBeat = -1;
  drum.score = 0;
  drum.combo = 0;
  updateDrumUI();
}

function renderDrumBeats() {
  const container = document.getElementById('drum-beats');
  container.innerHTML = drum.pattern.map((d, i) =>
    `<div class="drum-beat" id="dbeat-${i}">${DRUM_SVG[d]}</div>`
  ).join('');
}

function startDrumPattern() {
  if (drum.playing) return;
  if (drum.pattern.length === 0) generateDrumPattern();
  drum.playing = true;
  drum.currentBeat = -1;
  drum.score = 0;
  drum.combo = 0;
  updateDrumUI();
  document.getElementById('drum-status').textContent = 'ì—°ì£¼ì¤‘!';
  advanceBeat();
}

function advanceBeat() {
  if (!drum.playing) return;
  // ì´ì „ ë¹„íŠ¸ ë¹„í™œì„±í™”
  if (drum.currentBeat >= 0) {
    const prev = document.getElementById('dbeat-' + drum.currentBeat);
    if (prev) prev.classList.remove('active');
  }
  drum.currentBeat++;
  if (drum.currentBeat >= drum.pattern.length) {
    // íŒ¨í„´ ì™„ë£Œ
    stopDrumPattern();
    if (drum.score > drum.bestScore) drum.bestScore = drum.score;
    addXP(Math.min(drum.score, 5));
    SFX.fanfare();
    speak(drum.score >= drum.pattern.length * 8 ? 'ì™„ë²½í•´ìš”!' : 'ì˜í–ˆì–´ìš”!');
    document.getElementById('drum-status').textContent = `ì™„ë£Œ! ${drum.score}ì `;
    return;
  }
  // í˜„ì¬ ë¹„íŠ¸ í™œì„±í™”
  const cur = document.getElementById('dbeat-' + drum.currentBeat);
  if (cur) cur.classList.add('active');
  // ë‹¤ìŒ ë¹„íŠ¸ê¹Œì§€ ëŒ€ê¸°
  drum.beatTimeout = Date.now();
  drum.timer = setTimeout(advanceBeat, 60000 / drum.bpm);
}

function hitDrum(drumIdx) {
  playDrumSound(drumIdx);
  // ë¦¬í”Œ + bounce + glow ì´í™íŠ¸
  const pad = document.querySelectorAll('.drum-pad')[drumIdx];
  const ripple = document.createElement('div');
  ripple.className = 'drum-pad-ripple';
  ripple.style.cssText = 'width:100%;height:100%;top:0;left:0';
  pad.appendChild(ripple);
  setTimeout(() => ripple.remove(), 500);
  // SVG bounce
  pad.classList.add('drum-bounce','drum-glow');
  setTimeout(() => pad.classList.remove('drum-bounce','drum-glow'), 350);

  if (!drum.playing || drum.currentBeat < 0) return;

  const expected = drum.pattern[drum.currentBeat];
  const timeSinceBeat = Date.now() - drum.beatTimeout;
  const beatMs = 60000 / drum.bpm;

  if (drumIdx === expected) {
    let grade, color, points;
    if (timeSinceBeat < beatMs * 0.3) {
      grade = 'Perfect!'; color = '#22c55e'; points = 10;
      drum.totalPerfect++;
    } else if (timeSinceBeat < beatMs * 0.6) {
      grade = 'Good!'; color = '#f59e0b'; points = 5;
    } else {
      grade = 'OK'; color = '#3b82f6'; points = 2;
    }
    drum.score += points;
    drum.combo++;
    if (drum.combo > drum.maxCombo) drum.maxCombo = drum.combo;
    if (grade === 'Perfect!') SFX.perfect(); else SFX.chord();
    if (drum.combo >= 3) SFX.combo(drum.combo);
    showScorePopup(pad.parentElement, points);

    // ë¹„íŠ¸ í”¼ë“œë°±
    const beat = document.getElementById('dbeat-' + drum.currentBeat);
    if (beat) {
      beat.classList.add(timeSinceBeat < beatMs * 0.3 ? 'hit-perfect' : timeSinceBeat < beatMs * 0.6 ? 'hit-good' : 'hit-miss');
    }

    // íŒì • í…ìŠ¤íŠ¸
    showDrumResult(pad, grade, color);
  } else {
    drum.combo = 0;
    SFX.dissonance();
    const beat = document.getElementById('dbeat-' + drum.currentBeat);
    if (beat) beat.classList.add('hit-miss');
    showDrumResult(pad, 'Miss!', '#ef4444');
  }
  updateDrumUI();
}

function showDrumResult(pad, text, color) {
  const rect = pad.getBoundingClientRect();
  const area = document.querySelector('.drum-area');
  const aRect = area.getBoundingClientRect();
  const el = document.createElement('div');
  el.className = 'drum-result';
  el.textContent = text;
  el.style.cssText = `left:${rect.left - aRect.left + rect.width/2}px;top:${rect.top - aRect.top}px;color:${color}`;
  area.appendChild(el);
  setTimeout(() => el.remove(), 800);
}

function stopDrumPattern() {
  drum.playing = false;
  clearTimeout(drum.timer);
  document.querySelectorAll('.drum-beat').forEach(b => b.classList.remove('active'));
  saveStats();
}

function updateDrumUI() {
  document.getElementById('drum-score').textContent = drum.score;
  document.getElementById('drum-combo').textContent = drum.combo;
  document.getElementById('drum-score-side').textContent = drum.score;
  document.getElementById('drum-perfect').textContent = drum.totalPerfect;
  document.getElementById('drum-combo-side').textContent = drum.combo;
}

// ===== ëƒ‰ì¥ê³  ì˜¤ì¼€ìŠ¤íŠ¸ë¼ =====
function initFridge() {
  const container = document.getElementById('fridge-items');
  container.innerHTML = FRIDGE_ITEMS.map((item, i) =>
    `<div class="fridge-item" onclick="tapFridgeItem(${i})" id="fi-${i}">
      ${FRIDGE_SVG[i]}
      <div class="fridge-item-name">${item.name}</div>
    </div>`
  ).join('');
}

function tapFridgeItem(idx) {
  const item = FRIDGE_ITEMS[idx];
  playFridgeSound(item);
  fridge.totalItems++;

  // ì‹œê° ì´í™íŠ¸
  const el = document.getElementById('fi-' + idx);
  el.classList.add('playing');
  setTimeout(() => el.classList.remove('playing'), 300);

  // ë§ ì´í™íŠ¸ + ì†Œë¦¬íŒŒ ì´í™íŠ¸
  const ring = document.createElement('div');
  ring.className = 'fridge-item-ring';
  ring.style.cssText = `width:80px;height:80px;top:50%;left:50%;margin:-40px 0 0 -40px;border-color:${['#8b5cf6','#ec4899','#3b82f6','#10b981','#f59e0b','#ef4444','#06b6d4','#fbbf24'][idx]}`;
  el.appendChild(ring);
  setTimeout(() => ring.remove(), 600);
  // ì†Œë¦¬íŒŒ
  for (let w = 0; w < 2; w++) {
    const wave = document.createElement('div');
    wave.className = 'fridge-soundwave';
    wave.style.animationDelay = (w * 0.15) + 's';
    el.appendChild(wave);
    setTimeout(() => wave.remove(), 800);
  }

  // ì‹œí€€ì„œì— ë°°ì¹˜
  if (fridge.nextSlot < 4) {
    fridge.sequence[fridge.nextSlot] = idx;
    updateSlots();
    fridge.nextSlot++;
    if (fridge.nextSlot >= 4) fridge.nextSlot = 0;
  }
  saveStats();
}

function updateSlots() {
  for (let i = 0; i < 4; i++) {
    const slot = document.getElementById('fslot-' + i);
    if (fridge.sequence[i] !== null) {
      slot.innerHTML = FRIDGE_SVG[fridge.sequence[i]];
      slot.classList.add('filled');
    } else {
      slot.innerHTML = '';
      slot.classList.remove('filled');
    }
    slot.classList.toggle('active-slot', i === fridge.nextSlot);
  }
  document.getElementById('fridge-filled').textContent = fridge.sequence.filter(s => s !== null).length;
}

function clearSlot(idx) {
  fridge.sequence[idx] = null;
  fridge.nextSlot = idx;
  updateSlots();
}

function clearSequence() {
  fridge.sequence = [null, null, null, null];
  fridge.nextSlot = 0;
  updateSlots();
}

function randomSequence() {
  for (let i = 0; i < 4; i++) {
    fridge.sequence[i] = Math.floor(Math.random() * FRIDGE_ITEMS.length);
  }
  fridge.nextSlot = 0;
  updateSlots();
}

function playSequence() {
  const filled = fridge.sequence.filter(s => s !== null);
  if (filled.length === 0) { speak('ë¬¼ê±´ì„ í„°ì¹˜í•´ì„œ ì‹œí€€ì„œì— ë°°ì¹˜í•˜ì„¸ìš”!'); return; }
  if (fridge.isPlaying) return;
  fridge.isPlaying = true;
  fridge.totalPlays++;
  fridge.totalLoops++;
  addXP(1);

  let i = 0;
  function playNext() {
    if (i >= 4) { fridge.isPlaying = false; saveStats(); return; }
    const slot = document.getElementById('fslot-' + i);
    slot.classList.add('active-slot');
    if (fridge.sequence[i] !== null) {
      const item = FRIDGE_ITEMS[fridge.sequence[i]];
      playFridgeSound(item);
      const fi = document.getElementById('fi-' + fridge.sequence[i]);
      if (fi) { fi.classList.add('playing'); setTimeout(() => fi.classList.remove('playing'), 300); }
    }
    setTimeout(() => {
      slot.classList.remove('active-slot');
      i++;
      playNext();
    }, 500);
  }
  playNext();
  document.getElementById('fridge-plays').textContent = fridge.totalPlays;
}

// ===== ë‚´ ê¸°ë¡ =====
function updateRecords() {
  const lv = Math.floor(profile.totalXP / 10) + 1;
  document.getElementById('r-total').textContent = profile.totalXP;
  document.getElementById('r-level').textContent = lv;
  document.getElementById('r-xp').textContent = profile.totalXP;
  document.getElementById('rec-total').textContent = profile.totalXP;
  document.getElementById('rec-level').textContent = lv;
  document.getElementById('r-draw-count').textContent = draw.totalDrawn;
  document.getElementById('r-draw-notes').textContent = draw.totalNotes;
  document.getElementById('r-draw-best').textContent = draw.bestLength;
  document.getElementById('r-drum-score').textContent = drum.bestScore;
  document.getElementById('r-drum-perfect').textContent = drum.totalPerfect;
  document.getElementById('r-drum-combo').textContent = drum.maxCombo;
  document.getElementById('r-fridge-plays').textContent = fridge.totalPlays;
  document.getElementById('r-fridge-items').textContent = fridge.totalItems;
  document.getElementById('r-fridge-loops').textContent = fridge.totalLoops;
}

// ===== íˆì–´ë¡œ: ë¹„íŠ¸ ëŸ¬ì‹œ (ë¹„íŠ¸ë§¤ë‹ˆì•„ ìŠ¤íƒ€ì¼) =====
// ë ˆì¸ ì„¤ì •: 4ë ˆì¸ (ì¤‘ì•™ ì •ë ¬, ê° 160px í­, 12px ê°­)
const LANE_W = 160, LANE_GAP = 12;
const TOTAL_LANE_W = 4 * LANE_W + 3 * LANE_GAP; // 664
const LANE_COLORS = ['#ef4444','#3b82f6','#22c55e','#fbbf24'];
const LANE_KEYS = {d:0, f:1, j:2, k:3};
const NOTE_W = 130, NOTE_H = 36;
const NOTE_ICONS = [
  `<svg viewBox="0 0 32 32" width="28" height="28"><ellipse cx="12" cy="24" rx="7" ry="5" fill="#fff" opacity=".8"/><rect x="18" y="6" width="3" height="18" rx="1.5" fill="#fff" opacity=".8"/><path d="M21 6c4-1.5 8 0 8 4s-4 6-8 5z" fill="#fff" opacity=".6"/></svg>`,
  `<svg viewBox="0 0 40 32" width="28" height="28"><ellipse cx="10" cy="25" rx="6" ry="4.5" fill="#fff" opacity=".8"/><rect x="15" y="5" width="3" height="20" rx="1.5" fill="#fff" opacity=".8"/><ellipse cx="28" cy="23" rx="6" ry="4.5" fill="#fff" opacity=".8"/><rect x="33" y="5" width="3" height="18" rx="1.5" fill="#fff" opacity=".8"/><rect x="18" y="5" width="18" height="3.5" rx="1.5" fill="#fff" opacity=".8"/></svg>`,
  `<svg viewBox="0 0 36 36" width="28" height="28"><polygon points="18,2 22,13 34,13 24,20 28,32 18,25 8,32 12,20 2,13 14,13" fill="#fff" opacity=".7"/></svg>`
];

function getLaneX(lane) {
  // ì•„ë ˆë‚˜ ì¤‘ì•™ ê¸°ì¤€
  const arena = document.getElementById('hg-arena');
  const cx = arena.offsetWidth / 2;
  const startX = cx - TOTAL_LANE_W / 2;
  return startX + lane * (LANE_W + LANE_GAP);
}
function getJudgeY() {
  const arena = document.getElementById('hg-arena');
  return arena.offsetHeight - 160;
}

function startHeroGame() {
  try{document.documentElement.requestFullscreen?.()}catch(e){}
  document.getElementById('hero-game').classList.remove('hidden');
  hg.score = 0; hg.lives = 5; hg.level = 1; hg.running = false; hg.paused = false;
  hg.notes = []; hg.combo = 0; hg.maxCombo = 0; hg.perfects = 0; hg.bpm = 100;
  _prevHgLives = 5;
  // ì´í€„ë¼ì´ì € ì¥ì‹ ì¶”ê°€
  addEqBars();
  updateHgUI();
  // ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ ì‹œì‘
  hgCountdown();
}

function addEqBars() {
  const arena = document.getElementById('hg-arena');
  arena.querySelectorAll('.hg-eq-bar').forEach(e => e.remove());
  const colors = ['#a78bfa','#c084fc','#8b5cf6','#7c3aed'];
  for (let i = 0; i < 20; i++) {
    const bar = document.createElement('div');
    bar.className = 'hg-eq-bar';
    const side = i < 10 ? 'left' : 'right';
    const idx = i < 10 ? i : i - 10;
    const h1 = 20 + Math.random() * 60;
    const h2 = 40 + Math.random() * 120;
    bar.style.cssText = `${side}:${40 + idx * 50}px;background:${colors[i%4]};--h1:${h1}px;--h2:${h2}px;--dur:${0.6 + Math.random() * 1.2}s`;
    arena.appendChild(bar);
  }
}

function hgCountdown() {
  const cd = document.getElementById('hg-countdown');
  cd.style.display = 'flex';
  const steps = ['3','2','1','ğŸµ'];
  let i = 0;
  function showStep() {
    if (i >= steps.length) {
      cd.style.display = 'none';
      hg.running = true;
      SFX.gameStart();
      startBgDrone();
      startBgm();
      hgLoop();
      return;
    }
    cd.innerHTML = `<div class="hg-countdown-num">${steps[i]}</div>`;
    if (i < 3) playNote(440 + i * 110, 0.15, 'sine');
    else playNote(880, 0.2, 'sine');
    i++;
    setTimeout(showStep, 800);
  }
  showStep();
}

let bgDroneOsc = null, bgDroneGain = null;
function startBgDrone() {
  if (!soundEnabled) return;
  try {
    const ctx = getAudioCtx();
    bgDroneOsc = ctx.createOscillator();
    bgDroneGain = ctx.createGain();
    bgDroneOsc.type = 'sine';
    bgDroneOsc.frequency.setValueAtTime(65, ctx.currentTime);
    bgDroneGain.gain.setValueAtTime(0.06, ctx.currentTime);
    bgDroneOsc.connect(bgDroneGain);
    bgDroneGain.connect(ctx.destination);
    bgDroneOsc.start();
  } catch(e) {}
}

function stopBgDrone() {
  try {
    if (bgDroneGain) bgDroneGain.gain.exponentialRampToValueAtTime(0.001, getAudioCtx().currentTime + 0.3);
    setTimeout(() => { try { bgDroneOsc.stop(); } catch(e) {} bgDroneOsc = null; bgDroneGain = null; }, 400);
  } catch(e) { bgDroneOsc = null; bgDroneGain = null; }
}

// ===== BGM ë¹„íŠ¸ ìƒì„±ê¸° (í‚¥/ìŠ¤ë„¤ì–´/í•˜ì´í–‡/ë² ì´ìŠ¤) =====
let bgmTimer = null, bgmBeat = 0;
const BASS_NOTES = [65, 73, 82, 87, 98, 82, 73, 65]; // íœíƒ€í† ë‹‰ ë² ì´ìŠ¤ë¼ì¸

function startBgm() {
  if (!soundEnabled) return;
  bgmBeat = 0;
  playBgmBeat();
  updateBgmTimer();
}

function updateBgmTimer() {
  if (bgmTimer) clearInterval(bgmTimer);
  const beatMs = 60000 / hg.bpm;
  bgmTimer = setInterval(() => {
    if (!hg.running || hg.paused) return;
    bgmBeat++;
    playBgmBeat();
  }, beatMs);
}

function stopBgm() {
  if (bgmTimer) { clearInterval(bgmTimer); bgmTimer = null; }
}

function playBgmBeat() {
  try {
    const ctx = getAudioCtx();
    const t = ctx.currentTime;
    const beat = bgmBeat % 8;

    // í‚¥ ë“œëŸ¼: 0, 4 (ë§¤ ë§ˆë”” 1ë°•, 3ë°•)
    if (beat === 0 || beat === 4) {
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(150, t);
      osc.frequency.exponentialRampToValueAtTime(40, t + 0.12);
      g.gain.setValueAtTime(0.35, t);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
      osc.connect(g); g.connect(ctx.destination);
      osc.start(t); osc.stop(t + 0.2);
    }

    // ìŠ¤ë„¤ì–´: 2, 6 (2ë°•, 4ë°•)
    if (beat === 2 || beat === 6) {
      const len = Math.floor(ctx.sampleRate * 0.08);
      const buf = ctx.createBuffer(1, len, ctx.sampleRate);
      const d = buf.getChannelData(0);
      for (let i = 0; i < len; i++) d[i] = Math.random() * 2 - 1;
      const src = ctx.createBufferSource();
      src.buffer = buf;
      const bp = ctx.createBiquadFilter();
      bp.type = 'bandpass'; bp.frequency.setValueAtTime(2000, t); bp.Q.setValueAtTime(1, t);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.12, t);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
      src.connect(bp); bp.connect(g); g.connect(ctx.destination);
      src.start(t); src.stop(t + 0.08);
      // ìŠ¤ë„¤ì–´ í†¤ ì¶”ê°€
      const osc2 = ctx.createOscillator();
      const g2 = ctx.createGain();
      osc2.type = 'triangle';
      osc2.frequency.setValueAtTime(180, t);
      g2.gain.setValueAtTime(0.1, t);
      g2.gain.exponentialRampToValueAtTime(0.001, t + 0.06);
      osc2.connect(g2); g2.connect(ctx.destination);
      osc2.start(t); osc2.stop(t + 0.06);
    }

    // í•˜ì´í–‡: ë§¤ ë¹„íŠ¸ (8ë¶„ìŒí‘œ)
    {
      const len = Math.floor(ctx.sampleRate * 0.03);
      const buf = ctx.createBuffer(1, len, ctx.sampleRate);
      const d = buf.getChannelData(0);
      for (let i = 0; i < len; i++) d[i] = Math.random() * 2 - 1;
      const src = ctx.createBufferSource();
      src.buffer = buf;
      const hp = ctx.createBiquadFilter();
      hp.type = 'highpass'; hp.frequency.setValueAtTime(9000, t);
      const g = ctx.createGain();
      const vol = (beat % 2 === 0) ? 0.06 : 0.035; // ê°•/ì•½ ì—‘ì„¼íŠ¸
      g.gain.setValueAtTime(vol, t);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.025);
      src.connect(hp); hp.connect(g); g.connect(ctx.destination);
      src.start(t); src.stop(t + 0.03);
    }

    // ë² ì´ìŠ¤: 0, 3, 4, 7 (ë¦¬ë“¬ê° ìˆëŠ” íŒ¨í„´)
    if (beat === 0 || beat === 3 || beat === 4 || beat === 7) {
      const freq = BASS_NOTES[Math.floor(bgmBeat / 8) % BASS_NOTES.length];
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(freq, t);
      g.gain.setValueAtTime(0.1, t);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.25);
      osc.connect(g); g.connect(ctx.destination);
      osc.start(t); osc.stop(t + 0.25);
    }
  } catch(e) {}
}

function hgLoop() {
  const interval = Math.max(500, 60000 / hg.bpm);
  if (hg.spawnTimer) clearInterval(hg.spawnTimer);
  hg.spawnTimer = setInterval(() => {
    if (!hg.paused && hg.running) hgSpawn();
  }, interval);
  function tick() {
    if (!hg.running) return;
    if (!hg.paused) hgMoveNotes();
    hg.animId = requestAnimationFrame(tick);
  }
  hg.animId = requestAnimationFrame(tick);
}

function hgSpawn() {
  const arena = document.getElementById('hg-arena');
  const lane = Math.floor(Math.random() * 4);
  const lx = getLaneX(lane);

  const el = document.createElement('div');
  el.className = 'hg-note';
  el.setAttribute('data-l', lane);
  el.style.width = NOTE_W + 'px';
  el.style.height = NOTE_H + 'px';
  el.innerHTML = NOTE_ICONS[Math.floor(Math.random() * NOTE_ICONS.length)];
  el.style.left = (lx + (LANE_W - NOTE_W) / 2) + 'px';
  el.style.top = '-50px';
  arena.appendChild(el);

  // ë‚™í•˜ ì†ë„: ë ˆë²¨ì— ë”°ë¼ ì¦ê°€
  const speed = 2.5 + hg.level * 0.4;
  hg.notes.push({ el, lane, y: -50, speed, hit: false });
}

function hgMoveNotes() {
  const judgeY = getJudgeY();
  const missY = judgeY + 80; // íŒì •ì„  ì•„ë˜ 80px â†’ ë¯¸ìŠ¤

  hg.notes = hg.notes.filter(note => {
    if (note.hit) return false;
    note.y += note.speed;
    note.el.style.top = note.y + 'px';

    // íŒì •ì„  ê·¼ì²˜ì—ì„œ ê¸€ë¡œìš° ê°•í™”
    const dist = Math.abs(note.y - judgeY);
    if (dist < 80) {
      note.el.style.filter = `brightness(${1 + (80 - dist) / 80 * 0.5})`;
    }

    // ë¯¸ìŠ¤ íŒì •
    if (note.y > missY) {
      note.el.style.transition = 'opacity .2s';
      note.el.style.opacity = '0';
      setTimeout(() => note.el.remove(), 200);
      hgMiss();
      return false;
    }
    return true;
  });
}

function hgTap(lane) {
  if (!hg.running || hg.paused) return;
  const judgeY = getJudgeY();
  const arena = document.getElementById('hg-arena');

  // ë²„íŠ¼ ì‹œê° í”¼ë“œë°±
  const btn = document.getElementById('hg-btn-' + lane);
  if (btn) { btn.classList.remove('flash'); void btn.offsetWidth; btn.classList.add('flash'); }

  // í•´ë‹¹ ë ˆì¸ì—ì„œ íŒì •ì„ ì— ê°€ì¥ ê°€ê¹Œìš´ ë…¸íŠ¸ ì°¾ê¸°
  let best = null;
  let bestDist = Infinity;
  for (const note of hg.notes) {
    if (note.lane !== lane || note.hit) continue;
    const dist = Math.abs(note.y + NOTE_H / 2 - judgeY);
    if (dist < 100 && dist < bestDist) {
      bestDist = dist;
      best = note;
    }
  }

  if (!best) return; // ë¹ˆ íƒ­

  best.hit = true;
  let grade, points;
  if (bestDist < 20) { grade = 'Perfect!'; points = 10; hg.perfects++; }
  else if (bestDist < 50) { grade = 'Good!'; points = 5; }
  else { grade = 'OK'; points = 2; }

  hg.combo++;
  if (hg.combo > hg.maxCombo) hg.maxCombo = hg.combo;
  const comboBonus = Math.min(hg.combo, 15);
  const totalPts = points + comboBonus;
  hg.score += totalPts;

  // íš¨ê³¼ìŒ
  if (grade === 'Perfect!') SFX.perfect(); else SFX.chord();
  playNote(PENTA[lane % PENTA.length], 0.2, 'sine');
  if (hg.combo >= 5) SFX.combo(hg.combo);

  // ë ˆì¸ í”Œë˜ì‹œ
  const laneFlash = document.createElement('div');
  laneFlash.className = 'hg-lane-flash';
  laneFlash.setAttribute('data-l', lane);
  laneFlash.style.left = getLaneX(lane) + 'px';
  arena.appendChild(laneFlash);
  setTimeout(() => laneFlash.remove(), 250);

  // ì ìˆ˜ íŒì—…
  const sp = document.createElement('div');
  sp.className = 'hg-score-pop';
  sp.textContent = '+' + totalPts;
  sp.style.left = (getLaneX(lane) + LANE_W / 2 - 20) + 'px';
  sp.style.bottom = '180px';
  arena.appendChild(sp);
  setTimeout(() => sp.remove(), 600);

  // íŒì • í…ìŠ¤íŠ¸
  const jt = document.createElement('div');
  jt.className = 'hg-judge-text';
  jt.textContent = grade;
  jt.style.color = grade === 'Perfect!' ? '#22c55e' : grade === 'Good!' ? '#fbbf24' : '#60a5fa';
  arena.appendChild(jt);
  setTimeout(() => jt.remove(), 800);

  // ì½¤ë³´ í‘œì‹œ
  if (hg.combo >= 3) {
    arena.querySelectorAll('.hg-combo-text').forEach(e => e.remove());
    const ct = document.createElement('div');
    ct.className = 'hg-combo-text';
    ct.textContent = `${hg.combo} COMBO!`;
    arena.appendChild(ct);
    setTimeout(() => ct.remove(), 1000);
  }

  // ë…¸íŠ¸ ì œê±° ì• ë‹ˆë©”ì´ì…˜
  best.el.style.transition = 'all .15s';
  best.el.style.transform = 'scaleY(2) scaleX(1.3)';
  best.el.style.opacity = '0';
  setTimeout(() => best.el.remove(), 150);

  // ë ˆë²¨ ì—… (25ì ë§ˆë‹¤)
  const nl = Math.floor(hg.score / 25) + 1;
  if (nl > hg.level) {
    hg.level = nl;
    hg.bpm = 100 + (hg.level - 1) * 12;
    hgLoop(); // BPM ê°±ì‹ 
    updateBgmTimer(); // BGM í…œí¬ ë™ê¸°í™”
    hgUpdateBg();
    showLevelUp(nl);
    document.getElementById('hg-bpm').textContent = 'â™© ' + hg.bpm + ' BPM';
  }
  updateHgUI();
}

function hgMiss() {
  hg.lives--;
  hg.combo = 0;
  SFX.dissonance();
  const arena = document.getElementById('hg-arena');
  const flash = document.createElement('div');
  flash.className = 'hg-flash-miss';
  arena.appendChild(flash);
  setTimeout(() => flash.remove(), 350);
  playNote(100, 0.15, 'sawtooth');
  updateHgUI();
  if (hg.lives <= 0) hgEnd();
}

function hgUpdateBg() {
  const bgs = [
    'linear-gradient(180deg,#0f0720 0%,#1a0a3e 40%,#2d1463 100%)',
    'linear-gradient(180deg,#0a0520 0%,#150835 30%,#1e1b4b 60%,#312e81 100%)',
    'linear-gradient(180deg,#050210 0%,#0f0720 30%,#1a0a3e 60%,#2d1463 100%)',
    'linear-gradient(180deg,#000 0%,#0a0520 30%,#150835 60%,#1e1b4b 100%)'
  ];
  document.getElementById('hero-game').style.background = bgs[(hg.level - 1) % bgs.length];
}

let _prevHgLives = 5;
function updateHgUI() {
  document.getElementById('hg-score').textContent = hg.score;
  document.getElementById('hg-level').textContent = hg.level;
  const heartsEl = document.getElementById('hg-hearts');
  if (hg.lives < _prevHgLives && _prevHgLives > 0) {
    let html = '';
    for (let i = 0; i < 5; i++) {
      if (i < hg.lives) html += 'â¤ï¸';
      else if (i === hg.lives) html += '<span style="animation:flashMiss .3s">ğŸ’”</span>';
      else html += 'ğŸ–¤';
    }
    heartsEl.innerHTML = html;
  } else {
    heartsEl.textContent = 'â¤ï¸'.repeat(Math.max(0, hg.lives)) + 'ğŸ–¤'.repeat(Math.max(0, 5 - hg.lives));
  }
  _prevHgLives = hg.lives;
}

function hgEnd() {
  hg.running = false;
  SFX.gameOver();
  stopBgDrone();
  stopBgm();
  if (hg.spawnTimer) clearInterval(hg.spawnTimer);
  if (hg.animId) cancelAnimationFrame(hg.animId);
  hg.notes.forEach(n => n.el.remove());
  hg.notes = [];
  document.getElementById('hg-final-score').textContent = hg.score;
  document.getElementById('hg-final-combo').textContent = hg.maxCombo;
  document.getElementById('hg-final-perfect').textContent = hg.perfects;
  document.getElementById('hg-final-level').textContent = hg.level;
  let msg = 'ì˜í–ˆì–´ìš”!';
  if (hg.score >= 100) msg = 'ì „ì„¤ì˜ DJ! ë¹„íŠ¸ì˜ ë‹¬ì¸!';
  else if (hg.score >= 60) msg = 'ì™€! ë¦¬ë“¬ê°ì´ ì¢‹ì•„ìš”!';
  else if (hg.score >= 30) msg = 'ë©‹ì ¸ìš”! ê³„ì† ì—°ìŠµ!';
  document.getElementById('hg-over-msg').textContent = msg;
  document.getElementById('hg-over').classList.remove('hidden');
  addXP(Math.min(Math.floor(hg.score / 5), 10));
  speak(msg);
}

function hgRestart() {
  document.getElementById('hg-over').classList.add('hidden');
  const arena = document.getElementById('hg-arena');
  arena.querySelectorAll('.hg-note,.hg-judge-text,.hg-combo-text,.hg-lane-flash,.hg-flash-miss,.hg-score-pop').forEach(e => e.remove());
  hg.score = 0; hg.lives = 5; hg.level = 1; hg.running = false; hg.paused = false;
  hg.notes = []; hg.combo = 0; hg.maxCombo = 0; hg.perfects = 0; hg.bpm = 100;
  _prevHgLives = 5;
  updateHgUI(); hgUpdateBg();
  document.getElementById('hg-bpm').textContent = 'â™© 100 BPM';
  hgCountdown();
}

function hgPause() {
  hg.paused = !hg.paused;
  document.getElementById('hg-pause').classList.toggle('hidden', !hg.paused);
}

function hgExit() {
  hg.running = false;
  stopBgDrone();
  stopBgm();
  if (hg.spawnTimer) clearInterval(hg.spawnTimer);
  if (hg.animId) cancelAnimationFrame(hg.animId);
  hg.notes.forEach(n => n.el.remove());
  hg.notes = [];
  document.getElementById('hg-over').classList.add('hidden');
  document.getElementById('hg-pause').classList.add('hidden');
  document.getElementById('hg-countdown').style.display = 'none';
  document.getElementById('hero-game').classList.add('hidden');
  if(document.fullscreenElement)document.exitFullscreen?.();
}

// í‚¤ë³´ë“œ ì…ë ¥ (D, F, J, K)
document.addEventListener('keydown', function(e) {
  if (!hg.running || hg.paused) return;
  const lane = LANE_KEYS[e.key.toLowerCase()];
  if (lane !== undefined) { e.preventDefault(); hgTap(lane); }
});

// ===== ì´ˆê¸°í™” =====
document.addEventListener('DOMContentLoaded', function() {
  // fitScale
  function fitScale() {
    const c = document.querySelector('.container');
    if (!c || getComputedStyle(c).display === 'none') return;
    const M = 0.03;
    const vp = window.visualViewport || {width: window.innerWidth, height: window.innerHeight};
    const aW = vp.width * (1 - M * 2);
    const aH = vp.height * (1 - M * 2);
    const s = Math.min(aW / 1920, aH / 1080);
    c.style.transform = `scale(${s})`;
    c.style.left = ((vp.width - 1920 * s) / 2) + 'px';
    c.style.top = ((vp.height - 1080 * s) / 2) + 'px';
  }
  fitScale();
  window.addEventListener('resize', fitScale);
  if (window.visualViewport) window.visualViewport.addEventListener('resize', fitScale);

  // í”„ë¡œí•„
  const p = JSON.parse(localStorage.getItem('music_profile')||'{}');
  _prevMainLevel = Math.floor((p.totalXP||0) / 10) + 1;
  updateProfile();
  updateActionButtons();

  // ê²Œì„ ì´ˆê¸°í™”
  initDrawing();
  generateDrumPattern();
  initFridge();
  updateSlots();
});

// ===== ì ìˆ˜ íŒì—… =====
function showScorePopup(container, points, x, y) {
  const el = document.createElement('div');
  el.className = 'score-popup';
  el.textContent = `+${points}`;
  el.style.cssText = `left:${x||'50%'};top:${y||'40%'};color:${points>=10?'#c4b5fd':'#22c55e'};transform:translate(-50%,-50%)`;
  container.appendChild(el);
  setTimeout(() => el.remove(), 800);
}

// ===== ë ˆë²¨ì—… ì˜¤ë²„ë ˆì´ =====
function showLevelUp(level) {
  const ov = document.createElement('div');
  ov.className = 'levelup-overlay';
  ov.innerHTML = `<div class="levelup-text">LEVEL ${level}!</div>`;
  document.body.appendChild(ov);
  SFX.levelup();
  setTimeout(() => ov.remove(), 900);
}

// ===== ë§ˆìŠ¤ì½”íŠ¸ ê°ì • =====
function setMascotEmotion(viewId, emotion) {
  const mouthEl = document.getElementById(`mascot-${viewId}-mouth`);
  const speechEl = document.getElementById(`mascot-${viewId}-speech`);
  if (!mouthEl && !speechEl) return;
  if (emotion === 'happy') {
    if (mouthEl) mouthEl.setAttribute('d', 'M40 88 Q50 98 60 88');
    if (speechEl) { speechEl.textContent = ['ë©‹ì ¸!','ìµœê³ !','ì§±!','ë¸Œë¼ë³´!'][Math.floor(Math.random()*4)]; speechEl.style.display='block'; }
  } else if (emotion === 'worried') {
    if (mouthEl) mouthEl.setAttribute('d', 'M42 94 Q50 88 58 94');
    if (speechEl) { speechEl.textContent = ['ë‹¤ì‹œ!','í˜ë‚´!','ê´œì°®ì•„!'][Math.floor(Math.random()*3)]; speechEl.style.display='block'; }
  } else {
    if (mouthEl) mouthEl.setAttribute('d', 'M40 90 Q50 97 60 90');
    if (speechEl) speechEl.style.display='block';
  }
  setTimeout(() => setMascotEmotion(viewId, 'idle'), 2500);
}

// ë”ë¸”íƒ­ ë°©ì§€
let lastTouchEnd = 0;
document.addEventListener('touchend', function(e) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) e.preventDefault();
  lastTouchEnd = now;
}, false);
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
    if (hg.running && !hg.paused) hgPause();
  }
});
window.matchMedia('(orientation: portrait)').addEventListener('change', e => {
  if (e.matches) {
    speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
    if (hg.running && !hg.paused) hgPause();
  }
});
</script>
</body>
</html>
