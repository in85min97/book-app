<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÌïúÍ∏Ä ÎÜÄÏù¥ÌÑ∞ üåà</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #8B5FBF 100%);
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* Í∞ÄÎ°ú Ï†ÑÏö© ÌöåÏ†Ñ ÏïàÎÇ¥ */
        .rotate-notice {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            gap: 20px;
        }
        .rotate-notice .rotate-icon {
            font-size: 80px;
            animation: rotateHint 2s ease-in-out infinite;
        }
        @keyframes rotateHint {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }

        /* ÏÑ∏Î°ú ÌôîÎ©¥Ïùº Îïå ÌöåÏ†Ñ ÏïàÎÇ¥ ÌëúÏãú */
        @media (orientation: portrait) {
            .rotate-notice { display: flex; }
            .container { display: none !important; }
        }

        /* 1920√ó1080 Í≥†Ï†ï ‚Äî JSÍ∞Ä scale + ÎßàÏßÑ Ï≤òÎ¶¨ */
        .container {
            width: 1920px;
            height: 1080px;
            background: white;
            border-radius: 25px;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.12),
                0 12px 24px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform-origin: 0 0;
            position: absolute;
        }

        /* ===== ÏµúÏÉÅÎã®: Í≥ºÎ™© ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î ===== */
        .subject-bar {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            display: flex;
            align-items: center;
            padding: 0 20px;
            height: 56px;
            flex-shrink: 0;
            gap: 4px;
            position: relative;
        }
        .subject-bar::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #fbbf24);
        }
        .sb-tab {
            padding: 8px 30px;
            border: none;
            border-radius: 12px 12px 0 0;
            background: transparent;
            font-size: 18px;
            font-weight: 800;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sb-tab.active {
            background: white;
            color: #1e3a8a;
        }
        .sb-tab.locked { cursor: default; }
        .sb-tab .lock { font-size: 12px; opacity: 0.5; }
        .sb-spacer { flex: 1; }
        .sb-btns {
            display: flex;
            gap: 8px;
        }
        .sb-btn {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 6px 14px;
            font-size: 18px;
            color: white;
            cursor: pointer;
            transition: all 0.15s;
        }
        .sb-btn:active { background: rgba(255,255,255,0.3); }
        .sb-btn.muted { opacity: 0.5; }

        /* Î©îÏù∏ Î†àÏù¥ÏïÑÏõÉ: ÏôºÏ™Ω | Ï§ëÏïô | Ïò§Î•∏Ï™Ω */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 14px;
            padding: 14px;
            flex: 1;
            overflow: hidden;
        }

        /* ===== ÏôºÏ™Ω Ìå®ÎÑê ===== */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        /* ÌîÑÎ°úÌïÑ ÏÑπÏÖò */
        .profile-section {
            background: linear-gradient(145deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
            border-radius: 20px;
            padding: 20px;
            border: 3px solid #fbbf24;
            box-shadow: 0 6px 20px rgba(59,130,246,0.3);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        .profile-section::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="15" cy="15" r="1.5" fill="white" opacity="0.4"><animate attributeName="opacity" values="0.4;0.15;0.4" dur="2s" repeatCount="indefinite"/></circle><circle cx="85" cy="25" r="1" fill="white" opacity="0.3"><animate attributeName="opacity" values="0.3;0.1;0.3" dur="1.5s" repeatCount="indefinite"/></circle><circle cx="25" cy="75" r="1.2" fill="white" opacity="0.35"><animate attributeName="opacity" values="0.35;0.1;0.35" dur="1.8s" repeatCount="indefinite"/></circle><circle cx="70" cy="60" r="0.9" fill="white" opacity="0.25"><animate attributeName="opacity" values="0.25;0.08;0.25" dur="2.2s" repeatCount="indefinite"/></circle></svg>') repeat;
            pointer-events: none;
        }

        .profile-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 15px;
            height: 100%;
        }

        .profile-avatar {
            width: 90px;
            height: 90px;
            background: linear-gradient(145deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
            position: relative;
            animation: avatarGlow 3s ease-in-out infinite;
            flex-shrink: 0;
            min-width: 90px;
            min-height: 90px;
            cursor: pointer;
        }

        @keyframes avatarGlow {
            0%, 100% { 
                box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 8px 25px rgba(251, 191, 36, 0.6);
                transform: scale(1.05);
            }
        }

        .profile-info {
            flex: 1;
            color: white;
        }

        .profile-name {
            font-size: 28px;
            font-weight: 800;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .profile-name::before {
            content: 'üëë';
            font-size: 16px;
            animation: crownShine 2s ease-in-out infinite;
        }

        @keyframes crownShine {
            0%, 100% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(10deg) scale(1.1); }
        }

        .profile-level-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 8px 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .profile-level {
            font-size: 22px;
            font-weight: 700;
            color: #fbbf24;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .level-badge {
            background: linear-gradient(145deg, #fbbf24, #f59e0b);
            color: #92400e;
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 22px;
            font-weight: 800;
            border: 1px solid white;
            animation: levelPulse 2s ease-in-out infinite;
        }

        @keyframes levelPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #fbbf24);
            background-size: 200% 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
            animation: progressShine 2s linear infinite;
        }

        @keyframes progressShine {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* ÌÉ≠ ÏãúÏä§ÌÖú */
        .tab-headers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            flex-shrink: 0;
        }

        .tab-btn {
            background: linear-gradient(145deg, #e2e8f0, #cbd5e1);
            border: 2px solid #94a3b8;
            border-radius: 12px;
            padding: 8px 6px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #475569;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 44px;
            min-height: 44px;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            color: white;
            border-color: #3b82f6;
        }

        .tab-btn:active {
            background: linear-gradient(145deg, #2563eb, #1d4ed8);
        }

        /* ÌÉ≠ Ïª®ÌÖêÏ∏† */
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Ï†ÄÏû•Îêú Îã®Ïñ¥Îì§ ÏÑπÏÖò */
        .saved-words-section {
            background: linear-gradient(145deg, #f0f9ff, #e0f2fe);
            border-radius: 16px;
            padding: 14px;
            border: 2px solid #0ea5e9;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.1);
            overflow: hidden;
            height: 100%;
        }

        .saved-chars-title {
            font-size: 24px;
            font-weight: 700;
            color: #0c4a6e;
            text-align: center;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        .saved-chars-display {
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow-y: auto;
            flex: 1;
            scrollbar-width: thin;
            scrollbar-color: #0ea5e9 transparent;
        }

        .saved-chars-display::-webkit-scrollbar {
            width: 3px;
        }

        .saved-chars-display::-webkit-scrollbar-track {
            background: transparent;
        }

        .saved-chars-display::-webkit-scrollbar-thumb {
            background: #0ea5e9;
            border-radius: 2px;
        }

        .saved-word {
            background: linear-gradient(145deg, #0ea5e9, #0284c7);
            color: white;
            font-size: 22px;
            font-weight: 700;
            padding: 14px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: background 0.15s ease;
            touch-action: manipulation;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.2);
            flex-shrink: 0;
            height: 50px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .saved-word:active {
            background: linear-gradient(145deg, #0284c7, #0369a1);
        }

        .empty-saved {
            color: #0ea5e9;
            font-style: italic;
            font-size: 20px;
            text-align: center;
            margin-top: 15px;
            opacity: 0.7;
        }

        /* ÎèÑÏ†ÑÌïòÍ∏∞ ÏÑπÏÖò */
        .challenge-section {
            background: linear-gradient(145deg, #fef3c7, #fde68a);
            border-radius: 16px;
            padding: 14px;
            border: 2px solid #f59e0b;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.1);
            overflow: hidden;
            height: 100%;
        }

        .challenge-title {
            font-size: 24px;
            font-weight: 700;
            color: #92400e;
            text-align: center;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        .challenge-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            flex: 1;
            scrollbar-width: thin;
            scrollbar-color: #f59e0b transparent;
        }

        .challenge-content::-webkit-scrollbar {
            width: 3px;
        }

        .challenge-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .challenge-content::-webkit-scrollbar-thumb {
            background: #f59e0b;
            border-radius: 2px;
        }

        .challenge-word {
            background: linear-gradient(145deg, #f59e0b, #d97706);
            color: white;
            font-size: 22px;
            font-weight: 700;
            padding: 14px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            touch-action: manipulation;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 70px;
            min-height: 70px;
        }

        .challenge-word:active {
            background: linear-gradient(145deg, #d97706, #b45309);
        }

        .challenge-word.completed {
            background: linear-gradient(145deg, #10b981, #059669);
            opacity: 0.7;
            cursor: pointer;
        }

        .challenge-word.current {
            background: linear-gradient(145deg, #ef4444, #dc2626);
            animation: pulse-challenge 1.5s infinite;
        }

        .challenge-word.wrong {
            background: linear-gradient(145deg, #ef4444, #dc2626);
            color: white;
            border-color: #b91c1c;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes pulse-challenge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .no-challenge {
            color: #f59e0b;
            font-style: italic;
            font-size: 16px;
            text-align: center;
            margin-top: 15px;
            opacity: 0.7;
        }

        /* Ïª®Ìä∏Î°§ Î≤ÑÌäºÎì§ */
        .control-buttons {
            display: none;
        }

        .sound-toggle, .reset-btn {
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s ease;
            touch-action: manipulation;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
            height: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reset-btn {
            background: linear-gradient(145deg, #dc3545, #c82333);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);
        }

        .sound-toggle.muted {
            background: linear-gradient(145deg, #6b7280, #4b5563);
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
        }

        .sound-toggle:active, .reset-btn:active {
            background: linear-gradient(145deg, #059669, #047857);
        }

        .reset-btn:active {
            background: linear-gradient(145deg, #c82333, #b91c1c);
        }

        /* ===== Ï§ëÏïô Ìå®ÎÑê ===== */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: 18px;
            overflow: hidden;
        }

        #keyboard-view {
            display: flex;
            flex-direction: column;
            gap: 18px;
            flex: 1;
            overflow: hidden;
        }

        /* ÌÖçÏä§Ìä∏ ÎîîÏä§ÌîåÎ†àÏù¥ */
        .text-display {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 3px solid #e2e8f0;
            border-radius: 18px;
            padding: 30px;
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 90px;
            font-weight: 700;
            flex-wrap: wrap;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.06),
                0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .text-display:active {
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            border-color: #cbd5e1;
        }

        .word-char {
            color: #059669;
            opacity: 0.9;
            text-shadow: 0 2px 4px rgba(5, 150, 105, 0.1);
        }

        .current-char {
            color: #dc2626;
            text-shadow: 0 2px 4px rgba(220, 38, 38, 0.1);
        }

        /* ÏûÖÎ†• ÏòÅÏó≠ */
        .input-area {
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            border-radius: 16px;
            padding: 18px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.06);
            display: grid;
            grid-template-columns: 1fr 3px 1fr;
            gap: 18px;
            flex: 1;
            overflow: hidden;
        }

        /* ÏûêÏùå ÏòÅÏó≠ */
        .consonant-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .consonant-title {
            text-align: center;
            font-size: 26px;
            font-weight: 700;
            color: #3b82f6;
            padding: 14px;
            background: linear-gradient(145deg, #dbeafe, #bfdbfe);
            border-radius: 15px;
            border: 2px solid #3b82f6;
            flex-shrink: 0;
        }

        .consonant-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .consonant-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #3b82f6 transparent;
        }

        .double-consonant-title {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: #3b82f6;
            padding: 14px;
            background: linear-gradient(145deg, #dbeafe, #bfdbfe);
            border-radius: 15px;
            border: 2px solid #3b82f6;
            flex-shrink: 0;
        }

        .double-consonant-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #3b82f6 transparent;
        }

        .consonant-grid::-webkit-scrollbar, .double-consonant-grid::-webkit-scrollbar {
            width: 4px;
        }

        .consonant-grid::-webkit-scrollbar-track, .double-consonant-grid::-webkit-scrollbar-track {
            background: transparent;
        }

        .consonant-grid::-webkit-scrollbar-thumb, .double-consonant-grid::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 2px;
        }

        /* Í≤ΩÍ≥ÑÏÑ† */
        .divider {
            background: linear-gradient(to bottom, #e2e8f0, #cbd5e1, #e2e8f0);
            border-radius: 2px;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: #94a3b8;
            border-radius: 50%;
        }

        /* Î™®Ïùå ÏòÅÏó≠ */
        .vowel-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .vowel-title {
            text-align: center;
            font-size: 26px;
            font-weight: 700;
            color: #f59e0b;
            padding: 14px;
            background: linear-gradient(145deg, #fef3c7, #fde68a);
            border-radius: 15px;
            border: 2px solid #f59e0b;
            flex-shrink: 0;
        }

        .vowel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .vowel-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #f59e0b transparent;
        }

        .double-vowel-title {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: #f59e0b;
            padding: 14px;
            background: linear-gradient(145deg, #fef3c7, #fde68a);
            border-radius: 15px;
            border: 2px solid #f59e0b;
            flex-shrink: 0;
        }

        .double-vowel-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #f59e0b transparent;
        }

        .vowel-grid::-webkit-scrollbar, .double-vowel-grid::-webkit-scrollbar {
            width: 4px;
        }

        .vowel-grid::-webkit-scrollbar-track, .double-vowel-grid::-webkit-scrollbar-track {
            background: transparent;
        }

        .vowel-grid::-webkit-scrollbar-thumb, .double-vowel-grid::-webkit-scrollbar-thumb {
            background: #f59e0b;
            border-radius: 2px;
        }

        /* Í∏ÄÏûê Î≤ÑÌäº - ÎÜíÏù¥ Ï¶ùÍ∞Ä (ÌÑ∞Ïπò Ìé∏Ïùò) */
        .char-btn {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 28px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.15s ease, border-color 0.15s ease;
            color: #1e293b;
            touch-action: manipulation;
            height: 75px;
            min-height: 75px;
            max-height: 75px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow:
                0 2px 8px rgba(0,0,0,0.08),
                inset 0 1px 0 rgba(255,255,255,0.5);
            flex-shrink: 0;
        }

        .char-btn:active {
            background: linear-gradient(145deg, #dbeafe, #bfdbfe);
            border-color: #3b82f6;
        }

        .char-btn.speaking {
            background: linear-gradient(145deg, #fbbf24, #f59e0b);
            color: #78350f;
            border-color: #f59e0b;
            box-shadow: 
                0 4px 15px rgba(251, 191, 36, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .char-btn.empty {
            background: linear-gradient(145deg, #f1f5f9, #e2e8f0);
            border: 2px solid #cbd5e1;
            cursor: default;
            pointer-events: none;
        }

        /* ===== Ïò§Î•∏Ï™Ω Ìå®ÎÑê ===== */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .action-btn {
            border: none;
            border-radius: 20px;
            font-size: 42px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.1s ease;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex: 1;
            min-height: 70px;
            font-family: inherit;
            color: white;
            letter-spacing: 1px;
        }
        .action-btn .icon { font-size: 38px; opacity: 0.9; }
        .action-btn:active { transform: scale(0.95); }

        .action-btn.read {
            background: linear-gradient(145deg, #06b6d4, #0891b2);
            color: white;
            box-shadow: 0 2px 8px rgba(6, 182, 212, 0.2);
        }

        .action-btn.read:active {
            background: linear-gradient(145deg, #0891b2, #0e7490);
        }

        .action-btn.complete {
            background: linear-gradient(145deg, #fbbf24, #f59e0b);
            color: #78350f;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
       }

       .action-btn.complete:active {
           background: linear-gradient(145deg, #f59e0b, #d97706);
       }

        .action-btn.backspace {
            background: linear-gradient(145deg, #f87171, #ef4444);
            color: white;
            box-shadow: 0 2px 8px rgba(248, 113, 113, 0.2);
        }

        .action-btn.backspace:active {
            background: linear-gradient(145deg, #ef4444, #dc2626);
        }

       .action-btn:disabled {
           background: linear-gradient(145deg, #e5e7eb, #d1d5db);
           color: #9ca3af;
           cursor: not-allowed;
           box-shadow: none;
       }

       .action-btn:disabled:active {
           background: linear-gradient(145deg, #e5e7eb, #d1d5db);
       }

       /* Í¥ÄÎ¶¨Ïûê Î™®Îã¨ */
       .admin-modal {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background: rgba(0, 0, 0, 0.8);
          z-index: 2000;
          display: flex;
          align-items: center;
          justify-content: center;
          backdrop-filter: blur(10px);
      }

      .admin-modal.hidden {
          display: none;
      }

      .admin-content {
          background: white;
          border-radius: 20px;
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 25px 50px rgba(0,0,0,0.3);
      }

      .admin-header {
          background: linear-gradient(145deg, #3b82f6, #2563eb);
          color: white;
          padding: 20px;
          border-radius: 20px 20px 0 0;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .admin-header h3 {
          margin: 0;
          font-size: 18px;
      }

      .close-admin {
          background: none;
          border: none;
          color: white;
          font-size: 24px;
          cursor: pointer;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .close-admin:hover {
          background: rgba(255,255,255,0.2);
      }

      .admin-body {
          padding: 20px;
      }

      .admin-section {
          margin-bottom: 25px;
          padding: 15px;
          border-radius: 10px;
          background: #f8fafc;
      }

      .admin-section h4 {
          margin: 0 0 15px 0;
          font-weight: 700;
          color: #374151;
          font-size: 16px;
      }

      .profile-controls {
          display: grid;
          gap: 10px;
      }

      .profile-controls input {
          padding: 12px;
          border: 2px solid #e5e7eb;
          border-radius: 8px;
          font-size: 14px;
          transition: border-color 0.2s ease;
      }

      .profile-controls input:focus {
          outline: none;
          border-color: #3b82f6;
          box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .level-controls {
          display: grid;
          grid-template-columns: 1fr auto;
          gap: 10px;
          align-items: center;
      }

      .word-inputs {
          display: grid;
          gap: 10px;
          margin-bottom: 20px;
      }

      .word-inputs input {
          padding: 12px;
          border: 2px solid #e5e7eb;
          border-radius: 8px;
          font-size: 14px;
          transition: border-color 0.2s ease;
      }

      .word-inputs input:focus {
          outline: none;
          border-color: #3b82f6;
          box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .admin-btn {
          padding: 12px 20px;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: background 0.15s ease;
      }

      .save-words-btn {
          width: 100%;
          background: linear-gradient(145deg, #10b981, #059669);
          color: white;
      }

      .save-profile-btn {
          background: linear-gradient(145deg, #3b82f6, #2563eb);
          color: white;
      }

      .reset-all-btn {
          background: linear-gradient(145deg, #ef4444, #dc2626);
          color: white;
      }

      /* Ï∫êÎ¶≠ÌÑ∞ Î™®Îã¨ */
      .character-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          z-index: 3000;
          display: flex;
          align-items: center;
          justify-content: center;
          backdrop-filter: blur(10px);
      }

      .character-modal.hidden {
          display: none;
      }

      .character-content {
          background: white;
          border-radius: 20px;
          width: 90%;
          max-width: 800px;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 25px 50px rgba(0,0,0,0.3);
      }

      .character-header {
          background: linear-gradient(145deg, #8b5cf6, #7c3aed);
          color: white;
          padding: 20px;
          border-radius: 20px 20px 0 0;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .character-header h3 {
          margin: 0;
          font-size: 18px;
      }

      .close-character {
          background: none;
          border: none;
          color: white;
          font-size: 24px;
          cursor: pointer;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .close-character:hover {
          background: rgba(255,255,255,0.2);
      }

      .character-body {
          padding: 20px;
      }

      .character-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
          gap: 15px;
          max-height: 400px;
          overflow-y: auto;
      }

      .character-item {
          background: linear-gradient(145deg, #f8fafc, #e2e8f0);
          border: 2px solid #cbd5e1;
          border-radius: 15px;
          padding: 18px;
          text-align: center;
          cursor: pointer;
          transition: all 0.2s ease;
          font-size: 44px;
          height: 95px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 5px;
      }

      .character-item:hover {
          background: linear-gradient(145deg, #dbeafe, #bfdbfe);
          border-color: #3b82f6;
          transform: scale(1.05);
      }

      .character-item.selected {
          background: linear-gradient(145deg, #fbbf24, #f59e0b);
          border-color: #f59e0b;
          color: #78350f;
      }

      .character-level {
          font-size: 15px;
          font-weight: 600;
          color: #6b7280;
      }

      /* üéÜ Î©ãÏßÑ Î†àÎ≤®ÏóÖ Ïï†ÎãàÎ©îÏù¥ÏÖò */
      .levelup-animation {
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: radial-gradient(circle, rgba(59,130,246,0.1) 0%, rgba(147,51,234,0.2) 100%);
          z-index: 3000;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: levelupFadeIn 0.5s ease-out;
      }

      @keyframes levelupFadeIn {
          0% { opacity: 0; }
          100% { opacity: 1; }
      }

      .levelup-content {
          text-align: center;
          position: relative;
      }

      .levelup-title {
          font-size: 80px;
          font-weight: 900;
          background: linear-gradient(45deg, #fbbf24, #f59e0b, #ef4444, #8b5cf6, #06b6d4);
          background-size: 300% 300%;
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          animation: rainbowText 2s ease-in-out infinite;
          text-shadow: 0 0 30px rgba(251, 191, 36, 0.5);
          margin-bottom: 20px;
      }

      @keyframes rainbowText {
          0%, 100% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
      }

      .levelup-subtitle {
          font-size: 32px;
          font-weight: 700;
          color: white;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
          margin-bottom: 30px;
      }

      .levelup-character {
          font-size: 120px;
          animation: characterBounce 1s ease-in-out infinite;
          margin: 20px 0;
      }

      @keyframes characterBounce {
          0%, 100% { transform: translateY(0) scale(1); }
          50% { transform: translateY(-20px) scale(1.1); }
      }

      /* Ìè≠Ï£Ω Ìö®Í≥º */
      .firework {
          position: absolute;
          width: 6px;
          height: 6px;
          border-radius: 50%;
          animation: fireworkExplode 2s ease-out infinite;
      }

      .firework:nth-child(1) { background: #ff6b6b; left: 10%; top: 20%; animation-delay: 0s; }
      .firework:nth-child(2) { background: #4ecdc4; right: 10%; top: 30%; animation-delay: 0.2s; }
      .firework:nth-child(3) { background: #45b7d1; left: 20%; bottom: 20%; animation-delay: 0.4s; }
      .firework:nth-child(4) { background: #f9ca24; right: 20%; bottom: 30%; animation-delay: 0.6s; }
      .firework:nth-child(5) { background: #6c5ce7; left: 50%; top: 10%; animation-delay: 0.8s; }
      .firework:nth-child(6) { background: #a29bfe; right: 50%; bottom: 10%; animation-delay: 1s; }

      @keyframes fireworkExplode {
          0% {
              transform: scale(0);
              opacity: 1;
          }
          50% {
              transform: scale(20);
              opacity: 0.8;
          }
          100% {
              transform: scale(40);
              opacity: 0;
          }
      }

      /* ÏÑ±Í≥µ Î©îÏãúÏßÄ Ïï†ÎãàÎ©îÏù¥ÏÖò */
      .success-message {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) scale(0);
          background: linear-gradient(145deg, #10b981, #059669);
          color: white;
          padding: 30px 50px;
          border-radius: 25px;
          font-size: 36px;
          font-weight: 700;
          z-index: 1001;
          box-shadow: 
              0 25px 50px rgba(16, 185, 129, 0.4),
              0 15px 30px rgba(0,0,0,0.2);
          animation: success-popup 2.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
          text-align: center;
          backdrop-filter: blur(10px);
      }

      @keyframes success-popup {
          0% {
              transform: translate(-50%, -50%) scale(0) rotate(-180deg);
              opacity: 0;
          }
          60% {
              transform: translate(-50%, -50%) scale(1.15) rotate(10deg);
              opacity: 1;
          }
          100% {
              transform: translate(-50%, -50%) scale(1) rotate(0deg);
              opacity: 1;
          }
      }

      .star {
          position: absolute;
          width: 20px;
          height: 20px;
          background: linear-gradient(45deg, #fbbf24, #f59e0b);
          clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
          animation: star-twinkle 1.2s ease-in-out infinite alternate;
          box-shadow: 0 0 10px rgba(251, 191, 36, 0.6);
      }

      @keyframes star-twinkle {
          0% {
              transform: scale(0.8) rotate(0deg);
              opacity: 0.7;
          }
          100% {
              transform: scale(1.3) rotate(180deg);
              opacity: 1;
          }
      }

      .rainbow-text {
          background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24, #6c5ce7, #a29bfe);
          background-size: 400% 400%;
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          animation: rainbow-flow 2.5s ease-in-out infinite;
      }

      @keyframes rainbow-flow {
          0%, 100% {
              background-position: 0% 50%;
          }
          50% {
              background-position: 100% 50%;
          }
      }

      .touching {
          background: linear-gradient(145deg, #dbeafe, #bfdbfe) !important;
          border-color: #3b82f6 !important;
      }

      /* ===== Ï°∞Ìï©Ìëú (Í∞ÄÏö¥Îç∞ ÏòÅÏó≠) ===== */
      .chart-view {
          display: flex;
          flex-direction: column;
          height: 100%;
          overflow: hidden;
      }

      .chart-view.hidden {
          display: none;
      }

      .chart-header {
          text-align: center;
          padding: 8px 0;
          flex-shrink: 0;
      }

      .chart-header-title {
          font-size: 26px;
          font-weight: 800;
          color: #1e3a8a;
          margin-bottom: 2px;
      }

      .chart-header-desc {
          font-size: 16px;
          color: #64748b;
      }

      /* Í∏ÄÏûêÌëú ÏôºÏ™Ω ÏûêÏùå ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
      .chart-nav-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          grid-auto-rows: 1fr;
          gap: 6px;
          padding: 6px;
          height: 100%;
      }
      .chart-nav-btn {
          border-radius: 10px;
          border: 2px solid #e2e8f0;
          background: white;
          font-size: 26px;
          font-weight: 700;
          color: #1e293b;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.15s ease;
      }
      .chart-nav-btn.active {
          background: linear-gradient(145deg, #8b5cf6, #7c3aed);
          color: white;
          border-color: #8b5cf6;
      }
      .chart-nav-btn:active { transform: scale(0.93); }

      .chart-grid-wrapper {
          flex: 1;
          overflow: auto;
          border-radius: 14px;
          background: linear-gradient(145deg, #f8fafc, #f1f5f9);
          border: 2px solid #e2e8f0;
          scrollbar-width: thin;
          scrollbar-color: #94a3b8 transparent;
          padding: 14px;
          box-shadow: inset 0 2px 6px rgba(0,0,0,0.04);
      }

      .chart-grid-wrapper::-webkit-scrollbar {
          width: 5px;
          height: 5px;
      }
      .chart-grid-wrapper::-webkit-scrollbar-thumb {
          background: #94a3b8;
          border-radius: 3px;
      }

      /* ÏûêÏùå ÏÑ†ÌÉù Î∞î */
      .chart-consonant-bar {
          display: flex;
          gap: 6px;
          flex-wrap: wrap;
          justify-content: center;
          margin-bottom: 14px;
      }
      .chart-consonant-btn {
          width: 62px;
          height: 52px;
          border-radius: 10px;
          border: 2px solid #e2e8f0;
          background: white;
          font-size: 24px;
          font-weight: 700;
          color: #475569;
          cursor: pointer;
          transition: all 0.15s ease;
          display: flex;
          align-items: center;
          justify-content: center;
      }
      .chart-consonant-btn.active {
          background: linear-gradient(145deg, #3b82f6, #2563eb);
          color: white;
          border-color: #3b82f6;
          box-shadow: 0 3px 10px rgba(59,130,246,0.3);
          transform: scale(1.05);
      }
      .chart-consonant-btn:active {
          transform: scale(0.95);
      }

      /* ÏÑ†ÌÉùÎêú ÏûêÏùå ÌëúÏãú */
      .chart-selected-label {
          text-align: center;
          font-size: 18px;
          font-weight: 700;
          color: #64748b;
          margin-bottom: 10px;
      }
      .chart-selected-label span {
          color: #2563eb;
          font-size: 24px;
      }

      /* Í∏ÄÏûê Ïπ¥Îìú Í∑∏Î¶¨Îìú */
      .chart-card-grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 10px;
          margin-bottom: 16px;
      }
      .chart-card {
          background: white;
          border: 2px solid #e2e8f0;
          border-radius: 14px;
          padding: 18px 10px;
          text-align: center;
          cursor: pointer;
          transition: all 0.15s ease;
          box-shadow: 0 2px 6px rgba(0,0,0,0.04);
      }
      .chart-card:active {
          transform: scale(0.95);
          border-color: #3b82f6;
          background: #f0f7ff;
      }
      .chart-card-char {
          font-size: 40px;
          font-weight: 800;
          color: #1e293b;
          line-height: 1.2;
      }
      .chart-card-desc {
          font-size: 15px;
          color: #94a3b8;
          margin-top: 4px;
          font-weight: 600;
      }

      /* ÏÑπÏÖò Íµ¨Î∂Ñ */
      .chart-section-divider {
          height: 2px;
          background: linear-gradient(90deg, transparent, #cbd5e1, transparent);
          margin: 16px 0;
      }

      .chart-section-title {
          font-size: 20px;
          font-weight: 700;
          text-align: center;
          padding: 10px 14px;
          border-radius: 12px;
          margin-bottom: 10px;
          color: #92400e;
          background: linear-gradient(145deg, #fef3c7, #fde68a);
          border: 2px solid #f59e0b;
      }

      /* Î™®Ïùå Ï°∞Ìï© Ïπ¥Îìú */
      .vowel-combo-grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 10px;
      }

      .vowel-combo-card {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          background: white;
          border: 2px solid #fde68a;
          border-radius: 12px;
          padding: 18px 10px;
          cursor: pointer;
          transition: all 0.15s ease;
          box-shadow: 0 2px 6px rgba(0,0,0,0.04);
      }
      .vowel-combo-card:active {
          transform: scale(0.96);
          border-color: #f59e0b;
          background: #fffbeb;
      }
      .vc-part {
          font-size: 28px;
          font-weight: 800;
          color: #d97706;
      }
      .vc-plus {
          font-size: 18px;
          color: #9ca3af;
          font-weight: 700;
      }
      .vc-eq {
          font-size: 20px;
          color: #6b7280;
          font-weight: 700;
      }
      .vc-result {
          font-size: 34px;
          font-weight: 900;
          color: #1e3a8a;
      }

      /* ===== Îî∞ÎùºÏì∞Í∏∞ ===== */
      .trace-view {
          display: flex;
          flex-direction: column;
          height: 100%;
      }
      .trace-view.hidden { display: none; }

      .trace-canvas-area {
          flex: 1;
          display: flex;
          flex-direction: column;
          background: white;
          border-radius: 18px;
          border: 3px solid #e2e8f0;
          overflow: hidden;
          box-shadow: inset 0 2px 6px rgba(0,0,0,0.04);
      }
      .trace-top-bar {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 12px;
          padding: 10px 16px;
          background: linear-gradient(145deg, #f8fafc, #f1f5f9);
          border-bottom: 2px solid #e2e8f0;
          flex-shrink: 0;
      }
      .trace-nav-btn {
          width: 52px; height: 52px;
          border-radius: 12px;
          border: 2px solid #cbd5e1;
          background: white;
          font-size: 24px;
          cursor: pointer;
          display: flex; align-items: center; justify-content: center;
          color: #475569;
          transition: all 0.15s ease;
      }
      .trace-nav-btn:active { background: #e2e8f0; transform: scale(0.95); }
      .trace-current-label {
          font-size: 44px;
          font-weight: 900;
          color: #1e3a8a;
          min-width: 70px;
          text-align: center;
      }
      .trace-listen-btn {
          width: 52px; height: 52px;
          border-radius: 12px;
          border: 2px solid #3b82f6;
          background: linear-gradient(145deg, #dbeafe, #bfdbfe);
          font-size: 24px;
          cursor: pointer;
          display: flex; align-items: center; justify-content: center;
          transition: all 0.15s ease;
      }
      .trace-listen-btn:active { transform: scale(0.95); }
      .trace-clear-btn {
          width: 52px; height: 52px;
          border-radius: 12px;
          border: 2px solid #fca5a5;
          background: linear-gradient(145deg, #fef2f2, #fee2e2);
          font-size: 24px;
          cursor: pointer;
          display: flex; align-items: center; justify-content: center;
          transition: all 0.15s ease;
      }
      .trace-clear-btn:active { transform: scale(0.95); }
      .trace-eval-btn {
          height: 52px;
          border-radius: 12px;
          border: 2px solid #f59e0b;
          background: linear-gradient(145deg, #fef3c7, #fde68a);
          font-size: 18px;
          font-weight: 700;
          color: #92400e;
          cursor: pointer;
          padding: 0 18px;
          transition: all 0.15s ease;
          white-space: nowrap;
      }
      .trace-eval-btn:active { transform: scale(0.95); }

      /* ÌèâÍ∞Ä Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ */
      .trace-result-overlay {
          position: absolute;
          inset: 0;
          background: rgba(255,255,255,0.92);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 100;
          animation: comboFadeIn 0.3s ease;
          border-radius: 18px;
      }
      .trace-result-stars {
          font-size: 72px;
          margin-bottom: 12px;
          animation: comboResult 0.5s cubic-bezier(0.34,1.56,0.64,1) 0.1s both;
      }
      .trace-result-score {
          font-size: 44px;
          font-weight: 900;
          color: #1e293b;
          margin-bottom: 8px;
      }
      .trace-result-msg {
          font-size: 26px;
          font-weight: 700;
          color: #64748b;
          margin-bottom: 20px;
      }
      .trace-result-btns {
          display: flex;
          gap: 12px;
      }
      .trace-result-btns button {
          padding: 14px 28px;
          border-radius: 12px;
          font-size: 20px;
          font-weight: 700;
          cursor: pointer;
          border: none;
          transition: all 0.15s ease;
      }
      .trace-result-btns button:active { transform: scale(0.95); }
      .trace-retry-btn {
          background: linear-gradient(145deg, #3b82f6, #2563eb);
          color: white;
      }
      .trace-next-btn {
          background: linear-gradient(145deg, #10b981, #059669);
          color: white;
      }

      .trace-canvas-wrapper {
          flex: 1;
          position: relative;
          touch-action: none;
      }
      .trace-canvas-wrapper canvas {
          position: absolute;
          top: 0; left: 0;
          width: 100%; height: 100%;
      }
      .trace-bottom-hint {
          text-align: center;
          padding: 10px;
          font-size: 17px;
          font-weight: 600;
          color: #94a3b8;
          background: linear-gradient(145deg, #f8fafc, #f1f5f9);
          border-top: 2px solid #e2e8f0;
          flex-shrink: 0;
      }

      /* ÏôºÏ™Ω Îî∞ÎùºÏì∞Í∏∞ Ìå®ÎÑê */
      .trace-left-panel {
          display: flex;
          flex-direction: column;
          gap: 8px;
          height: 100%;
          overflow: hidden;
      }
      .trace-category-title {
          font-size: 19px;
          font-weight: 700;
          color: #1e3a8a;
          text-align: center;
      }
      .trace-category-btns {
          display: flex;
          gap: 6px;
          flex-shrink: 0;
      }
      .trace-cat-btn {
          flex: 1;
          padding: 10px;
          border-radius: 10px;
          border: 2px solid #e2e8f0;
          background: white;
          font-size: 17px;
          font-weight: 700;
          color: #475569;
          cursor: pointer;
          transition: all 0.15s ease;
          text-align: center;
      }
      .trace-cat-btn.active {
          background: linear-gradient(145deg, #3b82f6, #2563eb);
          color: white;
          border-color: #3b82f6;
      }
      .trace-letter-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          grid-auto-rows: 1fr;
          gap: 6px;
          flex: 1;
      }
      .trace-letter-btn {
          border-radius: 10px;
          border: 2px solid #e2e8f0;
          background: white;
          font-size: 26px;
          font-weight: 700;
          color: #1e293b;
          cursor: pointer;
          transition: all 0.15s ease;
          display: flex;
          align-items: center;
          justify-content: center;
      }
      .trace-letter-btn.active {
          background: linear-gradient(145deg, #dbeafe, #bfdbfe);
          border-color: #3b82f6;
          color: #1e40af;
      }
      .trace-letter-btn:active { transform: scale(0.93); }

      /* Ï°∞Ìï© Ïï†ÎãàÎ©îÏù¥ÏÖò Ïò§Î≤ÑÎ†àÏù¥ */
      .combo-overlay {
          position: fixed;
          inset: 0;
          background: rgba(15,23,42,0.65);
          z-index: 9000;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: comboFadeIn 0.3s ease;
      }
      @keyframes comboFadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
      }
      .combo-box {
          background: white;
          border-radius: 24px;
          padding: 40px 50px;
          text-align: center;
          box-shadow: 0 25px 60px rgba(0,0,0,0.25);
          border: 3px solid #e2e8f0;
          position: relative;
      }
      .combo-parts {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 20px;
          margin-bottom: 20px;
      }
      .combo-char {
          font-size: 78px;
          font-weight: 800;
          color: #2563eb;
          animation: comboSlideIn 0.4s ease-out;
      }
      .combo-char:nth-child(1) { animation-delay: 0s; }
      .combo-plus { font-size: 52px; color: #94a3b8; font-weight: 800; animation: comboSlideIn 0.4s ease-out 0.15s both; }
      .combo-char:nth-child(3) { animation-delay: 0.3s; animation-fill-mode: both; }
      @keyframes comboSlideIn {
          from { opacity: 0; transform: translateY(-40px) scale(0.5); }
          to { opacity: 1; transform: translateY(0) scale(1); }
      }
      .combo-arrow {
          font-size: 48px;
          color: #94a3b8;
          margin: 14px 0;
          animation: comboArrow 0.4s ease-out 0.6s both;
      }
      @keyframes comboArrow {
          from { opacity: 0; transform: scaleY(0); }
          to { opacity: 1; transform: scaleY(1); }
      }
      .combo-result {
          font-size: 105px;
          font-weight: 900;
          color: #1e293b;
          animation: comboResult 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.9s both;
      }
      @keyframes comboResult {
          from { opacity: 0; transform: scale(0) rotate(-20deg); }
          to { opacity: 1; transform: scale(1) rotate(0deg); }
      }
      .combo-sound-label {
          margin-top: 12px;
          font-size: 28px;
          color: #6b7280;
          font-weight: 600;
          animation: comboSlideIn 0.3s ease-out 1.2s both;
      }
      .combo-btn-row {
          display: flex;
          gap: 14px;
          justify-content: center;
          margin-top: 18px;
          animation: comboSlideIn 0.3s ease-out 1.2s both;
      }
      .combo-speak-btn {
          background: linear-gradient(145deg, #3b82f6, #2563eb);
          color: white;
          border: none;
          border-radius: 12px;
          padding: 14px 26px;
          font-size: 22px;
          font-weight: 700;
          cursor: pointer;
          box-shadow: 0 3px 10px rgba(59,130,246,0.25);
          transition: all 0.15s ease;
      }
      .combo-speak-btn:active {
          transform: scale(0.95);
          box-shadow: 0 2px 6px rgba(59,130,246,0.3);
      }
      .combo-close-btn {
          background: linear-gradient(145deg, #f1f5f9, #e2e8f0);
          color: #475569;
          border: 2px solid #cbd5e1;
          border-radius: 12px;
          padding: 14px 26px;
          font-size: 22px;
          font-weight: 700;
          cursor: pointer;
          box-shadow: 0 3px 10px rgba(0,0,0,0.06);
          transition: all 0.15s ease;
      }
      .combo-close-btn:active {
          transform: scale(0.95);
          background: linear-gradient(145deg, #e2e8f0, #cbd5e1);
      }

      /* ===== Í≤åÏûÑ Ïã§Ìñâ Î≤ÑÌäº (Ï§ëÏïô ÌïòÎã®) ===== */
      .game-launch-btn {
          flex-shrink: 0;
          background: linear-gradient(145deg, #fbbf24, #f59e0b);
          color: #78350f;
          border: 3px solid white;
          border-radius: 16px;
          padding: 14px;
          font-size: 24px;
          font-weight: 800;
          cursor: pointer;
          text-align: center;
          box-shadow: 0 4px 15px rgba(251,191,36,0.4);
          font-family: inherit;
          animation: gameBtnPulse 2s ease-in-out infinite;
      }
      @keyframes gameBtnPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.02)} }
      .game-launch-btn:active { transform: scale(0.97); }

      /* ===== Í∏ÄÏûê ÌûàÏñ¥Î°ú Í≤åÏûÑ ===== */
      .falling-game {
          position: absolute;
          top: 0;
          left: 0;
          width: 1920px;
          height: 1080px;
          z-index: 5000;
          display: flex;
          flex-direction: column;
          background: linear-gradient(180deg, #e0f2fe 0%, #bae6fd 25%, #a7f3d0 75%, #6ee7b7 100%);
          overflow: hidden;
      }

      .falling-game.hidden {
          display: none;
      }

      .game-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 14px 24px;
          background: rgba(255,255,255,0.35);
          backdrop-filter: blur(12px);
          flex-shrink: 0;
          z-index: 10;
          border-bottom: 2px solid rgba(255,255,255,0.4);
      }

      .game-stat {
          font-size: 26px;
          font-weight: 800;
          color: #1e3a8a;
          text-shadow: 0 1px 2px rgba(255,255,255,0.6);
      }

      .game-hearts {
          font-size: 32px;
          letter-spacing: 5px;
      }

      .game-controls-top {
          display: flex;
          gap: 10px;
      }

      .game-ctrl-btn {
          background: rgba(255,255,255,0.6);
          border: 2px solid rgba(255,255,255,0.8);
          border-radius: 50%;
          width: 54px;
          height: 54px;
          font-size: 24px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #475569;
          backdrop-filter: blur(5px);
          transition: all 0.15s ease;
      }
      .game-ctrl-btn:active { transform: scale(0.9); }

      .game-arena {
          flex: 1;
          position: relative;
          overflow: hidden;
      }

      .game-ground {
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          height: 12%;
          background: linear-gradient(180deg, #86efac 0%, #4ade80 100%);
          border-top: 4px solid #34d399;
          border-radius: 50% 50% 0 0 / 20px 20px 0 0;
      }

      .game-ground::before {
          content: 'üåøüå∏üå±üåºüåøüå∏üå±üåºüåøüå∏üå±üåºüåøüå∏üå±';
          position: absolute;
          top: -16px;
          left: 0;
          width: 200%;
          font-size: 18px;
          letter-spacing: 10px;
      }

      /* Îñ®Ïñ¥ÏßÄÎäî Í∏ÄÏûê - Í∑ÄÏó¨Ïö¥ Î≤ÑÎ∏î */
      .falling-char {
          position: absolute;
          font-size: 48px;
          font-weight: 900;
          color: white;
          z-index: 5;
          pointer-events: none;
          transition: none;
          animation: charBounce 1.5s ease-in-out infinite;
      }
      @keyframes charBounce {
          0%, 100% { transform: rotate(-3deg); }
          50% { transform: rotate(3deg); }
      }

      .falling-char .char-bubble {
          background: linear-gradient(145deg, #a78bfa, #8b5cf6);
          border-radius: 22px;
          padding: 14px 24px;
          border: 3px solid rgba(255,255,255,0.6);
          box-shadow: 0 8px 24px rgba(139,92,246,0.35), inset 0 2px 4px rgba(255,255,255,0.3);
          display: inline-block;
          min-width: 80px;
          text-align: center;
          text-shadow: 0 2px 4px rgba(0,0,0,0.2);
          transition: all 0.25s ease;
      }

      /* ÏûêÏùå Îß§Ïπ≠ ‚Üí ÌååÎûÄ ÏßëÏ§ë Ìö®Í≥º */
      .falling-char.cho-match .char-bubble {
          background: linear-gradient(145deg, #3b82f6, #2563eb);
          border-color: #93c5fd;
          transform: scale(1.15);
          box-shadow: 0 0 30px rgba(59,130,246,0.5), 0 0 60px rgba(59,130,246,0.2), 0 8px 24px rgba(59,130,246,0.4);
          animation: choMatchPulse 0.8s ease-in-out infinite;
      }
      @keyframes choMatchPulse {
          0%,100% { box-shadow: 0 0 30px rgba(59,130,246,0.5), 0 0 60px rgba(59,130,246,0.2), 0 8px 24px rgba(59,130,246,0.4); }
          50% { box-shadow: 0 0 45px rgba(59,130,246,0.7), 0 0 80px rgba(59,130,246,0.3), 0 8px 24px rgba(59,130,246,0.5); }
      }
      .falling-char.cho-match .cho-indicator {
          display: block;
      }
      .cho-indicator {
          display: none;
          position: absolute;
          top: -12px;
          right: -8px;
          background: #3b82f6;
          color: white;
          font-size: 16px;
          font-weight: 800;
          padding: 2px 8px;
          border-radius: 10px;
          border: 2px solid white;
          box-shadow: 0 2px 8px rgba(59,130,246,0.4);
          animation: choIndicatorPop 0.3s cubic-bezier(0.34,1.56,0.64,1);
      }
      @keyframes choIndicatorPop {
          from { transform: scale(0); }
          to { transform: scale(1); }
      }

      /* ÏôÑÏ†Ñ Îß§Ïπ≠ ‚Üí Í∏àÏÉâ Ìè≠Î∞ú ÏßÅÏ†Ñ */
      .falling-char.full-match .char-bubble {
          background: linear-gradient(145deg, #fbbf24, #f59e0b);
          border-color: #fde68a;
          transform: scale(1.3);
          box-shadow: 0 0 50px rgba(245,158,11,0.6), 0 0 100px rgba(245,158,11,0.25);
          animation: fullMatchGlow 0.4s ease;
      }
      @keyframes fullMatchGlow {
          0% { transform: scale(1.15); }
          50% { transform: scale(1.4); }
          100% { transform: scale(1.3); }
      }

      /* Íµ¨Î¶Ñ Ïû•Ïãù */
      .game-cloud,.hg-cloud{position:absolute;opacity:.25;pointer-events:none;animation:cloudFloat 20s linear infinite;z-index:1}
      @keyframes cloudFloat{0%{transform:translateX(-100px)}100%{transform:translateX(2020px)}}
      .hg-deco{position:absolute;pointer-events:none;z-index:1;opacity:0.08;animation:decoFloat var(--dur,6s) ease-in-out infinite}
      @keyframes decoFloat{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-15px) rotate(5deg)}50%{transform:translateY(-5px) rotate(-3deg)}75%{transform:translateY(-20px) rotate(4deg)}}
      .hg-bg-sparkle{position:absolute;pointer-events:none;z-index:2;animation:bgSparkle var(--dur,3s) ease-in-out infinite}
      @keyframes bgSparkle{0%,100%{transform:scale(.6);opacity:.3}50%{transform:scale(1.2);opacity:.8}}

      /* ÎßûÏ∂§ ÏÑ±Í≥µ Ìö®Í≥º */
      .char-explode {
          position: absolute;
          font-size: 40px;
          z-index: 20;
          pointer-events: none;
          animation: explodeEffect 0.8s ease-out forwards;
      }

      @keyframes explodeEffect {
          0% { transform: scale(1); opacity: 1; }
          50% { transform: scale(2.2); opacity: 0.8; }
          100% { transform: scale(3) translateY(-50px); opacity: 0; }
      }

      .star-burst {
          position: absolute;
          font-size: 28px;
          z-index: 20;
          pointer-events: none;
          animation: starBurst 0.6s ease-out forwards;
      }

      @keyframes starBurst {
          0% { transform: scale(0) rotate(0deg); opacity: 1; }
          100% { transform: scale(1.5) rotate(180deg) translateY(-80px); opacity: 0; }
      }

      /* Í≤åÏûÑ ÏûÖÎ†• ÏòÅÏó≠ - ÎÑìÍ≥† ÌÅ∞ ÌÇ§Î≥¥Îìú */
      .game-input-area {
          background: rgba(255,255,255,0.4);
          backdrop-filter: blur(15px);
          padding: 14px 20px 18px;
          flex-shrink: 0;
          border-top: 2px solid rgba(255,255,255,0.5);
      }

      .game-keyboard {
          display: flex;
          flex-direction: column;
          gap: 8px;
          max-width: 100%;
          margin: 0 auto;
      }

      .game-kb-row {
          display: flex;
          justify-content: center;
          gap: 6px;
      }

      .game-key {
          background: white;
          border: 3px solid #e2e8f0;
          border-radius: 14px;
          padding: 0;
          font-size: 28px;
          font-weight: 800;
          cursor: pointer;
          min-width: 78px;
          height: 72px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #1e40af;
          box-shadow: 0 4px 8px rgba(0,0,0,0.08), 0 2px 0 #cbd5e1;
          transition: all 0.1s ease;
          touch-action: manipulation;
      }

      .game-key:active {
          transform: translateY(2px);
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
          background: #dbeafe;
      }

      .game-key.vowel-key {
          background: #fffbeb;
          border-color: #fde68a;
          color: #92400e;
          box-shadow: 0 4px 8px rgba(0,0,0,0.06), 0 2px 0 #fde68a;
      }

      .game-key.vowel-key:active {
          background: #fef3c7;
      }

      .game-key.delete-key {
          background: linear-gradient(145deg, #fca5a5, #f87171);
          color: white;
          border-color: #f87171;
          min-width: 150px;
          font-size: 26px;
          box-shadow: 0 4px 8px rgba(248,113,113,0.25), 0 2px 0 #ef4444;
      }

      /* Í≤åÏûÑ Ïò§Î≤Ñ/Ï†ïÏßÄ/ÏÑ§Ï†ï ÌôîÎ©¥ */
      .game-over-screen, .game-pause-screen, .game-settings-screen {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 100;
          backdrop-filter: blur(5px);
      }

      .game-over-screen.hidden, .game-pause-screen.hidden, .game-settings-screen.hidden {
          display: none;
      }

      .game-over-content, .game-pause-content, .game-settings-content {
          background: white;
          border-radius: 25px;
          padding: 40px;
          text-align: center;
          box-shadow: 0 25px 50px rgba(0,0,0,0.3);
          min-width: 320px;
      }

      .game-over-title, .game-pause-title, .game-settings-title {
          font-size: 50px;
          font-weight: 900;
          color: #1e293b;
          margin-bottom: 18px;
      }

      .game-over-score {
          font-size: 44px;
          font-weight: 800;
          color: #f59e0b;
          margin-bottom: 12px;
      }

      .game-over-message {
          font-size: 24px;
          color: #64748b;
          margin-bottom: 28px;
      }

      .game-retry-btn, .game-exit-btn {
          display: block;
          width: 100%;
          padding: 18px;
          border: none;
          border-radius: 12px;
          font-size: 22px;
          font-weight: 700;
          cursor: pointer;
          margin-bottom: 10px;
      }

      .game-retry-btn {
          background: linear-gradient(145deg, #3b82f6, #2563eb);
          color: white;
      }

      .game-exit-btn {
          background: linear-gradient(145deg, #e2e8f0, #cbd5e1);
          color: #475569;
      }

      .game-setting-item {
          margin: 20px 0;
          text-align: left;
      }

      .game-setting-item label {
          font-size: 20px;
          font-weight: 700;
          color: #374151;
          display: block;
          margin-bottom: 12px;
      }

      .speed-btns {
          display: flex;
          gap: 8px;
      }

      .speed-btn, .type-btn {
          flex: 1;
          padding: 12px;
          border: 2px solid #e2e8f0;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          background: white;
          color: #475569;
          transition: all 0.15s ease;
      }

      .speed-btn.active, .type-btn.active {
          background: linear-gradient(145deg, #3b82f6, #2563eb);
          color: white;
          border-color: #3b82f6;
      }

      @keyframes comboPopAnim {
          0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
          30% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1) translateY(-60px); opacity: 0; }
      }

      /* ===== ÏÉÅÏö© ÌÄÑÎ¶¨Ìã∞ ÎπÑÏ£ºÏñº ÏóÖÍ∑∏Î†àÏù¥Îìú ===== */
      /* 3D ÏïÑÏºÄÏù¥Îìú Î≤ÑÌäº ‚Äî ÌÉ≠ */
      .tab-btn {
          border-bottom: 5px solid #7c8ba0 !important;
          transition: all .1s ease !important;
      }
      .tab-btn:active {
          transform: translateY(3px) scaleX(1.02) scaleY(.97) !important;
          border-bottom-width: 2px !important;
      }
      .tab-btn.active {
          border-bottom-color: #1d4ed8 !important;
      }

      /* 3D ÏïÑÏºÄÏù¥Îìú Î≤ÑÌäº ‚Äî Ïï°ÏÖò Î≤ÑÌäº */
      .action-btn.read { border-bottom: 6px solid #0e7490 !important; }
      .action-btn.read:active { transform: translateY(4px) scaleX(1.02) scaleY(.96) !important; border-bottom-width: 2px !important; }
      .action-btn.complete { border-bottom: 6px solid #b45309 !important; }
      .action-btn.complete:active { transform: translateY(4px) scaleX(1.02) scaleY(.96) !important; border-bottom-width: 2px !important; }
      .action-btn.backspace { border-bottom: 6px solid #b91c1c !important; }
      .action-btn.backspace:active { transform: translateY(4px) scaleX(1.02) scaleY(.96) !important; border-bottom-width: 2px !important; }

      /* 3D ÏïÑÏºÄÏù¥Îìú Î≤ÑÌäº ‚Äî ÌÇ§Î≥¥Îìú ÌÇ§ */
      .char-btn {
          border-bottom: 5px solid #c8cdd4 !important;
      }
      .char-btn:active {
          transform: translateY(3px) scaleX(1.01) scaleY(.97) !important;
          border-bottom-width: 2px !important;
      }
      .char-btn.empty {
          border-bottom-color: #d1d5db !important;
      }

      /* 3D Í≤åÏûÑ ÏãúÏûë Î≤ÑÌäº + ÌïòÏù¥ÎùºÏù¥Ìä∏ Ïä§Ïúï */
      .game-launch-btn {
          border-bottom: 6px solid #b45309 !important;
          position: relative !important;
          overflow: hidden !important;
      }
      .game-launch-btn::after {
          content: '';
          position: absolute;
          top: 0; left: -100%; width: 60%; height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
          animation: hlSweep 3s ease-in-out infinite;
      }
      @keyframes hlSweep { 0%,100%{left:-100%} 50%{left:150%} }
      .game-launch-btn:active {
          transform: translateY(4px) scaleX(1.01) scaleY(.96) !important;
          border-bottom-width: 2px !important;
          animation: none !important;
      }

      /* Ìå®ÎÑê ÎπÑÏ£ºÏñº Î≥¥Í∞ï */
      .right-panel {
          background: linear-gradient(180deg, rgba(139,95,191,.08) 0%, rgba(102,126,234,.06) 100%);
          border-radius: 20px;
          padding: 10px;
      }
      .left-panel {
          position: relative;
      }
      .saved-words-section, .challenge-section {
          position: relative;
      }
      .saved-words-section::before, .challenge-section::before {
          content: '';
          position: absolute;
          top: 0; left: 0; right: 0; height: 4px;
          background: linear-gradient(90deg, #667eea, #764ba2, #fbbf24);
          border-radius: 16px 16px 0 0;
      }
      .profile-section {
          background: linear-gradient(145deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%) !important;
      }

      /* Ï†êÏàò ÌåùÏóÖ */
      @keyframes scorePop {
          0% { transform: translateY(0) scale(.5); opacity: 0; }
          20% { transform: translateY(-10px) scale(1.2); opacity: 1; }
          100% { transform: translateY(-60px) scale(.8); opacity: 0; }
      }
      .score-popup {
          position: absolute; z-index: 99; pointer-events: none;
          font-size: 28px; font-weight: 900; color: #fbbf24;
          text-shadow: 0 2px 6px rgba(0,0,0,.3);
          animation: scorePop .9s ease-out forwards;
      }

      /* Î†àÎ≤®ÏóÖ Ïò§Î≤ÑÎ†àÏù¥ */
      @keyframes lvPop {
          0% { transform: translate(-50%,-50%) scale(0); opacity: 0; }
          40% { transform: translate(-50%,-50%) scale(1.2); opacity: 1; }
          100% { transform: translate(-50%,-50%) scale(1); opacity: 0; }
      }
      .level-up-overlay {
          position: fixed; top: 50%; left: 50%; z-index: 9999; pointer-events: none;
          font-size: 56px; font-weight: 900;
          background: linear-gradient(135deg, #667eea, #764ba2);
          -webkit-background-clip: text; -webkit-text-fill-color: transparent;
          filter: drop-shadow(0 4px 12px rgba(102,126,234,.5));
          animation: lvPop 1.4s ease-out forwards;
      }

      /* Î∑∞ Ï†ÑÌôò Ïï†ÎãàÎ©îÏù¥ÏÖò */
      @keyframes viewFadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }
      .tab-content.active {
          animation: viewFadeIn .3s ease-out;
      }

      /* ÎßàÏä§ÏΩîÌä∏ Ïä§ÌÉÄÏùº */
      .mascot-container {
          position: absolute; z-index: 10; pointer-events: none;
      }
      .mascot-svg{filter:drop-shadow(0 4px 8px rgba(0,0,0,.15));animation:mascotBob 3s ease-in-out infinite}
      @keyframes mascotBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
      .mascot-svg.happy{animation:mascotBob 3s ease-in-out infinite,mascotJump .5s ease-out}
      @keyframes mascotJump{0%{transform:translateY(0)}40%{transform:translateY(-20px) scale(1.1)}100%{transform:translateY(0) scale(1)}}
      .mascot-svg.worried{animation:mascotShake .4s ease-out}
      @keyframes mascotShake{0%,100%{transform:rotate(0)}25%{transform:rotate(-8deg)}75%{transform:rotate(8deg)}}
      .mascot-bubble {
          position: absolute; top: -28px; left: 50%; transform: translateX(-50%);
          background: #fff; border-radius: 14px; padding: 3px 10px;
          font-size: 11px; font-weight: 700; color: #764ba2;
          white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,.15);
          opacity: 0; transition: opacity .3s;
      }
      .mascot-bubble.show { opacity: 1; }
      .mascot-bubble::after {
          content: ''; position: absolute; bottom: -6px; left: 50%;
          transform: translateX(-50%); border-left: 6px solid transparent;
          border-right: 6px solid transparent; border-top: 6px solid #fff;
      }

      /* ÎÇ¥ Í∏∞Î°ù */
      .records-area{flex:1;display:flex;flex-direction:column;gap:18px;padding:18px;overflow-y:auto;position:relative;z-index:1}
      .record-card{background:linear-gradient(145deg,#fff,#f8fafc);border:2px solid #e2e8f0;border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
      .record-card h3{font-size:22px;font-weight:800;color:#1e293b;margin-bottom:12px}
      .record-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
      .record-item{text-align:center;padding:14px;background:linear-gradient(145deg,#f5f3ff,#ede9fe);border-radius:12px;border:2px solid #c4b5fd}
      .record-num{font-size:38px;font-weight:900;color:#7c3aed}
      .record-label{font-size:15px;font-weight:600;color:#5b21b6;margin-top:5px}
      .record-tab{position:relative;background:linear-gradient(180deg,#f5f3ff 0%,#ede9fe 50%,#ddd6fe80 100%);border-radius:12px;overflow:hidden}
      .record-tab::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 700'><defs><linearGradient id='tg' x1='0' y1='0' x2='0' y2='1'><stop offset='0%25' stop-color='%23a78bfa'/><stop offset='100%25' stop-color='%237c3aed'/></linearGradient></defs><g opacity='.12'><path d='M30,600 L30,510 Q30,498 42,498 L78,498 Q90,498 90,510 L90,600' fill='url(%23tg)'/><path d='M18,510 Q60,490 102,510' fill='none' stroke='%23a78bfa' stroke-width='2.5'/><circle cx='60' cy='490' r='7' fill='%23a78bfa'/><rect x='48' y='600' width='24' height='10' rx='3' fill='%236d28d9'/></g><g opacity='.1'><path d='M310,610 L310,530 Q310,520 320,520 L360,520 Q370,520 370,530 L370,610' fill='url(%23tg)'/><path d='M300,530 Q340,512 380,530' fill='none' stroke='%23a78bfa' stroke-width='2'/><circle cx='340' cy='514' r='6' fill='%23a78bfa'/><rect x='330' y='610' width='20' height='8' rx='2' fill='%236d28d9'/></g><g opacity='.06' font-family='sans-serif' fill='%237c3aed'><text x='60' y='100' font-size='28'>„Ñ±</text><text x='300' y='80' font-size='24'>„Ñ¥</text><text x='180' y='650' font-size='22'>„Ñ∑</text><text x='340' y='200' font-size='26'>„Öé</text><text x='40' y='400' font-size='20'>„ÖÅ</text></g><polygon points='100,40 104,52 117,52 107,60 110,72 100,64 90,72 93,60 83,52 96,52' fill='%23a78bfa' opacity='.12'><animate attributeName='opacity' values='.06;.18;.06' dur='2.5s' repeatCount='indefinite'/></polygon><polygon points='300,50 303,58 313,58 305,64 308,72 300,66 292,72 295,64 287,58 297,58' fill='%23a78bfa' opacity='.1'><animate attributeName='opacity' values='.05;.16;.05' dur='3s' repeatCount='indefinite'/></polygon><polygon points='200,30 203,38 213,38 205,44 208,52 200,46 192,52 195,44 187,38 197,38' fill='%238b5cf6' opacity='.14'><animate attributeName='opacity' values='.07;.2;.07' dur='2s' repeatCount='indefinite'/></polygon><polygon points='50,250 53,258 62,258 55,264 57,272 50,267 43,272 45,264 38,258 47,258' fill='%23a78bfa' opacity='.1'><animate attributeName='opacity' values='.05;.15;.05' dur='2.8s' repeatCount='indefinite'/></polygon><polygon points='350,300 353,308 362,308 355,314 357,322 350,317 343,322 345,314 338,308 347,308' fill='%238b5cf6' opacity='.1'><animate attributeName='opacity' values='.05;.16;.05' dur='3.2s' repeatCount='indefinite'/></polygon></svg>") no-repeat center/cover;opacity:.7}
      .record-tab .record-card{backdrop-filter:blur(4px);background:linear-gradient(145deg,rgba(255,255,255,.9),rgba(245,243,255,.85))!important;border:2px solid rgba(196,181,253,.5)!important;box-shadow:0 4px 16px rgba(139,92,246,.1),0 0 0 1px rgba(196,181,253,.2)!important;transition:transform .2s,box-shadow .2s}
      .record-tab .record-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(139,92,246,.15)!important}
      .record-tab .record-card h3{padding-bottom:8px;border-bottom:2px solid rgba(139,92,246,.15);background:linear-gradient(90deg,#7c3aed,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
      .record-tab .record-num{text-shadow:0 0 12px rgba(124,58,237,.3),0 0 24px rgba(167,139,250,.15)}
      .record-tab .record-item{border:2px solid rgba(196,181,253,.35)!important;background:linear-gradient(145deg,#f5f3ff,#ede9fe)!important}

      /* B3: ÌÉ≠ Î∞∞Í≤Ω SVG Ïû•ÏãùÏî¨ */
      .saved-tab,.challenge-tab,.chart-tab,.trace-tab{position:relative;overflow:hidden}
      .saved-tab>*,.challenge-tab>*,.chart-tab>*,.trace-tab>*{position:relative;z-index:1}

      /* ÎÇ¥ Í∏ÄÏûê: Ïó∞ÌïÑ + ÎÖ∏Ìä∏ Ï¢ÖÏù¥ + ÌïúÍ∏Ä Í∏ÄÏûê ÏõåÌÑ∞ÎßàÌÅ¨ */
      .saved-tab::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;opacity:.6;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 700'><defs><linearGradient id='pg' x1='0' y1='0' x2='0' y2='1'><stop offset='0%25' stop-color='%23a78bfa'/><stop offset='100%25' stop-color='%237c3aed'/></linearGradient></defs><g opacity='.12'><rect x='440' y='40' width='120' height='160' rx='8' fill='%23f5f3ff' stroke='%23a78bfa' stroke-width='2'/><line x1='456' y1='72' x2='544' y2='72' stroke='%23c4b5fd' stroke-width='1.5'/><line x1='456' y1='96' x2='544' y2='96' stroke='%23c4b5fd' stroke-width='1.5'/><line x1='456' y1='120' x2='544' y2='120' stroke='%23c4b5fd' stroke-width='1.5'/><line x1='456' y1='144' x2='530' y2='144' stroke='%23c4b5fd' stroke-width='1.5'/><line x1='456' y1='168' x2='520' y2='168' stroke='%23c4b5fd' stroke-width='1.5'/></g><g opacity='.14' transform='translate(30,520) rotate(-25)'><rect x='0' y='0' width='10' height='110' rx='2' fill='%23fbbf24'/><polygon points='5,-12 0,0 10,0' fill='%23a78bfa'/><rect x='3' y='95' width='4' height='18' rx='1' fill='%23f59e0b'/></g><g opacity='.12' transform='translate(520,480) rotate(15)'><rect x='0' y='0' width='8' height='100' rx='2' fill='%23fb923c'/><polygon points='4,-10 0,0 8,0' fill='%23a78bfa'/><rect x='2' y='85' width='4' height='16' rx='1' fill='%23ea580c'/></g><g opacity='.05' font-family='sans-serif' fill='%238b5cf6'><text x='60' y='80' font-size='48' font-weight='900'>Í∞Ä</text><text x='250' y='140' font-size='36' font-weight='900'>ÎÇò</text><text x='380' y='600' font-size='42' font-weight='900'>Îã§</text><text x='100' y='400' font-size='32' font-weight='900'>Îùº</text><text x='480' y='350' font-size='40' font-weight='900'>Îßà</text><text x='200' y='550' font-size='30' font-weight='900'>Î∞î</text></g><circle cx='150' cy='200' r='4' fill='%23a78bfa' opacity='.1'><animate attributeName='opacity' values='.05;.15;.05' dur='3s' repeatCount='indefinite'/></circle><circle cx='400' cy='300' r='3' fill='%238b5cf6' opacity='.1'><animate attributeName='opacity' values='.06;.14;.06' dur='2.5s' repeatCount='indefinite'/></circle><circle cx='300' cy='500' r='5' fill='%23c4b5fd' opacity='.08'><animate attributeName='opacity' values='.04;.12;.04' dur='3.5s' repeatCount='indefinite'/></circle></svg>") no-repeat center/cover}

      /* Îì£Í≥†ÎßûÏ∂∞!: Ïä§ÌîºÏª§ + ÎèôÏã¨Ïõê ÏùåÌåå + ÏùåÌëú */
      .challenge-tab::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;opacity:.6;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 700'><defs><linearGradient id='sg' x1='0' y1='0' x2='1' y2='1'><stop offset='0%25' stop-color='%23a78bfa'/><stop offset='100%25' stop-color='%237c3aed'/></linearGradient></defs><g opacity='.1' transform='translate(80,300)'><rect x='-18' y='-22' width='36' height='44' rx='8' fill='url(%23sg)'/><path d='M18,-30 Q50,-50 50,0 Q50,50 18,30' fill='none' stroke='%23a78bfa' stroke-width='3' stroke-linecap='round'/><path d='M22,-42 Q65,-65 65,0 Q65,65 22,42' fill='none' stroke='%23a78bfa' stroke-width='2' stroke-linecap='round' opacity='.6'/></g><g opacity='.08'><circle cx='480' cy='350' r='40' fill='none' stroke='%23a78bfa' stroke-width='2'><animate attributeName='r' values='40;70;40' dur='3s' repeatCount='indefinite'/><animate attributeName='opacity' values='.12;.02;.12' dur='3s' repeatCount='indefinite'/></circle><circle cx='480' cy='350' r='60' fill='none' stroke='%238b5cf6' stroke-width='1.5'><animate attributeName='r' values='60;95;60' dur='3s' begin='.5s' repeatCount='indefinite'/><animate attributeName='opacity' values='.1;.02;.1' dur='3s' begin='.5s' repeatCount='indefinite'/></circle><circle cx='480' cy='350' r='80' fill='none' stroke='%23c4b5fd' stroke-width='1'><animate attributeName='r' values='80;120;80' dur='3s' begin='1s' repeatCount='indefinite'/><animate attributeName='opacity' values='.08;.01;.08' dur='3s' begin='1s' repeatCount='indefinite'/></circle></g><g opacity='.1' fill='%238b5cf6'><g transform='translate(150,100) rotate(-15)'><ellipse cx='0' cy='0' rx='10' ry='8'/><rect x='8' y='-35' width='3' height='35' rx='1.5'/><path d='M11,-35 Q20,-45 11,-20' fill='%238b5cf6'/></g><g transform='translate(450,120) rotate(10)'><ellipse cx='0' cy='0' rx='10' ry='8'/><rect x='8' y='-35' width='3' height='35' rx='1.5'/><path d='M11,-35 Q20,-45 11,-20' fill='%238b5cf6'/></g><g transform='translate(100,560) rotate(-5)'><ellipse cx='0' cy='0' rx='8' ry='6.5'/><rect x='6' y='-28' width='2.5' height='28' rx='1'/><path d='M8.5,-28 Q16,-36 8.5,-16' fill='%238b5cf6'/></g><g transform='translate(500,550) rotate(20)'><ellipse cx='0' cy='0' rx='9' ry='7'/><rect x='7' y='-30' width='2.5' height='30' rx='1'/><path d='M9.5,-30 Q17,-40 9.5,-18' fill='%238b5cf6'/></g></g><g opacity='.05' font-family='sans-serif' fill='%237c3aed'><text x='250' y='200' font-size='38' font-weight='900'>Îì£</text><text x='350' y='550' font-size='34' font-weight='900'>Îßû</text></g></svg>") no-repeat center/cover}

      /* Í∏ÄÏûêÌëú: Í≤©Ïûê Ìå®ÌÑ¥ + ÏûêÏùå „Ñ±„Ñ¥„Ñ∑ ÏõåÌÑ∞ÎßàÌÅ¨ */
      .chart-tab::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;opacity:.6;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 700'><defs><pattern id='gd' x='0' y='0' width='60' height='60' patternUnits='userSpaceOnUse'><rect width='60' height='60' fill='none'/><line x1='60' y1='0' x2='60' y2='60' stroke='%23c4b5fd' stroke-width='.6' opacity='.15'/><line x1='0' y1='60' x2='60' y2='60' stroke='%23c4b5fd' stroke-width='.6' opacity='.15'/></pattern></defs><rect width='600' height='700' fill='url(%23gd)'/><g opacity='.06' font-family='sans-serif' fill='%238b5cf6' font-weight='900'><text x='40' y='70' font-size='52'>„Ñ±</text><text x='200' y='120' font-size='44'>„Ñ¥</text><text x='400' y='80' font-size='48'>„Ñ∑</text><text x='100' y='250' font-size='40'>„Ñπ</text><text x='350' y='230' font-size='46'>„ÖÅ</text><text x='500' y='180' font-size='38'>„ÖÇ</text><text x='50' y='420' font-size='50'>„ÖÖ</text><text x='250' y='380' font-size='42'>„Öá</text><text x='450' y='400' font-size='44'>„Öà</text><text x='150' y='560' font-size='46'>„Öä</text><text x='370' y='580' font-size='40'>„Öã</text><text x='520' y='550' font-size='48'>„Öå</text><text x='80' y='660' font-size='38'>„Öç</text><text x='300' y='660' font-size='50'>„Öé</text></g><rect x='160' y='280' width='280' height='180' rx='12' fill='none' stroke='%23a78bfa' stroke-width='2' opacity='.08' stroke-dasharray='8 4'><animate attributeName='stroke-dashoffset' values='0;24' dur='4s' repeatCount='indefinite'/></rect><circle cx='300' cy='370' r='50' fill='none' stroke='%23a78bfa' stroke-width='1.5' opacity='.06'><animate attributeName='r' values='45;55;45' dur='5s' repeatCount='indefinite'/></circle></svg>") no-repeat center/cover}

      /* Ïç®Î≥¥Í∏∞: Î∂ì + ÏûâÌÅ¨Î≥ë + ÏûâÌÅ¨ Î∞©Ïö∏ + ÌïúÏßÄ ÏßàÍ∞ê */
      .trace-tab::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;opacity:.6;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 700'><defs><linearGradient id='ig' x1='0' y1='0' x2='0' y2='1'><stop offset='0%25' stop-color='%237c3aed'/><stop offset='100%25' stop-color='%234c1d95'/></linearGradient><radialGradient id='ik' cx='.5' cy='.3' r='.7'><stop offset='0%25' stop-color='%238b5cf6'/><stop offset='100%25' stop-color='%234c1d95'/></radialGradient></defs><g opacity='.12' transform='translate(80,80) rotate(-30)'><rect x='-4' y='-60' width='8' height='100' rx='3' fill='%23d4a574'/><path d='M-5,40 Q0,55 5,40' fill='%237c3aed'/><rect x='-6' y='-60' width='12' height='20' rx='2' fill='%23b8860b'/></g><g opacity='.12' transform='translate(500,500)'><path d='M-20,30 Q-22,-10 -15,-25 Q0,-40 15,-25 Q22,-10 20,30 Z' fill='url(%23ig)'/><rect x='-24' y='22' width='48' height='10' rx='3' fill='%236d28d9'/><ellipse cx='0' cy='-28' rx='16' ry='6' fill='%234c1d95' opacity='.5'/><ellipse cx='0' cy='-26' rx='12' ry='4' fill='%238b5cf6' opacity='.3'><animate attributeName='ry' values='4;5;4' dur='2s' repeatCount='indefinite'/></ellipse></g><g opacity='.1'><circle cx='200' cy='400' r='6' fill='url(%23ik)'><animate attributeName='r' values='5;7;5' dur='3s' repeatCount='indefinite'/></circle><circle cx='350' cy='200' r='4' fill='%237c3aed'><animate attributeName='r' values='3;5;3' dur='2.5s' repeatCount='indefinite'/></circle><circle cx='150' cy='580' r='5' fill='%238b5cf6'><animate attributeName='r' values='4;6;4' dur='3.2s' repeatCount='indefinite'/></circle><circle cx='450' cy='150' r='3.5' fill='%23a78bfa'><animate attributeName='r' values='3;5;3' dur='2.8s' repeatCount='indefinite'/></circle></g><g opacity='.05' font-family='sans-serif' fill='%237c3aed' font-weight='900'><text x='280' y='120' font-size='40'>Ïì∞</text><text x='100' y='330' font-size='34'>Í∏∞</text><text x='420' y='600' font-size='36'>Ïó∞</text><text x='300' y='500' font-size='30'>Ïäµ</text></g><g opacity='.04'><line x1='100' y1='250' x2='500' y2='250' stroke='%23a78bfa' stroke-width='1'/><line x1='100' y1='350' x2='500' y2='350' stroke='%23a78bfa' stroke-width='1'/><line x1='100' y1='450' x2='500' y2='450' stroke='%23a78bfa' stroke-width='1'/></g></svg>") no-repeat center/cover}

      /* B5: ÌûàÏñ¥Î°ú Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ */
      .hero-countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.7);z-index:200;backdrop-filter:blur(4px)}
      .hero-cd-num{font-size:120px;font-weight:900;color:#fff;text-shadow:0 0 30px rgba(139,92,246,.8),0 0 60px rgba(139,92,246,.4);animation:cdPop .7s ease-out}
      @keyframes cdPop{0%{transform:scale(2.5);opacity:0}40%{transform:scale(.9);opacity:1}60%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
      .hero-best-display{text-align:center;margin-top:8px;font-size:16px;font-weight:700;color:#a78bfa;opacity:.8}
      .hero-best-display span{color:#fbbf24;font-size:20px;font-weight:900}

  </style>
</head>
<body>
  <!-- Í∞ÄÎ°ú ÌöåÏ†Ñ ÏïàÎÇ¥ (Î™®Î∞îÏùº ÏÑ∏Î°úÏùº ÎïåÎßå ÌëúÏãú) -->
  <div class="rotate-notice">
      <div class="rotate-icon">üì±</div>
      <div>ÌôîÎ©¥ÏùÑ Í∞ÄÎ°úÎ°ú ÎèåÎ†§Ï£ºÏÑ∏Ïöî!</div>
      <div style="font-size:14px;opacity:0.7;font-weight:400">Í∞ÄÎ°ú Î™®ÎìúÏóêÏÑúÎßå ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏñ¥Ïöî</div>
      <div style="font-size: 16px; opacity: 0.8;">Í∞ÄÎ°ú Î™®ÎìúÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏñ¥Ïöî</div>
  </div>

  <div class="container">
      <!-- ===== ÏµúÏÉÅÎã®: Í≥ºÎ™© ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î ===== -->
      <div class="subject-bar">
          <button class="sb-tab active">üìù ÌïúÍ∏Ä</button>
          <div class="sb-spacer"></div>
          <div class="sb-btns">
              <button class="sb-btn" id="sb-sound" data-action="toggle-sound">üîä</button>
              <button class="sb-btn" onclick="showAdminModal()">‚öôÔ∏è</button>
          </div>
      </div>

      <div class="main-layout">
          <!-- ÏôºÏ™Ω: ÌîÑÎ°úÌïÑ + Ï†ÄÏû•Îêú Îã®Ïñ¥Îì§ + ÎèÑÏ†ÑÌïòÍ∏∞ + Ïª®Ìä∏Î°§ Î≤ÑÌäºÎì§ -->
          <div class="left-panel">
              <!-- üéÆ Î©ãÏßÑ ÌîÑÎ°úÌïÑ ÏòÅÏó≠ (6ÏÑ∏ ÎÇ®ÏïÑÏö©) -->
              <div class="profile-section">
                  <div class="profile-content">
                      <div class="profile-avatar" onclick="showCharacterModal(event)">
                          <span id="profile-character">ü¶∏‚Äç‚ôÇÔ∏è</span>
                      </div>
                      <div class="profile-info">
                          <div class="profile-name" onclick="changeUserName(event)">
                              <span id="user-name">ÌôçÍ∏∏Îèô</span>
                          </div>
                          <div class="profile-level-container">
                              <div class="profile-level">
                                  <span class="level-badge">LV.<span id="user-level">1</span></span>
                                  <span id="completed-count">0</span>/<span id="total-count">10</span>
                              </div>
                              <div class="progress-bar">
                                  <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              
              <!-- ÌÉ≠ Ìó§Îçî -->
              <div class="tab-headers">
                  <button class="tab-btn active" data-action="switch-tab" data-tab="saved">üìù ÎÇ¥ Í∏ÄÏûê</button>
                  <button class="tab-btn" data-action="switch-tab" data-tab="challenge">üëÇ Îì£Í≥†ÎßûÏ∂∞!</button>
                  <button class="tab-btn" data-action="switch-tab" data-tab="chart">üìä Í∏ÄÏûêÌëú</button>
                  <button class="tab-btn" data-action="switch-tab" data-tab="trace">‚úèÔ∏è Ïç®Î≥¥Í∏∞</button>
              </div>
              
              <!-- Ï†ÄÏû•Îêú Îã®Ïñ¥Îì§ ÌÉ≠ -->
              <div class="tab-content saved-tab active">
                  <div class="saved-words-section">
                      <div class="saved-chars-title">üìù ÎÇ¥Í∞Ä ÎßåÎì† Í∏ÄÏûê</div>
                      <div class="saved-chars-display" id="saved-chars-display">
                          <div class="empty-saved">ÏïÑÏßÅ Í∏ÄÏûêÍ∞Ä<br>ÏóÜÏñ¥Ïöî</div>
                      </div>
                  </div>
              </div>
              
              <!-- ÎèÑÏ†ÑÌïòÍ∏∞ ÌÉ≠ -->
              <div class="tab-content challenge-tab">
                  <div class="challenge-section">
                      <div class="challenge-title">üéØ Îì£Í≥† ÎßûÏ∂∞Î≥¥ÏÑ∏Ïöî!</div>
                      <div class="challenge-content" id="challenge-content">
                          <div class="no-challenge">Í¥ÄÎ¶¨ÏûêÍ∞Ä Îã®Ïñ¥Î•º<br>ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî</div>
                      </div>
                  </div>
              </div>

              <!-- Í∏ÄÏûêÌëú ÌÉ≠ (ÏôºÏ™Ω ÏûêÏùå ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò) -->
              <div class="tab-content chart-tab">
                  <div class="chart-nav-grid" id="chart-nav-grid">
                      <!-- JS ÎèôÏ†Å ÏÉùÏÑ± -->
                  </div>
              </div>

              <!-- Îî∞ÎùºÏì∞Í∏∞ ÌÉ≠ -->
              <div class="tab-content trace-tab">
                  <div class="trace-left-panel">
                      <div class="trace-category-title">üìñ Í∏ÄÏûê ÏÑ†ÌÉù</div>
                      <div class="trace-category-btns">
                          <button class="trace-cat-btn active" onclick="setTraceCategory('consonant')">ÏûêÏùå</button>
                          <button class="trace-cat-btn" onclick="setTraceCategory('vowel')">Î™®Ïùå</button>
                          <button class="trace-cat-btn" onclick="setTraceCategory('syllable')">Í∏ÄÏûê</button>
                      </div>
                      <div class="trace-letter-grid" id="trace-letter-grid">
                          <!-- JS ÎèôÏ†Å ÏÉùÏÑ± -->
                      </div>
                  </div>
              </div>

              <!-- ÎÇ¥ Í∏∞Î°ù ÌÉ≠ -->
              <div class="tab-content record-tab">
                  <div class="records-area">
                      <div class="record-card">
                          <h3>üèÜ Ï¢ÖÌï© ÏÑ±Ï†Å</h3>
                          <div class="record-grid">
                              <div class="record-item"><div class="record-num" id="r-total-completed">0</div><div class="record-label">ÏôÑÏÑ± Í∏ÄÏûê</div></div>
                              <div class="record-item"><div class="record-num" id="r-challenge-done">0</div><div class="record-label">ÎèÑÏ†Ñ ÏÑ±Í≥µ</div></div>
                              <div class="record-item"><div class="record-num" id="r-level">1</div><div class="record-label">ÌòÑÏû¨ Î†àÎ≤®</div></div>
                          </div>
                      </div>
                      <div class="record-card">
                          <h3>üìù ÎÇ¥ Í∏ÄÏûê</h3>
                          <div class="record-grid">
                              <div class="record-item"><div class="record-num" id="r-saved-count">0</div><div class="record-label">Ï†ÄÏû• Í∏ÄÏûê</div></div>
                          </div>
                      </div>
                      <div class="record-card">
                          <h3>üåü Í∏ÄÏûê ÌûàÏñ¥Î°ú</h3>
                          <div class="record-grid">
                              <div class="record-item"><div class="record-num" id="r-hero-best">0</div><div class="record-label">ÏµúÍ≥† Ï†êÏàò</div></div>
                              <div class="record-item"><div class="record-num" id="r-hero-combo">0</div><div class="record-label">ÏµúÍ≥† ÏΩ§Î≥¥</div></div>
                              <div class="record-item"><div class="record-num" id="r-hero-level">0</div><div class="record-label">ÏµúÍ≥† Î†àÎ≤®</div></div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Í≤åÏûÑ Î≤ÑÌäº -->
              <div style="position:relative;flex-shrink:0">
                  <div class="game-launch-btn" onclick="startFallingGame()">
                      üåü Í∏ÄÏûê ÌûàÏñ¥Î°ú ÏãúÏûë!
                  </div>
                  <div class="hero-best-display" id="hero-best-display" style="display:none">üèÜ ÏµúÍ≥†Í∏∞Î°ù: <span id="hero-best-val">0</span>Ï†ê</div>
                  <!-- ÎßàÏä§ÏΩîÌä∏ "ÌïúÏù¥" -->
                  <div class="mascot-container" style="right:-15px;bottom:0;width:90px;height:113px">
                      <svg class="mascot-svg" id="mascot-hangul-svg" viewBox="0 0 100 125" width="90" height="113">
                          <ellipse cx="50" cy="118" rx="22" ry="4" fill="rgba(0,0,0,.08)"/>
                          <ellipse cx="35" cy="108" rx="12" ry="6" fill="#7c3aed"><animate attributeName="cx" values="35;33;35;37;35" dur="2s" repeatCount="indefinite"/></ellipse>
                          <ellipse cx="65" cy="108" rx="12" ry="6" fill="#7c3aed"><animate attributeName="cx" values="65;67;65;63;65" dur="2s" repeatCount="indefinite" begin=".5s"/></ellipse>
                          <ellipse cx="50" cy="72" rx="38" ry="34" fill="#8b5cf6"/>
                          <ellipse cx="50" cy="72" rx="38" ry="34" fill="url(#mascotGradH)" opacity=".5"/>
                          <defs><radialGradient id="mascotGradH" cx="40%" cy="35%"><stop offset="0%" stop-color="#c4b5fd"/><stop offset="100%" stop-color="#8b5cf6"/></radialGradient></defs>
                          <ellipse cx="38" cy="56" rx="5" ry="4" fill="#fff" opacity=".25"/>
                          <ellipse cx="36" cy="64" rx="8" ry="9" fill="#fff"><animate attributeName="ry" values="9;1;9" dur="4s" repeatCount="indefinite" begin="1s"/></ellipse>
                          <circle cx="38" cy="65" r="4.5" fill="#1e1b4b"><animate attributeName="r" values="4.5;.5;4.5" dur="4s" repeatCount="indefinite" begin="1s"/></circle>
                          <circle cx="39.5" cy="63.5" r="1.5" fill="#fff"><animate attributeName="opacity" values="1;.4;1" dur="2s" repeatCount="indefinite"/></circle>
                          <ellipse cx="64" cy="64" rx="8" ry="9" fill="#fff"><animate attributeName="ry" values="9;1;9" dur="4s" repeatCount="indefinite" begin="1s"/></ellipse>
                          <circle cx="66" cy="65" r="4.5" fill="#1e1b4b"><animate attributeName="r" values="4.5;.5;4.5" dur="4s" repeatCount="indefinite" begin="1s"/></circle>
                          <circle cx="67.5" cy="63.5" r="1.5" fill="#fff"><animate attributeName="opacity" values="1;.4;1" dur="2s" repeatCount="indefinite"/></circle>
                          <path id="mascot-mouth" d="M38 82 Q50 94 62 82" stroke="#4c1d95" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                          <ellipse cx="26" cy="78" rx="6" ry="4" fill="#f9a8d4" opacity=".35"/>
                          <ellipse cx="74" cy="78" rx="6" ry="4" fill="#f9a8d4" opacity=".35"/>
                          <text x="50" y="38" text-anchor="middle" font-size="26" font-weight="900" fill="#4c1d95" font-family="sans-serif"><animateTransform attributeName="transform" type="rotate" from="0 50 32" to="360 50 32" dur="8s" repeatCount="indefinite"/>„Öé</text>
                      </svg>
                      <div class="mascot-bubble" id="bubble-mascot">Í∏ÄÏûê Î∞∞Ïö∞Ïûê!</div>
                  </div>
              </div>
          </div>

          <!-- Ï§ëÍ∞Ñ: ÏûÖÎ†• ÏòÅÏó≠ -->
          <div class="center-panel">
              <!-- Í∏∞Î≥∏ ÌÇ§Î≥¥Îìú ÌôîÎ©¥ -->
              <div id="keyboard-view">
              <div class="text-display" id="text-display">
                  <span style="color: #94a3b8; font-size: 0.5em;">Ïó¨Í∏∞Ïóê Í∏ÄÏûêÍ∞Ä ÎÇòÌÉÄÎÇòÏöî</span>
              </div>

              <!-- ÏûêÏùå/Î™®Ïùå Î∂ÑÌï† ÏòÅÏó≠ -->
              <div class="input-area">
                  <!-- ÏûêÏùå ÏòÅÏó≠ -->
                  <div class="consonant-area">
                      <div class="consonant-title">üî§ ÏûêÏùå</div>
                      
                      <div class="consonant-content">
                          <div class="consonant-grid">
                              <button class="char-btn" data-action="char-input" data-value="„Ñ±">„Ñ±</button>
                              <button class="char-btn" data-action="char-input" data-value="„Ñ¥">„Ñ¥</button>
                              <button class="char-btn" data-action="char-input" data-value="„Ñ∑">„Ñ∑</button>
                              <button class="char-btn" data-action="char-input" data-value="„Ñπ">„Ñπ</button>
                              <button class="char-btn" data-action="char-input" data-value="„ÖÅ">„ÖÅ</button>
                              <button class="char-btn" data-action="char-input" data-value="„ÖÇ">„ÖÇ</button>
                              <button class="char-btn" data-action="char-input" data-value="„ÖÖ">„ÖÖ</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öá">„Öá</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öà">„Öà</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öä">„Öä</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öã">„Öã</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öå">„Öå</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öç">„Öç</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öé">„Öé</button>
                          </div>
                          
                          <div class="double-consonant-title">ÏåçÏûêÏùå</div>
                          <div class="double-consonant-grid">
                              <button class="char-btn" data-action="char-input" data-value="„Ñ≤">„Ñ≤</button>
                              <button class="char-btn" data-action="char-input" data-value="„Ñ∏">„Ñ∏</button>
                              <button class="char-btn" data-action="char-input" data-value="„ÖÉ">„ÖÉ</button>
                              <button class="char-btn" data-action="char-input" data-value="„ÖÜ">„ÖÜ</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öâ">„Öâ</button>
                          </div>
                      </div>
                  </div>

                  <!-- Í≤ΩÍ≥ÑÏÑ† -->
                  <div class="divider"></div>

                  <!-- Î™®Ïùå ÏòÅÏó≠ -->
                  <div class="vowel-area">
                      <div class="vowel-title">üéµ Î™®Ïùå</div>
                      
                      <div class="vowel-content">
                          <div class="vowel-grid">
                              <button class="char-btn" data-action="char-input" data-value="„Öè">„Öè</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öë">„Öë</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öì">„Öì</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öï">„Öï</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öó">„Öó</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öõ">„Öõ</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öú">„Öú</button>
                              <button class="char-btn" data-action="char-input" data-value="„Ö†">„Ö†</button>
                              <button class="char-btn" data-action="char-input" data-value="„Ö°">„Ö°</button>
                              <button class="char-btn" data-action="char-input" data-value="„Ö£">„Ö£</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öê">„Öê</button>
                              <button class="char-btn" data-action="char-input" data-value="„Öî">„Öî</button>
                          </div>
                      </div>
                  </div>
              </div>
              </div> <!-- /keyboard-view -->

              <!-- Ï°∞Ìï©Ìëú ÌôîÎ©¥ (Ï°∞Ìï©Ìëú ÌÉ≠ ÏÑ†ÌÉùÏãú ÌëúÏãú) -->
              <div id="chart-view" class="chart-view hidden">
                  <div class="chart-header">
                      <div class="chart-header-title">üìä Í∏ÄÏûêÌëú</div>
                      <div class="chart-header-desc">ÏôºÏ™ΩÏóêÏÑú ÏûêÏùåÏùÑ Í≥†Î•¥Í≥† Ïπ¥ÎìúÎ•º ÎàåÎü¨Î≥¥ÏÑ∏Ïöî!</div>
                  </div>
                  <div class="chart-grid-wrapper" id="chart-grid-wrapper">
                      <!-- JSÎ°ú ÎèôÏ†Å ÏÉùÏÑ± -->
                  </div>
              </div>

              <!-- Îî∞ÎùºÏì∞Í∏∞ ÌôîÎ©¥ -->
              <div id="trace-view" class="trace-view hidden">
                  <div class="trace-canvas-area">
                      <div class="trace-top-bar">
                          <button class="trace-nav-btn" onclick="traceNav(-1)">‚óÄ</button>
                          <div class="trace-current-label" id="trace-current-label">„Ñ±</div>
                          <button class="trace-nav-btn" onclick="traceNav(1)">‚ñ∂</button>
                          <button class="trace-listen-btn" onclick="tracePlaySound()">üîä</button>
                          <button class="trace-clear-btn" onclick="traceClear()">üóëÔ∏è</button>
                          <button class="trace-eval-btn" onclick="traceEvaluate()">‚≠ê ÌèâÍ∞Ä</button>
                      </div>
                      <div class="trace-canvas-wrapper">
                          <canvas id="trace-canvas"></canvas>
                      </div>
                      <div class="trace-bottom-hint">ÏÜêÍ∞ÄÎùΩÏúºÎ°ú Ïó∞Ìïú Í∏ÄÏûêÎ•º Îî∞Îùº Í∑∏Î†§Î≥¥ÏÑ∏Ïöî!</div>
                  </div>
              </div>
          </div>
          <div class="right-panel">
              <button id="read-btn" class="action-btn read" data-action="read-text"><span class="icon">üì¢</span>ÏùΩÏñ¥Ï£ºÍ∏∞</button>
              <button id="complete-btn" class="action-btn complete" data-action="complete-word" disabled><span class="icon">üìù</span>Îã®Ïñ¥ÏôÑÏÑ±</button>
              <button id="backspace-btn" class="action-btn backspace" data-action="backspace" disabled><span class="icon">‚å´</span>ÏßÄÏö∞Í∏∞</button>
          </div>
      </div>

  <!-- üåü Í∏ÄÏûê ÌûàÏñ¥Î°ú Í≤åÏûÑ Ïò§Î≤ÑÎ†àÏù¥ (container ÎÇ¥Î∂Ä) -->
  <div id="falling-game" class="falling-game hidden">
      <div class="game-header">
          <div class="game-stat">‚≠ê <span id="game-score">0</span>Ï†ê</div>
          <div class="game-stat">Î†àÎ≤® <span id="game-level">1</span></div>
          <div class="game-hearts" id="game-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
          <div class="game-controls-top">
              <button class="game-ctrl-btn" onclick="toggleGamePause()">‚è∏</button>
              <button class="game-ctrl-btn" onclick="showGameSettings()">‚öô</button>
              <button class="game-ctrl-btn" onclick="exitFallingGame()">‚úï</button>
          </div>
      </div>
      <div class="game-arena" id="game-arena">
          <div class="game-ground"></div>
      </div>
      <div class="game-input-area">
          <div class="game-keyboard">
              <div class="game-kb-row">
                  <button class="game-key" onclick="gameKeyPress('„Ñ±')">„Ñ±</button>
                  <button class="game-key" onclick="gameKeyPress('„Ñ¥')">„Ñ¥</button>
                  <button class="game-key" onclick="gameKeyPress('„Ñ∑')">„Ñ∑</button>
                  <button class="game-key" onclick="gameKeyPress('„Ñπ')">„Ñπ</button>
                  <button class="game-key" onclick="gameKeyPress('„ÖÅ')">„ÖÅ</button>
                  <button class="game-key" onclick="gameKeyPress('„ÖÇ')">„ÖÇ</button>
                  <button class="game-key" onclick="gameKeyPress('„ÖÖ')">„ÖÖ</button>
                  <button class="game-key" onclick="gameKeyPress('„Öá')">„Öá</button>
                  <button class="game-key" onclick="gameKeyPress('„Öà')">„Öà</button>
              </div>
              <div class="game-kb-row">
                  <button class="game-key" onclick="gameKeyPress('„Öä')">„Öä</button>
                  <button class="game-key" onclick="gameKeyPress('„Öã')">„Öã</button>
                  <button class="game-key" onclick="gameKeyPress('„Öå')">„Öå</button>
                  <button class="game-key" onclick="gameKeyPress('„Öç')">„Öç</button>
                  <button class="game-key" onclick="gameKeyPress('„Öé')">„Öé</button>
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Öè')">„Öè</button>
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Öì')">„Öì</button>
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Öó')">„Öó</button>
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Öú')">„Öú</button>
              </div>
              <div class="game-kb-row">
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Ö°')">„Ö°</button>
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Ö£')">„Ö£</button>
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Öë')">„Öë</button>
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Öï')">„Öï</button>
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Öõ')">„Öõ</button>
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Ö†')">„Ö†</button>
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Öê')">„Öê</button>
                  <button class="game-key vowel-key" onclick="gameKeyPress('„Öî')">„Öî</button>
                  <button class="game-key delete-key" onclick="gameBackspace()">‚å´</button>
              </div>
          </div>
      </div>
      <div id="game-over-screen" class="game-over-screen hidden">
          <div class="game-over-content">
              <div class="game-over-title">Í≤åÏûÑ ÎÅù!</div>
              <div class="game-over-score">‚≠ê <span id="final-score">0</span>Ï†ê</div>
              <div class="game-over-message" id="game-over-message">ÏûòÌñàÏñ¥Ïöî!</div>
              <div id="game-over-best" style="font-size:18px;color:#a78bfa;font-weight:700;margin-top:8px"></div>
              <button class="game-retry-btn" onclick="restartGame()">üîÑ Îã§ÏãúÌïòÍ∏∞</button>
              <button class="game-exit-btn" onclick="exitFallingGame()">üè† ÎèåÏïÑÍ∞ÄÍ∏∞</button>
          </div>
      </div>
      <div id="game-pause-screen" class="game-pause-screen hidden">
          <div class="game-pause-content">
              <div class="game-pause-title">‚è∏ ÏùºÏãúÏ†ïÏßÄ</div>
              <button class="game-retry-btn" onclick="toggleGamePause()">‚ñ∂ Í≥ÑÏÜçÌïòÍ∏∞</button>
              <button class="game-exit-btn" onclick="exitFallingGame()">üè† ÎèåÏïÑÍ∞ÄÍ∏∞</button>
          </div>
      </div>
      <div id="game-settings-screen" class="game-settings-screen hidden">
          <div class="game-settings-content">
              <div class="game-settings-title">‚öô ÏÑ§Ï†ï</div>
              <div class="game-setting-item">
                  <label>ÏÜçÎèÑ</label>
                  <div class="speed-btns">
                      <button class="speed-btn active" onclick="setGameSpeed(1)">üê¢ ÎäêÎ¶¨Í≤å</button>
                      <button class="speed-btn" onclick="setGameSpeed(2)">üêá Î≥¥ÌÜµ</button>
                      <button class="speed-btn" onclick="setGameSpeed(3)">üöÄ Îπ†Î•¥Í≤å</button>
                  </div>
              </div>
              <div class="game-setting-item">
                  <label>Í∏ÄÏûê Ï¢ÖÎ•ò</label>
                  <div class="speed-btns">
                      <button class="type-btn active" onclick="setGameType('simple')">Ïâ¨Ïö¥ Í∏ÄÏûê</button>
                      <button class="type-btn" onclick="setGameType('medium')">Î≥¥ÌÜµ Í∏ÄÏûê</button>
                      <button class="type-btn" onclick="setGameType('hard')">Ïñ¥Î†§Ïö¥ Îã®Ïñ¥</button>
                  </div>
              </div>
              <button class="game-retry-btn" onclick="closeGameSettings()">‚úì ÌôïÏù∏</button>
          </div>
      </div>
  </div>

  </div>

  <!-- Í¥ÄÎ¶¨Ïûê Î™®Îã¨ -->
  <div id="admin-modal" class="admin-modal hidden">
      <div class="admin-content">
          <div class="admin-header">
              <h3>üîê Í¥ÄÎ¶¨Ïûê Î™®Îìú</h3>
              <button class="close-admin" onclick="closeAdminModal()">√ó</button>
          </div>
          <div class="admin-body">
              <!-- ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï -->
              <div class="admin-section">
                  <h4>üë§ ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï</h4>
                  <div class="profile-controls">
                      <input type="text" id="admin-name" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•" maxlength="10">
                      <div class="level-controls">
                          <input type="number" id="admin-level" min="1" max="100" placeholder="Î†àÎ≤® ÏÑ§Ï†ï">
                          <button class="admin-btn save-profile-btn" onclick="saveProfile()">ÌîÑÎ°úÌïÑ Ï†ÄÏû•</button>
                      </div>
                      <button class="admin-btn reset-all-btn" onclick="resetAll()">üóëÔ∏è Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button>
                  </div>
              </div>

              <!-- ÎèÑÏ†Ñ Îã®Ïñ¥ ÏÑ§Ï†ï -->
              <div class="admin-section">
                  <h4>üéØ ÎèÑÏ†Ñ Îã®Ïñ¥ ÏÑ§Ï†ï</h4>
                  
                  <!-- Î†àÎ≤® ÌÖúÌîåÎ¶ø -->
                  <div style="margin-bottom:12px;">
                      <div style="font-size:13px;font-weight:700;color:#374151;margin-bottom:8px;">üìö Î†àÎ≤®Î≥Ñ ÌÖúÌîåÎ¶ø</div>
                      <div style="display:flex;gap:6px;flex-wrap:wrap;">
                          <button class="admin-btn" style="font-size:12px;padding:6px 10px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;" onclick="loadTemplate('easy')">üå± Ïâ¨ÏõÄ</button>
                          <button class="admin-btn" style="font-size:12px;padding:6px 10px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;" onclick="loadTemplate('medium')">üåü Î≥¥ÌÜµ</button>
                          <button class="admin-btn" style="font-size:12px;padding:6px 10px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;" onclick="loadTemplate('hard')">üî• Ïñ¥Î†§ÏõÄ</button>
                          <button class="admin-btn" style="font-size:12px;padding:6px 10px;background:#8b5cf6;color:white;border:none;border-radius:8px;cursor:pointer;" onclick="loadTemplate('random')">üé≤ ÎûúÎç§ÎØπÏä§</button>
                      </div>
                  </div>
                  
                  <!-- Îã®Ïñ¥ ÏûÖÎ†• -->
                  <div style="font-size:13px;font-weight:700;color:#374151;margin-bottom:6px;">‚úèÔ∏è ÏßÅÏ†ë ÏûÖÎ†• (ÏàòÏ†ï Í∞ÄÎä•)</div>
                  <div class="word-inputs">
                      <input type="text" placeholder="1. Ï≤´ Î≤àÏß∏ Îã®Ïñ¥" maxlength="10">
                      <input type="text" placeholder="2. Îëê Î≤àÏß∏ Îã®Ïñ¥" maxlength="10">
                      <input type="text" placeholder="3. ÏÑ∏ Î≤àÏß∏ Îã®Ïñ¥" maxlength="10">
                      <input type="text" placeholder="4. ÎÑ§ Î≤àÏß∏ Îã®Ïñ¥" maxlength="10">
                      <input type="text" placeholder="5. Îã§ÏÑØ Î≤àÏß∏ Îã®Ïñ¥" maxlength="10">
                  </div>
                  <button class="admin-btn save-words-btn" onclick="saveChallengeWords()">Îã®Ïñ¥ Ï†ÄÏû•</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù Î™®Îã¨ -->
  <div id="character-modal" class="character-modal hidden">
      <div class="character-content">
          <div class="character-header">
              <h3>üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù</h3>
              <button class="close-character" onclick="closeCharacterModal()">√ó</button>
          </div>
          <div class="character-body">
              <div class="character-grid" id="character-grid">
                  <!-- ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏Î°ú ÎèôÏ†Å ÏÉùÏÑ± -->
              </div>
          </div>
      </div>
  </div>

  <script>
      // Ï†ÑÏó≠ Î≥ÄÏàòÎì§
      let savedWords = [];
      let currentWord = [];
      let currentChar = {
          choseong: '',
          jungseong: '',
          jongseong: ''
      };
      let soundEnabled = true;

      // ===== SFX ÏãúÏä§ÌÖú (Web Audio Ìï©ÏÑ±) =====
      const SFX = {
        _ctx: null,
        _getCtx() { if (!this._ctx) this._ctx = new (window.AudioContext || window.webkitAudioContext)(); return this._ctx; },
        _play(fn) { try { if (!soundEnabled) return; fn(this._getCtx()); } catch(e) {} },
        write() { this._play(ctx => { [523,659,784].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.07);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.07+.12);o.start(ctx.currentTime+i*.07);o.stop(ctx.currentTime+i*.07+.12); }); }); },
        correct() { this._play(ctx => { [587,740,880].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.07,ctx.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.1+.15);o.start(ctx.currentTime+i*.1);o.stop(ctx.currentTime+i*.1+.15); }); }); },
        wrong() { this._play(ctx => { [330,262].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sawtooth';o.frequency.value=f;g.gain.setValueAtTime(.04,ctx.currentTime+i*.12);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.12+.2);o.start(ctx.currentTime+i*.12);o.stop(ctx.currentTime+i*.12+.2); }); }); },
        fanfare() { this._play(ctx => { [523,659,784,1047].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.12);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.12+.25);o.start(ctx.currentTime+i*.12);o.stop(ctx.currentTime+i*.12+.25); }); }); },
        levelup() { this._play(ctx => { [440,554,659,880].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.08,ctx.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.1+.3);o.start(ctx.currentTime+i*.1);o.stop(ctx.currentTime+i*.1+.3); }); }); },
        combo(n) { this._play(ctx => { for(let i=0;i<Math.min(n,6);i++){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=523+i*80;g.gain.setValueAtTime(.05,ctx.currentTime+i*.06);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.06+.1);o.start(ctx.currentTime+i*.06);o.stop(ctx.currentTime+i*.06+.1);} }); },
        gameStart() { this._play(ctx => { [392,523,659,784].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='square';o.frequency.value=f;g.gain.setValueAtTime(.04,ctx.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.1+.15);o.start(ctx.currentTime+i*.1);o.stop(ctx.currentTime+i*.1+.15); }); }); },
        gameOver() { this._play(ctx => { [440,349,294,220].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sawtooth';o.frequency.value=f;g.gain.setValueAtTime(.05,ctx.currentTime+i*.18);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.18+.3);o.start(ctx.currentTime+i*.18);o.stop(ctx.currentTime+i*.18+.3); }); }); },
        pop() { this._play(ctx => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.setValueAtTime(800,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(200,ctx.currentTime+.15);g.gain.setValueAtTime(.08,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.15);o.start(ctx.currentTime);o.stop(ctx.currentTime+.15); }); },
        powerup() { this._play(ctx => { [784,988,1175,1568].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.08);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.08+.2);o.start(ctx.currentTime+i*.08);o.stop(ctx.currentTime+i*.08+.2); }); }); }
      };

      // ===== Ïú†Ìã∏: Ï†êÏàò ÌåùÏóÖ =====
      function showScorePopup(container, points, x, y) {
        const el = document.createElement('div');
        el.className = 'score-popup';
        el.textContent = points;
        el.style.left = x + 'px'; el.style.top = y + 'px';
        container.appendChild(el);
        setTimeout(() => el.remove(), 900);
      }

      // ===== Ïú†Ìã∏: ÎßàÏä§ÏΩîÌä∏ Í∞êÏ†ï =====
      function setMascotEmotion(emotion) {
        const mouth = document.getElementById('mascot-mouth');
        const bubble = document.getElementById('bubble-mascot');
        const svg = document.getElementById('mascot-hangul-svg');
        if (!mouth) return;
        const paths = { happy: 'M38 82 Q50 94 62 82', worried: 'M38 86 Q50 78 62 86', idle: 'M38 82 Q50 94 62 82' };
        const msgs = { happy: ['ÏûòÌñàÏñ¥!','ÏµúÍ≥†!','ÎåÄÎã®Ìï¥!','Î©ãÏ†∏!'], worried: ['Îã§Ïãú Ìï¥Î≥¥Ïûê!','Í¥úÏ∞ÆÏïÑ!','ÌûòÎÇ¥!'], idle: ['Í∏ÄÏûê Î∞∞Ïö∞Ïûê!'] };
        const msgArr = msgs[emotion] || msgs.idle;
        mouth.setAttribute('d', paths[emotion] || paths.idle);
        if (svg) { svg.classList.remove('happy','worried'); if (emotion !== 'idle') svg.classList.add(emotion); }
        if (bubble) { bubble.textContent = msgArr[Math.floor(Math.random()*msgArr.length)]; bubble.classList.add('show'); setTimeout(() => bubble.classList.remove('show'), 2000); }
        if (emotion !== 'idle') setTimeout(() => { mouth.setAttribute('d', paths.idle); if (svg) svg.classList.remove('happy','worried'); }, 2500);
      }

      let _prevMainLevel = 1;

      // ÎèÑÏ†Ñ ÏãúÏä§ÌÖú Î≥ÄÏàòÎì§
      let challengeWords = [];
      let currentChallengeIndex = -1;
      let completedChallenges = [];
      let challengeMode = false;
      
      // ÌîÑÎ°úÌïÑ ÏãúÏä§ÌÖú Î≥ÄÏàòÎì§ (6ÏÑ∏ ÎÇ®ÏïÑÏö© Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä)
      let userStats = {
          name: localStorage.getItem('userName') || 'ÏäàÌçºÌûàÏñ¥Î°ú',
          totalCompleted: parseInt(localStorage.getItem('totalCompleted')) || 0,
          level: 1,
          character: localStorage.getItem('userCharacter') || 'ü¶∏‚Äç‚ôÇÔ∏è'
      };
      
      // Í¥ÄÎ¶¨Ïûê Ï†ëÏÜç Î≥ÄÏàòÎì§ (4Î≤àÏúºÎ°ú Î≥ÄÍ≤Ω)
      let secretClickCount = 0;
      let secretTimer = null;

      // Î†àÎ≤®Î≥Ñ Ï∫êÎ¶≠ÌÑ∞ ÏãúÏä§ÌÖú (1-100 Î†àÎ≤®)
      const levelCharacters = {
          1: 'ü¶∏‚Äç‚ôÇÔ∏è', 2: 'ü§ñ', 3: 'ü¶∏', 4: 'üöÄ', 5: '‚ö°',
          6: 'üî•', 7: 'üíé', 8: 'üèÜ', 9: 'üëë', 10: 'üåü',
          11: 'üéØ', 12: 'üéÆ', 13: 'üé™', 14: 'üé≠', 15: 'üé®',
          16: 'üéµ', 17: 'üé∏', 18: 'üé∫', 19: 'üéª', 20: 'ü•á',
          21: '‚öΩ', 22: 'üèÄ', 23: 'üèà', 24: '‚öæ', 25: 'üéæ',
          26: 'üèê', 27: 'üèì', 28: 'üè∏', 29: 'ü•ä', 30: 'ü•ã',
          31: 'üèÜ', 32: 'ü•â', 33: 'ü•à', 34: 'üèÖ', 35: 'üéñÔ∏è',
          36: 'üéóÔ∏è', 37: 'üèµÔ∏è', 38: 'üåπ', 39: 'üå∫', 40: 'üåª',
          41: 'üå∑', 42: 'üå∏', 43: 'üíê', 44: 'üåº', 45: 'üåà',
          46: '‚≠ê', 47: 'üåü', 48: '‚ú®', 49: 'üí´', 50: 'üåô',
          51: '‚òÄÔ∏è', 52: 'üåû', 53: 'üåù', 54: 'üåõ', 55: 'üåú',
          56: 'üåö', 57: 'üåï', 58: 'üåñ', 59: 'üåó', 60: 'üåò',
          61: 'ü¶Ñ', 62: 'üêâ', 63: 'üê≤', 64: 'ü¶ï', 65: 'ü¶ñ',
          66: 'üê≥', 67: 'üêã', 68: 'üêô', 69: 'ü¶ë', 70: 'ü¶à',
          71: 'üêä', 72: 'üêÖ', 73: 'üêÜ', 74: 'üêÉ', 75: 'üêÇ',
          76: 'ü¶è', 77: 'ü¶õ', 78: 'üêò', 79: 'ü¶í', 80: 'ü¶ì',
          81: 'üé™', 82: 'üé®', 83: 'üé≠', 84: 'üé™', 85: 'üé®',
          86: 'üé≠', 87: 'üé™', 88: 'üé®', 89: 'üé≠', 90: 'üé™',
          91: 'üëë', 92: 'üíé', 93: 'üèÜ', 94: 'ü•á', 95: 'üåü',
          96: '‚≠ê', 97: '‚ú®', 98: 'üí´', 99: 'üåà', 100: 'üéâ'
      };

      // Web Speech API TTS ‚Äî ÏµúÏ†Å ÌïúÍµ≠Ïñ¥ ÏùåÏÑ± ÏÑ†ÌÉù
      let bestKoreanVoice = null;
      
      function findBestKoreanVoice() {
          const voices = window.speechSynthesis.getVoices();
          if (!voices.length) return;
          
          const koreanVoices = voices.filter(v => v.lang.startsWith('ko'));
          if (!koreanVoices.length) return;
          
          // Ïö∞ÏÑ†ÏàúÏúÑ: Google ÌïúÍµ≠Ïñ¥ > Í∏∞Î≥∏ ÌïúÍµ≠Ïñ¥ > ÏïÑÎ¨¥ ÌïúÍµ≠Ïñ¥
          bestKoreanVoice = 
              koreanVoices.find(v => v.name.includes('Google') && v.name.includes('ÌïúÍµ≠')) ||
              koreanVoices.find(v => v.name.includes('Google')) ||
              koreanVoices.find(v => v.name.includes('Yuna')) ||
              koreanVoices.find(v => v.name.includes('Sora')) ||
              koreanVoices.find(v => v.default) ||
              koreanVoices[0];
          
          console.log('üîä ÏÑ†ÌÉùÎêú ÏùåÏÑ±:', bestKoreanVoice?.name);
      }
      
      // ÏùåÏÑ± Î™©Î°ù Î°úÎìú (ÎπÑÎèôÍ∏∞)
      if (window.speechSynthesis) {
          findBestKoreanVoice();
          window.speechSynthesis.addEventListener('voiceschanged', findBestKoreanVoice);
      }

      // ÏûêÎ™® Î∞úÏùå Îßµ (TTSÏóê Ï†ïÌôïÌïú Î∞úÏùå ÌÖçÏä§Ìä∏ Ï†ÑÎã¨)
      const jamoPronounciation = {
          '„Ñ±':'Í∏∞Ïó≠','„Ñ≤':'ÏåçÍ∏∞Ïó≠','„Ñ¥':'ÎãàÏùÄ','„Ñ∑':'ÎîîÍ∑ø','„Ñ∏':'ÏåçÎîîÍ∑ø',
          '„Ñπ':'Î¶¨ÏùÑ','„ÖÅ':'ÎØ∏Ïùå','„ÖÇ':'ÎπÑÏùç','„ÖÉ':'ÏåçÎπÑÏùç','„ÖÖ':'ÏãúÏò∑',
          '„ÖÜ':'ÏåçÏãúÏò∑','„Öá':'Ïù¥Ïùë','„Öà':'ÏßÄÏùí','„Öâ':'ÏåçÏßÄÏùí','„Öä':'ÏπòÏùì',
          '„Öã':'ÌÇ§Ïùî','„Öå':'Ìã∞Ïùï','„Öç':'ÌîºÏùñ','„Öé':'ÌûàÏùó',
          '„Öè':'ÏïÑ','„Öê':'Ïï†','„Öë':'Ïïº','„Öí':'Ïñò','„Öì':'Ïñ¥','„Öî':'Ïóê',
          '„Öï':'Ïó¨','„Öñ':'Ïòà','„Öó':'Ïò§','„Öò':'ÏôÄ','„Öô':'Ïôú','„Öö':'Ïô∏',
          '„Öõ':'Ïöî','„Öú':'Ïö∞','„Öù':'Ïõå','„Öû':'Ïõ®','„Öü':'ÏúÑ','„Ö†':'Ïú†',
          '„Ö°':'Ïúº','„Ö¢':'Ïùò','„Ö£':'Ïù¥'
      };

      function addToAudioQueue(text, button = null) {
          if (!soundEnabled) return;

          window.speechSynthesis.cancel();

          document.querySelectorAll('.speaking').forEach(el => {
              el.classList.remove('speaking');
          });

          if (button) {
              button.classList.add('speaking');
          }

          // ÏûêÎ™® 1Í∏ÄÏûêÎ©¥ Î∞úÏùåÎ™ÖÏúºÎ°ú Î≥ÄÌôò (Îçî Î™ÖÌôïÌïòÍ≤å Îì§Î¶º)
          const isJamo = text.length === 1 && jamoPronounciation[text];
          const speakText = isJamo ? jamoPronounciation[text] : text;

          const utterance = new SpeechSynthesisUtterance(speakText);
          utterance.lang = 'ko-KR';
          
          // ÏµúÏ†Å ÏùåÏÑ± Ï†ÅÏö©
          if (bestKoreanVoice) {
              utterance.voice = bestKoreanVoice;
          }
          
          // ÏûêÎ™® vs Îã®Ïñ¥/Î¨∏Ïû• Î≥Ñ ÌäúÎãù
          if (isJamo) {
              utterance.rate = 0.75;   // ÏûêÎ™®Îäî Ï≤úÏ≤úÌûà
              utterance.pitch = 1.15;  // ÏïΩÍ∞Ñ ÎÜíÏùÄ ÌÜ§ (ÏïÑÏù¥ ÏπúÌôî)
              utterance.volume = 1.0;  // ÏµúÎåÄ Î≥ºÎ•®
          } else if (text.length <= 3) {
              utterance.rate = 0.8;    // ÏßßÏùÄ Îã®Ïñ¥
              utterance.pitch = 1.1;
              utterance.volume = 1.0;
          } else {
              utterance.rate = 0.85;   // Î¨∏Ïû•/Í∏¥ ÌÖçÏä§Ìä∏
              utterance.pitch = 1.05;
              utterance.volume = 1.0;
          }

          utterance.onend = () => {
              if (button) button.classList.remove('speaking');
          };

          utterance.onerror = () => {
              if (button) button.classList.remove('speaking');
          };

          window.speechSynthesis.speak(utterance);
      }

      // ÏÇ¨Ïö©Ïûê Î†àÎ≤® ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (ÏàòÏ†ïÎê® - ÎèôÏ†Å Î†àÎ≤®ÏóÖ Í∏∞Ï§Ä)
      function updateUserLevel() {
          const oldLevel = userStats.level;
          const challengeCount = challengeWords.length || 10; // Í∏∞Î≥∏Í∞í 10Í∞ú
          
          userStats.level = Math.floor(userStats.totalCompleted / challengeCount) + 1;
          
          // Î†àÎ≤®Ïóê Îî∞Î•∏ Ï∫êÎ¶≠ÌÑ∞ Î≥ÄÍ≤Ω
          const newCharacter = levelCharacters[userStats.level] || levelCharacters[100];
          if (userStats.character !== newCharacter) {
              userStats.character = newCharacter;
          }
          
          document.getElementById('user-name').textContent = userStats.name;
          document.getElementById('user-level').textContent = userStats.level;
          document.getElementById('completed-count').textContent = userStats.totalCompleted % challengeCount;
          document.getElementById('total-count').textContent = challengeCount;
          document.getElementById('profile-character').textContent = userStats.character;
          
          // ÏßÑÌñâÎ∞î ÏóÖÎç∞Ïù¥Ìä∏ (ÎèôÏ†Å Í≥ÑÏÇ∞)
          const progress = (userStats.totalCompleted % challengeCount) * (100 / challengeCount);
          document.getElementById('progress-fill').style.width = progress + '%';
          
          // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
          localStorage.setItem('userName', userStats.name);
          localStorage.setItem('totalCompleted', userStats.totalCompleted);
          localStorage.setItem('userCharacter', userStats.character);
          
          // Î†àÎ≤®ÏóÖ Ï≤¥ÌÅ¨ (Ï∫êÎ¶≠ÌÑ∞ Î≥ÄÍ≤ΩÏãú ÌäπÎ≥Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò)
          if (oldLevel !== userStats.level && userStats.totalCompleted > 0) {
              showLevelUpAnimation();
          }
          if (userStats.level > _prevMainLevel && _prevMainLevel > 0) SFX.levelup();
          _prevMainLevel = userStats.level;
      }

      // üéÜ Î©ãÏßÑ Î†àÎ≤®ÏóÖ Ïï†ÎãàÎ©îÏù¥ÏÖò (6ÏÑ∏ ÎÇ®ÏïÑÏö©)
      function showLevelUpAnimation() {
          const animation = document.createElement('div');
          animation.className = 'levelup-animation';
          animation.innerHTML = `
              <div class="levelup-content">
                  <div class="levelup-title">LEVEL UP!</div>
                  <div class="levelup-character">${userStats.character}</div>
                  <div class="levelup-subtitle">Î†àÎ≤® ${userStats.level} Îã¨ÏÑ±!</div>
                  <div class="firework"></div>
                  <div class="firework"></div>
                  <div class="firework"></div>
                  <div class="firework"></div>
                  <div class="firework"></div>
                  <div class="firework"></div>
              </div>
          `;
          document.body.appendChild(animation);
          
          // 3Ï¥à ÌõÑ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†úÍ±∞
          setTimeout(() => {
              if (animation.parentNode) {
                  animation.parentNode.removeChild(animation);
              }
          }, 3000);
          
          // Î†àÎ≤®ÏóÖ ÏÜåÎ¶¨
          setTimeout(() => {
              if (soundEnabled) {
                  addToAudioQueue(`Î†àÎ≤® ${userStats.level} Îã¨ÏÑ±! ${userStats.name} ÏµúÍ≥†Ïïº!`);
              }
          }, 500);
      }

      // Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Í∏∞Îä• (ÌîÑÎ°úÌïÑ Ïù¥Î¶Ñ ÌÅ¥Î¶≠Ïãú)
      function changeUserName(event) {
          event.stopPropagation();
          const newName = prompt('Î©ãÏßÑ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî:', userStats.name);
          if (newName && newName.trim()) {
              userStats.name = newName.trim();
              updateUserLevel();
          }
      }

      // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù Î™®Îã¨ ÌëúÏãú
      function showCharacterModal(event) {
          event.stopPropagation();
          const modal = document.getElementById('character-modal');
          modal.classList.remove('hidden');
          
          // Ï∫êÎ¶≠ÌÑ∞ Í∑∏Î¶¨Îìú ÏÉùÏÑ±
          const grid = document.getElementById('character-grid');
          grid.innerHTML = '';
          
          for (let level = 1; level <= 100; level++) {
              const character = levelCharacters[level];
              const item = document.createElement('div');
              item.className = 'character-item';
              if (userStats.character === character) {
                  item.classList.add('selected');
              }
              item.innerHTML = `
                  <div style="font-size: 24px;">${character}</div>
                  <div class="character-level">LV.${level}</div>
              `;
              item.onclick = () => selectCharacter(character, level);
              grid.appendChild(item);
          }
      }

      // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù
      function selectCharacter(character, level) {
          userStats.character = character;
          updateUserLevel();
          closeCharacterModal();
          
          if (soundEnabled) {
              addToAudioQueue(`Î†àÎ≤® ${level} Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌñàÏñ¥Ïöî!`);
          }
      }

      // Ï∫êÎ¶≠ÌÑ∞ Î™®Îã¨ Îã´Í∏∞
      function closeCharacterModal() {
          const modal = document.getElementById('character-modal');
          modal.classList.add('hidden');
      }

      // Í¥ÄÎ¶¨Ïûê ÌîÑÎ°úÌïÑ Ï†ÄÏû•
      function saveProfile() {
          const name = document.getElementById('admin-name').value.trim();
          const level = parseInt(document.getElementById('admin-level').value);
          
          if (name) {
              userStats.name = name;
          }
          
          if (level && level >= 1 && level <= 100) {
              const challengeCount = challengeWords.length || 10;
              userStats.totalCompleted = (level - 1) * challengeCount;
              userStats.level = level;
              userStats.character = levelCharacters[level] || levelCharacters[100];
          }
          
          updateUserLevel();
          alert('ÌîÑÎ°úÌïÑÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
      }

      // Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî
      function resetAll() {
          if (confirm('Ï†ïÎßêÎ°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Ïù¥Î¶Ñ, Î†àÎ≤®, Ï†ÄÏû•Îêú Îã®Ïñ¥, ÎèÑÏ†Ñ Í∏∞Î°ù Î™®Îëê ÏÇ≠Ï†úÎê©ÎãàÎã§)')) {
              localStorage.clear();
              
              // Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï¥àÍ∏∞Ìôî
              userStats = {
                  name: 'ÏäàÌçºÌûàÏñ¥Î°ú',
                  totalCompleted: 0,
                  level: 1,
                  character: 'ü¶∏‚Äç‚ôÇÔ∏è'
              };
              
              savedWords = [];
              challengeWords = [];
              completedChallenges = [];
              currentChallengeIndex = -1;
              
              updateUserLevel();
              updateSavedWordsDisplay();
              updateChallengeDisplay();
              
              // Í¥ÄÎ¶¨Ïûê Î™®Îã¨ ÌïÑÎìú Ï¥àÍ∏∞Ìôî
              document.getElementById('admin-name').value = '';
              document.getElementById('admin-level').value = '';
              document.querySelectorAll('.word-inputs input').forEach(input => input.value = '');
              
              alert('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§!');
          }
      }

      // ÌïúÍ∏Ä ÏûêÎ™® ÌåêÎ≥Ñ Ìï®Ïàò
      function isConsonant(char) {
          const consonants = ['„Ñ±', '„Ñ≤', '„Ñ¥', '„Ñ∑', '„Ñ∏', '„Ñπ', '„ÖÅ', '„ÖÇ', '„ÖÉ', '„ÖÖ', '„ÖÜ', '„Öá', '„Öà', '„Öâ', '„Öä', '„Öã', '„Öå', '„Öç', '„Öé'];
          return consonants.includes(char);
      }

      function isVowel(char) {
          const vowels = ['„Öè', '„Öê', '„Öë', '„Öí', '„Öì', '„Öî', '„Öï', '„Öñ', '„Öó', '„Öò', '„Öô', '„Öö', '„Öõ', '„Öú', '„Öù', '„Öû', '„Öü', '„Ö†', '„Ö°', '„Ö¢', '„Ö£'];
          return vowels.includes(char);
      }

      // URL ÌååÎùºÎØ∏ÌÑ∞ Ï≤¥ÌÅ¨
      function checkURLParams() {
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.get('admin') === 'true') {
              setTimeout(() => showAdminModal(), 500);
          }
      }

      // Ïà®Í≤®ÏßÑ Ï°∞Ìï©ÌÇ§ (ÏÜåÎ¶¨ Î≤ÑÌäº 4Î≤à ÌÅ¥Î¶≠ÏúºÎ°ú Î≥ÄÍ≤Ω)
      function handleSecretKey() {
          secretClickCount++;
          
          if (secretClickCount === 1) {
              secretTimer = setTimeout(() => {
                  secretClickCount = 0;
              }, 5000);
          }
          
          if (secretClickCount === 4) { // 4Î≤àÏúºÎ°ú Î≥ÄÍ≤Ω
              clearTimeout(secretTimer);
              secretClickCount = 0;
              showAdminModal();
              
              if (soundEnabled) {
                  addToAudioQueue('Í¥ÄÎ¶¨Ïûê Î™®Îìú ÌôúÏÑ±Ìôî');
              }
          }
      }

      // Í¥ÄÎ¶¨Ïûê Î™®Îã¨ ÌëúÏãú
      function showAdminModal() {
          const modal = document.getElementById('admin-modal');
          modal.classList.remove('hidden');
          loadExistingWords();
          
          // ÌòÑÏû¨ ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ Î°úÎìú
          document.getElementById('admin-name').value = userStats.name;
          document.getElementById('admin-level').value = userStats.level;
      }

      // Í¥ÄÎ¶¨Ïûê Î™®Îã¨ Îã´Í∏∞
      function closeAdminModal() {
          const modal = document.getElementById('admin-modal');
          modal.classList.add('hidden');
      }

      // Í∏∞Ï°¥ Îã®Ïñ¥Îì§ Î°úÎìú
      function loadExistingWords() {
          const inputs = document.querySelectorAll('.word-inputs input');
          challengeWords.forEach((word, index) => {
              if (inputs[index]) {
                  inputs[index].value = word;
              }
          });
      }

      // Î†àÎ≤®Î≥Ñ Îã®Ïñ¥ ÌÖúÌîåÎ¶ø
      const wordTemplates = {
          easy: ['Í∞Ä','ÎÇò','Îã§','Îßà','Î∞î'],
          medium: ['ÏóÑÎßà','ÏïÑÎπ†','ÏÇ¨Í≥º','Î∞îÎÇòÎÇò','Ìè¨ÎèÑ'],
          hard: ['Ìï†Î®∏Îãà','ÏàòÎ∞ï','Îî∏Í∏∞','Í∞ïÏïÑÏßÄ','Í≥†ÏñëÏù¥']
      };

      function loadTemplate(type) {
          const inputs = document.querySelectorAll('.word-inputs input');
          inputs.forEach(i => i.value = '');

          let words;
          if (type === 'random') {
              const all = [...wordTemplates.easy, ...wordTemplates.medium, ...wordTemplates.hard];
              words = [];
              const shuffled = all.sort(() => Math.random() - 0.5);
              for (let i = 0; i < 5 && i < shuffled.length; i++) {
                  words.push(shuffled[i]);
              }
          } else {
              words = [...wordTemplates[type]];
          }

          words.forEach((w, i) => {
              if (inputs[i]) inputs[i].value = w;
          });
      }

      // ÎèÑÏ†ÑÏö© Îã®Ïñ¥ Ï†ÄÏû• (ÏàòÏ†ïÎê® - ÎèÑÏ†Ñ Í∏∞Î°ù Ï¥àÍ∏∞Ìôî)
      function saveChallengeWords() {
          const inputs = document.querySelectorAll('.word-inputs input');
          const newWords = [];
          
          inputs.forEach(input => {
              const word = input.value.trim();
              if (word) {
                  newWords.push(word);
              }
          });
          
          if (newWords.length === 0) {
              alert('ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅÏùò Îã®Ïñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
              return;
          }
          
          challengeWords = newWords;
          currentChallengeIndex = -1;
          
          // ÏÉàÎ°úÏö¥ Îã®Ïñ¥ ÏÑ§Ï†ïÏãú ÎèÑÏ†Ñ Í∏∞Î°ù Î∞è ÏÇ¨Ïö©Ïûê Ïä§ÌÉØ Ï¥àÍ∏∞Ìôî
          completedChallenges = [];
          userStats.totalCompleted = 0;
          userStats.level = 1;
          userStats.character = levelCharacters[1];
          
          localStorage.setItem('challengeWords', JSON.stringify(challengeWords));
          localStorage.setItem('completedChallenges', JSON.stringify(completedChallenges));
          localStorage.setItem('totalCompleted', userStats.totalCompleted);
          localStorage.setItem('userCharacter', userStats.character);
          
          updateChallengeDisplay();
          updateUserLevel();
          
          alert(`${newWords.length}Í∞úÏùò Îã®Ïñ¥Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!\nÎèÑÏ†Ñ Í∏∞Î°ùÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.`);
      }

      // ÌÉ≠ Ï†ÑÌôò
      function switchTab(tabName) {
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          
          document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
          document.querySelector(`.${tabName}-tab`).classList.add('active');
          
          challengeMode = (tabName === 'challenge');
          
          if (challengeMode) {
              resetCurrentInput();
          }
          
          // Í∞ÄÏö¥Îç∞ ÏòÅÏó≠ Ï†ÑÌôò
          const keyboardView = document.getElementById('keyboard-view');
          const chartView = document.getElementById('chart-view');
          const traceView = document.getElementById('trace-view');
          
          keyboardView.style.display = 'none';
          chartView.classList.add('hidden');
          traceView.classList.add('hidden');
          
          if (tabName === 'chart') {
              chartView.classList.remove('hidden');
              buildChartNav();
              buildCombinationChart();
          } else if (tabName === 'trace') {
              traceView.classList.remove('hidden');
              initTrace();
          } else if (tabName === 'record') {
              updateRecords();
          } else {
              keyboardView.style.display = '';
          }

          // Ïò§Î•∏Ï™Ω Î≤ÑÌäº ÌôúÏÑ±/ÎπÑÌôúÏÑ± (ÌÇ§Î≥¥Îìú Ïì∞Îäî ÌÉ≠Îßå ÌôúÏÑ±)
          const useKB = (tabName === 'saved' || tabName === 'challenge');
          document.getElementById('read-btn').disabled = !useKB;
          document.getElementById('complete-btn').disabled = !useKB;
          document.getElementById('backspace-btn').disabled = !useKB;
          if (useKB) updateActionButtons();
      }

      // ÌòÑÏû¨ ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
      function resetCurrentInput() {
          currentWord = [];
          currentChar = {
              choseong: '',
              jungseong: '',
              jongseong: ''
          };
          updateTextDisplay();
          updateActionButtons();
      }

      // ÎèÑÏ†Ñ ÎîîÏä§ÌîåÎ†àÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ (ÏµúÎåÄ 5Í∞ú, Ïù¥Î™®ÏßÄ Î≤àÌò∏)
      function updateChallengeDisplay() {
          const challengeContent = document.getElementById('challenge-content');

          if (challengeWords.length === 0) {
              challengeContent.innerHTML = '<div class="no-challenge">Í¥ÄÎ¶¨ÏûêÍ∞Ä Îã®Ïñ¥Î•º<br>ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî</div>';
              return;
          }

          const emojiNums = ['1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£'];
          const displayWords = challengeWords.slice(0, 5);

          let html = '';
          displayWords.forEach((word, index) => {
              let className = 'challenge-word';
              let icon = 'üîä';
              let displayText = `${emojiNums[index]} Îã®Ïñ¥`;

              if (completedChallenges.includes(index)) {
                  className += ' completed';
                  icon = '‚úÖ';
                  displayText = `${emojiNums[index]} ${word}`;
              } else if (index === currentChallengeIndex) {
                  className += ' current';
                  icon = 'üéØ';
                  displayText = `${emojiNums[index]} Îã®Ïñ¥`;
              }

              html += `<div class="${className}" data-action="play-challenge" data-index="${index}">
                          ${icon} ${displayText}
                       </div>`;
          });

          challengeContent.innerHTML = html;
      }

      // ÎèÑÏ†Ñ Îã®Ïñ¥ Ïû¨ÏÉù (ÏàòÏ†ïÎê® - ÏôÑÎ£åÎêú Îã®Ïñ¥ÎèÑ ÏÜåÎ¶¨ ÎÇòÍ≤å)
      function playChallengeWord(index) {
          if (!soundEnabled) return;
          
          const word = challengeWords[index];
          if (!word) return;
          
          // ÏôÑÎ£åÎêú Îã®Ïñ¥Î•º ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞ ÏÜåÎ¶¨Îßå Ïû¨ÏÉù
          if (completedChallenges.includes(index)) {
              addToAudioQueue(word);
              return;
          }
          
          // Îã§Î•∏ Î≤àÌò∏Î•º ÌÅ¥Î¶≠ÌñàÏùÑ ÎïåÎßå ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
          if (currentChallengeIndex !== index) {
              resetCurrentInput();
          }
          
          currentChallengeIndex = index;
          
          addToAudioQueue(word);
          
          updateChallengeDisplay();
      }

      // ÎèÑÏ†Ñ ÏôÑÎ£å Ï≤¥ÌÅ¨
      function checkChallengeAnswer() {
          if (!challengeMode || currentChallengeIndex === -1) return false;
          
          const currentText = currentWord.join('') + getCurrentCharDisplay();
          const targetWord = challengeWords[currentChallengeIndex];
          
          if (currentText === targetWord) {
              // Ï†ïÎãµ!
              completedChallenges.push(currentChallengeIndex);
              localStorage.setItem('completedChallenges', JSON.stringify(completedChallenges));
              
              // ÏÇ¨Ïö©Ïûê Ïä§ÌÉØ ÏóÖÎç∞Ïù¥Ìä∏
              userStats.totalCompleted++;
              updateUserLevel();
              
              SFX.correct(); SFX.fanfare(); setMascotEmotion('happy');
              showChallengeSuccess(targetWord);
              updateChallengeDisplay();
              
              // Î™®Îì† ÎèÑÏ†Ñ ÏôÑÎ£å Ï≤¥ÌÅ¨
              if (completedChallenges.length === challengeWords.length) {
                  setTimeout(() => showAllChallengesComplete(), 1000);
              }
              
              return true;
          } else {
              SFX.wrong(); setMascotEmotion('worried');
              showChallengeWrong(currentText);
              return false;
          }
      }

      // ÎèÑÏ†Ñ ÏÑ±Í≥µ Ïï†ÎãàÎ©îÏù¥ÏÖò
      function showChallengeSuccess(word) {
          const successMessage = document.createElement('div');
          successMessage.className = 'success-message';
          successMessage.innerHTML = `<span class="rainbow-text">üéâ "${word}" Ï†ïÎãµ! üéâ</span>`;
          document.body.appendChild(successMessage);
          
          setTimeout(() => {
              if (successMessage.parentNode) {
                  successMessage.parentNode.removeChild(successMessage);
              }
          }, 2500);
          
          setTimeout(() => {
              addToAudioQueue('ÏûòÌñàÏñ¥Ïöî');
          }, 300);
      }

      // ÎèÑÏ†Ñ Ïã§Ìå® Ïï†ÎãàÎ©îÏù¥ÏÖò
      function showChallengeWrong(attempt) {
          const wrongMessage = document.createElement('div');
          wrongMessage.className = 'success-message';
          wrongMessage.innerHTML = `<span style="color: #ef4444;">‚ùå ÌãÄÎ†∏Ïñ¥Ïöî!<br>Îã§Ïãú Ìï¥Î≥¥ÏÑ∏Ïöî</span>`;
          document.body.appendChild(wrongMessage);
          
          const challengeBtn = document.querySelector(`[data-index="${currentChallengeIndex}"]`);
          if (challengeBtn) {
              challengeBtn.classList.add('wrong');
              setTimeout(() => {
                  challengeBtn.classList.remove('wrong');
              }, 2000);
          }
          
          setTimeout(() => {
              if (wrongMessage.parentNode) {
                  wrongMessage.parentNode.removeChild(wrongMessage);
              }
          }, 2500);
          
          setTimeout(() => {
              addToAudioQueue('Îã§Ïãú Ìï¥Î≥¥ÏÑ∏Ïöî');
          }, 300);
      }

      // Î™®Îì† ÎèÑÏ†Ñ ÏôÑÎ£å
      function showAllChallengesComplete() {
          const successMessage = document.createElement('div');
          successMessage.className = 'success-message';
          successMessage.innerHTML = `<span class="rainbow-text">üèÜ Î™®Îì† ÎèÑÏ†Ñ ÏôÑÎ£å! üèÜ<br>Ï†ïÎßê ÎåÄÎã®Ìï¥Ïöî!</span>`;
          document.body.appendChild(successMessage);
          
          setTimeout(() => {
              if (successMessage.parentNode) {
                  successMessage.parentNode.removeChild(successMessage);
              }
          }, 4000);
          
          setTimeout(() => {
              addToAudioQueue('Î™®Îì† ÎèÑÏ†ÑÏùÑ ÏôÑÎ£åÌñàÏñ¥Ïöî! Ï†ïÎßê ÌõåÎ•≠Ìï¥Ïöî!');
          }, 500);
      }

      // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
      function loadChallengeData() {
          const savedWords = localStorage.getItem('challengeWords');
          const savedCompleted = localStorage.getItem('completedChallenges');
          
          if (savedWords) {
              challengeWords = JSON.parse(savedWords);
          }
          
          if (savedCompleted) {
              completedChallenges = JSON.parse(savedCompleted);
          }
          
          updateChallengeDisplay();
      }

      // ÌïúÍ∏Ä ÏûêÎèô Ï°∞Ìï© Î°úÏßÅ (Í∞úÏÑ†Îê®)
      async function addCharacterInput(char, button) {
          addToAudioQueue(char, button);

          if (isConsonant(char)) {
              if (!currentChar.choseong) {
                  currentChar.choseong = char;
              } else if (currentChar.choseong && !currentChar.jungseong) {
                  currentChar.choseong = char;
              } else if (currentChar.choseong && currentChar.jungseong && !currentChar.jongseong) {
                  currentChar.jongseong = char;
              } else if (currentChar.choseong && currentChar.jungseong && currentChar.jongseong) {
                  const doubleJongseong = combineJongseong(currentChar.jongseong, char);
                  if (doubleJongseong) {
                      currentChar.jongseong = doubleJongseong;
                  } else {
                      await completeCurrentChar();
                      currentChar.choseong = char;
                      currentChar.jungseong = '';
                      currentChar.jongseong = '';
                  }
              }
          } else if (isVowel(char)) {
              if (currentChar.choseong && !currentChar.jungseong) {
                  currentChar.jungseong = char;
              } else if (currentChar.choseong && currentChar.jungseong && !currentChar.jongseong) {
                  const doubleJungseong = combineJungseong(currentChar.jungseong, char);
                  if (doubleJungseong) {
                      currentChar.jungseong = doubleJungseong;
                  } else {
                      await completeCurrentChar();
                      return;
                  }
              } else if (currentChar.choseong && currentChar.jungseong && currentChar.jongseong) {
                  const splitResult = splitJongseong(currentChar.jongseong);
                  if (splitResult.canSplit) {
                      currentChar.jongseong = splitResult.first;
                      await completeCurrentChar();
                      currentChar.choseong = splitResult.second;
                      currentChar.jungseong = char;
                      currentChar.jongseong = '';
                  } else {
                      const jongseong = currentChar.jongseong;
                      currentChar.jongseong = '';
                      await completeCurrentChar();
                      currentChar.choseong = jongseong;
                      currentChar.jungseong = char;
                  }
              } else if (!currentChar.choseong) {
                  return;
              }
          }

          updateTextDisplay();
          updateActionButtons();
      }

      // Î≥µÌï©Î™®Ïùå Ï°∞Ìï© Ìï®Ïàò
      function combineJungseong(first, second) {
          const combinations = {
              '„Öó„Öè': '„Öò', '„Öó„Öê': '„Öô', '„Öó„Ö£': '„Öö',
              '„Öú„Öì': '„Öù', '„Öú„Öî': '„Öû', '„Öú„Ö£': '„Öü',
              '„Ö°„Ö£': '„Ö¢', '„Öë„Ö£': '„Öí', '„Öï„Ö£': '„Öñ'
          };
          
          const key = first + second;
          return combinations[key] || null;
      }

      // ÌòÑÏû¨ Í∏ÄÏûê ÏôÑÏÑ±ÌïòÍ≥† Îã®Ïñ¥Ïóê Ï∂îÍ∞Ä
      async function completeCurrentChar() {
          if (currentChar.choseong && currentChar.jungseong) {
              const composed = composeCharacter(currentChar.choseong, currentChar.jungseong, currentChar.jongseong);
              if (composed) {
                  currentWord.push(composed);
                  
                  currentChar = {
                      choseong: '',
                      jungseong: '',
                      jongseong: ''
                  };
              }
          }
      }

      // Ïù¥Ï§ëÎ∞õÏπ® Ï°∞Ìï© Ìï®Ïàò
      function combineJongseong(first, second) {
          const combinations = {
              '„Ñ±„ÖÖ': '„Ñ≥', '„Ñ¥„Öà': '„Ñµ', '„Ñ¥„Öé': '„Ñ∂',
              '„Ñπ„Ñ±': '„Ñ∫', '„Ñπ„ÖÅ': '„Ñª', '„Ñπ„ÖÇ': '„Ñº',
              '„Ñπ„ÖÖ': '„ÑΩ', '„Ñπ„Öå': '„Ñæ', '„Ñπ„Öç': '„Ñø',
              '„Ñπ„Öé': '„ÖÄ', '„ÖÇ„ÖÖ': '„ÖÑ'
          };
          
          const key = first + second;
          return combinations[key] || null;
      }

      // Ïù¥Ï§ëÎ∞õÏπ® Î∂ÑÎ¶¨ Ìï®Ïàò
      function splitJongseong(jongseong) {
          const splits = {
              '„Ñ≥': { first: '„Ñ±', second: '„ÖÖ', canSplit: true },
              '„Ñµ': { first: '„Ñ¥', second: '„Öà', canSplit: true },
              '„Ñ∂': { first: '„Ñ¥', second: '„Öé', canSplit: true },
              '„Ñ∫': { first: '„Ñπ', second: '„Ñ±', canSplit: true },
              '„Ñª': { first: '„Ñπ', second: '„ÖÅ', canSplit: true },
              '„Ñº': { first: '„Ñπ', second: '„ÖÇ', canSplit: true },
              '„ÑΩ': { first: '„Ñπ', second: '„ÖÖ', canSplit: true },
              '„Ñæ': { first: '„Ñπ', second: '„Öå', canSplit: true },
              '„Ñø': { first: '„Ñπ', second: '„Öç', canSplit: true },
              '„ÖÄ': { first: '„Ñπ', second: '„Öé', canSplit: true },
              '„ÖÑ': { first: '„ÖÇ', second: '„ÖÖ', canSplit: true }
          };
          
          return splits[jongseong] || { canSplit: false };
      }

      // ÌïúÍ∏Ä Ï°∞Ìï© Ìï®Ïàò (Í∞úÏÑ†Îê®)
      function composeCharacter(choseong, jungseong, jongseong = '') {
          const CHOSEONG_MAP = {
              '„Ñ±': 0, '„Ñ≤': 1, '„Ñ¥': 2, '„Ñ∑': 3, '„Ñ∏': 4, '„Ñπ': 5, '„ÖÅ': 6,
              '„ÖÇ': 7, '„ÖÉ': 8, '„ÖÖ': 9, '„ÖÜ': 10, '„Öá': 11, '„Öà': 12, '„Öâ': 13,
              '„Öä': 14, '„Öã': 15, '„Öå': 16, '„Öç': 17, '„Öé': 18
          };
          
          const JUNGSEONG_MAP = {
              '„Öè': 0, '„Öê': 1, '„Öë': 2, '„Öí': 3, '„Öì': 4, '„Öî': 5, '„Öï': 6,
              '„Öñ': 7, '„Öó': 8, '„Öò': 9, '„Öô': 10, '„Öö': 11, '„Öõ': 12, '„Öú': 13,
              '„Öù': 14, '„Öû': 15, '„Öü': 16, '„Ö†': 17, '„Ö°': 18, '„Ö¢': 19, '„Ö£': 20
          };
          
          const JONGSEONG_MAP = {
              '': 0, '„Ñ±': 1, '„Ñ≤': 2, '„Ñ≥': 3, '„Ñ¥': 4, '„Ñµ': 5, '„Ñ∂': 6,
              '„Ñ∑': 7, '„Ñπ': 8, '„Ñ∫': 9, '„Ñª': 10, '„Ñº': 11, '„ÑΩ': 12,
              '„Ñæ': 13, '„Ñø': 14, '„ÖÄ': 15, '„ÖÅ': 16, '„ÖÇ': 17, '„ÖÑ': 18,
              '„ÖÖ': 19, '„ÖÜ': 20, '„Öá': 21, '„Öà': 22, '„Öä': 23, '„Öã': 24, '„Öå': 25,
              '„Öç': 26, '„Öé': 27
          };
          
          // ÏûÖÎ†•Í∞í Í≤ÄÏ¶ù Í∞ïÌôî
          if (!choseong || !jungseong) {
              return choseong + (jungseong || '') + (jongseong || '');
          }
          
          if (!(choseong in CHOSEONG_MAP) || !(jungseong in JUNGSEONG_MAP)) {
              return choseong + jungseong + (jongseong || '');
          }
          
          if (jongseong && !(jongseong in JONGSEONG_MAP)) {
              return choseong + jungseong + jongseong;
          }
          
          try {
              const code = 0xAC00 + 
                          (CHOSEONG_MAP[choseong] * 588) + 
                          (JUNGSEONG_MAP[jungseong] * 28) + 
                          (JONGSEONG_MAP[jongseong] || 0);
              return String.fromCharCode(code);
          } catch (error) {
              console.error('ÌïúÍ∏Ä Ï°∞Ìï© Ïò§Î•ò:', error);
              return choseong + jungseong + (jongseong || '');
          }
      }

      function readCurrentText() {
          const fullText = currentWord.join('') + getCurrentCharDisplay();
          
          if (fullText) {
              addToAudioQueue(fullText);
          } else {
              addToAudioQueue('ÎßåÎì§Ïñ¥ÏßÑ Í∏ÄÏûêÍ∞Ä ÏóÜÏñ¥Ïöî');
          }
      }

      function toggleSound() {
          soundEnabled = !soundEnabled;
          const soundButton = document.querySelector('.sound-toggle');
          const sbSound = document.getElementById('sb-sound');
          
          if (soundEnabled) {
              if (soundButton) { soundButton.innerHTML = 'üîä ÏÜåÎ¶¨'; soundButton.classList.remove('muted'); }
              if (sbSound) { sbSound.textContent = 'üîä'; sbSound.classList.remove('muted'); }
          } else {
              if (soundButton) { soundButton.innerHTML = 'üîá ÏùåÏÜåÍ±∞'; soundButton.classList.add('muted'); }
              if (sbSound) { sbSound.textContent = 'üîá'; sbSound.classList.add('muted'); }
              
              window.speechSynthesis.cancel();
              
              document.querySelectorAll('.speaking').forEach(el => {
                  el.classList.remove('speaking');
              });
          }
      }

      function updateSavedWordsDisplay() {
          const display = document.getElementById('saved-chars-display');
          
          if (savedWords.length === 0) {
              display.innerHTML = '<div class="empty-saved">Ï†ÄÏû•Îêú Îã®Ïñ¥Í∞Ä<br>ÏóÜÏñ¥Ïöî</div>';
          } else {
              display.innerHTML = savedWords.map(word => 
                  `<div class="saved-word" data-action="speak-word" data-value="${word}">${word}</div>`
              ).join('');
          }
      }

      function updateTextDisplay() {
          const display = document.getElementById('text-display');
          let content = '';
          
          if (currentWord.length > 0) {
              content += currentWord.map(char => 
                  `<span class="word-char">${char}</span>`
              ).join('');
          }
          
          if (currentChar.choseong || currentChar.jungseong) {
              const currentDisplay = getCurrentCharDisplay();
              if (currentDisplay) {
                  content += `<span class="current-char">${currentDisplay}</span>`;
              }
          }
          
          if (!content) {
              content = '<span style="color: #94a3b8; font-size: 0.5em;">Ïó¨Í∏∞Ïóê Í∏ÄÏûêÍ∞Ä ÎÇòÌÉÄÎÇòÏöî</span>';
          }
          
          display.innerHTML = content;
      }

      function getCurrentCharDisplay() {
            if (!currentChar.choseong) return '';
            if (!currentChar.jungseong) return currentChar.choseong;
            
            // Î∞õÏπ®Ïù¥ ÏûàÏùÑ ÎïåÎäî Î¨¥Ï°∞Í±¥ Ï°∞Ìï©Ìï¥ÏÑú Î≥¥Ïó¨Ï£ºÍ∏∞ (Î¨∏Î≤ïÏóê ÎßûÏßÄ ÏïäÏïÑÎèÑ)
            if (currentChar.jongseong) {
                // Ï†ïÏÉÅ Ï°∞Ìï© ÏãúÎèÑ
                const composed = composeCharacter(currentChar.choseong, currentChar.jungseong, currentChar.jongseong);
                
                // Ï°∞Ìï©Ïù¥ Ïã§Ìå®Ìïú Í≤ΩÏö∞ (Î∞õÏπ®ÏúºÎ°ú Ïò¨ Ïàò ÏóÜÎäî ÏûêÏùå)
                if (composed === currentChar.choseong + currentChar.jungseong + currentChar.jongseong) {
                    // Í∏∞Î≥∏ Í∏ÄÏûê + Î∞õÏπ® ÏûêÏùåÏùÑ Îî∞Î°ú ÌëúÏãú (Ïòà: "ÏïÑ„ÖÉ")
                    const baseChar = composeCharacter(currentChar.choseong, currentChar.jungseong, '');
                    return baseChar + currentChar.jongseong;
                }
                
                return composed;
            }
            
            return composeCharacter(currentChar.choseong, currentChar.jungseong, '');
        }

      function updateActionButtons() {
          const readBtn = document.getElementById('read-btn');
          const backspaceBtn = document.getElementById('backspace-btn');
          const completeBtn = document.getElementById('complete-btn');
          
          readBtn.disabled = false;
          
          if (currentWord.length > 0 || currentChar.choseong || currentChar.jungseong || currentChar.jongseong) {
              backspaceBtn.disabled = false;
          } else {
              backspaceBtn.disabled = true;
          }
          
          if (currentWord.length > 0 || (currentChar.choseong && currentChar.jungseong)) {
              completeBtn.disabled = false;
          } else {
              completeBtn.disabled = true;
          }
      }

      function backspace() {
          addToAudioQueue('ÏßÄÏõ†Ïñ¥Ïöî');
          
          if (currentChar.jongseong) {
              currentChar.jongseong = '';
          } else if (currentChar.jungseong) {
              currentChar.jungseong = '';
          } else if (currentChar.choseong) {
              currentChar.choseong = '';
          } else if (currentWord.length > 0) {
              currentWord.pop();
          }
          
          updateTextDisplay();
          updateActionButtons();
      }

      async function completeWord() {
           if (currentChar.choseong && currentChar.jungseong) {
               await completeCurrentChar();
           }
           
           if (currentWord.length > 0) {
               const wordString = currentWord.join('');
               
               // ÏôÑÏÑ±Îêú Îã®Ïñ¥Î•º Î®ºÏ†Ä ÏùΩÏñ¥Ï£ºÍ∏∞
               addToAudioQueue(wordString);
               
               if (challengeMode) {
                   const isCorrect = checkChallengeAnswer();
                   
                   if (isCorrect) {
                       resetCurrentInput();
                   } else {
                       currentWord = [];
                       updateTextDisplay();
                       updateActionButtons();
                   }
               } else {
                   savedWords.push(wordString);
                   
                   if (savedWords.length > 10) {
                       savedWords.shift();
                   }
                   
                   updateSavedWordsDisplay();
                   showWordCompletionAnimation(wordString);
                   
                   // ÏôÑÏÑ± ÌõÑ Í≤©Î†§ Î©îÏãúÏßÄ
                   setTimeout(() => {
                       addToAudioQueue('ÏûòÌñàÏñ¥Ïöî');
                   }, 1500); // Îã®Ïñ¥ ÏùΩÍ∏∞Í∞Ä ÎÅùÎÇú ÌõÑ Í≤©Î†§
                   
                   resetCurrentInput();
               }
           }
       }

      function showWordCompletionAnimation(word) {
          const successMessage = document.createElement('div');
          successMessage.className = 'success-message';
          successMessage.innerHTML = `<span class="rainbow-text">üéØ "${word}" ÏôÑÏÑ±! üéØ</span>`;
          document.body.appendChild(successMessage);

          for (let i = 0; i < 12; i++) {
              const star = document.createElement('div');
              star.className = 'star';
              star.style.left = Math.random() * 100 + '%';
              star.style.top = Math.random() * 100 + '%';
              star.style.animationDelay = Math.random() * 1.5 + 's';
              document.body.appendChild(star);
          }

          setTimeout(() => {
              if (successMessage.parentNode) {
                  successMessage.parentNode.removeChild(successMessage);
              }
              document.querySelectorAll('.star').forEach(el => {
                  if (el.parentNode) {
                      el.parentNode.removeChild(el);
                  }
              });
          }, 2500);
      }

      function reset() {
          savedWords = [];
          currentWord = [];
          currentChar = {
              choseong: '',
              jungseong: '',
              jongseong: ''
          };
          
          if (challengeMode) {
              completedChallenges = [];
              localStorage.setItem('completedChallenges', JSON.stringify(completedChallenges));
              updateChallengeDisplay();
          }
          
          updateSavedWordsDisplay();
          updateTextDisplay();
          updateActionButtons();
      }

      function speakCurrentDisplay() {
          const display = document.getElementById('text-display');
          const text = display.textContent.trim();
          
          if (text && text !== 'Ïó¨Í∏∞Ïóê Í∏ÄÏûêÍ∞Ä ÎÇòÌÉÄÎÇòÏöî') {
              const fullText = currentWord.join('') + getCurrentCharDisplay();
              if (fullText) {
                  addToAudioQueue(fullText);
              }
          }
      }

      function handleAction(action, value, button) {
          switch(action) {
              case 'char-input':
                  addCharacterInput(value, button);
                  break;
              case 'read-text':
                  readCurrentText();
                  break;
              case 'backspace':
                  backspace();
                  break;
              case 'complete-word':
                  completeWord();
                  break;
              case 'speak-word':
                  addToAudioQueue(value);
                  break;
                  case 'toggle-sound':
                  toggleSound();
                  handleSecretKey(); // 4Î≤à ÌÅ¥Î¶≠ Ï≤¥ÌÅ¨
                  break;
              case 'reset':
                  reset();
                  break;
              case 'switch-tab':
                  switchTab(value);
                  break;
              case 'play-challenge':
                  playChallengeWord(parseInt(value));
                  break;
          }
      }

      function setupEventListeners() {
          document.addEventListener('click', function(e) {
              const button = e.target.closest('[data-action]');
              if (button && !button.disabled) {
                  e.preventDefault();
                  e.stopPropagation();
                  const action = button.getAttribute('data-action');
                  const value = button.getAttribute('data-value') || button.getAttribute('data-tab') || button.getAttribute('data-index');
                  handleAction(action, value, button);
              }
          });

          document.getElementById('text-display').addEventListener('click', speakCurrentDisplay);

          document.addEventListener('touchstart', function(e) {
              const button = e.target.closest('[data-action]');
              if (button && !button.disabled) {
                  e.preventDefault();
                  e.stopPropagation();
                  button.classList.add('touching');
              }
          }, { passive: false });

          document.addEventListener('touchend', function(e) {
              const button = e.target.closest('[data-action]');
              if (button && !button.disabled) {
                  e.preventDefault();
                  e.stopPropagation();
                  button.classList.remove('touching');
                  
                  const action = button.getAttribute('data-action');
                  const value = button.getAttribute('data-value') || button.getAttribute('data-tab') || button.getAttribute('data-index');
                  handleAction(action, value, button);
              }
          }, { passive: false });

          document.addEventListener('touchcancel', function(e) {
              const buttons = document.querySelectorAll('[data-action].touching');
              buttons.forEach(button => {
                  button.classList.remove('touching');
              });
          });
          
          document.addEventListener('keydown', function(e) {
              if (e.key === 'Escape') {
                  closeAdminModal();
                  closeCharacterModal();
              }
          });
      }

      // Î™®Î∞îÏùº ÏµúÏ†ÅÌôî
      document.addEventListener('touchmove', function(e) {
          if (e.target.closest('.consonant-grid') || 
              e.target.closest('.vowel-grid') ||
              e.target.closest('.double-consonant-grid') ||
              e.target.closest('.double-vowel-grid') ||
              e.target.closest('.right-panel')) {
              e.preventDefault();
          }
      }, { passive: false });

      // ÎçîÎ∏îÌÉ≠ Ï§å Î∞©ÏßÄ
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(e) {
          const now = Date.now();
          if (now - lastTouchEnd <= 300) {
              e.preventDefault();
          }
          lastTouchEnd = now;
      }, false);

      // Ï¥àÍ∏∞Ìôî
      document.addEventListener('DOMContentLoaded', function() {
          // 1920√ó1080 Í∏∞Ï§Ä scale + 3% ÎßàÏßÑ (TV/ÌÉúÎ∏îÎ¶ø/Ìè∞ Í≥µÌÜµ)
          function fitScale() {
              const container = document.querySelector('.container');
              if (!container || getComputedStyle(container).display === 'none') return;
              const vp = window.visualViewport || {width: window.innerWidth, height: window.innerHeight};
              const MARGIN = 0.03;
              const availW = vp.width * (1 - MARGIN * 2);
              const availH = vp.height * (1 - MARGIN * 2);
              const scaleX = availW / 1920;
              const scaleY = availH / 1080;
              const scale = Math.min(scaleX, scaleY);
              container.style.transform = `scale(${scale})`;
              container.style.transformOrigin = '0 0';
              container.style.left = ((vp.width - 1920 * scale) / 2) + 'px';
              container.style.top = ((vp.height - 1080 * scale) / 2) + 'px';
          }
          fitScale();
          window.addEventListener('resize', fitScale);
          if (window.visualViewport) {
              window.visualViewport.addEventListener('resize', fitScale);
          }
          updateSavedWordsDisplay();
          updateTextDisplay();
          updateActionButtons();
          setupEventListeners();
          
          // ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ Î°úÎìú
          const _tc = parseInt(localStorage.getItem('totalCompleted')) || 0;
          _prevMainLevel = Math.floor(_tc / 10) + 1;
          updateUserLevel();

          checkURLParams();
          loadChallengeData();

          // ÏµúÍ≥†Í∏∞Î°ù ÌëúÏãú
          const _hb = parseInt(localStorage.getItem('hangulHeroBest')) || 0;
          if (_hb > 0) {
              const bd = document.getElementById('hero-best-display');
              if (bd) { bd.style.display = 'block'; document.getElementById('hero-best-val').textContent = _hb; }
          }
      });

      // ===== Î≥µÌï©Î™®Ïùå Ï°∞Ìï©Ìëú =====
      let chartBuilt = false;

      // ÏôºÏ™Ω Ìå®ÎÑê ÏûêÏùå ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏÉùÏÑ±
      function buildChartNav() {
          const consonants = ['„Ñ±','„Ñ¥','„Ñ∑','„Ñπ','„ÖÅ','„ÖÇ','„ÖÖ','„Öá','„Öà','„Öä','„Öã','„Öå','„Öç','„Öé'];
          const grid = document.getElementById('chart-nav-grid');
          let html = '';
          consonants.forEach((c, i) => {
              html += `<div class="chart-nav-btn${i===0?' active':''}" onclick="selectChartFromNav('${c}', this)">${c}</div>`;
          });
          grid.innerHTML = html;
      }

      // ÏôºÏ™Ω ÎÑ§ÎπÑÍ≤åÏù¥ÏÖòÏóêÏÑú ÏûêÏùå ÏÑ†ÌÉù ‚Üí Í∞ÄÏö¥Îç∞ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
      function selectChartFromNav(consonant, btn) {
          document.querySelectorAll('.chart-nav-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // Í∞ÄÏö¥Îç∞ Ï∞®Ìä∏Ïùò ÏûêÏùå Î≤ÑÌäºÎèÑ ÎèôÍ∏∞Ìôî
          const chartBtn = document.querySelector(`.chart-consonant-btn[onclick*="'${consonant}'"]`);
          if (chartBtn) selectChartConsonant(consonant, chartBtn);
      }

      function buildCombinationChart() {
          if (chartBuilt) return;
          chartBuilt = true;

          const wrapper = document.getElementById('chart-grid-wrapper');
          const consonants = ['„Ñ±','„Ñ¥','„Ñ∑','„Ñπ','„ÖÅ','„ÖÇ','„ÖÖ','„Öá','„Öà','„Öä','„Öã','„Öå','„Öç','„Öé'];
          const complexVowels = ['„Öê','„Öî','„Öò','„Öô','„Öö','„Öù','„Öû','„Öü','„Ö¢','„Öí','„Öñ'];
          const vowelDecomposeMap = {
              '„Öò':'„Öó+„Öè','„Öô':'„Öó+„Öê','„Öö':'„Öó+„Ö£',
              '„Öù':'„Öú+„Öì','„Öû':'„Öú+„Öî','„Öü':'„Öú+„Ö£',
              '„Ö¢':'„Ö°+„Ö£','„Öí':'„Öë+„Ö£','„Öñ':'„Öï+„Ö£'
          };

          // ÏûêÏùå ÏÑ†ÌÉù Î∞î
          let html = '<div class="chart-consonant-bar">';
          consonants.forEach((c, i) => {
              html += `<div class="chart-consonant-btn${i===0?' active':''}" onclick="selectChartConsonant('${c}', this)">${c}</div>`;
          });
          html += '</div>';

          // ÏÑ†ÌÉù ÌëúÏãú + Ïπ¥Îìú Í∑∏Î¶¨Îìú ÏòÅÏó≠
          html += '<div id="chart-selected-label" class="chart-selected-label"><span>„Ñ±</span> + Î≥µÌï©Î™®Ïùå Ï°∞Ìï©</div>';
          html += '<div id="chart-card-area" class="chart-card-grid">';
          // Ï¥àÍ∏∞: „Ñ±
          complexVowels.forEach(v => {
              const char = composeCharacter('„Ñ±', v, '');
              const desc = vowelDecomposeMap[v] || v;
              html += `<div class="chart-card" onclick="playChartCell(this, '${char}')">
                  <div class="chart-card-char">${char}</div>
                  <div class="chart-card-desc">„Ñ± + ${desc}</div>
              </div>`;
          });
          html += '</div>';

          // Íµ¨Î∂ÑÏÑ†
          html += '<div class="chart-section-divider"></div>';

          // Î™®Ïùå Ï°∞Ìï©Ìëú
          const vowelCombos = [
              { a: '„Öó', b: '„Öè', result: '„Öò' },
              { a: '„Öó', b: '„Öê', result: '„Öô' },
              { a: '„Öó', b: '„Ö£', result: '„Öö' },
              { a: '„Öú', b: '„Öì', result: '„Öù' },
              { a: '„Öú', b: '„Öî', result: '„Öû' },
              { a: '„Öú', b: '„Ö£', result: '„Öü' },
              { a: '„Ö°', b: '„Ö£', result: '„Ö¢' },
              { a: '„Öë', b: '„Ö£', result: '„Öí' },
              { a: '„Öï', b: '„Ö£', result: '„Öñ' },
          ];

          html += '<div class="chart-section-title">üåà Î™®Ïùå + Î™®Ïùå = Î≥µÌï©Î™®Ïùå</div>';
          html += '<div class="vowel-combo-grid">';
          vowelCombos.forEach(c => {
              html += `<div class="vowel-combo-card" onclick="playVowelCombo('${c.a}','${c.b}','${c.result}')">
                  <span class="vc-part">${c.a}</span>
                  <span class="vc-plus">+</span>
                  <span class="vc-part">${c.b}</span>
                  <span class="vc-eq">=</span>
                  <span class="vc-result">${c.result}</span>
              </div>`;
          });
          html += '</div>';

          wrapper.innerHTML = html;
      }

      // ÏûêÏùå ÏÑ†ÌÉù ‚Üí Ïπ¥Îìú Í∞±Ïã†
      function selectChartConsonant(consonant, btn) {
          // Î≤ÑÌäº ÌôúÏÑ±Ìôî
          document.querySelectorAll('.chart-consonant-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          const complexVowels = ['„Öê','„Öî','„Öò','„Öô','„Öö','„Öù','„Öû','„Öü','„Ö¢','„Öí','„Öñ'];
          const vowelDecomposeMap = {
              '„Öò':'„Öó+„Öè','„Öô':'„Öó+„Öê','„Öö':'„Öó+„Ö£',
              '„Öù':'„Öú+„Öì','„Öû':'„Öú+„Öî','„Öü':'„Öú+„Ö£',
              '„Ö¢':'„Ö°+„Ö£','„Öí':'„Öë+„Ö£','„Öñ':'„Öï+„Ö£'
          };
          
          // ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
          document.getElementById('chart-selected-label').innerHTML = `<span>${consonant}</span> + Î≥µÌï©Î™®Ïùå Ï°∞Ìï©`;
          
          // Ïπ¥Îìú Í∞±Ïã†
          const area = document.getElementById('chart-card-area');
          let html = '';
          complexVowels.forEach(v => {
              const char = composeCharacter(consonant, v, '');
              const desc = vowelDecomposeMap[v] || v;
              html += `<div class="chart-card" onclick="playChartCell(this, '${char}')">
                  <div class="chart-card-char">${char}</div>
                  <div class="chart-card-desc">${consonant} + ${desc}</div>
              </div>`;
          });
          area.innerHTML = html;
      }

      // Î™®Ïùå Ï°∞Ìï© Ïπ¥Îìú ÌÅ¥Î¶≠ ‚Üí Ïï†ÎãàÎ©îÏù¥ÏÖò
      function playVowelCombo(a, b, result) {
          const pronunciationMap = {
              '„Öò':'ÏôÄ','„Öô':'Ïôú','„Öö':'Ïô∏','„Öù':'Ïõå','„Öû':'Ïõ®',
              '„Öü':'ÏúÑ','„Ö¢':'Ïùò','„Öí':'Ïñò','„Öñ':'Ïòà'
          };
          const pron = pronunciationMap[result] || result;
          
          const overlay = document.createElement('div');
          overlay.className = 'combo-overlay';
          overlay.innerHTML = `
              <div class="combo-box">
                  <div class="combo-parts">
                      <div class="combo-char" style="color:#f59e0b">${a}</div>
                      <div class="combo-plus">+</div>
                      <div class="combo-char" style="color:#f59e0b">${b}</div>
                  </div>
                  <div class="combo-arrow">‚¨áÔ∏è</div>
                  <div class="combo-result" style="color:#1e293b">${result}</div>
                  <div class="combo-btn-row">
                      <div class="combo-speak-btn" onclick="addToAudioQueue('${pron}')">üîä Îã§Ïãú Îì£Í∏∞</div>
                      <div class="combo-close-btn" onclick="this.closest('.combo-overlay').remove()">‚úï Îã´Í∏∞</div>
                  </div>
              </div>
          `;
          document.body.appendChild(overlay);
          
          setTimeout(() => { if (soundEnabled) addToAudioQueue(pron); }, 900);
      }

      function playChartCell(cell, char) {
          document.querySelectorAll('.chart-card.speaking').forEach(el => el.classList.remove('speaking'));
          cell.classList.add('speaking');
          
          const code = char.charCodeAt(0) - 0xAC00;
          const choIdx = Math.floor(code / 588);
          const jungIdx = Math.floor((code % 588) / 28);
          const choList = ['„Ñ±','„Ñ≤','„Ñ¥','„Ñ∑','„Ñ∏','„Ñπ','„ÖÅ','„ÖÇ','„ÖÉ','„ÖÖ','„ÖÜ','„Öá','„Öà','„Öâ','„Öä','„Öã','„Öå','„Öç','„Öé'];
          const jungList = ['„Öè','„Öê','„Öë','„Öí','„Öì','„Öî','„Öï','„Öñ','„Öó','„Öò','„Öô','„Öö','„Öõ','„Öú','„Öù','„Öû','„Öü','„Ö†','„Ö°','„Ö¢','„Ö£'];
          const cho = choList[choIdx] || '';
          const jung = jungList[jungIdx] || '';
          
          const vowelDecompose = {
              '„Öò':['„Öó','„Öè'],'„Öô':['„Öó','„Öê'],'„Öö':['„Öó','„Ö£'],
              '„Öù':['„Öú','„Öì'],'„Öû':['„Öú','„Öî'],'„Öü':['„Öú','„Ö£'],
              '„Ö¢':['„Ö°','„Ö£'],'„Öí':['„Öë','„Ö£'],'„Öñ':['„Öï','„Ö£']
          };
          
          const vParts = vowelDecompose[jung];
          let partsHtml;
          if (vParts) {
              partsHtml = `
                  <div class="combo-char">${cho}</div>
                  <div class="combo-plus">+</div>
                  <div class="combo-char" style="color:#f59e0b">${vParts[0]}</div>
                  <div class="combo-plus">+</div>
                  <div class="combo-char" style="color:#f59e0b">${vParts[1]}</div>`;
          } else {
              partsHtml = `
                  <div class="combo-char">${cho}</div>
                  <div class="combo-plus">+</div>
                  <div class="combo-char" style="color:#f59e0b">${jung}</div>`;
          }
          
          const overlay = document.createElement('div');
          overlay.className = 'combo-overlay';
          overlay.innerHTML = `
              <div class="combo-box">
                  <div class="combo-parts">${partsHtml}</div>
                  <div class="combo-arrow">‚¨áÔ∏è</div>
                  <div class="combo-result">${char}</div>
                  <div class="combo-btn-row">
                      <div class="combo-speak-btn" onclick="addToAudioQueue('${char}')">üîä Îã§Ïãú Îì£Í∏∞</div>
                      <div class="combo-close-btn" onclick="this.closest('.combo-overlay').remove()">‚úï Îã´Í∏∞</div>
                  </div>
              </div>
          `;
          document.body.appendChild(overlay);
          
          setTimeout(() => {
              if (soundEnabled) addToAudioQueue(char);
          }, 900);
          
          setTimeout(() => cell.classList.remove('speaking'), 800);
      }

      // ===== Îî∞ÎùºÏì∞Í∏∞ =====
      const traceLetters = {
          consonant: ['„Ñ±','„Ñ¥','„Ñ∑','„Ñπ','„ÖÅ','„ÖÇ','„ÖÖ','„Öá','„Öà','„Öä','„Öã','„Öå','„Öç','„Öé'],
          vowel: ['„Öè','„Öë','„Öì','„Öï','„Öó','„Öõ','„Öú','„Ö†','„Ö°','„Ö£','„Öê','„Öî'],
          syllable: ['Í∞Ä','ÎÇò','Îã§','Îùº','Îßà','Î∞î','ÏÇ¨','ÏïÑ','Ïûê','Ï∞®','Ïπ¥','ÌÉÄ','Ìåå','Ìïò']
      };
      let traceCategory = 'consonant';
      let traceIndex = 0;
      let traceCanvas = null;
      let traceCtx = null;
      let traceDrawing = false;
      let traceInited = false;

      function initTrace() {
          buildTraceLetterGrid();
          setupTraceCanvas();
      }

      function buildTraceLetterGrid() {
          const grid = document.getElementById('trace-letter-grid');
          const letters = traceLetters[traceCategory];
          let html = '';
          letters.forEach((ch, i) => {
              html += `<div class="trace-letter-btn${i===traceIndex?' active':''}" onclick="selectTraceLetter(${i})">${ch}</div>`;
          });
          grid.innerHTML = html;
      }

      function setTraceCategory(cat) {
          traceCategory = cat;
          traceIndex = 0;
          document.querySelectorAll('.trace-cat-btn').forEach(b => b.classList.remove('active'));
          event.target.classList.add('active');
          buildTraceLetterGrid();
          drawTraceGhost();
      }

      function selectTraceLetter(idx) {
          traceIndex = idx;
          document.querySelectorAll('.trace-letter-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.trace-letter-btn')[idx]?.classList.add('active');
          drawTraceGhost();
      }

      function traceNav(dir) {
          const letters = traceLetters[traceCategory];
          traceIndex = (traceIndex + dir + letters.length) % letters.length;
          buildTraceLetterGrid();
          drawTraceGhost();
      }

      function tracePlaySound() {
          const ch = traceLetters[traceCategory][traceIndex];
          addToAudioQueue(ch);
      }

      function traceClear() {
          drawTraceGhost();
      }

      function setupTraceCanvas() {
          traceCanvas = document.getElementById('trace-canvas');
          traceCtx = traceCanvas.getContext('2d');
          
          const wrapper = traceCanvas.parentElement;
          // 1920x1080 Í≥†Ï†ï Î†àÏù¥ÏïÑÏõÉ ÎÇ¥ Ïã§Ï†ú ÌÅ¨Í∏∞
          const w = wrapper.clientWidth || 1100;
          const h = wrapper.clientHeight || 700;
          traceCanvas.width = w;
          traceCanvas.height = h;
          
          // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏
          if (!traceInited) {
              traceInited = true;
              traceCanvas.addEventListener('pointerdown', traceStart);
              traceCanvas.addEventListener('pointermove', traceDraw);
              traceCanvas.addEventListener('pointerup', traceEnd);
              traceCanvas.addEventListener('pointercancel', traceEnd);
              traceCanvas.addEventListener('pointerleave', traceEnd);
          }
          
          drawTraceGhost();
      }

      function getTracePos(e) {
          const rect = traceCanvas.getBoundingClientRect();
          const scaleX = traceCanvas.width / rect.width;
          const scaleY = traceCanvas.height / rect.height;
          return {
              x: (e.clientX - rect.left) * scaleX,
              y: (e.clientY - rect.top) * scaleY
          };
      }

      function drawTraceGhost() {
          if (!traceCtx) return;
          const w = traceCanvas.width;
          const h = traceCanvas.height;
          const ch = traceLetters[traceCategory][traceIndex];
          
          traceCtx.clearRect(0, 0, w, h);
          
          // Î∞∞Í≤Ω Í∞ÄÏù¥Îìú ÎùºÏù∏
          traceCtx.strokeStyle = '#f1f5f9';
          traceCtx.lineWidth = 2;
          traceCtx.setLineDash([10, 10]);
          traceCtx.beginPath();
          traceCtx.moveTo(w/2, 0); traceCtx.lineTo(w/2, h);
          traceCtx.moveTo(0, h/2); traceCtx.lineTo(w, h/2);
          traceCtx.stroke();
          traceCtx.setLineDash([]);
          
          // Ïó∞Ìïú Í∏ÄÏûê (Í≥†Ïä§Ìä∏)
          const fontSize = Math.min(w, h) * 0.7;
          traceCtx.font = `900 ${fontSize}px sans-serif`;
          traceCtx.textAlign = 'center';
          traceCtx.textBaseline = 'middle';
          traceCtx.fillStyle = '#e2e8f0';
          traceCtx.fillText(ch, w/2, h/2);
          
          // ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
          const label = document.getElementById('trace-current-label');
          if (label) label.textContent = ch;
      }

      function traceStart(e) {
          e.preventDefault();
          traceDrawing = true;
          const pos = getTracePos(e);
          traceCtx.beginPath();
          traceCtx.moveTo(pos.x, pos.y);
          traceCtx.strokeStyle = '#3b82f6';
          traceCtx.lineWidth = Math.min(traceCanvas.width, traceCanvas.height) * 0.04;
          traceCtx.lineCap = 'round';
          traceCtx.lineJoin = 'round';
      }

      function traceDraw(e) {
          if (!traceDrawing) return;
          e.preventDefault();
          const pos = getTracePos(e);
          traceCtx.lineTo(pos.x, pos.y);
          traceCtx.stroke();
          traceCtx.beginPath();
          traceCtx.moveTo(pos.x, pos.y);
      }

      function traceEnd(e) {
          traceDrawing = false;
      }

      function traceEvaluate() {
          if (!traceCtx || !traceCanvas) return;
          
          const w = traceCanvas.width;
          const h = traceCanvas.height;
          const ch = traceLetters[traceCategory][traceIndex];
          
          // 1) ÏÇ¨Ïö©ÏûêÍ∞Ä Í∑∏Î¶∞ ÌîΩÏÖÄ Ï∂îÏ∂ú
          const userPixels = traceCtx.getImageData(0, 0, w, h).data;
          
          // 2) ÌóàÏö© Î≤îÏúÑ ÎßàÏä§ÌÅ¨ (Í∏ÄÏûêÎ•º ÎÑâÎÑâÌïòÍ≤å ÎëêÍªçÍ≤å)
          const offCanvas = document.createElement('canvas');
          offCanvas.width = w;
          offCanvas.height = h;
          const offCtx = offCanvas.getContext('2d');
          
          const fontSize = Math.min(w, h) * 0.7;
          offCtx.font = `900 ${fontSize}px sans-serif`;
          offCtx.textAlign = 'center';
          offCtx.textBaseline = 'middle';
          
          // ÎÑâÎÑâÌïú ÌóàÏö© ÏòÅÏó≠ (stroke ÎëêÍªçÍ≤å)
          offCtx.lineWidth = fontSize * 0.18;
          offCtx.strokeStyle = '#000';
          offCtx.strokeText(ch, w/2, h/2);
          offCtx.fillStyle = '#000';
          offCtx.fillText(ch, w/2, h/2);
          
          const maskPixels = offCtx.getImageData(0, 0, w, h).data;
          
          // 3) ÏÇ¨Ïö©Ïûê ÌîΩÏÖÄ vs ÎßàÏä§ÌÅ¨ ÎπÑÍµê ‚Üí Ï†ïÌôïÎèÑ(Ïïà ÏÇêÏ†∏ÎÇòÍ∞îÎäîÏßÄ)
          let userTotal = 0;
          let userInside = 0;
          
          const step = 3;
          for (let y = 0; y < h; y += step) {
              for (let x = 0; x < w; x += step) {
                  const i = (y * w + x) * 4;
                  const uR = userPixels[i], uG = userPixels[i+1], uB = userPixels[i+2], uA = userPixels[i+3];
                  // ÌååÎûÄÏÉâ ÏÇ¨Ïö©Ïûê ÏÑ† Í∞êÏßÄ (Í≥†Ïä§Ìä∏ ÌöåÏÉâ/Í∞ÄÏù¥Îìú ÎùºÏù∏ Ï†úÏô∏)
                  const isUserStroke = uA > 80 && uB > 130 && uR < 180 && !(uR > 200 && uG > 200 && uB > 200);
                  
                  if (isUserStroke) {
                      userTotal++;
                      if (maskPixels[i + 3] > 30) {
                          userInside++;
                      }
                  }
              }
          }
          
          if (userTotal < 15) {
              alert('Î®ºÏ†Ä Í∏ÄÏûêÎ•º Îî∞Îùº Ïç®Ï£ºÏÑ∏Ïöî!');
              return;
          }
          
          // 4) Í≤ΩÎ°ú Ïª§Î≤ÑÎ¶¨ÏßÄ ‚Üí Í∏ÄÏûê Ï†ÑÏ≤¥Î•º Îî∞ÎùºÍ∞îÎäîÏßÄ (Íµ¨Ïó≠ Í∏∞Î∞ò)
          const GRID = 10; // 10x10 Íµ¨Ïó≠
          const cellW = w / GRID;
          const cellH = h / GRID;
          let ghostZones = 0;
          let coveredZones = 0;
          
          for (let gy = 0; gy < GRID; gy++) {
              for (let gx = 0; gx < GRID; gx++) {
                  let hasGhost = false;
                  let hasUser = false;
                  
                  // Íµ¨Ïó≠ ÎÇ¥ ÏÉòÌîåÎßÅ
                  for (let sy = 0; sy < cellH; sy += 6) {
                      for (let sx = 0; sx < cellW; sx += 6) {
                          const px = Math.floor(gx * cellW + sx);
                          const py = Math.floor(gy * cellH + sy);
                          if (px >= w || py >= h) continue;
                          const i = (py * w + px) * 4;
                          
                          if (maskPixels[i + 3] > 30) hasGhost = true;
                          
                          const uR = userPixels[i], uG = userPixels[i+1], uB = userPixels[i+2], uA = userPixels[i+3];
                          if (uA > 80 && uB > 130 && uR < 180 && !(uR > 200 && uG > 200 && uB > 200)) {
                              hasUser = true;
                          }
                      }
                  }
                  
                  if (hasGhost) {
                      ghostZones++;
                      if (hasUser) coveredZones++;
                  }
              }
          }
          
          // 5) Ï†êÏàò Í≥ÑÏÇ∞ (ÏïÑÏù¥ ÎåÄÏÉÅ ‚Äî ÏµúÎåÄÌïú Ïπ≠Ï∞¨)
          const precision = userTotal > 0 ? userInside / userTotal : 0;
          const pathCoverage = ghostZones > 0 ? coveredZones / ghostZones : 0;
          
          const rawScore = precision * 0.4 + pathCoverage * 0.6;
          
          let score;
          if (rawScore < 0.15) {
              // ÏßÑÏßú ÎßêÎèÑ Ïïà ÎêòÎäî Í≤ΩÏö∞Îßå ÎÇÆÍ≤å
              score = Math.round(40 + Math.random() * 20); // 40~60
          } else {
              // Ï°∞Í∏àÏù¥ÎùºÎèÑ Îî∞ÎùºÏì∞Î©¥ 85~98, Í∞ÄÎÅî 100
              const base = 85 + Math.round(rawScore * 13); // 85~98
              const lucky = Math.random() < 0.2; // 20% ÌôïÎ•†Î°ú 100Ï†ê
              score = lucky ? 100 : Math.min(99, base);
          }
          
          // 6) Î≥Ñ + Î©îÏãúÏßÄ
          let stars, msg;
          if (score === 100) {
              stars = 'üåü‚≠êüåü';
              msg = '100Ï†ê! Ï≤úÏû¨ÏòàÏöî!! üéä';
          } else if (score >= 85) {
              stars = '‚≠ê‚≠ê‚≠ê';
              const msgs = ['ÏôÑÎ≤ΩÌï¥Ïöî! üëè','Ï≤úÏû¨! ÏµúÍ≥†ÏòàÏöî! üéâ','ÎÑàÎ¨¥ ÏûòÌñàÏñ¥Ïöî! ü•≥','Î©ãÏ†∏Ïöî! ÎåÄÎã®Ìï¥Ïöî! ‚ú®'];
              msg = msgs[Math.floor(Math.random() * msgs.length)];
          } else if (score >= 60) {
              stars = '‚≠ê‚≠ê';
              msg = 'ÏûòÌñàÏñ¥Ïöî! ÌïúÎ≤à Îçî Ìï¥Î≥ºÍπåÏöî? üòä';
          } else {
              stars = '‚≠ê';
              msg = 'Í¥úÏ∞ÆÏïÑÏöî! Îã§Ïãú Ìï¥Î≥¥Ïûê! üí™';
          }
          
          if (score >= 60) {
              const praises = ['ÏûòÌñàÏñ¥Ïöî','Î©ãÏ†∏Ïöî','ÏµúÍ≥†ÏòàÏöî','ÎåÄÎã®Ìï¥Ïöî'];
              addToAudioQueue(praises[Math.floor(Math.random() * praises.length)]);
          } else {
              addToAudioQueue('Îã§Ïãú Ìï¥Î≥ºÍπåÏöî');
          }
          
          // 7) Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥
          const wrapper = document.querySelector('.trace-canvas-area');
          const existing = wrapper.querySelector('.trace-result-overlay');
          if (existing) existing.remove();
          
          const overlay = document.createElement('div');
          overlay.className = 'trace-result-overlay';
          overlay.innerHTML = `
              <div class="trace-result-stars">${stars}</div>
              <div class="trace-result-score">${score}Ï†ê</div>
              <div class="trace-result-msg">${msg}</div>
              <div class="trace-result-detail" style="font-size:14px;color:#94a3b8;margin-bottom:14px;">
                  Ï†ïÌôïÎèÑ ${Math.round(precision*100)}% ¬∑ Í≤ΩÎ°ú ${Math.round(pathCoverage*100)}%
              </div>
              <div class="trace-result-btns">
                  <button class="trace-retry-btn" onclick="traceResultClose(false)">üîÑ Îã§Ïãú Ïì∞Í∏∞</button>
                  <button class="trace-next-btn" onclick="traceResultClose(true)">‚û°Ô∏è Îã§Ïùå Í∏ÄÏûê</button>
              </div>
          `;
          wrapper.appendChild(overlay);
      }

      function traceResultClose(goNext) {
          const overlay = document.querySelector('.trace-result-overlay');
          if (overlay) overlay.remove();
          if (goNext) {
              traceNav(1);
          } else {
              traceClear();
          }
      }

      // ===== Í∏ÄÏûê ÌûàÏñ¥Î°ú Í≤åÏûÑ =====
      let gameState = {
          running: false,
          paused: false,
          score: 0,
          lives: 3,
          level: 1,
          speed: 1,
          type: 'simple',
          fallingChars: [],
          animationId: null,
          spawnTimer: null,
          gameChar: { choseong: '', jungseong: '', jongseong: '' },
          combo: 0,
          maxCombo: 0,
          bestScore: parseInt(localStorage.getItem('hangulHeroBest')) || 0
      };

      const SIMPLE_CHARS = ['Í∞Ä','ÎÇò','Îã§','Îùº','Îßà','Î∞î','ÏÇ¨','ÏïÑ','Ïûê','Ï∞®','Ïπ¥','ÌÉÄ','Ìåå','Ìïò',
                             'Í≥†','ÎÖ∏','ÎèÑ','Î°ú','Î™®','Î≥¥','ÏÜå','Ïò§','Ï°∞','ÏΩî','ÌÜ†','Ìè¨','Ìò∏',
                             'Íµ¨','ÎàÑ','Îëê','Î£®','Î¨¥','Î∂Ä','Ïàò','Ïö∞','Ï£º','Ïø†','Ìà¨','Ìë∏','ÌõÑ'];
      const MEDIUM_CHARS = ['Í∞ú','ÎÑ§','ÎåÄ','Î†à','Îß§','Î∞∞','ÏÑ∏','Ïï†','Ïû¨','Ï±Ñ','Ï∫ê','ÌÉú','Ìå®','Ìï¥',
                             'Í≥º','ÎÜî','Îè†','Î¥ê','Ï¢å','Ìôî','Í∂à','Îà†','Îë¨','Î≠ê','Ï§ò','Ìõ†',
                             'Í∑Ä','Îâò','Îí§','Î∑î','Ï•ê','Ï∑®','Í∑Ä','Ìù¨'];
      const HARD_WORDS = ['ÏÇ¨Í≥º','Î∞îÎÇòÎÇò','Ìè¨ÎèÑ','ÏàòÎ∞ï','Îî∏Í∏∞','ÌÜ†ÎßàÌÜ†','Í≥†Íµ¨Îßà','Í∞êÏûê',
                           'ÏóÑÎßà','ÏïÑÎπ†','Ìï†Î®∏Îãà','Ìï†ÏïÑÎ≤ÑÏßÄ','Ïò§Îπ†','ÎàÑÎÇò','ÎèôÏÉù',
                           'Í∞ïÏïÑÏßÄ','Í≥†ÏñëÏù¥','ÌÜ†ÎÅº','Í±∞Î∂ÅÏù¥','Î¨ºÍ≥†Í∏∞','ÎÇòÎπÑ','Í∞úÍµ¨Î¶¨'];

      function getGameChars() {
          switch(gameState.type) {
              case 'simple': return SIMPLE_CHARS;
              case 'medium': return MEDIUM_CHARS;
              case 'hard': return HARD_WORDS;
              default: return SIMPLE_CHARS;
          }
      }

      function startFallingGame() {
          try{document.documentElement.requestFullscreen?.()}catch(e){}
          const game = document.getElementById('falling-game');
          game.classList.remove('hidden');

          gameState.score = 0;
          gameState.lives = 5;
          gameState.level = 1;
          gameState.running = false;
          gameState.paused = false;
          gameState.fallingChars = [];
          gameState.gameChar = { choseong: '', jungseong: '', jongseong: '' };
          gameState.combo = 0;
          gameState.maxCombo = 0;

          updateGameUI();
          updateGameBackground();
          addClouds();

          // 3-2-1 Ïπ¥Ïö¥Ìä∏Îã§Ïö¥
          const arena = document.getElementById('game-arena');
          const cd = document.createElement('div');
          cd.className = 'hero-countdown';
          cd.innerHTML = '<div class="hero-cd-num">3</div>';
          arena.appendChild(cd);
          SFX.pop();

          let count = 3;
          const cdTimer = setInterval(() => {
              count--;
              if (count > 0) {
                  cd.innerHTML = `<div class="hero-cd-num">${count}</div>`;
                  SFX.pop();
              } else {
                  clearInterval(cdTimer);
                  cd.innerHTML = '<div class="hero-cd-num" style="font-size:60px;color:#fbbf24">ÏãúÏûë!</div>';
                  SFX.gameStart();
                  setTimeout(() => {
                      cd.remove();
                      gameState.running = true;
                      startGameLoop();
                  }, 500);
              }
          }, 800);
      }

      function addClouds() { addHgDecorations(); }
      function addHgDecorations() {
          const arena = document.getElementById('game-arena');
          arena.querySelectorAll('.game-cloud,.hg-cloud,.hg-deco,.hg-bg-sparkle').forEach(c => c.remove());
          // SVG Íµ¨Î¶Ñ 5Í∞ú
          for (let i = 0; i < 5; i++) {
              const c = document.createElement('div');
              c.className = 'hg-cloud';
              c.innerHTML = '<svg width="80" height="48" viewBox="0 0 80 48"><ellipse cx="40" cy="30" rx="36" ry="16" fill="#fff" opacity=".7"/><ellipse cx="28" cy="22" rx="20" ry="14" fill="#fff" opacity=".8"/><ellipse cx="52" cy="20" rx="22" ry="15" fill="#fff" opacity=".75"/><ellipse cx="40" cy="18" rx="18" ry="12" fill="#fff" opacity=".85"/></svg>';
              c.style.top = (Math.random() * 35) + '%';
              c.style.animationDelay = -(Math.random() * 20) + 's';
              arena.appendChild(c);
          }
          // ÌïúÍ∏Ä ÌÖåÎßà SVG Ïû•Ïãù 10Í∞ú
          const hangulSVGs = [
              '<svg width="50" height="50" viewBox="0 0 50 50"><text x="25" y="37" text-anchor="middle" font-size="38" font-weight="900" fill="#8b5cf6">„Ñ±</text></svg>',
              '<svg width="50" height="50" viewBox="0 0 50 50"><text x="25" y="37" text-anchor="middle" font-size="38" font-weight="900" fill="#a855f7">„Öé</text></svg>',
              '<svg width="50" height="50" viewBox="0 0 50 50"><text x="25" y="37" text-anchor="middle" font-size="38" font-weight="900" fill="#7c3aed">„ÖÅ</text></svg>',
              '<svg width="50" height="50" viewBox="0 0 50 50"><text x="25" y="37" text-anchor="middle" font-size="36" font-weight="900" fill="#6d28d9">Í∞Ä</text></svg>',
              '<svg width="50" height="50" viewBox="0 0 50 50"><text x="25" y="37" text-anchor="middle" font-size="36" font-weight="900" fill="#c084fc">ÎÇò</text></svg>',
              '<svg width="55" height="55" viewBox="0 0 55 55"><rect x="4" y="4" width="47" height="47" rx="10" fill="none" stroke="#8b5cf6" stroke-width="2.5"/><line x1="4" y1="20" x2="51" y2="20" stroke="#8b5cf6" stroke-width="1.5"/><line x1="4" y1="36" x2="51" y2="36" stroke="#8b5cf6" stroke-width="1.5"/><line x1="20" y1="4" x2="20" y2="51" stroke="#8b5cf6" stroke-width="1.5"/><line x1="36" y1="4" x2="36" y2="51" stroke="#8b5cf6" stroke-width="1.5"/></svg>',
              '<svg width="50" height="55" viewBox="0 0 50 55"><rect x="5" y="2" width="40" height="51" rx="4" fill="none" stroke="#a855f7" stroke-width="2.5"/><line x1="12" y1="14" x2="38" y2="14" stroke="#a855f7" stroke-width="2"/><line x1="12" y1="24" x2="38" y2="24" stroke="#a855f7" stroke-width="2"/><line x1="12" y1="34" x2="30" y2="34" stroke="#a855f7" stroke-width="2"/></svg>',
              '<svg width="50" height="55" viewBox="0 0 50 55"><polygon points="25,3 6,53 44,53" fill="none" stroke="#7c3aed" stroke-width="2.5" stroke-linejoin="round"/><line x1="15" y1="35" x2="35" y2="35" stroke="#7c3aed" stroke-width="2"/></svg>',
              '<svg width="55" height="55" viewBox="0 0 55 55"><circle cx="27" cy="27" r="24" fill="none" stroke="#6d28d9" stroke-width="2.5"/><text x="27" y="34" text-anchor="middle" font-size="22" font-weight="900" fill="#6d28d9">„Öè</text></svg>',
              '<svg width="60" height="50" viewBox="0 0 60 50"><polygon points="30,2 38,18 56,20 42,33 46,50 30,42 14,50 18,33 4,20 22,18" fill="none" stroke="#c084fc" stroke-width="2.5"/></svg>'
          ];
          for (let i = 0; i < 10; i++) {
              const d = document.createElement('div');
              d.className = 'hg-deco';
              d.innerHTML = hangulSVGs[i];
              d.style.left = (i * 180 + Math.random() * 100) + 'px';
              d.style.top = (80 + Math.random() * 500) + 'px';
              d.style.setProperty('--dur', (5 + Math.random() * 4) + 's');
              d.style.animationDelay = -(i * 0.6) + 's';
              arena.appendChild(d);
          }
          // Î≥¥Îùº Î∞òÏßùÏù¥ 12Í∞ú
          const sparkColors = ['#8b5cf6','#a855f7','#c084fc','#7c3aed','#6d28d9','#ddd6fe'];
          for (let i = 0; i < 12; i++) {
              const s = document.createElement('div');
              s.className = 'hg-bg-sparkle';
              const sz = 4 + Math.random() * 6;
              s.style.cssText = 'width:'+sz+'px;height:'+sz+'px;border-radius:50%;background:'+sparkColors[i%sparkColors.length]+';left:'+(Math.random()*95)+'%;top:'+(Math.random()*80)+'%';
              s.style.setProperty('--dur', (2 + Math.random() * 2) + 's');
              s.style.animationDelay = -(Math.random() * 3) + 's';
              arena.appendChild(s);
          }
      }

      function startGameLoop() {
          const spawnInterval = [4500, 3000, 2000][gameState.speed - 1];
          
          if (gameState.spawnTimer) clearInterval(gameState.spawnTimer);
          gameState.spawnTimer = setInterval(() => {
              if (!gameState.paused && gameState.running) spawnChar();
          }, spawnInterval);
          
          function tick() {
              if (!gameState.running) return;
              if (!gameState.paused) {
                  moveChars();
              }
              gameState.animationId = requestAnimationFrame(tick);
          }
          gameState.animationId = requestAnimationFrame(tick);
      }

      function spawnChar() {
          // 5% ÌôïÎ•†Î°ú ÌååÏõåÏóÖ ÏÉùÏÑ±
          if (Math.random() < 0.05) {
              spawnPowerUp();
              return;
          }

          const chars = getGameChars();
          const char = chars[Math.floor(Math.random() * chars.length)];
          const arena = document.getElementById('game-arena');
          const arenaWidth = arena.offsetWidth;

          // Í∏ÄÏûê Î∂ÑÌï¥
          const code = char.charCodeAt(0) - 0xAC00;
          const choList = ['„Ñ±','„Ñ≤','„Ñ¥','„Ñ∑','„Ñ∏','„Ñπ','„ÖÅ','„ÖÇ','„ÖÉ','„ÖÖ','„ÖÜ','„Öá','„Öà','„Öâ','„Öä','„Öã','„Öå','„Öç','„Öé'];
          const jungList = ['„Öè','„Öê','„Öë','„Öí','„Öì','„Öî','„Öï','„Öñ','„Öó','„Öò','„Öô','„Öö','„Öõ','„Öú','„Öù','„Öû','„Öü','„Ö†','„Ö°','„Ö¢','„Ö£'];
          const cho = choList[Math.floor(code / 588)] || '';
          const jung = jungList[Math.floor((code % 588) / 28)] || '';

          // ÎûúÎç§ ÌÅ¨Í∏∞ (0.7 ~ 1.3) ‚Äî ÏûëÏùÄ Í∏ÄÏûêÎäî Î≥¥ÎÑàÏä§
          const sizeScale = 0.7 + Math.random() * 0.6;
          const isSmall = sizeScale < 0.85;

          const el = document.createElement('div');
          el.className = 'falling-char';
          el.innerHTML = `<div class="char-bubble" style="position:relative;">${char}<span class="cho-indicator">${cho}‚úì</span>${isSmall ? '<span style="position:absolute;top:-8px;left:-8px;font-size:14px;">‚≠ê</span>' : ''}</div>`;
          el.style.left = (Math.random() * (arenaWidth - 100) + 20) + 'px';
          el.style.top = '-80px';
          el.style.transform = `scale(${sizeScale})`;
          el.dataset.char = char;
          el.dataset.cho = cho;
          el.dataset.jung = jung;

          if (isSmall) {
              el.querySelector('.char-bubble').style.borderColor = '#fbbf24';
          }

          arena.appendChild(el);

          const fallSpeed = [0.2, 0.4, 0.7][gameState.speed - 1];
          const swayAmount = (Math.random() - 0.5) * 2;
          const startX = Math.random() * (arenaWidth - 100) + 20;
          gameState.fallingChars.push({
              el, y: -80, x: startX, speed: fallSpeed + Math.random() * 0.15,
              char, cho, jung, sway: swayAmount, isSmall
          });
      }

      // ÌååÏõåÏóÖ SVG ÏÉùÏÑ±
      let _pwId = 0;
      function getPowerupHTML(fx) {
          const id = _pwId++;
          if (fx === 'life') return `<svg viewBox="0 0 60 60" width="48" height="48"><defs><radialGradient id="pwh${id}" cx=".4" cy=".3" r=".7"><stop offset="0%" stop-color="#f472b6"/><stop offset="100%" stop-color="#ec4899"/></radialGradient></defs><circle cx="30" cy="30" r="28" fill="#fdf2f8" stroke="#f9a8d4" stroke-width="2"><animate attributeName="r" values="26;28;26" dur="1s" repeatCount="indefinite"/></circle><path d="M30 46 C18 36 10 28 10 22 A10 10 0 0 1 30 18 A10 10 0 0 1 50 22 C50 28 42 36 30 46Z" fill="url(#pwh${id})"><animate attributeName="d" values="M30 46 C18 36 10 28 10 22 A10 10 0 0 1 30 18 A10 10 0 0 1 50 22 C50 28 42 36 30 46Z;M30 44 C20 36 12 28 12 23 A10 10 0 0 1 30 20 A10 10 0 0 1 48 23 C48 28 40 36 30 44Z;M30 46 C18 36 10 28 10 22 A10 10 0 0 1 30 18 A10 10 0 0 1 50 22 C50 28 42 36 30 46Z" dur=".8s" repeatCount="indefinite"/></path><ellipse cx="22" cy="24" rx="3" ry="2" fill="#fff" opacity=".5"/></svg>`;
          if (fx === 'slow') return `<svg viewBox="0 0 60 60" width="48" height="48"><defs><linearGradient id="pwc${id}" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#7c3aed"/></linearGradient></defs><circle cx="30" cy="30" r="28" fill="#f5f3ff" stroke="#c4b5fd" stroke-width="2"/><circle cx="30" cy="30" r="22" fill="none" stroke="url(#pwc${id})" stroke-width="3"/><circle cx="30" cy="30" r="2.5" fill="#7c3aed"/><line x1="30" y1="30" x2="30" y2="14" stroke="#7c3aed" stroke-width="2.5" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" from="0 30 30" to="360 30 30" dur="4s" repeatCount="indefinite"/></line><line x1="30" y1="30" x2="42" y2="30" stroke="#a78bfa" stroke-width="2" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" from="0 30 30" to="360 30 30" dur="12s" repeatCount="indefinite"/></line><g font-size="7" fill="#7c3aed" font-weight="700" text-anchor="middle"><text x="30" y="14">12</text><text x="47" y="33">3</text><text x="30" y="52">6</text><text x="13" y="33">9</text></g></svg>`;
          return `<svg viewBox="0 0 60 60" width="48" height="48"><defs><linearGradient id="pwd${id}" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#c4b5fd"/><stop offset="50%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient></defs><circle cx="30" cy="30" r="28" fill="#faf5ff" stroke="#d8b4fe" stroke-width="2"><animate attributeName="r" values="26;28;26" dur="1.5s" repeatCount="indefinite"/></circle><polygon points="30,8 36,24 54,24 40,34 44,50 30,40 16,50 20,34 6,24 24,24" fill="url(#pwd${id})"><animate attributeName="opacity" values=".85;1;.85" dur="1.2s" repeatCount="indefinite"/></polygon><polygon points="30,16 34,26 44,26 36,32 38,42 30,36 22,42 24,32 16,26 26,26" fill="#fff" opacity=".3"/></svg>`;
      }

      // ÌååÏõåÏóÖ ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
      function spawnPowerUp() {
          const types = [
              { fx: 'life', effect: 'life' },
              { fx: 'slow', effect: 'slow' },
              { fx: 'points', effect: 'points' }
          ];
          const type = types[Math.floor(Math.random() * types.length)];
          const arena = document.getElementById('game-arena');
          const arenaWidth = arena.offsetWidth;

          const el = document.createElement('div');
          el.className = 'falling-char';
          el.innerHTML = `<div class="char-bubble" style="background:linear-gradient(145deg,#fbbf24,#f59e0b);border-color:#fde68a;position:relative;display:flex;align-items:center;justify-content:center;padding:4px;">${getPowerupHTML(type.fx)}</div>`;
          el.style.left = (Math.random() * (arenaWidth - 100) + 20) + 'px';
          el.style.top = '-80px';
          el.style.pointerEvents = 'auto';
          el.style.cursor = 'pointer';
          el.onclick = () => activatePowerUp(type.effect, el);
          arena.appendChild(el);
          SFX.pop();

          const fallSpeed = [0.15, 0.3, 0.5][gameState.speed - 1];
          gameState.fallingChars.push({
              el, y: -80, x: parseFloat(el.style.left), speed: fallSpeed,
              char: '__powerup__', cho: '', jung: '', sway: 0, isPowerUp: true, effect: type.effect
          });
      }

      // ÌååÏõåÏóÖ ÌôúÏÑ±Ìôî
      function activatePowerUp(effect, el) {
          if (effect === 'life') {
              gameState.lives = Math.min(gameState.lives + 1, 7);
          } else if (effect === 'slow') {
              gameState.fallingChars.forEach(i => i.speed *= 0.5);
              setTimeout(() => {
                  gameState.fallingChars.forEach(i => i.speed *= 2);
              }, 3000);
          } else if (effect === 'points') {
              gameState.score += 5;
          }
          SFX.powerup();

          // SVG ÌååÌã∞ÌÅ¥ Ïù¥ÌéôÌä∏
          const arena = document.getElementById('game-arena');
          const ex = parseFloat(el.style.left) + 30;
          const ey = parseFloat(el.style.top) + 30;
          const colors = ['#a78bfa','#fbbf24','#f472b6','#34d399','#60a5fa'];
          for (let i = 0; i < 8; i++) {
              const p = document.createElement('div');
              p.style.cssText = `position:absolute;left:${ex}px;top:${ey}px;width:8px;height:8px;border-radius:50%;background:${colors[i%colors.length]};pointer-events:none;z-index:100;transition:all .6s cubic-bezier(.25,.46,.45,.94);opacity:1;`;
              arena.appendChild(p);
              const angle = (i / 8) * Math.PI * 2;
              const dist = 40 + Math.random() * 30;
              requestAnimationFrame(() => {
                  p.style.left = (ex + Math.cos(angle) * dist) + 'px';
                  p.style.top = (ey + Math.sin(angle) * dist) + 'px';
                  p.style.opacity = '0';
                  p.style.transform = 'scale(0.2)';
              });
              setTimeout(() => p.remove(), 700);
          }

          // ÌÖçÏä§Ìä∏ Ïù¥ÌéôÌä∏
          const labels = { life: '‚ù§Ô∏è+1', slow: '‚è∞Ïä¨Î°úÏö∞!', points: 'üíé+5' };
          const ef = document.createElement('div');
          ef.style.cssText = `position:absolute;left:${ex}px;top:${ey-20}px;font-size:20px;font-weight:900;color:#fbbf24;text-shadow:0 0 8px rgba(251,191,36,.5);pointer-events:none;z-index:100;animation:scorePop .8s ease-out forwards;white-space:nowrap;`;
          ef.textContent = labels[effect] || '‚ú®';
          arena.appendChild(ef);
          setTimeout(() => ef.remove(), 900);

          // Í∏ÄÏûê Î™©Î°ùÏóêÏÑú Ï†úÍ±∞
          gameState.fallingChars = gameState.fallingChars.filter(i => i.el !== el);
          el.remove();
          updateGameUI();
      }

      function moveChars() {
          const arena = document.getElementById('game-arena');
          const groundY = arena.offsetHeight * 0.88;
          const arenaWidth = arena.offsetWidth;

          gameState.fallingChars = gameState.fallingChars.filter(item => {
              item.y += item.speed;

              // ÏßÄÍ∑∏Ïû¨Í∑∏ Ï¢åÏö∞ ÌùîÎì§Î¶º (ÏÇ¨Ïù∏Ìåå)
              if (item.sway) {
                  item.x += Math.sin(item.y / 80) * item.sway * 0.3;
                  item.x = Math.max(10, Math.min(arenaWidth - 90, item.x));
                  item.el.style.left = item.x + 'px';
              }

              item.el.style.top = item.y + 'px';

              if (item.y >= groundY) {
                  // ÌååÏõåÏóÖÏùÄ Ï°∞Ïö©Ìûà ÏÇ¨ÎùºÏßê
                  if (item.isPowerUp) {
                      item.el.remove();
                      return false;
                  }
                  // Î∞îÎã•Ïóê ÎãøÏùå
                  showMissEffect(item.el);
                  item.el.remove();
                  gameState.lives--;
                  gameState.combo = 0; // ÏΩ§Î≥¥ Î¶¨ÏÖã
                  SFX.wrong();
                  updateGameUI();

                  if (gameState.lives <= 0) {
                      endGame();
                  }
                  return false;
              }
              return true;
          });
      }

      function showMissEffect(el) {
          const arena = document.getElementById('game-arena');
          const x = parseInt(el.style.left);
          const y = parseInt(el.style.top);
          
          const miss = document.createElement('div');
          miss.className = 'char-explode';
          miss.textContent = 'üí•';
          miss.style.left = x + 'px';
          miss.style.top = y + 'px';
          arena.appendChild(miss);
          setTimeout(() => miss.remove(), 800);
      }

      function showMatchEffect(el) {
          const arena = document.getElementById('game-arena');
          const x = parseInt(el.style.left);
          const y = parseInt(el.style.top);
          
          const star = document.createElement('div');
          star.className = 'char-explode';
          star.textContent = '‚≠ê';
          star.style.left = x + 'px';
          star.style.top = y + 'px';
          arena.appendChild(star);
          
          for (let i = 0; i < 5; i++) {
              const s = document.createElement('div');
              s.className = 'star-burst';
              s.textContent = ['‚ú®','üåü','üí´','‚≠ê','üéâ'][i];
              s.style.left = (x + (Math.random() - 0.5) * 80) + 'px';
              s.style.top = y + 'px';
              s.style.animationDelay = (i * 0.1) + 's';
              arena.appendChild(s);
              setTimeout(() => s.remove(), 600);
          }
          
          setTimeout(() => star.remove(), 800);
      }

      function gameKeyPress(char) {
          if (!gameState.running || gameState.paused) return;
          
          const gc = gameState.gameChar;
          
          if (isConsonant(char)) {
              // ÏÉà ÏûêÏùå ÏûÖÎ†• ‚Üí Ï¥àÍ∏∞ÌôîÌïòÍ≥† ÏãúÏûë
              gc.choseong = char;
              gc.jungseong = '';
              gc.jongseong = '';
              highlightMatches();
          } else if (isVowel(char)) {
              if (gc.choseong && !gc.jungseong) {
                  gc.jungseong = char;
                  // Î™®Ïùå Ï°∞Ìï© ÏãúÎèÑ
                  checkAutoMatch();
              } else if (gc.choseong && gc.jungseong && !gc.jongseong) {
                  const combined = combineJungseong(gc.jungseong, char);
                  if (combined) {
                      gc.jungseong = combined;
                      checkAutoMatch();
                  }
              }
          }
      }

      function highlightMatches() {
          const gc = gameState.gameChar;
          
          // Î™®Îì† ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï¥àÍ∏∞Ìôî
          gameState.fallingChars.forEach(item => {
              item.el.classList.remove('cho-match', 'full-match');
          });
          
          if (!gc.choseong) return;
          
          // ÏûêÏùå Îß§Ïπ≠ ÌïòÏù¥ÎùºÏù¥Ìä∏
          gameState.fallingChars.forEach(item => {
              if (item.cho === gc.choseong) {
                  item.el.classList.add('cho-match');
              }
          });
      }

      function checkAutoMatch() {
          const gc = gameState.gameChar;
          if (!gc.choseong || !gc.jungseong) return;
          
          const inputText = composeCharacter(gc.choseong, gc.jungseong, gc.jongseong);
          
          // Î™®Îì† ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï¥àÍ∏∞Ìôî ÌõÑ Ïû¨Ï†ÅÏö©
          gameState.fallingChars.forEach(item => {
              item.el.classList.remove('cho-match', 'full-match');
              if (item.cho === gc.choseong) {
                  item.el.classList.add('cho-match');
              }
          });
          
          // ÏôÑÏ†Ñ Îß§Ïπ≠ Ï∞æÍ∏∞
          let matchedItems = [];
          gameState.fallingChars.forEach(item => {
              if (item.char === inputText) {
                  matchedItems.push(item);
              }
          });
          
          // Ïù¥ÏßÄÎ™®Îìú: Í∞ôÏùÄ Í∏ÄÏûê Ï†ÑÎ∂Ä Îß§Ïπ≠ / Í∑∏ Ïô∏: 1Í∞úÎßå
          if (matchedItems.length > 0) {
              const toMatch = gameState.type === 'simple' ? matchedItems : [matchedItems[0]];

              // ÏΩ§Î≥¥ ÏãúÏä§ÌÖú
              gameState.combo++;
              if (gameState.combo > gameState.maxCombo) gameState.maxCombo = gameState.combo;
              const comboBonus = Math.min(gameState.combo - 1, 5);
              SFX.correct();
              if (gameState.combo >= 3) { showComboEffect(gameState.combo); SFX.combo(gameState.combo); }

              // ÏûëÏùÄ Í∏ÄÏûê Î≥¥ÎÑàÏä§
              const smallBonus = toMatch.filter(m => m.isSmall).length;

              toMatch.forEach(m => {
                  m.el.classList.remove('cho-match');
                  m.el.classList.add('full-match');
              });

              setTimeout(() => {
                  toMatch.forEach(m => {
                      showMatchEffect(m.el);
                      m.el.remove();
                  });
                  gameState.fallingChars = gameState.fallingChars.filter(i => !toMatch.includes(i));
                  gameState.score += toMatch.length + comboBonus + smallBonus;

                  // Î†àÎ≤®ÏóÖ
                  const newLevel = Math.floor(gameState.score / 10) + 1;
                  if (newLevel > gameState.level) {
                      gameState.level = newLevel;
                      updateGameBackground();
                      SFX.levelup();
                      addToAudioQueue(`Î†àÎ≤® ${newLevel}!`);
                  }

                  if (toMatch.length > 1) {
                      addToAudioQueue('ÎåÄÎã®Ìï¥Ïöî');
                  }
                  addToAudioQueue(inputText);
                  updateGameUI();
              }, 350);

              // ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
              gc.choseong = '';
              gc.jungseong = '';
              gc.jongseong = '';

              // ÎÇòÎ®∏ÏßÄ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ìï¥Ï†ú (ÏïΩÍ∞Ñ ÎîúÎ†àÏù¥)
              setTimeout(() => highlightMatches(), 400);
          }
      }

      function gameBackspace() {
          const gc = gameState.gameChar;
          if (gc.jungseong) gc.jungseong = '';
          else if (gc.choseong) gc.choseong = '';
          highlightMatches();
      }

      // ÏΩ§Î≥¥ Ïù¥ÌéôÌä∏ ÌëúÏãú
      function showComboEffect(combo) {
          const arena = document.getElementById('game-arena');
          const ef = document.createElement('div');
          ef.textContent = `${combo} COMBO!`;
          ef.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:70px;font-weight:900;color:#f59e0b;text-shadow:0 4px 8px rgba(0,0,0,0.3);z-index:50;pointer-events:none;animation:comboPopAnim 1s ease-out forwards;';
          arena.appendChild(ef);
          setTimeout(() => ef.remove(), 1000);
      }

      // Î†àÎ≤®Î≥Ñ Î∞∞Í≤Ω Î≥ÄÌôî (Î¥Ñ‚ÜíÏó¨Î¶Ñ‚ÜíÍ∞ÄÏùÑ‚ÜíÍ≤®Ïö∏)
      function updateGameBackground() {
          const arena = document.getElementById('game-arena');
          const backgrounds = [
              'linear-gradient(180deg, #e0f2fe 0%, #bae6fd 25%, #a7f3d0 75%, #6ee7b7 100%)',
              'linear-gradient(180deg, #fef3c7 0%, #fde68a 25%, #fed7aa 75%, #fdba74 100%)',
              'linear-gradient(180deg, #ddd6fe 0%, #c4b5fd 25%, #a78bfa 75%, #7c3aed 100%)',
              'linear-gradient(180deg, #1e293b 0%, #334155 25%, #475569 75%, #64748b 100%)'
          ];
          const bgIndex = (gameState.level - 1) % backgrounds.length;
          const gameEl = document.getElementById('falling-game');
          gameEl.style.background = backgrounds[bgIndex];
      }

      function updateGameUI() {
          document.getElementById('game-score').textContent = gameState.score;
          document.getElementById('game-level').textContent = gameState.level;

          const maxHearts = Math.max(5, gameState.lives);
          const hearts = '‚ù§Ô∏è'.repeat(gameState.lives) + 'üñ§'.repeat(Math.max(0, 5 - gameState.lives));
          document.getElementById('game-hearts').textContent = hearts;
      }

      function updateRecords() {
          const el = id => document.getElementById(id);
          if (el('r-total-completed')) el('r-total-completed').textContent = userStats.totalCompleted;
          if (el('r-challenge-done')) el('r-challenge-done').textContent = parseInt(localStorage.getItem('challengeCompleted') || '0');
          if (el('r-level')) el('r-level').textContent = userStats.level;
          if (el('r-saved-count')) el('r-saved-count').textContent = (typeof savedWords !== 'undefined' ? savedWords.length : 0);
          if (el('r-hero-best')) el('r-hero-best').textContent = gameState.bestScore;
          if (el('r-hero-combo')) el('r-hero-combo').textContent = parseInt(localStorage.getItem('hangulHeroMaxCombo') || '0');
          if (el('r-hero-level')) el('r-hero-level').textContent = parseInt(localStorage.getItem('hangulHeroMaxLevel') || '0');
      }

      function endGame() {
          gameState.running = false;
          if (gameState.spawnTimer) clearInterval(gameState.spawnTimer);
          if (gameState.animationId) cancelAnimationFrame(gameState.animationId);
          
          // ÎÇ®ÏùÄ Í∏ÄÏûê Ï†úÍ±∞
          gameState.fallingChars.forEach(item => item.el.remove());
          gameState.fallingChars = [];

          // bestScore Í∞±Ïã†
          if (gameState.score > gameState.bestScore) gameState.bestScore = gameState.score;
          localStorage.setItem('hangulHeroBest', gameState.bestScore);
          const prevMaxCombo = parseInt(localStorage.getItem('hangulHeroMaxCombo') || '0');
          if (gameState.maxCombo > prevMaxCombo) localStorage.setItem('hangulHeroMaxCombo', gameState.maxCombo);
          const prevMaxLevel = parseInt(localStorage.getItem('hangulHeroMaxLevel') || '0');
          if (gameState.level > prevMaxLevel) localStorage.setItem('hangulHeroMaxLevel', gameState.level);

          document.getElementById('final-score').textContent = gameState.score;
          
          let msg = 'ÏûòÌñàÏñ¥Ïöî!';
          if (gameState.score >= 30) msg = 'ÎåÄÎã®Ìï¥Ïöî! Ï≤úÏû¨!';
          else if (gameState.score >= 20) msg = 'ÏôÄ! Ï†ïÎßê ÏûòÌñàÏñ¥Ïöî!';
          else if (gameState.score >= 10) msg = 'Î©ãÏ†∏Ïöî! Í≥ÑÏÜç Ïó∞ÏäµÌï¥Ïöî!';
          document.getElementById('game-over-message').textContent = msg;
          
          const bestEl = document.getElementById('game-over-best');
          if (bestEl && gameState.bestScore > 0) bestEl.textContent = `üèÜ ÏµúÍ≥† Í∏∞Î°ù: ${gameState.bestScore}Ï†ê`;

          document.getElementById('game-over-screen').classList.remove('hidden');
          SFX.gameOver();
          addToAudioQueue(msg);

          // ÏµúÍ≥†Í∏∞Î°ù ÎîîÏä§ÌîåÎ†àÏù¥ Í∞±Ïã†
          const bd = document.getElementById('hero-best-display');
          if (bd && gameState.bestScore > 0) { bd.style.display = 'block'; document.getElementById('hero-best-val').textContent = gameState.bestScore; }
      }

      function restartGame() {
          document.getElementById('game-over-screen').classList.add('hidden');
          document.getElementById('game-arena').querySelectorAll('.falling-char, .char-explode, .star-burst, .hero-countdown').forEach(el => el.remove());

          gameState.score = 0;
          gameState.lives = 5;
          gameState.level = 1;
          gameState.running = false;
          gameState.paused = false;
          gameState.fallingChars = [];
          gameState.gameChar = { choseong: '', jungseong: '', jongseong: '' };
          gameState.combo = 0;
          gameState.maxCombo = 0;

          updateGameUI();
          updateGameBackground();

          // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥
          const arena = document.getElementById('game-arena');
          const cd = document.createElement('div');
          cd.className = 'hero-countdown';
          cd.innerHTML = '<div class="hero-cd-num">3</div>';
          arena.appendChild(cd);
          SFX.pop();

          let count = 3;
          const cdTimer = setInterval(() => {
              count--;
              if (count > 0) {
                  cd.innerHTML = `<div class="hero-cd-num">${count}</div>`;
                  SFX.pop();
              } else {
                  clearInterval(cdTimer);
                  cd.innerHTML = '<div class="hero-cd-num" style="font-size:60px;color:#fbbf24">ÏãúÏûë!</div>';
                  SFX.gameStart();
                  setTimeout(() => {
                      cd.remove();
                      gameState.running = true;
                      startGameLoop();
                  }, 500);
              }
          }, 800);
      }

      function exitFallingGame() {
          gameState.running = false;
          if (gameState.spawnTimer) clearInterval(gameState.spawnTimer);
          if (gameState.animationId) cancelAnimationFrame(gameState.animationId);
          
          gameState.fallingChars.forEach(item => item.el.remove());
          gameState.fallingChars = [];
          
          document.getElementById('game-over-screen').classList.add('hidden');
          document.getElementById('game-pause-screen').classList.add('hidden');
          document.getElementById('game-settings-screen').classList.add('hidden');
          document.getElementById('falling-game').classList.add('hidden');
          if(document.fullscreenElement)document.exitFullscreen?.();
      }

      function toggleGamePause() {
          gameState.paused = !gameState.paused;
          const pauseScreen = document.getElementById('game-pause-screen');
          if (gameState.paused) {
              pauseScreen.classList.remove('hidden');
          } else {
              pauseScreen.classList.add('hidden');
          }
      }

      function showGameSettings() {
          gameState.paused = true;
          document.getElementById('game-settings-screen').classList.remove('hidden');
      }

      function closeGameSettings() {
          document.getElementById('game-settings-screen').classList.add('hidden');
          gameState.paused = false;
      }

      function setGameSpeed(speed) {
          gameState.speed = speed;
          document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.speed-btn')[speed - 1].classList.add('active');
          
          if (gameState.running) {
              if (gameState.spawnTimer) clearInterval(gameState.spawnTimer);
              const spawnInterval = [3000, 2200, 1500][speed - 1];
              gameState.spawnTimer = setInterval(() => {
                  if (!gameState.paused && gameState.running) spawnChar();
              }, spawnInterval);
          }
      }

      function setGameType(type) {
          gameState.type = type;
          document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
          const types = ['simple', 'medium', 'hard'];
          document.querySelectorAll('.type-btn')[types.indexOf(type)].classList.add('active');
      }

      // ÏûêÎèô ÏùºÏãúÏ†ïÏßÄ: ÌÉ≠Ï†ÑÌôò/ÏµúÏÜåÌôî/Ïï±Ï†ÑÌôò/ÌôîÎ©¥Ïû†Í∏à
      document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
              speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
              if (gameState.running && !gameState.paused) toggleGamePause();
          }
      });
      // ÏûêÎèô ÏùºÏãúÏ†ïÏßÄ: ÏÑ∏Î°úÎ™®Îìú Ï†ÑÌôò
      window.matchMedia('(orientation: portrait)').addEventListener('change', e => {
          if (e.matches) {
              speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
              if (gameState.running && !gameState.paused) toggleGamePause();
          }
      });
  </script>
</body>
</html>