<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Í≤ΩÏ†ú ÎÜÄÏù¥ÌÑ∞ üí∞</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}
body{font-family:'Noto Sans KR',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#059669 0%,#10b981 50%,#047857 100%);margin:0;padding:0;width:100vw;height:100vh;height:100dvh;overflow:hidden;touch-action:manipulation}
.rotate-notice{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#059669,#10b981);z-index:9999;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-size:24px;font-weight:700;text-align:center;gap:20px}
.rotate-notice .rotate-icon{font-size:80px;animation:rotateH 2s ease-in-out infinite}
@keyframes rotateH{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
@media(orientation:portrait){.rotate-notice{display:flex}.container{display:none!important}}
.container{width:1920px;height:1080px;background:#fff;border-radius:25px;box-shadow:0 25px 50px rgba(0,0,0,.12);display:flex;flex-direction:column;overflow:hidden;transform-origin:0 0;position:absolute}

/* Í≥ºÎ™©Î∞î */
.subject-bar{background:linear-gradient(135deg,#1e3a8a,#3b82f6);display:flex;align-items:center;padding:0 20px;height:56px;flex-shrink:0;gap:4px;position:relative}
.subject-bar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#6ee7b7,#10b981,#6ee7b7)}
.sb-tab{padding:8px 30px;border:none;border-radius:12px 12px 0 0;background:0;font-size:18px;font-weight:800;color:rgba(255,255,255,.5);cursor:pointer;font-family:inherit;transition:.2s;display:flex;align-items:center;gap:8px;text-decoration:none}
.sb-tab.active{background:#fff;color:#065f46}
.sb-tab.locked{cursor:default}
.sb-tab .lock{font-size:12px;opacity:.5}
.sb-spacer{flex:1}
.sb-btns{display:flex;gap:8px}
.sb-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);border-radius:10px;padding:6px 14px;font-size:18px;color:#fff;cursor:pointer;transition:.15s}
.sb-btn:active{background:rgba(255,255,255,.3)}

/* Î©îÏù∏ */
.main-layout{display:grid;grid-template-columns:300px 1fr 300px;gap:14px;padding:14px;flex:1;overflow:hidden}

/* ÏôºÏ™Ω */
.left-panel{display:flex;flex-direction:column;gap:10px;overflow:hidden}
.profile-section{background:linear-gradient(145deg,#047857,#059669 50%,#10b981);border-radius:20px;padding:20px;border:3px solid #a7f3d0;box-shadow:0 6px 20px rgba(5,150,105,.3);flex-shrink:0;position:relative;overflow:hidden}
.profile-section::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='15' cy='15' r='1.5' fill='white' opacity='.3'><animate attributeName='opacity' values='.3;.1;.3' dur='2s' repeatCount='indefinite'/></circle><circle cx='85' cy='25' r='1' fill='white' opacity='.25'><animate attributeName='opacity' values='.25;.08;.25' dur='1.5s' repeatCount='indefinite'/></circle><circle cx='25' cy='75' r='1.2' fill='white' opacity='.3'><animate attributeName='opacity' values='.3;.1;.3' dur='1.8s' repeatCount='indefinite'/></circle></svg>") repeat;pointer-events:none}
.profile-content{position:relative;z-index:1;display:flex;align-items:center;gap:15px}
.profile-avatar{width:90px;height:90px;background:linear-gradient(145deg,#6ee7b7,#34d399);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;border:3px solid #fff;box-shadow:0 4px 15px rgba(110,231,183,.4);animation:avGlow 3s ease-in-out infinite;flex-shrink:0;cursor:pointer}
@keyframes avGlow{0%,100%{box-shadow:0 4px 15px rgba(110,231,183,.4);transform:scale(1)}50%{box-shadow:0 8px 25px rgba(110,231,183,.6);transform:scale(1.05)}}
.profile-info{flex:1;color:#fff}
.profile-name{font-size:28px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,.3);margin-bottom:8px;cursor:pointer}
.profile-level-container{background:rgba(255,255,255,.2);border-radius:12px;padding:8px 12px}
.profile-level{font-size:22px;font-weight:700;color:#a7f3d0;display:flex;align-items:center;gap:8px}
.level-badge{background:linear-gradient(145deg,#6ee7b7,#34d399);color:#064e3b;padding:4px 12px;border-radius:8px;font-size:22px;font-weight:800;border:1px solid #fff}
.progress-bar{width:100%;height:6px;background:rgba(255,255,255,.3);border-radius:3px;margin-top:5px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#6ee7b7,#34d399,#6ee7b7);background-size:200% 100%;border-radius:3px;transition:width .5s;animation:pShine 2s linear infinite}
@keyframes pShine{0%{background-position:-200% 0}100%{background-position:200% 0}}

/* ÌÉ≠ */
.tab-headers{display:grid;grid-template-columns:1fr 1fr;gap:8px;flex-shrink:0}
.tab-btn{background:linear-gradient(145deg,#e2e8f0,#cbd5e1);border:2px solid #94a3b8;border-radius:12px;padding:8px;font-size:20px;font-weight:700;cursor:pointer;transition:.2s;color:#475569;display:flex;align-items:center;justify-content:center;height:62px;white-space:nowrap;font-family:inherit}
.tab-btn.active{background:linear-gradient(145deg,#10b981,#059669);color:#fff;border-color:#10b981}
.tab-btn:active{transform:scale(.97)}
.tab-content{display:none;flex:1;overflow:hidden}
.tab-content.active{display:flex;flex-direction:column}

/* ÏÇ¨Ïù¥Îìú Ï†ïÎ≥¥ */
.side-info{background:linear-gradient(145deg,#ecfdf5,#d1fae5);border-radius:16px;padding:18px;border:2px solid #10b981;display:flex;flex-direction:column;gap:12px;height:100%;overflow:hidden}
.side-title{font-size:24px;font-weight:700;color:#064e3b;text-align:center;flex-shrink:0}
.side-stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#fff;border-radius:8px;font-size:20px;font-weight:600;color:#1e293b}
.side-val{font-size:32px;font-weight:800;color:#059669}

/* Í≤åÏûÑ Îü∞Ïπò */
.game-launch-btn{flex-shrink:0;background:linear-gradient(145deg,#6ee7b7,#34d399);color:#064e3b;border:3px solid #fff;border-radius:16px;padding:20px;font-size:26px;font-weight:800;cursor:pointer;text-align:center;box-shadow:0 4px 15px rgba(110,231,183,.4);font-family:inherit;animation:gPulse 2s ease-in-out infinite}
@keyframes gPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
.game-launch-btn:active{transform:scale(.97)}

/* Ï§ëÏïô */
.center-panel{display:flex;flex-direction:column;overflow:hidden;position:relative}
.game-view{display:none;flex-direction:column;flex:1;overflow:hidden}
.game-view.active{display:flex}

/* ====== Î∂ïÏñ¥Îπµ Ïû•ÏÇ¨ ====== */
.fish-area{flex:1;display:flex;flex-direction:column;gap:6px;padding:8px;overflow:hidden}
.fish-phase{display:none;flex-direction:column;gap:12px;flex:1}
.fish-phase.active{display:flex}
.fish-title{font-size:28px;font-weight:900;color:#064e3b;text-align:center;padding:8px;background:linear-gradient(145deg,#ecfdf5,#d1fae5);border-radius:14px;border:2px solid #6ee7b7}
.fish-day-info{font-size:22px;font-weight:700;color:#065f46;text-align:center}
.shop-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:4px}
.shop-item{background:linear-gradient(145deg,#fff,#f0fdf4);border:3px solid #a7f3d0;border-radius:16px;padding:12px 16px;text-align:center;cursor:pointer;transition:.2s;min-width:150px}
.shop-item:active{transform:scale(.96)}
.shop-item.selected{border-color:#059669;background:linear-gradient(145deg,#d1fae5,#a7f3d0);box-shadow:0 0 16px rgba(5,150,105,.3)}
.shop-emoji{font-size:90px;margin-bottom:4px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.15));width:100px;height:100px;display:flex;align-items:center;justify-content:center;margin:0 auto 4px}
.shop-emoji svg{width:100%;height:100%}
.shop-name{font-size:22px;font-weight:800;color:#064e3b}
.shop-price{font-size:20px;font-weight:700;color:#059669;margin-top:4px}
.fish-slider-row{display:flex;align-items:center;gap:16px;padding:12px 20px;background:#fff;border-radius:14px;border:2px solid #a7f3d0}
.fish-slider-label{font-size:22px;font-weight:700;color:#064e3b;min-width:100px}
.fish-slider{flex:1;height:12px;-webkit-appearance:none;appearance:none;background:linear-gradient(90deg,#a7f3d0,#10b981);border-radius:6px;outline:none;cursor:pointer}
.fish-slider::-webkit-slider-thumb{-webkit-appearance:none;width:28px;height:28px;background:linear-gradient(145deg,#6ee7b7,#059669);border:3px solid #fff;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.2);cursor:pointer}
.fish-slider-val{font-size:30px;font-weight:900;color:#059669;min-width:80px;text-align:right}
.fish-btn{background:linear-gradient(145deg,#10b981,#059669);color:#fff;border:3px solid #6ee7b7;border-radius:16px;padding:14px 30px;font-size:28px;font-weight:800;cursor:pointer;font-family:inherit;text-align:center;box-shadow:0 4px 12px rgba(5,150,105,.3)}
.fish-btn:active{transform:scale(.96)}
.fish-btn.restart{background:linear-gradient(145deg,#6ee7b7,#34d399);color:#064e3b}
/* ÌåêÎß§Í∞Ä ÏÑ§Ï†ï Î¶¨Îâ¥Ïñº */
.price-setup-main{display:grid;grid-template-columns:1fr 1.3fr;gap:20px;flex:1;align-items:center}
.price-preview{display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px}
.price-fish-display{width:200px;height:140px}
.price-fish-display svg{width:100%;height:100%;filter:drop-shadow(0 6px 16px rgba(120,53,15,.3))}
.price-tag{background:linear-gradient(145deg,#fef3c7,#fde68a);border:3px solid #f59e0b;border-radius:16px;padding:10px 28px;text-align:center;box-shadow:0 4px 16px rgba(245,158,11,.3);animation:priceTagPulse 2s ease-in-out infinite;position:relative}
.price-tag::before{content:'';position:absolute;top:-8px;left:50%;transform:translateX(-50%);width:20px;height:8px;background:#f59e0b;border-radius:4px 4px 0 0}
.price-tag-label{font-size:16px;font-weight:700;color:#92400e}
.price-tag-val{font-size:36px;font-weight:900;color:#b45309}
@keyframes priceTagPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.price-cost-info{font-size:18px;font-weight:700;color:#064e3b;text-align:center}
.price-controls{display:flex;flex-direction:column;gap:14px}
.price-meter-area{background:linear-gradient(145deg,#fff,#f0fdf4);border:2px solid #a7f3d0;border-radius:16px;padding:14px 18px}
.price-meter-label{font-size:18px;font-weight:800;color:#064e3b;margin-bottom:8px;text-align:center}
.price-meter-bar{height:24px;background:#e5e7eb;border-radius:12px;overflow:hidden;position:relative}
.price-meter-fill{height:100%;background:linear-gradient(90deg,#34d399,#10b981,#059669);border-radius:12px;transition:width .4s ease}
.price-meter-faces{display:flex;justify-content:center;gap:8px;margin-top:8px;font-size:32px;min-height:40px}
.price-slider-big{background:linear-gradient(145deg,#fff,#ecfdf5);border:2px solid #a7f3d0;border-radius:16px;padding:14px 18px}
.price-slider-labels{display:flex;justify-content:space-between;font-size:16px;font-weight:700;color:#065f46;margin-bottom:6px}
.fish-slider-big{height:18px!important}
.fish-slider-big::-webkit-slider-thumb{width:36px!important;height:36px!important}
.price-slider-val-big{font-size:42px;font-weight:900;color:#059669;text-align:center;margin-top:4px;text-shadow:0 2px 4px rgba(5,150,105,.2)}
.price-tip{font-size:18px;font-weight:700;color:#065f46;text-align:center;padding:8px;background:linear-gradient(145deg,#ecfdf5,#d1fae5);border-radius:12px;transition:.3s}
.fish-btn-big{font-size:32px;padding:16px 40px;width:100%;animation:btnGlow 2s ease-in-out infinite}
@keyframes btnGlow{0%,100%{box-shadow:0 4px 12px rgba(5,150,105,.3)}50%{box-shadow:0 4px 24px rgba(5,150,105,.6)}}
/* ÌåêÎß§ Ïï†ÎãàÎ©îÏù¥ÏÖò */
.selling-scene{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;position:relative;overflow:hidden}
.selling-weather-reveal{text-align:center;opacity:0;transform:scale(0.3);transition:all .6s cubic-bezier(.34,1.56,.64,1)}
.selling-weather-reveal.show{opacity:1;transform:scale(1)}
.selling-weather-icon{font-size:120px}
.selling-weather-icon svg{width:150px;height:150px}
.selling-weather-name{font-size:30px;font-weight:900;color:#064e3b}
.selling-stall{position:relative;width:500px;height:160px;margin-top:8px}
.selling-stall-roof{position:absolute;top:0;left:-30px;right:-30px;height:40px;background:linear-gradient(180deg,#dc2626,#b91c1c);border-radius:8px 8px 0 0;box-shadow:0 4px 12px rgba(0,0,0,.2)}
.selling-stall-roof::before{content:'Î∂ïÏñ¥Îπµ';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;color:#fef08a;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.selling-stall-counter{position:absolute;top:40px;left:0;right:0;height:120px;background:linear-gradient(180deg,#92400e,#78350f);border-radius:0 0 12px 12px;display:flex;align-items:center;justify-content:center;gap:8px;padding:0 20px;box-shadow:0 6px 20px rgba(0,0,0,.2)}
.selling-fish-stack{position:absolute;top:50px;left:20px;right:20px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
.selling-fish-mini{width:50px;height:35px;opacity:1;transition:all .4s ease}
.selling-fish-mini.sold{opacity:0;transform:scale(0) rotate(30deg)}
.selling-fish-mini svg{width:100%;height:100%}
.selling-customers{display:flex;gap:16px;min-height:70px;align-items:flex-end}
.selling-customer{opacity:0;transform:translateY(30px);transition:all .4s ease}
.selling-customer.arrive{opacity:1;transform:translateY(0)}
.selling-coin-fly{position:absolute;animation:sellingCoinFly .8s ease-out forwards;font-size:28px;font-weight:900;color:#fbbf24;pointer-events:none}
@keyframes sellingCoinFly{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--tx,0),var(--ty,-80px)) scale(0.5)}}
.selling-status{font-size:26px;font-weight:900;color:#064e3b;text-align:center;padding:10px 24px;background:linear-gradient(145deg,#ecfdf5,#d1fae5);border-radius:14px;border:2px solid #6ee7b7}
.weather-card{background:linear-gradient(145deg,#fff,#ecfdf5);border:3px solid #6ee7b7;border-radius:20px;padding:20px;text-align:center;min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;position:relative;overflow:hidden}
.weather-card::before{content:'';position:absolute;inset:0;opacity:.08;pointer-events:none}
.weather-emoji{font-size:120px;filter:drop-shadow(0 4px 8px rgba(0,0,0,.15));min-height:180px;display:flex;align-items:center;justify-content:center}
.weather-emoji svg{width:180px;height:180px}
.weather-name{font-size:28px;font-weight:800;color:#064e3b}
.weather-desc{font-size:20px;color:#065f46;font-weight:600}
.result-box{background:linear-gradient(145deg,#ecfdf5,#d1fae5);border:3px solid #10b981;border-radius:20px;padding:20px;text-align:center}
.result-row{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;font-size:22px;font-weight:700;color:#064e3b;border-bottom:1px solid #a7f3d0}
.result-row:last-child{border-bottom:none}
.result-val{font-size:28px;font-weight:900;color:#059669}
.result-val.loss{color:#ef4444}
.result-val.profit{color:#059669}
/* Î∂ïÏñ¥Îπµ ÌãÄ SVG */
.fish-grill-container{display:flex;justify-content:center;padding:8px 0}
.fish-grill-svg{width:100%;max-width:550px;height:auto;filter:drop-shadow(0 4px 12px rgba(0,0,0,.2))}
/* Ïû•ÏÇ¨ Í≤∞Í≥º ÎèôÏ†Ñ Ïù¥ÌéôÌä∏ */
.fish-coin-rain{position:absolute;inset:0;pointer-events:none;z-index:20;overflow:hidden}
.fish-flying-coin{position:absolute;animation:fishCoinFly 1.2s ease-out forwards}
@keyframes fishCoinFly{0%{transform:translate(0,0) rotate(0) scale(1);opacity:1}100%{transform:translate(var(--tx,0),var(--ty,-100px)) rotate(360deg) scale(0.3);opacity:0}}
.fish-summary{background:linear-gradient(145deg,#064e3b,#065f46);border-radius:20px;padding:24px;text-align:center;color:#fff}
.fish-summary h2{font-size:34px;font-weight:900;margin-bottom:16px;color:#6ee7b7}
.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.summary-item{background:rgba(255,255,255,.1);border-radius:12px;padding:14px}
.summary-num{font-size:40px;font-weight:900;color:#6ee7b7}
.summary-label{font-size:18px;color:#a7f3d0;margin-top:4px}

/* ====== ÏßÄÍ∞ë ÌÉàÏ∂ú ====== */
.wallet-area{flex:1;display:flex;flex-direction:column;gap:10px;padding:10px;overflow:hidden;position:relative}
.wallet-header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:linear-gradient(145deg,#ecfdf5,#d1fae5);border-radius:14px;border:2px solid #6ee7b7;flex-shrink:0}
.wallet-money{font-size:34px;font-weight:900;color:#064e3b}
.wallet-piggy{font-size:30px;font-weight:700;color:#059669;display:flex;align-items:center;gap:12px}
.wallet-piggy .piggy-icon{font-size:36px;transition:transform .3s;display:inline-flex;align-items:center}
.piggy-svg{width:120px;height:100px;filter:drop-shadow(0 4px 12px rgba(236,72,153,.3))}
.piggy-svg .piggy-ear{animation:piggyEarWiggle 2s ease-in-out infinite}
@keyframes piggyEarWiggle{0%,100%{transform:rotate(0)}50%{transform:rotate(-5deg)}}
.piggy-svg .piggy-eye-blink{animation:piggyBlink 3s ease-in-out infinite}
@keyframes piggyBlink{0%,42%,46%,100%{ry:3}44%{ry:0.5}}
.wallet-piggy .piggy-icon.bounce{animation:piggyBounce .5s ease-out}
@keyframes piggyBounce{0%{transform:scale(1)}30%{transform:scale(1.3) rotate(-10deg)}60%{transform:scale(1.1) rotate(5deg)}100%{transform:scale(1)}}
.product-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:4px;flex:1;overflow-y:auto;align-content:start;grid-auto-rows:1fr}
.product-item{background:linear-gradient(145deg,#fff,#f0fdf4);border:3px solid #d1fae5;border-radius:16px;padding:14px 12px;text-align:center;cursor:pointer;transition:.2s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
.product-item:active{transform:scale(.95)}
.product-item.in-cart{border-color:#059669;background:linear-gradient(145deg,#d1fae5,#a7f3d0)}
.product-item.over-budget{border-color:#ef4444;background:linear-gradient(145deg,#fef2f2,#fecaca)}
.product-emoji{font-size:90px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.12));transition:transform .2s;line-height:1;width:120px;height:120px;display:flex;align-items:center;justify-content:center;margin:0 auto}
.product-emoji svg{width:100%;height:100%}
.product-item:hover .product-emoji{transform:scale(1.1)}
.product-item.in-cart .product-emoji{animation:cartBounce .4s ease-out}
@keyframes cartBounce{0%{transform:scale(1)}40%{transform:scale(1.2)}100%{transform:scale(1)}}
.product-name{font-size:18px;font-weight:700;color:#064e3b}
.product-price{font-size:20px;font-weight:800;color:#059669}
.cart-bar{display:flex;align-items:center;gap:12px;padding:10px 16px;background:#fff;border-radius:14px;border:2px solid #a7f3d0;flex-shrink:0}
.cart-label{font-size:20px;font-weight:700;color:#064e3b;white-space:nowrap}
.cart-items{flex:1;display:flex;gap:6px;overflow-x:auto;min-height:36px;align-items:center}
.cart-item-tag{background:linear-gradient(145deg,#d1fae5,#a7f3d0);border-radius:8px;padding:4px 10px;font-size:14px;font-weight:700;color:#064e3b;white-space:nowrap;cursor:pointer}
.cart-item-tag:active{transform:scale(.9)}
.cart-total{font-size:26px;font-weight:900;color:#059669;white-space:nowrap}
.wallet-status{text-align:center;font-size:26px;font-weight:800;padding:8px;border-radius:12px;flex-shrink:0;min-height:44px;transition:.3s}
.wallet-crying{position:absolute;font-size:40px;pointer-events:none;z-index:10;animation:walletCry 1s ease-out forwards}
@keyframes walletCry{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-60px) scale(.5);opacity:0}}
.piggy-particle{position:absolute;pointer-events:none;z-index:10;animation:piggyPart .6s ease-out forwards}
@keyframes piggyPart{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx,0),var(--ty,-30px)) scale(0);opacity:0}}

/* ====== Î¨ºÎ¨ºÍµêÌôò ====== */
.trade-area{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;overflow:hidden;position:relative}
.trade-goal{font-size:26px;font-weight:800;color:#064e3b;text-align:center;padding:10px;background:linear-gradient(145deg,#ecfdf5,#d1fae5);border-radius:14px;border:2px solid #6ee7b7;flex-shrink:0}
.trade-main{flex:1;display:grid;grid-template-columns:1fr 2fr;gap:10px;overflow:hidden}
.trade-bag{background:linear-gradient(145deg,#fff,#f0fdf4);border:3px solid #a7f3d0;border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px;overflow-y:auto}
.trade-bag-title{font-size:22px;font-weight:800;color:#064e3b;text-align:center;padding:6px;background:linear-gradient(145deg,#d1fae5,#a7f3d0);border-radius:10px}
.trade-bag-items{display:flex;flex-direction:column;gap:8px;flex:1}
.trade-bag-item{display:flex;align-items:center;gap:10px;padding:10px;background:linear-gradient(145deg,#ecfdf5,#d1fae5);border-radius:12px;border:2px solid #6ee7b7}
.trade-bag-item .bag-item-svg{width:60px;height:60px;flex-shrink:0}
.trade-bag-item .bag-item-svg svg{width:100%;height:100%}
.trade-bag-item .bag-item-name{font-size:20px;font-weight:700;color:#064e3b}
.trade-bag-item .bag-item-count{font-size:24px;font-weight:900;color:#059669;margin-left:auto}
.trade-market{display:flex;flex-direction:column;gap:8px;overflow-y:auto}
.trade-market-title{font-size:22px;font-weight:800;color:#064e3b;text-align:center;padding:6px;background:linear-gradient(145deg,#d1fae5,#a7f3d0);border-radius:10px;flex-shrink:0}
.trade-stalls{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;flex:1;align-content:start}
.trade-stall{background:linear-gradient(145deg,#fff,#f0fdf4);border:3px solid #d1fae5;border-radius:16px;padding:12px;text-align:center;cursor:pointer;transition:.2s;display:flex;flex-direction:column;align-items:center;gap:4px}
.trade-stall:hover{border-color:#10b981;box-shadow:0 2px 8px rgba(16,185,129,.2)}
.trade-stall:active{transform:scale(.97)}
.trade-stall.disabled{opacity:.35;pointer-events:none;filter:grayscale(.5)}
.trade-stall .stall-get-svg{width:70px;height:70px}
.trade-stall .stall-get-svg svg{width:100%;height:100%}
.trade-stall .stall-get-name{font-size:20px;font-weight:800;color:#059669}
.trade-stall .stall-get-count{font-size:16px;font-weight:700;color:#059669}
.trade-stall .stall-need{font-size:15px;font-weight:600;color:#dc2626;padding:4px 8px;background:#fef2f2;border-radius:8px;margin-top:2px}
.trade-stall .stall-need svg{width:24px;height:24px;vertical-align:middle}
.trade-result{text-align:center;font-size:28px;font-weight:800;padding:12px;border-radius:14px;flex-shrink:0;min-height:50px;transition:.3s}
.trade-success-overlay{position:absolute;inset:0;pointer-events:none;z-index:20;overflow:hidden}
.trade-confetti{position:absolute;width:8px;height:8px;border-radius:2px;pointer-events:none;animation:tradeConf var(--dur,1s) ease-out forwards}
@keyframes tradeConf{0%{transform:translate(0,0) rotate(0deg);opacity:1}100%{transform:translate(var(--tx,0),var(--ty,200px)) rotate(720deg);opacity:0}}
.trade-star-burst{position:absolute;pointer-events:none;z-index:25;animation:starBurst .8s ease-out forwards}
@keyframes starBurst{0%{transform:translate(0,0) scale(0) rotate(0);opacity:1}50%{transform:translate(var(--tx,0),var(--ty,0)) scale(1.5) rotate(180deg);opacity:1}100%{transform:translate(calc(var(--tx,0) * 2),calc(var(--ty,0) * 2)) scale(0) rotate(360deg);opacity:0}}
/* ÏÉÅÌíà Î∞òÏßùÏù¥ Ïù¥ÌéôÌä∏ */
.sparkle-effect{position:absolute;pointer-events:none;z-index:10;animation:sparkleFloat 0.6s ease-out forwards}
@keyframes sparkleFloat{0%{transform:scale(0) rotate(0);opacity:1}100%{transform:scale(1.5) rotate(180deg);opacity:0}}

/* ÎÇ¥ Í∏∞Î°ù */
.records-area{flex:1;display:flex;flex-direction:column;gap:20px;padding:20px;overflow-y:auto}
.record-card{background:linear-gradient(145deg,#fff,#f8fafc);border:2px solid #e2e8f0;border-radius:16px;padding:18px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.record-card h3{font-size:24px;font-weight:800;color:#1e293b;margin-bottom:10px}
.record-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.record-item{text-align:center;padding:16px;background:linear-gradient(145deg,#ecfdf5,#d1fae5);border-radius:12px;border:2px solid #a7f3d0}
.record-num{font-size:42px;font-weight:900;color:#059669}
.record-label{font-size:17px;font-weight:600;color:#064e3b;margin-top:4px}

/* Ïò§Î•∏Ï™Ω */
.right-panel{display:flex;flex-direction:column;gap:12px;overflow:hidden}
.action-btn{border:none;border-radius:20px;font-size:36px;font-weight:800;cursor:pointer;transition:.1s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;flex:1;min-height:60px;font-family:inherit;color:#fff}
.action-btn .icon{font-size:60px;opacity:.9;filter:drop-shadow(0 2px 4px rgba(0,0,0,.15))}
.action-btn:active{transform:scale(.95)}
.action-btn.btn-emerald{background:linear-gradient(145deg,#10b981,#059669);box-shadow:0 2px 8px rgba(16,185,129,.3)}
.action-btn.btn-cyan{background:linear-gradient(145deg,#06b6d4,#0891b2);box-shadow:0 2px 8px rgba(6,182,212,.2)}
.action-btn.btn-red{background:linear-gradient(145deg,#f87171,#ef4444);box-shadow:0 2px 8px rgba(248,113,113,.2)}
.action-btn.btn-green{background:linear-gradient(145deg,#10b981,#059669);box-shadow:0 2px 8px rgba(16,185,129,.2)}
.action-btn.btn-orange{background:linear-gradient(145deg,#f97316,#ea580c);box-shadow:0 2px 8px rgba(249,115,22,.2)}
.action-btn:disabled{background:linear-gradient(145deg,#e5e7eb,#d1d5db)!important;color:#9ca3af;cursor:not-allowed;box-shadow:none}

/* ====== ÌûàÏñ¥Î°ú: ÏãúÏû• Ïû•Î≥¥Í∏∞ Îü¨Ïãú ====== */
.hero-game{position:absolute;inset:0;width:1920px;height:1080px;z-index:5000;overflow:hidden;display:flex;flex-direction:column}
.hero-game.hidden{display:none}
.hg-bg{position:absolute;inset:0;z-index:0}
/* HUD */
.hg-header{display:flex;justify-content:space-between;align-items:center;padding:16px 40px;background:rgba(0,0,0,.35);backdrop-filter:blur(8px);z-index:20;flex-shrink:0;border-bottom:2px solid rgba(255,255,255,.15)}
.hg-stat{font-size:32px;font-weight:900;color:#fbbf24;text-shadow:0 2px 8px rgba(0,0,0,.5)}
.hg-target-area{text-align:center}
.hg-target-label{font-size:20px;color:rgba(255,255,255,.7);font-weight:700}
.hg-target-amount{font-size:48px;font-weight:900;color:#fff;text-shadow:0 0 20px rgba(16,185,129,.8)}
.hg-target-bar{width:300px;height:14px;background:rgba(255,255,255,.15);border-radius:7px;overflow:hidden;margin:6px auto 0}
.hg-target-fill{height:100%;background:linear-gradient(90deg,#10b981,#34d399);border-radius:7px;transition:width .3s ease;width:0%}
.hg-hearts{font-size:30px;letter-spacing:4px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
.hg-ctrls{display:flex;gap:8px}
.hg-ctrl-btn{background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.35);border-radius:50%;width:48px;height:48px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;backdrop-filter:blur(4px)}
.hg-ctrl-btn:active{transform:scale(.9)}
/* Arena */
.hg-arena{flex:1;position:relative;overflow:hidden;cursor:pointer;touch-action:none;z-index:1}
/* Wallet */
.hg-wallet{position:absolute;bottom:12%;left:50%;transform:translateX(-50%);width:250px;height:160px;z-index:15;transition:left .05s linear;cursor:grab;pointer-events:none}
.hg-wallet:active{cursor:grabbing}
.hg-wallet svg{width:250px;height:160px;filter:drop-shadow(0 8px 24px rgba(0,0,0,.35))}
.hg-wallet-glow{position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:220px;height:30px;background:radial-gradient(ellipse,rgba(16,185,129,.4),transparent);border-radius:50%;pointer-events:none;z-index:14}
.hg-wallet-amount{position:absolute;bottom:-40px;left:50%;transform:translateX(-50%);font-size:32px;font-weight:900;color:#fbbf24;text-shadow:0 2px 8px rgba(0,0,0,.6);white-space:nowrap}
/* Falling coins */
.hg-coin{position:absolute;z-index:10;pointer-events:none}
.hg-coin svg{filter:drop-shadow(0 4px 12px rgba(0,0,0,.3))}
.hg-coin.coin-spin{animation:hgCoinSpin 1.5s linear infinite}
@keyframes hgCoinSpin{0%{filter:brightness(1) drop-shadow(0 4px 12px rgba(0,0,0,.3))}50%{filter:brightness(1.25) drop-shadow(0 4px 16px rgba(251,191,36,.4))}100%{filter:brightness(1) drop-shadow(0 4px 12px rgba(0,0,0,.3))}}
.hg-coin .coin-label{position:absolute;bottom:-24px;left:50%;transform:translateX(-50%);font-size:22px;font-weight:900;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.6);white-space:nowrap}
/* Coin collect effect */
.coin-collected{animation:hgCoinCollect .4s ease-in forwards}
@keyframes hgCoinCollect{0%{transform:scale(1);opacity:1}50%{transform:scale(1.4);opacity:.8}100%{transform:scale(0) translateY(50px);opacity:0}}
/* Score popup */
.hg-score-pop{position:absolute;font-size:40px;font-weight:900;color:#fbbf24;text-shadow:0 2px 8px rgba(0,0,0,.5);pointer-events:none;animation:hgScorePop 1s ease-out forwards;z-index:25}
@keyframes hgScorePop{0%{transform:translateY(0) scale(.5);opacity:0}20%{transform:translateY(-10px) scale(1.2);opacity:1}100%{transform:translateY(-80px) scale(.8);opacity:0}}
/* Debt bomb */
.hg-debt{position:absolute;z-index:10;pointer-events:none}
.hg-debt svg{filter:drop-shadow(0 4px 12px rgba(239,68,68,.5));animation:hgDebtPulse .6s ease-in-out infinite alternate}
@keyframes hgDebtPulse{0%{filter:drop-shadow(0 4px 12px rgba(239,68,68,.3))}100%{filter:drop-shadow(0 4px 20px rgba(239,68,68,.8))}}
/* Power-up */
.hg-power{position:absolute;z-index:10;pointer-events:none}
.hg-power svg{animation:hgPowerGlow 1s ease-in-out infinite alternate;filter:drop-shadow(0 0 10px rgba(16,185,129,.5))}
@keyframes hgPowerGlow{0%{filter:drop-shadow(0 0 5px rgba(16,185,129,.3))}100%{filter:drop-shadow(0 0 20px rgba(16,185,129,.8))}}
/* Market decorations */
.hg-market-stall{position:absolute;bottom:0;z-index:2;pointer-events:none}
.hg-market-banner{position:absolute;z-index:3;pointer-events:none;animation:hgBannerSway 3s ease-in-out infinite}
@keyframes hgBannerSway{0%,100%{transform:rotate(-2deg)}50%{transform:rotate(2deg)}}
/* Ground */
.hg-ground{position:absolute;bottom:0;width:100%;height:10%;z-index:5;pointer-events:none}
/* Screen flash effects */
.hg-flash-green{position:absolute;inset:0;background:rgba(16,185,129,.3);z-index:30;pointer-events:none;animation:hgFlashG .4s ease-out forwards}
@keyframes hgFlashG{0%{opacity:1}100%{opacity:0}}
.hg-flash-red{position:absolute;inset:0;background:rgba(239,68,68,.3);z-index:30;pointer-events:none;animation:hgFlashR .5s ease-out forwards}
@keyframes hgFlashR{0%{opacity:1}100%{opacity:0}}
.hg-arena-shake{animation:hgArenaShake .4s ease-out}
@keyframes hgArenaShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
/* Round clear celebration */
.hg-round-clear{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:30;pointer-events:none}
.hg-round-text{font-size:72px;font-weight:900;color:#fbbf24;text-shadow:0 0 30px rgba(251,191,36,.8),0 4px 12px rgba(0,0,0,.5);animation:hgRoundClearZoom 1.5s ease-out forwards}
@keyframes hgRoundClearZoom{0%{transform:scale(0) rotate(-10deg);opacity:0}30%{transform:scale(1.3) rotate(5deg);opacity:1}60%{transform:scale(.95) rotate(-2deg)}100%{transform:scale(1) rotate(0deg);opacity:0}}
/* Confetti */
.hg-confetti{position:absolute;width:12px;height:12px;z-index:28;pointer-events:none;animation:hgConfettiFall var(--dur) linear forwards}
@keyframes hgConfettiFall{0%{transform:translateY(0) rotate(0) scale(1);opacity:1}100%{transform:translateY(600px) rotate(720deg) scale(.3);opacity:0}}
/* Combo badge */
.hg-combo-badge{position:absolute;top:90px;left:50%;transform:translateX(-50%);font-size:46px;font-weight:900;color:#f59e0b;text-shadow:0 0 20px rgba(245,158,11,.8),0 3px 8px rgba(0,0,0,.4);z-index:25;pointer-events:none;animation:hgComboAppear .6s ease-out}
@keyframes hgComboAppear{0%{transform:translateX(-50%) scale(0)}60%{transform:translateX(-50%) scale(1.2)}100%{transform:translateX(-50%) scale(1)}}
/* Countdown */
.hg-countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:40;pointer-events:none}
.hg-countdown-num{font-size:180px;font-weight:900;color:#fff;text-shadow:0 0 60px rgba(16,185,129,.8),0 8px 30px rgba(0,0,0,.5);animation:hgCountPop .8s ease-out forwards}
@keyframes hgCountPop{0%{transform:scale(3);opacity:0}30%{transform:scale(1);opacity:1}80%{transform:scale(1.05);opacity:1}100%{transform:scale(.5);opacity:0}}
/* Game over overlay */
.hg-overlay{position:absolute;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50;gap:20px}
.hg-overlay.hidden{display:none}
.hg-over-title{font-size:60px;font-weight:900;color:#fbbf24;text-shadow:0 3px 10px rgba(0,0,0,.5)}
.hg-over-score{font-size:36px;color:#fff;font-weight:700}
.hg-over-best{font-size:28px;color:#a7f3d0;font-weight:600}
.hg-over-btn{padding:18px 50px;border:3px solid #10b981;border-radius:16px;background:linear-gradient(145deg,#10b981,#059669);color:#fff;font-size:28px;font-weight:800;cursor:pointer;font-family:inherit;margin-top:10px;transition:.2s;border-bottom:5px solid #047857}
.hg-over-btn:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(16,185,129,.5)}
.hg-over-btn:active{transform:translateY(3px) scale(1.02);border-bottom-width:2px}
.hg-over-btn.btn-exit{background:linear-gradient(145deg,#64748b,#475569);border-color:#475569;border-bottom-color:#334155}
/* Wallet open animation */
.wallet-mouth-open{animation:hgWalletOpen .3s ease-out}
@keyframes hgWalletOpen{0%{transform:scaleY(1)}50%{transform:scaleY(1.15)}100%{transform:scaleY(1)}}
/* Floating decoration in arena */
.hg-float-deco{position:absolute;pointer-events:none;z-index:1;opacity:.12;animation:hgFloatDeco var(--dur,15s) linear infinite}
@keyframes hgFloatDeco{0%{transform:translate(0,0) rotate(0)}25%{transform:translate(30px,-20px) rotate(90deg)}50%{transform:translate(-10px,-40px) rotate(180deg)}75%{transform:translate(-30px,-10px) rotate(270deg)}100%{transform:translate(0,0) rotate(360deg)}}

/* Î™®Îã¨ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:6000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px)}
.modal-overlay.hidden{display:none}
.modal-box{background:#fff;border-radius:20px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,.3)}
.modal-head{background:linear-gradient(145deg,#10b981,#059669);color:#fff;padding:16px 20px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center}
.modal-head h3{margin:0;font-size:18px}
.modal-close{background:0;border:0;color:#fff;font-size:24px;cursor:pointer}
.modal-body{padding:20px}
.modal-section{margin-bottom:16px;padding:14px;border-radius:10px;background:#f8fafc}
.modal-section h4{margin:0 0 10px;font-weight:700;color:#374151;font-size:15px}
.modal-input{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;margin-bottom:8px}
.modal-input:focus{outline:none;border-color:#10b981}
.modal-btn{padding:10px 16px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;width:100%;background:linear-gradient(145deg,#10b981,#059669);color:#fff;margin-top:6px}
.char-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:12px}
.char-item{background:linear-gradient(145deg,#f8fafc,#e2e8f0);border:2px solid #cbd5e1;border-radius:14px;padding:12px;text-align:center;cursor:pointer;font-size:32px;height:70px;display:flex;align-items:center;justify-content:center;transition:.2s}
.char-item.selected{background:linear-gradient(145deg,#6ee7b7,#34d399);border-color:#10b981}

/* ===== ÎπÑÏ£ºÏñº ÏóÖÍ∑∏Î†àÏù¥Îìú ===== */
/* Î∞∞Í≤Ω Ïî¨: Î∂ïÏñ¥ÎπµÏû•ÏÇ¨ ‚Äî Ìè¨Ïû•ÎßàÏ∞® */
.fish-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1300 900'><defs><linearGradient id='fb' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%23ecfdf5'/><stop offset='100%' stop-color='%23d1fae5'/></linearGradient></defs><rect fill='url(%23fb)' width='1300' height='900'/><rect x='0' y='780' width='1300' height='120' fill='%23a7f3d0' opacity='.2'/><circle cx='80' cy='100' r='3' fill='%2310b981' opacity='.12'><animate attributeName='opacity' values='.08;.2;.08' dur='3s' repeatCount='indefinite'/></circle><circle cx='1220' cy='80' r='2.5' fill='%2334d399' opacity='.1'><animate attributeName='opacity' values='.06;.18;.06' dur='2.5s' repeatCount='indefinite'/></circle></svg>") center/cover no-repeat;opacity:.5}
.fish-view{position:relative}
/* Î∞∞Í≤Ω Ïî¨: ÏßÄÍ∞ëÌÉàÏ∂ú ‚Äî ÏáºÌïëÎ™∞ */
.wallet-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1300 900'><rect fill='%23ecfdf5' width='1300' height='900'/><rect x='40' y='60' width='100' height='80' rx='6' fill='none' stroke='%2310b981' stroke-width='2' opacity='.08'/><rect x='1160' y='80' width='90' height='70' rx='6' fill='none' stroke='%2310b981' stroke-width='2' opacity='.08'/><circle cx='650' cy='830' r='3' fill='%2310b981' opacity='.1'><animate attributeName='opacity' values='.06;.18;.06' dur='2.8s' repeatCount='indefinite'/></circle></svg>") center/cover no-repeat;opacity:.5}
.wallet-view{position:relative}
/* Î∞∞Í≤Ω Ïî¨: Î¨ºÎ¨ºÍµêÌôò ‚Äî ÏãúÏû• */
.trade-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1300 900'><rect fill='%23ecfdf5' width='1300' height='900'/><rect x='0' y='760' width='1300' height='140' fill='%23d1fae5' opacity='.15'/><circle cx='120' cy='90' r='35' fill='none' stroke='%2310b981' stroke-width='1.5' opacity='.06'><animateTransform attributeName='transform' type='rotate' values='0 120 90;360 120 90' dur='25s' repeatCount='indefinite'/></circle></svg>") center/cover no-repeat;opacity:.5}
.trade-view{position:relative}
/* Î∞∞Í≤Ω Ïî¨: ÎÇ¥Í∏∞Î°ù ‚Äî Í∏àÍ≥† */
.record-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1300 900'><defs><linearGradient id='rb2' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%23ecfdf5'/><stop offset='100%' stop-color='%23d1fae5'/></linearGradient></defs><rect fill='url(%23rb2)' width='1300' height='900'/><circle cx='100' cy='810' r='3' fill='%2310b981' opacity='.15'><animate attributeName='opacity' values='.1;.25;.1' dur='3s' repeatCount='indefinite'/></circle><circle cx='1200' cy='820' r='2.5' fill='%2334d399' opacity='.12'><animate attributeName='opacity' values='.08;.2;.08' dur='2.5s' repeatCount='indefinite'/></circle></svg>") center/cover no-repeat;opacity:.5}
.record-view{position:relative}

/* 3D ÏïÑÏºÄÏù¥Îìú Î≤ÑÌäº */
.tab-btn{border-bottom:5px solid #7c8ba5;transition:.15s}
.tab-btn:active{transform:translateY(3px) scaleX(1.02) scaleY(.95)!important;border-bottom-width:2px}
.tab-btn.active{border-color:#047857;border-bottom:5px solid #047857}
.tab-btn.active:active{border-bottom-width:2px}
.action-btn{border-bottom:6px solid rgba(0,0,0,.25);transition:.1s}
.action-btn:active:not(:disabled){transform:translateY(4px) scaleX(1.03) scaleY(.94)!important;border-bottom-width:2px}
.action-btn.btn-green{border-bottom-color:#047857}
.action-btn.btn-cyan{border-bottom-color:#0e7490}
.action-btn.btn-red{border-bottom-color:#b91c1c}
.action-btn.btn-teal{border-bottom-color:#0d6e6e}
.game-launch-btn{border-bottom:6px solid #047857;position:relative;overflow:hidden}
.game-launch-btn:active{transform:translateY(4px) scaleX(1.02) scaleY(.95)!important;border-bottom-width:2px;animation:none}
.game-launch-btn::after{content:'';position:absolute;top:0;left:-100%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);animation:btnSweep 3s ease-in-out infinite}
@keyframes btnSweep{0%,100%{left:-100%}50%{left:120%}}

/* Ìå®ÎÑê Î≥¥Í∞ï */
.right-panel{background:linear-gradient(180deg,rgba(236,253,245,.3),rgba(209,250,229,.15));border-radius:20px;padding:10px}
.side-info{position:relative;overflow:hidden}
.side-info::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#10b981,#34d399,#10b981);border-radius:4px 4px 0 0}
.side-val{text-shadow:0 0 12px rgba(16,185,129,.35)}
.side-stat{transition:transform .2s}
.side-stat:hover{transform:translateX(3px)}

/* ÎîîÏûêÏù∏ Ìè¨ÎÆ¨Îü¨ */
.hg-stat,.game-launch-btn,.side-title{-webkit-text-stroke:.5px rgba(0,0,0,.1);paint-order:stroke fill}
.score-popup{position:absolute;pointer-events:none;z-index:50;font-size:28px;font-weight:900;color:#10b981;text-shadow:0 2px 8px rgba(0,0,0,.2);animation:scorePop .9s ease-out forwards}
@keyframes scorePop{0%{opacity:1;transform:translateY(0) scale(.5)}40%{transform:translateY(-30px) scale(1.2)}100%{opacity:0;transform:translateY(-70px) scale(.8)}}
.game-view.active{animation:viewFadeIn .35s ease-out}
@keyframes viewFadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.levelup-overlay{position:fixed;inset:0;z-index:8000;display:flex;align-items:center;justify-content:center;background:rgba(16,185,129,.15);pointer-events:none;animation:lvFlash .8s ease-out forwards}
@keyframes lvFlash{0%{background:rgba(16,185,129,.25)}100%{background:transparent}}
.levelup-box{font-size:52px;font-weight:900;color:#059669;text-shadow:0 4px 20px rgba(16,185,129,.5);animation:lvPop .8s cubic-bezier(.175,.885,.32,1.275) forwards}
@keyframes lvPop{0%{opacity:0;transform:scale(0) rotate(-10deg)}50%{opacity:1;transform:scale(1.3) rotate(3deg)}100%{opacity:0;transform:scale(1) rotate(0)}}
@keyframes heartLost{0%{transform:scale(1)}25%{transform:scale(1.4);filter:brightness(2)}50%{transform:scale(.8)}100%{transform:scale(1)}}

/* ÎßàÏä§ÏΩîÌä∏ */
.mascot{position:absolute;z-index:5;pointer-events:none;animation:mascotBob 3s ease-in-out infinite}
@keyframes mascotBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.mascot-bubble{position:absolute;background:#fff;border-radius:16px;padding:6px 14px;font-size:13px;font-weight:700;color:#065f46;box-shadow:0 3px 12px rgba(0,0,0,.12);white-space:nowrap;opacity:0;transition:opacity .3s;top:-40px;left:50%;transform:translateX(-50%)}
.mascot-bubble::after{content:'';position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid #fff}
.mascot-bubble.show{opacity:1}
</style>
</head>
<body>
<!-- SVG Ï†ïÏùò -->
<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden">
<defs>
  <!-- Í∏àÏÉâ ÎèôÏ†Ñ Í∑∏ÎùºÎç∞Ïù¥ÏÖò -->
  <radialGradient id="coinGold" cx="35%" cy="35%">
    <stop offset="0%" stop-color="#fef08a"/>
    <stop offset="40%" stop-color="#fbbf24"/>
    <stop offset="80%" stop-color="#d97706"/>
    <stop offset="100%" stop-color="#92400e"/>
  </radialGradient>
  <radialGradient id="coinSilver" cx="35%" cy="35%">
    <stop offset="0%" stop-color="#e2e8f0"/>
    <stop offset="40%" stop-color="#94a3b8"/>
    <stop offset="80%" stop-color="#64748b"/>
    <stop offset="100%" stop-color="#475569"/>
  </radialGradient>
  <radialGradient id="coinCopper" cx="35%" cy="35%">
    <stop offset="0%" stop-color="#fcd34d"/>
    <stop offset="40%" stop-color="#b45309"/>
    <stop offset="80%" stop-color="#78350f"/>
    <stop offset="100%" stop-color="#451a03"/>
  </radialGradient>
  <radialGradient id="coinGreen" cx="35%" cy="35%">
    <stop offset="0%" stop-color="#a7f3d0"/>
    <stop offset="40%" stop-color="#34d399"/>
    <stop offset="80%" stop-color="#059669"/>
    <stop offset="100%" stop-color="#047857"/>
  </radialGradient>
  <!-- ÎÇ†Ïî® SVG Í∑∏ÎùºÎç∞Ïù¥ÏÖò -->
  <linearGradient id="sunGrad" x1="0" y1="0" x2="1" y2="1">
    <stop offset="0%" stop-color="#fbbf24"/>
    <stop offset="100%" stop-color="#f59e0b"/>
  </linearGradient>
  <linearGradient id="cloudGrad" x1="0" y1="0" x2="0" y2="1">
    <stop offset="0%" stop-color="#e2e8f0"/>
    <stop offset="100%" stop-color="#94a3b8"/>
  </linearGradient>
  <linearGradient id="rainGrad" x1="0" y1="0" x2="0" y2="1">
    <stop offset="0%" stop-color="#60a5fa"/>
    <stop offset="100%" stop-color="#3b82f6"/>
  </linearGradient>
  <linearGradient id="snowGrad" x1="0" y1="0" x2="1" y2="1">
    <stop offset="0%" stop-color="#e0f2fe"/>
    <stop offset="100%" stop-color="#bae6fd"/>
  </linearGradient>
  <linearGradient id="stormGrad" x1="0" y1="0" x2="0" y2="1">
    <stop offset="0%" stop-color="#6b7280"/>
    <stop offset="100%" stop-color="#374151"/>
  </linearGradient>
  <!-- ÍµêÌôò ÌôîÏÇ¥Ìëú Í∑∏ÎùºÎç∞Ïù¥ÏÖò -->
  <linearGradient id="arrowGrad" x1="0" y1="0" x2="1" y2="0">
    <stop offset="0%" stop-color="#ef4444"/>
    <stop offset="50%" stop-color="#f59e0b"/>
    <stop offset="100%" stop-color="#10b981"/>
  </linearGradient>
</defs>
</svg>

<div class="rotate-notice"><div class="rotate-icon">üì±</div>ÌôîÎ©¥ÏùÑ Í∞ÄÎ°úÎ°ú ÎèåÎ†§Ï£ºÏÑ∏Ïöî!</div>

<div class="container">
  <div class="subject-bar">
    <button class="sb-tab active">üí∞ Í≤ΩÏ†ú</button>
    <div class="sb-spacer"></div>
    <div class="sb-btns">
      <button class="sb-btn" id="sb-sound" onclick="toggleSound()">üîä</button>
      <button class="sb-btn" onclick="showAdmin()">‚öôÔ∏è</button>
    </div>
  </div>

  <div class="main-layout">
    <!-- ÏôºÏ™Ω Ìå®ÎÑê -->
    <div class="left-panel">
      <div class="profile-section">
        <div class="profile-content">
          <div class="profile-avatar" onclick="showCharModal()"><span id="pf-char">üßí</span></div>
          <div class="profile-info">
            <div class="profile-name" onclick="changeName()"><span id="pf-name">Í≤ΩÏ†úÏôï</span></div>
            <div class="profile-level-container">
              <div class="profile-level">
                <span class="level-badge">LV.<span id="pf-level">1</span></span>
                <span id="pf-done">0</span>/<span id="pf-total">10</span>
              </div>
              <div class="progress-bar"><div class="progress-fill" id="pf-bar" style="width:0%"></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-headers">
        <button class="tab-btn active" onclick="switchTab('fish')">üêü Î∂ïÏñ¥Îπµ</button>
        <button class="tab-btn" onclick="switchTab('wallet')">üëõ ÏßÄÍ∞ëÌÉàÏ∂ú</button>
        <button class="tab-btn" onclick="switchTab('trade')">üîÑ Î¨ºÎ¨ºÍµêÌôò</button>
        <button class="tab-btn" onclick="switchTab('record')">üìä ÎÇ¥ Í∏∞Î°ù</button>
      </div>

      <!-- Î∂ïÏñ¥Îπµ ÏÇ¨Ïù¥Îìú -->
      <div class="tab-content fish-side active">
        <div class="side-info">
          <div class="side-title">üêü Î∂ïÏñ¥Îπµ Ïû•ÏÇ¨</div>
          <div class="side-stat"><span>ÎÇ†Ïßú</span><span class="side-val" id="fish-day">1ÏùºÏ∞®</span></div>
          <div class="side-stat"><span>ÏÜåÏßÄÍ∏à</span><span class="side-val" id="fish-money-side">5000Ïõê</span></div>
          <div class="side-stat"><span>Ï¥ù ÏàòÏùµ</span><span class="side-val" id="fish-profit-side">0Ïõê</span></div>
          <div class="side-stat"><span>ÌåêÎß§ Ïàò</span><span class="side-val" id="fish-sold-side">0Í∞ú</span></div>
        </div>
      </div>

      <!-- ÏßÄÍ∞ë ÏÇ¨Ïù¥Îìú -->
      <div class="tab-content wallet-side">
        <div class="side-info">
          <div class="side-title">üëõ ÏßÄÍ∞ë ÌÉàÏ∂ú</div>
          <div class="side-stat"><span>Ïö©Îèà</span><span class="side-val" id="wallet-budget-side">3000Ïõê</span></div>
          <div class="side-stat"><span>ÏÇ¨Ïö©</span><span class="side-val" id="wallet-spent-side">0Ïõê</span></div>
          <div class="side-stat"><span>Ï†ÄÍ∏àÌÜµ</span><span class="side-val" id="wallet-saved-side">0Ïõê</span></div>
          <div class="side-stat"><span>Ïó∞ÏÜç ÏÑ±Í≥µ</span><span class="side-val" id="wallet-streak-side">0</span></div>
        </div>
      </div>

      <!-- ÍµêÌôò ÏÇ¨Ïù¥Îìú -->
      <div class="tab-content trade-side">
        <div class="side-info">
          <div class="side-title">üîÑ Î¨ºÎ¨ºÍµêÌôò</div>
          <div class="side-stat"><span>ÍµêÌôò ÌöüÏàò</span><span class="side-val" id="trade-count-side">0</span></div>
          <div class="side-stat"><span>Î™©Ìëú</span><span class="side-val" id="trade-goal-side">?</span></div>
          <div class="side-stat"><span>ÏÑ±Í≥µ</span><span class="side-val" id="trade-success-side">0</span></div>
        </div>
      </div>

      <!-- Í∏∞Î°ù ÏÇ¨Ïù¥Îìú -->
      <div class="tab-content record-side">
        <div class="side-info">
          <div class="side-title">üìä Ï¢ÖÌï© Í∏∞Î°ù</div>
          <div class="side-stat"><span>Ï¥ù ÌôúÎèô</span><span class="side-val" id="rec-total-side">0</span></div>
          <div class="side-stat"><span>ÏÑ±Í≥µÎ•†</span><span class="side-val" id="rec-rate-side">0%</span></div>
        </div>
      </div>

      <div class="game-launch-btn" onclick="startHeroGame()">üõí ÏãúÏû• Ïû•Î≥¥Í∏∞ Îü¨Ïãú!</div>
    </div>

    <!-- Ï§ëÏïô Ìå®ÎÑê -->
    <div class="center-panel">
      <!-- ÎßàÏä§ÏΩîÌä∏ "ÏΩîÏù∏Ïù¥" -->
      <div class="mascot" id="mascot-main" style="top:4px;right:180px;z-index:10">
        <div id="mascot-svg-container" style="width:100px;height:140px"></div>
        <div class="mascot-bubble" id="bubble-fish">Ïû•ÏÇ¨ ÏãúÏûë!</div>
      </div>
      <!-- Î∂ïÏñ¥Îπµ Ïû•ÏÇ¨ -->
      <div class="game-view fish-view active" id="fish-view">
        <div class="fish-area" id="fish-area">
          <!-- Íµ¨Îß§ Îã®Í≥Ñ -->
          <div class="fish-phase active" id="fish-phase-buy">
            <div class="fish-title">üõí Ïû¨Î£å Íµ¨Îß§ ‚Äî <span id="fish-day-label">1ÏùºÏ∞®</span></div>
            <div class="fish-day-info">ÏÜåÏßÄÍ∏à: <span id="fish-budget-label">5000</span>Ïõê</div>
            <div class="shop-grid" id="shop-grid"></div>
            <div style="text-align:center">
              <div style="font-size:18px;font-weight:700;color:#064e3b;margin-bottom:8px">Ïû¨Î£åÎπÑ Ìï©Í≥Ñ: <span id="fish-cost-label" style="color:#059669;font-size:22px">0</span>Ïõê</div>
              <button class="fish-btn" onclick="fishBuyDone()">‚úÖ Íµ¨Îß§ ÏôÑÎ£å</button>
            </div>
          </div>
          <!-- Í∞ÄÍ≤© ÏÑ§Ï†ï -->
          <div class="fish-phase" id="fish-phase-price">
            <div class="fish-title">üí∞ Î∂ïÏñ¥Îπµ Í∞ÄÍ≤©ÏùÑ Ï†ïÌï¥Ïöî!</div>
            <div class="price-setup-main">
              <!-- ÏôºÏ™Ω: Î∂ïÏñ¥Îπµ ÌîÑÎ¶¨Î∑∞ + Í∞ÄÍ≤©ÌÉúÍ∑∏ -->
              <div class="price-preview">
                <div class="price-fish-display" id="price-fish-display"></div>
                <div class="price-tag" id="price-tag">
                  <div class="price-tag-label">1Í∞ú</div>
                  <div class="price-tag-val" id="price-tag-val">500Ïõê</div>
                </div>
                <div class="price-cost-info">ÏõêÍ∞Ä <span id="fish-unit-cost" style="color:#ef4444;font-size:26px;font-weight:900">0</span>Ïõê</div>
              </div>
              <!-- Ïò§Î•∏Ï™Ω: Ïä¨ÎùºÏù¥Îçî + ÏÜêÎãò ÎØ∏ÌÑ∞ -->
              <div class="price-controls">
                <div class="price-meter-area">
                  <div class="price-meter-label">ÏòàÏÉÅ ÏÜêÎãò</div>
                  <div class="price-meter-bar">
                    <div class="price-meter-fill" id="price-meter-fill" style="width:70%"></div>
                  </div>
                  <div class="price-meter-faces" id="price-meter-faces"></div>
                </div>
                <div class="price-slider-big">
                  <div class="price-slider-labels"><span>Ïã∏Í≤å üòä</span><span>ÎπÑÏã∏Í≤å üí∞</span></div>
                  <input type="range" class="fish-slider fish-slider-big" id="fish-price-slider" min="100" max="2000" step="100" value="500" oninput="updatePriceLabel()">
                  <div class="price-slider-val-big"><span id="fish-price-label">500</span>Ïõê</div>
                </div>
                <div class="price-tip" id="price-tip">Ï†ÅÎãπÌïú Í∞ÄÍ≤©Ïù¥ÏóêÏöî!</div>
                <button class="fish-btn fish-btn-big" onclick="fishSetPrice()">üè™ Ïû•ÏÇ¨ ÏãúÏûë!</button>
              </div>
            </div>
          </div>
          <!-- ÌåêÎß§ Ïï†ÎãàÎ©îÏù¥ÏÖò Îã®Í≥Ñ -->
          <div class="fish-phase" id="fish-phase-selling">
            <div class="fish-title">üè™ Ïû•ÏÇ¨ Ï§ë ‚Äî <span id="fish-selling-day">1ÏùºÏ∞®</span></div>
            <div class="selling-scene">
              <div class="selling-weather-reveal" id="selling-weather">
                <div class="selling-weather-icon" id="selling-weather-icon"></div>
                <div class="selling-weather-name" id="selling-weather-name"></div>
              </div>
              <div class="selling-stall">
                <div class="selling-stall-roof"></div>
                <div class="selling-stall-counter" id="selling-counter"></div>
                <div class="selling-fish-stack" id="selling-fish-stack"></div>
              </div>
              <div class="selling-customers" id="selling-customers"></div>
              <div class="selling-coins" id="selling-coins"></div>
              <div class="selling-status" id="selling-status">Ï§ÄÎπÑ Ï§ë...</div>
            </div>
          </div>
          <!-- Ïû•ÏÇ¨ Í≤∞Í≥º -->
          <div class="fish-phase" id="fish-phase-sell">
            <div class="fish-title">üìä Ïò§ÎäòÏùò Í≤∞Í≥º ‚Äî <span id="fish-sell-day">1ÏùºÏ∞®</span></div>
            <div style="display:flex;gap:16px;flex:1">
              <div style="flex:1;display:flex;flex-direction:column;gap:12px">
                <div class="weather-card" id="weather-card">
                  <div class="weather-emoji" id="weather-emoji">‚òÄÔ∏è</div>
                  <div class="weather-name" id="weather-name">ÎßëÏùå</div>
                  <div class="weather-desc" id="weather-desc">ÏÜêÎãòÏù¥ ÎßéÏù¥ ÏôÄÏöî!</div>
                </div>
              </div>
              <div style="flex:1;display:flex;flex-direction:column;gap:8px">
                <div class="result-box" id="sell-result">
                  <div class="result-row"><span>ÌåêÎß§Í∞Ä</span><span class="result-val" id="res-price">500Ïõê</span></div>
                  <div class="result-row"><span>ÏÜêÎãò Ïàò</span><span class="result-val" id="res-customers">0Î™Ö</span></div>
                  <div class="result-row"><span>Îß§Ï∂ú</span><span class="result-val" id="res-revenue">0Ïõê</span></div>
                  <div class="result-row"><span>Ïû¨Î£åÎπÑ</span><span class="result-val" id="res-cost">0Ïõê</span></div>
                  <div class="result-row"><span>Ïù¥Ïùµ</span><span class="result-val profit" id="res-profit">0Ïõê</span></div>
                </div>
              </div>
            </div>
            <div style="text-align:center"><button class="fish-btn" id="fish-next-btn" onclick="fishNextDay()">‚û°Ô∏è Îã§Ïùå ÎÇ†</button></div>
          </div>
          <!-- 3Ïùº Í≤∞ÏÇ∞ -->
          <div class="fish-phase" id="fish-phase-summary">
            <div class="fish-summary" id="fish-summary">
              <h2>üìä 3Ïùº Í≤∞ÏÇ∞!</h2>
              <div class="summary-grid" id="summary-grid"></div>
              <div style="margin-top:16px">
                <button class="fish-btn restart" onclick="fishRestart()">üîÑ Îã§Ïãú Ïû•ÏÇ¨ÌïòÍ∏∞</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ÏßÄÍ∞ë ÌÉàÏ∂ú -->
      <div class="game-view wallet-view" id="wallet-view">
        <div class="wallet-area" id="wallet-area">
          <div class="wallet-header">
            <div class="wallet-money">üí∞ Ïö©Îèà: <span id="wallet-budget">3000</span>Ïõê</div>
            <div class="wallet-piggy"><span class="piggy-icon" id="piggy-icon"><svg class="piggy-svg" viewBox="0 0 150 130" xmlns="http://www.w3.org/2000/svg">
              <defs><radialGradient id="piggyBody" cx="40%" cy="35%"><stop offset="0%" stop-color="#fce7f3"/><stop offset="50%" stop-color="#f9a8d4"/><stop offset="100%" stop-color="#ec4899"/></radialGradient></defs>
              <!-- Î™∏ÌÜµ -->
              <ellipse cx="75" cy="78" rx="55" ry="40" fill="url(#piggyBody)" stroke="#ec4899" stroke-width="2.5"/>
              <!-- Î®∏Î¶¨ -->
              <circle cx="55" cy="55" r="30" fill="#f9a8d4" stroke="#ec4899" stroke-width="2"/>
              <!-- Í∑Ä -->
              <ellipse cx="34" cy="32" rx="12" ry="10" fill="#f9a8d4" stroke="#ec4899" stroke-width="2" class="piggy-ear" transform-origin="34 42"/>
              <ellipse cx="34" cy="32" rx="7" ry="6" fill="#fce7f3"/>
              <ellipse cx="76" cy="32" rx="12" ry="10" fill="#f9a8d4" stroke="#ec4899" stroke-width="2" class="piggy-ear" transform-origin="76 42"/>
              <ellipse cx="76" cy="32" rx="7" ry="6" fill="#fce7f3"/>
              <!-- Îàà -->
              <ellipse cx="42" cy="50" rx="5" ry="5" fill="#1e293b" class="piggy-eye-blink"/>
              <ellipse cx="66" cy="50" rx="5" ry="5" fill="#1e293b" class="piggy-eye-blink"/>
              <circle cx="44" cy="48" r="2" fill="#fff"/>
              <circle cx="68" cy="48" r="2" fill="#fff"/>
              <!-- Î≥ºÌÑ∞Ïπò -->
              <ellipse cx="32" cy="60" rx="7" ry="4" fill="#f472b6" opacity=".5"/>
              <ellipse cx="78" cy="60" rx="7" ry="4" fill="#f472b6" opacity=".5"/>
              <!-- ÏΩî -->
              <ellipse cx="55" cy="64" rx="12" ry="8" fill="#fb7185" stroke="#ec4899" stroke-width="1.5"/>
              <ellipse cx="50" cy="63" rx="2.5" ry="3" fill="#be185d"/>
              <ellipse cx="60" cy="63" rx="2.5" ry="3" fill="#be185d"/>
              <!-- ÎèôÏ†Ñ Ìà¨ÏûÖÍµ¨ -->
              <rect x="58" y="18" width="34" height="5" rx="2.5" fill="#fbbf24" stroke="#f59e0b" stroke-width="1.5">
                <animate attributeName="fill" values="#fbbf24;#fde68a;#fbbf24" dur="2s" repeatCount="indefinite"/>
              </rect>
              <!-- Îã§Î¶¨ -->
              <rect x="40" y="112" width="12" height="14" rx="6" fill="#f9a8d4" stroke="#ec4899" stroke-width="1.5"/>
              <rect x="58" y="112" width="12" height="14" rx="6" fill="#f9a8d4" stroke="#ec4899" stroke-width="1.5"/>
              <rect x="78" y="112" width="12" height="14" rx="6" fill="#f9a8d4" stroke="#ec4899" stroke-width="1.5"/>
              <rect x="96" y="112" width="12" height="14" rx="6" fill="#f9a8d4" stroke="#ec4899" stroke-width="1.5"/>
              <!-- Íº¨Î¶¨ -->
              <path d="M128,70 Q140,60 136,50 Q134,44 138,40" fill="none" stroke="#ec4899" stroke-width="3" stroke-linecap="round"/>
              <!-- Î∞∞ Í∏àÏï° -->
              <text x="90" y="90" text-anchor="middle" font-size="14" font-weight="800" fill="#be185d" id="piggy-belly-text">0Ïõê</text>
              <!-- ÌïòÏù¥ÎùºÏù¥Ìä∏ -->
              <ellipse cx="60" cy="70" rx="15" ry="8" fill="rgba(255,255,255,.15)" transform="rotate(-15,60,70)"/>
            </svg></span> Ï†ÄÍ∏àÌÜµ: <span id="wallet-saved">0</span>Ïõê</div>
          </div>
          <div class="product-grid" id="product-grid"></div>
          <div class="cart-bar">
            <div class="cart-label">üõí Ïû•Î∞îÍµ¨Îãà:</div>
            <div class="cart-items" id="cart-items"></div>
            <div class="cart-total">Ìï©Í≥Ñ: <span id="cart-total">0</span>Ïõê</div>
          </div>
          <div class="wallet-status" id="wallet-status"></div>
        </div>
      </div>

      <!-- Î¨ºÎ¨ºÍµêÌôò -->
      <div class="game-view trade-view" id="trade-view">
        <div class="trade-area" id="trade-area">
          <div class="trade-goal" id="trade-goal-text">üéØ Î™©Ìëú: ÏºÄÏù¥ÌÅ¨Î•º Íµ¨ÌïòÏÑ∏Ïöî!</div>
          <div class="trade-main">
            <div class="trade-bag" id="trade-bag">
              <div class="trade-bag-title">ÎÇ¥ Í∞ÄÎ∞©</div>
              <div class="trade-bag-items" id="trade-bag-items"></div>
            </div>
            <div class="trade-market" id="trade-market">
              <div class="trade-market-title">ÏãúÏû•</div>
              <div class="trade-stalls" id="trade-stalls"></div>
            </div>
          </div>
          <div class="trade-result" id="trade-result"></div>
        </div>
      </div>

      <!-- ÎÇ¥ Í∏∞Î°ù -->
      <div class="game-view record-view" id="record-view">
        <!-- record mascot handled by mascot-main -->
        <div class="records-area">
          <div class="record-card">
            <h3>üèÜ Ï¢ÖÌï© ÏÑ±Ï†Å</h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-total">0</div><div class="record-label">Ï¥ù ÌôúÎèô</div></div>
              <div class="record-item"><div class="record-num" id="r-correct">0</div><div class="record-label">ÏÑ±Í≥µ</div></div>
              <div class="record-item"><div class="record-num" id="r-rate">0%</div><div class="record-label">ÏÑ±Í≥µÎ•†</div></div>
            </div>
          </div>
          <div class="record-card">
            <h3>üêü Î∂ïÏñ¥Îπµ Ïû•ÏÇ¨</h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-fish-games">0</div><div class="record-label">Ïû•ÏÇ¨ ÌöüÏàò</div></div>
              <div class="record-item"><div class="record-num" id="r-fish-profit">0</div><div class="record-label">ÏµúÍ≥† ÏàòÏùµ</div></div>
              <div class="record-item"><div class="record-num" id="r-fish-sold">0</div><div class="record-label">Ï¥ù ÌåêÎß§</div></div>
            </div>
          </div>
          <div class="record-card">
            <h3>üëõ ÏßÄÍ∞ë ÌÉàÏ∂ú</h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-wallet-games">0</div><div class="record-label">ÎèÑÏ†Ñ ÌöüÏàò</div></div>
              <div class="record-item"><div class="record-num" id="r-wallet-saved">0</div><div class="record-label">ÏµúÍ≥† Ï†ÄÍ∏à</div></div>
              <div class="record-item"><div class="record-num" id="r-wallet-streak">0</div><div class="record-label">ÏµúÍ≥† Ïó∞ÏÜç</div></div>
            </div>
          </div>
          <div class="record-card">
            <h3>üîÑ Î¨ºÎ¨ºÍµêÌôò</h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-trade-games">0</div><div class="record-label">ÎèÑÏ†Ñ ÌöüÏàò</div></div>
              <div class="record-item"><div class="record-num" id="r-trade-success">0</div><div class="record-label">ÏÑ±Í≥µ</div></div>
              <div class="record-item"><div class="record-num" id="r-trade-trades">0</div><div class="record-label">Ï¥ù ÍµêÌôò</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ïò§Î•∏Ï™Ω Ìå®ÎÑê -->
    <div class="right-panel" id="right-panel">
      <button class="action-btn btn-cyan" id="act1" onclick="actionBtn(1)"><span class="icon">üí°</span>ÌûåÌä∏</button>
      <button class="action-btn btn-green" id="act2" onclick="actionBtn(2)"><span class="icon">üîÑ</span>Îã§Ïãú</button>
      <button class="action-btn btn-red" id="act3" onclick="actionBtn(3)"><span class="icon">‚è≠</span>Îã§Ïùå</button>
    </div>
  </div>

<!-- ÌûàÏñ¥Î°ú Í≤åÏûÑ: ÏãúÏû• Ïû•Î≥¥Í∏∞ Îü¨Ïãú (container ÎÇ¥Î∂Ä) -->
<div id="hero-game" class="hero-game hidden">
  <div class="hg-bg" id="hg-bg"></div>
  <div class="hg-header">
    <div class="hg-stat" id="hg-score-display">‚≠ê <span id="hg-score">0</span>Ï†ê</div>
    <div class="hg-target-area">
      <div class="hg-target-label">Î™©Ìëú Í∏àÏï°</div>
      <div class="hg-target-amount" id="hg-target">0Ïõê</div>
      <div class="hg-target-bar"><div class="hg-target-fill" id="hg-fill"></div></div>
    </div>
    <div class="hg-hearts" id="hg-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <div class="hg-ctrls">
      <button class="hg-ctrl-btn" onclick="hgPause()">‚è∏</button>
      <button class="hg-ctrl-btn" onclick="hgExit()">‚úï</button>
    </div>
  </div>
  <div class="hg-arena" id="hg-arena">
    <!-- coins, wallet, decorations spawn here -->
  </div>
  <div id="hg-over" class="hg-overlay hidden">
    <div class="hg-over-title">Í≤åÏûÑ ÎÅù!</div>
    <div class="hg-over-score" id="hg-final-score">0Ï†ê</div>
    <div class="hg-over-best" id="hg-over-best"></div>
    <div class="hg-over-score" id="hg-over-msg" style="font-size:28px;color:#a7f3d0">ÏûòÌñàÏñ¥Ïöî!</div>
    <button class="hg-over-btn" onclick="hgRestart()">üîÑ Îã§ÏãúÌïòÍ∏∞</button>
    <button class="hg-over-btn btn-exit" onclick="hgExit()">üè† ÎèåÏïÑÍ∞ÄÍ∏∞</button>
  </div>
  <div id="hg-pause" class="hg-overlay hidden">
    <div class="hg-over-title">‚è∏ ÏùºÏãúÏ†ïÏßÄ</div>
    <button class="hg-over-btn" onclick="hgPause()">‚ñ∂ Í≥ÑÏÜçÌïòÍ∏∞</button>
    <button class="hg-over-btn btn-exit" onclick="hgExit()">üè† ÎèåÏïÑÍ∞ÄÍ∏∞</button>
  </div>
</div>

</div>

<!-- Í¥ÄÎ¶¨Ïûê Î™®Îã¨ -->
<div id="admin-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-head"><h3>‚öô ÏÑ§Ï†ï</h3><button class="modal-close" onclick="hideAdmin()">√ó</button></div>
    <div class="modal-body">
      <div class="modal-section">
        <h4>üë§ ÌîÑÎ°úÌïÑ</h4>
        <input class="modal-input" id="adm-name" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•" maxlength="10">
        <button class="modal-btn" onclick="saveProfile()">Ï†ÄÏû•</button>
      </div>
      <div class="modal-section">
        <h4>üîÑ Ï¥àÍ∏∞Ìôî</h4>
        <button class="modal-btn" style="background:linear-gradient(145deg,#ef4444,#dc2626)" onclick="resetAll()">Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button>
      </div>
    </div>
  </div>
</div>

<!-- Ï∫êÎ¶≠ÌÑ∞ Î™®Îã¨ -->
<div id="char-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-head"><h3>üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù</h3><button class="modal-close" onclick="hideCharModal()">√ó</button></div>
    <div class="modal-body">
      <div class="char-grid" id="char-grid"></div>
    </div>
  </div>
</div>

<script>
// ===== Ï†ÑÏó≠ Î≥ÄÏàò =====
let currentTab = 'fish';
let soundEnabled = true;
const LS = localStorage;

// ÌîÑÎ°úÌïÑ
let profile = {
  name: LS.getItem('econName') || 'Í≤ΩÏ†úÏôï',
  char: LS.getItem('econChar') || 'üßí',
  totalCorrect: parseInt(LS.getItem('econCorrect')) || 0,
  totalPlayed: parseInt(LS.getItem('econPlayed')) || 0
};

// Î∂ïÏñ¥Îπµ Ïû•ÏÇ¨ ÏÉÅÌÉú
let fish = {
  day: 1, money: 5000, totalProfit: 0, totalSold: 0,
  ingredients: [], cost: 0, unitCost: 0, sellPrice: 500,
  dailyResults: [],
  games: parseInt(LS.getItem('fishGames')) || 0,
  bestProfit: parseInt(LS.getItem('fishBestProfit')) || 0,
  lifetimeSold: parseInt(LS.getItem('fishLifetimeSold')) || 0
};

// ÏßÄÍ∞ë ÌÉàÏ∂ú ÏÉÅÌÉú
let wallet = {
  budget: 3000, spent: 0, saved: 0, cart: [], streak: 0,
  bestStreak: parseInt(LS.getItem('walletBestStreak')) || 0,
  bestSaved: parseInt(LS.getItem('walletBestSaved')) || 0,
  games: parseInt(LS.getItem('walletGames')) || 0
};

// Î¨ºÎ¨ºÍµêÌôò ÏÉÅÌÉú
let trade = {
  inventory: {}, goal: '', goalEmoji: '', tradeCount: 0,
  success: parseInt(LS.getItem('tradeSuccess')) || 0,
  games: parseInt(LS.getItem('tradeGames')) || 0,
  lifetimeTrades: parseInt(LS.getItem('tradeTotalTrades')) || 0
};

// ÌûàÏñ¥Î°ú Í≤åÏûÑ ÏÉÅÌÉú
let hg = {
  score: 0, lives: 5, level: 1, round: 0,
  target: 0, money: 0,
  running: false, paused: false,
  items: [], walletX: 835, walletEl: null,
  animId: null, spawnTimer: null,
  combo: 0, maxCombo: 0, dragging: false,
  hasPiggy: false, hasCalc: false,
  bestScore: parseInt(LS.getItem('econHeroBest')) || 0
};

// ===== SFX (Web Audio) =====
const SFX = {
  _ctx: null,
  _getCtx() { if (!this._ctx) this._ctx = new (window.AudioContext || window.webkitAudioContext)(); return this._ctx; },
  _play(fn) { try { if (!soundEnabled) return; fn(this._getCtx()); } catch(e) {} },
  coin() { this._play(ctx => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.setValueAtTime(1200,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(2400,ctx.currentTime+.08);g.gain.setValueAtTime(.06,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.12);o.start();o.stop(ctx.currentTime+.12); }); },
  cash() { this._play(ctx => { [800,1000,1200].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.04,ctx.currentTime+i*.05);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.05+.1);o.start(ctx.currentTime+i*.05);o.stop(ctx.currentTime+i*.05+.1); }); }); },
  profit() { this._play(ctx => { [523,659,784,1047].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.05,ctx.currentTime+i*.08);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.08+.2);o.start(ctx.currentTime+i*.08);o.stop(ctx.currentTime+i*.08+.2); }); }); },
  loss() { this._play(ctx => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sawtooth';o.frequency.setValueAtTime(200,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(100,ctx.currentTime+.15);g.gain.setValueAtTime(.05,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.15);o.start();o.stop(ctx.currentTime+.15); }); },
  trade() { this._play(ctx => { [659,784].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.1+.15);o.start(ctx.currentTime+i*.1);o.stop(ctx.currentTime+i*.1+.15); }); }); },
  fanfare() { this._play(ctx => { [523,659,784,1047].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='square';o.frequency.value=f;g.gain.setValueAtTime(.04,ctx.currentTime+i*.12);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.12+.25);o.start(ctx.currentTime+i*.12);o.stop(ctx.currentTime+i*.12+.25); }); }); },
  levelup() { this._play(ctx => { for(let i=0;i<8;i++){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=523*(1+i*.15);g.gain.setValueAtTime(.05,ctx.currentTime+i*.06);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.06+.15);o.start(ctx.currentTime+i*.06);o.stop(ctx.currentTime+i*.06+.15);} }); },
  combo(n) { this._play(ctx => { const f=800+Math.min(n,10)*60;const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.setValueAtTime(f,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(f*1.3,ctx.currentTime+.1);g.gain.setValueAtTime(.06,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.12);o.start();o.stop(ctx.currentTime+.12); }); },
  gameStart() { this._play(ctx => { [392,523,659,784].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.1+.2);o.start(ctx.currentTime+i*.1);o.stop(ctx.currentTime+i*.1+.2); }); }); },
  gameOver() { this._play(ctx => { [523,440,349,262].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.15);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.15+.3);o.start(ctx.currentTime+i*.15);o.stop(ctx.currentTime+i*.15+.3); }); }); }
};

// ===== SVG ÎîïÏÖîÎÑàÎ¶¨ =====
const SHOP_SVG = {
  'Î∞ÄÍ∞ÄÎ£®': `<svg viewBox="0 0 80 80"><defs><linearGradient id="flourBag" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#fefce8"/><stop offset="100%" stop-color="#fef9c3"/></linearGradient></defs><rect x="15" y="22" width="50" height="48" rx="4" fill="url(#flourBag)" stroke="#d4a574" stroke-width="2"/><rect x="15" y="22" width="50" height="12" rx="4" fill="#d4a574"/><path d="M30,18 Q33,8 40,10 Q47,8 50,18" fill="none" stroke="#ca8a04" stroke-width="2.5" stroke-linecap="round"/><path d="M36,12 L38,6 M40,11 L40,4 M44,12 L42,6" stroke="#eab308" stroke-width="1.5" stroke-linecap="round"/><circle cx="38" cy="8" r="2" fill="#eab308"/><circle cx="42" cy="6" r="1.5" fill="#eab308"/><text x="40" y="56" text-anchor="middle" font-size="10" font-weight="800" fill="#78350f">Î∞ÄÍ∞ÄÎ£®</text><rect x="24" y="40" width="32" height="8" rx="2" fill="rgba(255,255,255,.6)"/></svg>`,
  'ÏïôÍ∏à': `<svg viewBox="0 0 80 80"><defs><radialGradient id="beanPaste" cx="50%" cy="40%"><stop offset="0%" stop-color="#991b1b"/><stop offset="100%" stop-color="#7f1d1d"/></radialGradient></defs><ellipse cx="40" cy="52" rx="28" ry="14" fill="#a16207" stroke="#854d0e" stroke-width="1.5"/><ellipse cx="40" cy="48" rx="26" ry="16" fill="url(#beanPaste)"/><ellipse cx="40" cy="45" rx="22" ry="12" fill="#991b1b"/><ellipse cx="34" cy="43" rx="6" ry="3" fill="rgba(255,255,255,.15)" transform="rotate(-15,34,43)"/><path d="M28,32 Q30,24 34,28" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="2" stroke-linecap="round"><animate attributeName="opacity" values=".3;.1;.3" dur="2s" repeatCount="indefinite"/></path><path d="M40,30 Q42,22 44,28" fill="none" stroke="rgba(255,255,255,.25)" stroke-width="2" stroke-linecap="round"><animate attributeName="opacity" values=".25;.08;.25" dur="2.5s" repeatCount="indefinite"/></path><path d="M50,33 Q52,26 54,30" fill="none" stroke="rgba(255,255,255,.2)" stroke-width="2" stroke-linecap="round"><animate attributeName="opacity" values=".2;.05;.2" dur="1.8s" repeatCount="indefinite"/></path></svg>`,
  'Í∞ÄÏä§': `<svg viewBox="0 0 80 80"><defs><linearGradient id="gasTank" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#fb923c"/><stop offset="100%" stop-color="#ea580c"/></linearGradient></defs><rect x="22" y="24" width="36" height="44" rx="8" fill="url(#gasTank)" stroke="#c2410c" stroke-width="2"/><rect x="22" y="24" width="36" height="14" rx="8" fill="#f97316"/><rect x="32" y="18" width="16" height="10" rx="3" fill="#9a3412" stroke="#7c2d12" stroke-width="1"/><rect x="36" y="14" width="8" height="6" rx="2" fill="#78350f"/><path d="M36,50 Q40,40 44,50 Q40,58 36,50Z" fill="#fbbf24"><animate attributeName="d" values="M36,50 Q40,40 44,50 Q40,58 36,50Z;M34,48 Q40,36 46,48 Q40,60 34,48Z;M36,50 Q40,40 44,50 Q40,58 36,50Z" dur="0.8s" repeatCount="indefinite"/></path><path d="M38,48 Q40,44 42,48" fill="#fef08a"><animate attributeName="d" values="M38,48 Q40,44 42,48;M37,46 Q40,40 43,46;M38,48 Q40,44 42,48" dur="0.6s" repeatCount="indefinite"/></path></svg>`,
  'ÏÑ§ÌÉï': `<svg viewBox="0 0 80 80"><defs><linearGradient id="sugarBag" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#f1f5f9"/></linearGradient></defs><rect x="16" y="24" width="48" height="44" rx="4" fill="url(#sugarBag)" stroke="#cbd5e1" stroke-width="2"/><rect x="16" y="24" width="48" height="12" rx="4" fill="#e2e8f0"/><path d="M32,20 Q34,14 40,16 Q46,14 48,20" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round"/><text x="40" y="54" text-anchor="middle" font-size="10" font-weight="800" fill="#64748b">ÏÑ§ÌÉï</text><circle cx="26" cy="40" r="1.5" fill="#e2e8f0"><animate attributeName="opacity" values="1;.3;1" dur="1.5s" repeatCount="indefinite"/></circle><circle cx="54" cy="38" r="1" fill="#e2e8f0"><animate attributeName="opacity" values=".5;1;.5" dur="2s" repeatCount="indefinite"/></circle><polygon points="50,36 51,34 52,36 51.5,34.5 50.5,34.5" fill="#fef08a" opacity=".6"><animate attributeName="opacity" values=".6;.2;.6" dur="1.2s" repeatCount="indefinite"/></polygon></svg>`,
  'Î≤ÑÌÑ∞': `<svg viewBox="0 0 80 80"><defs><linearGradient id="butterBlock" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#fef08a"/><stop offset="100%" stop-color="#fbbf24"/></linearGradient></defs><rect x="12" y="32" width="56" height="30" rx="4" fill="url(#butterBlock)" stroke="#d97706" stroke-width="2"/><rect x="12" y="32" width="56" height="10" rx="4" fill="#fde68a"/><polygon points="12,62 8,66 64,66 68,62" fill="#f59e0b" opacity=".4"/><rect x="10" y="26" width="60" height="8" rx="2" fill="#e5e7eb" stroke="#cbd5e1" stroke-width="1"/><text x="40" y="28" text-anchor="middle" font-size="5" fill="#94a3b8">BUTTER</text><rect x="18" y="38" width="20" height="2" rx="1" fill="rgba(255,255,255,.4)"/></svg>`,
  'ÌÅ¨Î¶º': `<svg viewBox="0 0 80 80"><defs><linearGradient id="creamCup" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#fce7f3"/></linearGradient></defs><path d="M22,40 L18,68 Q18,72 22,72 L58,72 Q62,72 62,68 L58,40Z" fill="url(#creamCup)" stroke="#f9a8d4" stroke-width="2"/><ellipse cx="40" cy="40" rx="20" ry="6" fill="#fce7f3" stroke="#f9a8d4" stroke-width="1.5"/><path d="M28,38 Q32,28 40,32 Q48,28 52,38" fill="#fff" stroke="#fbcfe8" stroke-width="1"/><path d="M34,32 Q38,22 40,26 Q42,22 46,32" fill="#fff" stroke="#fbcfe8" stroke-width="1"/><circle cx="40" cy="24" r="3" fill="#fff" stroke="#fbcfe8" stroke-width="1"/><circle cx="40" cy="22" r="1.5" fill="#f9a8d4"/></svg>`
};

const PRODUCT_SVG = {
  'ÏÇ¨ÌÉï': `<svg viewBox="0 0 80 80"><circle cx="40" cy="36" r="16" fill="#ef4444" stroke="#dc2626" stroke-width="2"/><circle cx="40" cy="36" r="12" fill="none" stroke="#fbbf24" stroke-width="3" stroke-dasharray="6 4" transform="rotate(30,40,36)"/><ellipse cx="35" cy="30" rx="4" ry="2.5" fill="rgba(255,255,255,.35)" transform="rotate(-30,35,30)"/><rect x="38" y="50" width="4" height="22" rx="2" fill="#d4a574" stroke="#a16207" stroke-width="1"/></svg>`,
  'Í≥ºÏûê': `<svg viewBox="0 0 80 80"><circle cx="40" cy="40" r="22" fill="#d4a574" stroke="#a16207" stroke-width="2"/><circle cx="40" cy="40" r="18" fill="#c2956a"/><circle cx="30" cy="34" r="3" fill="#78350f"/><circle cx="42" cy="30" r="2.5" fill="#78350f"/><circle cx="50" cy="40" r="2.5" fill="#78350f"/><circle cx="36" cy="48" r="3" fill="#78350f"/><circle cx="48" cy="50" r="2" fill="#78350f"/><circle cx="32" cy="42" r="2" fill="#78350f"/></svg>`,
  'ÏïÑÏù¥Ïä§ÌÅ¨Î¶º': `<svg viewBox="0 0 80 80"><polygon points="32,48 48,48 40,76" fill="#d4a574" stroke="#a16207" stroke-width="1.5"/><circle cx="32" cy="40" r="12" fill="#86efac" stroke="#22c55e" stroke-width="1.5"/><circle cx="48" cy="40" r="12" fill="#fda4af" stroke="#fb7185" stroke-width="1.5"/><circle cx="40" cy="26" r="12" fill="#fde68a" stroke="#fbbf24" stroke-width="1.5"/><circle cx="40" cy="18" r="3" fill="#ef4444"/></svg>`,
  'Ïù∏Ìòï': `<svg viewBox="0 0 80 80"><circle cx="40" cy="28" r="16" fill="#d4a574" stroke="#a16207" stroke-width="2"/><circle cx="30" cy="22" r="6" fill="#d4a574" stroke="#a16207" stroke-width="1.5"/><circle cx="50" cy="22" r="6" fill="#d4a574" stroke="#a16207" stroke-width="1.5"/><ellipse cx="40" cy="56" rx="16" ry="18" fill="#d4a574" stroke="#a16207" stroke-width="2"/><circle cx="34" cy="26" r="2.5" fill="#1e293b"/><circle cx="46" cy="26" r="2.5" fill="#1e293b"/><circle cx="35" cy="27" r="1" fill="#fff"/><circle cx="47" cy="27" r="1" fill="#fff"/><ellipse cx="40" cy="32" rx="3" ry="2" fill="#78350f"/><path d="M36,36 Q40,40 44,36" fill="none" stroke="#78350f" stroke-width="1.5" stroke-linecap="round"/><rect x="30" y="44" width="8" height="3" rx="1.5" fill="#ef4444"/></svg>`,
  'Í≥µ': `<svg viewBox="0 0 80 80"><circle cx="40" cy="40" r="24" fill="#fff" stroke="#e2e8f0" stroke-width="2"/><path d="M40,16 L40,64 M16,40 L64,40" stroke="#1e293b" stroke-width="2"/><path d="M22,22 Q40,30 58,22 M22,58 Q40,50 58,58" stroke="#1e293b" stroke-width="1.5" fill="none"/><circle cx="40" cy="40" r="24" fill="none" stroke="#1e293b" stroke-width="2.5"/></svg>`,
  'ÏÉâÏó∞ÌïÑ': `<svg viewBox="0 0 80 80"><g transform="translate(16,10) rotate(-15,24,30)"><rect x="8" y="12" width="10" height="50" rx="1" fill="#ef4444" stroke="#dc2626" stroke-width="1"/><polygon points="8,62 18,62 13,74" fill="#fde68a"/></g><g transform="translate(30,8)"><rect x="8" y="12" width="10" height="50" rx="1" fill="#3b82f6" stroke="#2563eb" stroke-width="1"/><polygon points="8,62 18,62 13,74" fill="#fde68a"/></g><g transform="translate(44,10) rotate(15,12,30)"><rect x="8" y="12" width="10" height="50" rx="1" fill="#eab308" stroke="#ca8a04" stroke-width="1"/><polygon points="8,62 18,62 13,74" fill="#fde68a"/></g></svg>`,
  'ÌíçÏÑ†': `<svg viewBox="0 0 80 80"><defs><radialGradient id="balloonRd" cx="35%" cy="30%"><stop offset="0%" stop-color="#fca5a5"/><stop offset="100%" stop-color="#ef4444"/></radialGradient></defs><ellipse cx="40" cy="32" rx="18" ry="22" fill="url(#balloonRd)" stroke="#dc2626" stroke-width="1.5"/><ellipse cx="34" cy="24" rx="5" ry="3" fill="rgba(255,255,255,.3)" transform="rotate(-20,34,24)"/><polygon points="36,54 44,54 40,58" fill="#dc2626"/><path d="M40,58 Q42,64 38,70 Q42,72 40,76" fill="none" stroke="#94a3b8" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  'Ïä§Ìã∞Ïª§': `<svg viewBox="0 0 80 80"><polygon points="40,8 47,28 68,28 51,40 58,60 40,48 22,60 29,40 12,28 33,28" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/><polygon points="40,16 45,28 56,28 47,36 50,48 40,42 30,48 33,36 24,28 35,28" fill="#fde68a"/><circle cx="52" cy="22" r="3" fill="#fff" opacity=".6"><animate attributeName="opacity" values=".6;.2;.6" dur="1.5s" repeatCount="indefinite"/></circle></svg>`,
  'ÏöîÍµ¨Î•¥Ìä∏': `<svg viewBox="0 0 80 80"><defs><linearGradient id="yogurt" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#fce7f3"/><stop offset="100%" stop-color="#f9a8d4"/></linearGradient></defs><path d="M26,24 L22,70 Q22,74 26,74 L54,74 Q58,74 58,70 L54,24Z" fill="url(#yogurt)" stroke="#ec4899" stroke-width="2"/><rect x="24" y="20" width="32" height="8" rx="3" fill="#f472b6"/><ellipse cx="40" cy="24" rx="16" ry="4" fill="#fbcfe8"/><text x="40" y="52" text-anchor="middle" font-size="7" font-weight="700" fill="#be185d">ÏöîÍµ¨Î•¥Ìä∏</text></svg>`,
  'Ï†§Î¶¨': `<svg viewBox="0 0 80 80"><ellipse cx="40" cy="44" rx="16" ry="20" fill="#22c55e" stroke="#16a34a" stroke-width="2"/><ellipse cx="40" cy="40" rx="12" ry="14" fill="#4ade80"/><circle cx="34" cy="36" r="2.5" fill="#1e293b"/><circle cx="46" cy="36" r="2.5" fill="#1e293b"/><circle cx="35" cy="35" r="1" fill="#fff"/><circle cx="47" cy="35" r="1" fill="#fff"/><path d="M36,44 Q40,48 44,44" fill="none" stroke="#15803d" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  'Î°úÎ¥á': `<svg viewBox="0 0 80 80"><rect x="24" y="28" width="32" height="28" rx="4" fill="#94a3b8" stroke="#64748b" stroke-width="2"/><rect x="28" y="56" width="10" height="14" rx="2" fill="#94a3b8" stroke="#64748b" stroke-width="1.5"/><rect x="42" y="56" width="10" height="14" rx="2" fill="#94a3b8" stroke="#64748b" stroke-width="1.5"/><rect x="28" y="18" width="24" height="14" rx="4" fill="#64748b" stroke="#475569" stroke-width="2"/><circle cx="36" cy="24" r="3" fill="#3b82f6"><animate attributeName="fill" values="#3b82f6;#60a5fa;#3b82f6" dur="1.5s" repeatCount="indefinite"/></circle><circle cx="44" cy="24" r="3" fill="#3b82f6"><animate attributeName="fill" values="#3b82f6;#60a5fa;#3b82f6" dur="1.5s" repeatCount="indefinite" begin="0.3s"/></circle><line x1="40" y1="10" x2="40" y2="18" stroke="#64748b" stroke-width="2"/><circle cx="40" cy="8" r="3" fill="#ef4444"><animate attributeName="fill" values="#ef4444;#fbbf24;#ef4444" dur="2s" repeatCount="indefinite"/></circle></svg>`,
  'Ï£ºÏä§': `<svg viewBox="0 0 80 80"><defs><linearGradient id="juiceBox" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="40%" stop-color="#fff"/><stop offset="40%" stop-color="#fb923c"/><stop offset="100%" stop-color="#ea580c"/></linearGradient></defs><rect x="20" y="16" width="40" height="54" rx="4" fill="url(#juiceBox)" stroke="#c2410c" stroke-width="2"/><text x="40" y="52" text-anchor="middle" font-size="7" font-weight="800" fill="#fff">JUICE</text><circle cx="40" cy="42" r="8" fill="#fdba74"/><path d="M50,20 Q56,16 54,10 L56,8" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round"/></svg>`
};

const TRADE_SVG = {
  'ÏÇ¨Í≥º': `<svg viewBox="0 0 80 80"><path d="M40,20 Q20,20 18,44 Q16,64 40,68 Q64,64 62,44 Q60,20 40,20Z" fill="#ef4444" stroke="#dc2626" stroke-width="2"/><path d="M38,20 Q36,10 42,8 L44,12 Q40,14 40,20" fill="#22c55e"/><ellipse cx="32" cy="36" rx="6" ry="4" fill="rgba(255,255,255,.25)" transform="rotate(-20,32,36)"/></svg>`,
  'Îπµ': `<svg viewBox="0 0 80 80"><defs><linearGradient id="breadG" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#d4a574"/><stop offset="100%" stop-color="#a16207"/></linearGradient></defs><ellipse cx="40" cy="48" rx="28" ry="16" fill="url(#breadG)" stroke="#854d0e" stroke-width="2"/><ellipse cx="40" cy="44" rx="26" ry="14" fill="#d4a574"/><path d="M20,42 Q30,36 40,42 Q50,36 60,42" fill="none" stroke="#a16207" stroke-width="1.5"/></svg>`,
  'Ïö∞Ïú†': `<svg viewBox="0 0 80 80"><rect x="22" y="24" width="36" height="46" rx="4" fill="#fff" stroke="#93c5fd" stroke-width="2"/><rect x="22" y="24" width="36" height="16" rx="4" fill="#dbeafe"/><polygon points="30,18 50,18 48,12 32,12" fill="#fff" stroke="#93c5fd" stroke-width="1.5"/><rect x="26" y="46" width="28" height="16" rx="2" fill="#bfdbfe"/><text x="40" y="58" text-anchor="middle" font-size="8" font-weight="800" fill="#1e40af">Ïö∞Ïú†</text></svg>`,
  'ÏÉùÏÑ†': `<svg viewBox="0 0 80 80"><path d="M14,40 Q24,20 50,24 Q68,28 66,40 Q68,52 50,56 Q24,60 14,40Z" fill="#60a5fa" stroke="#3b82f6" stroke-width="2"/><path d="M14,40 Q8,32 12,24 L14,40 L12,56 Q8,48 14,40Z" fill="#93c5fd" stroke="#3b82f6" stroke-width="1.5"/><circle cx="56" cy="38" r="3.5" fill="#fff" stroke="#1e293b" stroke-width="1.5"/><circle cx="57" cy="37" r="1.5" fill="#1e293b"/></svg>`,
  'Îã¨Í±Ä': `<svg viewBox="0 0 80 80"><ellipse cx="40" cy="44" rx="18" ry="22" fill="#fef3c7" stroke="#d4a574" stroke-width="2"/><ellipse cx="40" cy="42" rx="16" ry="20" fill="#fefce8"/><ellipse cx="34" cy="34" rx="6" ry="4" fill="rgba(255,255,255,.4)" transform="rotate(-15,34,34)"/></svg>`,
  'ÏºÄÏù¥ÌÅ¨': `<svg viewBox="0 0 80 80"><rect x="14" y="40" width="52" height="28" rx="6" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/><rect x="14" y="40" width="52" height="10" rx="6" fill="#fbcfe8"/><path d="M14,50 Q22,46 30,50 Q38,46 46,50 Q54,46 66,50" fill="none" stroke="#f9a8d4" stroke-width="2"/><rect x="18" y="32" width="44" height="12" rx="4" fill="#fda4af" stroke="#ec4899" stroke-width="1.5"/><rect x="38" y="18" width="4" height="16" rx="1" fill="#fbbf24"/><path d="M38,18 Q40,10 42,18" fill="#ef4444"><animate attributeName="d" values="M38,18 Q40,10 42,18;M37,16 Q40,8 43,16;M38,18 Q40,10 42,18" dur="1s" repeatCount="indefinite"/></path></svg>`,
  'ÍΩÉ': `<svg viewBox="0 0 80 80"><line x1="40" y1="46" x2="40" y2="72" stroke="#16a34a" stroke-width="3" stroke-linecap="round"/><circle cx="40" cy="32" r="8" fill="#fbbf24"/><circle cx="40" cy="20" r="8" fill="#f9a8d4" stroke="#ec4899" stroke-width="1"/><circle cx="50" cy="26" r="8" fill="#f9a8d4" stroke="#ec4899" stroke-width="1"/><circle cx="48" cy="38" r="8" fill="#f9a8d4" stroke="#ec4899" stroke-width="1"/><circle cx="32" cy="38" r="8" fill="#f9a8d4" stroke="#ec4899" stroke-width="1"/><circle cx="30" cy="26" r="8" fill="#f9a8d4" stroke="#ec4899" stroke-width="1"/><circle cx="40" cy="32" r="6" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/></svg>`,
  'ÎÇòÎ¨¥': `<svg viewBox="0 0 80 80"><rect x="34" y="50" width="12" height="22" rx="2" fill="#854d0e" stroke="#78350f" stroke-width="1.5"/><path d="M40,10 L60,36 L52,36 L64,52 L16,52 L28,36 L20,36Z" fill="#22c55e" stroke="#16a34a" stroke-width="2"/><path d="M40,10 L50,26 L44,26 L54,40 L26,40 L36,26 L30,26Z" fill="#4ade80"/></svg>`,
  'Ïû•ÎÇúÍ∞ê': `<svg viewBox="0 0 80 80"><rect x="18" y="44" width="44" height="22" rx="6" fill="#3b82f6" stroke="#2563eb" stroke-width="2"/><rect x="24" y="34" width="32" height="14" rx="3" fill="#ef4444" stroke="#dc2626" stroke-width="1.5"/><circle cx="28" cy="66" r="6" fill="#1e293b"/><circle cx="52" cy="66" r="6" fill="#1e293b"/></svg>`,
  'Î≥ÑÏÇ¨ÌÉï': `<svg viewBox="0 0 80 80"><polygon points="40,10 46,30 68,30 50,42 56,62 40,50 24,62 30,42 12,30 34,30" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/><polygon points="40,18 44,30 56,30 47,38 50,50 40,44 30,50 33,38 24,30 36,30" fill="#fde68a"/></svg>`
};

const COIN_SVG = {
  'coin10': `<svg viewBox="0 0 80 80"><circle cx="40" cy="40" r="36" fill="url(#coinCopper)" stroke="rgba(255,255,255,.5)" stroke-width="2"/><circle cx="40" cy="40" r="30" fill="none" stroke="rgba(255,255,255,.2)" stroke-width="1.5" stroke-dasharray="3 3"/><text x="40" y="48" text-anchor="middle" font-size="22" font-weight="900" fill="#fff" style="text-shadow:0 1px 3px rgba(0,0,0,.5)">10</text></svg>`,
  'coin50': `<svg viewBox="0 0 80 80"><circle cx="40" cy="40" r="36" fill="url(#coinGold)" stroke="rgba(255,255,255,.6)" stroke-width="2.5"/><circle cx="40" cy="40" r="30" fill="none" stroke="rgba(255,255,255,.25)" stroke-width="1.5"/><text x="40" y="48" text-anchor="middle" font-size="22" font-weight="900" fill="#fff" style="text-shadow:0 1px 3px rgba(0,0,0,.5)">50</text></svg>`,
  'coin100': `<svg viewBox="0 0 80 80"><circle cx="40" cy="40" r="36" fill="url(#coinGreen)" stroke="rgba(255,255,255,.6)" stroke-width="2.5"/><circle cx="40" cy="40" r="30" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="1.5"/><text x="40" y="47" text-anchor="middle" font-size="18" font-weight="900" fill="#fff" style="text-shadow:0 1px 3px rgba(0,0,0,.5)">100</text></svg>`,
  'coin500': `<svg viewBox="0 0 80 80"><circle cx="40" cy="40" r="36" fill="url(#coinGold)" stroke="rgba(255,255,255,.7)" stroke-width="3"/><circle cx="40" cy="40" r="30" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="2"/><polygon points="40,16 42,22 48,22 43,26 45,32 40,28 35,32 37,26 32,22 38,22" fill="rgba(255,255,255,.3)"/><text x="40" y="50" text-anchor="middle" font-size="20" font-weight="900" fill="#fff" style="text-shadow:0 2px 4px rgba(0,0,0,.5)">500</text></svg>`
};

// ===== ÌíÄÎ∞îÎîî ÎßàÏä§ÏΩîÌä∏ ÏΩîÏù∏Ïù¥ (ÌÉ≠Î≥Ñ) =====
function getMascotSVG(tab) {
  const extra = {
    fish: `<g transform="translate(78,42) scale(0.5)"><path d="M0,10 Q12,-2 24,4 Q30,10 28,20 Q24,28 12,30 Q0,28 -4,20 Q-6,14 0,10Z" fill="#d4a574" stroke="#a16207" stroke-width="2"/><ellipse cx="8" cy="14" rx="2" ry="1.5" fill="#78350f" opacity=".5"/></g>`,
    wallet: `<g transform="translate(80,44) scale(0.5)"><rect x="0" y="0" width="28" height="22" rx="4" fill="#a78bfa" stroke="#7c3aed" stroke-width="2"/><rect x="0" y="0" width="28" height="8" rx="4" fill="#c4b5fd"/><circle cx="22" cy="14" r="4" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/></g>`,
    trade: `<g transform="translate(80,42) scale(0.5)"><rect x="2" y="10" width="26" height="20" rx="3" fill="#ef4444" stroke="#dc2626" stroke-width="1.5"/><rect x="0" y="6" width="30" height="8" rx="2" fill="#f87171"/><line x1="15" y1="6" x2="15" y2="30" stroke="#fbbf24" stroke-width="3"/><line x1="0" y1="10" x2="30" y2="10" stroke="#fbbf24" stroke-width="3"/></g>`,
    record: `<g transform="translate(80,40) scale(0.5)"><path d="M8,0 L8,12 Q8,20 15,22 Q22,20 22,12 L22,0Z" fill="#fbbf24" stroke="#f59e0b" stroke-width="1.5"/><rect x="11" y="22" width="8" height="4" rx="1" fill="#d97706"/><rect x="8" y="26" width="14" height="4" rx="2" fill="#f59e0b"/></g>`
  }[tab] || '';
  return `<svg viewBox="0 0 100 140">
    <rect x="28" y="108" width="16" height="20" rx="8" fill="#fbbf24" stroke="#f59e0b" stroke-width="1.5"><animateTransform attributeName="transform" type="rotate" values="-3,36,108;3,36,108;-3,36,108" dur="0.8s" repeatCount="indefinite"/></rect>
    <rect x="56" y="108" width="16" height="20" rx="8" fill="#fbbf24" stroke="#f59e0b" stroke-width="1.5"><animateTransform attributeName="transform" type="rotate" values="3,64,108;-3,64,108;3,64,108" dur="0.8s" repeatCount="indefinite"/></rect>
    <ellipse cx="36" cy="130" rx="12" ry="6" fill="#92400e"/>
    <ellipse cx="64" cy="130" rx="12" ry="6" fill="#92400e"/>
    <circle cx="50" cy="62" r="40" fill="#fbbf24" stroke="#f59e0b" stroke-width="3"/>
    <circle cx="50" cy="62" r="32" fill="#fde68a"/>
    <text x="50" y="80" text-anchor="middle" font-size="22" font-weight="900" fill="#92400e" opacity=".3">‚Ç©</text>
    <rect x="4" y="56" width="14" height="8" rx="4" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/>
    <rect x="82" y="56" width="14" height="8" rx="4" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/>
    <ellipse cx="38" cy="52" rx="5" ry="5" fill="#1e293b"><animate attributeName="ry" values="5;0.5;5" dur="4s" repeatCount="indefinite" begin="1s"/></ellipse>
    <ellipse cx="62" cy="52" rx="5" ry="5" fill="#1e293b"><animate attributeName="ry" values="5;0.5;5" dur="4s" repeatCount="indefinite" begin="1s"/></ellipse>
    <circle cx="40" cy="50" r="2" fill="#fff"/>
    <circle cx="64" cy="50" r="2" fill="#fff"/>
    <ellipse cx="28" cy="64" rx="6" ry="4" fill="#f9a8d4" opacity=".5"/>
    <ellipse cx="72" cy="64" rx="6" ry="4" fill="#f9a8d4" opacity=".5"/>
    <path id="mascot-mouth-${tab}" d="M42,72 Q50,80 58,72" fill="none" stroke="#92400e" stroke-width="2.5" stroke-linecap="round"/>
    ${extra}
  </svg>`;
}

function showScorePopup(container, points, x, y) {
  const el = document.createElement('div');
  el.className = 'score-popup';
  el.textContent = (points > 0 ? '+' : '') + points;
  el.style.left = x + 'px'; el.style.top = y + 'px';
  container.appendChild(el);
  setTimeout(() => el.remove(), 900);
}
function showLevelUp(lv) {
  SFX.levelup();
  const ov = document.createElement('div');
  ov.className = 'levelup-overlay';
  ov.innerHTML = `<div class="levelup-box">üí∞ Î†àÎ≤® ${lv} Îã¨ÏÑ±!</div>`;
  document.body.appendChild(ov);
  setTimeout(() => ov.remove(), 800);
}
function setMascotEmotion(viewId, emotion) {
  const mouth = document.getElementById('mascot-mouth-' + currentTab);
  const bubble = document.getElementById('bubble-fish');
  if (!mouth) return;
  if (emotion === 'happy') {
    mouth.setAttribute('d', 'M42,72 Q50,82 58,72');
    if (bubble) { bubble.textContent = ['ÎåÄÎ∞ï!','Î∂ÄÏûê!','Ïß±!','ÏôÄ!'][Math.floor(Math.random()*4)]; bubble.classList.add('show'); setTimeout(() => bubble.classList.remove('show'), 2000); }
  } else if (emotion === 'worried') {
    mouth.setAttribute('d', 'M44,78 Q50,70 56,78');
    if (bubble) { bubble.textContent = 'Ïïó!'; bubble.classList.add('show'); setTimeout(() => bubble.classList.remove('show'), 1500); }
  } else {
    mouth.setAttribute('d', 'M42,72 Q50,80 58,72');
  }
  setTimeout(() => { if (mouth) mouth.setAttribute('d', 'M42,72 Q50,80 58,72'); }, 2500);
}

// ===== TTS =====
let audioQueue = [];
let isSpeaking = false;
function speak(text) {
  if (!soundEnabled) return;
  speechSynthesis.cancel();
  audioQueue = [];
  isSpeaking = false;
  audioQueue.push(text);
  processQueue();
}
function processQueue() {
  if (isSpeaking || !audioQueue.length) return;
  isSpeaking = true;
  const u = new SpeechSynthesisUtterance(audioQueue.shift());
  u.lang = 'ko-KR'; u.rate = 1.0; u.pitch = 1.1;
  u.onend = () => { isSpeaking = false; processQueue(); };
  u.onerror = () => { isSpeaking = false; processQueue(); };
  speechSynthesis.speak(u);
}
function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('sb-sound').textContent = soundEnabled ? 'üîä' : 'üîá';
  if (!soundEnabled) speechSynthesis.cancel();
}

// ===== ÌîÑÎ°úÌïÑ =====
let _prevMainLevel = 1;
function updateProfile() {
  document.getElementById('pf-name').textContent = profile.name;
  document.getElementById('pf-char').textContent = profile.char;
  const lv = Math.floor(profile.totalCorrect / 10) + 1;
  if (lv > _prevMainLevel && _prevMainLevel > 0) showLevelUp(lv);
  _prevMainLevel = lv;
  document.getElementById('pf-level').textContent = lv;
  const prog = (profile.totalCorrect % 10);
  document.getElementById('pf-done').textContent = prog;
  document.getElementById('pf-total').textContent = 10;
  document.getElementById('pf-bar').style.width = (prog * 10) + '%';
}
function changeName() {
  const n = prompt('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', profile.name);
  if (n && n.trim()) { profile.name = n.trim(); LS.setItem('econName', profile.name); updateProfile(); }
}
function showCharModal() {
  document.getElementById('char-modal').classList.remove('hidden');
  const chars = ['üßí','üë¶','üëß','ü¶∏‚Äç‚ôÇÔ∏è','ü¶∏‚Äç‚ôÄÔ∏è','üßô‚Äç‚ôÇÔ∏è','üê±','üê∂','ü¶ä','üêª','üê∞','üê∏','ü¶Å','üêØ','üêº'];
  const g = document.getElementById('char-grid');
  g.innerHTML = chars.map(c => `<div class="char-item${c===profile.char?' selected':''}" onclick="pickChar('${c}')">${c}</div>`).join('');
}
function hideCharModal() { document.getElementById('char-modal').classList.add('hidden'); }
function pickChar(c) { profile.char = c; LS.setItem('econChar', c); updateProfile(); hideCharModal(); }
function showAdmin() { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('adm-name').value = profile.name; }
function hideAdmin() { document.getElementById('admin-modal').classList.add('hidden'); }
function saveProfile() {
  const n = document.getElementById('adm-name').value.trim();
  if (n) { profile.name = n; LS.setItem('econName', n); updateProfile(); }
  hideAdmin();
}
function resetAll() {
  if (!confirm('Î™®Îì† Í∏∞Î°ùÏù¥ ÏÇ¨ÎùºÏßëÎãàÎã§. Ï†ïÎßê Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?')) return;
  ['econName','econChar','econCorrect','econPlayed',
   'fishGames','fishBestProfit','fishLifetimeSold',
   'walletBestStreak','walletBestSaved','walletGames',
   'tradeSuccess','tradeGames','tradeTotalTrades'].forEach(k => LS.removeItem(k));
  location.reload();
}
function saveStats() {
  LS.setItem('econCorrect', profile.totalCorrect);
  LS.setItem('econPlayed', profile.totalPlayed);
  LS.setItem('fishGames', fish.games);
  LS.setItem('fishBestProfit', fish.bestProfit);
  LS.setItem('fishLifetimeSold', fish.lifetimeSold);
  LS.setItem('walletBestStreak', wallet.bestStreak);
  LS.setItem('walletBestSaved', wallet.bestSaved);
  LS.setItem('walletGames', wallet.games);
  LS.setItem('tradeSuccess', trade.success);
  LS.setItem('tradeGames', trade.games);
  LS.setItem('tradeTotalTrades', trade.lifetimeTrades);
}

// ===== ÌÉ≠ Ï†ÑÌôò =====
function switchTab(tab) {
  speechSynthesis.cancel();
  audioQueue = [];
  isSpeaking = false;
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', ['fish','wallet','trade','record'][i] === tab);
  });
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector('.' + tab + '-side').classList.add('active');
  document.querySelectorAll('.game-view').forEach(v => v.classList.remove('active'));
  document.querySelector('.' + tab + '-view').classList.add('active');
  updateActionButtons();
  updateMascotTab(tab);
  if (tab === 'record') updateRecords();
}

function updateMascotTab(tab) {
  const container = document.getElementById('mascot-svg-container');
  if (container) container.innerHTML = getMascotSVG(tab);
  // Adjust mascot position per tab to avoid overlap
  const mascot = document.getElementById('mascot-main');
  if (mascot) {
    if (tab === 'wallet') {
      mascot.style.right = '10px';
      mascot.style.top = '0px';
    } else {
      mascot.style.right = '180px';
      mascot.style.top = '4px';
    }
  }
}

function updateActionButtons() {
  const a1 = document.getElementById('act1');
  const a2 = document.getElementById('act2');
  const a3 = document.getElementById('act3');
  if (currentTab === 'fish') {
    a1.innerHTML = '<span class="icon">üí°</span>ÌûåÌä∏'; a1.className = 'action-btn btn-cyan'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">üîÑ</span>Îã§Ïãú'; a2.className = 'action-btn btn-green'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">‚è≠</span>Îã§Ïùå'; a3.className = 'action-btn btn-emerald'; a3.disabled = false;
  } else if (currentTab === 'wallet') {
    a1.innerHTML = '<span class="icon">‚úÖ</span>Íµ¨Îß§!'; a1.className = 'action-btn btn-green'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">üóë</span>ÎπÑÏö∞Í∏∞'; a2.className = 'action-btn btn-red'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">‚è≠</span>Îã§Ïùå'; a3.className = 'action-btn btn-emerald'; a3.disabled = false;
  } else if (currentTab === 'trade') {
    a1.innerHTML = '<span class="icon">üí°</span>ÌûåÌä∏'; a1.className = 'action-btn btn-cyan'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">üîÑ</span>Îã§Ïãú'; a2.className = 'action-btn btn-green'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">‚è≠</span>Îã§Ïùå'; a3.className = 'action-btn btn-emerald'; a3.disabled = false;
  } else {
    a1.innerHTML = '<span class="icon">üìä</span>Í∏∞Î°ù'; a1.className = 'action-btn btn-cyan'; a1.disabled = true;
    a2.innerHTML = '<span class="icon">‚Äî</span>‚Äî'; a2.className = 'action-btn btn-green'; a2.disabled = true;
    a3.innerHTML = '<span class="icon">‚Äî</span>‚Äî'; a3.className = 'action-btn btn-red'; a3.disabled = true;
  }
}

function actionBtn(n) {
  if (currentTab === 'fish') {
    if (n === 1) fishHint();
    else if (n === 2) fishRestart();
    else fishSkipDay();
  } else if (currentTab === 'wallet') {
    if (n === 1) walletConfirm();
    else if (n === 2) walletClearCart();
    else walletNewRound();
  } else if (currentTab === 'trade') {
    if (n === 1) tradeHint();
    else if (n === 2) initTradeGame();
    else initTradeGame();
  }
}

// ===== SVG Ìó¨Ìçº =====
function weatherSVG(type) {
  const svgs = {
    'ÎßëÏùå': `<svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="28" fill="url(#sunGrad)"><animate attributeName="r" values="28;30;28" dur="2s" repeatCount="indefinite"/></circle>${[0,45,90,135,180,225,270,315].map(a=>`<line x1="60" y1="60" x2="${60+Math.cos(a*Math.PI/180)*46}" y2="${60+Math.sin(a*Math.PI/180)*46}" stroke="#fbbf24" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-width" values="4;6;4" dur="1.5s" begin="${a/360}s" repeatCount="indefinite"/></line>`).join('')}</svg>`,
    'ÌùêÎ¶º': `<svg viewBox="0 0 120 120"><circle cx="45" cy="72" r="14" fill="#fbbf24" opacity=".6"/><line x1="45" y1="52" x2="45" y2="46" stroke="#fbbf24" stroke-width="3" stroke-linecap="round" opacity=".6"/><line x1="32" y1="60" x2="28" y2="56" stroke="#fbbf24" stroke-width="3" stroke-linecap="round" opacity=".6"/><ellipse cx="65" cy="65" rx="30" ry="18" fill="url(#cloudGrad)"/><ellipse cx="48" cy="58" rx="18" ry="14" fill="#cbd5e1"/><ellipse cx="78" cy="60" rx="16" ry="12" fill="#e2e8f0"/></svg>`,
    'ÎπÑ': `<svg viewBox="0 0 120 120"><ellipse cx="60" cy="42" rx="32" ry="18" fill="url(#cloudGrad)"/><ellipse cx="40" cy="36" rx="20" ry="14" fill="#94a3b8"/><ellipse cx="76" cy="38" rx="18" ry="12" fill="#cbd5e1"/>${[35,50,65,80].map((x,i)=>`<line x1="${x}" y1="65" x2="${x-5}" y2="85" stroke="url(#rainGrad)" stroke-width="2.5" stroke-linecap="round"><animate attributeName="y1" values="65;70;65" dur="0.8s" begin="${i*0.2}s" repeatCount="indefinite"/><animate attributeName="y2" values="85;92;85" dur="0.8s" begin="${i*0.2}s" repeatCount="indefinite"/></line>`).join('')}</svg>`,
    'Îàà': `<svg viewBox="0 0 120 120"><ellipse cx="60" cy="38" rx="32" ry="18" fill="url(#snowGrad)"/><ellipse cx="40" cy="32" rx="20" ry="14" fill="#e0f2fe"/><ellipse cx="76" cy="34" rx="18" ry="12" fill="#bae6fd"/>${[30,50,70,90].map((x,i)=>`<text x="${x}" y="${75+i*5}" font-size="14" fill="#60a5fa" opacity=".8"><animate attributeName="y" values="${65+i*5};${95+i*5};${65+i*5}" dur="${1.5+i*0.3}s" repeatCount="indefinite"/><animate attributeName="opacity" values=".8;.3;.8" dur="${1.5+i*0.3}s" repeatCount="indefinite"/>‚ùÑ</text>`).join('')}</svg>`,
    'Ìè≠Ìíç': `<svg viewBox="0 0 120 120"><ellipse cx="60" cy="38" rx="34" ry="20" fill="url(#stormGrad)"/><ellipse cx="38" cy="32" rx="22" ry="16" fill="#4b5563"/><ellipse cx="78" cy="34" rx="18" ry="13" fill="#6b7280"/><polygon points="55,58 48,78 56,73 50,95 68,68 58,72 65,58" fill="#fbbf24"><animate attributeName="opacity" values="1;.4;1" dur=".3s" repeatCount="indefinite"/></polygon>${[35,80].map((x,i)=>`<line x1="${x}" y1="60" x2="${x-8}" y2="88" stroke="#60a5fa" stroke-width="2" stroke-linecap="round" opacity=".6"><animate attributeName="opacity" values=".6;0;.6" dur="0.6s" begin="${i*0.3}s" repeatCount="indefinite"/></line>`).join('')}</svg>`
  };
  return svgs[type] || `<span style="font-size:100px">${type}</span>`;
}

function tradeSvgArrow() {
  const uid = 'ar' + Math.random().toString(36).slice(2,6);
  return `<svg class="trade-arrow-svg" viewBox="0 0 100 50" xmlns="http://www.w3.org/2000/svg" style="filter:drop-shadow(0 0 6px rgba(16,185,129,.4))">
    <defs>
      <linearGradient id="${uid}" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#f87171"/><stop offset="50%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#34d399"/></linearGradient>
      <filter id="${uid}gl"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>
    <path d="M8,25 L72,25" stroke="url(#${uid})" stroke-width="6" stroke-linecap="round" filter="url(#${uid}gl)"/>
    <polygon points="70,12 92,25 70,38" fill="#34d399" filter="url(#${uid}gl)"/>
    <circle cx="12" cy="25" r="4" fill="#f87171" opacity=".6"><animate attributeName="cx" values="12;65;12" dur="1.5s" repeatCount="indefinite"/></circle>
    <circle cx="50" cy="25" r="3" fill="#fbbf24" opacity=".4"><animate attributeName="opacity" values=".4;.8;.4" dur="1s" repeatCount="indefinite"/></circle>
  </svg>`;
}

function svgFishGrill() {
  let fishBreads = '';
  const clipIds = [];
  for(let r=0;r<2;r++) for(let c=0;c<3;c++){
    const idx = r*3+c;
    const x=15+c*185, y=12+r*150;
    const clipId = 'fishClip'+idx;
    clipIds.push(clipId);
    // ÌãÄ Ïπ∏
    fishBreads += `<rect x="${x}" y="${y}" width="170" height="140" rx="10" fill="#44403c" stroke="#78350f" stroke-width="2"/>`;
    fishBreads += `<rect x="${x+4}" y="${y+4}" width="162" height="132" rx="8" fill="#292524"/>`;
    // Î¨ºÍ≥†Í∏∞ Î™®Ïñë Î∂ïÏñ¥Îπµ ‚Äî ÏßÑÏßú Î∂ïÏñ¥Îπµ Ïã§Î£®Ïó£
    const fx=x+85, fy=y+70;
    // Î¨ºÍ≥†Í∏∞ Î∞îÎîî Ìå®Ïä§ (Î®∏Î¶¨ ÏôºÏ™Ω, Íº¨Î¶¨ Ïò§Î•∏Ï™Ω)
    const fishPath = `M${fx-55},${fy} C${fx-55},${fy-30} ${fx-30},${fy-40} ${fx-10},${fy-38} C${fx+10},${fy-36} ${fx+30},${fy-42} ${fx+45},${fy-35} L${fx+55},${fy-28} C${fx+65},${fy-25} ${fx+70},${fy-15} ${fx+65},${fy-5} L${fx+55},${fy} L${fx+65},${fy+5} C${fx+70},${fy+15} ${fx+65},${fy+25} ${fx+55},${fy+28} L${fx+45},${fy+35} C${fx+30},${fy+42} ${fx+10},${fy+36} ${fx-10},${fy+38} C${fx-30},${fy+40} ${fx-55},${fy+30} ${fx-55},${fy} Z`;
    // clipPath Ï†ïÏùòÎäî defsÏóê ÎÑ£Ïùå
    clipIds[idx] = { id: clipId, path: fishPath };
    // Î¨ºÍ≥†Í∏∞ Î™∏Ï≤¥
    fishBreads += `<path d="${fishPath}" fill="#d4a574" stroke="#a16207" stroke-width="2"/>`;
    // Îì±ÏßÄÎäêÎü¨ÎØ∏
    fishBreads += `<path d="M${fx-5},${fy-38} C${fx},${fy-52} ${fx+15},${fy-50} ${fx+25},${fy-40} C${fx+18},${fy-42} ${fx+5},${fy-40} ${fx-5},${fy-38} Z" fill="#c2956a" stroke="#a16207" stroke-width="1"/>`;
    // Í∞ÄÏä¥ÏßÄÎäêÎü¨ÎØ∏
    fishBreads += `<path d="M${fx-20},${fy+10} C${fx-30},${fy+18} ${fx-25},${fy+28} ${fx-15},${fy+22} C${fx-18},${fy+16} ${fx-20},${fy+12} ${fx-20},${fy+10} Z" fill="#c2956a" stroke="#a16207" stroke-width="0.8" opacity=".7"/>`;
    // Íº¨Î¶¨ÏßÄÎäêÎü¨ÎØ∏ (Í∞àÎùºÏßÑ Î∂ÄÏ±ÑÍº¥)
    fishBreads += `<path d="M${fx+55},${fy-28} C${fx+72},${fy-35} ${fx+78},${fy-22} ${fx+65},${fy-5} Z" fill="#c2956a" stroke="#a16207" stroke-width="1"/>`;
    fishBreads += `<path d="M${fx+55},${fy+28} C${fx+72},${fy+35} ${fx+78},${fy+22} ${fx+65},${fy+5} Z" fill="#c2956a" stroke="#a16207" stroke-width="1"/>`;
    // ÏôÄÌîå Í≤©Ïûê (ÌÅ¥Î¶ΩÏúºÎ°ú Î¨ºÍ≥†Í∏∞ ÏïàÏóêÎßå)
    fishBreads += `<clipPath id="${clipId}"><path d="${fishPath}"/></clipPath>`;
    fishBreads += `<g clip-path="url(#${clipId})" opacity=".35">`;
    for(let gy=-40;gy<=40;gy+=16) fishBreads += `<line x1="${fx-60}" y1="${fy+gy}" x2="${fx+70}" y2="${fy+gy}" stroke="#a16207" stroke-width="1"/>`;
    for(let gx=-50;gx<=60;gx+=16) fishBreads += `<line x1="${fx+gx}" y1="${fy-50}" x2="${fx+gx}" y2="${fy+50}" stroke="#a16207" stroke-width="1"/>`;
    fishBreads += `</g>`;
    // Îàà
    fishBreads += `<circle cx="${fx-32}" cy="${fy-10}" r="5.5" fill="#78350f" opacity=".7"/>`;
    fishBreads += `<circle cx="${fx-30}" cy="${fy-12}" r="2" fill="rgba(255,255,255,.35)"/>`;
    // ÏïôÍ∏à (Ìïú ÏûÖ Î®πÏùÄ ÏûêÍµ≠ ‚Äî Í∞ÄÏö¥Îç∞Îßå)
    if(c===1) {
      fishBreads += `<path d="M${fx-52},${fy+8} Q${fx-48},${fy+22} ${fx-38},${fy+14}" fill="#7f1d1d" stroke="#991b1b" stroke-width="1"/>`;
    }
    // ÌïòÏù¥ÎùºÏù¥Ìä∏
    fishBreads += `<ellipse cx="${fx-12}" cy="${fy-22}" rx="16" ry="7" fill="rgba(255,255,255,.14)" transform="rotate(-10,${fx-12},${fy-22})"/>`;
    // Ï¶ùÍ∏∞
    fishBreads += `<path d="M${fx-10},${y+6} Q${fx-6},${y-8} ${fx},${y+3}" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"><animate attributeName="opacity" values=".35;.08;.35" dur="${1.5+r*0.3}s" repeatCount="indefinite"/></path>`;
    fishBreads += `<path d="M${fx+10},${y+8} Q${fx+14},${y-4} ${fx+18},${y+5}" fill="none" stroke="rgba(255,255,255,.25)" stroke-width="1.5" stroke-linecap="round"><animate attributeName="opacity" values=".25;.05;.25" dur="${1.8+c*0.2}s" repeatCount="indefinite"/></path>`;
  }
  return `<svg class="fish-grill-svg" viewBox="0 0 580 320" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="grillTop" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#57534e"/><stop offset="100%" stop-color="#292524"/></linearGradient></defs>
    <rect x="3" y="3" width="574" height="314" rx="16" fill="url(#grillTop)" stroke="#78350f" stroke-width="4"/>
    <rect x="8" y="8" width="564" height="304" rx="12" fill="#1c1917"/>
    <!-- ÏÜêÏû°Ïù¥ -->
    <rect x="250" y="0" width="80" height="8" rx="4" fill="#78350f"/>
    ${fishBreads}
  </svg>`;
}

function coinRainEffect(container) {
  const overlay = document.createElement('div');
  overlay.className = 'fish-coin-rain';
  overlay.style.position = 'relative';
  container.style.position = 'relative';
  container.appendChild(overlay);
  for(let i=0;i<12;i++){
    const coin = document.createElement('div');
    coin.className = 'fish-flying-coin';
    coin.innerHTML = `<svg viewBox="0 0 30 30" width="30" height="30"><circle cx="15" cy="15" r="13" fill="url(#coinGold)" stroke="rgba(255,255,255,.5)" stroke-width="1.5"/><text x="15" y="19" text-anchor="middle" font-size="9" font-weight="900" fill="#fff">$</text></svg>`;
    coin.style.cssText = `left:${10+Math.random()*80}%;top:${30+Math.random()*40}%;--tx:${(Math.random()-.5)*120}px;--ty:${-80-Math.random()*120}px;animation-delay:${Math.random()*0.5}s`;
    overlay.appendChild(coin);
  }
  setTimeout(()=>overlay.remove(), 1800);
}

function spawnSparkleAt(container, x, y) {
  for(let i=0;i<5;i++){
    const sp = document.createElement('div');
    sp.className = 'sparkle-effect';
    sp.innerHTML = `<svg viewBox="0 0 20 20" width="20" height="20"><polygon points="10,0 12,7 20,7 14,12 16,20 10,15 4,20 6,12 0,7 8,7" fill="#fbbf24" opacity=".8"/></svg>`;
    const angle = (Math.PI*2/5)*i;
    const dist = 15+Math.random()*20;
    sp.style.cssText = `left:${x+Math.cos(angle)*dist}px;top:${y+Math.sin(angle)*dist}px;position:absolute;animation-delay:${i*0.05}s`;
    container.appendChild(sp);
    setTimeout(()=>sp.remove(), 600);
  }
}

// ===== Î∂ïÏñ¥Îπµ Ïû•ÏÇ¨ =====
const INGREDIENTS = [
  { name: 'Î∞ÄÍ∞ÄÎ£®', emoji: 'üåæ', price: 500, desc: 'Î∞òÏ£ΩÏö©' },
  { name: 'ÏïôÍ∏à', emoji: 'ü´ò', price: 800, desc: 'Ìå•ÏïôÍ∏à' },
  { name: 'Í∞ÄÏä§', emoji: 'üî•', price: 300, desc: 'Î∂àÏù¥Ïïº' },
  { name: 'ÏÑ§ÌÉï', emoji: 'üç¨', price: 200, desc: 'Îã¨ÏΩ§' },
  { name: 'Î≤ÑÌÑ∞', emoji: 'üßà', price: 400, desc: 'Í≥†ÏÜå' },
  { name: 'ÌÅ¨Î¶º', emoji: 'üç¶', price: 600, desc: 'ÏäàÌÅ¨Î¶º' }
];

const WEATHERS = [
  { name: 'ÎßëÏùå', emoji: '‚òÄÔ∏è', desc: 'ÏÜêÎãòÏù¥ ÎßéÏù¥ ÏôÄÏöî!', multiplier: 1.5 },
  { name: 'ÌùêÎ¶º', emoji: '‚õÖ', desc: 'Î≥¥ÌÜµÏù¥ÏóêÏöî', multiplier: 1.0 },
  { name: 'ÎπÑ', emoji: 'üåßÔ∏è', desc: 'ÏÜêÎãòÏù¥ Ï†ÅÏñ¥Ïöî...', multiplier: 0.5 },
  { name: 'Îàà', emoji: '‚ùÑÔ∏è', desc: 'Ï∂îÏõåÏÑú Î∂ïÏñ¥Îπµ Ïù∏Í∏∞!', multiplier: 1.8 },
  { name: 'Ìè≠Ìíç', emoji: '‚õàÔ∏è', desc: 'ÏÜêÎãòÏù¥ Í±∞Ïùò ÏóÜÏñ¥Ïöî', multiplier: 0.3 }
];

function initFishGame() {
  fish.day = 1;
  fish.money = 5000;
  fish.totalProfit = 0;
  fish.totalSold = 0;
  fish.ingredients = [];
  fish.cost = 0;
  fish.dailyResults = [];
  showFishPhase('buy');
  renderShop();
  updateFishSide();
}

function showFishPhase(phase) {
  document.querySelectorAll('.fish-phase').forEach(p => p.classList.remove('active'));
  document.getElementById('fish-phase-' + phase).classList.add('active');
}

function renderShop() {
  const grid = document.getElementById('shop-grid');
  document.getElementById('fish-day-label').textContent = fish.day + 'ÏùºÏ∞®';
  document.getElementById('fish-budget-label').textContent = fish.money;
  fish.ingredients = [];
  fish.cost = 0;
  document.getElementById('fish-cost-label').textContent = 0;

  grid.innerHTML = INGREDIENTS.map((ing, i) =>
    `<div class="shop-item" id="shop-${i}" onclick="toggleIngredient(${i})">
      <div class="shop-emoji">${SHOP_SVG[ing.name] || ing.emoji}</div>
      <div class="shop-name">${ing.name}</div>
      <div class="shop-price">${ing.price}Ïõê</div>
    </div>`
  ).join('');

  // Î∂ïÏñ¥Îπµ ÌãÄ SVG ÌëúÏãú
  let grillContainer = document.querySelector('.fish-grill-container');
  if(!grillContainer){
    grillContainer = document.createElement('div');
    grillContainer.className = 'fish-grill-container';
    const buyPhase = document.getElementById('fish-phase-buy');
    const titleEl = buyPhase.querySelector('.fish-title');
    titleEl.insertAdjacentElement('afterend', grillContainer);
  }
  grillContainer.innerHTML = svgFishGrill();
}

function toggleIngredient(idx) {
  const el = document.getElementById('shop-' + idx);
  const ing = INGREDIENTS[idx];
  const inList = fish.ingredients.indexOf(idx);
  if (inList >= 0) {
    fish.ingredients.splice(inList, 1);
    fish.cost -= ing.price;
    el.classList.remove('selected');
  } else {
    if (fish.cost + ing.price > fish.money) {
      speak('ÎèàÏù¥ Î∂ÄÏ°±Ìï¥Ïöî!');
      return;
    }
    fish.ingredients.push(idx);
    fish.cost += ing.price;
    el.classList.add('selected');
    SFX.coin();
  }
  document.getElementById('fish-cost-label').textContent = fish.cost;
}

function fishBuyDone() {
  if (fish.ingredients.length < 2) {
    speak('Ïû¨Î£åÎ•º 2Í∞ú Ïù¥ÏÉÅ ÏÇ¨Ïïº Ìï¥Ïöî!');
    return;
  }
  // ÌïÑÏàòÏû¨Î£å Ï≤¥ÌÅ¨: Î∞ÄÍ∞ÄÎ£®(0) + ÏïôÍ∏à(1) ÌïÑÏàò
  if (!fish.ingredients.includes(0) || !fish.ingredients.includes(1)) {
    speak('Î∞ÄÍ∞ÄÎ£®ÏôÄ ÏïôÍ∏àÏùÄ Íº≠ ÌïÑÏöîÌï¥Ïöî!');
    return;
  }

  fish.money -= fish.cost;
  // Ïû¨Î£å Í∞úÏàòÎ°ú ÎßåÎì§ Ïàò ÏûàÎäî Î∂ïÏñ¥Îπµ Ïàò Í≤∞Ï†ï (10Í∞ú Í∏∞Î≥∏ + Ï∂îÍ∞Ä Ïû¨Î£åÎãπ 2Í∞ú)
  fish.unitCost = Math.round(fish.cost / (10 + (fish.ingredients.length - 2) * 2));
  document.getElementById('fish-unit-cost').textContent = fish.unitCost;

  // Ïù¥Ï†Ñ Í∞ÄÍ≤© Ïú†ÏßÄ
  document.getElementById('fish-price-slider').value = fish.sellPrice;
  document.getElementById('fish-price-label').textContent = fish.sellPrice;

  SFX.cash();
  showFishPhase('price');
  initPricePhase();
  speak('Ïû¨Î£åÎ•º ÏÉÄÏñ¥Ïöî! Ïù¥Ï†ú Î∂ïÏñ¥Îπµ Í∞ÄÍ≤©ÏùÑ Ï†ïÌï¥Î≥ºÍπåÏöî?');
}

function updatePriceLabel() {
  const val = parseInt(document.getElementById('fish-price-slider').value);
  document.getElementById('fish-price-label').textContent = val;
  // Í∞ÄÍ≤© ÌÉúÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏
  const tagVal = document.getElementById('price-tag-val');
  if (tagVal) tagVal.textContent = val + 'Ïõê';
  // ÏÜêÎãò ÎØ∏ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
  let pct, tip, faces;
  if (val <= 300) { pct = 95; tip = 'ÏïÑÏ£º Ïã∏Ïöî! ÏÜêÎãòÏù¥ Î™∞Î†§ÏôÄÏöî! üèÉ‚Äç‚ôÇÔ∏èüí®'; faces = 'üòÜüòÜüòÜüòÜüòÜ'; }
  else if (val <= 500) { pct = 75; tip = 'Ï†ÅÎãπÌïú Í∞ÄÍ≤©! ÏÜêÎãòÏù¥ ÎßéÏù¥ ÏôÄÏöî üòä'; faces = 'üòäüòäüòäüòä'; }
  else if (val <= 800) { pct = 50; tip = 'Ï°∞Í∏à ÎπÑÏãºÎç∞... ÏÜêÎãòÏù¥ Ï§ÑÏñ¥Ïöî ü§î'; faces = 'üòêüòêüòê'; }
  else if (val <= 1200) { pct = 25; tip = 'ÎÑàÎ¨¥ ÎπÑÏã∏Ïöî! ÏÜêÎãòÏù¥ Í±∞Ïùò Ïïà ÏôÄÏöî üò¢'; faces = 'üò¢üò¢'; }
  else { pct = 10; tip = 'ÏóÑÏ≤≠ ÎπÑÏã∏Ïöî! ÏïÑÎ¨¥ÎèÑ Ïïà Ïò¨ÏßÄÎèÑ... üò≠'; faces = 'üò≠'; }
  const fill = document.getElementById('price-meter-fill');
  if (fill) fill.style.width = pct + '%';
  const facesEl = document.getElementById('price-meter-faces');
  if (facesEl) facesEl.textContent = faces;
  const tipEl = document.getElementById('price-tip');
  if (tipEl) tipEl.textContent = tip;
}

function initPricePhase() {
  // Î∂ïÏñ¥Îπµ ÌîÑÎ¶¨Î∑∞ SVG
  const fishDisplay = document.getElementById('price-fish-display');
  if (fishDisplay) {
    fishDisplay.innerHTML = `<svg viewBox="0 0 200 140" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="fishPrev" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#e8c07a"/><stop offset="50%" stop-color="#d4a574"/><stop offset="100%" stop-color="#b8860b"/></linearGradient></defs>
      <path d="M40,70 C40,40 65,22 95,22 C120,22 140,30 155,45 L170,35 C178,28 185,32 180,42 L168,55 C172,62 174,70 172,78 L185,85 C190,88 186,95 178,92 L165,87 C155,100 135,110 105,112 C70,114 40,100 40,70Z" fill="url(#fishPrev)" stroke="#a16207" stroke-width="2.5"/>
      <path d="M145,25 C150,18 160,18 155,28 L148,40" fill="#c2956a" stroke="#a16207" stroke-width="1.5"/>
      <line x1="55" y1="45" x2="145" y2="45" stroke="#a16207" stroke-width="1" opacity=".3"/>
      <line x1="55" y1="65" x2="150" y2="65" stroke="#a16207" stroke-width="1" opacity=".3"/>
      <line x1="55" y1="85" x2="145" y2="85" stroke="#a16207" stroke-width="1" opacity=".3"/>
      <line x1="80" y1="28" x2="80" y2="108" stroke="#a16207" stroke-width="1" opacity=".25"/>
      <line x1="110" y1="25" x2="110" y2="110" stroke="#a16207" stroke-width="1" opacity=".25"/>
      <line x1="140" y1="32" x2="140" y2="100" stroke="#a16207" stroke-width="1" opacity=".25"/>
      <circle cx="60" cy="60" r="7" fill="#78350f" opacity=".7"/>
      <circle cx="62" cy="58" r="2.5" fill="rgba(255,255,255,.4)"/>
      <ellipse cx="85" cy="42" rx="20" ry="8" fill="rgba(255,255,255,.12)" transform="rotate(-8,85,42)"/>
      <path d="M60,120 Q55,128 65,130" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="2"><animate attributeName="opacity" values=".3;.08;.3" dur="1.5s" repeatCount="indefinite"/></path>
      <path d="M100,118 Q95,126 105,128" fill="none" stroke="rgba(255,255,255,.25)" stroke-width="1.5"><animate attributeName="opacity" values=".25;.05;.25" dur="1.8s" repeatCount="indefinite"/></path>
    </svg>`;
  }
  updatePriceLabel();
}

function fishSetPrice() {
  fish.sellPrice = parseInt(document.getElementById('fish-price-slider').value);

  // ÎÇ†Ïî® Í≤∞Ï†ï
  const weather = WEATHERS[Math.floor(Math.random() * WEATHERS.length)];

  // ÏÜêÎãò Ïàò Í≥ÑÏÇ∞: Í∞ÄÍ≤©Ïù¥ Ïã∏Î©¥ ÏÜêÎãò ÎßéÏùå, ÎπÑÏã∏Î©¥ Ï†ÅÏùå
  let baseCustomers;
  if (fish.sellPrice <= 300) baseCustomers = 12;
  else if (fish.sellPrice <= 500) baseCustomers = 10;
  else if (fish.sellPrice <= 800) baseCustomers = 7;
  else if (fish.sellPrice <= 1200) baseCustomers = 4;
  else baseCustomers = 2;

  const maxFish = 10 + (fish.ingredients.length - 2) * 2;
  let customers = Math.min(Math.round(baseCustomers * weather.multiplier), maxFish);
  customers = Math.max(1, customers + Math.floor(Math.random() * 3) - 1);

  const revenue = customers * fish.sellPrice;
  const dailyProfit = revenue - fish.cost;

  // ‚ñ∂ ÌåêÎß§ Ïï†ÎãàÎ©îÏù¥ÏÖò Îã®Í≥Ñ ÏßÑÏûÖ
  showFishPhase('selling');
  document.getElementById('fish-selling-day').textContent = fish.day + 'ÏùºÏ∞®';
  speak('Ïû•ÏÇ¨Î•º ÏãúÏûëÌï©ÎãàÎã§!');
  SFX.cash();

  // Î∂ïÏñ¥Îπµ ÏßÑÏó¥
  const fishStack = document.getElementById('selling-fish-stack');
  fishStack.innerHTML = '';
  for (let i = 0; i < maxFish; i++) {
    const f = document.createElement('div');
    f.className = 'selling-fish-mini';
    f.id = 'sell-fish-' + i;
    f.innerHTML = `<svg viewBox="0 0 80 55"><path d="M10,28 C10,14 22,6 38,6 C50,6 60,10 66,18 L72,14 C76,11 78,13 76,17 L71,23 C73,26 74,28 73,31 L78,34 C80,35 78,38 75,37 L70,35 C66,40 58,44 44,45 C28,46 10,40 10,28Z" fill="#d4a574" stroke="#a16207" stroke-width="1.5"/><circle cx="22" cy="24" r="3" fill="#78350f" opacity=".6"/></svg>`;
    fishStack.appendChild(f);
  }

  // Step 1: ÎÇ†Ïî® Í≥µÍ∞ú (0.5Ï¥à)
  const weatherReveal = document.getElementById('selling-weather');
  weatherReveal.classList.remove('show');
  document.getElementById('selling-weather-icon').innerHTML = weatherSVG(weather.name);
  document.getElementById('selling-weather-name').textContent = weather.name + ' ‚Äî ' + weather.desc;
  const statusEl = document.getElementById('selling-status');
  statusEl.textContent = 'Ïò§Îäò ÎÇ†Ïî®Îäî...';

  setTimeout(() => {
    weatherReveal.classList.add('show');
    statusEl.textContent = weather.name + '! ' + weather.desc;
  }, 500);

  // Step 2: ÏÜêÎãò ÎèÑÏ∞© (1.5Ï¥à~)
  const customersEl = document.getElementById('selling-customers');
  customersEl.innerHTML = '';

  setTimeout(() => {
    statusEl.textContent = 'ÏÜêÎãòÏù¥ Ïò§Í≥† ÏûàÏñ¥Ïöî...';
    for (let i = 0; i < customers; i++) {
      const c = document.createElement('div');
      c.className = 'selling-customer';
      c.innerHTML = makeCustomerSVG(i);
      customersEl.appendChild(c);
      setTimeout(() => {
        c.classList.add('arrive');
        SFX.coin();
        // Ìï¥Îãπ Î∂ïÏñ¥Îπµ ÏÇ¨ÎùºÏßê
        const fishEl = document.getElementById('sell-fish-' + i);
        if (fishEl) fishEl.classList.add('sold');
        // ÎèôÏ†Ñ ÌåùÏóÖ
        const coinFly = document.createElement('div');
        coinFly.className = 'selling-coin-fly';
        coinFly.textContent = '+' + fish.sellPrice + 'Ïõê';
        coinFly.style.cssText = `left:${200 + i * 40}px;top:200px;--tx:${(Math.random()-.5)*60}px;--ty:-${60+Math.random()*40}px`;
        document.querySelector('.selling-scene').appendChild(coinFly);
        setTimeout(() => coinFly.remove(), 800);
      }, i * 350);
    }
  }, 1500);

  // Step 3: Í≤∞Í≥º ÌëúÏãú (ÏÜêÎãò Îã§ Ïò® ÌõÑ ~1Ï¥à Îí§)
  const resultDelay = 1500 + customers * 350 + 800;
  setTimeout(() => {
    // Îç∞Ïù¥ÌÑ∞ Î∞òÏòÅ
    fish.totalSold += customers;
    fish.totalProfit += dailyProfit;
    fish.money += revenue;
    fish.lifetimeSold += customers;
    fish.dailyResults.push({ day: fish.day, weather: weather.name, customers, revenue, cost: fish.cost, profit: dailyProfit });

    // Í≤∞Í≥º ÌôîÎ©¥ ÏÑ∏ÌåÖ
    document.getElementById('weather-emoji').innerHTML = weatherSVG(weather.name);
    document.getElementById('weather-name').textContent = weather.name;
    document.getElementById('weather-desc').textContent = weather.desc;
    document.getElementById('fish-sell-day').textContent = fish.day + 'ÏùºÏ∞®';
    document.getElementById('res-price').textContent = fish.sellPrice + 'Ïõê';
    document.getElementById('res-customers').textContent = customers + 'Î™Ö';
    document.getElementById('res-revenue').textContent = revenue + 'Ïõê';
    document.getElementById('res-cost').textContent = fish.cost + 'Ïõê';

    const profitEl = document.getElementById('res-profit');
    profitEl.textContent = (dailyProfit >= 0 ? '+' : '') + dailyProfit + 'Ïõê';
    profitEl.className = 'result-val ' + (dailyProfit >= 0 ? 'profit' : 'loss');

    document.getElementById('fish-next-btn').textContent = fish.day < 3 ? '‚û°Ô∏è Îã§Ïùå ÎÇ†' : 'üìä Í≤∞ÏÇ∞ Î≥¥Í∏∞';

    showFishPhase('sell');

    if (dailyProfit >= 0) {
      SFX.profit(); setMascotEmotion('fish-view','happy');
      speak(`${customers}Î™ÖÏù¥ ÏôîÏñ¥Ïöî! ${dailyProfit}Ïõê Î≤åÏóàÏñ¥Ïöî!`);
      setTimeout(()=>{
        const sellResult = document.getElementById('sell-result');
        if(sellResult) coinRainEffect(sellResult);
      }, 300);
    } else {
      SFX.loss(); setMascotEmotion('fish-view','worried');
      speak(`${customers}Î™ÖÎ∞ñÏóê Ïïà ÏôîÏñ¥Ïöî. ${Math.abs(dailyProfit)}Ïõê ÏÜêÌï¥ÏòàÏöî.`);
    }

    profile.totalPlayed++;
    if (dailyProfit > 0) profile.totalCorrect++;
    updateFishSide();
    updateProfile();
    saveStats();
  }, resultDelay);
}

function makeCustomerSVG(idx) {
  const colors = ['#f87171','#fbbf24','#34d399','#60a5fa','#a78bfa','#f472b6','#fb923c','#2dd4bf','#818cf8','#e879f9','#facc15','#4ade80'];
  const c = colors[idx % colors.length];
  return `<svg viewBox="0 0 50 70" width="50" height="70">
    <circle cx="25" cy="16" r="12" fill="${c}"/>
    <circle cx="20" cy="14" r="2" fill="#1e293b"/>
    <circle cx="30" cy="14" r="2" fill="#1e293b"/>
    <path d="M21,20 Q25,24 29,20" fill="none" stroke="#1e293b" stroke-width="1.5" stroke-linecap="round"/>
    <rect x="15" y="28" width="20" height="26" rx="6" fill="${c}" opacity=".85"/>
    <rect x="11" y="54" width="10" height="14" rx="5" fill="${c}" opacity=".7"/>
    <rect x="29" y="54" width="10" height="14" rx="5" fill="${c}" opacity=".7"/>
  </svg>`;
}

function fishNextDay() {
  if (fish.day >= 3) {
    fishShowSummary();
    return;
  }
  fish.day++;
  showFishPhase('buy');
  renderShop();
  updateFishSide();
}

function fishShowSummary() {
  fish.games++;
  if (fish.totalProfit > fish.bestProfit) fish.bestProfit = fish.totalProfit;

  const grid = document.getElementById('summary-grid');
  grid.innerHTML = `
    <div class="summary-item"><div class="summary-num">${fish.totalSold}Í∞ú</div><div class="summary-label">Ï¥ù ÌåêÎß§</div></div>
    <div class="summary-item"><div class="summary-num">${fish.totalProfit >= 0 ? '+' : ''}${fish.totalProfit}Ïõê</div><div class="summary-label">Ï¥ù ÏàòÏùµ</div></div>
    <div class="summary-item"><div class="summary-num">${fish.money}Ïõê</div><div class="summary-label">ÏµúÏ¢Ö ÏÜåÏßÄÍ∏à</div></div>
  `;
  // ÏùºÎ≥Ñ ÏÉÅÏÑ∏
  let details = '<div style="margin-top:16px;text-align:left">';
  fish.dailyResults.forEach(d => {
    details += `<div style="padding:8px 12px;margin:4px 0;background:rgba(255,255,255,.1);border-radius:8px;font-size:14px;color:#a7f3d0">
      ${d.day}ÏùºÏ∞® ${d.weather} ‚Äî ÏÜêÎãò ${d.customers}Î™Ö, ÏàòÏùµ ${d.profit >= 0 ? '+' : ''}${d.profit}Ïõê
    </div>`;
  });
  details += '</div>';
  document.getElementById('fish-summary').querySelector('.summary-grid').insertAdjacentHTML('afterend', details);

  showFishPhase('summary');
  if (fish.totalProfit > 0) {
    SFX.profit(); setMascotEmotion('fish-view','happy');
    speak(`3Ïùº ÎèôÏïà ${fish.totalProfit}Ïõê Î≤åÏóàÏñ¥Ïöî! ÎåÄÎã®Ìïú ÏÇ¨Ïû•Îãò!`);
  } else {
    SFX.loss(); setMascotEmotion('fish-view','worried');
    speak(`Ïù¥Îü∞, ${Math.abs(fish.totalProfit)}Ïõê ÏÜêÌï¥Î¥§Ïñ¥Ïöî. Îã§ÏùåÏóê ÏûòÌï¥Î¥êÏöî!`);
  }
  saveStats();
}

function fishRestart() {
  // summary ÏïàÏùò Ï∂îÍ∞Ä details Ï†ïÎ¶¨
  const summary = document.getElementById('fish-summary');
  const extraDiv = summary.querySelector('.summary-grid + div');
  if (extraDiv) extraDiv.remove();
  initFishGame();
}

function fishHint() {
  const phase = document.querySelector('.fish-phase.active');
  if (phase.id === 'fish-phase-buy') {
    speak('Î∞ÄÍ∞ÄÎ£®ÏôÄ ÏïôÍ∏àÏùÄ Íº≠ ÏÇ¨Ïïº Ìï¥Ïöî! ÎÇòÎ®∏ÏßÄÎäî Í≥®ÎùºÎ≥¥ÏÑ∏Ïöî.');
  } else if (phase.id === 'fish-phase-price') {
    speak(`Ïû¨Î£åÎπÑÍ∞Ä ${fish.unitCost}ÏõêÏù¥ÎãàÍπå, Í∑∏Î≥¥Îã§ ÎπÑÏã∏Í≤å ÌåîÏïÑÏïº Ïù¥ÏùµÏù¥ÏóêÏöî!`);
  } else {
    speak('ÎÇ†Ïî®Í∞Ä Ï¢ãÏúºÎ©¥ ÏÜêÎãòÏù¥ ÎßéÏïÑÏöî!');
  }
}

function fishSkipDay() {
  const phase = document.querySelector('.fish-phase.active');
  if (phase.id === 'fish-phase-sell') {
    fishNextDay();
  }
}

function updateFishSide() {
  document.getElementById('fish-day').textContent = fish.day + 'ÏùºÏ∞®';
  document.getElementById('fish-money-side').textContent = fish.money + 'Ïõê';
  document.getElementById('fish-profit-side').textContent = fish.totalProfit + 'Ïõê';
  document.getElementById('fish-sold-side').textContent = fish.totalSold + 'Í∞ú';
}

// ===== ÏßÄÍ∞ë ÌÉàÏ∂ú =====
const PRODUCTS = [
  { name: 'ÏÇ¨ÌÉï', emoji: 'üç¨', price: 200 },
  { name: 'Í≥ºÏûê', emoji: 'üç™', price: 500 },
  { name: 'ÏïÑÏù¥Ïä§ÌÅ¨Î¶º', emoji: 'üç¶', price: 800 },
  { name: 'Ïù∏Ìòï', emoji: 'üß∏', price: 1500 },
  { name: 'Í≥µ', emoji: '‚öΩ', price: 1000 },
  { name: 'ÏÉâÏó∞ÌïÑ', emoji: 'üñçÔ∏è', price: 600 },
  { name: 'ÌíçÏÑ†', emoji: 'üéà', price: 300 },
  { name: 'Ïä§Ìã∞Ïª§', emoji: '‚≠ê', price: 100 },
  { name: 'ÏöîÍµ¨Î•¥Ìä∏', emoji: 'ü•õ', price: 400 },
  { name: 'Ï†§Î¶¨', emoji: 'üç°', price: 350 },
  { name: 'Î°úÎ¥á', emoji: 'ü§ñ', price: 2000 },
  { name: 'Ï£ºÏä§', emoji: 'üßÉ', price: 700 }
];

function initWalletGame() {
  // Ïö©Îèà ÎûúÎç§: 2000, 3000, 5000 Ï§ë
  const budgets = [2000, 3000, 5000];
  wallet.budget = budgets[Math.floor(Math.random() * budgets.length)];
  wallet.spent = 0;
  wallet.saved = 0;
  wallet.cart = [];

  document.getElementById('wallet-budget').textContent = wallet.budget;
  document.getElementById('wallet-saved').textContent = 0;
  document.getElementById('cart-total').textContent = 0;
  document.getElementById('cart-items').innerHTML = '';
  document.getElementById('wallet-status').textContent = '';
  document.getElementById('wallet-status').style.background = '';

  // ÏÉÅÌíà 8Í∞ú ÎûúÎç§ ÏÑ†ÌÉù
  const shuffled = [...PRODUCTS].sort(() => Math.random() - 0.5).slice(0, 8);
  const grid = document.getElementById('product-grid');
  grid.innerHTML = shuffled.map((p, i) =>
    `<div class="product-item" id="prod-${i}" data-price="${p.price}" data-name="${p.name}" data-emoji="${p.emoji}" onclick="toggleProduct(${i})">
      <div class="product-emoji">${PRODUCT_SVG[p.name] || p.emoji}</div>
      <div class="product-name">${p.name}</div>
      <div class="product-price">${p.price}Ïõê</div>
    </div>`
  ).join('');

  updateWalletSide();
  speak(`Ïò§Îäò Ïö©ÎèàÏùÄ ${wallet.budget}ÏõêÏù¥ÏóêÏöî! Î≠ò ÏÇ¨Î≥ºÍπå?`);
}

function toggleProduct(idx) {
  const el = document.getElementById('prod-' + idx);
  const price = parseInt(el.dataset.price);
  const name = el.dataset.name;
  const emoji = el.dataset.emoji;

  const cartIdx = wallet.cart.findIndex(c => c.idx === idx);
  if (cartIdx >= 0) {
    // Ïû•Î∞îÍµ¨ÎãàÏóêÏÑú Ï†úÍ±∞
    wallet.cart.splice(cartIdx, 1);
    el.classList.remove('in-cart', 'over-budget');
  } else {
    // Ïû•Î∞îÍµ¨ÎãàÏóê Ï∂îÍ∞Ä
    wallet.cart.push({ idx, name, emoji, price });
    el.classList.add('in-cart');
    SFX.coin();
    // Î∞òÏßùÏù¥ Ïù¥ÌéôÌä∏
    const rect = el.getBoundingClientRect();
    const area = document.getElementById('wallet-area');
    const areaRect = area.getBoundingClientRect();
    spawnSparkleAt(area, rect.left - areaRect.left + rect.width/2, rect.top - areaRect.top + rect.height/2);
  }

  updateCartDisplay();
}

function updateCartDisplay() {
  wallet.spent = wallet.cart.reduce((s, c) => s + c.price, 0);
  document.getElementById('cart-total').textContent = wallet.spent;
  document.getElementById('cart-items').innerHTML = wallet.cart.map(c =>
    `<div class="cart-item-tag" onclick="toggleProduct(${c.idx})">${c.emoji} ${c.price}Ïõê</div>`
  ).join('');

  // Ï¥àÍ≥º Ïãú ÌëúÏãú
  const status = document.getElementById('wallet-status');
  if (wallet.spent > wallet.budget) {
    status.textContent = 'üò¢ ÏßÄÍ∞ëÏù¥ Ïö∏Í≥† ÏûàÏñ¥Ïöî! Î≠ò ÎπºÎ≥ºÍπå?';
    status.style.background = 'linear-gradient(145deg,#fef2f2,#fecaca)';
    status.style.color = '#dc2626';
    // Ïò§Î≤Ñ ÏÉÅÌÉú ÌëúÏãú
    wallet.cart.forEach(c => {
      document.getElementById('prod-' + c.idx).classList.add('over-budget');
    });
    // Ïö∏Ïùå Ïù¥ÌéôÌä∏
    SFX.loss();
    spawnCryEffect();
  } else {
    status.textContent = wallet.spent > 0 ? `ÎÇ®Îäî Îèà: ${wallet.budget - wallet.spent}Ïõê` : '';
    status.style.background = wallet.spent > 0 ? 'linear-gradient(145deg,#ecfdf5,#d1fae5)' : '';
    status.style.color = '#059669';
    wallet.cart.forEach(c => {
      const el = document.getElementById('prod-' + c.idx);
      el.classList.remove('over-budget');
      el.classList.add('in-cart');
    });
  }

  updateWalletSide();
}

function spawnCryEffect() {
  const area = document.getElementById('wallet-area');
  const cry = document.createElement('div');
  cry.className = 'wallet-crying';
  cry.textContent = 'üíß';
  cry.style.cssText = `left:${50 + Math.random() * 200}px;top:${20 + Math.random() * 30}px`;
  area.appendChild(cry);
  setTimeout(() => cry.remove(), 1000);
}

function walletConfirm() {
  if (wallet.cart.length === 0) {
    speak('ÏïÑÎ¨¥Í≤ÉÎèÑ Ïïà ÏÉÄÏñ¥Ïöî! Î¨ºÍ±¥ÏùÑ Í≥®ÎùºÎ≥ºÍπåÏöî?');
    return;
  }
  if (wallet.spent > wallet.budget) {
    speak('ÎèàÏù¥ Î∂ÄÏ°±Ìï¥Ïöî! Î≠ò ÎπºÎ≥ºÍπåÏöî?');
    return;
  }

  wallet.games++;
  wallet.saved = wallet.budget - wallet.spent;
  profile.totalPlayed++;
  profile.totalCorrect++;
  wallet.streak++;
  if (wallet.streak > wallet.bestStreak) wallet.bestStreak = wallet.streak;
  if (wallet.saved > wallet.bestSaved) wallet.bestSaved = wallet.saved;

  if (wallet.saved > 0) {
    SFX.cash(); setMascotEmotion('fish-view','happy');
    piggyEffect();
    speak(`ÏûòÌñàÏñ¥Ïöî! ${wallet.saved}ÏõêÏùÑ Ï†ÄÍ∏àÌñàÏñ¥Ïöî! ÎèºÏßÄÏ†ÄÍ∏àÌÜµÏù¥ Í∏∞ÎªêÌï¥Ïöî!`);
  } else {
    SFX.coin();
    speak('Îî± ÎßûÍ≤å ÏçºÏñ¥Ïöî!');
  }

  document.getElementById('wallet-status').textContent = `‚úÖ Íµ¨Îß§ ÏôÑÎ£å! ${wallet.saved > 0 ? wallet.saved + 'Ïõê Ï†ÄÍ∏à!' : 'Îî± ÎßûÍ≤å ÏçºÏñ¥Ïöî!'}`;
  document.getElementById('wallet-status').style.background = 'linear-gradient(145deg,#ecfdf5,#d1fae5)';
  document.getElementById('wallet-status').style.color = '#059669';

  updateWalletSide();
  updateProfile();
  saveStats();
}

function piggyEffect() {
  const icon = document.getElementById('piggy-icon');
  icon.classList.add('bounce');
  setTimeout(() => icon.classList.remove('bounce'), 500);
  document.getElementById('wallet-saved').textContent = wallet.saved;
  // ÎèºÏßÄ Î∞∞Ïóê Í∏àÏï° ÌëúÏãú
  const bellyText = document.getElementById('piggy-belly-text');
  if (bellyText) bellyText.textContent = wallet.saved + 'Ïõê';

  // ÌååÌã∞ÌÅ¥
  const area = document.getElementById('wallet-area');
  const sparks = ['‚≠ê','‚ú®','ü™ô','üíõ'];
  for (let i = 0; i < 6; i++) {
    const p = document.createElement('div');
    p.className = 'piggy-particle';
    p.textContent = sparks[Math.floor(Math.random() * sparks.length)];
    const angle = (Math.PI * 2 / 6) * i;
    const dist = 30 + Math.random() * 40;
    p.style.cssText = `right:${80 + Math.random() * 40}px;top:${20 + Math.random() * 20}px;font-size:${18+Math.random()*12}px;--tx:${Math.cos(angle)*dist}px;--ty:${Math.sin(angle)*dist-20}px`;
    area.appendChild(p);
    setTimeout(() => p.remove(), 600);
  }
}

function walletClearCart() {
  wallet.cart.forEach(c => {
    const el = document.getElementById('prod-' + c.idx);
    if (el) el.classList.remove('in-cart', 'over-budget');
  });
  wallet.cart = [];
  updateCartDisplay();
}

function walletNewRound() {
  initWalletGame();
}

function updateWalletSide() {
  document.getElementById('wallet-budget-side').textContent = wallet.budget + 'Ïõê';
  document.getElementById('wallet-spent-side').textContent = wallet.spent + 'Ïõê';
  document.getElementById('wallet-saved-side').textContent = wallet.saved + 'Ïõê';
  document.getElementById('wallet-streak-side').textContent = wallet.streak;
}

// ===== Î¨ºÎ¨ºÍµêÌôò =====
const TRADE_ITEMS = [
  { name: 'ÏÇ¨Í≥º', emoji: 'üçé' },
  { name: 'ÏÉùÏÑ†', emoji: 'üêü' },
  { name: 'Îπµ', emoji: 'üçû' },
  { name: 'Ïö∞Ïú†', emoji: 'ü•õ' },
  { name: 'Îã¨Í±Ä', emoji: 'ü•ö' },
  { name: 'ÍΩÉ', emoji: 'üå∏' },
  { name: 'ÎÇòÎ¨¥', emoji: 'ü™µ' },
  { name: 'ÏºÄÏù¥ÌÅ¨', emoji: 'üéÇ' },
  { name: 'Ïû•ÎÇúÍ∞ê', emoji: 'üß∏' },
  { name: 'Î≥ÑÏÇ¨ÌÉï', emoji: '‚≠ê' }
];

const TRADE_RECIPES = [
  // Í∞Å Î†àÏãúÌîº: { exchanges: [{give: {name, count}, receive: {name, count}}...], start: {name, count}, goal: name }
  {
    start: { name: 'ÏÇ¨Í≥º', emoji: 'üçé', count: 5 },
    goal: { name: 'ÏºÄÏù¥ÌÅ¨', emoji: 'üéÇ' },
    exchanges: [
      { give: { name: 'ÏÇ¨Í≥º', emoji: 'üçé', count: 3 }, receive: { name: 'Ïö∞Ïú†', emoji: 'ü•õ', count: 1 } },
      { give: { name: 'ÏÇ¨Í≥º', emoji: 'üçé', count: 2 }, receive: { name: 'Îã¨Í±Ä', emoji: 'ü•ö', count: 2 } },
      { give: { name: 'Ïö∞Ïú†', emoji: 'ü•õ', count: 1 }, receive: { name: 'Îπµ', emoji: 'üçû', count: 2 } },
      { give: { name: 'Îã¨Í±Ä', emoji: 'ü•ö', count: 2 }, receive: { name: 'Îπµ', emoji: 'üçû', count: 1 } },
      { give: { name: 'Îπµ', emoji: 'üçû', count: 3 }, receive: { name: 'ÏºÄÏù¥ÌÅ¨', emoji: 'üéÇ', count: 1 } }
    ]
  },
  {
    start: { name: 'ÏÉùÏÑ†', emoji: 'üêü', count: 4 },
    goal: { name: 'Ïû•ÎÇúÍ∞ê', emoji: 'üß∏' },
    exchanges: [
      { give: { name: 'ÏÉùÏÑ†', emoji: 'üêü', count: 2 }, receive: { name: 'ÏÇ¨Í≥º', emoji: 'üçé', count: 3 } },
      { give: { name: 'ÏÉùÏÑ†', emoji: 'üêü', count: 2 }, receive: { name: 'ÍΩÉ', emoji: 'üå∏', count: 2 } },
      { give: { name: 'ÏÇ¨Í≥º', emoji: 'üçé', count: 3 }, receive: { name: 'ÎÇòÎ¨¥', emoji: 'ü™µ', count: 2 } },
      { give: { name: 'ÍΩÉ', emoji: 'üå∏', count: 2 }, receive: { name: 'Î≥ÑÏÇ¨ÌÉï', emoji: '‚≠ê', count: 1 } },
      { give: { name: 'ÎÇòÎ¨¥', emoji: 'ü™µ', count: 2 }, receive: { name: 'Ïû•ÎÇúÍ∞ê', emoji: 'üß∏', count: 1 } }
    ]
  },
  {
    start: { name: 'ÍΩÉ', emoji: 'üå∏', count: 6 },
    goal: { name: 'Î≥ÑÏÇ¨ÌÉï', emoji: '‚≠ê' },
    exchanges: [
      { give: { name: 'ÍΩÉ', emoji: 'üå∏', count: 3 }, receive: { name: 'ÏÇ¨Í≥º', emoji: 'üçé', count: 2 } },
      { give: { name: 'ÍΩÉ', emoji: 'üå∏', count: 2 }, receive: { name: 'Îπµ', emoji: 'üçû', count: 1 } },
      { give: { name: 'ÏÇ¨Í≥º', emoji: 'üçé', count: 2 }, receive: { name: 'Îã¨Í±Ä', emoji: 'ü•ö', count: 3 } },
      { give: { name: 'Îπµ', emoji: 'üçû', count: 1 }, receive: { name: 'Ïö∞Ïú†', emoji: 'ü•õ', count: 1 } },
      { give: { name: 'Îã¨Í±Ä', emoji: 'ü•ö', count: 3 }, receive: { name: 'Î≥ÑÏÇ¨ÌÉï', emoji: '‚≠ê', count: 1 } },
      { give: { name: 'Ïö∞Ïú†', emoji: 'ü•õ', count: 1 }, receive: { name: 'Î≥ÑÏÇ¨ÌÉï', emoji: '‚≠ê', count: 1 } }
    ]
  }
];

let currentRecipe = null;

function initTradeGame() {
  trade.tradeCount = 0;
  trade.inventory = {};

  // ÎûúÎç§ Î†àÏãúÌîº ÏÑ†ÌÉù
  currentRecipe = TRADE_RECIPES[Math.floor(Math.random() * TRADE_RECIPES.length)];

  // ÏãúÏûë ÏïÑÏù¥ÌÖú ÏßÄÍ∏â
  trade.inventory[currentRecipe.start.name] = { count: currentRecipe.start.count, emoji: currentRecipe.start.emoji };

  trade.games++;
  document.getElementById('trade-goal-text').innerHTML = `<span style="display:inline-flex;align-items:center;gap:8px">üéØ Î™©Ìëú: <span style="display:inline-block;width:50px;height:50px;vertical-align:middle;filter:drop-shadow(0 0 8px rgba(16,185,129,.5))">${TRADE_SVG[currentRecipe.goal.name] || currentRecipe.goal.emoji}</span> ${currentRecipe.goal.name}ÏùÑ Íµ¨ÌïòÏÑ∏Ïöî!</span>`;
  document.getElementById('trade-goal-side').textContent = currentRecipe.goal.emoji;
  document.getElementById('trade-result').textContent = '';
  document.getElementById('trade-result').style.background = '';

  renderTradeInventory();
  renderTradeTable();
  updateTradeSide();
  speak(`${currentRecipe.start.name} ${currentRecipe.start.count}Í∞úÎ°ú ÏãúÏûë! ${currentRecipe.goal.name}ÏùÑ Íµ¨Ìï¥Î≥¥ÏÑ∏Ïöî!`);
  saveStats();
}

function renderTradeInventory() {
  const bag = document.getElementById('trade-bag-items');
  if (!bag) return;
  let html = '';
  for (const [name, data] of Object.entries(trade.inventory)) {
    if (data.count > 0) {
      html += `<div class="trade-bag-item">
        <div class="bag-item-svg">${TRADE_SVG[name] || data.emoji}</div>
        <div class="bag-item-name">${name}</div>
        <div class="bag-item-count">x${data.count}</div>
      </div>`;
    }
  }
  if (!html) html = '<div style="color:#94a3b8;font-size:16px;text-align:center;padding:20px">ÏïÑÎ¨¥Í≤ÉÎèÑ ÏóÜÏñ¥Ïöî...</div>';
  bag.innerHTML = html;
}

function renderTradeTable() {
  const stalls = document.getElementById('trade-stalls');
  if (!stalls) return;
  stalls.innerHTML = currentRecipe.exchanges.map((ex, i) => {
    const hasEnough = trade.inventory[ex.give.name] && trade.inventory[ex.give.name].count >= ex.give.count;
    return `<div class="trade-stall${hasEnough ? '' : ' disabled'}" onclick="executeTrade(${i})">
      <div class="stall-get-svg">${TRADE_SVG[ex.receive.name] || ex.receive.emoji}</div>
      <div class="stall-get-name">${ex.receive.name}</div>
      <div class="stall-get-count">x${ex.receive.count}</div>
      <div class="stall-need">${TRADE_SVG[ex.give.name] ? '<span style="display:inline-block;width:24px;height:24px;vertical-align:middle">' + TRADE_SVG[ex.give.name] + '</span>' : ex.give.emoji} ${ex.give.name} ${ex.give.count}Í∞ú ÌïÑÏöî</div>
    </div>`;
  }).join('');
}

function executeTrade(idx) {
  const ex = currentRecipe.exchanges[idx];
  // ÏïÑÏù¥ÌÖú Ï∂©Î∂ÑÌïúÏßÄ ÌôïÏù∏
  if (!trade.inventory[ex.give.name] || trade.inventory[ex.give.name].count < ex.give.count) {
    speak(`${ex.give.name}Ïù¥ Î∂ÄÏ°±Ìï¥Ïöî!`);
    return;
  }

  // ÍµêÌôò Ïã§Ìñâ
  trade.inventory[ex.give.name].count -= ex.give.count;
  if (!trade.inventory[ex.receive.name]) {
    trade.inventory[ex.receive.name] = { count: 0, emoji: ex.receive.emoji };
  }
  trade.inventory[ex.receive.name].count += ex.receive.count;

  trade.tradeCount++;
  trade.lifetimeTrades++;
  SFX.trade();

  speak(`${ex.give.name} ${ex.give.count}Í∞úÎ•º Ï£ºÍ≥† ${ex.receive.name} ${ex.receive.count}Í∞úÎ•º Î∞õÏïòÏñ¥Ïöî!`);

  renderTradeInventory();
  renderTradeTable();
  updateTradeSide();

  // Î™©Ìëú Îã¨ÏÑ± Ï≤¥ÌÅ¨
  if (trade.inventory[currentRecipe.goal.name] && trade.inventory[currentRecipe.goal.name].count > 0) {
    tradeSuccess();
  }
}

function tradeSuccess() {
  trade.success++;
  profile.totalPlayed++;
  profile.totalCorrect++;

  const result = document.getElementById('trade-result');
  result.textContent = `üéâ ${currentRecipe.goal.name}ÏùÑ Íµ¨ÌñàÏñ¥Ïöî! ${trade.tradeCount}Î≤à ÍµêÌôòÌñàÏñ¥Ïöî!`;
  result.style.background = 'linear-gradient(145deg,#ecfdf5,#d1fae5)';
  result.style.color = '#059669';

  SFX.trade(); SFX.fanfare(); setMascotEmotion('fish-view','happy');
  speak(`ÎåÄÎã®Ìï¥Ïöî! ${currentRecipe.goal.name}ÏùÑ Íµ¨ÌñàÏñ¥Ïöî! ÎèàÏù¥ ÏûàÏúºÎ©¥ Ïù¥Î†áÍ≤å Î≥µÏû°ÌïòÍ≤å Ïïà Ìï¥ÎèÑ ÎêòÍ≤†Ï£†?`);

  // ÏÑ±Í≥µ Ïù¥ÌéôÌä∏
  tradeSuccessEffect();

  updateTradeSide();
  updateProfile();
  saveStats();
}

function tradeSuccessEffect() {
  const area = document.getElementById('trade-area');
  const overlay = document.createElement('div');
  overlay.className = 'trade-success-overlay';
  area.appendChild(overlay);
  const colors = ['#10b981','#6ee7b7','#34d399','#fbbf24','#f59e0b','#3b82f6','#8b5cf6'];
  // Ïª®ÌéòÌã∞
  for (let i = 0; i < 25; i++) {
    const c = document.createElement('div');
    c.className = 'trade-confetti';
    c.style.cssText = `left:${Math.random()*100}%;top:-10px;background:${colors[Math.floor(Math.random()*colors.length)]};--tx:${(Math.random()-.5)*200}px;--ty:${200+Math.random()*300}px;--dur:${.8+Math.random()*.6}s;animation-delay:${Math.random()*.3}s;width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;border-radius:${Math.random()>.5?'50%':'2px'}`;
    overlay.appendChild(c);
  }
  // SVG Î≥Ñ Î≤ÑÏä§Ìä∏
  for (let i = 0; i < 8; i++) {
    const star = document.createElement('div');
    star.className = 'trade-star-burst';
    const angle = (Math.PI*2/8)*i;
    const dist = 60+Math.random()*80;
    const size = 20+Math.random()*16;
    const col = colors[Math.floor(Math.random()*colors.length)];
    star.innerHTML = `<svg viewBox="0 0 24 24" width="${size}" height="${size}"><polygon points="12,0 15,8 24,8 17,14 19,24 12,18 5,24 7,14 0,8 9,8" fill="${col}"/></svg>`;
    star.style.cssText = `left:50%;top:50%;--tx:${Math.cos(angle)*dist}px;--ty:${Math.sin(angle)*dist}px;animation-delay:${i*0.05}s`;
    overlay.appendChild(star);
  }
  setTimeout(() => overlay.remove(), 1500);
}

function tradeHint() {
  // Í∞ÄÎä•Ìïú ÍµêÌôò Ï§ë Ï≤´ Î≤àÏß∏ ÌûåÌä∏
  for (const ex of currentRecipe.exchanges) {
    if (trade.inventory[ex.give.name] && trade.inventory[ex.give.name].count >= ex.give.count) {
      speak(`${ex.give.name}ÏùÑ ${ex.receive.name}ÏúºÎ°ú Î∞îÍøîÎ≥¥ÏÑ∏Ïöî!`);
      return;
    }
  }
  speak('ÍµêÌôòÌï† Ïàò ÏûàÎäî Í≤å ÏóÜÏñ¥Ïöî. Îã§Ïãú ÏãúÏûëÌï¥Î≥ºÍπåÏöî?');
}

function updateTradeSide() {
  document.getElementById('trade-count-side').textContent = trade.tradeCount;
  document.getElementById('trade-success-side').textContent = trade.success;
}

// ===== ÎÇ¥ Í∏∞Î°ù =====
function updateRecords() {
  document.getElementById('r-total').textContent = profile.totalPlayed;
  document.getElementById('r-correct').textContent = profile.totalCorrect;
  document.getElementById('r-rate').textContent = profile.totalPlayed ? Math.round(profile.totalCorrect / profile.totalPlayed * 100) + '%' : '0%';
  document.getElementById('rec-total-side').textContent = profile.totalPlayed;
  document.getElementById('rec-rate-side').textContent = profile.totalPlayed ? Math.round(profile.totalCorrect / profile.totalPlayed * 100) + '%' : '0%';
  document.getElementById('r-fish-games').textContent = fish.games;
  document.getElementById('r-fish-profit').textContent = fish.bestProfit + 'Ïõê';
  document.getElementById('r-fish-sold').textContent = fish.lifetimeSold;
  document.getElementById('r-wallet-games').textContent = wallet.games;
  document.getElementById('r-wallet-saved').textContent = wallet.bestSaved + 'Ïõê';
  document.getElementById('r-wallet-streak').textContent = wallet.bestStreak;
  document.getElementById('r-trade-games').textContent = trade.games;
  document.getElementById('r-trade-success').textContent = trade.success;
  document.getElementById('r-trade-trades').textContent = trade.lifetimeTrades;
}

// ===== ÌûàÏñ¥Î°ú: ÏãúÏû• Ïû•Î≥¥Í∏∞ Îü¨Ïãú =====
const COIN_TYPES = [
  { value: 10, label: '10Ïõê', size: 80, grad: 'coinCopper' },
  { value: 50, label: '50Ïõê', size: 90, grad: 'coinSilver' },
  { value: 100, label: '100Ïõê', size: 100, grad: 'coinGreen' },
  { value: 500, label: '500Ïõê', size: 110, grad: 'coinGold' }
];

// Coin SVG generator
function makeCoinSVG(type) {
  const s = type.size;
  return `<svg viewBox="0 0 ${s} ${s}" width="${s}" height="${s}" xmlns="http://www.w3.org/2000/svg">
    <circle cx="${s/2}" cy="${s/2}" r="${s/2-4}" fill="url(#${type.grad})" stroke="rgba(255,255,255,.7)" stroke-width="3"/>
    <circle cx="${s/2}" cy="${s/2}" r="${s/2-14}" fill="none" stroke="rgba(255,255,255,.2)" stroke-width="2"/>
    <ellipse cx="${s*.38}" cy="${s*.38}" rx="${s*.15}" ry="${s*.1}" fill="rgba(255,255,255,.25)" transform="rotate(-25,${s*.38},${s*.38})"/>
    <text x="${s/2}" y="${s/2+6}" text-anchor="middle" font-size="${type.value>=100?s*.18:s*.24}" font-weight="900" fill="#fff" style="text-shadow:0 1px 3px rgba(0,0,0,.5)">${type.value}</text>
  </svg>`;
}

// Wallet SVG (250x160)
function makeWalletSVG() {
  return `<svg viewBox="0 0 250 160" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="hgWalletBody" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#a0522d"/>
        <stop offset="30%" stop-color="#8b4513"/>
        <stop offset="70%" stop-color="#6d3710"/>
        <stop offset="100%" stop-color="#4a2508"/>
      </linearGradient>
      <linearGradient id="hgWalletFlap" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#c47a3e"/>
        <stop offset="100%" stop-color="#a0522d"/>
      </linearGradient>
    </defs>
    <!-- Î≥∏Ï≤¥ -->
    <rect x="15" y="45" width="220" height="105" rx="18" fill="url(#hgWalletBody)" stroke="#3d1e06" stroke-width="3"/>
    <!-- Ïä§Ìã∞Ïπ≠ -->
    <rect x="25" y="55" width="200" height="85" rx="14" fill="none" stroke="#c49a6c" stroke-width="1.5" stroke-dasharray="6,4" opacity=".5"/>
    <!-- ÌîåÎû© -->
    <path d="M25,48 Q125,15 225,48" fill="url(#hgWalletFlap)" stroke="#3d1e06" stroke-width="2"/>
    <path d="M35,48 Q125,22 215,48" fill="none" stroke="#c49a6c" stroke-width="1" stroke-dasharray="5,3" opacity=".4"/>
    <!-- Ïû†Í∏à Î≤ÑÌäº -->
    <circle cx="125" cy="42" r="14" fill="#fbbf24" stroke="#b45309" stroke-width="2.5"/>
    <circle cx="125" cy="42" r="8" fill="#f59e0b"/>
    <text x="125" y="47" text-anchor="middle" font-size="12" font-weight="900" fill="#78350f">‚Ç©</text>
    <!-- ÏΩîÏù∏ Ïû•Ïãù -->
    <circle cx="55" cy="100" r="16" fill="url(#coinGold)" opacity=".4"/>
    <circle cx="195" cy="100" r="12" fill="url(#coinCopper)" opacity=".35"/>
    <!-- Ìè¨Ïºì -->
    <rect x="80" y="70" width="90" height="50" rx="10" fill="rgba(0,0,0,.15)"/>
    <rect x="85" y="75" width="80" height="40" rx="8" fill="rgba(255,255,255,.05)"/>
    <!-- ÏûÖÍµ¨ ÌïòÏù¥ÎùºÏù¥Ìä∏ -->
    <ellipse cx="125" cy="48" rx="60" ry="5" fill="rgba(0,0,0,.3)"/>
  </svg>`;
}

// Debt bomb SVG
function makeDebtSVG() {
  return `<svg viewBox="0 0 90 90" width="90" height="90" xmlns="http://www.w3.org/2000/svg">
    <circle cx="45" cy="52" r="30" fill="#1f2937" stroke="#374151" stroke-width="2"/>
    <ellipse cx="35" cy="42" rx="10" ry="6" fill="rgba(255,255,255,.1)" transform="rotate(-20,35,42)"/>
    <path d="M45,22 Q52,8 56,14" stroke="#ef4444" stroke-width="3.5" fill="none" stroke-linecap="round"/>
    <circle cx="57" cy="11" r="7" fill="#f59e0b">
      <animate attributeName="opacity" values="1;.2;1" dur=".4s" repeatCount="indefinite"/>
    </circle>
    <circle cx="57" cy="11" r="4" fill="#fbbf24">
      <animate attributeName="r" values="3;5;3" dur=".4s" repeatCount="indefinite"/>
    </circle>
    <text x="45" y="60" text-anchor="middle" font-size="20" font-weight="900" fill="#ef4444">Îπö</text>
    <text x="45" y="60" text-anchor="middle" font-size="20" font-weight="900" fill="#fca5a5" opacity=".5">Îπö</text>
  </svg>`;
}

// Power-up SVGs
function makeCouponSVG() {
  return `<svg viewBox="0 0 90 90" width="90" height="90" xmlns="http://www.w3.org/2000/svg">
    <rect x="8" y="22" width="74" height="46" rx="8" fill="#10b981" stroke="#059669" stroke-width="2"/>
    <circle cx="8" cy="45" r="9" fill="#064e3b"/>
    <circle cx="82" cy="45" r="9" fill="#064e3b"/>
    <rect x="16" y="28" width="58" height="34" rx="4" fill="none" stroke="#6ee7b7" stroke-width="1" stroke-dasharray="4,3"/>
    <text x="45" y="42" text-anchor="middle" font-size="11" font-weight="900" fill="#fff">50%</text>
    <text x="45" y="56" text-anchor="middle" font-size="10" font-weight="800" fill="#d1fae5">Ìï†Ïù∏!</text>
    <circle cx="22" cy="35" r="2" fill="#6ee7b7" opacity=".5"/>
    <circle cx="68" cy="55" r="2" fill="#6ee7b7" opacity=".5"/>
  </svg>`;
}

function makePiggySVG() {
  return `<svg viewBox="0 0 90 90" width="90" height="90" xmlns="http://www.w3.org/2000/svg">
    <ellipse cx="45" cy="52" rx="30" ry="24" fill="#f9a8d4"/>
    <ellipse cx="45" cy="52" rx="28" ry="22" fill="#fbcfe8"/>
    <ellipse cx="62" cy="46" rx="12" ry="10" fill="#f472b6"/>
    <ellipse cx="62" cy="46" rx="5" ry="3.5" fill="#1f2937"/>
    <circle cx="38" cy="42" r="4" fill="#1f2937"/>
    <circle cx="39" cy="41" r="1.5" fill="#fff"/>
    <rect x="33" y="28" width="24" height="6" rx="3" fill="#f472b6"/>
    <rect x="38" y="24" width="14" height="4" rx="2" fill="#e879a0" opacity=".6"/>
    <ellipse cx="34" cy="72" rx="5" ry="4" fill="#f472b6"/>
    <ellipse cx="56" cy="72" rx="5" ry="4" fill="#f472b6"/>
    <text x="45" y="58" text-anchor="middle" font-size="10" font-weight="800" fill="#be185d">Ï†ÄÍ∏à</text>
  </svg>`;
}

function makeCalcSVG() {
  return `<svg viewBox="0 0 90 90" width="90" height="90" xmlns="http://www.w3.org/2000/svg">
    <rect x="15" y="10" width="60" height="70" rx="8" fill="#4338ca" stroke="#6366f1" stroke-width="2"/>
    <rect x="20" y="16" width="50" height="18" rx="4" fill="#1e1b4b"/>
    <text x="45" y="30" text-anchor="middle" font-size="12" font-weight="900" fill="#a5b4fc">123</text>
    <rect x="22" y="40" width="12" height="10" rx="2" fill="#6366f1"/><text x="28" y="48" text-anchor="middle" font-size="8" fill="#fff">7</text>
    <rect x="39" y="40" width="12" height="10" rx="2" fill="#6366f1"/><text x="45" y="48" text-anchor="middle" font-size="8" fill="#fff">8</text>
    <rect x="56" y="40" width="12" height="10" rx="2" fill="#6366f1"/><text x="62" y="48" text-anchor="middle" font-size="8" fill="#fff">9</text>
    <rect x="22" y="54" width="12" height="10" rx="2" fill="#6366f1"/><text x="28" y="62" text-anchor="middle" font-size="8" fill="#fff">4</text>
    <rect x="39" y="54" width="12" height="10" rx="2" fill="#6366f1"/><text x="45" y="62" text-anchor="middle" font-size="8" fill="#fff">5</text>
    <rect x="56" y="54" width="12" height="10" rx="2" fill="#10b981"/><text x="62" y="62" text-anchor="middle" font-size="8" font-weight="900" fill="#fff">=</text>
  </svg>`;
}

// Background SVG for market scene
function makeMarketBgSVG(level) {
  const skyColors = [
    ['#7dd3fc','#38bdf8','#0ea5e9'], // ÎÇÆ ÌïòÎäò
    ['#fde68a','#fbbf24','#f59e0b'], // ÏÑùÏñë
    ['#c4b5fd','#8b5cf6','#6d28d9'], // Ï†ÄÎÖÅ
    ['#1e293b','#0f172a','#020617']  // Î∞§
  ];
  const sky = skyColors[(level - 1) % skyColors.length];
  return `<svg viewBox="0 0 1920 1080" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%">
    <defs>
      <linearGradient id="hgSky" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${sky[0]}"/>
        <stop offset="50%" stop-color="${sky[1]}"/>
        <stop offset="100%" stop-color="${sky[2]}"/>
      </linearGradient>
    </defs>
    <rect width="1920" height="1080" fill="url(#hgSky)"/>
    <!-- Íµ¨Î¶Ñ -->
    <ellipse cx="200" cy="120" rx="120" ry="40" fill="rgba(255,255,255,.15)"><animate attributeName="cx" values="200;400;200" dur="30s" repeatCount="indefinite"/></ellipse>
    <ellipse cx="800" cy="80" rx="90" ry="30" fill="rgba(255,255,255,.1)"><animate attributeName="cx" values="800;600;800" dur="25s" repeatCount="indefinite"/></ellipse>
    <ellipse cx="1500" cy="150" rx="100" ry="35" fill="rgba(255,255,255,.12)"><animate attributeName="cx" values="1500;1700;1500" dur="28s" repeatCount="indefinite"/></ellipse>
    <!-- Í±¥Î¨º Ïã§Î£®Ïó£ -->
    <rect x="0" y="750" width="1920" height="330" fill="rgba(0,0,0,.15)" rx="0"/>
    <rect x="50" y="680" width="180" height="400" fill="rgba(0,0,0,.08)" rx="6"/>
    <rect x="280" y="720" width="140" height="360" fill="rgba(0,0,0,.06)" rx="4"/>
    <rect x="1500" y="700" width="160" height="380" fill="rgba(0,0,0,.07)" rx="5"/>
    <rect x="1700" y="660" width="200" height="420" fill="rgba(0,0,0,.09)" rx="6"/>
    <!-- Î∞îÎã• ÌÉÄÏùº -->
    <rect x="0" y="970" width="1920" height="110" fill="#92400e"/>
    <rect x="0" y="970" width="1920" height="6" fill="#b45309"/>
    ${Array.from({length:24},(_,i)=>`<rect x="${i*80}" y="976" width="78" height="50" rx="2" fill="#a0522d" opacity="${.6+Math.random()*.3}"/>`).join('')}
    ${Array.from({length:24},(_,i)=>`<rect x="${i*80+40}" y="1026" width="78" height="50" rx="2" fill="#8b4513" opacity="${.5+Math.random()*.3}"/>`).join('')}
  </svg>`;
}

// Market stall SVG decorations
function makeMarketStallLeft() {
  return `<svg viewBox="0 0 350 450" width="350" height="450" xmlns="http://www.w3.org/2000/svg" class="hg-market-stall" style="left:20px">
    <!-- Í∏∞Îë• -->
    <rect x="40" y="100" width="16" height="350" fill="#8b4513"/>
    <rect x="294" y="100" width="16" height="350" fill="#8b4513"/>
    <!-- ÏßÄÎ∂ï Ï∞®Ïñë -->
    <path d="M10,110 L175,60 L340,110 L340,130 L175,80 L10,130Z" fill="#dc2626"/>
    <path d="M10,130 L175,80 L340,130 L340,150 L175,100 L10,150Z" fill="#fff"/>
    <path d="M10,150 L175,100 L340,150 L340,170 L175,120 L10,170Z" fill="#dc2626"/>
    <!-- ÏÑ†Î∞ò -->
    <rect x="50" y="200" width="250" height="10" rx="3" fill="#a0522d"/>
    <rect x="50" y="300" width="250" height="10" rx="3" fill="#a0522d"/>
    <!-- ÏÉÅÌíàÎì§ -->
    <circle cx="100" cy="185" r="16" fill="url(#coinGold)" opacity=".7"/>
    <circle cx="150" cy="185" r="14" fill="#ef4444"/><text x="150" y="190" text-anchor="middle" font-size="14" fill="#fff">üçé</text>
    <circle cx="200" cy="190" r="12" fill="#f59e0b"/><text x="200" y="195" text-anchor="middle" font-size="12" fill="#fff">üçä</text>
    <circle cx="250" cy="188" r="13" fill="#22c55e"/><text x="250" y="193" text-anchor="middle" font-size="12" fill="#fff">ü•¨</text>
    <!-- Í∞ÑÌåê -->
    <rect x="90" y="160" width="170" height="30" rx="6" fill="#fbbf24" stroke="#b45309" stroke-width="2"/>
    <text x="175" y="182" text-anchor="middle" font-size="16" font-weight="900" fill="#78350f">Ïã†ÏÑ† Í≥ºÏùº</text>
  </svg>`;
}

function makeMarketStallRight() {
  return `<svg viewBox="0 0 350 450" width="350" height="450" xmlns="http://www.w3.org/2000/svg" class="hg-market-stall" style="right:20px">
    <rect x="40" y="100" width="16" height="350" fill="#8b4513"/>
    <rect x="294" y="100" width="16" height="350" fill="#8b4513"/>
    <path d="M10,110 L175,60 L340,110 L340,130 L175,80 L10,130Z" fill="#2563eb"/>
    <path d="M10,130 L175,80 L340,130 L340,150 L175,100 L10,150Z" fill="#fff"/>
    <path d="M10,150 L175,100 L340,150 L340,170 L175,120 L10,170Z" fill="#2563eb"/>
    <rect x="50" y="200" width="250" height="10" rx="3" fill="#a0522d"/>
    <rect x="50" y="300" width="250" height="10" rx="3" fill="#a0522d"/>
    <circle cx="100" cy="188" r="14" fill="#8b5cf6"/><text x="100" y="193" text-anchor="middle" font-size="12" fill="#fff">üßÅ</text>
    <circle cx="150" cy="186" r="15" fill="#ec4899"/><text x="150" y="191" text-anchor="middle" font-size="14" fill="#fff">üç∞</text>
    <circle cx="200" cy="188" r="13" fill="#14b8a6"/><text x="200" y="193" text-anchor="middle" font-size="12" fill="#fff">üç°</text>
    <circle cx="250" cy="185" r="16" fill="#f97316"/><text x="250" y="190" text-anchor="middle" font-size="14" fill="#fff">ü•ê</text>
    <rect x="90" y="160" width="170" height="30" rx="6" fill="#93c5fd" stroke="#3b82f6" stroke-width="2"/>
    <text x="175" y="182" text-anchor="middle" font-size="16" font-weight="900" fill="#1e3a8a">ÎßõÏûàÎäî Îπµ</text>
  </svg>`;
}

function makeMarketBanner() {
  return `<svg viewBox="0 0 200 80" width="200" height="80" xmlns="http://www.w3.org/2000/svg" class="hg-market-banner" style="left:50%;top:85px;transform-origin:center top;margin-left:-100px">
    <path d="M10,0 L190,0 L180,70 L100,60 L20,70Z" fill="#dc2626" stroke="#b91c1c" stroke-width="2"/>
    <path d="M20,70 L10,80 L10,70Z" fill="#991b1b"/>
    <path d="M180,70 L190,80 L190,70Z" fill="#991b1b"/>
    <text x="100" y="38" text-anchor="middle" font-size="24" font-weight="900" fill="#fef08a" style="text-shadow:0 1px 2px rgba(0,0,0,.3)">Ïãú Ïû•</text>
    <text x="100" y="56" text-anchor="middle" font-size="12" font-weight="700" fill="#fde68a">MARKET</text>
  </svg>`;
}

function hgGenerateTarget(level) {
  const bases = [100, 200, 300, 500, 750, 1000, 1500, 2000, 2500, 3000];
  const base = bases[Math.min(level - 1, bases.length - 1)];
  return Math.round((base + Math.floor(Math.random() * base * 0.4)) / 50) * 50;
}

function startHeroGame() {
  try{document.documentElement.requestFullscreen?.()}catch(e){}
  speechSynthesis.cancel();
  const heroEl = document.getElementById('hero-game');
  heroEl.classList.remove('hidden');

  // Reset state
  hg.score = 0; hg.lives = 5; hg.level = 1; hg.round = 0;
  hg.target = 0; hg.money = 0;
  hg.running = false; hg.paused = false;
  hg.items = []; hg.walletX = 960;
  hg.combo = 0; hg.maxCombo = 0;
  hg.hasPiggy = false; hg.hasCalc = false;
  hg.dragging = false;

  // Setup arena
  const arena = document.getElementById('hg-arena');
  arena.innerHTML = '';

  // Background
  document.getElementById('hg-bg').innerHTML = makeMarketBgSVG(1);

  // Market decorations
  hgAddDecorations(arena);

  // Ground
  const ground = document.createElement('div');
  ground.className = 'hg-ground';
  ground.innerHTML = `<svg viewBox="0 0 1920 108" preserveAspectRatio="none" style="width:100%;height:100%"><rect width="1920" height="108" fill="#6d3710"/><rect width="1920" height="6" fill="#8b4513"/>${Array.from({length:24},(_,i)=>`<rect x="${i*80}" y="8" width="78" height="48" rx="2" fill="#7c4a1e" opacity="${.5+Math.random()*.4}"/>`).join('')}${Array.from({length:24},(_,i)=>`<rect x="${i*80+40}" y="56" width="78" height="48" rx="2" fill="#6d3710" opacity="${.5+Math.random()*.4}"/>`).join('')}</svg>`;
  arena.appendChild(ground);

  // Wallet
  const wallet = document.createElement('div');
  wallet.className = 'hg-wallet';
  wallet.innerHTML = makeWalletSVG() + '<div class="hg-wallet-glow"></div><div class="hg-wallet-amount" id="hg-wallet-amt">0Ïõê</div>';
  wallet.style.left = hg.walletX + 'px';
  arena.appendChild(wallet);
  hg.walletEl = wallet;

  // Input handlers
  hgSetupInput(arena);

  // Countdown -> start
  hgCountdown(() => {
    hg.running = true;
    hg.target = hgGenerateTarget(1);
    hg.round = 1;
    updateHgUI();
    hgMainLoop();
    SFX.gameStart();
    speak('ÏãúÏû• Ïû•Î≥¥Í∏∞ ÏãúÏûë!');
  });
}

function hgAddDecorations(arena) {
  // Left stall
  const leftStall = document.createElement('div');
  leftStall.innerHTML = makeMarketStallLeft();
  leftStall.style.cssText = 'position:absolute;bottom:9%;left:20px;z-index:2;pointer-events:none;opacity:.7';
  arena.appendChild(leftStall);

  // Right stall
  const rightStall = document.createElement('div');
  rightStall.innerHTML = makeMarketStallRight();
  rightStall.style.cssText = 'position:absolute;bottom:9%;right:20px;z-index:2;pointer-events:none;opacity:.7';
  arena.appendChild(rightStall);

  // Banner
  const banner = document.createElement('div');
  banner.innerHTML = makeMarketBanner();
  banner.style.cssText = 'position:absolute;top:0;left:50%;transform:translateX(-50%);z-index:3;pointer-events:none';
  arena.appendChild(banner);

  // Floating deco coins
  for (let i = 0; i < 8; i++) {
    const d = document.createElement('div');
    d.className = 'hg-float-deco';
    const sz = 20 + Math.random() * 30;
    d.innerHTML = `<svg viewBox="0 0 40 40" width="${sz}" height="${sz}"><circle cx="20" cy="20" r="18" fill="url(#coinGold)"/><text x="20" y="25" text-anchor="middle" font-size="12" fill="#fff" font-weight="900">‚Ç©</text></svg>`;
    d.style.cssText = `left:${100+Math.random()*1700}px;top:${100+Math.random()*500}px;--dur:${12+Math.random()*12}s;animation-delay:${-Math.random()*15}s`;
    arena.appendChild(d);
  }
}

function hgSetupInput(arena) {
  arena.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    hg.dragging = true;
    hgMoveWallet(e);
  });
  arena.addEventListener('pointermove', (e) => {
    if (hg.dragging) {
      e.preventDefault();
      hgMoveWallet(e);
    }
  });
  arena.addEventListener('pointerup', () => { hg.dragging = false; });
  arena.addEventListener('pointerleave', () => { hg.dragging = false; });
  arena.addEventListener('pointercancel', () => { hg.dragging = false; });
}

function hgMoveWallet(e) {
  const arena = document.getElementById('hg-arena');
  const rect = arena.getBoundingClientRect();
  const scaleX = 1920 / rect.width;
  const x = (e.clientX - rect.left) * scaleX;
  hg.walletX = Math.max(125, Math.min(1795, x));
  if (hg.walletEl) hg.walletEl.style.left = hg.walletX + 'px';
}

function hgCountdown(callback) {
  const arena = document.getElementById('hg-arena');
  let count = 3;
  function showNum() {
    if (count <= 0) {
      // GO!
      const go = document.createElement('div');
      go.className = 'hg-countdown';
      go.innerHTML = '<div class="hg-countdown-num" style="color:#fbbf24">GO!</div>';
      arena.appendChild(go);
      setTimeout(() => { go.remove(); callback(); }, 800);
      return;
    }
    const cd = document.createElement('div');
    cd.className = 'hg-countdown';
    cd.innerHTML = `<div class="hg-countdown-num">${count}</div>`;
    arena.appendChild(cd);
    SFX.coin();
    setTimeout(() => { cd.remove(); count--; showNum(); }, 800);
  }
  showNum();
}

function hgMainLoop() {
  // Spawn timer
  function getSpawnInterval() { return Math.max(600, 2000 - hg.level * 150); }
  if (hg.spawnTimer) clearInterval(hg.spawnTimer);
  hg.spawnTimer = setInterval(() => {
    if (!hg.paused && hg.running) hgSpawnItem();
  }, getSpawnInterval());

  function tick() {
    if (!hg.running) return;
    if (!hg.paused) {
      hgMoveItems();
      hgCheckCollisions();
    }
    hg.animId = requestAnimationFrame(tick);
  }
  hg.animId = requestAnimationFrame(tick);
}

function hgSpawnItem() {
  const arena = document.getElementById('hg-arena');
  const rng = Math.random();

  // 8% power-up
  if (rng < 0.08) { hgSpawnPower(arena); return; }
  // 12% debt bomb
  if (rng < 0.20) { hgSpawnDebt(arena); return; }

  // 80% coin
  // Weight coins: 10Ïõê 40%, 50Ïõê 30%, 100Ïõê 20%, 500Ïõê 10%
  const r2 = Math.random();
  let coinIdx = 0;
  if (r2 < 0.40) coinIdx = 0;
  else if (r2 < 0.70) coinIdx = 1;
  else if (r2 < 0.90) coinIdx = 2;
  else coinIdx = 3;
  const type = COIN_TYPES[coinIdx];

  const el = document.createElement('div');
  el.className = 'hg-coin coin-spin';
  el.innerHTML = makeCoinSVG(type) + `<div class="coin-label">${type.label}</div>`;
  const x = 120 + Math.random() * (1920 - 240);
  el.style.left = x + 'px';
  el.style.top = '-120px';
  arena.appendChild(el);

  const speed = 1.8 + hg.level * 0.25 + Math.random() * 0.6;
  const sway = (Math.random() - 0.5) * 2;
  hg.items.push({ el, type: 'coin', value: type.value, x, y: -120, speed, sway, size: type.size });
}

function hgSpawnDebt(arena) {
  const el = document.createElement('div');
  el.className = 'hg-debt';
  el.innerHTML = makeDebtSVG();
  const x = 120 + Math.random() * (1920 - 240);
  el.style.left = x + 'px';
  el.style.top = '-100px';
  arena.appendChild(el);

  const speed = 2.0 + hg.level * 0.2 + Math.random() * 0.4;
  hg.items.push({ el, type: 'debt', value: 0, x, y: -100, speed, sway: 0, size: 90 });
}

function hgSpawnPower(arena) {
  const types = ['coupon', 'piggy', 'calc'];
  const fx = types[Math.floor(Math.random() * types.length)];
  const el = document.createElement('div');
  el.className = 'hg-power';
  if (fx === 'coupon') el.innerHTML = makeCouponSVG();
  else if (fx === 'piggy') el.innerHTML = makePiggySVG();
  else el.innerHTML = makeCalcSVG();
  const x = 120 + Math.random() * (1920 - 240);
  el.style.left = x + 'px';
  el.style.top = '-100px';
  arena.appendChild(el);

  const speed = 1.5 + Math.random() * 0.5;
  hg.items.push({ el, type: 'power', value: 0, x, y: -100, speed, sway: (Math.random()-0.5)*1.5, size: 90, fx });
}

function hgMoveItems() {
  hg.items.forEach(item => {
    item.y += item.speed;
    if (item.sway) {
      item.x += Math.sin(item.y / 60) * item.sway * 0.5;
      item.x = Math.max(10, Math.min(1900, item.x));
      item.el.style.left = item.x + 'px';
    }
    item.el.style.top = item.y + 'px';
  });

  // Remove off-screen items (past bottom)
  hg.items = hg.items.filter(item => {
    if (item.y > 1080) {
      item.el.remove();
      return false;
    }
    return true;
  });
}

function hgCheckCollisions() {
  const walletLeft = hg.walletX - 140;
  const walletRight = hg.walletX + 140;
  const walletBottom = Math.round(1080 * 0.88);  // CSS bottom:12% ‚Üí top 88% = 950
  const walletTop = walletBottom - 190;  // generous hitbox

  const toRemove = [];
  hg.items.forEach((item, idx) => {
    const cx = item.x + item.size / 2;
    const cy = item.y + item.size / 2;
    if (cy > walletTop && cy < walletBottom && cx > walletLeft && cx < walletRight) {
      // Collision!
      if (item.type === 'coin') hgCollectCoin(item);
      else if (item.type === 'debt') hgHitDebt(item);
      else if (item.type === 'power') hgActivatePower(item);
      toRemove.push(idx);
    }
  });

  // Remove collected items (reverse order to keep indices valid)
  for (let i = toRemove.length - 1; i >= 0; i--) {
    hg.items.splice(toRemove[i], 1);
  }
}

function hgCollectCoin(item) {
  hg.money += item.value;
  hg.combo++;
  if (hg.combo > hg.maxCombo) hg.maxCombo = hg.combo;
  SFX.coin();
  if (hg.combo >= 3) SFX.combo(hg.combo);

  // Collect animation
  item.el.classList.add('coin-collected');
  setTimeout(() => item.el.remove(), 400);

  // Score popup
  hgShowPopup('+' + item.value + 'Ïõê', item.x, item.y, '#fbbf24');

  // Wallet bounce
  if (hg.walletEl) hg.walletEl.querySelector('svg').classList.add('wallet-mouth-open');
  setTimeout(() => { if (hg.walletEl) { const sv = hg.walletEl.querySelector('svg'); if(sv) sv.classList.remove('wallet-mouth-open'); }}, 300);

  // Combo badge
  if (hg.combo >= 3 && hg.combo % 3 === 0) {
    hgShowCombo(hg.combo);
  }

  // Check target
  if (hg.money === hg.target) {
    hgRoundClear();
  } else if (hg.money > hg.target) {
    if (hg.hasPiggy) {
      hg.score += 3;
      hg.hasPiggy = false;
      hg.money = hg.target;
      speak('ÎèºÏßÄÏ†ÄÍ∏àÌÜµÏù¥ Ï¥àÍ≥ºÎ∂ÑÏùÑ Ï†ÄÏ∂ï!');
      hgRoundClear();
    } else {
      hgOverBudget();
    }
  }

  updateHgUI();
}

function hgHitDebt(item) {
  const loss = [50, 100, 200][Math.floor(Math.random() * 3)];
  hg.money = Math.max(0, hg.money - loss);
  hg.combo = 0;
  SFX.loss();

  // Red flash + shake
  const arena = document.getElementById('hg-arena');
  const flash = document.createElement('div');
  flash.className = 'hg-flash-red';
  arena.appendChild(flash);
  setTimeout(() => flash.remove(), 500);
  arena.classList.add('hg-arena-shake');
  setTimeout(() => arena.classList.remove('hg-arena-shake'), 400);

  hgShowPopup('-' + loss + 'Ïõê', item.x, item.y, '#ef4444');
  item.el.remove();
  speak('Ïïó! ÎπöÏù¥ÏóêÏöî!');

  updateHgUI();
}

function hgActivatePower(item) {
  const fx = item.fx;
  SFX.cash();

  if (fx === 'coupon') {
    const oldTarget = hg.target;
    hg.target = Math.max(50, Math.round(hg.target / 2 / 50) * 50);
    speak('Ìï†Ïù∏ Ïø†Ìè∞! Î™©ÌëúÍ∞Ä ' + hg.target + 'ÏõêÏúºÎ°ú!');
    hgShowPopup('50% Ìï†Ïù∏!', item.x, item.y, '#10b981');
    // Check if now at target
    if (hg.money === hg.target) {
      setTimeout(() => hgRoundClear(), 300);
    } else if (hg.money > hg.target) {
      if (hg.hasPiggy) { hg.money = hg.target; setTimeout(() => hgRoundClear(), 300); }
      else setTimeout(() => hgOverBudget(), 300);
    }
  } else if (fx === 'piggy') {
    hg.hasPiggy = true;
    speak('ÎèºÏßÄÏ†ÄÍ∏àÌÜµ! Ï¥àÍ≥ºÌï¥ÎèÑ OK!');
    hgShowPopup('Ï†ÄÍ∏àÌÜµ!', item.x, item.y, '#ec4899');
  } else if (fx === 'calc') {
    hg.hasCalc = true;
    const remain = hg.target - hg.money;
    speak('ÎÇ®ÏùÄ Í∏àÏï° ' + Math.max(0, remain) + 'Ïõê!');
    hgShowPopup('ÎÇ®ÏùÄ:' + Math.max(0, remain) + 'Ïõê', item.x, item.y, '#6366f1');
    setTimeout(() => { hg.hasCalc = false; updateHgUI(); }, 6000);
  }

  item.el.remove();
  updateHgUI();
}

function hgRoundClear() {
  hg.round++;
  const bonus = Math.min(hg.combo, 10);
  hg.score += 10 + bonus;
  SFX.fanfare();

  // Green flash
  const arena = document.getElementById('hg-arena');
  const flash = document.createElement('div');
  flash.className = 'hg-flash-green';
  arena.appendChild(flash);
  setTimeout(() => flash.remove(), 400);

  // Round clear text
  const rc = document.createElement('div');
  rc.className = 'hg-round-clear';
  rc.innerHTML = `<div class="hg-round-text">ÎùºÏö¥Îìú ${hg.round} ÌÅ¥Î¶¨Ïñ¥!</div>`;
  arena.appendChild(rc);
  setTimeout(() => rc.remove(), 1500);

  // Confetti
  hgSpawnConfetti(arena, 30);

  speak('Îî± ÎßûÏïòÏñ¥Ïöî! ÎåÄÎã®Ìï¥!');

  // Next round
  setTimeout(() => {
    hg.money = 0;
    const newLevel = Math.floor(hg.round / 3) + 1;
    if (newLevel > hg.level) {
      hg.level = newLevel;
      SFX.levelup();
      document.getElementById('hg-bg').innerHTML = makeMarketBgSVG(hg.level);
      hgShowPopup('Î†àÎ≤® ' + hg.level + '!', 900, 400, '#fbbf24');
    }
    hg.target = hgGenerateTarget(hg.level);
    hg.hasPiggy = false;
    hg.hasCalc = false;

    // Adjust spawn speed
    if (hg.spawnTimer) clearInterval(hg.spawnTimer);
    const interval = Math.max(600, 2000 - hg.level * 150);
    hg.spawnTimer = setInterval(() => {
      if (!hg.paused && hg.running) hgSpawnItem();
    }, interval);

    updateHgUI();
  }, 1200);
}

function hgOverBudget() {
  hg.lives--;
  hg.combo = 0;
  SFX.loss();
  speak('Í±∞Ïä§Î¶ÑÎèàÏù¥ ÏóÜÏñ¥Ïöî!');

  const arena = document.getElementById('hg-arena');
  // Red flash + shake
  const flash = document.createElement('div');
  flash.className = 'hg-flash-red';
  arena.appendChild(flash);
  setTimeout(() => flash.remove(), 500);
  arena.classList.add('hg-arena-shake');
  setTimeout(() => arena.classList.remove('hg-arena-shake'), 400);

  // Show "over!" popup
  hgShowPopup('Ï¥àÍ≥º!', 960, 400, '#ef4444');

  updateHgUI();

  if (hg.lives <= 0) {
    setTimeout(() => hgEnd(), 600);
  } else {
    setTimeout(() => {
      hg.money = 0;
      hg.target = hgGenerateTarget(hg.level);
      hg.hasPiggy = false;
      hg.hasCalc = false;
      // Clear all items on screen
      hg.items.forEach(it => it.el.remove());
      hg.items = [];
      updateHgUI();
    }, 1000);
  }
}

function hgShowPopup(text, x, y, color) {
  const arena = document.getElementById('hg-arena');
  const pop = document.createElement('div');
  pop.className = 'hg-score-pop';
  pop.textContent = text;
  pop.style.cssText = `left:${x}px;top:${y}px;color:${color}`;
  arena.appendChild(pop);
  setTimeout(() => pop.remove(), 1000);
}

function hgShowCombo(n) {
  const arena = document.getElementById('hg-arena');
  arena.querySelectorAll('.hg-combo-badge').forEach(e => e.remove());
  const cb = document.createElement('div');
  cb.className = 'hg-combo-badge';
  cb.textContent = n + ' COMBO!';
  arena.appendChild(cb);
  setTimeout(() => cb.remove(), 1500);
}

function hgSpawnConfetti(arena, count) {
  const colors = ['#ef4444','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899','#fbbf24'];
  for (let i = 0; i < count; i++) {
    const c = document.createElement('div');
    c.className = 'hg-confetti';
    c.style.cssText = `left:${Math.random()*1920}px;top:${-20-Math.random()*100}px;background:${colors[Math.floor(Math.random()*colors.length)]};width:${8+Math.random()*10}px;height:${8+Math.random()*10}px;border-radius:${Math.random()>.5?'50%':'2px'};--dur:${1+Math.random()*1.5}s;animation-delay:${Math.random()*.3}s`;
    arena.appendChild(c);
    setTimeout(() => c.remove(), 2500);
  }
}

function updateHgUI() {
  // Score
  const scoreEl = document.getElementById('hg-score');
  if (scoreEl) scoreEl.textContent = hg.score;

  // Target
  const targetEl = document.getElementById('hg-target');
  if (targetEl) {
    let targetText = hg.target + 'Ïõê';
    if (hg.hasCalc && hg.target > hg.money) {
      targetText += ' (ÎÇ®ÏùÄ:' + (hg.target - hg.money) + 'Ïõê)';
    }
    targetEl.textContent = targetText;
  }

  // Target bar fill
  const fillEl = document.getElementById('hg-fill');
  if (fillEl && hg.target > 0) {
    const pct = Math.min(100, (hg.money / hg.target) * 100);
    fillEl.style.width = pct + '%';
    // Color change: green -> yellow -> red as approaching target
    if (pct > 85) fillEl.style.background = 'linear-gradient(90deg,#f59e0b,#ef4444)';
    else if (pct > 60) fillEl.style.background = 'linear-gradient(90deg,#10b981,#f59e0b)';
    else fillEl.style.background = 'linear-gradient(90deg,#10b981,#34d399)';
  }

  // Wallet amount
  const wAmt = document.getElementById('hg-wallet-amt');
  if (wAmt) wAmt.textContent = hg.money + 'Ïõê';

  // Hearts
  const heartsEl = document.getElementById('hg-hearts');
  if (heartsEl) {
    let hearts = '';
    for (let i = 0; i < 5; i++) {
      if (i < hg.lives) hearts += '‚ù§Ô∏è';
      else hearts += 'üñ§';
    }
    heartsEl.textContent = hearts;
  }
}

function hgEnd() {
  hg.running = false;
  if (hg.spawnTimer) clearInterval(hg.spawnTimer);
  if (hg.animId) cancelAnimationFrame(hg.animId);

  // Clear items
  hg.items.forEach(it => it.el.remove());
  hg.items = [];

  // Save best
  if (hg.score > hg.bestScore) {
    hg.bestScore = hg.score;
    LS.setItem('econHeroBest', hg.bestScore);
  }

  // Show overlay
  document.getElementById('hg-final-score').textContent = hg.score + 'Ï†ê';
  document.getElementById('hg-over-best').textContent = 'ÏµúÍ≥† Í∏∞Î°ù: ' + hg.bestScore + 'Ï†ê';

  let msg = 'ÏûòÌñàÏñ¥Ïöî!';
  if (hg.score >= 50) msg = 'Í≤ΩÏ†ú Ï≤úÏû¨! ÎåÄÎã®Ìï¥Ïöî!';
  else if (hg.score >= 30) msg = 'ÏôÄ! Ï†ïÎßê ÏûòÌñàÏñ¥Ïöî!';
  else if (hg.score >= 15) msg = 'Î©ãÏ†∏Ïöî! Í≥ÑÏÜç Ïó∞ÏäµÌï¥Î¥êÏöî!';
  document.getElementById('hg-over-msg').textContent = msg;
  document.getElementById('hg-over').classList.remove('hidden');

  SFX.gameOver();
  speak(msg);
}

function hgRestart() {
  document.getElementById('hg-over').classList.add('hidden');
  document.getElementById('hg-pause').classList.add('hidden');

  // Clean arena
  const arena = document.getElementById('hg-arena');
  arena.querySelectorAll('.hg-coin,.hg-debt,.hg-power,.hg-score-pop,.hg-combo-badge,.hg-confetti,.hg-flash-green,.hg-flash-red,.hg-round-clear,.hg-countdown').forEach(e => e.remove());

  // Reset
  hg.score = 0; hg.lives = 5; hg.level = 1; hg.round = 0;
  hg.target = 0; hg.money = 0;
  hg.running = false; hg.paused = false;
  hg.items = []; hg.walletX = 960;
  hg.combo = 0; hg.maxCombo = 0;
  hg.hasPiggy = false; hg.hasCalc = false;
  hg.dragging = false;

  if (hg.spawnTimer) clearInterval(hg.spawnTimer);
  if (hg.animId) cancelAnimationFrame(hg.animId);

  // Reposition wallet
  if (hg.walletEl) hg.walletEl.style.left = '960px';
  const wAmt = document.getElementById('hg-wallet-amt');
  if (wAmt) wAmt.textContent = '0Ïõê';

  document.getElementById('hg-bg').innerHTML = makeMarketBgSVG(1);

  hgCountdown(() => {
    hg.running = true;
    hg.target = hgGenerateTarget(1);
    hg.round = 1;
    updateHgUI();
    hgMainLoop();
    SFX.gameStart();
  });
}

function hgPause() {
  hg.paused = !hg.paused;
  document.getElementById('hg-pause').classList.toggle('hidden', !hg.paused);
  if (hg.paused) {
    if (hg.spawnTimer) clearInterval(hg.spawnTimer);
  } else {
    // Resume spawn
    const interval = Math.max(600, 2000 - hg.level * 150);
    hg.spawnTimer = setInterval(() => {
      if (!hg.paused && hg.running) hgSpawnItem();
    }, interval);
  }
}

function hgExit() {
  hg.running = false;
  if (hg.spawnTimer) clearInterval(hg.spawnTimer);
  if (hg.animId) cancelAnimationFrame(hg.animId);
  hg.items.forEach(it => it.el.remove());
  hg.items = [];
  document.getElementById('hg-over').classList.add('hidden');
  document.getElementById('hg-pause').classList.add('hidden');
  document.getElementById('hero-game').classList.add('hidden');
  speechSynthesis.cancel();
  if(document.fullscreenElement)document.exitFullscreen?.();
}

// ===== Ï¥àÍ∏∞Ìôî =====
document.addEventListener('DOMContentLoaded', function() {
  // fitScale
  function fitScale() {
    const c = document.querySelector('.container');
    if (!c || getComputedStyle(c).display === 'none') return;
    const M = 0.03;
    const vp = window.visualViewport || {width: window.innerWidth, height: window.innerHeight};
    const aW = vp.width * (1 - M * 2);
    const aH = vp.height * (1 - M * 2);
    const s = Math.min(aW / 1920, aH / 1080);
    c.style.transform = `scale(${s})`;
    c.style.left = ((vp.width - 1920 * s) / 2) + 'px';
    c.style.top = ((vp.height - 1080 * s) / 2) + 'px';
  }
  fitScale();
  window.addEventListener('resize', fitScale);
  if (window.visualViewport) window.visualViewport.addEventListener('resize', fitScale);

  // ÌîÑÎ°úÌïÑ ‚Äî _prevMainLevel Ï¥àÍ∏∞Ìôî (Ï≤´ updateProfile Ìò∏Ï∂ú Ïãú false level-up Î∞©ÏßÄ)
  const _p = JSON.parse(localStorage.getItem('economy_profile')||'{}');
  _prevMainLevel = Math.floor((_p.totalCorrect||0) / 10) + 1;
  updateProfile();
  updateActionButtons();

  // ÎßàÏä§ÏΩîÌä∏ Ï¥àÍ∏∞Ìôî
  updateMascotTab('fish');

  // Í≤åÏûÑ Ï¥àÍ∏∞Ìôî
  initFishGame();
  initWalletGame();
  initTradeGame();
});

// ÎçîÎ∏îÌÉ≠ Î∞©ÏßÄ
let lastTouchEnd = 0;
document.addEventListener('touchend', function(e) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) e.preventDefault();
  lastTouchEnd = now;
}, false);
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
    if (hg.running && !hg.paused) hgPause();
  }
});
window.matchMedia('(orientation: portrait)').addEventListener('change', e => {
  if (e.matches) {
    speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
    if (hg.running && !hg.paused) hgPause();
  }
});
</script>
</body>
</html>
