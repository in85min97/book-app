<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ÎèôÎ¨º ÎÜÄÏù¥ÌÑ∞ üêæ</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}
body{font-family:'Noto Sans KR',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#65a30d 0%,#84cc16 50%,#4d7c0f 100%);margin:0;padding:0;width:100vw;height:100vh;height:100dvh;overflow:hidden;touch-action:manipulation}
.rotate-notice{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#65a30d,#84cc16);z-index:9999;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-size:24px;font-weight:700;text-align:center;gap:20px}
.rotate-notice .rotate-icon{font-size:80px;animation:rotateH 2s ease-in-out infinite}
@keyframes rotateH{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
@media(orientation:portrait){.rotate-notice{display:flex}.container{display:none!important}}
.container{width:1920px;height:1080px;background:#fff;border-radius:25px;box-shadow:0 25px 50px rgba(0,0,0,.12);display:flex;flex-direction:column;overflow:hidden;transform-origin:0 0;position:absolute}

/* Í≥ºÎ™©Î∞î */
.subject-bar{background:linear-gradient(135deg,#1e3a8a,#3b82f6);display:flex;align-items:center;padding:0 20px;height:56px;flex-shrink:0;gap:4px;position:relative}
.subject-bar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#fbbf24,#f59e0b,#fbbf24)}
.sb-tab{padding:8px 30px;border:none;border-radius:12px 12px 0 0;background:0;font-size:18px;font-weight:800;color:rgba(255,255,255,.5);cursor:pointer;font-family:inherit;transition:.2s;display:flex;align-items:center;gap:8px;text-decoration:none}
.sb-tab.active{background:#fff;color:#1e3a8a}
.sb-tab.locked{cursor:default}
.sb-tab .lock{font-size:12px;opacity:.5}
.sb-spacer{flex:1}
.sb-btns{display:flex;gap:8px}
.sb-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);border-radius:10px;padding:6px 14px;font-size:18px;color:#fff;cursor:pointer;transition:.15s}
.sb-btn:active{background:rgba(255,255,255,.3)}

/* Î©îÏù∏ */
.main-layout{display:grid;grid-template-columns:300px 1fr 300px;gap:14px;padding:14px;flex:1;overflow:hidden}

/* ÏôºÏ™Ω */
.left-panel{display:flex;flex-direction:column;gap:10px;overflow:hidden}
.profile-section{background:linear-gradient(145deg,#4d7c0f,#65a30d 50%,#84cc16);border-radius:20px;padding:20px;border:3px solid #d9f99d;box-shadow:0 6px 20px rgba(101,163,13,.3);flex-shrink:0;position:relative;overflow:hidden}
.profile-section::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='15' cy='15' r='1.5' fill='white' opacity='.3'><animate attributeName='opacity' values='.3;.1;.3' dur='2s' repeatCount='indefinite'/></circle><circle cx='85' cy='25' r='1' fill='white' opacity='.25'><animate attributeName='opacity' values='.25;.08;.25' dur='1.5s' repeatCount='indefinite'/></circle><circle cx='25' cy='75' r='1.2' fill='white' opacity='.3'><animate attributeName='opacity' values='.3;.1;.3' dur='1.8s' repeatCount='indefinite'/></circle></svg>") repeat;pointer-events:none}
.profile-content{position:relative;z-index:1;display:flex;align-items:center;gap:15px}
.profile-avatar{width:90px;height:90px;background:linear-gradient(145deg,#bef264,#a3e635);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;border:3px solid #fff;box-shadow:0 4px 15px rgba(190,242,100,.4);animation:avGlow 3s ease-in-out infinite;flex-shrink:0;cursor:pointer}
@keyframes avGlow{0%,100%{box-shadow:0 4px 15px rgba(190,242,100,.4);transform:scale(1)}50%{box-shadow:0 8px 25px rgba(190,242,100,.6);transform:scale(1.05)}}
.profile-info{flex:1;color:#fff}
.profile-name{font-size:28px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,.3);margin-bottom:8px;cursor:pointer}
.profile-level-container{background:rgba(255,255,255,.2);border-radius:12px;padding:8px 12px}
.profile-level{font-size:22px;font-weight:700;color:#d9f99d;display:flex;align-items:center;gap:8px}
.level-badge{background:linear-gradient(145deg,#bef264,#a3e635);color:#365314;padding:4px 12px;border-radius:8px;font-size:22px;font-weight:800;border:1px solid #fff}
.progress-bar{width:100%;height:6px;background:rgba(255,255,255,.3);border-radius:3px;margin-top:5px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#bef264,#a3e635,#bef264);background-size:200% 100%;border-radius:3px;transition:width .5s;animation:pShine 2s linear infinite}
@keyframes pShine{0%{background-position:-200% 0}100%{background-position:200% 0}}

/* ÌÉ≠ */
.tab-headers{display:grid;grid-template-columns:1fr 1fr;gap:8px;flex-shrink:0}
.tab-btn{background:linear-gradient(145deg,#e2e8f0,#cbd5e1);border:2px solid #94a3b8;border-radius:12px;padding:8px;font-size:20px;font-weight:700;cursor:pointer;transition:.2s;color:#475569;display:flex;align-items:center;justify-content:center;height:62px;white-space:nowrap;font-family:inherit}
.tab-btn.active{background:linear-gradient(145deg,#65a30d,#4d7c0f);color:#fff;border-color:#65a30d}
.tab-btn:active{transform:scale(.97)}
.tab-content{display:none;flex:1;overflow:hidden}
.tab-content.active{display:flex;flex-direction:column}

/* ÏÇ¨Ïù¥Îìú Ï†ïÎ≥¥ */
.side-info{background:linear-gradient(145deg,#f7fee7,#ecfccb);border-radius:16px;padding:18px;border:2px solid #84cc16;display:flex;flex-direction:column;gap:12px;height:100%;overflow:hidden}
.side-title{font-size:28px;font-weight:700;color:#365314;text-align:center;flex-shrink:0}
.side-stat{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#fff;border-radius:8px;font-size:22px;font-weight:600;color:#1e293b}
.side-val{font-size:36px;font-weight:800;color:#65a30d}

/* Í≤åÏûÑ Îü∞Ïπò */
.game-launch-btn{flex-shrink:0;background:linear-gradient(145deg,#bef264,#a3e635);color:#365314;border:3px solid #fff;border-radius:16px;padding:14px;font-size:24px;font-weight:800;cursor:pointer;text-align:center;box-shadow:0 4px 15px rgba(190,242,100,.4);font-family:inherit;animation:gPulse 2s ease-in-out infinite;white-space:nowrap}
@keyframes gPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
.game-launch-btn:active{transform:scale(.97)}

/* Ï§ëÏïô */
.center-panel{display:flex;flex-direction:column;overflow:hidden;position:relative}
.game-view{display:none;flex-direction:column;flex:1;overflow:hidden}
.game-view.active{display:flex}

/* ===== ÏàòÏùòÏÇ¨ ÎÜÄÏù¥ ===== */
.vet-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;gap:16px;padding:10px 20px;overflow:hidden}
.vet-bg-deco{position:absolute;inset:0;pointer-events:none;z-index:0;opacity:.12}
.vet-info{font-size:32px;font-weight:800;color:#365314;text-align:center;padding:12px 24px;background:linear-gradient(145deg,#f0fdf4,#dcfce7);border-radius:14px;border:2px solid #86efac}
.vet-stage{flex:1;display:flex;align-items:center;justify-content:center;position:relative;width:100%;z-index:1}
.vet-animal-container{position:relative;width:100%;max-width:600px;height:100%;max-height:550px;display:flex;align-items:center;justify-content:center}
.vet-animal-svg{width:100%;height:100%;max-width:500px;max-height:500px;filter:drop-shadow(0 8px 20px rgba(0,0,0,.15))}
.vet-sick-indicator{position:absolute;top:20px;right:20px;font-size:70px;animation:sickPulse 1s ease-in-out infinite}
@keyframes sickPulse{0%,100%{transform:scale(1);opacity:.8}50%{transform:scale(1.3);opacity:1}}
.vet-hearts{position:absolute;inset:0;pointer-events:none;overflow:hidden}
.vet-heart{position:absolute;font-size:30px;animation:heartFloat 1.5s ease-out forwards;pointer-events:none}
@keyframes heartFloat{0%{transform:translate(0,0) scale(0);opacity:0}30%{transform:translate(var(--tx),var(--ty)) scale(1.2);opacity:1}100%{transform:translate(var(--tx),calc(var(--ty) - 80px)) scale(.6);opacity:0}}
.vet-tool-palette{display:flex;gap:30px;padding:20px 40px;background:linear-gradient(145deg,#f0fdf4,#dcfce7);border-radius:20px;border:2px solid #86efac;z-index:1;position:relative}
.vet-tool{width:170px;height:170px;background:linear-gradient(145deg,#fff,#f0fdf4);border:3px solid #86efac;border-radius:24px;display:flex;align-items:center;justify-content:center;cursor:grab;transition:.15s;box-shadow:0 4px 12px rgba(0,0,0,.08);position:relative}
.vet-tool:active{transform:scale(.9);cursor:grabbing}
.vet-tool.used{opacity:.3;pointer-events:none;border-color:#d1d5db}
.vet-tool-label{position:absolute;bottom:-8px;font-size:18px;font-weight:700;color:#365314;background:#ecfccb;padding:4px 12px;border-radius:8px;white-space:nowrap}
.vet-dropzone{position:absolute;inset:0;border-radius:50%;z-index:5}
.vet-success-overlay{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:10}
.vet-sparkle{position:absolute;pointer-events:none;animation:vetSparkle var(--dur,.8s) ease-out forwards}
@keyframes vetSparkle{0%{transform:translate(0,0) scale(0) rotate(0deg);opacity:0}30%{transform:translate(calc(var(--tx)*.3),calc(var(--ty)*.3)) scale(1.2) rotate(180deg);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0) rotate(360deg);opacity:0}}

/* ===== Î∞• Ï§ò! ===== */
.feed-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;gap:20px;padding:10px 20px}
.feed-info{font-size:32px;font-weight:800;color:#365314;text-align:center;padding:12px 24px;background:linear-gradient(145deg,#f0fdf4,#dcfce7);border-radius:14px;border:2px solid #86efac}
.feed-stage{display:flex;align-items:center;justify-content:center;gap:30px;position:relative}
.feed-animal{width:350px;height:350px;display:flex;align-items:center;justify-content:center;position:relative;filter:drop-shadow(0 6px 16px rgba(0,0,0,.12))}
.feed-animal-speech{position:absolute;top:-45px;left:50%;transform:translateX(-50%);background:#fff;border:2px solid #e2e8f0;border-radius:16px;padding:8px 18px;font-size:24px;font-weight:700;color:#1e293b;white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:5}
.feed-animal-speech::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid #fff}
.feed-type-badge{position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);font-size:20px;font-weight:800;padding:6px 14px;border-radius:10px;white-space:nowrap}
.feed-type-herb{background:#dcfce7;color:#166534;border:1px solid #86efac}
.feed-type-carn{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
.feed-type-omni{background:#fef3c7;color:#92400e;border:1px solid #fcd34d}
.food-choices{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;width:100%;max-width:900px}
.food-choice{background:linear-gradient(145deg,#fff,#f8fafc);border:3px solid #e2e8f0;border-radius:20px;height:200px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.15s;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.food-choice:active{transform:scale(.9)}
.food-choice.correct{background:linear-gradient(145deg,#dcfce7,#bbf7d0)!important;border-color:#22c55e!important;animation:correctBounce .5s ease}
.food-choice.wrong{background:linear-gradient(145deg,#fee2e2,#fecaca)!important;border-color:#ef4444!important;animation:shake .5s}
@keyframes correctBounce{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.feed-result{font-size:26px;font-weight:700;text-align:center;min-height:36px;padding:8px}
.feed-spit{position:absolute;pointer-events:none;z-index:15;animation:spitAnim .8s ease-out forwards}
@keyframes spitAnim{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx,80px),var(--ty,-60px)) scale(.3) rotate(360deg);opacity:0}}
.feed-yum{position:absolute;pointer-events:none;z-index:15;font-size:28px;font-weight:900;animation:feedYum .8s ease-out forwards}
@keyframes feedYum{0%{transform:translate(-50%,0) scale(0);opacity:0}30%{transform:translate(-50%,-20px) scale(1.2);opacity:1}100%{transform:translate(-50%,-60px) scale(.6);opacity:0}}
.feed-confetti{position:absolute;width:8px;height:8px;border-radius:2px;pointer-events:none;animation:feedConf var(--dur,1s) ease-out forwards}
@keyframes feedConf{0%{transform:translate(0,0) rotate(0deg);opacity:1}100%{transform:translate(var(--tx,0),var(--ty,200px)) rotate(720deg);opacity:0}}

/* ===== Î≥ÄÏã† Ïï®Î≤î ===== */
.transform-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:10px 20px;position:relative}
.transform-info{font-size:32px;font-weight:800;color:#365314;text-align:center;padding:12px 24px;background:linear-gradient(145deg,#f0fdf4,#dcfce7);border-radius:14px;border:2px solid #86efac}
.transform-set-name{font-size:30px;font-weight:800;color:#1e293b;margin-bottom:4px}
.slot-row{display:flex;gap:14px;align-items:center}
.slot-box{width:230px;height:230px;background:linear-gradient(145deg,#f8fafc,#e2e8f0);border:3px dashed #94a3b8;border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:150px;position:relative;transition:.2s}
.slot-box.filled{border-style:solid;border-color:#22c55e;background:linear-gradient(145deg,#dcfce7,#bbf7d0)}
.slot-box.wrong-slot{border-color:#ef4444;background:linear-gradient(145deg,#fee2e2,#fecaca);animation:shake .5s}
.slot-arrow{font-size:50px;color:#94a3b8;font-weight:900}
.slot-num{position:absolute;top:6px;left:10px;font-size:18px;font-weight:800;color:#64748b;background:#f1f5f9;padding:3px 10px;border-radius:6px}
.card-pool{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;max-width:1000px}
.stage-card{width:200px;height:200px;background:linear-gradient(145deg,#fff,#f0fdf4);border:3px solid #86efac;border-radius:18px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:grab;transition:.15s;box-shadow:0 4px 12px rgba(0,0,0,.08);gap:4px}
.stage-card:active{transform:scale(.9);cursor:grabbing}
.stage-card .card-emoji{font-size:110px}
.stage-card .card-label{font-size:22px;font-weight:700;color:#365314}
.stage-card.placed{opacity:.3;pointer-events:none}
.transform-anim-overlay{position:absolute;inset:0;pointer-events:none;z-index:20;display:flex;align-items:center;justify-content:center}
.transform-morph{font-size:120px;animation:morphPop 2s ease-in-out forwards}
@keyframes morphPop{0%{transform:scale(0) rotate(-30deg);opacity:0}20%{transform:scale(1.3) rotate(10deg);opacity:1}40%{transform:scale(.8) rotate(-5deg);opacity:1}60%{transform:scale(1.1) rotate(3deg);opacity:1}80%{transform:scale(1) rotate(0);opacity:1}100%{transform:scale(1) rotate(0) translateY(-20px);opacity:0}}
.transform-sparkle-ring{position:absolute;border-radius:50%;pointer-events:none;animation:tSparkRing .8s ease-out forwards}
@keyframes tSparkRing{0%{transform:translate(-50%,-50%) scale(0);opacity:.8}100%{transform:translate(-50%,-50%) scale(1);opacity:0}}
.transform-wrong-result{position:absolute;font-size:80px;pointer-events:none;z-index:25;animation:wrongPop 2s ease-out forwards}
@keyframes wrongPop{0%{transform:translate(-50%,-50%) scale(0) rotate(-20deg);opacity:0}20%{transform:translate(-50%,-50%) scale(1.2) rotate(10deg);opacity:1}100%{transform:translate(-50%,-50%) scale(.6) rotate(0) translateY(-40px);opacity:0}}

/* ===== ÎÇ¥ Í∏∞Î°ù ===== */
.records-area{flex:1;display:flex;flex-direction:column;gap:16px;padding:20px;overflow-y:auto}
.record-card{background:linear-gradient(145deg,#fff,#f8fafc);border:2px solid #e2e8f0;border-radius:16px;padding:22px;box-shadow:0 4px 12px rgba(0,0,0,.06);flex:1}
.record-card:last-child{flex:1}
.record-card h3{font-size:28px;font-weight:800;color:#1e293b;margin-bottom:10px}
.record-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.record-item{text-align:center;padding:16px;background:linear-gradient(145deg,#f7fee7,#ecfccb);border-radius:12px;border:2px solid #d9f99d}
.record-num{font-size:46px;font-weight:900;color:#65a30d}
.record-label{font-size:20px;font-weight:600;color:#365314;margin-top:4px}

/* Ïò§Î•∏Ï™Ω */
.right-panel{display:flex;flex-direction:column;gap:12px;overflow:hidden}
.action-btn{border:none;border-radius:20px;font-size:36px;font-weight:800;cursor:pointer;transition:.1s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;flex:1;min-height:60px;font-family:inherit;color:#fff}
.action-btn .icon{font-size:62px;opacity:.9}
.action-btn:active{transform:scale(.95)}
.action-btn.btn-lime{background:linear-gradient(145deg,#84cc16,#65a30d);box-shadow:0 2px 8px rgba(132,204,22,.3)}
.action-btn.btn-cyan{background:linear-gradient(145deg,#06b6d4,#0891b2);box-shadow:0 2px 8px rgba(6,182,212,.2)}
.action-btn.btn-red{background:linear-gradient(145deg,#f87171,#ef4444);box-shadow:0 2px 8px rgba(248,113,113,.2)}
.action-btn.btn-green{background:linear-gradient(145deg,#10b981,#059669);box-shadow:0 2px 8px rgba(16,185,129,.2)}
.action-btn.btn-orange{background:linear-gradient(145deg,#f97316,#ea580c);box-shadow:0 2px 8px rgba(249,115,22,.2)}
.action-btn:disabled{background:linear-gradient(145deg,#e5e7eb,#d1d5db)!important;color:#9ca3af;cursor:not-allowed;box-shadow:none}

/* ===== ÌûàÏñ¥Î°ú: ÏÑúÏãùÏßÄ Î∂ÑÎ•òÏôï ===== */
.hero-game{position:absolute;top:0;left:0;width:1920px;height:1080px;z-index:5000;display:flex;flex-direction:column;overflow:hidden}
.hero-game.hidden{display:none}
.hg-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(255,255,255,.35);backdrop-filter:blur(12px);flex-shrink:0;z-index:10;border-bottom:2px solid rgba(255,255,255,.4)}
.hg-stat{font-size:28px;font-weight:800;color:#1e3a8a}
.hg-hearts{font-size:30px;letter-spacing:3px}
.hg-combo{font-size:26px;font-weight:800;color:#f59e0b}
.hg-ctrls{display:flex;gap:8px}
.hg-ctrl-btn{background:rgba(255,255,255,.6);border:2px solid rgba(255,255,255,.8);border-radius:50%;width:44px;height:44px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#475569}
.hg-ctrl-btn:active{transform:scale(.9)}
.hg-arena{flex:1;position:relative;overflow:hidden}
.hg-biome{position:absolute;bottom:0;width:50%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:20px;transition:all .5s}
.hg-biome.left{left:0}
.hg-biome.right{right:0}
.hg-biome-label{font-size:44px;font-weight:900;color:#fff;text-shadow:0 3px 8px rgba(0,0,0,.4);padding:12px 36px;border-radius:20px;background:rgba(0,0,0,.25);backdrop-filter:blur(4px);margin-bottom:10px;z-index:5}
.hg-biome-ground{position:absolute;bottom:0;left:0;right:0;height:25%;border-radius:50% 50% 0 0/30px 30px 0 0;z-index:1}
.hg-biome-icon{font-size:120px;z-index:2;margin-bottom:10px}
.hg-divider{position:absolute;left:50%;top:0;bottom:0;width:4px;background:rgba(255,255,255,.4);transform:translateX(-50%);z-index:5}
/* 3/4 biome mode */
.hg-biome.third{width:33.33%}
.hg-biome.third.b0{left:0}
.hg-biome.third.b1{left:33.33%}
.hg-biome.third.b2{left:66.66%}
.hg-biome.fourth{width:25%}
.hg-biome.fourth.b0{left:0}
.hg-biome.fourth.b1{left:25%}
.hg-biome.fourth.b2{left:50%}
.hg-biome.fourth.b3{left:75%}
.hg-divider2{position:absolute;left:33.33%;top:0;bottom:0;width:4px;background:rgba(255,255,255,.4);transform:translateX(-50%);z-index:5;display:none}
.hg-divider3{position:absolute;left:66.66%;top:0;bottom:0;width:4px;background:rgba(255,255,255,.4);transform:translateX(-50%);z-index:5;display:none}
.hg-divider4{position:absolute;left:25%;top:0;bottom:0;width:4px;background:rgba(255,255,255,.4);transform:translateX(-50%);z-index:5;display:none}
.hg-divider5{position:absolute;left:75%;top:0;bottom:0;width:4px;background:rgba(255,255,255,.4);transform:translateX(-50%);z-index:5;display:none}
.falling-animal{position:absolute;z-index:15;pointer-events:auto;cursor:pointer;filter:drop-shadow(0 4px 12px rgba(0,0,0,.2));transition:none;touch-action:none}
.falling-animal.dragging{z-index:50;transform:scale(1.2);filter:drop-shadow(0 8px 20px rgba(0,0,0,.3))}
.falling-animal.placed{pointer-events:none}
.hg-flash-green{position:absolute;inset:0;pointer-events:none;z-index:30;animation:screenFlashG .3s ease-out forwards}
@keyframes screenFlashG{0%{background:rgba(34,197,94,.3)}100%{background:transparent}}
.hg-flash-red{position:absolute;inset:0;pointer-events:none;z-index:30;animation:screenFlashR .4s ease-out forwards}
@keyframes screenFlashR{0%{background:rgba(239,68,68,.3)}50%{background:rgba(239,68,68,.15)}100%{background:transparent}}
.hg-arena-shake{animation:arenaShake .4s ease-out}
@keyframes arenaShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
.hg-animal-confused{animation:confused .5s ease-in-out 2}
@keyframes confused{0%,100%{transform:rotate(0)}25%{transform:rotate(-15deg)}75%{transform:rotate(15deg)}}
.hg-score-pop{position:absolute;font-size:40px;font-weight:900;color:#22c55e;text-shadow:0 2px 6px rgba(0,0,0,.2);pointer-events:none;z-index:40;animation:scorePop .8s ease-out forwards}
@keyframes scorePop{0%{transform:translate(-50%,0) scale(0);opacity:0}30%{transform:translate(-50%,-15px) scale(1.2);opacity:1}100%{transform:translate(-50%,-50px) scale(.7);opacity:0}}
.hg-combo-text{position:absolute;top:50%;left:50%;font-size:72px;font-weight:900;color:#f59e0b;text-shadow:0 4px 8px rgba(0,0,0,.3);pointer-events:none;z-index:50;animation:comboPop 1s ease-out forwards}
@keyframes comboPop{0%{transform:translate(-50%,-50%) scale(0);opacity:0}30%{transform:translate(-50%,-50%) scale(1.2);opacity:1}100%{transform:translate(-50%,-50%) scale(.8);opacity:0}}
.hg-powerup{position:absolute;font-size:64px;z-index:15;pointer-events:auto;cursor:pointer;animation:powerFloat 2s ease-in-out infinite;filter:drop-shadow(0 4px 12px rgba(251,191,36,.4))}
@keyframes powerFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.hg-cloud{position:absolute;font-size:36px;opacity:.2;pointer-events:none;animation:cFloat 25s linear infinite;z-index:1}
@keyframes cFloat{0%{transform:translateX(-100px)}100%{transform:translateX(calc(100vw + 100px))}}
.hg-overlay{position:absolute;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(5px)}
.hg-overlay.hidden{display:none}
.hg-overlay-box{background:#fff;border-radius:24px;padding:40px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.3);min-width:320px}
.hg-overlay-box h2{font-size:42px;font-weight:900;color:#1e293b;margin-bottom:12px}
.hg-overlay-box .score{font-size:34px;font-weight:700;color:#65a30d;margin-bottom:8px}
.hg-overlay-box .msg{font-size:24px;color:#64748b;margin-bottom:20px}
.hg-overlay-box button{display:block;width:100%;padding:16px;border:none;border-radius:14px;font-size:24px;font-weight:800;cursor:pointer;margin-bottom:8px;font-family:inherit}
.hg-overlay-box .btn-retry{background:linear-gradient(145deg,#84cc16,#65a30d);color:#fff}
.hg-overlay-box .btn-exit{background:linear-gradient(145deg,#e2e8f0,#cbd5e1);color:#475569}
.hg-start-screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;z-index:60;background:rgba(0,0,0,.5);backdrop-filter:blur(8px)}
.hg-start-screen.hidden{display:none}
.hg-start-title{font-size:48px;font-weight:900;color:#fff;text-shadow:0 4px 12px rgba(0,0,0,.3)}
.hg-start-desc{font-size:20px;color:#d9f99d;font-weight:600}
.hg-start-btn{background:linear-gradient(145deg,#84cc16,#65a30d);color:#fff;border:4px solid #d9f99d;border-radius:24px;padding:24px 60px;font-size:36px;font-weight:900;cursor:pointer;font-family:inherit;box-shadow:0 8px 24px rgba(132,204,22,.4);animation:gPulse 2s ease-in-out infinite}
.hg-start-btn:active{transform:scale(.95)}

/* Î™®Îã¨ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:6000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px)}
.modal-overlay.hidden{display:none}
.modal-box{background:#fff;border-radius:20px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,.3)}
.modal-head{background:linear-gradient(145deg,#65a30d,#84cc16);color:#fff;padding:16px 20px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center}
.modal-head h3{margin:0;font-size:18px}
.modal-close{background:0;border:0;color:#fff;font-size:24px;cursor:pointer}
.modal-body{padding:20px}
.modal-section{margin-bottom:16px;padding:14px;border-radius:10px;background:#f8fafc}
.modal-section h4{margin:0 0 10px;font-weight:700;color:#374151;font-size:15px}
.modal-input{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;margin-bottom:8px}
.modal-input:focus{outline:none;border-color:#65a30d}
.modal-btn{padding:10px 16px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;width:100%;background:linear-gradient(145deg,#65a30d,#84cc16);color:#fff;margin-top:6px}
.char-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:12px}
.char-item{background:linear-gradient(145deg,#f8fafc,#e2e8f0);border:2px solid #cbd5e1;border-radius:14px;padding:12px;text-align:center;cursor:pointer;font-size:32px;height:70px;display:flex;align-items:center;justify-content:center;transition:.2s}
.char-item.selected{background:linear-gradient(145deg,#bef264,#a3e635);border-color:#a3e635}

/* ===== ÎπÑÏ£ºÏñº ÏóÖÍ∑∏Î†àÏù¥Îìú ===== */
/* ÌÉ≠Î≥Ñ Î∞∞Í≤Ω Ïî¨ */
.vet-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:
  url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 900'><rect fill='%23f0fdf4' width='1320' height='900'/><rect x='0' y='700' width='1320' height='200' rx='0' fill='%23dcfce7'/><rect x='50' y='200' width='80' height='500' rx='10' fill='%23fff' opacity='.4'/><rect x='55' y='220' width='70' height='6' rx='3' fill='%2386efac' opacity='.3'/><rect x='55' y='260' width='70' height='6' rx='3' fill='%2386efac' opacity='.3'/><rect x='55' y='300' width='70' height='6' rx='3' fill='%2386efac' opacity='.3'/><rect x='1190' y='200' width='80' height='500' rx='10' fill='%23fff' opacity='.4'/><rect x='1195' y='220' width='70' height='6' rx='3' fill='%2386efac' opacity='.3'/><rect x='1195' y='260' width='70' height='6' rx='3' fill='%2386efac' opacity='.3'/><text x='660' y='60' text-anchor='middle' font-size='30' fill='%2365a30d' opacity='.08' font-weight='900'>ANIMAL HOSPITAL</text><circle cx='200' cy='780' r='40' fill='%2386efac' opacity='.2'/><circle cx='1100' cy='770' r='35' fill='%2386efac' opacity='.15'/></svg>") center/cover no-repeat;
  opacity:.2;border-radius:16px}
.vet-view{position:relative}

.feed-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:
  url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 900'><rect fill='%23fefce8' width='1320' height='900'/><rect x='0' y='750' width='1320' height='150' fill='%23fef9c3'/><circle cx='150' cy='800' r='50' fill='%23fde68a' opacity='.2'/><circle cx='1170' cy='810' r='45' fill='%23fde68a' opacity='.15'/><text x='100' y='120' font-size='80' fill='%2365a30d' opacity='.05'>ü•¨</text><text x='1100' y='200' font-size='70' fill='%2365a30d' opacity='.05'>ü•ï</text><text x='600' y='850' font-size='60' fill='%2365a30d' opacity='.05'>üçñ</text></svg>") center/cover no-repeat;
  opacity:.25;border-radius:16px}
.feed-view{position:relative}

.transform-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:
  url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 900'><rect fill='%23ecfdf5' width='1320' height='900'/><circle cx='200' cy='450' r='200' fill='none' stroke='%234ade80' stroke-width='1' opacity='.1'><animate attributeName='r' values='200;240;200' dur='4s' repeatCount='indefinite'/></circle><circle cx='1100' cy='450' r='180' fill='none' stroke='%2384cc16' stroke-width='1' opacity='.1'><animate attributeName='r' values='180;220;180' dur='3.5s' repeatCount='indefinite'/></circle><text x='100' y='100' font-size='60' fill='%234ade80' opacity='.06'>ü•ö</text><text x='660' y='850' font-size='50' fill='%234ade80' opacity='.06'>ü¶ã</text><text x='1100' y='120' font-size='55' fill='%234ade80' opacity='.06'>üêõ</text></svg>") center/cover no-repeat;
  opacity:.25;border-radius:16px}
.transform-view{position:relative}

.record-view::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background:
  url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1320 900'><defs><linearGradient id='rg' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%23f7fee7'/><stop offset='100%' stop-color='%23ecfccb'/></linearGradient></defs><rect fill='url(%23rg)' width='1320' height='900'/><rect x='80' y='50' width='200' height='12' rx='6' fill='%2384cc16' opacity='.08'/><rect x='80' y='80' width='160' height='12' rx='6' fill='%2384cc16' opacity='.06'/><rect x='1040' y='50' width='200' height='12' rx='6' fill='%2384cc16' opacity='.08'/><text x='660' y='860' text-anchor='middle' font-size='100' fill='%2384cc16' opacity='.04' font-weight='900'>üèÜ</text></svg>") center/cover no-repeat;
  opacity:.2;border-radius:16px}
.record-view{position:relative}

/* 3D ÏïÑÏºÄÏù¥Îìú Î≤ÑÌäº */
.tab-btn{border-bottom:5px solid #7c8a9a;transition:transform .1s,border-bottom-width .1s}
.tab-btn:active{transform:translateY(3px) scaleX(1.02) scaleY(.97);border-bottom-width:2px}
.tab-btn.active{border-bottom:5px solid #365314}
.tab-btn.active:active{border-bottom-width:2px}

.action-btn{border-bottom:6px solid rgba(0,0,0,.25);transition:transform .1s,border-bottom-width .1s}
.action-btn:active{transform:translateY(4px) scaleX(1.02) scaleY(.97)!important;border-bottom-width:2px}
.action-btn.btn-lime{border-bottom-color:#365314}
.action-btn.btn-green{border-bottom-color:#047857}
.action-btn.btn-yellow{border-bottom-color:#a16207}
.action-btn.btn-red{border-bottom-color:#b91c1c}
.action-btn.btn-rose{border-bottom-color:#be123c}

.game-launch-btn{border-bottom:6px solid #4d7c0f;transition:transform .1s,border-bottom-width .1s;position:relative;overflow:hidden}
.game-launch-btn:active{transform:translateY(4px) scaleX(1.02) scaleY(.97)!important;border-bottom-width:2px;animation:none}
.game-launch-btn::after{content:'';position:absolute;top:0;left:-100%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.18),transparent);animation:btnShine 3s ease-in-out infinite}
@keyframes btnShine{0%,100%{left:-100%}50%{left:150%}}

/* Ìå®ÎÑê ÎπÑÏ£ºÏñº Î≥¥Í∞ï */
.side-info::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#84cc16,#a3e635,#bef264,#a3e635,#84cc16);border-radius:16px 16px 0 0}
.side-info{position:relative}
.side-stat{box-shadow:0 2px 6px rgba(101,163,13,.08);transition:transform .15s}
.side-stat:hover{transform:translateX(4px)}
.side-val{text-shadow:0 1px 4px rgba(101,163,13,.2)}

.right-panel::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 30%,rgba(101,163,13,.06) 0%,transparent 70%);pointer-events:none;border-radius:20px;z-index:0}
.right-panel{position:relative}
.action-btn .icon{filter:drop-shadow(0 2px 4px rgba(0,0,0,.15))}

.record-card{backdrop-filter:blur(5px);background:linear-gradient(145deg,rgba(255,255,255,.9),rgba(248,250,252,.9));transition:transform .15s}
.record-card:hover{transform:translateY(-2px)}

/* ÌÉ≠ Ï†ÑÌôò Ïï†ÎãàÎ©îÏù¥ÏÖò */
@keyframes viewFadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
.game-view.active{animation:viewFadeIn .3s ease-out}

/* Ïä§ÏΩîÏñ¥ ÌåùÏóÖ */
.score-popup{position:absolute;font-size:28px;font-weight:900;color:#65a30d;pointer-events:none;z-index:50;animation:scorePop .9s ease-out forwards;text-shadow:0 2px 4px rgba(0,0,0,.2);paint-order:stroke fill;-webkit-text-stroke:2px #fff}
@keyframes scorePop{0%{opacity:1;transform:translateY(0) scale(.5)}40%{transform:translateY(-30px) scale(1.2)}100%{opacity:0;transform:translateY(-70px) scale(.8)}}

/* Î†àÎ≤®ÏóÖ Ïò§Î≤ÑÎ†àÏù¥ */
.levelup-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9000;pointer-events:none;background:rgba(101,163,13,.15)}
.levelup-box{background:linear-gradient(145deg,#65a30d,#4d7c0f);color:#fff;padding:30px 60px;border-radius:24px;font-size:42px;font-weight:900;text-shadow:0 3px 8px rgba(0,0,0,.3);border:4px solid #bef264;box-shadow:0 12px 40px rgba(101,163,13,.5);animation:lvPop .8s cubic-bezier(.34,1.56,.64,1) forwards}
@keyframes lvPop{0%{transform:scale(0) rotate(-10deg);opacity:0}50%{transform:scale(1.15) rotate(3deg);opacity:1}100%{transform:scale(1) rotate(0);opacity:0}}

/* ÎßàÏä§ÏΩîÌä∏ */
.mascot-wrap{position:absolute;z-index:5;pointer-events:none}
.mascot-bubble{position:absolute;top:-40px;left:50%;transform:translateX(-50%);background:#fff;border-radius:12px;padding:6px 14px;font-size:14px;font-weight:700;color:#365314;white-space:nowrap;box-shadow:0 3px 10px rgba(0,0,0,.15);opacity:0;transition:opacity .3s}
.mascot-bubble.show{opacity:1}
.mascot-bubble::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);border:8px solid transparent;border-top-color:#fff}
</style>
</head>
<body>
<div class="rotate-notice"><div class="rotate-icon">üì±</div>ÌôîÎ©¥ÏùÑ Í∞ÄÎ°úÎ°ú ÎèåÎ†§Ï£ºÏÑ∏Ïöî!</div>

<div class="container">
  <div class="subject-bar">
    <button class="sb-tab active">üêæ ÎèôÎ¨º</button>
    <div class="sb-spacer"></div>
    <div class="sb-btns">
      <button class="sb-btn" id="sb-sound" onclick="toggleSound()">üîä</button>
      <button class="sb-btn" onclick="showAdmin()">‚öôÔ∏è</button>
    </div>
  </div>

  <div class="main-layout">
    <!-- ÏôºÏ™Ω Ìå®ÎÑê -->
    <div class="left-panel">
      <div class="profile-section">
        <div class="profile-content">
          <div class="profile-avatar" onclick="showCharModal()"><span id="pf-char">üêæ</span></div>
          <div class="profile-info">
            <div class="profile-name" onclick="changeName()"><span id="pf-name">ÎèôÎ¨ºÎ∞ïÏÇ¨</span></div>
            <div class="profile-level-container">
              <div class="profile-level">
                <span class="level-badge">LV.<span id="pf-level">1</span></span>
                <span id="pf-done">0</span>/<span id="pf-total">10</span>
              </div>
              <div class="progress-bar"><div class="progress-fill" id="pf-bar" style="width:0%"></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-headers">
        <button class="tab-btn active" onclick="switchTab('vet')">ü©∫ ÏàòÏùòÏÇ¨</button>
        <button class="tab-btn" onclick="switchTab('feed')">üçΩ Î∞• Ï§ò!</button>
        <button class="tab-btn" onclick="switchTab('transform')">ü¶ã Î≥ÄÏã†Ïï®Î≤î</button>
        <button class="tab-btn" onclick="switchTab('record')">üìä ÎÇ¥ Í∏∞Î°ù</button>
      </div>

      <!-- ÏàòÏùòÏÇ¨ ÏÇ¨Ïù¥Îìú -->
      <div class="tab-content vet-side active">
        <div class="side-info">
          <div class="side-title">ü©∫ ÏàòÏùòÏÇ¨ ÎÜÄÏù¥</div>
          <div class="side-stat"><span>ÏπòÎ£å ÏôÑÎ£å</span><span class="side-val" id="vet-healed">0</span></div>
          <div class="side-stat"><span>ÌòÑÏû¨ ÌôòÏûê</span><span class="side-val" id="vet-patient">?</span></div>
          <div class="side-stat"><span>Ï†êÏàò</span><span class="side-val" id="vet-score-side">0</span></div>
          <div class="side-stat"><span>Ïó∞ÏÜç ÏπòÎ£å</span><span class="side-val" id="vet-streak">0</span></div>
        </div>
      </div>

      <!-- Î∞• Ï§ò! ÏÇ¨Ïù¥Îìú -->
      <div class="tab-content feed-side">
        <div class="side-info">
          <div class="side-title">üçΩ Î∞• Ï§ò!</div>
          <div class="side-stat"><span>Î®πÏù¥Í∏∞ ÏÑ±Í≥µ</span><span class="side-val" id="feed-correct-side">0</span></div>
          <div class="side-stat"><span>Ï†êÏàò</span><span class="side-val" id="feed-score-side">0</span></div>
          <div class="side-stat"><span>Ïó∞ÏÜç ÏÑ±Í≥µ</span><span class="side-val" id="feed-streak-side">0</span></div>
        </div>
      </div>

      <!-- Î≥ÄÏã†Ïï®Î≤î ÏÇ¨Ïù¥Îìú -->
      <div class="tab-content transform-side">
        <div class="side-info">
          <div class="side-title">ü¶ã Î≥ÄÏã† Ïï®Î≤î</div>
          <div class="side-stat"><span>ÏôÑÏÑ±Ìïú Î≥ÄÏã†</span><span class="side-val" id="tf-done-side">0</span></div>
          <div class="side-stat"><span>Ï†êÏàò</span><span class="side-val" id="tf-score-side">0</span></div>
          <div class="side-stat"><span>Ïó∞ÏÜç ÏÑ±Í≥µ</span><span class="side-val" id="tf-streak-side">0</span></div>
        </div>
      </div>

      <!-- Í∏∞Î°ù ÏÇ¨Ïù¥Îìú -->
      <div class="tab-content record-side">
        <div class="side-info">
          <div class="side-title">üìä Ï¢ÖÌï© Í∏∞Î°ù</div>
          <div class="side-stat"><span>Ï¥ù Î¨∏Ï†ú</span><span class="side-val" id="rec-total">0</span></div>
          <div class="side-stat"><span>Ï†ïÎãµÎ•†</span><span class="side-val" id="rec-rate">0%</span></div>
        </div>
      </div>

      <div class="game-launch-btn" onclick="startHeroGame()">üåç ÏÑúÏãùÏßÄ Î∂ÑÎ•òÏôï ÏãúÏûë!</div>
    </div>

    <!-- Ï§ëÏïô Ìå®ÎÑê -->
    <div class="center-panel">
      <!-- ÏàòÏùòÏÇ¨ ÎÜÄÏù¥ -->
      <div class="game-view vet-view active" id="vet-view">
        <!-- ÎßàÏä§ÏΩîÌä∏ "ÌååÏö∞" ÌíÄÎ∞îÎîî (Î∞úÎ∞îÎã• Ï∫êÎ¶≠ÌÑ∞) -->
        <div class="mascot-wrap" style="bottom:8px;right:8px">
          <div class="mascot-bubble" id="bubble-vet">ÏπòÎ£å!</div>
          <svg width="90" height="126" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
            <!-- Í∑∏Î¶ºÏûê -->
            <ellipse cx="50" cy="136" rx="28" ry="4" fill="#000" opacity=".1"/>
            <!-- Îã§Î¶¨ -->
            <ellipse cx="36" cy="124" rx="12" ry="10" fill="#84cc16" stroke="#4d7c0f" stroke-width="1.5">
              <animate attributeName="ry" values="10;11;10" dur="2s" repeatCount="indefinite"/>
            </ellipse>
            <ellipse cx="64" cy="124" rx="12" ry="10" fill="#84cc16" stroke="#4d7c0f" stroke-width="1.5">
              <animate attributeName="ry" values="10;11;10" dur="2s" begin="0.5s" repeatCount="indefinite"/>
            </ellipse>
            <!-- Î™∏ÌÜµ (Î∞úÎ∞îÎã• Î™®Ïñë) -->
            <ellipse cx="50" cy="72" rx="36" ry="44" fill="url(#pawGrad)" stroke="#4d7c0f" stroke-width="2"/>
            <!-- Î∞úÍ∞ÄÎùΩ (ÏúÑÏ™Ω Ìå®Îìú) -->
            <circle cx="28" cy="32" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <circle cx="50" cy="24" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <circle cx="72" cy="32" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <!-- Î∞∞ -->
            <ellipse cx="50" cy="80" rx="20" ry="16" fill="#bef264" opacity=".7"/>
            <!-- Îàà -->
            <ellipse cx="38" cy="62" rx="7" ry="8" fill="#fff"/>
            <ellipse cx="62" cy="62" rx="7" ry="8" fill="#fff"/>
            <circle cx="39" cy="63" r="4.5" fill="#365314">
              <animate attributeName="r" values="4.5;4;4.5" dur="4s" repeatCount="indefinite"/>
            </circle>
            <circle cx="63" cy="63" r="4.5" fill="#365314">
              <animate attributeName="r" values="4.5;4;4.5" dur="4s" repeatCount="indefinite"/>
            </circle>
            <circle cx="41" cy="60" r="1.5" fill="#fff"/>
            <circle cx="65" cy="60" r="1.5" fill="#fff"/>
            <!-- Î∫® -->
            <ellipse cx="28" cy="74" rx="8" ry="5" fill="#f9a8d4" opacity=".35"/>
            <ellipse cx="72" cy="74" rx="8" ry="5" fill="#f9a8d4" opacity=".35"/>
            <!-- ÏΩî -->
            <ellipse cx="50" cy="72" rx="5" ry="3.5" fill="#4d7c0f"/>
            <!-- ÏûÖ -->
            <path id="mascot-vet-mouth" d="M44,80 Q50,88 56,80" fill="none" stroke="#365314" stroke-width="2" stroke-linecap="round"/>
            <!-- Ï≤≠ÏßÑÍ∏∞ Ïû•Ïãù -->
            <path d="M35,50 Q35,58 40,62" fill="none" stroke="#06b6d4" stroke-width="2.5" stroke-linecap="round"/>
            <circle cx="40" cy="64" r="4" fill="#06b6d4"/>
            <circle cx="40" cy="64" r="2" fill="#fff"/>
            <defs>
              <linearGradient id="pawGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#a3e635"/>
                <stop offset="100%" stop-color="#84cc16"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <div class="vet-area" id="vet-area">
          <svg class="vet-bg-deco" viewBox="0 0 1200 700" xmlns="http://www.w3.org/2000/svg">
            <!-- Ï≤≠ÏßÑÍ∏∞ -->
            <g transform="translate(80,60)" fill="none" stroke="#22c55e" stroke-width="5" stroke-linecap="round">
              <path d="M0,0 Q0,60 30,80 T60,120 Q60,150 40,160" /><circle cx="40" cy="170" r="14" fill="#22c55e"/><circle cx="40" cy="170" r="6" fill="#fff"/>
              <path d="M60,0 Q60,60 30,80"/><circle cx="0" cy="0" r="8" fill="#22c55e"/><circle cx="60" cy="0" r="8" fill="#22c55e"/>
            </g>
            <!-- Î∞òÏ∞ΩÍ≥† ÏôºÏ™ΩÏúÑ -->
            <g transform="translate(250,40) rotate(-15)">
              <rect x="0" y="0" width="100" height="40" rx="8" fill="#fbbf24"/><rect x="35" y="0" width="30" height="40" rx="4" fill="#fde68a"/><rect x="42" y="12" width="16" height="16" rx="3" fill="#f59e0b" opacity=".5"/>
            </g>
            <!-- Ï≤¥Ïò®Í≥Ñ Ïò§Î•∏Ï™Ω -->
            <g transform="translate(1050,80) rotate(20)">
              <rect x="0" y="0" width="14" height="120" rx="7" fill="#e2e8f0"/><circle cx="7" cy="130" r="16" fill="#ef4444"/><circle cx="7" cy="130" r="10" fill="#fca5a5"/>
              <rect x="4" y="30" width="6" height="60" rx="3" fill="#ef4444" opacity=".6"/>
            </g>
            <!-- ÌïòÌä∏ -->
            <g transform="translate(1100,300)" fill="#f87171" opacity=".6"><path d="M0,-15 C-10,-30 -30,-20 -25,-5 C-20,10 0,25 0,25 C0,25 20,10 25,-5 C30,-20 10,-30 0,-15Z"><animate attributeName="transform" type="scale" values="1;1.1;1" dur="2s" repeatCount="indefinite"/></path></g>
            <!-- Î∞òÏ∞ΩÍ≥† Ïò§Î•∏Ï™ΩÏïÑÎûò -->
            <g transform="translate(950,550) rotate(25)">
              <rect x="0" y="0" width="80" height="32" rx="6" fill="#fbbf24" opacity=".7"/><rect x="28" y="0" width="24" height="32" rx="3" fill="#fde68a"/><rect x="34" y="10" width="12" height="12" rx="2" fill="#f59e0b" opacity=".4"/>
            </g>
            <!-- Ïã≠ÏûêÍ∞Ä ÎßàÌÅ¨Îì§ -->
            <g fill="#22c55e" opacity=".3">
              <rect x="170" y="550" width="8" height="30" rx="4"/><rect x="159" y="561" width="30" height="8" rx="4"/>
              <rect x="900" y="100" width="6" height="24" rx="3"/><rect x="891" y="109" width="24" height="6" rx="3"/>
              <rect x="600" y="620" width="7" height="26" rx="3.5"/><rect x="590" y="630" width="26" height="7" rx="3.5"/>
            </g>
            <!-- Î∞òÏßùÏù¥ Ï†êÎì§ -->
            <circle cx="500" cy="50" r="4" fill="#86efac" opacity=".4"><animate attributeName="opacity" values=".4;.1;.4" dur="2.5s" repeatCount="indefinite"/></circle>
            <circle cx="800" cy="600" r="3" fill="#a7f3d0" opacity=".3"><animate attributeName="opacity" values=".3;.08;.3" dur="3s" repeatCount="indefinite"/></circle>
            <circle cx="150" cy="400" r="3.5" fill="#bbf7d0" opacity=".35"><animate attributeName="opacity" values=".35;.1;.35" dur="2s" repeatCount="indefinite"/></circle>
          </svg>
          <div class="vet-info" id="vet-info" style="position:relative;z-index:1">ü©∫ ÏïÑÌîà ÎèôÎ¨ºÏùÑ ÏπòÎ£åÌï¥ Ï£ºÏÑ∏Ïöî!</div>
          <div class="vet-stage" id="vet-stage">
            <div class="vet-animal-container" id="vet-animal-container">
              <div id="vet-animal-display" style="position:relative;display:flex;align-items:center;justify-content:center">
                üê∂
                <div class="vet-sick-indicator" id="vet-sick-indicator">üíß</div>
              </div>
              <div class="vet-dropzone" id="vet-dropzone"></div>
              <div class="vet-hearts" id="vet-hearts"></div>
            </div>
          </div>
          <div class="vet-tool-palette" id="vet-tool-palette"></div>
        </div>
      </div>

      <!-- Î∞• Ï§ò! -->
      <div class="game-view feed-view" id="feed-view">
        <!-- ÎßàÏä§ÏΩîÌä∏ "ÌååÏö∞" Î∞•Ï§ò Î≤ÑÏ†Ñ -->
        <div class="mascot-wrap" style="bottom:8px;right:8px">
          <div class="mascot-bubble" id="bubble-feed">ÎÉ†ÎÉ†!</div>
          <svg width="90" height="126" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="50" cy="136" rx="28" ry="4" fill="#000" opacity=".1"/>
            <ellipse cx="36" cy="124" rx="12" ry="10" fill="#84cc16" stroke="#4d7c0f" stroke-width="1.5">
              <animate attributeName="ry" values="10;11;10" dur="2s" repeatCount="indefinite"/>
            </ellipse>
            <ellipse cx="64" cy="124" rx="12" ry="10" fill="#84cc16" stroke="#4d7c0f" stroke-width="1.5">
              <animate attributeName="ry" values="10;11;10" dur="2s" begin="0.5s" repeatCount="indefinite"/>
            </ellipse>
            <ellipse cx="50" cy="72" rx="36" ry="44" fill="url(#pawGrad2)" stroke="#4d7c0f" stroke-width="2"/>
            <circle cx="28" cy="32" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <circle cx="50" cy="24" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <circle cx="72" cy="32" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <ellipse cx="50" cy="80" rx="20" ry="16" fill="#bef264" opacity=".7"/>
            <ellipse cx="38" cy="62" rx="7" ry="8" fill="#fff"/>
            <ellipse cx="62" cy="62" rx="7" ry="8" fill="#fff"/>
            <circle cx="39" cy="63" r="4.5" fill="#365314"><animate attributeName="r" values="4.5;4;4.5" dur="4s" repeatCount="indefinite"/></circle>
            <circle cx="63" cy="63" r="4.5" fill="#365314"><animate attributeName="r" values="4.5;4;4.5" dur="4s" repeatCount="indefinite"/></circle>
            <circle cx="41" cy="60" r="1.5" fill="#fff"/>
            <circle cx="65" cy="60" r="1.5" fill="#fff"/>
            <ellipse cx="28" cy="74" rx="8" ry="5" fill="#f9a8d4" opacity=".35"/>
            <ellipse cx="72" cy="74" rx="8" ry="5" fill="#f9a8d4" opacity=".35"/>
            <ellipse cx="50" cy="72" rx="5" ry="3.5" fill="#4d7c0f"/>
            <path id="mascot-feed-mouth" d="M44,80 Q50,88 56,80" fill="none" stroke="#365314" stroke-width="2" stroke-linecap="round"/>
            <!-- Ìè¨ÌÅ¨&ÎÇòÏù¥ÌîÑ Ïû•Ïãù -->
            <line x1="70" y1="46" x2="70" y2="56" stroke="#94a3b8" stroke-width="2.5" stroke-linecap="round"/>
            <line x1="66" y1="46" x2="66" y2="50" stroke="#94a3b8" stroke-width="1" stroke-linecap="round"/>
            <line x1="68" y1="46" x2="68" y2="50" stroke="#94a3b8" stroke-width="1" stroke-linecap="round"/>
            <line x1="70" y1="46" x2="70" y2="50" stroke="#94a3b8" stroke-width="1" stroke-linecap="round"/>
            <defs><linearGradient id="pawGrad2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#a3e635"/><stop offset="100%" stop-color="#84cc16"/></linearGradient></defs>
          </svg>
        </div>
        <div class="feed-area" id="feed-area">
          <div class="feed-info" id="feed-info">üçΩ ÏïåÎßûÏùÄ Î®πÏù¥Î•º Í≥®ÎùºÏ£ºÏÑ∏Ïöî!</div>
          <div class="feed-stage">
            <div class="feed-animal" id="feed-animal">
              <div class="feed-animal-speech" id="feed-speech">Î∞∞Í≥†ÌååÏöî~</div>
              üê∞
              <div class="feed-type-badge feed-type-herb" id="feed-type-badge">Ï¥àÏãù</div>
            </div>
          </div>
          <div class="food-choices" id="food-choices"></div>
          <div class="feed-result" id="feed-result"></div>
        </div>
      </div>

      <!-- Î≥ÄÏã† Ïï®Î≤î -->
      <div class="game-view transform-view" id="transform-view">
        <!-- ÎßàÏä§ÏΩîÌä∏ "ÌååÏö∞" Î≥ÄÏã† Î≤ÑÏ†Ñ -->
        <div class="mascot-wrap" style="bottom:8px;right:8px">
          <div class="mascot-bubble" id="bubble-tf">Î≥ÄÏã†!</div>
          <svg width="90" height="126" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="50" cy="136" rx="28" ry="4" fill="#000" opacity=".1"/>
            <ellipse cx="36" cy="124" rx="12" ry="10" fill="#84cc16" stroke="#4d7c0f" stroke-width="1.5">
              <animate attributeName="ry" values="10;11;10" dur="2s" repeatCount="indefinite"/>
            </ellipse>
            <ellipse cx="64" cy="124" rx="12" ry="10" fill="#84cc16" stroke="#4d7c0f" stroke-width="1.5">
              <animate attributeName="ry" values="10;11;10" dur="2s" begin="0.5s" repeatCount="indefinite"/>
            </ellipse>
            <ellipse cx="50" cy="72" rx="36" ry="44" fill="url(#pawGrad3)" stroke="#4d7c0f" stroke-width="2"/>
            <circle cx="28" cy="32" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <circle cx="50" cy="24" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <circle cx="72" cy="32" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <ellipse cx="50" cy="80" rx="20" ry="16" fill="#bef264" opacity=".7"/>
            <ellipse cx="38" cy="62" rx="7" ry="8" fill="#fff"/>
            <ellipse cx="62" cy="62" rx="7" ry="8" fill="#fff"/>
            <circle cx="39" cy="63" r="4.5" fill="#365314"><animate attributeName="r" values="4.5;4;4.5" dur="4s" repeatCount="indefinite"/></circle>
            <circle cx="63" cy="63" r="4.5" fill="#365314"><animate attributeName="r" values="4.5;4;4.5" dur="4s" repeatCount="indefinite"/></circle>
            <circle cx="41" cy="60" r="1.5" fill="#fff"/>
            <circle cx="65" cy="60" r="1.5" fill="#fff"/>
            <ellipse cx="28" cy="74" rx="8" ry="5" fill="#f9a8d4" opacity=".35"/>
            <ellipse cx="72" cy="74" rx="8" ry="5" fill="#f9a8d4" opacity=".35"/>
            <ellipse cx="50" cy="72" rx="5" ry="3.5" fill="#4d7c0f"/>
            <path id="mascot-tf-mouth" d="M44,80 Q50,88 56,80" fill="none" stroke="#365314" stroke-width="2" stroke-linecap="round"/>
            <!-- ÎÇòÎπÑ ÎÇ†Í∞ú Ïû•Ïãù -->
            <g transform="translate(74,30)">
              <ellipse cx="0" cy="-6" rx="8" ry="6" fill="#c084fc" opacity=".6">
                <animate attributeName="rx" values="8;10;8" dur="1.5s" repeatCount="indefinite"/>
              </ellipse>
              <ellipse cx="0" cy="6" rx="6" ry="5" fill="#a78bfa" opacity=".5">
                <animate attributeName="rx" values="6;8;6" dur="1.5s" repeatCount="indefinite"/>
              </ellipse>
            </g>
            <defs><linearGradient id="pawGrad3" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#a3e635"/><stop offset="100%" stop-color="#84cc16"/></linearGradient></defs>
          </svg>
        </div>
        <div class="transform-area" id="transform-area">
          <div class="transform-info" id="transform-info">ü¶ã Ïò¨Î∞îÎ•∏ ÏàúÏÑúÎ°ú Î≥ÄÏã† Ïπ¥ÎìúÎ•º ÎÜìÏïÑÎ≥¥ÏÑ∏Ïöî!</div>
          <div class="transform-set-name" id="transform-set-name">Ïò¨Ï±ôÏù¥Ïùò Î≥ÄÏã†</div>
          <div class="slot-row" id="slot-row"></div>
          <div class="card-pool" id="card-pool"></div>
        </div>
      </div>

      <!-- ÎÇ¥ Í∏∞Î°ù -->
      <div class="game-view record-view" id="record-view">
        <div class="records-area">
          <div class="record-card">
            <h3>üèÜ Ï¢ÖÌï© ÏÑ±Ï†Å</h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-total">0</div><div class="record-label">Ï¥ù Î¨∏Ï†ú</div></div>
              <div class="record-item"><div class="record-num" id="r-correct">0</div><div class="record-label">Ï†ïÎãµ</div></div>
              <div class="record-item"><div class="record-num" id="r-rate">0%</div><div class="record-label">Ï†ïÎãµÎ•†</div></div>
            </div>
          </div>
          <div class="record-card">
            <h3>ü©∫ ÏàòÏùòÏÇ¨ ÎÜÄÏù¥</h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-vet-healed">0</div><div class="record-label">ÏπòÎ£å ÏÑ±Í≥µ</div></div>
              <div class="record-item"><div class="record-num" id="r-vet-streak">0</div><div class="record-label">ÏµúÍ≥† Ïó∞ÏÜç</div></div>
              <div class="record-item"><div class="record-num" id="r-vet-score">0</div><div class="record-label">ÏµúÍ≥† Ï†êÏàò</div></div>
            </div>
          </div>
          <div class="record-card">
            <h3>üçΩ Î∞• Ï§ò!</h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-feed-correct">0</div><div class="record-label">Î®πÏù¥Í∏∞ ÏÑ±Í≥µ</div></div>
              <div class="record-item"><div class="record-num" id="r-feed-streak">0</div><div class="record-label">ÏµúÍ≥† Ïó∞ÏÜç</div></div>
              <div class="record-item"><div class="record-num" id="r-feed-score">0</div><div class="record-label">ÏµúÍ≥† Ï†êÏàò</div></div>
            </div>
          </div>
          <div class="record-card">
            <h3>ü¶ã Î≥ÄÏã† Ïï®Î≤î</h3>
            <div class="record-grid">
              <div class="record-item"><div class="record-num" id="r-tf-done">0</div><div class="record-label">ÏôÑÏÑ± Î≥ÄÏã†</div></div>
              <div class="record-item"><div class="record-num" id="r-tf-streak">0</div><div class="record-label">ÏµúÍ≥† Ïó∞ÏÜç</div></div>
              <div class="record-item"><div class="record-num" id="r-tf-score">0</div><div class="record-label">ÏµúÍ≥† Ï†êÏàò</div></div>
            </div>
          </div>
        </div>
        <!-- Í∏∞Î°ù ÎßàÏä§ÏΩîÌä∏ "ÌååÏö∞" ÌíÄÎ∞îÎîî -->
        <div class="mascot-wrap" style="bottom:8px;right:8px">
          <div class="mascot-bubble" id="bubble-rec">Í∏∞Î°ù!</div>
          <svg width="90" height="126" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="50" cy="136" rx="28" ry="4" fill="#000" opacity=".1"/>
            <ellipse cx="36" cy="124" rx="12" ry="10" fill="#84cc16" stroke="#4d7c0f" stroke-width="1.5">
              <animate attributeName="ry" values="10;11;10" dur="2s" repeatCount="indefinite"/>
            </ellipse>
            <ellipse cx="64" cy="124" rx="12" ry="10" fill="#84cc16" stroke="#4d7c0f" stroke-width="1.5">
              <animate attributeName="ry" values="10;11;10" dur="2s" begin="0.5s" repeatCount="indefinite"/>
            </ellipse>
            <ellipse cx="50" cy="72" rx="36" ry="44" fill="url(#pawGrad4)" stroke="#4d7c0f" stroke-width="2"/>
            <circle cx="28" cy="32" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <circle cx="50" cy="24" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <circle cx="72" cy="32" r="12" fill="#a3e635" stroke="#4d7c0f" stroke-width="1.5"/>
            <ellipse cx="50" cy="80" rx="20" ry="16" fill="#bef264" opacity=".7"/>
            <ellipse cx="38" cy="62" rx="7" ry="8" fill="#fff"/>
            <ellipse cx="62" cy="62" rx="7" ry="8" fill="#fff"/>
            <circle cx="39" cy="63" r="4.5" fill="#365314"><animate attributeName="r" values="4.5;4;4.5" dur="4s" repeatCount="indefinite"/></circle>
            <circle cx="63" cy="63" r="4.5" fill="#365314"><animate attributeName="r" values="4.5;4;4.5" dur="4s" repeatCount="indefinite"/></circle>
            <circle cx="41" cy="60" r="1.5" fill="#fff"/>
            <circle cx="65" cy="60" r="1.5" fill="#fff"/>
            <ellipse cx="28" cy="74" rx="8" ry="5" fill="#f9a8d4" opacity=".35"/>
            <ellipse cx="72" cy="74" rx="8" ry="5" fill="#f9a8d4" opacity=".35"/>
            <ellipse cx="50" cy="72" rx="5" ry="3.5" fill="#4d7c0f"/>
            <path id="mascot-rec-mouth" d="M44,80 Q50,88 56,80" fill="none" stroke="#365314" stroke-width="2" stroke-linecap="round"/>
            <!-- Ìä∏Î°úÌîº Ïû•Ïãù -->
            <g transform="translate(72,30)">
              <rect x="-4" y="0" width="8" height="6" rx="1" fill="#fbbf24"/>
              <rect x="-6" y="-8" width="12" height="10" rx="3" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/>
              <rect x="-2" y="-5" width="4" height="4" rx="1" fill="#fde68a"/>
            </g>
            <defs><linearGradient id="pawGrad4" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#a3e635"/><stop offset="100%" stop-color="#84cc16"/></linearGradient></defs>
          </svg>
        </div>
      </div>
    </div>

    <!-- Ïò§Î•∏Ï™Ω Ìå®ÎÑê -->
    <div class="right-panel" id="right-panel">
      <button class="action-btn btn-cyan" id="act1" onclick="actionBtn(1)"><span class="icon">üí°</span>ÌûåÌä∏</button>
      <button class="action-btn btn-green" id="act2" onclick="actionBtn(2)"><span class="icon">‚è≠</span>Îã§Ïùå</button>
      <button class="action-btn btn-red" id="act3" onclick="actionBtn(3)"><span class="icon">üîÑ</span>Îã§Ïãú</button>
    </div>
  </div>

  <!-- ÌûàÏñ¥Î°ú Í≤åÏûÑ: ÏÑúÏãùÏßÄ Î∂ÑÎ•òÏôï -->
  <div id="hero-game" class="hero-game hidden" style="background:linear-gradient(180deg,#7dd3fc 0%,#bae6fd 30%,#bbf7d0 70%,#86efac 100%)">
  <div class="hg-header">
    <div class="hg-stat">‚≠ê <span id="hg-score">0</span>Ï†ê</div>
    <div class="hg-stat">Î†àÎ≤® <span id="hg-level">1</span></div>
    <div class="hg-hearts" id="hg-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <div class="hg-combo" id="hg-combo-display"></div>
    <div class="hg-ctrls">
      <button class="hg-ctrl-btn" onclick="hgPause()">‚è∏</button>
      <button class="hg-ctrl-btn" onclick="hgExit()">‚úï</button>
    </div>
  </div>
  <div class="hg-arena" id="hg-arena">
    <div class="hg-divider" id="hg-divider"></div>
    <div class="hg-divider2" id="hg-divider2"></div>
    <div class="hg-divider3" id="hg-divider3"></div>
    <div class="hg-divider4" id="hg-divider4"></div>
    <div class="hg-divider5" id="hg-divider5"></div>
  </div>
  <div id="hg-start" class="hg-start-screen">
    <div class="hg-start-title">üåç ÏÑúÏãùÏßÄ Î∂ÑÎ•òÏôï</div>
    <div class="hg-start-desc">ÎèôÎ¨ºÏùÑ ÏïåÎßûÏùÄ ÏÑúÏãùÏßÄÎ°ú Î≥¥ÎÇ¥Ï£ºÏÑ∏Ïöî!</div>
    <button class="hg-start-btn" onclick="hgStart()">üöÄ ÏãúÏûë!</button>
  </div>
  <div id="hg-over" class="hg-overlay hidden">
    <div class="hg-overlay-box">
      <h2>Í≤åÏûÑ ÎÅù!</h2>
      <div class="score">‚≠ê <span id="hg-final-score">0</span>Ï†ê</div>
      <div class="msg" id="hg-over-msg">ÏûòÌñàÏñ¥Ïöî!</div>
      <button class="btn-retry" onclick="hgRestart()">üîÑ Îã§ÏãúÌïòÍ∏∞</button>
      <button class="btn-exit" onclick="hgExit()">üè† ÎèåÏïÑÍ∞ÄÍ∏∞</button>
    </div>
  </div>
  <div id="hg-pause-screen" class="hg-overlay hidden">
    <div class="hg-overlay-box">
      <h2>‚è∏ ÏùºÏãúÏ†ïÏßÄ</h2>
      <button class="btn-retry" onclick="hgPause()">‚ñ∂ Í≥ÑÏÜçÌïòÍ∏∞</button>
      <button class="btn-exit" onclick="hgExit()">üè† ÎèåÏïÑÍ∞ÄÍ∏∞</button>
    </div>
  </div>
  </div>
</div>

<!-- Í¥ÄÎ¶¨Ïûê Î™®Îã¨ -->
<div id="admin-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-head"><h3>‚öô ÏÑ§Ï†ï</h3><button class="modal-close" onclick="hideAdmin()">√ó</button></div>
    <div class="modal-body">
      <div class="modal-section">
        <h4>üë§ ÌîÑÎ°úÌïÑ</h4>
        <input class="modal-input" id="adm-name" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•" maxlength="10">
        <button class="modal-btn" onclick="saveProfileAdmin()">Ï†ÄÏû•</button>
      </div>
      <div class="modal-section">
        <h4>üîÑ Ï¥àÍ∏∞Ìôî</h4>
        <button class="modal-btn" style="background:linear-gradient(145deg,#ef4444,#dc2626)" onclick="resetAll()">Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button>
      </div>
    </div>
  </div>
</div>

<!-- Ï∫êÎ¶≠ÌÑ∞ Î™®Îã¨ -->
<div id="char-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-head"><h3>üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù</h3><button class="modal-close" onclick="hideCharModal()">√ó</button></div>
    <div class="modal-body">
      <div class="char-grid" id="char-grid"></div>
    </div>
  </div>
</div>

<script>
// ===== Ï†ÑÏó≠ Î≥ÄÏàò =====
let currentTab = 'vet';
let soundEnabled = true;
const LS = localStorage;

// ÌîÑÎ°úÌïÑ
let profile = {
  name: LS.getItem('animalName') || 'ÎèôÎ¨ºÎ∞ïÏÇ¨',
  char: LS.getItem('animalChar') || 'üêæ',
  totalCorrect: parseInt(LS.getItem('animalCorrect')) || 0,
  totalPlayed: parseInt(LS.getItem('animalPlayed')) || 0
};

// ÏàòÏùòÏÇ¨ Í≤åÏûÑ ÏÉÅÌÉú
let vet = {
  score: 0, streak: 0, healed: parseInt(LS.getItem('vetHealed')) || 0,
  bestStreak: parseInt(LS.getItem('vetBestStreak')) || 0,
  bestScore: parseInt(LS.getItem('vetBestScore')) || 0,
  currentAnimal: null, toolsApplied: 0, toolsNeeded: 0
};

// Î∞• Ï§ò! Í≤åÏûÑ ÏÉÅÌÉú
let feed = {
  score: 0, streak: 0, correct: parseInt(LS.getItem('feedCorrect')) || 0,
  bestStreak: parseInt(LS.getItem('feedBestStreak')) || 0,
  bestScore: parseInt(LS.getItem('feedBestScore')) || 0,
  currentAnimal: null, answered: false
};

// Î≥ÄÏã† Ïï®Î≤î ÏÉÅÌÉú
let tf = {
  score: 0, streak: 0, done: parseInt(LS.getItem('tfDone')) || 0,
  bestStreak: parseInt(LS.getItem('tfBestStreak')) || 0,
  bestScore: parseInt(LS.getItem('tfBestScore')) || 0,
  currentSet: null, filledSlots: [], nextSlotIdx: 0
};

// ÌûàÏñ¥Î°ú Í≤åÏûÑ ÏÉÅÌÉú
let hg = {
  score: 0, lives: 5, level: 1, running: false, paused: false, started: false,
  animals: [], spawnTimer: null, animId: null, combo: 0, maxCombo: 0,
  biomes: [], dragItem: null, dragOffsetX: 0, dragOffsetY: 0
};

// ===== Îç∞Ïù¥ÌÑ∞ =====

// ÏàòÏùòÏÇ¨ - ÏïÑÌîà ÎèôÎ¨ºÎì§
const VET_ANIMALS = [
  { emoji: 'üê∂', name: 'Í∞ïÏïÑÏßÄ', sick: 'Í∞êÍ∏∞ Í±∏Î¶º', sickEmoji: 'ü§ß', tools: ['üå°Ô∏è','üíä','ü©π'], toolNames: ['Ï≤¥Ïò®Í≥Ñ','ÏïΩ','Î∂ïÎåÄ'] },
  { emoji: 'üê±', name: 'Í≥†ÏñëÏù¥', sick: 'Îã§Î¶¨ Îã§Ïπ®', sickEmoji: 'üíß', tools: ['ü©π','üíä','üßä'], toolNames: ['Î∂ïÎåÄ','ÏïΩ','ÏñºÏùå'] },
  { emoji: 'üê∞', name: 'ÌÜ†ÎÅº', sick: 'Î∞∞ ÏïÑÌîî', sickEmoji: 'üò¢', tools: ['üíä','üçµ','‚ù§Ô∏è‚Äçü©π'], toolNames: ['ÏïΩ','Îî∞ÎúªÌïú Ï∞®','ÏπòÎ£å'] },
  { emoji: 'üêª', name: 'Í≥∞', sick: 'Ïó¥Ïù¥ ÎÇ®', sickEmoji: 'üî•', tools: ['üå°Ô∏è','üßä','üíä'], toolNames: ['Ï≤¥Ïò®Í≥Ñ','ÏñºÏùå','ÏïΩ'] },
  { emoji: 'üê∏', name: 'Í∞úÍµ¨Î¶¨', sick: 'Î™©Ïù¥ ÏïÑÌîî', sickEmoji: 'üòñ', tools: ['üíä','üçØ','ü©π'], toolNames: ['ÏïΩ','ÍøÄ','Î∂ïÎåÄ'] },
  { emoji: 'üêß', name: 'Ìé≠Í∑Ñ', sick: 'Í∞êÍ∏∞ Í±∏Î¶º', sickEmoji: 'ü§í', tools: ['üå°Ô∏è','üíä','üß£'], toolNames: ['Ï≤¥Ïò®Í≥Ñ','ÏïΩ','Î™©ÎèÑÎ¶¨'] },
  { emoji: 'ü¶ä', name: 'Ïó¨Ïö∞', sick: 'Î∞ú Îã§Ïπ®', sickEmoji: 'üòø', tools: ['ü©π','üíä','‚ù§Ô∏è‚Äçü©π'], toolNames: ['Î∂ïÎåÄ','ÏïΩ','ÏπòÎ£å'] },
  { emoji: 'üêº', name: 'ÌåêÎã§', sick: 'ÏÜåÌôîÎ∂àÎüâ', sickEmoji: 'ü§¢', tools: ['üíä','üçµ','‚ù§Ô∏è‚Äçü©π'], toolNames: ['ÏïΩ','Îî∞ÎúªÌïú Ï∞®','ÏπòÎ£å'] },
];

// Î∞• Ï§ò! - ÎèôÎ¨ºÍ≥º Î®πÏù¥
const FEED_DATA = [
  { emoji: 'üê∞', name: 'ÌÜ†ÎÅº', food: 'ü•ï', foodName: 'ÎãπÍ∑º', type: 'Ï¥àÏãù', typeClass: 'feed-type-herb' },
  { emoji: 'üê±', name: 'Í≥†ÏñëÏù¥', food: 'üêü', foodName: 'ÏÉùÏÑ†', type: 'Ïú°Ïãù', typeClass: 'feed-type-carn' },
  { emoji: 'üê∂', name: 'Í∞ïÏïÑÏßÄ', food: 'ü¶¥', foodName: 'Îºà', type: 'Ïû°Ïãù', typeClass: 'feed-type-omni' },
  { emoji: 'ü¶Å', name: 'ÏÇ¨Ïûê', food: 'üçñ', foodName: 'Í≥†Í∏∞', type: 'Ïú°Ïãù', typeClass: 'feed-type-carn' },
  { emoji: 'üêµ', name: 'ÏõêÏà≠Ïù¥', food: 'üçå', foodName: 'Î∞îÎÇòÎÇò', type: 'Ïû°Ïãù', typeClass: 'feed-type-omni' },
  { emoji: 'üêº', name: 'ÌåêÎã§', food: 'üéã', foodName: 'ÎåÄÎÇòÎ¨¥', type: 'Ï¥àÏãù', typeClass: 'feed-type-herb' },
];
const ALL_FOODS = ['ü•ï','üêü','ü¶¥','üçñ','üçå','üéã','üçé','üßÄ','üçï'];

// Î≥ÄÏã† Ïï®Î≤î - Î≥ÄÏã† ÏÑ∏Ìä∏
const TRANSFORM_SETS = [
  { name: 'Ïò¨Ï±ôÏù¥Ïùò Î≥ÄÏã†', stages: [
    { emoji: 'ü•ö', label: 'Ïïå' },
    { emoji: 'üîµ', label: 'Ïò¨Ï±ôÏù¥' },
    { emoji: 'ü¶é', label: 'Îí∑Îã§Î¶¨' },
    { emoji: 'üê∏', label: 'Í∞úÍµ¨Î¶¨' }
  ], final: 'üê∏' },
  { name: 'ÎÇòÎπÑÏùò Î≥ÄÏã†', stages: [
    { emoji: 'ü•ö', label: 'Ïïå' },
    { emoji: 'üêõ', label: 'Ïï†Î≤åÎ†à' },
    { emoji: 'ü´ò', label: 'Î≤àÎç∞Í∏∞' },
    { emoji: 'ü¶ã', label: 'ÎÇòÎπÑ' }
  ], final: 'ü¶ã' },
  { name: 'Î≥ëÏïÑÎ¶¨Ïùò Î≥ÄÏã†', stages: [
    { emoji: 'ü•ö', label: 'Ïïå' },
    { emoji: 'üê£', label: 'Î∂ÄÌôî' },
    { emoji: 'üê•', label: 'Î≥ëÏïÑÎ¶¨' },
    { emoji: 'üêî', label: 'Îã≠' }
  ], final: 'üêî' },
];

// ÌûàÏñ¥Î°ú - ÏÑúÏãùÏßÄÏôÄ ÎèôÎ¨º
const BIOME_DATA = {
  forest: { name: 'Ïà≤', emoji: 'üå≤', bg: 'linear-gradient(180deg,#166534,#22c55e)', ground: '#15803d', animals: ['üêøÔ∏è','ü¶ä','üêª','ü¶å','üêó','ü¶â','üê∫'] },
  ocean:  { name: 'Î∞îÎã§', emoji: 'üåä', bg: 'linear-gradient(180deg,#1e40af,#3b82f6)', ground: '#1d4ed8', animals: ['üê≥','üê¨','üêô','ü¶à','üê†','ü¶Ä','üêö'] },
  desert: { name: 'ÏÇ¨Îßâ', emoji: 'üèúÔ∏è', bg: 'linear-gradient(180deg,#b45309,#f59e0b)', ground: '#a16207', animals: ['üê™','ü¶Ç','ü¶é','üêç','ü¶Ö'] },
  arctic: { name: 'Í∑πÏßÄ', emoji: '‚ùÑÔ∏è', bg: 'linear-gradient(180deg,#e0f2fe,#bae6fd)', ground: '#7dd3fc', animals: ['üêß','ü¶≠','üêª‚Äç‚ùÑÔ∏è','ü¶Ö'] }
};

// ===== SVG ÎèôÎ¨º/ÎèÑÍµ¨/Î®πÏù¥ ÎîïÏÖîÎÑàÎ¶¨ =====
const ANIMAL_SVG = {
  'üê∂': `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="58" rx="32" ry="28" fill="#D2691E"/><ellipse cx="50" cy="58" rx="22" ry="18" fill="#FDEBD0"/><circle cx="38" cy="50" r="5" fill="#fff"/><circle cx="62" cy="50" r="5" fill="#fff"/><circle cx="39" cy="51" r="3" fill="#1e293b"/><circle cx="63" cy="51" r="3" fill="#1e293b"/><circle cx="40" cy="49" r="1" fill="#fff"/><circle cx="64" cy="49" r="1" fill="#fff"/><ellipse cx="50" cy="60" rx="6" ry="4" fill="#1e293b"/><path d="M47,64 Q50,68 53,64" fill="none" stroke="#c0392b" stroke-width="1.5"/><ellipse cx="28" cy="30" rx="14" ry="18" fill="#A0522D" transform="rotate(-15 28 30)"/><ellipse cx="72" cy="30" rx="14" ry="18" fill="#A0522D" transform="rotate(15 72 30)"/><ellipse cx="50" cy="90" rx="10" ry="4" fill="#A0522D" opacity=".5"/></svg>`,
  'üê±': `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="60" rx="30" ry="26" fill="#f97316"/><polygon points="22,38 18,10 38,32" fill="#f97316" stroke="#ea580c" stroke-width="1"/><polygon points="78,38 82,10 62,32" fill="#f97316" stroke="#ea580c" stroke-width="1"/><polygon points="22,38 20,14 34,32" fill="#fde68a"/><polygon points="78,38 80,14 66,32" fill="#fde68a"/><ellipse cx="50" cy="62" rx="16" ry="12" fill="#fef3c7"/><circle cx="38" cy="52" r="6" fill="#bef264"/><circle cx="62" cy="52" r="6" fill="#bef264"/><ellipse cx="38" cy="52" rx="2" ry="5" fill="#1e293b"/><ellipse cx="62" cy="52" rx="2" ry="5" fill="#1e293b"/><ellipse cx="50" cy="62" rx="4" ry="3" fill="#f472b6"/><line x1="14" y1="56" x2="32" y2="58" stroke="#94a3b8" stroke-width="1"/><line x1="14" y1="62" x2="32" y2="62" stroke="#94a3b8" stroke-width="1"/><line x1="68" y1="58" x2="86" y2="56" stroke="#94a3b8" stroke-width="1"/><line x1="68" y1="62" x2="86" y2="62" stroke="#94a3b8" stroke-width="1"/><path d="M46,66 Q50,70 54,66" fill="none" stroke="#94a3b8" stroke-width="1"/></svg>`,
  'üê∞': `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="65" rx="28" ry="24" fill="#fef3c7"/><ellipse cx="36" cy="18" rx="10" ry="26" fill="#fef3c7" stroke="#e5e7eb" stroke-width="1"/><ellipse cx="64" cy="18" rx="10" ry="26" fill="#fef3c7" stroke="#e5e7eb" stroke-width="1"/><ellipse cx="36" cy="18" rx="6" ry="20" fill="#fca5a5"/><ellipse cx="64" cy="18" rx="6" ry="20" fill="#fca5a5"/><circle cx="38" cy="58" r="5" fill="#fff"/><circle cx="62" cy="58" r="5" fill="#fff"/><circle cx="39" cy="59" r="3" fill="#dc2626"/><circle cx="63" cy="59" r="3" fill="#dc2626"/><circle cx="40" cy="57" r="1" fill="#fff"/><circle cx="64" cy="57" r="1" fill="#fff"/><ellipse cx="50" cy="66" rx="4" ry="3" fill="#fca5a5"/><path d="M46,70 Q50,74 54,70" fill="none" stroke="#94a3b8" stroke-width="1.5"/><circle cx="34" cy="68" r="8" fill="#fca5a5" opacity=".3"/><circle cx="66" cy="68" r="8" fill="#fca5a5" opacity=".3"/></svg>`,
  'üêª': `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="28" cy="28" r="14" fill="#8B4513"/><circle cx="72" cy="28" r="14" fill="#8B4513"/><circle cx="28" cy="28" r="8" fill="#D2691E"/><circle cx="72" cy="28" r="8" fill="#D2691E"/><ellipse cx="50" cy="58" rx="34" ry="30" fill="#8B4513"/><ellipse cx="50" cy="64" rx="18" ry="14" fill="#D2B48C"/><circle cx="38" cy="50" r="5" fill="#fff"/><circle cx="62" cy="50" r="5" fill="#fff"/><circle cx="39" cy="51" r="3" fill="#1e293b"/><circle cx="63" cy="51" r="3" fill="#1e293b"/><ellipse cx="50" cy="62" rx="6" ry="4" fill="#1e293b"/><path d="M44,68 Q50,74 56,68" fill="none" stroke="#6b3a00" stroke-width="2"/></svg>`,
  'üê∏': `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="62" rx="34" ry="26" fill="#22c55e"/><circle cx="32" cy="36" r="14" fill="#22c55e"/><circle cx="68" cy="36" r="14" fill="#22c55e"/><circle cx="32" cy="34" r="10" fill="#fff"/><circle cx="68" cy="34" r="10" fill="#fff"/><circle cx="33" cy="35" r="5" fill="#1e293b"/><circle cx="69" cy="35" r="5" fill="#1e293b"/><circle cx="34" cy="33" r="1.5" fill="#fff"/><circle cx="70" cy="33" r="1.5" fill="#fff"/><path d="M34,68 Q50,80 66,68" fill="none" stroke="#15803d" stroke-width="2.5"/><ellipse cx="50" cy="68" rx="14" ry="6" fill="#bbf7d0"/><circle cx="30" cy="60" r="6" fill="#fca5a5" opacity=".25"/><circle cx="70" cy="60" r="6" fill="#fca5a5" opacity=".25"/></svg>`,
  'üêß': `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="58" rx="28" ry="32" fill="#1e293b"/><ellipse cx="50" cy="64" rx="18" ry="22" fill="#fff"/><circle cx="40" cy="44" r="5" fill="#fff"/><circle cx="60" cy="44" r="5" fill="#fff"/><circle cx="41" cy="45" r="3" fill="#1e293b"/><circle cx="61" cy="45" r="3" fill="#1e293b"/><polygon points="50,52 44,58 56,58" fill="#f59e0b"/><ellipse cx="40" cy="90" rx="8" ry="4" fill="#f59e0b"/><ellipse cx="60" cy="90" rx="8" ry="4" fill="#f59e0b"/><path d="M22,52 Q18,68 26,78" fill="none" stroke="#334155" stroke-width="4" stroke-linecap="round"/><path d="M78,52 Q82,68 74,78" fill="none" stroke="#334155" stroke-width="4" stroke-linecap="round"/></svg>`,
  'ü¶ä': `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="60" rx="30" ry="26" fill="#f97316"/><polygon points="20,40 14,8 38,34" fill="#f97316"/><polygon points="80,40 86,8 62,34" fill="#f97316"/><polygon points="20,40 18,14 32,34" fill="#1e293b"/><polygon points="80,40 82,14 68,34" fill="#1e293b"/><ellipse cx="50" cy="66" rx="18" ry="12" fill="#fff"/><circle cx="38" cy="52" r="5" fill="#fff"/><circle cx="62" cy="52" r="5" fill="#fff"/><circle cx="39" cy="53" r="3" fill="#d97706"/><circle cx="63" cy="53" r="3" fill="#d97706"/><ellipse cx="50" cy="62" rx="4" ry="3" fill="#1e293b"/><path d="M46,66 Q50,70 54,66" fill="none" stroke="#92400e" stroke-width="1.5"/></svg>`,
  'üêº': `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="58" rx="34" ry="30" fill="#fff" stroke="#e5e7eb" stroke-width="1"/><ellipse cx="34" cy="48" rx="12" ry="10" fill="#1e293b"/><ellipse cx="66" cy="48" rx="12" ry="10" fill="#1e293b"/><circle cx="34" cy="48" r="5" fill="#fff"/><circle cx="66" cy="48" r="5" fill="#fff"/><circle cx="35" cy="49" r="3" fill="#1e293b"/><circle cx="67" cy="49" r="3" fill="#1e293b"/><ellipse cx="50" cy="62" rx="5" ry="4" fill="#1e293b"/><path d="M44,68 Q50,74 56,68" fill="none" stroke="#374151" stroke-width="1.5"/><circle cx="24" cy="28" r="12" fill="#1e293b"/><circle cx="76" cy="28" r="12" fill="#1e293b"/></svg>`,
  'ü¶Å': `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="52" r="38" fill="#f59e0b"/><circle cx="50" cy="56" r="26" fill="#fde68a"/><circle cx="38" cy="48" r="5" fill="#fff"/><circle cx="62" cy="48" r="5" fill="#fff"/><circle cx="39" cy="49" r="3" fill="#92400e"/><circle cx="63" cy="49" r="3" fill="#92400e"/><ellipse cx="50" cy="58" rx="5" ry="4" fill="#92400e"/><path d="M44,64 Q50,70 56,64" fill="none" stroke="#78350f" stroke-width="2"/><circle cx="38" cy="60" r="6" fill="#fca5a5" opacity=".25"/><circle cx="62" cy="60" r="6" fill="#fca5a5" opacity=".25"/></svg>`,
  'üêµ': `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="56" rx="30" ry="28" fill="#8B4513"/><ellipse cx="50" cy="62" rx="20" ry="16" fill="#FDEBD0"/><circle cx="20" cy="50" r="10" fill="#FDEBD0"/><circle cx="80" cy="50" r="10" fill="#FDEBD0"/><circle cx="38" cy="48" r="5" fill="#fff"/><circle cx="62" cy="48" r="5" fill="#fff"/><circle cx="39" cy="49" r="3" fill="#1e293b"/><circle cx="63" cy="49" r="3" fill="#1e293b"/><ellipse cx="50" cy="62" rx="8" ry="6" fill="#FDEBD0" stroke="#D2691E" stroke-width="1"/><path d="M46,66 Q50,70 54,66" fill="none" stroke="#6b3a00" stroke-width="1.5"/></svg>`
};

const TOOL_SVG = {
  'üå°Ô∏è': `<svg viewBox="0 0 60 100" xmlns="http://www.w3.org/2000/svg"><rect x="22" y="8" width="16" height="60" rx="8" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1.5"/><circle cx="30" cy="78" r="16" fill="#ef4444"/><circle cx="30" cy="78" r="10" fill="#fca5a5"/><rect x="26" y="30" width="8" height="38" rx="4" fill="#ef4444" opacity=".7"><animate attributeName="height" values="38;28;38" dur="2s" repeatCount="indefinite"/></rect></svg>`,
  'üíä': `<svg viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="10" width="90" height="40" rx="20" fill="#f472b6"/><rect x="50" y="10" width="45" height="40" rx="20" fill="#fff" stroke="#f472b6" stroke-width="2"/><ellipse cx="30" cy="24" rx="12" ry="4" fill="#fda4af" opacity=".5" transform="rotate(-10 30 24)"/></svg>`,
  'ü©π': `<svg viewBox="0 0 100 50" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="5" width="100" height="40" rx="8" fill="#fbbf24"/><rect x="35" y="5" width="30" height="40" rx="4" fill="#fde68a"/><rect x="44" y="15" width="12" height="12" rx="2" fill="#f59e0b" opacity=".5"/><g fill="#d97706" opacity=".3"><circle cx="15" cy="18" r="2"/><circle cx="25" cy="32" r="2"/><circle cx="75" cy="18" r="2"/><circle cx="85" cy="32" r="2"/></g></svg>`,
  'üßä': `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="10" width="60" height="60" rx="8" fill="#7dd3fc" opacity=".7"/><rect x="10" y="10" width="60" height="60" rx="8" fill="none" stroke="#38bdf8" stroke-width="2"/><line x1="20" y1="20" x2="35" y2="35" stroke="#fff" stroke-width="2" opacity=".6"/><line x1="25" y1="18" x2="30" y2="28" stroke="#fff" stroke-width="1.5" opacity=".4"/><path d="M50,50 L60,40" stroke="#bae6fd" stroke-width="1.5" opacity=".5"/></svg>`,
  'üçµ': `<svg viewBox="0 0 90 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="40" cy="60" rx="28" ry="12" fill="#a16207"/><rect x="12" y="30" width="56" height="32" rx="4" fill="#fde68a" stroke="#d97706" stroke-width="1.5"/><ellipse cx="40" cy="32" rx="28" ry="8" fill="#fbbf24"/><ellipse cx="40" cy="32" rx="22" ry="5" fill="#92400e" opacity=".3"/><path d="M68,38 Q82,38 82,50 Q82,62 68,58" fill="none" stroke="#d97706" stroke-width="2.5"/><path d="M30,20 Q32,10 36,20" fill="none" stroke="#94a3b8" stroke-width="1.5" opacity=".5"><animate attributeName="d" values="M30,20 Q32,10 36,20;M30,18 Q33,8 36,18;M30,20 Q32,10 36,20" dur="2s" repeatCount="indefinite"/></path></svg>`,
  '‚ù§Ô∏è‚Äçü©π': `<svg viewBox="0 0 100 90" xmlns="http://www.w3.org/2000/svg"><path d="M50,82 C20,60 2,40 2,24 C2,10 14,2 26,2 C36,2 44,8 50,18 C56,8 64,2 74,2 C86,2 98,10 98,24 C98,40 80,60 50,82Z" fill="#ef4444"/><rect x="38" y="30" width="24" height="8" rx="2" fill="#fff"/><rect x="46" y="22" width="8" height="24" rx="2" fill="#fff"/></svg>`,
  'üçØ': `<svg viewBox="0 0 80 90" xmlns="http://www.w3.org/2000/svg"><rect x="15" y="25" width="50" height="55" rx="10" fill="#fbbf24"/><rect x="15" y="25" width="50" height="55" rx="10" fill="none" stroke="#d97706" stroke-width="1.5"/><rect x="20" y="18" width="40" height="12" rx="4" fill="#78350f"/><ellipse cx="40" cy="18" rx="16" ry="4" fill="#92400e"/><text x="40" y="60" text-anchor="middle" font-size="14" fill="#78350f" font-weight="700">HONEY</text><ellipse cx="40" cy="38" rx="12" ry="3" fill="#fde68a" opacity=".5"/></svg>`,
  'üß£': `<svg viewBox="0 0 90 80" xmlns="http://www.w3.org/2000/svg"><path d="M10,20 Q10,10 20,10 L70,10 Q80,10 80,20 L80,30 Q80,35 75,35 L60,35 L60,70 Q60,75 55,75 L45,75 Q40,75 40,70 L40,35 L20,35 Q15,35 15,30Z" fill="#ef4444"/><g stroke="#dc2626" stroke-width="1.5" fill="none"><line x1="20" y1="14" x2="20" y2="32"/><line x1="30" y1="14" x2="30" y2="32"/><line x1="40" y1="14" x2="40" y2="32"/><line x1="50" y1="14" x2="50" y2="32"/><line x1="60" y1="14" x2="60" y2="32"/></g><g stroke="#dc2626" stroke-width="1" fill="none"><line x1="44" y1="40" x2="44" y2="72"/><line x1="50" y1="40" x2="50" y2="72"/><line x1="56" y1="40" x2="56" y2="72"/></g></svg>`
};

const FOOD_SVG = {
  'ü•ï': `<svg viewBox="0 0 60 100" xmlns="http://www.w3.org/2000/svg"><path d="M30,95 L10,40 Q30,35 50,40Z" fill="#f97316"/><g stroke="#ea580c" stroke-width="1" fill="none"><line x1="20" y1="55" x2="36" y2="52"/><line x1="18" y1="68" x2="34" y2="66"/><line x1="22" y1="80" x2="32" y2="78"/></g><g fill="#22c55e"><ellipse cx="30" cy="36" rx="12" ry="8"/><ellipse cx="22" cy="30" rx="6" ry="12" transform="rotate(-20 22 30)"/><ellipse cx="38" cy="30" rx="6" ry="12" transform="rotate(20 38 30)"/></g></svg>`,
  'üêü': `<svg viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg"><ellipse cx="48" cy="30" rx="35" ry="20" fill="#60a5fa"/><polygon points="85,30 100,14 100,46" fill="#3b82f6"/><circle cx="30" cy="26" r="4" fill="#fff"/><circle cx="31" cy="27" r="2" fill="#1e293b"/><path d="M20,35 Q35,42 55,35" fill="none" stroke="#2563eb" stroke-width="1.5"/><g stroke="#93c5fd" stroke-width="1" opacity=".5"><path d="M50,22 Q55,18 60,22"/><path d="M55,26 Q60,22 65,26"/></g></svg>`,
  'ü¶¥': `<svg viewBox="0 0 100 40" xmlns="http://www.w3.org/2000/svg"><rect x="20" y="12" width="60" height="16" rx="8" fill="#fef3c7" stroke="#d6d3d1" stroke-width="1"/><circle cx="16" cy="10" r="8" fill="#fef3c7" stroke="#d6d3d1" stroke-width="1"/><circle cx="16" cy="30" r="8" fill="#fef3c7" stroke="#d6d3d1" stroke-width="1"/><circle cx="84" cy="10" r="8" fill="#fef3c7" stroke="#d6d3d1" stroke-width="1"/><circle cx="84" cy="30" r="8" fill="#fef3c7" stroke="#d6d3d1" stroke-width="1"/></svg>`,
  'üçñ': `<svg viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg"><ellipse cx="55" cy="30" rx="35" ry="22" fill="#dc2626"/><ellipse cx="55" cy="30" rx="28" ry="16" fill="#fca5a5"/><rect x="8" y="22" width="24" height="16" rx="8" fill="#fef3c7" stroke="#d6d3d1" stroke-width="1"/><circle cx="8" cy="22" r="6" fill="#fef3c7" stroke="#d6d3d1" stroke-width="1"/><circle cx="8" cy="38" r="6" fill="#fef3c7" stroke="#d6d3d1" stroke-width="1"/></svg>`,
  'üçå': `<svg viewBox="0 0 80 100" xmlns="http://www.w3.org/2000/svg"><path d="M40,10 Q20,30 15,60 Q12,80 30,90 Q40,85 45,70 Q55,40 50,15Z" fill="#fde047"/><path d="M40,10 Q42,8 44,10 Q54,35 48,65 Q44,80 35,86" fill="none" stroke="#ca8a04" stroke-width="1.5"/><rect x="38" y="6" width="8" height="6" rx="3" fill="#78350f"/></svg>`,
  'üéã': `<svg viewBox="0 0 60 100" xmlns="http://www.w3.org/2000/svg"><rect x="26" y="5" width="8" height="90" rx="4" fill="#22c55e"/><g fill="#4ade80"><ellipse cx="18" cy="25" rx="14" ry="4" transform="rotate(-20 18 25)"/><ellipse cx="42" cy="40" rx="14" ry="4" transform="rotate(15 42 40)"/><ellipse cx="16" cy="55" rx="14" ry="4" transform="rotate(-25 16 55)"/><ellipse cx="44" cy="70" rx="12" ry="3.5" transform="rotate(20 44 70)"/></g><line x1="30" y1="22" x2="30" y2="24" stroke="#15803d" stroke-width="6"/><line x1="30" y1="42" x2="30" y2="44" stroke="#15803d" stroke-width="6"/><line x1="30" y1="62" x2="30" y2="64" stroke="#15803d" stroke-width="6"/></svg>`,
  'üçé': `<svg viewBox="0 0 80 90" xmlns="http://www.w3.org/2000/svg"><ellipse cx="40" cy="55" rx="30" ry="30" fill="#ef4444"/><ellipse cx="30" cy="50" rx="10" ry="8" fill="#fca5a5" opacity=".4"/><rect x="37" y="14" width="6" height="16" rx="3" fill="#78350f"/><ellipse cx="48" cy="18" rx="8" ry="5" fill="#22c55e" transform="rotate(20 48 18)"/></svg>`,
  'üßÄ': `<svg viewBox="0 0 100 80" xmlns="http://www.w3.org/2000/svg"><polygon points="50,5 95,70 5,70" fill="#fde047"/><polygon points="50,5 95,70 5,70" fill="none" stroke="#ca8a04" stroke-width="1.5"/><circle cx="40" cy="50" r="6" fill="#fbbf24"/><circle cx="60" cy="55" r="5" fill="#fbbf24"/><circle cx="50" cy="40" r="4" fill="#fbbf24"/><circle cx="70" cy="60" r="3" fill="#fbbf24"/></svg>`,
  'üçï': `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50,10 L90,85 L10,85Z" fill="#fde68a"/><path d="M50,10 L90,85 L10,85Z" fill="none" stroke="#d97706" stroke-width="2"/><path d="M16,80 Q50,72 84,80" fill="#ef4444" stroke="#dc2626" stroke-width="1"/><circle cx="40" cy="50" r="6" fill="#dc2626"/><circle cx="60" cy="55" r="5" fill="#dc2626"/><circle cx="50" cy="68" r="5" fill="#dc2626"/><circle cx="45" cy="40" r="3" fill="#22c55e"/><circle cx="65" cy="45" r="2" fill="#22c55e"/></svg>`
};

function getAnimalSVG(emoji, size) {
  const svg = ANIMAL_SVG[emoji];
  if (svg) return `<div style="width:${size}px;height:${size}px;display:flex;align-items:center;justify-content:center">${svg}</div>`;
  return `<span style="font-size:${size}px">${emoji}</span>`;
}
function getToolSVG(emoji, size) {
  const svg = TOOL_SVG[emoji];
  if (svg) return `<div style="width:${size}px;height:${size}px;display:flex;align-items:center;justify-content:center">${svg}</div>`;
  return `<span style="font-size:${size}px">${emoji}</span>`;
}
function getFoodSVG(emoji, size) {
  const svg = FOOD_SVG[emoji];
  if (svg) return `<div style="width:${size}px;height:${size}px;display:flex;align-items:center;justify-content:center">${svg}</div>`;
  return `<span style="font-size:${size}px">${emoji}</span>`;
}

// ===== TTS =====
let audioQueue = [];
let isSpeaking = false;
function speak(text) {
  if (!soundEnabled) return;
  speechSynthesis.cancel();
  audioQueue = [];
  isSpeaking = false;
  audioQueue.push(text);
  processQueue();
}
function processQueue() {
  if (isSpeaking || !audioQueue.length) return;
  isSpeaking = true;
  const u = new SpeechSynthesisUtterance(audioQueue.shift());
  u.lang = 'ko-KR'; u.rate = 1.0; u.pitch = 1.1;
  u.onend = () => { isSpeaking = false; processQueue(); };
  u.onerror = () => { isSpeaking = false; processQueue(); };
  speechSynthesis.speak(u);
}
function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('sb-sound').textContent = soundEnabled ? 'üîä' : 'üîá';
  if (!soundEnabled) speechSynthesis.cancel();
}

// ===== SFX ÏãúÏä§ÌÖú =====
const SFX = {
  _ctx: null,
  _getCtx() { if (!this._ctx) this._ctx = new (window.AudioContext || window.webkitAudioContext)(); return this._ctx; },
  _play(fn) { try { if (!soundEnabled) return; fn(this._getCtx()); } catch(e) {} },
  heal() { this._play(ctx => { [523,659,784,1047].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.05,ctx.currentTime+i*.07);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.07+.15);o.start(ctx.currentTime+i*.07);o.stop(ctx.currentTime+i*.07+.15); }); }); },
  feed() { this._play(ctx => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.setValueAtTime(800,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(1600,ctx.currentTime+.1);g.gain.setValueAtTime(.06,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.12);o.start();o.stop(ctx.currentTime+.12); }); },
  correct() { this._play(ctx => { [659,784,988].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.06);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.06+.12);o.start(ctx.currentTime+i*.06);o.stop(ctx.currentTime+i*.06+.12); }); }); },
  wrong() { this._play(ctx => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sawtooth';o.frequency.setValueAtTime(250,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(120,ctx.currentTime+.18);g.gain.setValueAtTime(.04,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.18);o.start();o.stop(ctx.currentTime+.18); }); },
  transform() { this._play(ctx => { for(let i=0;i<5;i++){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=400+i*150;g.gain.setValueAtTime(.04,ctx.currentTime+i*.08);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.08+.15);o.start(ctx.currentTime+i*.08);o.stop(ctx.currentTime+i*.08+.15);} }); },
  fanfare() { this._play(ctx => { [523,659,784,1047].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='square';o.frequency.value=f;g.gain.setValueAtTime(.04,ctx.currentTime+i*.12);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.12+.25);o.start(ctx.currentTime+i*.12);o.stop(ctx.currentTime+i*.12+.25); }); }); },
  levelup() { this._play(ctx => { for(let i=0;i<8;i++){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=523*(1+i*.15);g.gain.setValueAtTime(.05,ctx.currentTime+i*.06);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.06+.15);o.start(ctx.currentTime+i*.06);o.stop(ctx.currentTime+i*.06+.15);} }); },
  combo(n) { this._play(ctx => { const f=800+Math.min(n,10)*60;const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.setValueAtTime(f,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(f*1.3,ctx.currentTime+.1);g.gain.setValueAtTime(.06,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.12);o.start();o.stop(ctx.currentTime+.12); }); },
  gameStart() { this._play(ctx => { [392,523,659,784].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.1+.2);o.start(ctx.currentTime+i*.1);o.stop(ctx.currentTime+i*.1+.2); }); }); },
  gameOver() { this._play(ctx => { [523,440,349,262].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.06,ctx.currentTime+i*.15);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.15+.3);o.start(ctx.currentTime+i*.15);o.stop(ctx.currentTime+i*.15+.3); }); }); }
};

function showScorePopup(container, points, x, y) {
  const el = document.createElement('div');
  el.className = 'score-popup';
  el.textContent = (typeof points === 'number' && points > 0 ? '+' : '') + points;
  el.style.left = x + 'px'; el.style.top = y + 'px';
  container.appendChild(el);
  setTimeout(() => el.remove(), 900);
}
function showLevelUp(lv) {
  SFX.levelup();
  const ov = document.createElement('div');
  ov.className = 'levelup-overlay';
  ov.innerHTML = `<div class="levelup-box">üêæ Î†àÎ≤® ${lv} Îã¨ÏÑ±!</div>`;
  document.body.appendChild(ov);
  setTimeout(() => ov.remove(), 800);
}
function setMascotEmotion(mouthId, bubbleId, emotion) {
  const mouth = document.getElementById(mouthId);
  const bubble = document.getElementById(bubbleId);
  if (!mouth) return;
  if (emotion === 'happy') {
    mouth.setAttribute('d', 'M40,80 Q50,92 60,80');
    if (bubble) { bubble.textContent = ['Ï¢ãÏïÑ!','ÎåÄÎ∞ï!','Ïß±!','Î©ãÏ†∏!'][Math.floor(Math.random()*4)]; bubble.classList.add('show'); setTimeout(() => bubble.classList.remove('show'), 2000); }
  } else if (emotion === 'worried') {
    mouth.setAttribute('d', 'M44,86 Q50,80 56,86');
    if (bubble) { bubble.textContent = 'Ïïó!'; bubble.classList.add('show'); setTimeout(() => bubble.classList.remove('show'), 1500); }
  } else {
    mouth.setAttribute('d', 'M44,80 Q50,88 56,80');
  }
  setTimeout(() => { if (mouth) mouth.setAttribute('d', 'M44,80 Q50,88 56,80'); }, 2500);
}

// ===== ÌîÑÎ°úÌïÑ =====
let _prevMainLevel = 1;
function updateProfile() {
  document.getElementById('pf-name').textContent = profile.name;
  document.getElementById('pf-char').textContent = profile.char;
  const lv = Math.floor(profile.totalCorrect / 10) + 1;
  if (lv > _prevMainLevel && _prevMainLevel > 0) showLevelUp(lv);
  _prevMainLevel = lv;
  document.getElementById('pf-level').textContent = lv;
  const prog = (profile.totalCorrect % 10);
  document.getElementById('pf-done').textContent = prog;
  document.getElementById('pf-total').textContent = 10;
  document.getElementById('pf-bar').style.width = (prog * 10) + '%';
}
function changeName() {
  const n = prompt('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', profile.name);
  if (n && n.trim()) { profile.name = n.trim(); LS.setItem('animalName', profile.name); updateProfile(); }
}
function showCharModal() {
  document.getElementById('char-modal').classList.remove('hidden');
  const chars = ['üêæ','üê∂','üê±','üê∞','üêª','ü¶ä','üê∏','üêº','ü¶Å','üêØ','üêµ','üêß','ü¶ã','üê¢','üê¨'];
  const g = document.getElementById('char-grid');
  g.innerHTML = chars.map(c => `<div class="char-item${c===profile.char?' selected':''}" onclick="pickChar('${c}')">${c}</div>`).join('');
}
function hideCharModal() { document.getElementById('char-modal').classList.add('hidden'); }
function pickChar(c) { profile.char = c; LS.setItem('animalChar', c); updateProfile(); hideCharModal(); }
function showAdmin() { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('adm-name').value = profile.name; }
function hideAdmin() { document.getElementById('admin-modal').classList.add('hidden'); }
function saveProfileAdmin() {
  const n = document.getElementById('adm-name').value.trim();
  if (n) { profile.name = n; LS.setItem('animalName', n); updateProfile(); }
  hideAdmin();
}
function resetAll() {
  if (!confirm('Î™®Îì† Í∏∞Î°ùÏù¥ ÏÇ¨ÎùºÏßëÎãàÎã§. Ï†ïÎßê Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?')) return;
  ['animalName','animalChar','animalCorrect','animalPlayed','vetHealed','vetBestStreak','vetBestScore','feedCorrect','feedBestStreak','feedBestScore','tfDone','tfBestStreak','tfBestScore'].forEach(k => LS.removeItem(k));
  location.reload();
}
function saveStats() {
  LS.setItem('animalCorrect', profile.totalCorrect);
  LS.setItem('animalPlayed', profile.totalPlayed);
  LS.setItem('vetHealed', vet.healed);
  LS.setItem('vetBestStreak', vet.bestStreak);
  LS.setItem('vetBestScore', vet.bestScore);
  LS.setItem('feedCorrect', feed.correct);
  LS.setItem('feedBestStreak', feed.bestStreak);
  LS.setItem('feedBestScore', feed.bestScore);
  LS.setItem('tfDone', tf.done);
  LS.setItem('tfBestStreak', tf.bestStreak);
  LS.setItem('tfBestScore', tf.bestScore);
}

// ===== ÌÉ≠ Ï†ÑÌôò =====
function switchTab(tab) {
  speechSynthesis.cancel();
  audioQueue = [];
  isSpeaking = false;
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', ['vet','feed','transform','record'][i] === tab);
  });
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector('.' + tab + '-side').classList.add('active');
  document.querySelectorAll('.game-view').forEach(v => v.classList.remove('active'));
  document.querySelector('.' + tab + '-view').classList.add('active');
  updateActionButtons();
  if (tab === 'record') updateRecords();
}

function updateActionButtons() {
  const a1 = document.getElementById('act1');
  const a2 = document.getElementById('act2');
  const a3 = document.getElementById('act3');
  if (currentTab === 'vet') {
    a1.innerHTML = '<span class="icon">üí°</span>ÌûåÌä∏'; a1.className = 'action-btn btn-cyan'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">‚è≠</span>Îã§Ïùå'; a2.className = 'action-btn btn-green'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">üîÑ</span>Îã§Ïãú'; a3.className = 'action-btn btn-red'; a3.disabled = false;
  } else if (currentTab === 'feed') {
    a1.innerHTML = '<span class="icon">üí°</span>ÌûåÌä∏'; a1.className = 'action-btn btn-cyan'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">‚è≠</span>Îã§Ïùå'; a2.className = 'action-btn btn-green'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">üîÑ</span>Îã§Ïãú'; a3.className = 'action-btn btn-red'; a3.disabled = false;
  } else if (currentTab === 'transform') {
    a1.innerHTML = '<span class="icon">üí°</span>ÌûåÌä∏'; a1.className = 'action-btn btn-cyan'; a1.disabled = false;
    a2.innerHTML = '<span class="icon">‚è≠</span>Îã§Ïùå'; a2.className = 'action-btn btn-green'; a2.disabled = false;
    a3.innerHTML = '<span class="icon">üîÑ</span>Îã§Ïãú'; a3.className = 'action-btn btn-red'; a3.disabled = false;
  } else {
    a1.innerHTML = '<span class="icon">üìä</span>Í∏∞Î°ù'; a1.className = 'action-btn btn-cyan'; a1.disabled = true;
    a2.innerHTML = '<span class="icon">‚Äî</span>‚Äî'; a2.className = 'action-btn btn-green'; a2.disabled = true;
    a3.innerHTML = '<span class="icon">‚Äî</span>‚Äî'; a3.className = 'action-btn btn-red'; a3.disabled = true;
  }
}

function actionBtn(n) {
  if (currentTab === 'vet') {
    if (n === 1) vetHint();
    else if (n === 2) initVetGame();
    else initVetGame();
  } else if (currentTab === 'feed') {
    if (n === 1) feedHint();
    else if (n === 2) initFeedGame();
    else initFeedGame();
  } else if (currentTab === 'transform') {
    if (n === 1) tfHint();
    else if (n === 2) initTransformGame();
    else initTransformGame();
  }
}

// ===== ÏàòÏùòÏÇ¨ ÎÜÄÏù¥ =====
function initVetGame() {
  const animal = VET_ANIMALS[Math.floor(Math.random() * VET_ANIMALS.length)];
  vet.currentAnimal = animal;
  vet.toolsApplied = 0;
  vet.toolsNeeded = animal.tools.length;

  document.getElementById('vet-animal-display').innerHTML = getAnimalSVG(animal.emoji, 400) + `<div class="vet-sick-indicator" id="vet-sick-indicator">${animal.sickEmoji}</div>`;
  document.getElementById('vet-info').textContent = `ü©∫ ${animal.name}(Ïù¥)Í∞Ä ${animal.sick}! ÏπòÎ£åÌï¥ Ï£ºÏÑ∏Ïöî!`;
  document.getElementById('vet-patient').textContent = animal.emoji;

  speak(`${animal.name}(Ïù¥)Í∞Ä ${animal.sick}Ïù¥ÏóêÏöî. ÏπòÎ£åÌï¥ Ï£ºÏÑ∏Ïöî!`);

  // ÎèÑÍµ¨ ÌåîÎ†àÌä∏ ÏÉùÏÑ±
  const palette = document.getElementById('vet-tool-palette');
  palette.innerHTML = animal.tools.map((t, i) =>
    `<div class="vet-tool" id="vet-tool-${i}" draggable="false" data-idx="${i}">
      ${getToolSVG(t, 110)}
      <div class="vet-tool-label">${animal.toolNames[i]}</div>
    </div>`
  ).join('');

  // ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
  setupVetDrag();

  document.getElementById('vet-hearts').innerHTML = '';
}

function getContainerScale() {
  const c = document.querySelector('.container');
  if (!c) return 1;
  const t = getComputedStyle(c).transform;
  if (!t || t === 'none') return 1;
  const m = t.match(/matrix\(([^)]+)\)/);
  if (m) return parseFloat(m[1].split(',')[0]);
  return 1;
}
function setupVetDrag() {
  const tools = document.querySelectorAll('.vet-tool:not(.used)');
  const dropzone = document.getElementById('vet-dropzone');
  const container = document.querySelector('.container');

  tools.forEach(tool => {
    let isDragging = false;
    let clone = null;
    let offsetX, offsetY;

    const onStart = (e) => {
      if (tool.classList.contains('used')) return;
      isDragging = true;
      const touch = e.touches ? e.touches[0] : e;
      const scale = getContainerScale();
      const cRect = container.getBoundingClientRect();
      const tRect = tool.getBoundingClientRect();
      // ÌÅ¥Î°†ÏùÑ containerÏóê ÏßÅÏ†ë Î∂ÄÏ∞© (positioning Î¨∏Ï†ú Ìï¥Í≤∞)
      clone = tool.cloneNode(true);
      clone.style.position = 'absolute';
      clone.style.zIndex = '9999';
      clone.style.width = tRect.width / scale + 'px';
      clone.style.height = tRect.height / scale + 'px';
      clone.style.transition = 'none';
      clone.style.pointerEvents = 'none';
      clone.style.opacity = '0.9';
      clone.style.boxShadow = '0 8px 24px rgba(0,0,0,.25)';
      clone.style.transform = 'scale(1.1)';
      offsetX = (touch.clientX - tRect.left) / scale;
      offsetY = (touch.clientY - tRect.top) / scale;
      const posX = (touch.clientX - cRect.left) / scale - offsetX;
      const posY = (touch.clientY - cRect.top) / scale - offsetY;
      clone.style.left = posX + 'px';
      clone.style.top = posY + 'px';
      container.appendChild(clone);
      tool.style.opacity = '0.3';
      e.preventDefault();
    };

    const onMove = (e) => {
      if (!isDragging || !clone) return;
      const touch = e.touches ? e.touches[0] : e;
      const scale = getContainerScale();
      const cRect = container.getBoundingClientRect();
      const posX = (touch.clientX - cRect.left) / scale - offsetX;
      const posY = (touch.clientY - cRect.top) / scale - offsetY;
      clone.style.left = posX + 'px';
      clone.style.top = posY + 'px';
      e.preventDefault();
    };

    const onEnd = (e) => {
      if (!isDragging) return;
      isDragging = false;
      if (clone) { clone.remove(); clone = null; }
      tool.style.opacity = '';
      const touch = e.changedTouches ? e.changedTouches[0] : e;
      const dzRect = dropzone.getBoundingClientRect();
      const tx = touch.clientX;
      const ty = touch.clientY;

      if (tx >= dzRect.left && tx <= dzRect.right && ty >= dzRect.top && ty <= dzRect.bottom) {
        tool.classList.add('used');
        applyVetTool(parseInt(tool.dataset.idx));
      }
    };

    tool.addEventListener('mousedown', onStart);
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onEnd);
    tool.addEventListener('touchstart', onStart, { passive: false });
    document.addEventListener('touchmove', onMove, { passive: false });
    document.addEventListener('touchend', onEnd);
  });

  // ÌÅ¥Î¶≠ÏúºÎ°úÎèÑ Ï†ÅÏö© Í∞ÄÎä• (Î™®Î∞îÏùº Ìé∏Ïùò)
  tools.forEach(tool => {
    tool.addEventListener('click', () => {
      if (tool.classList.contains('used')) return;
      tool.classList.add('used');
      applyVetTool(parseInt(tool.dataset.idx));
    });
  });
}

function applyVetTool(idx) {
  vet.toolsApplied++;
  const toolName = vet.currentAnimal.toolNames[idx];
  speak(`${toolName} ÏÇ¨Ïö©!`);

  // ÏπòÎ£å ÌååÌã∞ÌÅ¥
  const container = document.getElementById('vet-animal-container');
  const rect = container.getBoundingClientRect();
  const sparkles = ['‚ú®','üí´','‚≠ê','üíö'];
  for (let i = 0; i < 6; i++) {
    const s = document.createElement('div');
    s.className = 'vet-sparkle';
    const angle = (Math.PI * 2 / 6) * i;
    const dist = 50 + Math.random() * 60;
    s.textContent = sparkles[Math.floor(Math.random() * sparkles.length)];
    s.style.cssText = `left:50%;top:50%;font-size:${20+Math.random()*14}px;--tx:${Math.cos(angle)*dist}px;--ty:${Math.sin(angle)*dist}px;--dur:${.5+Math.random()*.3}s`;
    document.getElementById('vet-hearts').appendChild(s);
    setTimeout(() => s.remove(), 800);
  }

  // Î™®Îì† ÎèÑÍµ¨ Ï†ÅÏö© ÏôÑÎ£å?
  if (vet.toolsApplied >= vet.toolsNeeded) {
    setTimeout(() => vetCureComplete(), 500);
  }
}

function vetCureComplete() {
  vet.score += 10 + vet.streak * 3;
  vet.streak++;
  vet.healed++;
  if (vet.streak > vet.bestStreak) vet.bestStreak = vet.streak;
  if (vet.score > vet.bestScore) vet.bestScore = vet.score;
  profile.totalCorrect++;
  profile.totalPlayed++;

  // ÏïÑÌîà ÌëúÏãú Ï†úÍ±∞ + Í∏∞ÏÅú ÌëúÏ†ï
  const display = document.getElementById('vet-animal-display');
  const indicator = document.getElementById('vet-sick-indicator');
  if (indicator) indicator.remove();
  display.innerHTML = getAnimalSVG(vet.currentAnimal.emoji, 400);

  document.getElementById('vet-info').textContent = `üéâ ${vet.currentAnimal.name}(Ïù¥)Í∞Ä Í±¥Í∞ïÌï¥Ï°åÏñ¥Ïöî!`;
  SFX.heal(); SFX.fanfare(); setMascotEmotion('mascot-vet-mouth','bubble-vet','happy');
  speak(`${vet.currentAnimal.name}(Ïù¥)Í∞Ä Í±¥Í∞ïÌï¥Ï°åÏñ¥Ïöî! Í≥†ÎßàÏõåÏöî!`);

  // ÌïòÌä∏ ÌååÌã∞ÌÅ¥
  const hearts = document.getElementById('vet-hearts');
  for (let i = 0; i < 12; i++) {
    setTimeout(() => {
      const h = document.createElement('div');
      h.className = 'vet-heart';
      h.textContent = ['‚ù§Ô∏è','üíö','üíõ','üíñ','üíï'][Math.floor(Math.random() * 5)];
      const tx = (Math.random() - 0.5) * 200;
      const ty = -(50 + Math.random() * 100);
      h.style.cssText = `left:${40 + Math.random()*20}%;top:${40 + Math.random()*20}%;--tx:${tx}px;--ty:${ty}px`;
      hearts.appendChild(h);
      setTimeout(() => h.remove(), 1500);
    }, i * 100);
  }

  updateVetUI();
  updateProfile();
  saveStats();

  // Îã§Ïùå ÎèôÎ¨º (3Ï¥à ÌõÑ)
  setTimeout(() => initVetGame(), 3000);
}

function vetHint() {
  if (!vet.currentAnimal) return;
  const remaining = [];
  document.querySelectorAll('.vet-tool:not(.used)').forEach(t => {
    remaining.push(vet.currentAnimal.toolNames[parseInt(t.dataset.idx)]);
  });
  if (remaining.length > 0) {
    speak(`${remaining[0]}ÏùÑ ÏÇ¨Ïö©Ìï¥ Î≥¥ÏÑ∏Ïöî!`);
  }
}

function updateVetUI() {
  document.getElementById('vet-healed').textContent = vet.healed;
  document.getElementById('vet-score-side').textContent = vet.score;
  document.getElementById('vet-streak').textContent = vet.streak;
}

// ===== Î∞• Ï§ò! =====
function initFeedGame() {
  const animal = FEED_DATA[Math.floor(Math.random() * FEED_DATA.length)];
  feed.currentAnimal = animal;
  feed.answered = false;

  // ÎèôÎ¨º ÌëúÏãú
  const animalEl = document.getElementById('feed-animal');
  animalEl.innerHTML = `<div class="feed-animal-speech" id="feed-speech">Î∞∞Í≥†ÌååÏöî~</div>${getAnimalSVG(animal.emoji, 280)}<div class="feed-type-badge ${animal.typeClass}" id="feed-type-badge">${animal.type}</div>`;
  document.getElementById('feed-info').textContent = `üçΩ ${animal.name}ÏóêÍ≤å ÏïåÎßûÏùÄ Î®πÏù¥Î•º Í≥®ÎùºÏ£ºÏÑ∏Ïöî!`;
  document.getElementById('feed-result').textContent = '';
  document.getElementById('feed-result').style.color = '';

  speak(`${animal.name}(Ïù¥)Í∞Ä Î∞∞Í≥†ÌååÏöî. Î¨¥ÏóáÏùÑ Ï§ÑÍπåÏöî?`);

  // Î®πÏù¥ Î≥¥Í∏∞ ÏÉùÏÑ± (Ï†ïÎãµ + Ïò§Îãµ 2Í∞ú)
  let choices = [animal.food];
  const others = ALL_FOODS.filter(f => f !== animal.food);
  while (choices.length < 6) {
    const r = others[Math.floor(Math.random() * others.length)];
    if (!choices.includes(r)) choices.push(r);
  }
  // ÏÖîÌîå
  choices.sort(() => Math.random() - 0.5);

  const grid = document.getElementById('food-choices');
  grid.innerHTML = choices.map(f =>
    `<div class="food-choice" data-food="${f}" onclick="feedSelect(this,'${f}')">${getFoodSVG(f, 140)}</div>`
  ).join('');
}

function feedSelect(el, food) {
  if (feed.answered) return;
  feed.answered = true;
  profile.totalPlayed++;

  const animal = feed.currentAnimal;
  const area = document.getElementById('feed-area');

  if (food === animal.food) {
    // Ï†ïÎãµ!
    el.classList.add('correct');
    feed.score += 10 + feed.streak * 3;
    feed.streak++;
    feed.correct++;
    if (feed.streak > feed.bestStreak) feed.bestStreak = feed.streak;
    if (feed.score > feed.bestScore) feed.bestScore = feed.score;
    profile.totalCorrect++;

    document.getElementById('feed-speech').textContent = 'ÎßõÏûàÎã§! ÎÉ†ÎÉ†!';
    document.getElementById('feed-result').textContent = `üéâ Ï†ïÎãµ! ${animal.name}ÏùÄ ${animal.foodName}ÏùÑ Ï¢ãÏïÑÌï¥Ïöî!`;
    document.getElementById('feed-result').style.color = '#16a34a';
    SFX.feed(); SFX.correct(); setMascotEmotion('mascot-feed-mouth','bubble-feed','happy');
    speak(`Ï†ïÎãµ! ${animal.name}ÏùÄ ${animal.foodName}ÏùÑ Ï¢ãÏïÑÌï¥Ïöî!`);

    // Î®πÍ∏∞ ÏÑ±Í≥µ Ïù¥ÌéôÌä∏ - ÌååÌã∞ÌÅ¥
    const rect = el.getBoundingClientRect();
    const aRect = area.getBoundingClientRect();
    const cx = rect.left - aRect.left + rect.width/2;
    const cy = rect.top - aRect.top + rect.height/2;
    const yumEl = document.createElement('div');
    yumEl.className = 'feed-yum';
    yumEl.textContent = 'ÎÉ†ÎÉ†!';
    yumEl.style.cssText = `left:${cx}px;top:${cy-10}px;color:#22c55e`;
    area.appendChild(yumEl);
    setTimeout(() => yumEl.remove(), 800);

    // Ïª®ÌéòÌã∞
    feedConfettiEffect();

    setTimeout(() => initFeedGame(), 2500);
  } else {
    // Ïò§Îãµ - Î±âÏñ¥ÎÉÑ
    el.classList.add('wrong');
    feed.streak = 0;

    document.getElementById('feed-speech').textContent = 'Ïù¥Í±¥ ÏïÑÎãàÏïº~!';
    document.getElementById('feed-result').textContent = `‚ùå ${animal.name}ÏùÄ Ïù¥Í±∏ Ïïà Î®πÏñ¥Ïöî! ${animal.foodName}ÏùÑ Ï§òÏïº Ìï¥Ïöî`;
    document.getElementById('feed-result').style.color = '#dc2626';
    SFX.wrong(); setMascotEmotion('mascot-feed-mouth','bubble-feed','worried');
    speak(`ÌãÄÎ†∏Ïñ¥Ïöî! ${animal.name}ÏùÄ ${animal.foodName}ÏùÑ Ï¢ãÏïÑÌï¥Ïöî`);

    // Î±âÏñ¥ÎÉÑ Ïï†ÎãàÎ©îÏù¥ÏÖò
    const rect = el.getBoundingClientRect();
    const aRect = area.getBoundingClientRect();
    const spit = document.createElement('div');
    spit.className = 'feed-spit';
    spit.textContent = food;
    spit.style.cssText = `left:${rect.left - aRect.left + rect.width/2}px;top:${rect.top - aRect.top}px;font-size:40px;--tx:${(Math.random()>.5?1:-1)*100}px;--ty:-80px`;
    area.appendChild(spit);
    setTimeout(() => spit.remove(), 800);

    // Ï†ïÎãµ Í∞ïÏ°∞
    setTimeout(() => {
      document.querySelectorAll('.food-choice').forEach(fc => {
        if (fc.dataset.food === animal.food) fc.classList.add('correct');
      });
    }, 800);

    setTimeout(() => initFeedGame(), 3000);
  }

  updateFeedUI();
  updateProfile();
  saveStats();
}

function feedHint() {
  if (!feed.currentAnimal || feed.answered) return;
  const animal = feed.currentAnimal;
  speak(`${animal.name}ÏùÄ ${animal.type} ÎèôÎ¨ºÏù¥ÏóêÏöî!`);
  document.getElementById('feed-speech').textContent = `ÎÇòÎäî ${animal.type} ÎèôÎ¨º!`;
}

function feedConfettiEffect() {
  const area = document.getElementById('feed-area');
  const colors = ['#22c55e','#84cc16','#fbbf24','#3b82f6','#8b5cf6','#ec4899','#ef4444'];
  for (let i = 0; i < 25; i++) {
    const c = document.createElement('div');
    c.className = 'feed-confetti';
    c.style.cssText = `left:${Math.random()*100}%;top:-10px;background:${colors[Math.floor(Math.random()*colors.length)]};--tx:${(Math.random()-.5)*200}px;--ty:${200+Math.random()*300}px;--dur:${.8+Math.random()*.6}s;animation-delay:${Math.random()*.3}s;width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;border-radius:${Math.random()>.5?'50%':'2px'}`;
    area.appendChild(c);
    setTimeout(() => c.remove(), 1500);
  }
  // SVG ÌïòÌä∏/Î≥Ñ ÌååÌã∞ÌÅ¥
  feedSvgParticles();
}

function feedSvgParticles() {
  const area = document.getElementById('feed-area');
  const aRect = area.getBoundingClientRect();
  const cx = aRect.width / 2;
  const cy = aRect.height / 2;
  const heartPath = 'M0,-8 C-5,-16 -16,-10 -13,-2.5 C-10,5 0,13 0,13 C0,13 10,5 13,-2.5 C16,-10 5,-16 0,-8Z';
  const starPath = 'M0,-12 L3,-4 L12,-4 L5,2 L8,11 L0,6 L-8,11 L-5,2 L-12,-4 L-3,-4Z';
  const svgColors = ['#ef4444','#f472b6','#fbbf24','#22c55e','#8b5cf6','#3b82f6'];
  for (let i = 0; i < 12; i++) {
    const ns = 'http://www.w3.org/2000/svg';
    const svg = document.createElementNS(ns, 'svg');
    svg.setAttribute('viewBox', '-16 -16 32 32');
    const isHeart = Math.random() > 0.5;
    const path = document.createElementNS(ns, 'path');
    path.setAttribute('d', isHeart ? heartPath : starPath);
    path.setAttribute('fill', svgColors[Math.floor(Math.random() * svgColors.length)]);
    svg.appendChild(path);
    svg.style.cssText = `position:absolute;pointer-events:none;z-index:20;width:${28+Math.random()*20}px;height:${28+Math.random()*20}px;left:${cx}px;top:${cy}px;`;
    area.appendChild(svg);
    const angle = (Math.PI * 2 / 12) * i + (Math.random() - .5) * .5;
    const dist = 80 + Math.random() * 120;
    const tx = Math.cos(angle) * dist;
    const ty = Math.sin(angle) * dist;
    const dur = 600 + Math.random() * 400;
    const rot = (Math.random() - .5) * 360;
    svg.animate([
      { transform: 'translate(0,0) scale(0) rotate(0deg)', opacity: 0 },
      { transform: `translate(${tx*.3}px,${ty*.3}px) scale(1.3) rotate(${rot*.3}deg)`, opacity: 1, offset: 0.3 },
      { transform: `translate(${tx}px,${ty}px) scale(.4) rotate(${rot}deg)`, opacity: 0 }
    ], { duration: dur, easing: 'ease-out', fill: 'forwards' });
    setTimeout(() => svg.remove(), dur);
  }
}

function updateFeedUI() {
  document.getElementById('feed-correct-side').textContent = feed.correct;
  document.getElementById('feed-score-side').textContent = feed.score;
  document.getElementById('feed-streak-side').textContent = feed.streak;
}

// ===== Î≥ÄÏã† Ïï®Î≤î =====
function initTransformGame() {
  const set = TRANSFORM_SETS[Math.floor(Math.random() * TRANSFORM_SETS.length)];
  tf.currentSet = set;
  tf.filledSlots = [];
  tf.nextSlotIdx = 0;

  document.getElementById('transform-set-name').textContent = set.name;
  document.getElementById('transform-info').textContent = 'ü¶ã Ïò¨Î∞îÎ•∏ ÏàúÏÑúÎ°ú Î≥ÄÏã† Ïπ¥ÎìúÎ•º ÎÜìÏïÑÎ≥¥ÏÑ∏Ïöî!';

  speak(`${set.name}! ÏàúÏÑúÎåÄÎ°ú Ïπ¥ÎìúÎ•º ÎÜìÏïÑÏ£ºÏÑ∏Ïöî`);

  // Ïä¨Î°Ø ÏÉùÏÑ±
  const slotRow = document.getElementById('slot-row');
  let slotHtml = '';
  for (let i = 0; i < set.stages.length; i++) {
    if (i > 0) slotHtml += '<div class="slot-arrow">‚Üí</div>';
    slotHtml += `<div class="slot-box" id="slot-${i}"><div class="slot-num">${i+1}Î≤àÏß∏</div>?</div>`;
  }
  slotRow.innerHTML = slotHtml;

  // Ïπ¥Îìú ÌíÄ (ÏÖîÌîå)
  const shuffled = [...set.stages].sort(() => Math.random() - 0.5);
  const pool = document.getElementById('card-pool');
  pool.innerHTML = shuffled.map((s, i) =>
    `<div class="stage-card" id="card-${i}" data-emoji="${s.emoji}" data-label="${s.label}" onclick="tfSelectCard(this)">
      <div class="card-emoji">${s.emoji}</div>
      <div class="card-label">${s.label}</div>
    </div>`
  ).join('');
}

function tfSelectCard(card) {
  if (card.classList.contains('placed')) return;
  if (tf.nextSlotIdx >= tf.currentSet.stages.length) return;

  const expected = tf.currentSet.stages[tf.nextSlotIdx];
  const cardEmoji = card.dataset.emoji;
  const cardLabel = card.dataset.label;
  const slot = document.getElementById('slot-' + tf.nextSlotIdx);

  profile.totalPlayed++;

  if (cardEmoji === expected.emoji) {
    // Ï†ïÎãµ!
    card.classList.add('placed');
    slot.innerHTML = `<div class="slot-num">${tf.nextSlotIdx+1}Î≤àÏß∏</div><span style="font-size:110px">${cardEmoji}</span>`;
    slot.classList.add('filled');
    SFX.transform();
    speak(`${cardLabel}!`);
    tf.nextSlotIdx++;

    // Î™®Îì† Ïä¨Î°Ø Ï±ÑÏõÄ?
    if (tf.nextSlotIdx >= tf.currentSet.stages.length) {
      setTimeout(() => tfComplete(), 500);
    }
  } else {
    // Ïò§Îãµ - ÏõÉÍ∏¥ Í≤∞Í≥ºÎ¨º
    slot.classList.add('wrong-slot');
    slot.innerHTML = `<div class="slot-num">${tf.nextSlotIdx+1}Î≤àÏß∏</div><span style="font-size:100px">${cardEmoji}</span>`;
    SFX.wrong(); setMascotEmotion('mascot-tf-mouth','bubble-tf','worried');
    speak('Ïïó! ÏàúÏÑúÍ∞Ä Îã¨ÎùºÏöî!');

    const area = document.getElementById('transform-area');
    const wrongEmojis = ['üòµ','ü§™','üòÇ','üôÉ'];
    const wr = document.createElement('div');
    wr.className = 'transform-wrong-result';
    wr.textContent = wrongEmojis[Math.floor(Math.random() * wrongEmojis.length)];
    wr.style.cssText = 'left:50%;top:45%';
    area.appendChild(wr);
    setTimeout(() => wr.remove(), 2000);

    tf.streak = 0;

    setTimeout(() => {
      slot.classList.remove('wrong-slot');
      slot.innerHTML = `<div class="slot-num">${tf.nextSlotIdx+1}Î≤àÏß∏</div>?`;
    }, 1000);
  }
  saveStats();
}

function tfComplete() {
  tf.score += 10 + tf.streak * 5;
  tf.streak++;
  tf.done++;
  if (tf.streak > tf.bestStreak) tf.bestStreak = tf.streak;
  if (tf.score > tf.bestScore) tf.bestScore = tf.score;
  profile.totalCorrect++;

  document.getElementById('transform-info').textContent = `üéâ ${tf.currentSet.name} ÏôÑÏÑ±!`;
  SFX.fanfare(); setMascotEmotion('mascot-tf-mouth','bubble-tf','happy');
  speak(`ÎåÄÎã®Ìï¥Ïöî! ${tf.currentSet.name} ÏôÑÏÑ±!`);

  // Î≥ÄÏã† Ïï†ÎãàÎ©îÏù¥ÏÖò
  const area = document.getElementById('transform-area');
  const morph = document.createElement('div');
  morph.className = 'transform-anim-overlay';
  morph.innerHTML = `<div class="transform-morph">${tf.currentSet.final}</div>`;
  area.appendChild(morph);

  // Ïä§ÌååÌÅ¥ ÎßÅ
  for (let i = 0; i < 3; i++) {
    setTimeout(() => {
      const ring = document.createElement('div');
      ring.className = 'transform-sparkle-ring';
      const size = 150 + i * 80;
      const colors = ['#22c55e','#84cc16','#fbbf24'];
      ring.style.cssText = `left:50%;top:45%;width:${size}px;height:${size}px;border:4px solid ${colors[i]};box-shadow:0 0 20px ${colors[i]}`;
      area.appendChild(ring);
      setTimeout(() => ring.remove(), 800);
    }, i * 200);
  }

  setTimeout(() => morph.remove(), 2500);

  updateTfUI();
  updateProfile();
  saveStats();

  setTimeout(() => initTransformGame(), 3500);
}

function tfHint() {
  if (!tf.currentSet || tf.nextSlotIdx >= tf.currentSet.stages.length) return;
  const next = tf.currentSet.stages[tf.nextSlotIdx];
  speak(`Îã§ÏùåÏùÄ ${next.label}Ïù¥ÏóêÏöî!`);
  document.getElementById('transform-info').textContent = `üí° ÌûåÌä∏: Îã§ÏùåÏùÄ "${next.label}"!`;
}

function updateTfUI() {
  document.getElementById('tf-done-side').textContent = tf.done;
  document.getElementById('tf-score-side').textContent = tf.score;
  document.getElementById('tf-streak-side').textContent = tf.streak;
}

// ===== ÎÇ¥ Í∏∞Î°ù =====
function updateRecords() {
  document.getElementById('r-total').textContent = profile.totalPlayed;
  document.getElementById('r-correct').textContent = profile.totalCorrect;
  document.getElementById('r-rate').textContent = profile.totalPlayed ? Math.round(profile.totalCorrect / profile.totalPlayed * 100) + '%' : '0%';
  document.getElementById('rec-total').textContent = profile.totalPlayed;
  document.getElementById('rec-rate').textContent = profile.totalPlayed ? Math.round(profile.totalCorrect / profile.totalPlayed * 100) + '%' : '0%';
  document.getElementById('r-vet-healed').textContent = vet.healed;
  document.getElementById('r-vet-streak').textContent = vet.bestStreak;
  document.getElementById('r-vet-score').textContent = vet.bestScore;
  document.getElementById('r-feed-correct').textContent = feed.correct;
  document.getElementById('r-feed-streak').textContent = feed.bestStreak;
  document.getElementById('r-feed-score').textContent = feed.bestScore;
  document.getElementById('r-tf-done').textContent = tf.done;
  document.getElementById('r-tf-streak').textContent = tf.bestStreak;
  document.getElementById('r-tf-score').textContent = tf.bestScore;
}

// ===== ÌûàÏñ¥Î°ú: ÏÑúÏãùÏßÄ Î∂ÑÎ•òÏôï =====
function startHeroGame() {
  try{document.documentElement.requestFullscreen?.()}catch(e){}
  document.getElementById('hero-game').classList.remove('hidden');
  document.getElementById('hg-start').classList.remove('hidden');
  document.getElementById('hg-over').classList.add('hidden');
  document.getElementById('hg-pause-screen').classList.add('hidden');
}

function hgStart() {
  SFX.gameStart();
  document.getElementById('hg-start').classList.add('hidden');
  hg.score = 0; hg.lives = 5; hg.level = 1; hg.running = true; hg.paused = false;
  hg.started = true; hg.animals = []; hg.combo = 0; hg.maxCombo = 0;
  updateHgUI();
  hgSetupBiomes();
  addHgClouds();
  hgLoop();
}

function hgSetupBiomes() {
  const arena = document.getElementById('hg-arena');
  // Í∏∞Ï°¥ Î∞îÏù¥Ïò¥ Ï†úÍ±∞
  arena.querySelectorAll('.hg-biome').forEach(b => b.remove());

  let biomeKeys;
  if (hg.level < 3) biomeKeys = ['forest', 'ocean'];
  else if (hg.level < 6) biomeKeys = ['forest', 'ocean', 'desert'];
  else biomeKeys = ['forest', 'ocean', 'desert', 'arctic'];

  hg.biomes = biomeKeys;
  const count = biomeKeys.length;

  // ÎîîÎ∞îÏù¥Îçî ÏóÖÎç∞Ïù¥Ìä∏
  document.getElementById('hg-divider').style.display = count === 2 ? 'block' : 'none';
  document.getElementById('hg-divider2').style.display = count >= 3 ? 'block' : 'none';
  document.getElementById('hg-divider3').style.display = count >= 3 ? 'block' : 'none';
  document.getElementById('hg-divider4').style.display = count >= 4 ? 'block' : 'none';
  document.getElementById('hg-divider5').style.display = count >= 4 ? 'block' : 'none';

  if (count === 3) {
    document.getElementById('hg-divider2').style.left = '33.33%';
    document.getElementById('hg-divider3').style.left = '66.66%';
  } else if (count === 4) {
    document.getElementById('hg-divider4').style.left = '25%';
    document.getElementById('hg-divider').style.left = '50%';
    document.getElementById('hg-divider5').style.left = '75%';
  }

  const BIOME_SVG = {
    forest: `<svg class="biome-svg-deco" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;opacity:.35">
      <g fill="#0d5016"><polygon points="60,280 80,120 100,280"/><polygon points="50,280 80,180 110,280"/></g>
      <g fill="#166534"><polygon points="160,280 185,90 210,280"/><polygon points="145,280 185,150 225,280"/></g>
      <g fill="#14532d"><polygon points="280,280 300,140 320,280"/><polygon points="268,280 300,200 332,280"/></g>
      <g fill="#15803d" opacity=".5"><polygon points="340,280 355,170 370,280"/><polygon points="20,280 38,200 56,280"/></g>
      <circle cx="90" cy="80" r="4" fill="#86efac" opacity=".6"><animate attributeName="opacity" values=".6;.2;.6" dur="3s" repeatCount="indefinite"/></circle>
      <circle cx="300" cy="100" r="3" fill="#bbf7d0" opacity=".5"><animate attributeName="opacity" values=".5;.15;.5" dur="2.5s" repeatCount="indefinite"/></circle>
      <circle cx="200" cy="60" r="3.5" fill="#a7f3d0" opacity=".4"><animate attributeName="opacity" values=".4;.1;.4" dur="2s" repeatCount="indefinite"/></circle>
    </svg>`,
    ocean: `<svg class="biome-svg-deco" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;opacity:.35">
      <path d="M0,200 Q50,185 100,200 T200,200 T300,200 T400,200 L400,300 L0,300Z" fill="#1d4ed8" opacity=".5"><animate attributeName="d" values="M0,200 Q50,185 100,200 T200,200 T300,200 T400,200 L400,300 L0,300Z;M0,200 Q50,215 100,200 T200,200 T300,200 T400,200 L400,300 L0,300Z;M0,200 Q50,185 100,200 T200,200 T300,200 T400,200 L400,300 L0,300Z" dur="4s" repeatCount="indefinite"/></path>
      <path d="M0,220 Q60,205 120,220 T240,220 T360,220 T400,220 L400,300 L0,300Z" fill="#1e40af" opacity=".4"><animate attributeName="d" values="M0,220 Q60,205 120,220 T240,220 T360,220 T400,220 L400,300 L0,300Z;M0,220 Q60,235 120,220 T240,220 T360,220 T400,220 L400,300 L0,300Z;M0,220 Q60,205 120,220 T240,220 T360,220 T400,220 L400,300 L0,300Z" dur="3.5s" repeatCount="indefinite"/></path>
      <g fill="#60a5fa" opacity=".3"><ellipse cx="80" cy="240" rx="20" ry="6"><animate attributeName="rx" values="20;25;20" dur="2s" repeatCount="indefinite"/></ellipse><ellipse cx="300" cy="250" rx="18" ry="5"><animate attributeName="rx" values="18;23;18" dur="2.5s" repeatCount="indefinite"/></ellipse></g>
      <g opacity=".25" fill="#93c5fd"><path d="M150,180 Q155,170 160,175 Q165,165 170,170 Q175,160 180,175 L175,180 Q170,176 165,180 Q160,174 155,180Z"><animate attributeName="transform" type="translate" values="0,0;-5,3;0,0" dur="5s" repeatCount="indefinite"/></path><path d="M260,200 Q265,190 270,195 Q275,185 280,190 Q285,180 290,195 L285,200 Q280,196 275,200 Q270,194 265,200Z"><animate attributeName="transform" type="translate" values="0,0;5,-3;0,0" dur="4s" repeatCount="indefinite"/></path></g>
      <circle cx="100" cy="260" r="6" fill="#7dd3fc" opacity=".2"><animate attributeName="cy" values="260;255;260" dur="3s" repeatCount="indefinite"/></circle>
      <circle cx="320" cy="270" r="5" fill="#7dd3fc" opacity=".15"><animate attributeName="cy" values="270;265;270" dur="2.5s" repeatCount="indefinite"/></circle>
    </svg>`,
    desert: `<svg class="biome-svg-deco" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;opacity:.35">
      <g fill="#a16207" opacity=".6"><path d="M80,280 L80,200 Q75,195 80,190 Q85,195 80,200 M80,210 Q65,205 60,215 M80,230 Q95,225 100,235"/><path d="M300,280 L300,180 Q295,175 300,170 Q305,175 300,180 M300,200 Q285,195 280,205 M300,220 Q315,215 320,225 M300,190 Q315,185 320,195"/></g>
      <g fill="#ca8a04" opacity=".4"><path d="M200,280 L200,220 Q195,215 200,210 Q205,215 200,220 M200,240 Q190,236 186,244"/></g>
      <circle cx="350" cy="50" r="25" fill="#fbbf24" opacity=".3"/><circle cx="350" cy="50" r="18" fill="#fde68a" opacity=".2"/>
      <g fill="#d97706" opacity=".15"><path d="M0,270 Q100,255 200,270 T400,270 L400,300 L0,300Z"/></g>
      <circle cx="150" cy="260" r="3" fill="#fde68a" opacity=".3"><animate attributeName="opacity" values=".3;.1;.3" dur="4s" repeatCount="indefinite"/></circle>
      <circle cx="250" cy="250" r="2" fill="#fef3c7" opacity=".25"><animate attributeName="opacity" values=".25;.08;.25" dur="3s" repeatCount="indefinite"/></circle>
    </svg>`,
    arctic: `<svg class="biome-svg-deco" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;opacity:.35">
      <g fill="#e0f2fe" opacity=".5"><polygon points="60,160 70,80 80,160"/><polygon points="55,160 70,120 85,160"/></g>
      <g stroke="#bae6fd" stroke-width="1.5" fill="none" opacity=".5">
        <g transform="translate(100,60)"><line x1="0" y1="-15" x2="0" y2="15"/><line x1="-13" y1="-7.5" x2="13" y2="7.5"/><line x1="-13" y1="7.5" x2="13" y2="-7.5"/><line x1="-5" y1="-12" x2="5" y2="12" transform="rotate(30)"/><line x1="-5" y1="-12" x2="5" y2="12" transform="rotate(60)"/><line x1="-5" y1="-12" x2="5" y2="12" transform="rotate(120)"/><animate attributeName="opacity" values=".5;.2;.5" dur="3s" repeatCount="indefinite"/></g>
        <g transform="translate(300,80) scale(.7)"><line x1="0" y1="-15" x2="0" y2="15"/><line x1="-13" y1="-7.5" x2="13" y2="7.5"/><line x1="-13" y1="7.5" x2="13" y2="-7.5"/><animate attributeName="opacity" values=".4;.15;.4" dur="2.5s" repeatCount="indefinite"/></g>
        <g transform="translate(200,40) scale(.5)"><line x1="0" y1="-15" x2="0" y2="15"/><line x1="-13" y1="-7.5" x2="13" y2="7.5"/><line x1="-13" y1="7.5" x2="13" y2="-7.5"/><animate attributeName="opacity" values=".35;.1;.35" dur="3.5s" repeatCount="indefinite"/></g>
      </g>
      <g fill="#fff" opacity=".15"><ellipse cx="120" cy="270" rx="50" ry="12"/><ellipse cx="300" cy="260" rx="40" ry="10"/></g>
      <circle cx="50" cy="100" r="2" fill="#fff" opacity=".4"><animate attributeName="opacity" values=".4;.1;.4" dur="2s" repeatCount="indefinite"/></circle>
      <circle cx="350" cy="120" r="2.5" fill="#fff" opacity=".3"><animate attributeName="opacity" values=".3;.08;.3" dur="2.8s" repeatCount="indefinite"/></circle>
      <circle cx="180" cy="90" r="1.5" fill="#e0f2fe" opacity=".35"><animate attributeName="opacity" values=".35;.1;.35" dur="3.2s" repeatCount="indefinite"/></circle>
    </svg>`
  };

  biomeKeys.forEach((key, i) => {
    const data = BIOME_DATA[key];
    const biome = document.createElement('div');
    let cls = 'hg-biome';
    if (count === 2) { cls += i === 0 ? ' left' : ' right'; }
    else if (count === 3) { cls += ` third b${i}`; }
    else { cls += ` fourth b${i}`; }
    biome.className = cls;
    biome.dataset.biome = key;
    biome.style.background = data.bg;
    biome.innerHTML = `
      ${BIOME_SVG[key] || ''}
      <div class="hg-biome-ground" style="background:${data.ground}"></div>
      <div class="hg-biome-icon">${data.emoji}</div>
      <div class="hg-biome-label">${data.emoji} ${data.name}</div>
    `;
    arena.appendChild(biome);
  });
}

function addHgClouds() {
  const arena = document.getElementById('hg-arena');
  arena.querySelectorAll('.hg-cloud').forEach(c => c.remove());
  for (let i = 0; i < 4; i++) {
    const c = document.createElement('div');
    c.className = 'hg-cloud'; c.textContent = '‚òÅÔ∏è';
    c.style.top = (5 + Math.random() * 25) + '%';
    c.style.animationDelay = -(Math.random() * 25) + 's';
    c.style.fontSize = (28 + Math.random() * 28) + 'px';
    arena.appendChild(c);
  }
}

function hgLoop() {
  const interval = Math.max(1500, 3500 - hg.level * 300);
  if (hg.spawnTimer) clearInterval(hg.spawnTimer);
  hg.spawnTimer = setInterval(() => {
    if (!hg.paused && hg.running) hgSpawn();
  }, interval);

  function tick() {
    if (!hg.running) return;
    if (!hg.paused) hgMove();
    hg.animId = requestAnimationFrame(tick);
  }
  hg.animId = requestAnimationFrame(tick);
}

function hgSpawn() {
  // 5% ÌååÏõåÏóÖ
  if (Math.random() < 0.05) { hgSpawnPower(); return; }

  const arena = document.getElementById('hg-arena');
  const w = arena.offsetWidth;

  // ÌòÑÏû¨ ÌôúÏÑ± Î∞îÏù¥Ïò¥ÏóêÏÑú ÎûúÎç§ ÏÑ†ÌÉù
  const biomeKey = hg.biomes[Math.floor(Math.random() * hg.biomes.length)];
  const biomeData = BIOME_DATA[biomeKey];
  const animalEmoji = biomeData.animals[Math.floor(Math.random() * biomeData.animals.length)];

  const el = document.createElement('div');
  el.className = 'falling-animal';
  const animalSvg = ANIMAL_SVG[animalEmoji];
  if (animalSvg) {
    el.innerHTML = `<div style="width:180px;height:180px">${animalSvg}</div>`;
  } else {
    el.textContent = animalEmoji;
    el.style.fontSize = '150px';
  }
  el.style.left = (40 + Math.random() * (w - 200)) + 'px';
  el.style.top = '-80px';
  arena.appendChild(el);

  const speed = 0.25 + hg.level * 0.06 + Math.random() * 0.1;
  const sway = (Math.random() - 0.5) * 1.2;
  const item = { el, y: -80, x: parseFloat(el.style.left), speed, sway, emoji: animalEmoji, biome: biomeKey };
  hg.animals.push(item);

  // ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏
  setupAnimalDrag(el, item);
}

// ÌûàÏñ¥Î°ú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Í¥ÄÎ¶¨ (ÎàÑÏ†Å Î∞©ÏßÄ)
let _hgDocListeners = [];
function _hgCleanListeners() {
  _hgDocListeners.forEach(([ev, fn, opts]) => document.removeEventListener(ev, fn, opts));
  _hgDocListeners = [];
}

function setupAnimalDrag(el, item) {
  let isDragging = false;
  let offsetX = 0, offsetY = 0;

  const onStart = (e) => {
    if (item.placed) return;
    isDragging = true;
    item.dragging = true;
    el.classList.add('dragging');
    const touch = e.touches ? e.touches[0] : e;
    const scale = getContainerScale();
    const rect = el.getBoundingClientRect();
    offsetX = (touch.clientX - rect.left) / scale;
    offsetY = (touch.clientY - rect.top) / scale;
    e.preventDefault();
    e.stopPropagation();
  };

  const onMove = (e) => {
    if (!isDragging) return;
    const touch = e.touches ? e.touches[0] : e;
    const scale = getContainerScale();
    const arena = document.getElementById('hg-arena');
    const arenaRect = arena.getBoundingClientRect();
    const newX = (touch.clientX - arenaRect.left) / scale - offsetX;
    const newY = (touch.clientY - arenaRect.top) / scale - offsetY;
    item.x = newX;
    item.y = newY;
    el.style.left = newX + 'px';
    el.style.top = newY + 'px';
    e.preventDefault();
  };

  const onEnd = (e) => {
    if (!isDragging) return;
    isDragging = false;
    item.dragging = false;
    el.classList.remove('dragging');

    const touch = e.changedTouches ? e.changedTouches[0] : e;
    const dropBiome = getBiomeAtPoint(touch.clientX, touch.clientY);

    if (dropBiome) {
      hgPlaceAnimal(item, dropBiome);
    }
  };

  el.addEventListener('mousedown', onStart);
  el.addEventListener('touchstart', onStart, { passive: false });
  const moveFn = onMove;
  const endFn = onEnd;
  document.addEventListener('mousemove', moveFn);
  document.addEventListener('mouseup', endFn);
  document.addEventListener('touchmove', moveFn, { passive: false });
  document.addEventListener('touchend', endFn);
  _hgDocListeners.push(['mousemove', moveFn], ['mouseup', endFn], ['touchmove', moveFn, { passive: false }], ['touchend', endFn]);
}

function getBiomeAtPoint(clientX, clientY) {
  const biomeEls = document.querySelectorAll('.hg-biome');
  for (const b of biomeEls) {
    const rect = b.getBoundingClientRect();
    if (clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom) {
      return b.dataset.biome;
    }
  }
  return null;
}

function hgPlaceAnimal(item, targetBiome) {
  item.placed = true;
  item.el.classList.add('placed');
  const arena = document.getElementById('hg-arena');

  if (targetBiome === item.biome) {
    // Ï†ïÎãµ!
    hg.combo++;
    if (hg.combo > hg.maxCombo) hg.maxCombo = hg.combo;
    const bonus = Math.min(hg.combo - 1, 5);
    hg.score += 1 + bonus;

    // Ï†ïÎãµ Ïù¥ÌéôÌä∏
    const flash = document.createElement('div');
    flash.className = 'hg-flash-green';
    arena.appendChild(flash);
    setTimeout(() => flash.remove(), 300);

    const scorePop = document.createElement('div');
    scorePop.className = 'hg-score-pop';
    scorePop.textContent = `+${1 + bonus}`;
    scorePop.style.cssText = `left:${item.x + 32}px;top:${item.y}px`;
    arena.appendChild(scorePop);
    setTimeout(() => scorePop.remove(), 800);

    SFX.correct();
    if (hg.combo >= 3) SFX.combo(hg.combo);
    speak('Ï†ïÎãµ!');

    // ÏΩ§Î≥¥ ÌëúÏãú
    if (hg.combo >= 3) {
      const ce = document.createElement('div');
      ce.className = 'hg-combo-text';
      ce.textContent = `${hg.combo} COMBO!`;
      arena.appendChild(ce);
      setTimeout(() => ce.remove(), 1000);
    }

    // ÎèôÎ¨º ÏÇ¨ÎùºÏßê Ïï†ÎãàÎ©îÏù¥ÏÖò
    item.el.style.transition = 'all .4s ease-out';
    item.el.style.transform = 'scale(0)';
    item.el.style.opacity = '0';
    setTimeout(() => item.el.remove(), 400);

    const nl = Math.floor(hg.score / 8) + 1;
    if (nl > hg.level) {
      hg.level = nl;
      SFX.levelup();
      hgSetupBiomes();
      hgUpdateBg();
    }
  } else {
    // Ïò§Îãµ!
    hg.combo = 0;

    if (hg.shielded) {
      hg.shielded = false;
      speak('Ïö∏ÌÉÄÎ¶¨Î°ú ÎßâÏïòÏñ¥Ïöî!');
      // ÎèôÎ¨º Ï†úÍ±∞ (Î≥¥Ìò∏Îê®)
      item.placed = true;
      item.el.style.transition = 'all .4s ease-out';
      item.el.style.transform = 'scale(0)';
      item.el.style.opacity = '0';
      setTimeout(() => item.el.remove(), 400);
    } else {
      hg.lives--;

      // ÎãπÌô© Ïï†ÎãàÎ©îÏù¥ÏÖò
      item.el.classList.add('hg-animal-confused');
      setTimeout(() => item.el.classList.remove('hg-animal-confused'), 1000);

      const flash = document.createElement('div');
      flash.className = 'hg-flash-red';
      arena.appendChild(flash);
      setTimeout(() => flash.remove(), 400);

      arena.classList.add('hg-arena-shake');
      setTimeout(() => arena.classList.remove('hg-arena-shake'), 400);

      SFX.wrong();
      speak('Ïïó! Ïó¨Í∏∞Í∞Ä ÏïÑÎãàÏóêÏöî!');

      // ÎèôÎ¨º ÏõêÎûò ÏúÑÏπòÎ°ú Î≥µÍ∑Ä
      item.placed = false;
      item.el.classList.remove('placed');

      if (hg.lives <= 0) {
        hgEnd();
        return;
      }
    }
  }

  // Î¶¨Ïä§Ìä∏ÏóêÏÑú Ï†úÍ±∞ (Ï†ïÎãµÏùº ÎïåÎßå)
  if (item.placed) {
    hg.animals = hg.animals.filter(a => a !== item);
  }

  updateHgUI();
}

function hgSpawnPower() {
  const types = [{e:'‚ù§Ô∏è',fx:'life',name:'ÏÉùÎ™Ö'},{e:'üõ°Ô∏è',fx:'shield',name:'Ïö∏ÌÉÄÎ¶¨'},{e:'ü•©',fx:'lure',name:'Î®πÏù¥'}];
  const t = types[Math.floor(Math.random() * types.length)];
  const arena = document.getElementById('hg-arena');
  const w = arena.offsetWidth;
  const el = document.createElement('div');
  el.className = 'hg-powerup';
  el.textContent = t.e;
  el.style.left = (Math.random() * (w - 60) + 20) + 'px';
  el.style.top = '-60px';
  el.onclick = () => {
    hgPowerUp(t.fx, el);
  };
  arena.appendChild(el);
  hg.animals.push({ el, y: -60, x: parseFloat(el.style.left), speed: 0.15, sway: 0, isPower: true, fx: t.fx });
}

function hgPowerUp(fx, el) {
  if (fx === 'life') { hg.lives = Math.min(hg.lives + 1, 7); speak('ÏÉùÎ™Ö Ï∂îÍ∞Ä!'); }
  else if (fx === 'shield') { speak('Ïö∏ÌÉÄÎ¶¨ Î∞©Ïñ¥!'); /* Îã§Ïùå 1Ìöå ÎØ∏Ïä§ Î∞©Ïñ¥ */ hg.shielded = true; }
  else if (fx === 'lure') {
    speak('Î®πÏù¥Î°ú Ïú†Ïù∏!');
    // Í∞ÄÏû• ÏïÑÎûò ÏûàÎäî ÎèôÎ¨º ÏûêÎèô Ï†ïÎãµ Ï≤òÎ¶¨
    const lowest = hg.animals.filter(a => !a.isPower && !a.placed && !a.dragging).sort((a,b) => b.y - a.y)[0];
    if (lowest) {
      lowest.placed = true;
      lowest.el.style.transition = 'all .5s ease-out';
      lowest.el.style.transform = 'scale(0)';
      lowest.el.style.opacity = '0';
      setTimeout(() => lowest.el.remove(), 500);
      hg.animals = hg.animals.filter(a => a !== lowest);
      hg.score += 1;
    }
  }
  hg.animals = hg.animals.filter(a => a.el !== el);
  el.remove();
  updateHgUI();
}

function hgMove() {
  const arena = document.getElementById('hg-arena');
  const groundY = arena.offsetHeight * 0.82;
  const arenaW = arena.offsetWidth;
  hg.animals = hg.animals.filter(item => {
    if (item.dragging || item.placed) return true;
    item.y += item.speed;
    if (item.sway) {
      item.x += Math.sin(item.y / 80) * item.sway * 0.3;
      item.x = Math.max(5, Math.min(arenaW - 65, item.x));
      item.el.style.left = item.x + 'px';
    }
    item.el.style.top = item.y + 'px';
    if (item.y >= groundY) {
      if (item.isPower) { item.el.remove(); return false; }
      // ÎÜìÏπ®!
      if (hg.shielded) {
        hg.shielded = false;
        speak('Ïö∏ÌÉÄÎ¶¨Î°ú ÎßâÏïòÏñ¥Ïöî!');
      } else {
        hg.lives--;
        hg.combo = 0;
        speak('ÎÜìÏ≥§Ïñ¥Ïöî!');
        // ÎØ∏Ïä§ Ïù¥ÌéôÌä∏
        const flash = document.createElement('div');
        flash.className = 'hg-flash-red';
        arena.appendChild(flash);
        setTimeout(() => flash.remove(), 400);
        arena.classList.add('hg-arena-shake');
        setTimeout(() => arena.classList.remove('hg-arena-shake'), 400);
      }
      item.el.remove();
      updateHgUI();
      if (hg.lives <= 0) hgEnd();
      return false;
    }
    return true;
  });
}

function hgUpdateBg() {
  const bgs = [
    'linear-gradient(180deg,#7dd3fc 0%,#bae6fd 30%,#bbf7d0 70%,#86efac 100%)',
    'linear-gradient(180deg,#fef3c7 0%,#fde68a 30%,#fed7aa 70%,#fdba74 100%)',
    'linear-gradient(180deg,#1e293b 0%,#334155 30%,#475569 70%,#64748b 100%)',
    'linear-gradient(180deg,#0f172a 0%,#1e1b4b 30%,#312e81 70%,#4338ca 100%)'
  ];
  document.getElementById('hero-game').style.background = bgs[(hg.level - 1) % bgs.length];
}

function updateHgUI() {
  document.getElementById('hg-score').textContent = hg.score;
  document.getElementById('hg-level').textContent = hg.level;
  document.getElementById('hg-hearts').textContent = '‚ù§Ô∏è'.repeat(Math.max(0, hg.lives)) + 'üñ§'.repeat(Math.max(0, 5 - hg.lives));
  document.getElementById('hg-combo-display').textContent = hg.combo >= 2 ? `${hg.combo} COMBO` : '';
}

function hgEnd() {
  hg.running = false;
  if (hg.spawnTimer) clearInterval(hg.spawnTimer);
  if (hg.animId) cancelAnimationFrame(hg.animId);
  _hgCleanListeners();
  hg.animals.forEach(a => a.el.remove());
  hg.animals = [];
  // ÌûàÏñ¥Î°ú Ï†êÏàò Ï†ÄÏû•
  const prevBest = parseInt(LS.getItem('hgBestScore')) || 0;
  if (hg.score > prevBest) LS.setItem('hgBestScore', hg.score);
  const prevMaxCombo = parseInt(LS.getItem('hgMaxCombo')) || 0;
  if (hg.maxCombo > prevMaxCombo) LS.setItem('hgMaxCombo', hg.maxCombo);
  document.getElementById('hg-final-score').textContent = hg.score;
  let msg = 'ÏûòÌñàÏñ¥Ïöî!';
  if (hg.score >= 30) msg = 'ÎåÄÎã®Ìï¥Ïöî! ÎèôÎ¨º Î∞ïÏÇ¨!';
  else if (hg.score >= 20) msg = 'ÏôÄ! Ï†ïÎßê ÏûòÌñàÏñ¥Ïöî!';
  else if (hg.score >= 10) msg = 'Î©ãÏ†∏Ïöî! Í≥ÑÏÜç Ïó∞Ïäµ!';
  document.getElementById('hg-over-msg').textContent = msg;
  document.getElementById('hg-over').classList.remove('hidden');
  SFX.gameOver();
  speak(msg);
}

function hgRestart() {
  _hgCleanListeners();
  SFX.gameStart();
  document.getElementById('hg-over').classList.add('hidden');
  const arena = document.getElementById('hg-arena');
  arena.querySelectorAll('.falling-animal,.hg-powerup,.hg-score-pop,.hg-combo-text').forEach(e => e.remove());
  hg.score = 0; hg.lives = 5; hg.level = 1; hg.running = true; hg.paused = false;
  hg.animals = []; hg.combo = 0; hg.maxCombo = 0; hg.shielded = false;
  updateHgUI(); hgSetupBiomes(); hgUpdateBg(); hgLoop();
}

function hgPause() {
  hg.paused = !hg.paused;
  document.getElementById('hg-pause-screen').classList.toggle('hidden', !hg.paused);
}

function hgExit() {
  hg.running = false;
  if (hg.spawnTimer) clearInterval(hg.spawnTimer);
  if (hg.animId) cancelAnimationFrame(hg.animId);
  _hgCleanListeners();
  hg.animals.forEach(a => a.el.remove());
  hg.animals = [];
  document.getElementById('hg-over').classList.add('hidden');
  document.getElementById('hg-pause-screen').classList.add('hidden');
  document.getElementById('hg-start').classList.remove('hidden');
  document.getElementById('hero-game').classList.add('hidden');
  if(document.fullscreenElement)document.exitFullscreen?.();
}

// ===== Ï¥àÍ∏∞Ìôî =====
document.addEventListener('DOMContentLoaded', function() {
  // fitScale
  function fitScale() {
    const c = document.querySelector('.container');
    if (!c || getComputedStyle(c).display === 'none') return;
    const M = 0.03;
    const aW = window.innerWidth * (1 - M * 2);
    const aH = window.innerHeight * (1 - M * 2);
    const s = Math.min(aW / 1920, aH / 1080);
    c.style.transform = `scale(${s})`;
    c.style.left = ((window.innerWidth - 1920 * s) / 2) + 'px';
    c.style.top = ((window.innerHeight - 1080 * s) / 2) + 'px';
  }
  fitScale();
  window.addEventListener('resize', fitScale);
  if (window.visualViewport) window.visualViewport.addEventListener('resize', fitScale);

  // ÌîÑÎ°úÌïÑ ‚Äî _prevMainLevel Ï¥àÍ∏∞Ìôî
  const _p = parseInt(localStorage.getItem('animalCorrect')) || 0;
  _prevMainLevel = Math.floor(_p / 10) + 1;
  updateProfile();
  updateActionButtons();

  // Í≤åÏûÑ Ï¥àÍ∏∞Ìôî
  initVetGame();
  initFeedGame();
  initTransformGame();
});

// ÎçîÎ∏îÌÉ≠ Î∞©ÏßÄ
let lastTouchEnd = 0;
document.addEventListener('touchend', function(e) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) e.preventDefault();
  lastTouchEnd = now;
}, false);
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
    if (hg.running && !hg.paused) hgPause();
  }
});
window.matchMedia('(orientation: portrait)').addEventListener('change', e => {
  if (e.matches) {
    speechSynthesis.cancel(); audioQueue = []; isSpeaking = false;
    if (hg.running && !hg.paused) hgPause();
  }
});
</script>
</body>
</html>
